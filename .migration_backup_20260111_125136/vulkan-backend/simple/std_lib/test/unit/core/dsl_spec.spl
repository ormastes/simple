# DSL Features Tests

use spec.*
use core.dsl.*

describe "Context blocks":
    it "provides context-aware building":
        builder = ContextBuilder()
        builder.set("name", "Alice")
        builder.set("age", 30)

        expect(builder.get("name")).to_equal("Alice")
        expect(builder.get("age")).to_equal(30)


describe "Method missing":
    it "handles undefined methods":
        class TestObject:
            fn __init__():
                self.called = []

            fn method_missing(name, args):
                self.called.push((name, args))
                return f"Called {name}"

        obj = TestObject()
        # In full implementation, obj.unknown() would call method_missing
        result = obj.method_missing("unknown", (1, 2))
        expect(result).to_equal("Called unknown")

    it "enables dynamic proxies":
        calls = []

        def handler(name, args):
            calls.push(name)
            return 42

        proxy = DynamicProxy(handler)
        result = proxy.method_missing("test", ())

        expect(result).to_equal(42)

    it "supports attribute dictionaries":
        obj = AttributeDict()
        obj.__setattr__("name", "Bob")
        obj.__setattr__("age", 25)

        expect(obj.__getattr__("name")).to_equal("Bob")


describe "Fluent interfaces":
    it "enables method chaining":
        builder = QueryBuilder()
        builder = builder.select("name", "age")
        builder = builder.from_table("users")
        builder = builder.where("age > 18")

        sql = builder.to_sql()
        expect(sql).to_contain("SELECT name, age")
        expect(sql).to_contain("FROM users")
        expect(sql).to_contain("WHERE age > 18")

    it "supports pipeline transformations":
        pipeline = Pipeline([1, 2, 3, 4, 5])
        result = pipeline
            .map(fn(x): x * 2)
            .filter(fn(x): x > 5)
            .collect()

        expect(result).to_equal([6, 8, 10])
