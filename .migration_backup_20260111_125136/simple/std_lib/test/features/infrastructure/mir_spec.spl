# MIR Feature Specification
# Feature #5: Mid-level Intermediate Representation
# Category: Infrastructure | Difficulty: 4 | Status: Complete

# =====================================================
# Feature Metadata
# =====================================================

class FeatureMetadata:
    id: Int
    name: String
    category: String
    difficulty: Int
    status: String
    impl_type: String
    spec_ref: String
    files: List<String>
    tests: List<String>
    description: String
    code_examples: List<String>
    dependencies: List<Int>
    required_by: List<Int>
    notes: String

# Feature Definition
let FEATURE = FeatureMetadata {
    id: 5,
    name: 'MIR',
    category: 'Infrastructure',
    difficulty: 4,
    status: 'Complete',
    impl_type: 'Rust',
    spec_ref: 'doc/codegen/status.md',
    files: [
        'src/compiler/src/mir/mod.rs',
        'src/compiler/src/mir/instructions.rs',
        'src/compiler/src/mir/lower.rs'
    ],
    tests: [
        'src/driver/tests/runner_tests.rs'
    ],
    description: 'Mid-level IR with 50+ instruction variants. Lowers HIR to basic blocks with explicit control flow. Handles arithmetic, memory, collections, patterns, async, and generators.',
    code_examples: [],
    dependencies: [4],
    required_by: [100],
    notes: 'MIR uses SSA form. Generator lowering creates state machines. Effect tracking for async safety.'
}

# =====================================================
# BDD Specification Tests
# =====================================================

print('============================================================')
print('  MIR FEATURE SPECIFICATION (#5)')
print('  Category: Infrastructure | Difficulty: 4 | Status: Complete')
print('============================================================')
print('')

let mut passed = 0
let mut failed = 0

# -----------------------------------------------------
# Core Instructions (6)
# -----------------------------------------------------

print('describe Core instructions:')
print('  context ConstInt:')
print('    it creates integer constants:')

let const_int = 42
if const_int == 42:
    print('      [PASS] ConstInt lowering')
    passed = passed + 1
else:
    print('      [FAIL] ConstInt lowering')
    failed = failed + 1

print('')
print('  context BinOp:')
print('    it lowers binary operations:')

let sum = 10 + 20 + 12
let prod = 6 * 7
if sum == 42 and prod == 42:
    print('      [PASS] BinOp lowering')
    passed = passed + 1
else:
    print('      [FAIL] BinOp lowering')
    failed = failed + 1

print('')
print('  context UnaryOp:')
print('    it lowers unary operations:')

let neg = -42
let not_val = not false
if neg == -42 and not_val:
    print('      [PASS] UnaryOp lowering')
    passed = passed + 1
else:
    print('      [FAIL] UnaryOp lowering')
    failed = failed + 1

# -----------------------------------------------------
# Memory Instructions (6)
# -----------------------------------------------------

print('')
print('describe Memory instructions:')
print('  context Load/Store:')
print('    it loads and stores values:')

let mut mem = 0
mem = 42
if mem == 42:
    print('      [PASS] Load/Store')
    passed = passed + 1
else:
    print('      [FAIL] Load/Store')
    failed = failed + 1

print('')
print('  context FieldGet/FieldSet:')
print('    it accesses struct fields:')

struct Data:
    value: i64

let d = Data { value: 42 }
if d.value == 42:
    print('      [PASS] FieldGet')
    passed = passed + 1
else:
    print('      [FAIL] FieldGet')
    failed = failed + 1

# -----------------------------------------------------
# Collection Instructions (7)
# -----------------------------------------------------

print('')
print('describe Collection instructions:')
print('  context ArrayLit:')
print('    it creates arrays:')

let arr = [1, 2, 3, 4, 5]
if arr.len() == 5:
    print('      [PASS] ArrayLit')
    passed = passed + 1
else:
    print('      [FAIL] ArrayLit')
    failed = failed + 1

print('')
print('  context TupleLit:')
print('    it creates tuples:')

let tup = (10, 20, 30)
if tup[0] + tup[1] + tup[2] == 60:
    print('      [PASS] TupleLit')
    passed = passed + 1
else:
    print('      [FAIL] TupleLit')
    failed = failed + 1

print('')
print('  context DictLit:')
print('    it creates dicts:')

let dict = {"a": 1, "b": 2}
if dict["a"] + dict["b"] == 3:
    print('      [PASS] DictLit')
    passed = passed + 1
else:
    print('      [FAIL] DictLit')
    failed = failed + 1

print('')
print('  context IndexGet:')
print('    it indexes collections:')

let items = [10, 20, 30]
if items[1] == 20:
    print('      [PASS] IndexGet')
    passed = passed + 1
else:
    print('      [FAIL] IndexGet')
    failed = failed + 1

# -----------------------------------------------------
# String Instructions (3)
# -----------------------------------------------------

print('')
print('describe String instructions:')
print('  context ConstString:')
print('    it creates strings:')

let s = "hello world"
if s.len() == 11:
    print('      [PASS] ConstString')
    passed = passed + 1
else:
    print('      [FAIL] ConstString')
    failed = failed + 1

print('')
print('  context FStringFormat:')
print('    it formats interpolated strings:')

let name = "World"
let greeting = "Hello, {name}!"
if greeting == "Hello, World!":
    print('      [PASS] FStringFormat')
    passed = passed + 1
else:
    print('      [FAIL] FStringFormat')
    failed = failed + 1

# -----------------------------------------------------
# Pattern Instructions (6)
# -----------------------------------------------------

print('')
print('describe Pattern instructions:')
print('  context PatternTest:')
print('    it tests literal patterns:')

let val = 42
let mut matched = false
match val:
    42 =>
        matched = true
    _ =>
        matched = false

if matched:
    print('      [PASS] PatternTest literal')
    passed = passed + 1
else:
    print('      [FAIL] PatternTest literal')
    failed = failed + 1

print('')
print('  context PatternBind:')
print('    it binds pattern variables:')

let opt = Some(100)
let mut extracted = 0
match opt:
    Some(x) =>
        extracted = x
    None =>
        extracted = -1

if extracted == 100:
    print('      [PASS] PatternBind')
    passed = passed + 1
else:
    print('      [FAIL] PatternBind')
    failed = failed + 1

print('')
print('  context EnumDiscriminant:')
print('    it tests enum variants:')

enum Color:
    Red
    Green
    Blue

let c = Color::Green
let mut is_green = false
match c:
    Color::Green =>
        is_green = true
    _ =>
        is_green = false

if is_green:
    print('      [PASS] EnumDiscriminant')
    passed = passed + 1
else:
    print('      [FAIL] EnumDiscriminant')
    failed = failed + 1

# -----------------------------------------------------
# Async Instructions (5)
# -----------------------------------------------------

print('')
print('describe Async instructions:')
print('  context FutureCreate:')
print('    it creates futures:')

let f = future(42)
if await f == 42:
    print('      [PASS] FutureCreate')
    passed = passed + 1
else:
    print('      [FAIL] FutureCreate')
    failed = failed + 1

print('')
print('  context Await:')
print('    it awaits values:')

let f2 = future(10 + 20)
let result = await f2
if result == 30:
    print('      [PASS] Await')
    passed = passed + 1
else:
    print('      [FAIL] Await')
    failed = failed + 1

# -----------------------------------------------------
# Generator Instructions (3)
# -----------------------------------------------------

print('')
print('describe Generator instructions:')
print('  context GeneratorCreate:')
print('    it creates generators:')

let gen = generator(\: yield 42)
if next(gen) == 42:
    print('      [PASS] GeneratorCreate')
    passed = passed + 1
else:
    print('      [FAIL] GeneratorCreate')
    failed = failed + 1

print('')
print('  context Yield/GeneratorNext:')
print('    it yields and advances:')

let gen2 = generator(\: [yield 1, yield 2, yield 3])
let sum_gen = next(gen2) + next(gen2) + next(gen2)
if sum_gen == 6:
    print('      [PASS] Yield/GeneratorNext')
    passed = passed + 1
else:
    print('      [FAIL] Yield/GeneratorNext')
    failed = failed + 1

# =====================================================
# Documentation Output
# =====================================================

print('')
print('============================================================')
print('  GENERATED DOCUMENTATION')
print('============================================================')
print('')
print('# MIR')
print('')
print('**Feature ID:** #5')
print('**Category:** Infrastructure')
print('**Difficulty:** Level 4/5')
print('**Status:** Complete')
print('**Implementation:** Rust')
print('')
print('## Description')
print('')
print(FEATURE.description)
print('')
print('## Instruction Categories')
print('')
print('| Category | Count | Examples |')
print('|----------|-------|----------|')
print('| Core | 6 | ConstInt, BinOp, UnaryOp |')
print('| Memory | 6 | Load, Store, FieldGet |')
print('| Collections | 7 | ArrayLit, TupleLit, IndexGet |')
print('| Strings | 3 | ConstString, FStringFormat |')
print('| Patterns | 6 | PatternTest, PatternBind |')
print('| Async | 5 | FutureCreate, Await |')
print('| Generators | 3 | GeneratorCreate, Yield |')
print('')
print('## Notes')
print('')
print(FEATURE.notes)

# Summary
print('')
print('============================================================')
print('  TEST SUMMARY')
print('============================================================')
let total = passed + failed
print("Passed: {passed}")
print("Failed: {failed}")
print("Total:  {total}")
if failed == 0:
    print('All tests PASSED!')
print('============================================================')
