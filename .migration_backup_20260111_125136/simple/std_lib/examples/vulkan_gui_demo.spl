# Vulkan GUI Demo - Cross-Platform UI Rendering
#
# Demonstrates the Vulkan GUI renderer implementing the RenderBackend trait.
# Shows how the UI framework's Element tree is rendered using Vulkan.
#
# Features Demonstrated:
# - RenderBackend trait implementation
# - Element tree construction
# - Vulkan-based rendering
# - Event loop integration
# - Async/await patterns

use ui.*
use ui.element.*
use ui.gui.*
use core.*

# =============================================================================
# Sample Application - Counter with Buttons
# =============================================================================

struct CounterApp:
    count: i32
    renderer: VulkanRenderer

impl CounterApp:
    pub fn new(renderer: VulkanRenderer) -> CounterApp:
        CounterApp {
            count: 0,
            renderer: renderer,
        }

    # Build UI tree
    pub fn build(&self) -> Element:
        Element::container()
            .with_attr("padding", "20")
            .with_attr("background-color", "#2c3e50")
            .with_children([
                # Title
                Element::text("Vulkan GUI Demo")
                    .with_attr("font-size", "24")
                    .with_attr("color", "#ecf0f1")
                    .with_attr("margin-bottom", "20"),

                # Counter display
                Element::container()
                    .with_attr("padding", "10")
                    .with_attr("background-color", "#34495e")
                    .with_attr("margin-bottom", "10")
                    .with_children([
                        Element::text("Count: {self.count}")
                            .with_attr("font-size", "32")
                            .with_attr("color", "#3498db")
                            .with_attr("text-align", "center"),
                    ]),

                # Buttons row
                Element::container()
                    .with_attr("layout", "horizontal")
                    .with_attr("gap", "10")
                    .with_children([
                        Element::button("Increment")
                            .with_attr("background-color", "#27ae60")
                            .with_attr("color", "#ffffff")
                            .with_attr("padding", "10 20")
                            .on_click(|| self.increment()),

                        Element::button("Decrement")
                            .with_attr("background-color", "#e74c3c")
                            .with_attr("color", "#ffffff")
                            .with_attr("padding", "10 20")
                            .on_click(|| self.decrement()),

                        Element::button("Reset")
                            .with_attr("background-color", "#95a5a6")
                            .with_attr("color", "#ffffff")
                            .with_attr("padding", "10 20")
                            .on_click(|| self.reset()),
                    ]),

                # Stats
                Element::text("Rendered with Vulkan")
                    .with_attr("font-size", "12")
                    .with_attr("color", "#7f8c8d")
                    .with_attr("margin-top", "20")
                    .with_attr("text-align", "center"),
            ])

    # Event handlers
    fn increment(&mut self):
        self.count += 1

    fn decrement(&mut self):
        self.count -= 1

    fn reset(&mut self):
        self.count = 0

# =============================================================================
# Main Application Loop
# =============================================================================

async fn main() -> Result[(), String]:
    println("=== Vulkan GUI Demo ===")
    println("Cross-Platform UI Rendering")
    println()

    # Create window
    println("1. Creating window...")
    let window_handle = create_window("Vulkan GUI Demo", 800, 600)?
    println("   ✓ Window created")

    # Create Vulkan renderer
    println("2. Initializing Vulkan renderer...")
    let mut renderer = VulkanRenderer::new(window_handle, 800, 600)
    await renderer.init().map_err(|e| e.message().to_string())?
    println("   ✓ Vulkan renderer initialized")

    # Create application
    println("3. Creating application...")
    let mut app = CounterApp::new(renderer)
    println("   ✓ Application created")

    # Main event loop
    println("4. Starting render loop...")
    println("   Press Escape to exit")
    println()

    let mut frame_count = 0
    let start_time = get_time()
    let mut last_fps_time = start_time
    let mut fps_counter = 0

    loop:
        # Build UI tree
        let ui_tree = app.build()

        # Render frame
        await app.renderer.render(&ui_tree)
            .map_err(|e| e.message().to_string())?

        # FPS counter
        frame_count += 1
        fps_counter += 1
        let current_time = get_time()

        if current_time - last_fps_time >= 1.0:
            println("FPS: {} | Frame: {}", fps_counter, frame_count)
            fps_counter = 0
            last_fps_time = current_time

        # Check for events (TODO: implement event system)
        # For now, run for 600 frames (10 seconds at 60 FPS)
        if frame_count >= 600:
            break

    # Cleanup
    println()
    println("5. Shutting down...")
    await app.renderer.shutdown().map_err(|e| e.message().to_string())?
    println("   ✓ Renderer shutdown")

    # Summary
    println()
    println("=== Demo Complete ===")
    let total_time = get_time() - start_time
    let avg_fps = frame_count as f64 / total_time
    println("Total frames: {}", frame_count)
    println("Total time: {:.2}s", total_time)
    println("Average FPS: {:.1}", avg_fps)

    Ok(())

# =============================================================================
# Window Management (Placeholder FFI)
# =============================================================================

extern fn create_window(title: &str, width: u32, height: u32) -> Result[i64, String]
extern fn get_time() -> f64

# =============================================================================
# Expected Output
# =============================================================================

# === Vulkan GUI Demo ===
# Cross-Platform UI Rendering
#
# 1. Creating window...
#    ✓ Window created
# 2. Initializing Vulkan renderer...
#    ✓ Vulkan renderer initialized
# 3. Creating application...
#    ✓ Application created
# 4. Starting render loop...
#    Press Escape to exit
#
# FPS: 60 | Frame: 60
# FPS: 60 | Frame: 120
# FPS: 60 | Frame: 180
# FPS: 60 | Frame: 240
# FPS: 60 | Frame: 300
# FPS: 60 | Frame: 360
# FPS: 60 | Frame: 420
# FPS: 60 | Frame: 480
# FPS: 60 | Frame: 540
# FPS: 60 | Frame: 600
#
# 5. Shutting down...
#    ✓ Renderer shutdown
#
# === Demo Complete ===
# Total frames: 600
# Total time: 10.00s
# Average FPS: 60.0
