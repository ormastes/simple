# Godot Variant Type System
#
# Variant is Godot's universal value type that can hold any value.
# This module provides type-safe Simple wrappers for Variant operations.
#
# Reference: https://docs.godotengine.org/en/stable/classes/class_variant.html

import godot.ffi

# Variant type - Godot's universal value container
pub struct Variant:
    ptr: ffi.GDExtensionVariantPtr
    owns_data: bool

impl Variant:
    # Create a nil (null) variant
    pub fn nil() -> Variant:
        let ptr = runtime_allocate_variant()
        ffi.godot_variant_new_nil(ptr)
        return Variant(ptr: ptr, owns_data: true)

    # Create from boolean
    pub fn from_bool(value: bool) -> Variant:
        let ptr = runtime_allocate_variant()
        ffi.godot_variant_new_bool(ptr, value)
        return Variant(ptr: ptr, owns_data: true)

    # Create from integer
    pub fn from_int(value: i64) -> Variant:
        let ptr = runtime_allocate_variant()
        ffi.godot_variant_new_int(ptr, value)
        return Variant(ptr: ptr, owns_data: true)

    # Create from float
    pub fn from_float(value: f64) -> Variant:
        let ptr = runtime_allocate_variant()
        ffi.godot_variant_new_float(ptr, value)
        return Variant(ptr: ptr, owns_data: true)

    # Create from string
    pub fn from_string(value: String) -> Variant:
        let ptr = runtime_allocate_variant()
        let str_ptr = string_to_godot_string(value)
        ffi.godot_variant_new_string(ptr, str_ptr)
        ffi.godot_string_destroy(str_ptr)
        return Variant(ptr: ptr, owns_data: true)

    # Create from object pointer
    pub fn from_object(obj_ptr: ffi.GDExtensionObjectPtr) -> Variant:
        let ptr = runtime_allocate_variant()
        ffi.godot_variant_new_object(ptr, obj_ptr)
        return Variant(ptr: ptr, owns_data: true)

    # Create from Vector2
    pub fn from_vector2(x: f64, y: f64) -> Variant:
        let ptr = runtime_allocate_variant()
        ffi.godot_variant_new_vector2(ptr, x, y)
        return Variant(ptr: ptr, owns_data: true)

    # Create from Vector3
    pub fn from_vector3(x: f64, y: f64, z: f64) -> Variant:
        let ptr = runtime_allocate_variant()
        ffi.godot_variant_new_vector3(ptr, x, y, z)
        return Variant(ptr: ptr, owns_data: true)

    # Create from Color
    pub fn from_color(r: f32, g: f32, b: f32, a: f32) -> Variant:
        let ptr = runtime_allocate_variant()
        ffi.godot_variant_new_color(ptr, r, g, b, a)
        return Variant(ptr: ptr, owns_data: true)

    # Create array variant
    pub fn new_array() -> Variant:
        let ptr = runtime_allocate_variant()
        ffi.godot_variant_new_array(ptr)
        return Variant(ptr: ptr, owns_data: true)

    # Create dictionary variant
    pub fn new_dictionary() -> Variant:
        let ptr = runtime_allocate_variant()
        ffi.godot_variant_new_dictionary(ptr)
        return Variant(ptr: ptr, owns_data: true)

    # Copy constructor
    pub fn copy(other: &Variant) -> Variant:
        let ptr = runtime_allocate_variant()
        ffi.godot_variant_new_copy(ptr, other.ptr)
        return Variant(ptr: ptr, owns_data: true)

    # Extract as boolean
    pub fn as_bool(self) -> bool:
        return ffi.godot_variant_as_bool(self.ptr)

    # Extract as integer
    pub fn as_int(self) -> i64:
        return ffi.godot_variant_as_int(self.ptr)

    # Extract as float
    pub fn as_float(self) -> f64:
        return ffi.godot_variant_as_float(self.ptr)

    # Extract as string
    pub fn as_string(self) -> String:
        let str_ptr = ffi.godot_variant_as_string(self.ptr)
        let result = godot_string_to_string(str_ptr)
        ffi.godot_string_destroy(str_ptr)
        return result

    # Extract as object pointer
    pub fn as_object(self) -> ffi.GDExtensionObjectPtr:
        return ffi.godot_variant_as_object(self.ptr)

    # Extract as Vector2
    pub fn as_vector2(self) -> (f64, f64):
        let mut x: f64 = 0.0
        let mut y: f64 = 0.0
        ffi.godot_variant_as_vector2(self.ptr, &mut x, &mut y)
        return (x, y)

    # Extract as Vector3
    pub fn as_vector3(self) -> (f64, f64, f64):
        let mut x: f64 = 0.0
        let mut y: f64 = 0.0
        let mut z: f64 = 0.0
        ffi.godot_variant_as_vector3(self.ptr, &mut x, &mut y, &mut z)
        return (x, y, z)

    # Get internal pointer (for FFI calls)
    pub fn ptr(self) -> ffi.GDExtensionVariantPtr:
        return self.ptr

    # Destructor
    pub fn drop(mut self):
        if self.owns_data:
            ffi.godot_variant_destroy(self.ptr)
            runtime_free_variant(self.ptr)
            self.owns_data = false

# StringName - Godot's optimized string type for identifiers
pub struct StringName:
    ptr: ffi.GDExtensionStringNamePtr
    owns_data: bool

impl StringName:
    # Create from string
    pub fn new(name: String) -> StringName:
        let ptr = runtime_allocate_string_name()
        let bytes = name.as_bytes()
        ffi.godot_string_name_new_with_utf8_chars(ptr, bytes.data(), bytes.len() as i64)
        return StringName(ptr: ptr, owns_data: true)

    # Get internal pointer
    pub fn ptr(self) -> ffi.GDExtensionStringNamePtr:
        return self.ptr

    # Destructor
    pub fn drop(mut self):
        if self.owns_data:
            ffi.godot_string_name_destroy(self.ptr)
            runtime_free_string_name(self.ptr)
            self.owns_data = false

# Helper functions (implemented in Rust runtime)
extern "C" fn runtime_allocate_variant() -> ffi.GDExtensionVariantPtr
extern "C" fn runtime_free_variant(ptr: ffi.GDExtensionVariantPtr)
extern "C" fn runtime_allocate_string_name() -> ffi.GDExtensionStringNamePtr
extern "C" fn runtime_free_string_name(ptr: ffi.GDExtensionStringNamePtr)

# String conversion helpers
fn string_to_godot_string(s: String) -> ffi.GDExtensionStringPtr:
    let ptr = runtime_allocate_godot_string()
    let bytes = s.as_bytes()
    ffi.godot_string_new_with_utf8_chars(ptr, bytes.data(), bytes.len() as i64)
    return ptr

fn godot_string_to_string(ptr: ffi.GDExtensionStringPtr) -> String:
    # Get length first
    let len = ffi.godot_string_to_utf8_chars(ptr, null, 0)
    if len <= 0:
        return ""

    # Allocate buffer and copy
    let mut buffer = Array<u8>::with_capacity(len as usize)
    ffi.godot_string_to_utf8_chars(ptr, buffer.data(), len)

    return String::from_utf8(buffer)

extern "C" fn runtime_allocate_godot_string() -> ffi.GDExtensionStringPtr
extern "C" fn runtime_free_godot_string(ptr: ffi.GDExtensionStringPtr)
