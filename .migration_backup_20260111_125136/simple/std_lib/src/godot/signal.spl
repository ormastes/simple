# Godot Signal System
#
# Signals are Godot's event system for communication between nodes.
#
# Reference: https://docs.godotengine.org/en/stable/classes/class_signal.html

import godot.ffi
import godot.variant
import godot.object

# Signal wrapper
pub struct Signal:
    object_ptr: ffi.GDExtensionObjectPtr
    signal_name: variant.StringName

impl Signal:
    # Create a signal reference
    pub fn new(obj: object.Object, name: String) -> Signal:
        return Signal(
            object_ptr: obj.ptr(),
            signal_name: variant.StringName::new(name)
        )

    # Connect this signal to a target method
    pub fn connect(self, target: object.Object, method_name: String) -> bool:
        let method_sname = variant.StringName::new(method_name)

        let result = ffi.godot_signal_connect(
            self.object_ptr,
            self.signal_name.ptr(),
            target.ptr(),
            method_sname.ptr(),
            0  # Flags
        )

        return result == 0

    # Disconnect this signal from a target method
    pub fn disconnect(self, target: object.Object, method_name: String):
        let method_sname = variant.StringName::new(method_name)

        ffi.godot_signal_disconnect(
            self.object_ptr,
            self.signal_name.ptr(),
            target.ptr(),
            method_sname.ptr()
        )

    # Emit this signal with arguments
    pub fn emit(self, args: Array<variant.Variant>):
        let mut arg_ptrs = Array<ffi.GDExtensionVariantPtr>::new()
        for arg in args:
            arg_ptrs.push(arg.ptr())

        ffi.godot_object_emit_signal(
            self.object_ptr,
            self.signal_name.ptr(),
            arg_ptrs.data(),
            args.len() as i64
        )

    # Emit with no arguments
    pub fn emit0(self):
        self.emit(Array<variant.Variant>::new())

    # Emit with one argument
    pub fn emit1(self, arg1: variant.Variant):
        let mut args = Array<variant.Variant>::new()
        args.push(arg1)
        self.emit(args)

    # Emit with two arguments
    pub fn emit2(self, arg1: variant.Variant, arg2: variant.Variant):
        let mut args = Array<variant.Variant>::new()
        args.push(arg1)
        args.push(arg2)
        self.emit(args)
