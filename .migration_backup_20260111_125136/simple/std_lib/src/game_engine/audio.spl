# Common Audio Abstraction
#
# Engine-agnostic audio interface
# Works with both Godot AudioStreamPlayer and Unreal USoundBase
#
# Features:
# - Audio playback control
# - Volume and pitch control
# - 3D spatial audio
# - Audio bus/mixer management
# - Sound effects and music

import sys.ffi

mod audio

# AudioPlayer trait
# Common interface for audio playback
pub trait AudioPlayer:
    # Playback control
    me play()
    me stop()
    me pause()
    me resume()
    fn is_playing() -> bool

    # Properties
    fn get_volume() -> f32
    me set_volume(volume: f32)
    fn get_pitch() -> f32
    me set_pitch(pitch: f32)

    # Looping
    fn is_looping() -> bool
    me set_looping(looping: bool)

    # Position
    fn get_playback_position() -> f32
    me set_playback_position(position: f32)
    fn get_duration() -> f32


# SpatialAudioPlayer trait
# Extended interface for 3D spatial audio
pub trait SpatialAudioPlayer: AudioPlayer:
    fn get_position() -> (f32, f32, f32)
    me set_position(x: f32, y: f32, z: f32)
    fn get_max_distance() -> f32
    me set_max_distance(distance: f32)
    fn get_attenuation() -> f32
    me set_attenuation(attenuation: f32)


# GodotAudioPlayerAdapter
# Adapts Godot AudioStreamPlayer to AudioPlayer trait
pub struct GodotAudioPlayerAdapter:
    player_ptr: ffi.VoidPtr

impl GodotAudioPlayerAdapter:
    pub fn new(player_ptr: ffi.VoidPtr) -> GodotAudioPlayerAdapter:
        return GodotAudioPlayerAdapter(player_ptr: player_ptr)

    # =========================================================================
    # Helper Methods
    # =========================================================================

    pub fn get_player_ptr(self) -> ffi.VoidPtr:
        """Get audio player pointer.

        Returns:
            Player pointer

        Example:
            adapter.get_player_ptr()
        """
        return self.player_ptr

    pub fn has_player(self) -> bool:
        """Check if has valid player pointer.

        Returns:
            true if pointer is not null

        Example:
            adapter.has_player()  # → true
        """
        return not ffi.is_null_ptr(self.player_ptr)

    pub fn is_stopped(self) -> bool:
        """Check if player is stopped (not playing).

        Returns:
            true if stopped

        Example:
            adapter.is_stopped()  # → false
        """
        return not self.is_playing()

    pub fn summary(self) -> String:
        """Get Godot audio player adapter summary.

        Returns:
            Human-readable summary

        Example:
            adapter.summary()
            # → "GodotAudioPlayerAdapter: playing, volume=0.8, pitch=1.0"
        """
        let play_state = if self.is_playing() { "playing" } else { "stopped" }
        let vol = self.get_volume()
        let pitch = self.get_pitch()
        return "GodotAudioPlayerAdapter: {play_state}, volume={vol}, pitch={pitch}"

impl AudioPlayer for GodotAudioPlayerAdapter:
    me play():
        godot_audio_player_play(self.player_ptr)

    me stop():
        godot_audio_player_stop(self.player_ptr)

    me pause():
        godot_audio_player_set_stream_paused(self.player_ptr, true)

    me resume():
        godot_audio_player_set_stream_paused(self.player_ptr, false)

    fn is_playing() -> bool:
        return godot_audio_player_is_playing(self.player_ptr)

    fn get_volume() -> f32:
        return godot_audio_player_get_volume_db(self.player_ptr)

    me set_volume(volume: f32):
        godot_audio_player_set_volume_db(self.player_ptr, volume)

    fn get_pitch() -> f32:
        return godot_audio_player_get_pitch_scale(self.player_ptr)

    me set_pitch(pitch: f32):
        godot_audio_player_set_pitch_scale(self.player_ptr, pitch)

    fn is_looping() -> bool:
        return godot_audio_player_is_autoplay(self.player_ptr)

    me set_looping(looping: bool):
        # Godot uses autoplay for looping
        godot_audio_player_set_autoplay(self.player_ptr, looping)

    fn get_playback_position() -> f32:
        return godot_audio_player_get_playback_position(self.player_ptr)

    me set_playback_position(position: f32):
        godot_audio_player_seek(self.player_ptr, position)

    fn get_duration() -> f32:
        return godot_audio_player_get_stream_length(self.player_ptr)


# GodotSpatialAudioAdapter
# Adapts Godot AudioStreamPlayer3D to SpatialAudioPlayer trait
pub struct GodotSpatialAudioAdapter:
    base: GodotAudioPlayerAdapter
    spatial_ptr: ffi.VoidPtr

impl GodotSpatialAudioAdapter:
    pub fn new(spatial_ptr: ffi.VoidPtr) -> GodotSpatialAudioAdapter:
        return GodotSpatialAudioAdapter(
            base: GodotAudioPlayerAdapter::new(spatial_ptr),
            spatial_ptr: spatial_ptr,
        )

    # =========================================================================
    # Helper Methods
    # =========================================================================

    pub fn get_spatial_ptr(self) -> ffi.VoidPtr:
        """Get spatial audio player pointer.

        Returns:
            Spatial player pointer

        Example:
            adapter.get_spatial_ptr()
        """
        return self.spatial_ptr

    pub fn has_spatial(self) -> bool:
        """Check if has valid spatial player pointer.

        Returns:
            true if pointer is not null

        Example:
            adapter.has_spatial()  # → true
        """
        return not ffi.is_null_ptr(self.spatial_ptr)

    pub fn get_base_player(self) -> GodotAudioPlayerAdapter:
        """Get base audio player adapter.

        Returns:
            Base adapter

        Example:
            let base = adapter.get_base_player()
        """
        return self.base

    pub fn summary(self) -> String:
        """Get Godot spatial audio adapter summary.

        Returns:
            Human-readable summary

        Example:
            adapter.summary()
            # → "GodotSpatialAudioAdapter: playing, position=(10.0, 0.0, 5.0), max_dist=50.0"
        """
        let play_state = if self.is_playing() { "playing" } else { "stopped" }
        let (x, y, z) = self.get_position()
        let max_dist = self.get_max_distance()
        return "GodotSpatialAudioAdapter: {play_state}, position=({x}, {y}, {z}), max_dist={max_dist}"

impl AudioPlayer for GodotSpatialAudioAdapter:
    me play():
        self.base.play()

    me stop():
        self.base.stop()

    me pause():
        self.base.pause()

    me resume():
        self.base.resume()

    fn is_playing() -> bool:
        return self.base.is_playing()

    fn get_volume() -> f32:
        return self.base.get_volume()

    me set_volume(volume: f32):
        self.base.set_volume(volume)

    fn get_pitch() -> f32:
        return self.base.get_pitch()

    me set_pitch(pitch: f32):
        self.base.set_pitch(pitch)

    fn is_looping() -> bool:
        return self.base.is_looping()

    me set_looping(looping: bool):
        self.base.set_looping(looping)

    fn get_playback_position() -> f32:
        return self.base.get_playback_position()

    me set_playback_position(position: f32):
        self.base.set_playback_position(position)

    fn get_duration() -> f32:
        return self.base.get_duration()

impl SpatialAudioPlayer for GodotSpatialAudioAdapter:
    fn get_position() -> (f32, f32, f32):
        let x = ffi.alloc_f32()
        let y = ffi.alloc_f32()
        let z = ffi.alloc_f32()
        godot_audio_player_3d_get_position(self.spatial_ptr, x, y, z)
        let result = (ffi.read_f32(x), ffi.read_f32(y), ffi.read_f32(z))
        ffi.free(x)
        ffi.free(y)
        ffi.free(z)
        return result

    me set_position(x: f32, y: f32, z: f32):
        godot_audio_player_3d_set_position(self.spatial_ptr, x, y, z)

    fn get_max_distance() -> f32:
        return godot_audio_player_3d_get_max_distance(self.spatial_ptr)

    me set_max_distance(distance: f32):
        godot_audio_player_3d_set_max_distance(self.spatial_ptr, distance)

    fn get_attenuation() -> f32:
        return godot_audio_player_3d_get_attenuation_filter_db(self.spatial_ptr)

    me set_attenuation(attenuation: f32):
        godot_audio_player_3d_set_attenuation_filter_db(self.spatial_ptr, attenuation)


# UnrealAudioPlayerAdapter
# Adapts Unreal UAudioComponent to AudioPlayer trait
pub struct UnrealAudioPlayerAdapter:
    component_ptr: ffi.VoidPtr

impl UnrealAudioPlayerAdapter:
    pub fn new(component_ptr: ffi.VoidPtr) -> UnrealAudioPlayerAdapter:
        return UnrealAudioPlayerAdapter(component_ptr: component_ptr)

    # =========================================================================
    # Helper Methods
    # =========================================================================

    pub fn get_component_ptr(self) -> ffi.VoidPtr:
        """Get audio component pointer.

        Returns:
            Component pointer

        Example:
            adapter.get_component_ptr()
        """
        return self.component_ptr

    pub fn has_component(self) -> bool:
        """Check if has valid component pointer.

        Returns:
            true if pointer is not null

        Example:
            adapter.has_component()  # → true
        """
        return not ffi.is_null_ptr(self.component_ptr)

    pub fn is_stopped(self) -> bool:
        """Check if player is stopped (not playing).

        Returns:
            true if stopped

        Example:
            adapter.is_stopped()  # → true
        """
        return not self.is_playing()

    pub fn summary(self) -> String:
        """Get Unreal audio player adapter summary.

        Returns:
            Human-readable summary

        Example:
            adapter.summary()
            # → "UnrealAudioPlayerAdapter: playing, volume=1.0, pitch=1.2, looping"
        """
        let play_state = if self.is_playing() { "playing" } else { "stopped" }
        let vol = self.get_volume()
        let pitch = self.get_pitch()
        let loop_state = if self.is_looping() { "looping" } else { "oneshot" }
        return "UnrealAudioPlayerAdapter: {play_state}, volume={vol}, pitch={pitch}, {loop_state}"

impl AudioPlayer for UnrealAudioPlayerAdapter:
    me play():
        unreal_audio_component_play(self.component_ptr)

    me stop():
        unreal_audio_component_stop(self.component_ptr)

    me pause():
        unreal_audio_component_set_paused(self.component_ptr, true)

    me resume():
        unreal_audio_component_set_paused(self.component_ptr, false)

    fn is_playing() -> bool:
        return unreal_audio_component_is_playing(self.component_ptr)

    fn get_volume() -> f32:
        return unreal_audio_component_get_volume_multiplier(self.component_ptr)

    me set_volume(volume: f32):
        unreal_audio_component_set_volume_multiplier(self.component_ptr, volume)

    fn get_pitch() -> f32:
        return unreal_audio_component_get_pitch_multiplier(self.component_ptr)

    me set_pitch(pitch: f32):
        unreal_audio_component_set_pitch_multiplier(self.component_ptr, pitch)

    fn is_looping() -> bool:
        return unreal_audio_component_is_looping(self.component_ptr)

    me set_looping(looping: bool):
        unreal_audio_component_set_looping(self.component_ptr, looping)

    fn get_playback_position() -> f32:
        return unreal_audio_component_get_playback_percent(self.component_ptr)

    me set_playback_position(position: f32):
        # Unreal doesn't support seeking directly, restart at position
        pass

    fn get_duration() -> f32:
        return unreal_audio_component_get_duration(self.component_ptr)


# FFI declarations for Godot audio
extern "C":
    fn godot_audio_player_play(player: ffi.VoidPtr)
    fn godot_audio_player_stop(player: ffi.VoidPtr)
    fn godot_audio_player_set_stream_paused(player: ffi.VoidPtr, paused: bool)
    fn godot_audio_player_is_playing(player: ffi.VoidPtr) -> bool
    fn godot_audio_player_get_volume_db(player: ffi.VoidPtr) -> f32
    fn godot_audio_player_set_volume_db(player: ffi.VoidPtr, volume: f32)
    fn godot_audio_player_get_pitch_scale(player: ffi.VoidPtr) -> f32
    fn godot_audio_player_set_pitch_scale(player: ffi.VoidPtr, pitch: f32)
    fn godot_audio_player_is_autoplay(player: ffi.VoidPtr) -> bool
    fn godot_audio_player_set_autoplay(player: ffi.VoidPtr, autoplay: bool)
    fn godot_audio_player_get_playback_position(player: ffi.VoidPtr) -> f32
    fn godot_audio_player_seek(player: ffi.VoidPtr, position: f32)
    fn godot_audio_player_get_stream_length(player: ffi.VoidPtr) -> f32

    fn godot_audio_player_3d_get_position(player: ffi.VoidPtr, x: ffi.VoidPtr, y: ffi.VoidPtr, z: ffi.VoidPtr)
    fn godot_audio_player_3d_set_position(player: ffi.VoidPtr, x: f32, y: f32, z: f32)
    fn godot_audio_player_3d_get_max_distance(player: ffi.VoidPtr) -> f32
    fn godot_audio_player_3d_set_max_distance(player: ffi.VoidPtr, distance: f32)
    fn godot_audio_player_3d_get_attenuation_filter_db(player: ffi.VoidPtr) -> f32
    fn godot_audio_player_3d_set_attenuation_filter_db(player: ffi.VoidPtr, attenuation: f32)

# FFI declarations for Unreal audio
extern "C":
    fn unreal_audio_component_play(component: ffi.VoidPtr)
    fn unreal_audio_component_stop(component: ffi.VoidPtr)
    fn unreal_audio_component_set_paused(component: ffi.VoidPtr, paused: bool)
    fn unreal_audio_component_is_playing(component: ffi.VoidPtr) -> bool
    fn unreal_audio_component_get_volume_multiplier(component: ffi.VoidPtr) -> f32
    fn unreal_audio_component_set_volume_multiplier(component: ffi.VoidPtr, volume: f32)
    fn unreal_audio_component_get_pitch_multiplier(component: ffi.VoidPtr) -> f32
    fn unreal_audio_component_set_pitch_multiplier(component: ffi.VoidPtr, pitch: f32)
    fn unreal_audio_component_is_looping(component: ffi.VoidPtr) -> bool
    fn unreal_audio_component_set_looping(component: ffi.VoidPtr, looping: bool)
    fn unreal_audio_component_get_playback_percent(component: ffi.VoidPtr) -> f32
    fn unreal_audio_component_get_duration(component: ffi.VoidPtr) -> f32


# Example usage:
#
# # Godot 2D audio
# let audio = GodotAudioPlayerAdapter::new(godot_player_ptr)
# audio.set_volume(0.8)
# audio.set_pitch(1.2)
# audio.play()
#
# # Godot 3D spatial audio
# let spatial_audio = GodotSpatialAudioAdapter::new(godot_3d_player_ptr)
# spatial_audio.set_position(10.0, 0.0, 5.0)
# spatial_audio.set_max_distance(50.0)
# spatial_audio.play()
#
# # Unreal audio
# let unreal_audio = UnrealAudioPlayerAdapter::new(unreal_component_ptr)
# unreal_audio.set_looping(true)
# unreal_audio.play()
