# Markdown Document Folding for MCP
# Collapses markdown documents into outline format

use core.*

# Markdown section types
pub enum SectionType:
    Heading1
    Heading2
    Heading3
    Heading4
    Heading5
    Heading6
    CodeBlock
    List
    Table
    Quote

impl SectionType:
    # =========================================================================
    # Helper Methods
    # =========================================================================

    pub fn is_heading1(self) -> bool:
        """Check if this is a level 1 heading.

        Returns:
            true for Heading1

        Example:
            SectionType::Heading1.is_heading1()  # → true
        """
        match self:
            case Heading1: true
            case _: false

    pub fn is_heading2(self) -> bool:
        """Check if this is a level 2 heading.

        Returns:
            true for Heading2

        Example:
            SectionType::Heading2.is_heading2()  # → true
        """
        match self:
            case Heading2: true
            case _: false

    pub fn is_heading3(self) -> bool:
        """Check if this is a level 3 heading.

        Returns:
            true for Heading3

        Example:
            SectionType::Heading3.is_heading3()  # → true
        """
        match self:
            case Heading3: true
            case _: false

    pub fn is_heading4(self) -> bool:
        """Check if this is a level 4 heading.

        Returns:
            true for Heading4

        Example:
            SectionType::Heading4.is_heading4()  # → true
        """
        match self:
            case Heading4: true
            case _: false

    pub fn is_heading5(self) -> bool:
        """Check if this is a level 5 heading.

        Returns:
            true for Heading5

        Example:
            SectionType::Heading5.is_heading5()  # → true
        """
        match self:
            case Heading5: true
            case _: false

    pub fn is_heading6(self) -> bool:
        """Check if this is a level 6 heading.

        Returns:
            true for Heading6

        Example:
            SectionType::Heading6.is_heading6()  # → true
        """
        match self:
            case Heading6: true
            case _: false

    pub fn is_code_block(self) -> bool:
        """Check if this is a code block.

        Returns:
            true for CodeBlock

        Example:
            SectionType::CodeBlock.is_code_block()  # → true
        """
        match self:
            case CodeBlock: true
            case _: false

    pub fn is_list(self) -> bool:
        """Check if this is a list.

        Returns:
            true for List

        Example:
            SectionType::List.is_list()  # → true
        """
        match self:
            case List: true
            case _: false

    pub fn is_table(self) -> bool:
        """Check if this is a table.

        Returns:
            true for Table

        Example:
            SectionType::Table.is_table()  # → true
        """
        match self:
            case Table: true
            case _: false

    pub fn is_quote(self) -> bool:
        """Check if this is a quote.

        Returns:
            true for Quote

        Example:
            SectionType::Quote.is_quote()  # → true
        """
        match self:
            case Quote: true
            case _: false

    pub fn is_heading(self) -> bool:
        """Check if this is any heading type.

        Returns:
            true for any Heading variant

        Example:
            SectionType::Heading3.is_heading()  # → true
            SectionType::CodeBlock.is_heading()  # → false
        """
        match self:
            case Heading1: true
            case Heading2: true
            case Heading3: true
            case Heading4: true
            case Heading5: true
            case Heading6: true
            case _: false

    pub fn heading_level(self) -> i32:
        """Get heading level (1-6), or 0 for non-headings.

        Returns:
            Heading level or 0

        Example:
            SectionType::Heading3.heading_level()  # → 3
            SectionType::CodeBlock.heading_level()  # → 0
        """
        match self:
            case Heading1: 1
            case Heading2: 2
            case Heading3: 3
            case Heading4: 4
            case Heading5: 5
            case Heading6: 6
            case _: 0

    pub fn is_content_block(self) -> bool:
        """Check if this is a content block (not a heading).

        Returns:
            true for CodeBlock, List, Table, or Quote

        Example:
            SectionType::CodeBlock.is_content_block()  # → true
            SectionType::Heading1.is_content_block()  # → false
        """
        match self:
            case CodeBlock: true
            case List: true
            case Table: true
            case Quote: true
            case _: false

    pub fn to_string(self) -> String:
        """Convert section type to string.

        Returns:
            Section type name

        Example:
            SectionType::Heading3.to_string()  # → "heading3"
        """
        match self:
            case Heading1: "heading1"
            case Heading2: "heading2"
            case Heading3: "heading3"
            case Heading4: "heading4"
            case Heading5: "heading5"
            case Heading6: "heading6"
            case CodeBlock: "code_block"
            case List: "list"
            case Table: "table"
            case Quote: "quote"

    pub fn description(self) -> String:
        """Get section type description.

        Returns:
            Human-readable description

        Example:
            SectionType::Heading3.description()
            # → "Level 3 heading"
        """
        match self:
            case Heading1: "Level 1 heading"
            case Heading2: "Level 2 heading"
            case Heading3: "Level 3 heading"
            case Heading4: "Level 4 heading"
            case Heading5: "Level 5 heading"
            case Heading6: "Level 6 heading"
            case CodeBlock: "Code block"
            case List: "List (bullet or numbered)"
            case Table: "Table"
            case Quote: "Quote block"

    pub fn summary(self) -> String:
        """Get section type summary.

        Returns:
            Human-readable summary

        Example:
            SectionType::Heading3.summary()
            # → "SectionType: heading3 (Level 3 heading, heading, level 3)"
        """
        let name = self.to_string()
        let desc = self.description()
        let section_kind = if self.is_heading():
            "heading"
        else:
            "content block"
        let level_info = if self.is_heading():
            ", level " + self.heading_level().to_string()
        else:
            ""
        return "SectionType: {name} ({desc}, {section_kind}{level_info})"

# Markdown section
pub class MarkdownSection:
    pub section_type: SectionType
    pub title: String
    pub content: String
    pub line_start: i64
    pub line_end: i64
    pub collapsed: bool

# Parse markdown document into sections
pub fn parse_markdown(source: String) -> List[MarkdownSection]:
    sections = []
    lines = source.split("\n")
    i = 0

    while i < lines.len():
        line = lines[i]

        # Heading detection
        if line.starts_with("# "):
            section = parse_heading(lines, i, SectionType.Heading1)
            sections.append(section)
            i = section.line_end + 1
        elif line.starts_with("## "):
            section = parse_heading(lines, i, SectionType.Heading2)
            sections.append(section)
            i = section.line_end + 1
        elif line.starts_with("### "):
            section = parse_heading(lines, i, SectionType.Heading3)
            sections.append(section)
            i = section.line_end + 1
        elif line.starts_with("#### "):
            section = parse_heading(lines, i, SectionType.Heading4)
            sections.append(section)
            i = section.line_end + 1
        elif line.starts_with("##### "):
            section = parse_heading(lines, i, SectionType.Heading5)
            sections.append(section)
            i = section.line_end + 1
        elif line.starts_with("###### "):
            section = parse_heading(lines, i, SectionType.Heading6)
            sections.append(section)
            i = section.line_end + 1

        # Code block detection
        elif line.starts_with("```"):
            section = parse_code_block(lines, i)
            sections.append(section)
            i = section.line_end + 1

        # List detection
        elif line.starts_with("- ") or line.starts_with("* ") or line.starts_with("+ "):
            section = parse_list(lines, i)
            sections.append(section)
            i = section.line_end + 1

        # Table detection
        elif line.contains("|"):
            section = parse_table(lines, i)
            sections.append(section)
            i = section.line_end + 1

        # Quote detection
        elif line.starts_with("> "):
            section = parse_quote(lines, i)
            sections.append(section)
            i = section.line_end + 1

        else:
            i = i + 1

    return sections

# Parse heading section
fn parse_heading(lines: List[String], start: i64, section_type: SectionType) -> MarkdownSection:
    title_line = lines[start]

    # Extract title (remove # prefix)
    title = title_line
    if section_type == SectionType.Heading1:
        title = title_line[2:]  # Remove "# "
    elif section_type == SectionType.Heading2:
        title = title_line[3:]  # Remove "## "
    elif section_type == SectionType.Heading3:
        title = title_line[4:]  # Remove "### "
    elif section_type == SectionType.Heading4:
        title = title_line[5:]  # Remove "#### "
    elif section_type == SectionType.Heading5:
        title = title_line[6:]  # Remove "##### "
    else:
        title = title_line[7:]  # Remove "###### "

    # Find content until next heading or end
    content_lines = []
    i = start + 1
    while i < lines.len():
        line = lines[i]
        if line.starts_with("#"):
            break
        content_lines.append(line)
        i = i + 1

    content = "\n".join(content_lines)

    return MarkdownSection:
        section_type: section_type
        title: title.strip()
        content: content
        line_start: start
        line_end: i - 1
        collapsed: true

# Parse code block
fn parse_code_block(lines: List[String], start: i64) -> MarkdownSection:
    first_line = lines[start]
    language = first_line[3:]  # After ```

    # Find closing ```
    content_lines = []
    i = start + 1
    while i < lines.len():
        line = lines[i]
        if line.starts_with("```"):
            break
        content_lines.append(line)
        i = i + 1

    content = "\n".join(content_lines)
    title = "Code block (" + language + ")"

    return MarkdownSection:
        section_type: SectionType.CodeBlock
        title: title
        content: content
        line_start: start
        line_end: i
        collapsed: true

# Parse list
fn parse_list(lines: List[String], start: i64) -> MarkdownSection:
    content_lines = []
    i = start

    while i < lines.len():
        line = lines[i]
        if not (line.starts_with("- ") or line.starts_with("* ") or line.starts_with("+ ") or line.starts_with("  ")):
            break
        content_lines.append(line)
        i = i + 1

    content = "\n".join(content_lines)
    item_count = 0
    for line in content_lines:
        if line.starts_with("- ") or line.starts_with("* ") or line.starts_with("+ "):
            item_count = item_count + 1

    title = "List (" + item_count.to_string() + " items)"

    return MarkdownSection:
        section_type: SectionType.List
        title: title
        content: content
        line_start: start
        line_end: i - 1
        collapsed: true

# Parse table
fn parse_table(lines: List[String], start: i64) -> MarkdownSection:
    content_lines = []
    i = start

    while i < lines.len():
        line = lines[i]
        if not line.contains("|"):
            break
        content_lines.append(line)
        i = i + 1

    content = "\n".join(content_lines)
    row_count = content_lines.len()
    title = "Table (" + row_count.to_string() + " rows)"

    return MarkdownSection:
        section_type: SectionType.Table
        title: title
        content: content
        line_start: start
        line_end: i - 1
        collapsed: true

# Parse quote
fn parse_quote(lines: List[String], start: i64) -> MarkdownSection:
    content_lines = []
    i = start

    while i < lines.len():
        line = lines[i]
        if not line.starts_with("> "):
            break
        content_lines.append(line)
        i = i + 1

    content = "\n".join(content_lines)
    title = "Quote"

    return MarkdownSection:
        section_type: SectionType.Quote
        title: title
        content: content
        line_start: start
        line_end: i - 1
        collapsed: true

# Format markdown sections for MCP
pub fn format_markdown_mcp(sections: List[MarkdownSection], show_all: bool) -> String:
    result = ""

    for section in sections:
        if section.collapsed and not show_all:
            result = result + format_collapsed_section(section) + "\n"
        else:
            result = result + format_expanded_section(section) + "\n"

    return result

# Format collapsed section
fn format_collapsed_section(section: MarkdownSection) -> String:
    mark = get_section_mark(section.section_type)
    return mark + " " + section.title + " { … }"

# Format expanded section
fn format_expanded_section(section: MarkdownSection) -> String:
    mark = get_section_mark(section.section_type)
    result = mark + " " + section.title + " {\n"
    result = result + section.content + "\n"
    result = result + "}"
    return result

# Get section block mark
fn get_section_mark(section_type: SectionType) -> String:
    if section_type == SectionType.Heading1:
        return "H1>"
    elif section_type == SectionType.Heading2:
        return "H2>"
    elif section_type == SectionType.Heading3:
        return "H3>"
    elif section_type == SectionType.Heading4:
        return "H4>"
    elif section_type == SectionType.Heading5:
        return "H5>"
    elif section_type == SectionType.Heading6:
        return "H6>"
    elif section_type == SectionType.CodeBlock:
        return "CB>"
    elif section_type == SectionType.List:
        return "L>"
    elif section_type == SectionType.Table:
        return "T>"
    else:
        return "Q>"
