# VSCode Tree View API
# Create custom tree views in the explorer sidebar

# External FFI declarations
extern fn vscode_tree_view_register(view_id: String, callback_id: i64): i64
extern fn vscode_tree_view_reveal(view_id: String, element_id: String, expand: bool): void
extern fn vscode_tree_view_refresh(view_id: String): void

# Tree item collapsible state
pub let TreeItemCollapsibleState_None: i32 = 0
pub let TreeItemCollapsibleState_Collapsed: i32 = 1
pub let TreeItemCollapsibleState_Expanded: i32 = 2

# Tree item context value (for menu contributions)
pub let TreeItemContext_File: String = "file"
pub let TreeItemContext_Folder: String = "folder"
pub let TreeItemContext_Root: String = "root"

# Tree item
pub class TreeItem:
    pub id: String
    pub label: String
    pub description: String
    pub tooltip: String
    pub collapsible_state: i32
    pub context_value: String
    pub icon_path: String
    pub resource_uri: String
    pub command: Option<Command>

    pub fn new(label: String): TreeItem =
        """Create tree item.

        Args:
            label: Item label

        Example:
            item = TreeItem.new("main.spl")
            item.icon_path = "$(file)"
            item.collapsible_state = TreeItemCollapsibleState_None
            item.context_value = TreeItemContext_File
        """
        TreeItem {
            id: "",
            label: label,
            description: "",
            tooltip: "",
            collapsible_state: TreeItemCollapsibleState_None,
            context_value: "",
            icon_path: "",
            resource_uri: "",
            command: none
        }

    pub fn set_command(self, command: String, title: String, args: List<String>):
        """Set command to execute on click.

        Args:
            command: Command ID
            title: Command title
            args: Command arguments

        Example:
            item.set_command("simple.openFile", "Open", ["file:///main.spl"])
        """
        self.command = some(Command.new(command, title, args))

# Command (for tree item actions)
pub class Command:
    pub command: String
    pub title: String
    pub arguments: List<String>

    pub fn new(command: String, title: String, arguments: List<String>): Command =
        """Create command."""
        Command {
            command: command,
            title: title,
            arguments: arguments
        }

# Tree data provider
pub class TreeDataProvider:
    pub view_id: String
    pub get_children_fn: fn(element_id: Option<String>): List<TreeItem>
    pub get_tree_item_fn: fn(element_id: String): Option<TreeItem>

    pub fn new(view_id: String): TreeDataProvider =
        """Create tree data provider.

        Args:
            view_id: Unique view identifier

        Example:
            provider = TreeDataProvider.new("simple.fileExplorer")
            provider.get_children_fn = fn(element):
                match element:
                    none:
                        # Return root items
                        return [TreeItem.new("Root 1"), TreeItem.new("Root 2")]
                    some(id):
                        # Return children of element
                        return []
        """
        TreeDataProvider {
            view_id: view_id,
            get_children_fn: fn(element): [],
            get_tree_item_fn: fn(element): none
        }

    pub fn get_children(self, element: Option<TreeItem>): List<TreeItem> =
        """Get child tree items.

        Args:
            element: Parent item (none for root)

        Returns:
            List of child items
        """
        match element:
            none:
                self.get_children_fn(none)
            some(item):
                self.get_children_fn(some(item.id))

    pub fn get_tree_item(self, element: String): Option<TreeItem> =
        """Get tree item by ID.

        Args:
            element: Element ID

        Returns:
            TreeItem if found
        """
        self.get_tree_item_fn(element)

    pub fn refresh(self):
        """Refresh entire tree view."""
        vscode_tree_view_refresh(self.view_id)

# Tree view
pub class TreeView:
    pub id: String
    pub provider: TreeDataProvider

    pub fn new(view_id: String, provider: TreeDataProvider): TreeView =
        """Create tree view.

        Args:
            view_id: View identifier (matches package.json contribution)
            provider: Tree data provider

        Example:
            provider = TreeDataProvider.new("simple.files")
            view = TreeView.new("simple.files", provider)
        """
        TreeView {
            id: view_id,
            provider: provider
        }

    pub fn reveal(self, element_id: String, expand: bool):
        """Reveal and optionally expand tree item.

        Args:
            element_id: Item ID to reveal
            expand: Whether to expand the item

        Example:
            view.reveal("file123", true)
        """
        vscode_tree_view_reveal(self.id, element_id, expand)

    pub fn refresh(self):
        """Refresh tree view."""
        self.provider.refresh()

# Register tree data provider
pub fn register_tree_data_provider(view_id: String, provider: TreeDataProvider): i64 =
    """Register tree data provider.

    Args:
        view_id: View identifier
        provider: Tree data provider

    Returns:
        Subscription ID for disposal

    Example:
        provider = TreeDataProvider.new("simple.fileExplorer")

        provider.get_children_fn = fn(element):
            match element:
                none:
                    # Root level
                    let root = TreeItem.new("src")
                    root.collapsible_state = TreeItemCollapsibleState_Collapsed
                    root.context_value = TreeItemContext_Folder
                    return [root]

                some(id):
                    if id == "src":
                        # Files in src
                        let file1 = TreeItem.new("main.spl")
                        file1.context_value = TreeItemContext_File
                        file1.set_command("simple.openFile", "Open", ["src/main.spl"])

                        return [file1]
                    else:
                        return []

        tree_view.register_tree_data_provider("simple.fileExplorer", provider)
    """
    # TODO: [stdlib][P3] Store provider callback
    let callback_id = 0
    vscode_tree_view_register(view_id, callback_id)

# Create tree view
pub fn create_tree_view(view_id: String, provider: TreeDataProvider): TreeView =
    """Create and register tree view.

    Args:
        view_id: View identifier
        provider: Tree data provider

    Returns:
        TreeView instance

    Example:
        provider = TreeDataProvider.new("simple.dependencies")
        view = tree_view.create_tree_view("simple.dependencies", provider)
    """
    register_tree_data_provider(view_id, provider)
    TreeView.new(view_id, provider)

# Helper: Create file tree item
pub fn create_file_item(label: String, uri: String): TreeItem =
    """Create file tree item.

    Args:
        label: File name
        uri: File URI

    Returns:
        Configured file item

    Example:
        item = tree_view.create_file_item("main.spl", "file:///workspace/main.spl")
    """
    let item = TreeItem.new(label)
    item.id = uri
    item.resource_uri = uri
    item.context_value = TreeItemContext_File
    item.icon_path = "$(file)"
    item.collapsible_state = TreeItemCollapsibleState_None
    item

# Helper: Create folder tree item
pub fn create_folder_item(label: String, uri: String): TreeItem =
    """Create folder tree item.

    Args:
        label: Folder name
        uri: Folder URI

    Returns:
        Configured folder item

    Example:
        item = tree_view.create_folder_item("src", "file:///workspace/src")
    """
    let item = TreeItem.new(label)
    item.id = uri
    item.resource_uri = uri
    item.context_value = TreeItemContext_Folder
    item.icon_path = "$(folder)"
    item.collapsible_state = TreeItemCollapsibleState_Collapsed
    item

# Helper: Create custom item
pub fn create_custom_item(label: String, icon: String, collapsible: bool): TreeItem =
    """Create custom tree item.

    Args:
        label: Item label
        icon: Icon path (e.g., "$(symbol-class)")
        collapsible: Whether item has children

    Returns:
        Custom tree item

    Example:
        item = tree_view.create_custom_item("Dependencies", "$(package)", true)
    """
    let item = TreeItem.new(label)
    item.icon_path = icon
    item.collapsible_state = if collapsible: TreeItemCollapsibleState_Collapsed else: TreeItemCollapsibleState_None
    item
