# Test Feature Doc Compatibility
# Verifies that BDD tests can register features properly

use spec.feature_doc.FeatureMetadata
use spec.feature_doc.feature_metadata
use spec.feature_doc.get_feature
use spec.feature_doc.get_features_by_category
use spec.feature_doc.get_all_features
use spec.feature_doc.get_all_categories
use spec.feature_doc.clear_feature_registry

print("=== Feature Documentation Compatibility Test ===\n")

# Clear registry for clean test
clear_feature_registry()

print("Step 1: Register test features from BDD tests")
print("----------------------------------------------")

# Simulate what BDD tests do
let test_feature = FeatureMetadata {
    id: 999,
    name: "Compatibility Test Feature",
    category: "Testing",
    difficulty: 1,
    status: "âœ… Complete",
    impl_type: "Simple",
    spec_ref: "test",
    files: ["test.spl"],
    tests: ["test_spec.spl"],
    description: "Test feature for compatibility verification",
    code_examples: ['test()'],
    dependencies: [],
    required_by: [],
    notes: "BDD test-driven compatibility check"
}

# Register using the API
feature_metadata(test_feature)

print("âœ“ Feature registered: #" + test_feature.id + " - " + test_feature.name)
print("")

print("Step 2: Verify feature retrieval")
print("----------------------------------")

# Try to get the feature back
let retrieved_opt = get_feature(999)

if retrieved_opt.is_some():
    let retrieved = retrieved_opt.unwrap()
    print("âœ“ Feature retrieved successfully")
    print("  ID: " + retrieved.id)
    print("  Name: " + retrieved.name)
    print("  Status: " + retrieved.status)
    print("  Files: " + retrieved.files.len() + " file(s)")
    print("  Tests: " + retrieved.tests.len() + " test file(s)")
else:
    print("âœ— FAILED: Could not retrieve feature")
print("")

print("Step 3: Verify category grouping")
print("----------------------------------")

# Get features by category
let category_features = get_features_by_category("Testing")

print("âœ“ Features in 'Testing' category: " + category_features.len())

for feature in category_features:
    print("  - #" + feature.id + ": " + feature.name)
print("")

print("Step 4: Verify all features retrieval")
print("---------------------------------------")

let all_features = get_all_features()
print("âœ“ Total features in registry: " + all_features.len())
print("")

print("Step 5: Test multiple feature registration")
print("--------------------------------------------")

# Register multiple features like BDD tests would
let bdd_features = [
    FeatureMetadata {
        id: 1000,
        name: "DateTime BDD Test",
        category: "Date and Time",
        difficulty: 3,
        status: "ðŸ”„ In Progress",
        impl_type: "Simple",
        spec_ref: "doc/spec/stdlib.md",
        files: ["datetime.spl"],
        tests: ["datetime_spec.spl"],
        description: "DateTime from BDD test",
        code_examples: ['DateTime.now()'],
        dependencies: [],
        required_by: [],
        notes: "BDD test registration"
    },
    FeatureMetadata {
        id: 1001,
        name: "Math BDD Test",
        category: "Math and Numeric",
        difficulty: 2,
        status: "âœ… Complete",
        impl_type: "Simple",
        spec_ref: "doc/spec/stdlib.md",
        files: ["math.spl"],
        tests: ["math_spec.spl"],
        description: "Math from BDD test",
        code_examples: ['math.sin(x)'],
        dependencies: [],
        required_by: [],
        notes: "BDD test registration"
    },
    FeatureMetadata {
        id: 1002,
        name: "Regex BDD Test",
        category: "Regular Expressions",
        difficulty: 3,
        status: "ðŸ”„ In Progress",
        impl_type: "Simple",
        spec_ref: "doc/spec/stdlib.md",
        files: ["regex.spl"],
        tests: ["regex_spec.spl"],
        description: "Regex from BDD test",
        code_examples: ['regex.match(pattern, text)'],
        dependencies: [],
        required_by: [],
        notes: "BDD test registration"
    }
]

for feature in bdd_features:
    feature_metadata(feature)
    print("âœ“ Registered #" + feature.id + ": " + feature.name)
print("")

print("Step 6: Verify all categories")
print("-------------------------------")

let categories = get_all_categories()
print("âœ“ Categories found: " + categories.len())

for category in categories:
    let cat_features = get_features_by_category(category)
    print("  " + category + ": " + cat_features.len() + " feature(s)")
print("")

print("Step 7: Compatibility Summary")
print("===============================")
print("")

let final_count = get_all_features().len()

print("âœ… Feature Doc Compatibility: VERIFIED")
print("")
print("Summary:")
print("  - Feature registration: âœ“ Working")
print("  - Feature retrieval: âœ“ Working")
print("  - Category grouping: âœ“ Working")
print("  - Multiple registration: âœ“ Working")
print("  - Total features registered: " + final_count)
print("")
print("Conclusion: BDD tests can successfully register features")
print("           using the existing feature_doc.spl framework!")
print("")
print("==========================================================")
