# Math Backend - Computation backend selection for math blocks
#
# Provides backend selection for m{} math expressions:
# - Auto: Runtime auto-selection (default, picks fastest available)
# - CPU: Native interpreter (always available)
# - Torch: PyTorch tensor backend
# - CUDA: Direct CUDA computation

# ============================================================================
# Backend Types
# ============================================================================

enum MathBackend:
    """Computation backend for math expressions."""
    Auto            # Runtime auto-select (DEFAULT)
    CPU             # Native interpreter
    Torch           # PyTorch tensor backend
    CUDA            # Direct CUDA

impl MathBackend:
    fn is_available() -> bool:
        """Check if this backend is available at runtime."""
        match self:
            case Auto: true
            case CPU: true
            case Torch: _torch_available()
            case CUDA: _cuda_available()

    fn to_string() -> text:
        match self:
            case Auto: "auto"
            case CPU: "cpu"
            case Torch: "torch"
            case CUDA: "cuda"

enum RenderFormat:
    """Output format for math expression rendering."""
    LaTeX           # \sum_{i=1}^{n} i^{2}
    MathML          # <mrow><munderover>...
    Text            # Unicode text
    Lean            # Lean4 expression

impl RenderFormat:
    fn to_string() -> text:
        match self:
            case LaTeX: "latex"
            case MathML: "mathml"
            case Text: "text"
            case Lean: "lean"

struct BackendCapability:
    """Capabilities of a computation backend."""
    supports_tensor: bool
    supports_autograd: bool
    supports_symbolic: bool
    max_precision: text
    estimated_speed: f64      # relative to CPU=1.0

impl BackendCapability:
    static fn for_backend(backend: MathBackend) -> BackendCapability:
        """Get capabilities for a given backend."""
        match backend:
            case Auto | CPU:
                BackendCapability(
                    supports_tensor: true,
                    supports_autograd: false,
                    supports_symbolic: true,
                    max_precision: "f64",
                    estimated_speed: 1.0
                )
            case Torch:
                BackendCapability(
                    supports_tensor: true,
                    supports_autograd: true,
                    supports_symbolic: false,
                    max_precision: "f64",
                    estimated_speed: 10.0
                )
            case CUDA:
                BackendCapability(
                    supports_tensor: true,
                    supports_autograd: true,
                    supports_symbolic: false,
                    max_precision: "f64",
                    estimated_speed: 50.0
                )

# ============================================================================
# Backend Selection
# ============================================================================

fn select_backend(preferred: MathBackend = MathBackend.Auto) -> MathBackend:
    """Select the best available backend.

    If preferred is not Auto and is available, it is used.
    Otherwise, auto-selects based on availability and speed.
    """
    if preferred != MathBackend.Auto:
        if preferred.is_available():
            return preferred

    # Auto-selection: try fastest first
    if MathBackend.CUDA.is_available():
        return MathBackend.CUDA
    if MathBackend.Torch.is_available():
        return MathBackend.Torch
    return MathBackend.CPU

# ============================================================================
# Private Helpers (FFI stubs)
# ============================================================================

fn _torch_available() -> bool:
    """Check PyTorch availability via FFI."""
    # TODO: Wire to Rust FFI check
    false

fn _cuda_available() -> bool:
    """Check CUDA availability via FFI."""
    # TODO: Wire to Rust FFI check
    false

# ============================================================================
# Exports
# ============================================================================

export MathBackend, RenderFormat, BackendCapability
export select_backend
