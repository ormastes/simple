# Full-featured Docker image for comprehensive test execution
# Base: Ubuntu 24.04 (~80MB) + Simple runtime (27MB) + build tools (~300MB)
# Total size: ~450MB
#
# Use this image for:
# - Integration tests requiring system tools
# - Debugging test failures with full toolchain
# - QEMU/baremetal tests
# - Database tests with SQLite/PostgreSQL clients
#
# Build:  docker build -t simple-test-full:latest -f docker/Dockerfile.test-full .
# Usage:  docker run --rm -v $(pwd):/workspace:ro --memory=2g --cpus=4.0 \
#           simple-test-full:latest test test/integration/

FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive

# Install comprehensive toolset
# - Build tools: gcc, g++, make, cmake for native compilation tests
# - Debugging: gdb, strace, ltrace for test debugging
# - System tools: procps, psmisc for process management
# - Network tools: curl, wget for integration tests
# - Database clients: sqlite3 for database tests
# - QEMU: for cross-platform testing
RUN apt-get update -qq && apt-get install -y -qq --no-install-recommends \
    # Build essentials
    build-essential \
    cmake \
    clang \
    llvm \
    # Debugging tools
    gdb \
    strace \
    ltrace \
    valgrind \
    # System utilities
    procps \
    psmisc \
    util-linux \
    coreutils \
    # Network tools
    curl \
    wget \
    ca-certificates \
    # Database tools
    sqlite3 \
    # QEMU for cross-platform testing
    qemu-user \
    qemu-user-static \
    # Other utilities
    bash \
    git \
    vim-tiny \
    && rm -rf /var/lib/apt/lists/*

# Create non-root test user
# Same UID/GID as test-isolation for consistency
RUN groupadd -g 1001 testuser && \
    useradd -u 1001 -g testuser -m -s /bin/bash testuser

# Copy Simple runtime binary
COPY bin/release/simple /usr/local/bin/simple
RUN chmod +x /usr/local/bin/simple && \
    chown root:root /usr/local/bin/simple

# Core dump configuration
# The /proc write requires --privileged at runtime; best-effort here.
# Actual core pattern is set via: docker run --ulimit core=-1:-1
RUN echo '/tmp/core.%e.%p' > /proc/sys/kernel/core_pattern 2>/dev/null || true
RUN mkdir -p /tmp/cores && chmod 1777 /tmp/cores

# Create workspace and temp directories
WORKDIR /workspace
RUN chown testuser:testuser /workspace && \
    mkdir -p /tmp/simple-test && \
    chown testuser:testuser /tmp/simple-test

# Switch to non-root user
USER testuser

# Set up environment variables
ENV SIMPLE_TEST_TEMP_DIR=/tmp/simple-test \
    SIMPLE_TEST_MODE=full \
    PATH=/usr/local/bin:/usr/bin:/bin

# Health check: verify Simple runtime + basic tools
HEALTHCHECK --interval=30s --timeout=5s --start-period=5s --retries=3 \
    CMD /usr/local/bin/simple --version && \
        gcc --version > /dev/null && \
        sqlite3 --version > /dev/null || exit 1

# Default entrypoint: Simple test runner
ENTRYPOINT ["/usr/local/bin/simple"]
CMD ["test"]

# Labels for metadata
LABEL org.opencontainers.image.title="Simple Language Test Full Environment" \
      org.opencontainers.image.description="Full-featured container for comprehensive Simple test execution with debugging tools" \
      org.opencontainers.image.version="1.0.0" \
      org.opencontainers.image.authors="Simple Language Project" \
      org.opencontainers.image.base.name="docker.io/library/ubuntu:24.04"
