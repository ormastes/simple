# CMakeLists.txt - Bootstrap Build for Generated C++20 Code
#
# This directory contains C++20 source generated by:
#   bin/simple compile --backend=c -o src/compiler_cpp/ src/app/cli/main.spl
#
# The generated code links against runtime.c/runtime.h from compiler_seed/.
#
# Build:
#   cmake -B build -G Ninja -DCMAKE_CXX_COMPILER=clang++ -DCMAKE_C_COMPILER=clang -S src/compiler_cpp
#   ninja -C build
#
# This produces a `simple` binary that can compile Simple code.
# The bootstrap approach follows Go/Zig: generated C++ is committed to repo,
# so anyone can bootstrap from scratch with just CMake + Clang.

cmake_minimum_required(VERSION 3.20)
project(simple LANGUAGES C CXX)

set(CMAKE_C_STANDARD 11)
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Runtime sources from compiler_seed/
set(RUNTIME_DIR "${CMAKE_CURRENT_SOURCE_DIR}/../compiler_seed")

# Runtime C files
set(RUNTIME_SOURCES
    ${RUNTIME_DIR}/runtime.c
    ${RUNTIME_DIR}/runtime_thread.c
)

# Support both single-file and multi-file generated code
if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/generated_sources.cmake")
    # Multi-file mode: per-module .cpp files with CMake structure
    include(${CMAKE_CURRENT_SOURCE_DIR}/generated_sources.cmake)
    add_executable(simple
        ${GENERATED_ROOT_SOURCES}
        ${RUNTIME_SOURCES}
    )
    foreach(LIB ${GENERATED_OBJECT_LIBS})
        target_link_libraries(simple PRIVATE ${LIB})
    endforeach()
else()
    # Single-file mode (backward compatible)
    file(GLOB GENERATED_SOURCES "${CMAKE_CURRENT_SOURCE_DIR}/*.cpp")
    add_executable(simple
        ${GENERATED_SOURCES}
        ${RUNTIME_SOURCES}
    )
endif()

target_include_directories(simple PRIVATE
    ${RUNTIME_DIR}
    ${RUNTIME_DIR}/platform
)

# Link system libraries
if(UNIX)
    target_link_libraries(simple PRIVATE pthread dl m)
endif()

if(WIN32)
    target_link_libraries(simple PRIVATE ws2_32)
endif()

# Compiler flags
if(CMAKE_CXX_COMPILER_ID MATCHES "Clang|GNU")
    target_compile_options(simple PRIVATE
        -Wall -Wextra -Wno-unused-parameter -Wno-unused-variable
        $<$<CONFIG:Release>:-O2>
        $<$<CONFIG:Debug>:-g -O0>
    )
endif()

if(CMAKE_CXX_COMPILER_ID MATCHES "MSVC")
    target_compile_options(simple PRIVATE
        /W3 /wd4100 /wd4189
        $<$<CONFIG:Release>:/O2>
    )
endif()

install(TARGETS simple DESTINATION bin)
