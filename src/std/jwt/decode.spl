# JWT Decoding Module
#
# This module handles JWT token parsing and JSON decoding operations.

# Import encoding functions (needed for base64url_decode)
# Note: In Simple, we'll assume these are available via the facade

# ============================================================================
# JSON Decoding
# ============================================================================

# Simple JSON parser - extract key-value pairs from JSON object
fn json_parse_object(json: text) -> list:
    var result = []
    var trimmed = json.trim()

    # Remove outer braces
    if trimmed.starts_with("{") and trimmed.ends_with("}"):
        trimmed = trimmed.substring(1, trimmed.length() - 1)

    # Split by comma (simplified - doesn't handle nested objects)
    var pairs = trimmed.split(",")
    var i = 0
    var pairs_len = pairs.length()

    while i < pairs_len:
        var pair = pairs.at(i)
        var parts = pair.split(":")

        if parts.length() >= 2:
            var key = parts.at(0)
            var value = parts.at(1)

            # Remove quotes and whitespace
            key = key.trim()
            key = key.replace("\"", "")

            value = value.trim()
            value = value.replace("\"", "")

            # Add to result
            var tuple = [key, value]
            result = result + [tuple]

        i = i + 1

    return result

# Decode JSON to claims list
fn json_decode(json: text) -> list:
    return json_parse_object(json)

# Convert JSON string to claims (alias)
fn json_to_claims(json: text) -> list:
    return json_decode(json)

# ============================================================================
# JWT Token Parsing
# ============================================================================

# Split JWT token into three parts: [header, payload, signature]
fn split_token(token: text) -> list:
    var parts = token.split(".")
    if parts.length() != 3:
        return []
    return parts

# Join JWT parts with "."
fn join_parts(parts: list) -> text:
    if parts.length() != 3:
        return ""
    var part0 = parts.at(0)
    var part1 = parts.at(1)
    var part2 = parts.at(2)
    return part0 + "." + part1 + "." + part2

# Parse JWT token structure (no verification)
fn parse_jwt(token: text) -> list:
    var parts = split_token(token)
    if parts.length() != 3:
        return []
    return parts
