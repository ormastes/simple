# Shell Environment Module
#
# Simple facade module for environment variable operations.
# Provides FFI access to environment variables and working directory.
#
# Used by: test/unit/std/env_spec.spl
#
# Functions:
#   get(key) -> text           Get environment variable
#   set(key, value) -> bool    Set environment variable
#   cwd() -> text              Get current working directory

# FFI declarations for runtime functions
extern fn rt_env_get(key: text) -> text
extern fn rt_env_set(key: text, value_str: text) -> bool
extern fn rt_process_run(cmd: text, args: [text]) -> (text, text, i64)

# Get environment variable value
# Returns empty string if not set
fn get(key: text) -> text:
    val result = rt_env_get(key)
    if result == nil:
        ""
    else:
        result

# Set environment variable
# Returns true on success, false on failure
fn set(key: text, value: text) -> bool:
    rt_env_set(key, value)

# Lazy-initialized current working directory cache
# Prevents FFI hang during module initialization
var _cwd_cache: text? = nil

# Get current working directory
# Uses shell command 'pwd' to get the path
# Cached to avoid repeated FFI calls
fn cwd() -> text:
    # Return cached value if available
    if val cached = _cwd_cache:
        return cached

    # Otherwise get from shell
    val (out, err, code) = rt_process_run("/bin/sh", ["-c", "pwd"])
    val result = if code == 0:
        out.trim()
    else:
        "."

    # Cache for future calls
    _cwd_cache = Some(result)
    result

export get, set, cwd
