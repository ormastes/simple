# CLI Help Module
# Help text generation

use std.text.{NL}

# =============================================================================
# Help Text Generation
# =============================================================================

# Generate full help text for parser
fn generate_help(parser: tuple) -> text:
    val name = parser[0]
    val version = parser[1]
    val description = parser[6]

    var help_text = ""

    # Header
    help_text = "{help_text}{name} {version}" + NL
    if description != "":
        help_text = "{help_text}{description}" + NL
    help_text = help_text + NL

    # Usage
    val usage = generate_usage(parser)
    help_text = help_text + "{usage}" + NL + NL

    # Flags
    val flags = parser[2]
    if len(flags) > 0:
        help_text = help_text + "FLAGS:" + NL
        var i = 0
        while i < len(flags):
            val flag = flags[i]
            val flag_line = format_flag_help(flag)
            help_text = help_text + "  {flag_line}" + NL
            i = i + 1
        help_text = help_text + NL

    # Options
    val options = parser[3]
    if len(options) > 0:
        help_text = help_text + "OPTIONS:" + NL
        var j = 0
        while j < len(options):
            val option = options[j]
            val option_line = format_option_help(option)
            help_text = help_text + "  {option_line}" + NL
            j = j + 1
        help_text = help_text + NL

    # Positionals
    val positionals = parser[4]
    if len(positionals) > 0:
        help_text = help_text + "ARGUMENTS:" + NL
        var k = 0
        while k < len(positionals):
            val pos = positionals[k]
            val pos_line = format_positional_help(pos)
            help_text = help_text + "  {pos_line}" + NL
            k = k + 1
        help_text = help_text + NL

    # Commands
    val commands = parser[5]
    if len(commands) > 0:
        help_text = help_text + "COMMANDS:" + NL
        var m = 0
        while m < len(commands):
            val cmd = commands[m]
            val cmd_name = cmd[0]
            val cmd_help = cmd[1]
            help_text = help_text + "  {cmd_name}" + NL
            help_text = help_text + "      {cmd_help}" + NL
            m = m + 1
        help_text = help_text + NL

    help_text

# Generate usage line
fn generate_usage(parser: tuple) -> text:
    val name = parser[0]
    var usage = "USAGE: {name}"

    val flags = parser[2]
    if len(flags) > 0:
        usage = "{usage} [FLAGS]"

    val options = parser[3]
    if len(options) > 0:
        usage = "{usage} [OPTIONS]"

    val commands = parser[5]
    if len(commands) > 0:
        usage = "{usage} <COMMAND>"

    val positionals = parser[4]
    var i = 0
    while i < len(positionals):
        val pos = positionals[i]
        val pos_name = pos[0]
        val is_required = pos[3]
        if is_required:
            usage = "{usage} <{pos_name}>"
        else:
            usage = "{usage} [{pos_name}]"
        i = i + 1

    usage

# Format flag for help display
fn format_flag_help(flag: tuple) -> text:
    val short = flag[1]
    val long = flag[2]
    val help = flag[3]

    var line = ""
    if short != "":
        line = "-{short}"
    if long != "":
        if line != "":
            line = "{line}, --{long}"
        else:
            line = "--{long}"

    val padded = pad_right(line, 20)
    "{padded}{help}"

# Format option for help display
fn format_option_help(option: tuple) -> text:
    val short = option[1]
    val long = option[2]
    val default = option[3]
    val help = option[4]
    val is_required = option[6]

    var line = ""
    if short != "":
        line = "-{short} <value>"
    if long != "":
        if line != "":
            line = "{line}, --{long}=<value>"
        else:
            line = "--{long}=<value>"

    val padded = pad_right(line, 20)
    var help_text = "{padded}{help}"

    if is_required:
        help_text = "{help_text} [required]"
    else:
        if default != "":
            help_text = "{help_text} [default: {default}]"

    help_text

# Format positional for help display
fn format_positional_help(pos: tuple) -> text:
    val name = pos[0]
    val help = pos[1]
    val is_required = pos[3]

    var line = ""
    if is_required:
        line = "<{name}>"
    else:
        line = "[{name}]"

    val padded = pad_right(line, 20)
    "{padded}{help}"

# Helper function for formatting
fn pad_right(text: text, width: i64) -> text:
    val current_len = len(text)
    if current_len >= width:
        return text
    val spaces_needed = width - current_len
    var result = text
    var i = 0
    while i < spaces_needed:
        result = "{result} "
        i = i + 1
    result
