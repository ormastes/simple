# CSV Validation Functions

# Helper (from utilities)
fn char_at(s: text, index: i64) -> text:
    val len = s.length()
    if index < 0 or index >= len:
        return ""
    val substring = s.substring(index, index + 1)
    substring

fn is_whitespace_char(c: text) -> bool:
    val is_space = c == " "
    val is_tab = c == "\t"
    val is_nl = c == "\n"
    val is_cr = c == "\r"
    val result1 = is_space or is_tab
    val result2 = is_nl or is_cr
    val final_result = result1 or result2
    final_result

fn trim_left(s: text) -> text:
    var i = 0
    val len = s.length()
    loop:
        if i >= len:
            break
        val c = char_at(s, i)
        val is_ws = is_whitespace_char(c)
        if not is_ws:
            break
        i = i + 1
    val result = s.substring(i, len)
    result

fn trim_right(s: text) -> text:
    var i = s.length()
    loop:
        if i <= 0:
            break
        val c = char_at(s, i - 1)
        val is_ws = is_whitespace_char(c)
        if not is_ws:
            break
        i = i - 1
    val result = s.substring(0, i)
    result

fn trim_whitespace(s: text) -> text:
    val temp = trim_left(s)
    val result = trim_right(temp)
    result

# ============================================================================
# Data Validation
# ============================================================================

fn validate_row_length(row: list, expected_length: i64) -> bool:
    val actual_length = row.length()
    actual_length == expected_length

fn validate_table_uniform_rows(table: CsvTable) -> bool:
    val row_count = table.rows.length()
    if row_count == 0:
        return true

    val first_row = table.rows.at(0)
    val expected_length = first_row.length()

    var i = 1
    loop:
        if i >= row_count:
            break
        val row = table.rows.at(i)
        val is_valid = validate_row_length(row, expected_length)
        if not is_valid:
            return false
        i = i + 1

    true

fn validate_headers_match_columns(table: CsvTable) -> bool:
    val header_count = table.headers.length()
    if header_count == 0:
        return true
    val col_count = get_column_count(table)
    header_count == col_count

fn is_numeric_field(field: text) -> bool:
    val trimmed = trim_whitespace(field)
    val len = trimmed.length()
    if len == 0:
        return false

    var i = 0
    var has_digit = false
    var has_dot = false

    loop:
        if i >= len:
            break
        val c = char_at(trimmed, i)
        val is_minus = c == "-"
        val is_plus = c == "+"
        val is_dot = c == "."
        val is_digit = c >= "0" and c <= "9"

        if is_minus or is_plus:
            if i != 0:
                return false
        else:
            if is_dot:
                if has_dot:
                    return false
                has_dot = true
            else:
                if is_digit:
                    has_digit = true
                else:
                    return false
        i = i + 1

    has_digit

fn validate_column_numeric(table: CsvTable, col_index: i64) -> bool:
    var i = 0
    val row_count = table.rows.length()

    loop:
        if i >= row_count:
            break
        val row = table.rows.at(i)
        val field_count = row.length()
        if col_index >= 0 and col_index < field_count:
            val field = row.at(col_index)
            val is_num = is_numeric_field(field)
            if not is_num:
                return false
        i = i + 1

    true

fn validate_column_not_empty(table: CsvTable, col_index: i64) -> bool:
    var i = 0
    val row_count = table.rows.length()

    loop:
        if i >= row_count:
            break
        val row = table.rows.at(i)
        val field_count = row.length()
        if col_index >= 0 and col_index < field_count:
            val field = row.at(col_index)
            val trimmed = trim_whitespace(field)
            val len = trimmed.length()
            if len == 0:
                return false
        i = i + 1

    true

fn validate_row_not_empty(table: CsvTable, row_index: i64) -> bool:
    val row = get_row(table, row_index)
    val field_count = row.length()
    var i = 0
    loop:
        if i >= field_count:
            break
        val field = row.at(i)
        val trimmed = trim_whitespace(field)
        val len = trimmed.length()
        if len > 0:
            return true
        i = i + 1
    false

fn count_empty_rows(table: CsvTable) -> i64:
    var count = 0
    var i = 0
    val row_count = table.rows.length()
    loop:
        if i >= row_count:
            break
        val is_empty = not validate_row_not_empty(table, i)
        if is_empty:
            count = count + 1
        i = i + 1
    count

# Helper placeholders
fn get_row(table: CsvTable, index: i64) -> list:
    val row_count = table.rows.length()
    if index < 0 or index >= row_count:
        return []
    table.rows.at(index)

fn get_column_count(table: CsvTable) -> i64:
    val row_count = table.rows.length()
    if row_count == 0:
        return 0
    val first_row = table.rows.at(0)
    first_row.length()
