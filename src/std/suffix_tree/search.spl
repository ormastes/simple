# Suffix Tree Search Module

# ============================================================================
# Basic Operations
# ============================================================================

fn suffix_tree_search(tree: (text, list, i64), pattern: text) -> bool:
    """Search for a pattern in the suffix tree - O(m) time"""
    val text_val = tree.0
    val nodes = tree.1
    val root_id = tree.2

    var current_id = root_id
    var pos = 0
    val pattern_len = text_length(pattern)

    while pos < pattern_len:
        val current_char = text_char_at(pattern, pos)
        val current_node = list_get(nodes, current_id)
        val children = current_node.2

        var found = false
        var child_idx = 0
        var matching_child_id = -1

        while child_idx < list_length(children):
            val child_entry = list_get(children, child_idx)
            val edge_char = child_entry.0
            val child_id = child_entry.1

            if edge_char == current_char:
                found = true
                matching_child_id = child_id
                child_idx = list_length(children)

            child_idx = child_idx + 1

        if found:
            current_id = matching_child_id
            pos = pos + 1
        else:
            return false

    true

fn suffix_tree_contains(tree: (text, list, i64), substring: text) -> bool:
    """Check if substring exists in the tree"""
    suffix_tree_search(tree, substring)

fn suffix_tree_find_all_occurrences(tree: (text, list, i64), pattern: text) -> list:
    """Find all starting positions of pattern in text"""
    val text_val = tree.0
    val nodes = tree.1
    val root_id = tree.2

    var current_id = root_id
    var pos = 0
    val pattern_len = text_length(pattern)

    # Navigate to the end of pattern
    while pos < pattern_len:
        val current_char = text_char_at(pattern, pos)
        val current_node = list_get(nodes, current_id)
        val children = current_node.2

        var found = false
        var child_idx = 0
        var matching_child_id = -1

        while child_idx < list_length(children):
            val child_entry = list_get(children, child_idx)
            val edge_char = child_entry.0
            val child_id = child_entry.1

            if edge_char == current_char:
                found = true
                matching_child_id = child_id
                child_idx = list_length(children)

            child_idx = child_idx + 1

        if found:
            current_id = matching_child_id
            pos = pos + 1
        else:
            return []

    # Collect all leaf positions from this subtree
    suffix_tree_collect_leaves(tree, current_id)

fn suffix_tree_collect_leaves(tree: (text, list, i64), node_id: i64) -> list:
    """Collect all leaf positions from subtree rooted at node_id"""
    val nodes = tree.1
    val node = list_get(nodes, node_id)
    val children = node.2

    if list_length(children) == 0:
        return [node.0]

    var positions = []
    var child_idx = 0

    while child_idx < list_length(children):
        val child_entry = list_get(children, child_idx)
        val child_id = child_entry.1
        val child_positions = suffix_tree_collect_leaves(tree, child_id)
        positions = list_concat(positions, child_positions)
        child_idx = child_idx + 1

    positions


# Export all public functions
