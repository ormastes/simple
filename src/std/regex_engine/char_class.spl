# Regular Expression Engine - Character Class Utilities
#
# Character class creation, parsing, and matching.

from .char_utils import char_code, string_from_code

# ============================================================================
# CHARACTER CLASS UTILITIES
# ============================================================================

fn char_class_create(definition: text, negated: bool) -> any:
    """Create character class from definition string."""
    (definition, negated)

fn char_class_parse(definition: text) -> [text]:
    """Parse character class definition into list of characters."""
    var chars = []
    var i = 0
    while i < definition.len():
        val ch = definition[i:i + 1]
        if i + 2 < definition.len():
            val next = definition[i + 1:i + 2]
            val after = definition[i + 2:i + 3]
            if next == "-":
                val start_code = char_code(ch)
                val end_code = char_code(after)
                var code = start_code
                while code <= end_code:
                    chars.push(string_from_code(code))
                    code = code + 1
                i = i + 3
            else:
                chars.push(ch)
                i = i + 1
        else:
            chars.push(ch)
            i = i + 1
    chars

fn char_class_matches(char_class: any, ch: text) -> bool:
    """Check if character matches character class."""
    val definition = char_class.0
    val negated = char_class.1
    val chars = char_class_parse(definition)
    var found = false
    var i = 0
    while i < chars.len():
        if chars[i] == ch:
            found = true
        i = i + 1
    if negated:
        return not found
    found

fn char_class_empty() -> any:
    """Create empty character class."""
    ("", false)

fn char_class_any() -> any:
    """Create character class matching any character (dot)."""
    ("", false)

fn char_class_digit() -> any:
    """Create character class for digits [0-9]."""
    ("0-9", false)

fn char_class_word() -> any:
    """Create character class for word characters [a-zA-Z0-9_]."""
    ("a-zA-Z0-9_", false)

fn char_class_space() -> any:
    """Create character class for whitespace [ \t\n\r]."""
    (" \t\n\r", false)

export char_class_create, char_class_parse, char_class_matches
export char_class_empty, char_class_any, char_class_digit, char_class_word, char_class_space
