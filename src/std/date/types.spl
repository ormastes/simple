# Date Types and Constants Module
# Type definitions and constant values for date handling

# ============================================================================
# Constants
# ============================================================================

# Days of the week (ISO 8601: Monday=1, Sunday=7)
val MONDAY = 1
val TUESDAY = 2
val WEDNESDAY = 3
val THURSDAY = 4
val FRIDAY = 5
val SATURDAY = 6
val SUNDAY = 7

# Month constants
val JANUARY = 1
val FEBRUARY = 2
val MARCH = 3
val APRIL = 4
val MAY = 5
val JUNE = 6
val JULY = 7
val AUGUST = 8
val SEPTEMBER = 9
val OCTOBER = 10
val NOVEMBER = 11
val DECEMBER = 12

# Day names for display
fn day_name(day: i64) -> text:
    if day == 1:
        return "Monday"
    if day == 2:
        return "Tuesday"
    if day == 3:
        return "Wednesday"
    if day == 4:
        return "Thursday"
    if day == 5:
        return "Friday"
    if day == 6:
        return "Saturday"
    if day == 7:
        return "Sunday"
    return "Invalid"

# Month names for display
fn month_name(month: i64) -> text:
    if month == 1:
        return "January"
    if month == 2:
        return "February"
    if month == 3:
        return "March"
    if month == 4:
        return "April"
    if month == 5:
        return "May"
    if month == 6:
        return "June"
    if month == 7:
        return "July"
    if month == 8:
        return "August"
    if month == 9:
        return "September"
    if month == 10:
        return "October"
    if month == 11:
        return "November"
    if month == 12:
        return "December"
    return "Invalid"

# Short month names (3 letters)
fn month_abbrev(month: i64) -> text:
    if month == 1:
        return "Jan"
    if month == 2:
        return "Feb"
    if month == 3:
        return "Mar"
    if month == 4:
        return "Apr"
    if month == 5:
        return "May"
    if month == 6:
        return "Jun"
    if month == 7:
        return "Jul"
    if month == 8:
        return "Aug"
    if month == 9:
        return "Sep"
    if month == 10:
        return "Oct"
    if month == 11:
        return "Nov"
    if month == 12:
        return "Dec"
    return "Inv"

# ============================================================================
# Core Date Creation
# ============================================================================

# Create a date from year, month, day components
# Returns a tuple (year, month, day) or nil if invalid
fn from_ymd(year: i64, month: i64, day: i64) -> any:
    if is_valid_date(year, month, day):
        return (year, month, day)
    return nil

# Get the epoch date (January 1, 0001)
fn epoch() -> any:
    return (1, 1, 1)

# Mock today function for testing (returns a fixed date)
fn today_mock() -> any:
    return (2025, 1, 15)

# Create a date from days since epoch
fn from_days(days: i64) -> any:
    if days < 1:
        return nil

    # Start from epoch
    var year = 1
    var month = 1
    var day = days

    # Advance through years
    var done = false
    while not done:
        var year_days = 365
        if is_leap_year(year):
            year_days = 366

        if day > year_days:
            day = day - year_days
            year = year + 1
        else:
            done = true

    # Advance through months
    done = false
    while not done:
        var month_days = days_in_month(year, month)

        if day > month_days:
            day = day - month_days
            month = month + 1
        else:
            done = true

    return (year, month, day)

# ============================================================================
# Date Validation
# ============================================================================

# Check if a year is a leap year
# Leap year: divisible by 4, except century years (divisible by 100)
#            unless also divisible by 400
fn is_leap_year(year: i64) -> bool:
    if year % 400 == 0:
        return true
    if year % 100 == 0:
        return false
    if year % 4 == 0:
        return true
    return false

# Get the number of days in a month
fn days_in_month(year: i64, month: i64) -> i64:
    if month == 1:
        return 31
    if month == 2:
        if is_leap_year(year):
            return 29
        return 28
    if month == 3:
        return 31
    if month == 4:
        return 30
    if month == 5:
        return 31
    if month == 6:
        return 30
    if month == 7:
        return 31
    if month == 8:
        return 31
    if month == 9:
        return 30
    if month == 10:
        return 31
    if month == 11:
        return 30
    if month == 12:
        return 31
    return 0

# Check if a date is valid
fn is_valid_date(year: i64, month: i64, day: i64) -> bool:
    if month < 1:
        return false
    if month > 12:
        return false
    if day < 1:
        return false

    var max_days = days_in_month(year, month)
    if day > max_days:
        return false

    return true

# ============================================================================
# Date Properties
# ============================================================================

# Get day of week (Monday=1, Sunday=7)
# Using Zeller's congruence algorithm modified for ISO week date
fn day_of_week(date: any) -> i64:
    var year = date[0]
    var month = date[1]
    var day = date[2]

    # Adjust for January and February
    var m = month
    var y = year
    if m < 3:
        m = m + 12
        y = y - 1

    # Calculate day of week
    var q = day
    var k = y % 100
    var j = y / 100

    # Zeller's formula
    var h = q + ((13 * (m + 1)) / 5) + k + (k / 4) + (j / 4) - (2 * j)
    h = h % 7

    # Convert to ISO (Monday=1, Sunday=7)
    # Zeller gives Saturday=0, Sunday=1, ..., Friday=6
    var dow = ((h + 5) % 7) + 1

    return dow

# Get day of year (1-366)
fn day_of_year(date: any) -> i64:
    var year = date[0]
    var month = date[1]
    var day = date[2]

    var doy = day

    var m = 1
    while m < month:
        doy = doy + days_in_month(year, m)
        m = m + 1

    return doy

# Get week of year (ISO 8601: week 1 contains first Thursday)
fn week_of_year(date: any) -> i64:
    var year = date[0]

    # Get day of year
    var doy = day_of_year(date)

    # Get day of week for January 1
    var jan1 = (year, 1, 1)
    var jan1_dow = day_of_week(jan1)

    # Calculate week number
    # Week 1 is the week containing the first Thursday
    var week = ((doy + jan1_dow - 2) / 7) + 1

    # Adjust if January 1 is Friday, Saturday, or Sunday
    if jan1_dow > 4:
        week = week - 1

    # Handle edge cases
    if week == 0:
        # This date belongs to the last week of previous year
        return 52

    if week > 52:
        # Check if it's week 53 or week 1 of next year
        var is_leap = is_leap_year(year)
        if is_leap:
            if doy > 366:
                return 1
        else:
            if doy > 365:
                return 1
        return 53

    return week

# Check if a date falls on a weekend (Saturday or Sunday)
fn is_weekend(date: any) -> bool:
    var dow = day_of_week(date)
    return dow == 6 or dow == 7

# Check if a date falls on a weekday (Monday-Friday)
fn is_weekday(date: any) -> bool:
    return not is_weekend(date)

# Get the quarter of the year (1-4)
fn quarter(date: any) -> i64:
    var month = date[1]
    if month <= 3:
        return 1
    if month <= 6:
        return 2
    if month <= 9:
        return 3
    return 4
