# File System
#
# File and directory operations with path manipulation.
# Provides cross-platform file system access.
#
# Components:
# - Path: Path manipulation (join, normalize, parent, etc.)
# - File: File operations (read, write, append, metadata)
# - Dir: Directory operations (create, delete, read_dir)
# - Walk: Directory tree traversal
# - Glob: Pattern matching for file paths
#
# Usage:
#   val path = Path.new("/home/user/file.txt")
#   val content = File.read(path.to_string())
#
# Architecture:
# - Cross-platform path handling (Unix/Windows)
# - Lazy directory traversal
# - Pattern matching with glob syntax

use src.std.platform (is_windows, dir_sep, normalize_path as platform_normalize, is_absolute_path as platform_is_absolute, join_path)

# ============================================================================
# Path - Path Manipulation
# ============================================================================

class Path:
    """Cross-platform path manipulation.

    Handles path operations for Unix and Windows.

    Example:
        val path = Path.new("/home/user/file.txt")
        val parent = path.parent()  # "/home/user"
        val name = path.filename()  # "file.txt"
        val ext = path.extension()  # "txt"
    """
    path: text  # Path string

    static fn new(path: text) -> Path:
        """Create path from string.

        Args:
            path: Path string

        Returns:
            Path object
        """
        Path(path: path)

    fn to_string() -> text:
        """Convert path to string.

        Returns:
            Path string
        """
        self.path

    fn join(other: text) -> Path:
        """Join path with another component.

        Args:
            other: Path component to append

        Returns:
            New path

        Example:
            Path.new("/home").join("user")  # "/home/user"
        """
        val joined = join_path(self.path, other)
        Path(path: joined)

    fn normalize() -> Path:
        """Normalize path (resolve . and ..).

        Returns:
            Normalized path

        Example:
            Path.new("/a/b/../c").normalize()  # "/a/c"
            Path.new("C:/Users/Name").normalize()  # "C:\Users\Name" (Windows)
        """
        val normalized = platform_normalize(self.path)
        Path(path: normalized)

    fn parent() -> Path?:
        """Get parent directory.

        Returns:
            Some(parent path) or None if at root

        Example:
            Path.new("/home/user").parent()  # Some("/home")
        """
        val parent = path_parent(self.path)
        if parent.?:
            Some(Path(path: parent.unwrap()))
        else:
            None

    fn filename() -> text?:
        """Get filename (last component).

        Returns:
            Some(filename) or None if directory

        Example:
            Path.new("/home/file.txt").filename()  # Some("file.txt")
        """
        path_filename(self.path)

    fn extension() -> text?:
        """Get file extension.

        Returns:
            Some(extension) or None if no extension

        Example:
            Path.new("file.txt").extension()  # Some("txt")
        """
        path_extension(self.path)

    fn stem() -> text?:
        """Get filename without extension.

        Returns:
            Some(stem) or None

        Example:
            Path.new("file.txt").stem()  # Some("file")
        """
        path_stem(self.path)

    fn components() -> [text]:
        """Get path components.

        Returns:
            Array of path components

        Example:
            Path.new("/home/user/file").components()
            # ["/", "home", "user", "file"]
        """
        path_components(self.path)

    fn is_absolute() -> bool:
        """Check if path is absolute.

        Returns:
            true if absolute, false if relative

        Example:
            Path.new("/home/user").is_absolute()     # true (Unix)
            Path.new("C:\\Users\\Name").is_absolute()  # true (Windows)
            Path.new("./relative").is_absolute()     # false
        """
        platform_is_absolute(self.path)

    fn is_relative() -> bool:
        """Check if path is relative."""
        not self.is_absolute()

    fn with_extension(ext: text) -> Path:
        """Replace file extension.

        Args:
            ext: New extension

        Returns:
            Path with new extension

        Example:
            Path.new("file.txt").with_extension("md")  # "file.md"
        """
        val new_path = path_with_extension(self.path, ext)
        Path(path: new_path)

# ============================================================================
# FileMetadata - File Information
# ============================================================================

struct FileMetadata:
    """File metadata information.

    Example:
        val metadata = File.metadata("file.txt")?
        print "Size: {metadata.size} bytes"
        print "Is file: {metadata.is_file}"
    """
    size: usize         # File size in bytes
    is_file: bool       # Is regular file
    is_dir: bool        # Is directory
    is_symlink: bool    # Is symbolic link
    readonly: bool      # Is read-only
    modified: usize     # Last modified time (Unix timestamp)
    created: usize      # Creation time (Unix timestamp)

# ============================================================================
# File - File Operations
# ============================================================================

class File:
    """File operations (read, write, metadata, etc.).

    Static methods for file manipulation.

    Example:
        val content = File.read("data.txt")?
        File.write("output.txt", content)?
    """

    static fn read(path: text) -> text?:
        """Read entire file as text.

        Args:
            path: File path

        Returns:
            Some(content) or None on error
        """
        file_read_text(path)

    static fn read_bytes(path: text) -> [u8]?:
        """Read entire file as bytes.

        Args:
            path: File path

        Returns:
            Some(bytes) or None on error
        """
        file_read_bytes(path)

    static fn write(path: text, content: text) -> bool:
        """Write text to file (overwrite).

        Args:
            path: File path
            content: Text to write

        Returns:
            true on success, false on error
        """
        file_write_text(path, content)

    static fn write_bytes(path: text, data: [u8]) -> bool:
        """Write bytes to file (overwrite).

        Args:
            path: File path
            data: Bytes to write

        Returns:
            true on success, false on error
        """
        file_write_bytes(path, data)

    static fn append(path: text, content: text) -> bool:
        """Append text to file.

        Args:
            path: File path
            content: Text to append

        Returns:
            true on success, false on error
        """
        file_append_text(path, content)

    static fn exists(path: text) -> bool:
        """Check if file exists.

        Args:
            path: File path

        Returns:
            true if exists, false otherwise
        """
        file_exists(path)

    static fn delete(path: text) -> bool:
        """Delete file.

        Args:
            path: File path

        Returns:
            true on success, false on error
        """
        file_delete(path)

    static fn rename(old_path: text, new_path: text) -> bool:
        """Rename/move file.

        Args:
            old_path: Current path
            new_path: New path

        Returns:
            true on success, false on error
        """
        file_rename(old_path, new_path)

    static fn copy(src: text, dest: text) -> bool:
        """Copy file.

        Args:
            src: Source path
            dest: Destination path

        Returns:
            true on success, false on error
        """
        file_copy(src, dest)

    static fn metadata(path: text) -> FileMetadata?:
        """Get file metadata.

        Args:
            path: File path

        Returns:
            Some(metadata) or None on error
        """
        file_metadata(path)

    static fn size(path: text) -> usize?:
        """Get file size in bytes.

        Args:
            path: File path

        Returns:
            Some(size) or None on error
        """
        file_size(path)

# ============================================================================
# Dir - Directory Operations
# ============================================================================

class Dir:
    """Directory operations.

    Example:
        Dir.create("new_dir")?
        val entries = Dir.read(".")?
        for entry in entries:
            print entry
    """

    static fn create(path: text) -> bool:
        """Create directory.

        Args:
            path: Directory path

        Returns:
            true on success, false on error
        """
        dir_create(path)

    static fn create_all(path: text) -> bool:
        """Create directory and all parent directories.

        Args:
            path: Directory path

        Returns:
            true on success, false on error
        """
        dir_create_all(path)

    static fn delete(path: text) -> bool:
        """Delete empty directory.

        Args:
            path: Directory path

        Returns:
            true on success, false on error
        """
        dir_delete(path)

    static fn delete_all(path: text) -> bool:
        """Delete directory and all contents.

        Args:
            path: Directory path

        Returns:
            true on success, false on error

        WARNING: Recursive deletion, use with caution.
        """
        dir_delete_all(path)

    static fn read(path: text) -> [text]?:
        """Read directory entries.

        Args:
            path: Directory path

        Returns:
            Some(entries) or None on error
        """
        dir_read(path)

    static fn exists(path: text) -> bool:
        """Check if directory exists.

        Args:
            path: Directory path

        Returns:
            true if exists and is directory
        """
        dir_exists(path)

    static fn is_empty(path: text) -> bool:
        """Check if directory is empty.

        Args:
            path: Directory path

        Returns:
            true if empty, false otherwise
        """
        dir_is_empty(path)

# ============================================================================
# Walk - Directory Tree Traversal
# ============================================================================

struct DirEntry:
    """Directory entry information.

    Example:
        for entry in Walk.new("./src"):
            if entry.is_file:
                print entry.path
    """
    path: text          # Full path
    name: text          # Entry name
    is_file: bool       # Is regular file
    is_dir: bool        # Is directory

class Walk:
    """Directory tree traversal.

    Recursively walks directory tree.

    Example:
        for entry in Walk.new("./src"):
            if entry.path.ends_with(".spl"):
                process_file(entry.path)
    """
    root: text          # Root directory
    entries: [DirEntry] # Collected entries

    static fn new(root: text) -> Walk:
        """Create directory walker.

        Args:
            root: Root directory

        Returns:
            Walk iterator
        """
        val entries = walk_dir(root)
        Walk(root: root, entries: entries)

    fn filter(predicate: fn(DirEntry) -> bool) -> Walk:
        """Filter entries by predicate.

        Args:
            predicate: Filter function

        Returns:
            Filtered walk
        """
        val filtered = self.entries.filter(predicate)
        Walk(root: self.root, entries: filtered)

    fn files_only() -> Walk:
        """Filter to files only.

        Returns:
            Walk with only files
        """
        self.filter(\entry: entry.is_file)

    fn dirs_only() -> Walk:
        """Filter to directories only.

        Returns:
            Walk with only directories
        """
        self.filter(\entry: entry.is_dir)

    fn to_list() -> [DirEntry]:
        """Convert to list of entries.

        Returns:
            List of directory entries
        """
        self.entries

# ============================================================================
# Glob - Pattern Matching
# ============================================================================

class Glob:
    """Glob pattern matching for file paths.

    Supports wildcards: *, ?, [abc], **

    Example:
        val files = Glob.new("src/**/*.spl").matches()
        for file in files:
            print file
    """
    pattern: text       # Glob pattern

    static fn new(pattern: text) -> Glob:
        """Create glob matcher.

        Args:
            pattern: Glob pattern

        Returns:
            Glob matcher

        Patterns:
        - * : Match any string (excluding /)
        - ? : Match single character
        - [abc] : Match one of abc
        - ** : Match any path (including /)
        """
        Glob(pattern: pattern)

    fn matches() -> [text]:
        """Find all matching paths.

        Returns:
            Array of matching paths
        """
        glob_find(self.pattern)

    fn matches_path(path: text) -> bool:
        """Check if path matches pattern.

        Args:
            path: Path to check

        Returns:
            true if matches, false otherwise
        """
        glob_matches(self.pattern, path)

# ============================================================================
# Utility Functions
# ============================================================================

fn read_to_string(path: text) -> text?:
    """Convenience function to read file as text.

    Args:
        path: File path

    Returns:
        Some(content) or None on error
    """
    File.read(path)

fn write_string(path: text, content: text) -> bool:
    """Convenience function to write text to file.

    Args:
        path: File path
        content: Text to write

    Returns:
        true on success, false on error
    """
    File.write(path, content)

fn list_dir(path: text) -> [text]?:
    """Convenience function to list directory.

    Args:
        path: Directory path

    Returns:
        Some(entries) or None on error
    """
    Dir.read(path)

# ============================================================================
# FFI Functions
# ============================================================================

# Path operations
extern fn path_join(path: text, other: text) -> text
extern fn path_normalize(path: text) -> text
extern fn path_parent(path: text) -> text?
extern fn path_filename(path: text) -> text?
extern fn path_extension(path: text) -> text?
extern fn path_stem(path: text) -> text?
extern fn path_components(path: text) -> [text]
extern fn path_is_absolute(path: text) -> bool
extern fn path_with_extension(path: text, ext: text) -> text

# File operations
extern fn file_read_text(path: text) -> text?
extern fn file_read_bytes(path: text) -> [u8]?
extern fn file_write_text(path: text, content: text) -> bool
extern fn file_write_bytes(path: text, data: [u8]) -> bool
extern fn file_append_text(path: text, content: text) -> bool
extern fn file_exists(path: text) -> bool
extern fn file_delete(path: text) -> bool
extern fn file_rename(old_path: text, new_path: text) -> bool
extern fn file_copy(src: text, dest: text) -> bool
extern fn file_metadata(path: text) -> FileMetadata?
extern fn file_size(path: text) -> usize?

# Directory operations
extern fn dir_create(path: text) -> bool
extern fn dir_create_all(path: text) -> bool
extern fn dir_delete(path: text) -> bool
extern fn dir_delete_all(path: text) -> bool
extern fn dir_read(path: text) -> [text]?
extern fn dir_exists(path: text) -> bool
extern fn dir_is_empty(path: text) -> bool

# Directory traversal
extern fn walk_dir(root: text) -> [DirEntry]

# Glob pattern matching
extern fn glob_find(pattern: text) -> [text]
extern fn glob_matches(pattern: text, path: text) -> bool

# ============================================================================
# Exports
# ============================================================================

export Path
export FileMetadata
export File
export Dir
export DirEntry
export Walk
export Glob
export read_to_string
export write_string
export list_dir
