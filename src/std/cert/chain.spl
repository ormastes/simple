# Certificate Chain Building and Management
#
# This module provides functions for building and managing certificate chains.

fn find_issuer(cert: text, candidates: text) -> text:
    # Find issuer certificate in list of candidates
    val issuer_dn = get_issuer(cert)
    val issuer_cn = get_common_name(issuer_dn)

    var i = 0
    while i < candidates.length():
        val candidate = candidates[i]
        val subject_dn = get_subject(candidate)
        val subject_cn = get_common_name(subject_dn)

        if issuer_cn == subject_cn:
            return candidate

        i = i + 1

    nil

fn build_certificate_chain(cert: text, intermediates: text, roots: text) -> text:
    # Build certificate chain from leaf to root
    var chain = [cert]
    var current = cert
    var all_certs = intermediates + roots

    var max_depth = 10
    var depth = 0

    while depth < max_depth:
        if is_self_signed(current):
            break

        val issuer = find_issuer(current, all_certs)
        if issuer == nil:
            break

        chain = chain + [issuer]
        current = issuer
        depth = depth + 1

    chain
