# Cache Get Operations
#
# Purpose: Retrieve values from different cache types
#
# Contains:
# - LRU cache get
# - FIFO cache get
# - LFU cache get
# - TTL cache get
# - Generic cache get

# ============================================================================
# LRU Cache Get
# ============================================================================

fn cache_lru_get(cache, key: text):
    """Get value from LRU cache. Returns nil if not found.
    Updates access order on hit."""
    val keys = cache['keys']
    val values = cache['values']
    val index = _find_key_index(keys, key)

    if index >= 0:
        # Hit: move to end (most recently used)
        cache['hits'] = cache['hits'] + 1
        val value = values[index]

        # Remove from current position
        cache['keys'] = _remove_at_index(keys, index)
        cache['values'] = _remove_at_index(values, index)

        # Add to end
        var new_keys = cache['keys']
        new_keys.push(key)
        cache['keys'] = new_keys

        var new_values = cache['values']
        new_values.push(value)
        cache['values'] = new_values

        return value
    else:
        # Miss
        cache['misses'] = cache['misses'] + 1
        return nil

# ============================================================================
# FIFO Cache Get
# ============================================================================

fn cache_fifo_get(cache, key: text):
    """Get value from FIFO cache. Returns nil if not found.
    Does NOT update order on access (unlike LRU)."""
    val keys = cache['keys']
    val values = cache['values']
    val index = _find_key_index(keys, key)

    if index >= 0:
        cache['hits'] = cache['hits'] + 1
        return values[index]
    else:
        cache['misses'] = cache['misses'] + 1
        return nil

# ============================================================================
# LFU Cache Get
# ============================================================================

fn cache_lfu_get(cache, key: text):
    """Get value from LFU cache. Returns nil if not found.
    Increments frequency counter on hit."""
    val keys = cache['keys']
    val values = cache['values']
    val frequencies = cache['frequencies']
    val index = _find_key_index(keys, key)

    if index >= 0:
        cache['hits'] = cache['hits'] + 1

        # Increment frequency
        var new_frequencies = frequencies
        new_frequencies[index] = frequencies[index] + 1
        cache['frequencies'] = new_frequencies

        return values[index]
    else:
        cache['misses'] = cache['misses'] + 1
        return nil

# ============================================================================
# TTL Cache Get
# ============================================================================

fn cache_ttl_get(cache, key: text):
    """Get value from TTL cache. Returns nil if not found or expired."""
    val keys = cache['keys']
    val values = cache['values']
    val expiry_times = cache['expiry_times']
    val index = _find_key_index(keys, key)

    if index >= 0:
        val now = _get_timestamp()
        val expiry = expiry_times[index]

        if now < expiry:
            # Not expired - hit
            cache['hits'] = cache['hits'] + 1
            return values[index]
        else:
            # Expired - remove entry and count as miss
            cache['keys'] = _remove_at_index(keys, index)
            cache['values'] = _remove_at_index(values, index)
            cache['expiry_times'] = _remove_at_index(expiry_times, index)
            cache['misses'] = cache['misses'] + 1
            return nil
    else:
        cache['misses'] = cache['misses'] + 1
        return nil

# ============================================================================
# Generic Cache Operations
# ============================================================================

fn cache_get(cache, key: text):
    """Generic cache get operation. Works with any cache type."""
    val cache_type = cache['type']
    if cache_type == 'lru':
        cache_lru_get(cache, key)
    elif cache_type == 'fifo':
        cache_fifo_get(cache, key)
    elif cache_type == 'lfu':
        cache_lfu_get(cache, key)
    elif cache_type == 'ttl':
        cache_ttl_get(cache, key)
    else:
        nil

# ============================================================================
# Helper Functions
# ============================================================================

fn _find_key_index(keys, key: text) -> i64:
    """Find index of key in keys array. Returns -1 if not found."""
    var i = 0
    while i < keys.len():
        if keys[i] == key:
            return i
        i = i + 1
    -1

fn _remove_at_index(arr, index: i64):
    """Remove element at index from array. Returns new array."""
    var result = []
    var i = 0
    while i < arr.len():
        if i != index:
            result.push(arr[i])
        i = i + 1
    result

fn _get_timestamp() -> i64:
    """Get current timestamp (simulated with counter for testing)."""
    1000000

export cache_lru_get, cache_fifo_get, cache_lfu_get, cache_ttl_get, cache_get
