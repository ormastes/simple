# Serialization - Format Detection and SDN

use serialization.serialize.{serialize_list, serialize_tuple_text, serialize_dict, quote_string}

# ============================================================================
# SDN (Simple Data Notation) Serialization
# ============================================================================

fn to_sdn_int(n: i64) -> text:
    """Convert integer to SDN format."""
    "{n}"

fn to_sdn_bool(b: bool) -> text:
    """Convert boolean to SDN format."""
    if b:
        return "true"
    "false"

fn to_sdn_nil() -> text:
    """Convert nil to SDN format."""
    "nil"

fn to_sdn_text(s: text) -> text:
    """Convert text to SDN format (quoted)."""
    quote_string(s)

fn to_sdn_list(items: [text]) -> text:
    """Convert list to SDN format."""
    serialize_list(items)

fn to_sdn_tuple(values: [text]) -> text:
    """Convert tuple to SDN format."""
    serialize_tuple_text(values)

fn to_sdn_dict(entries: [(text, text)]) -> text:
    """Convert dict to SDN format."""
    serialize_dict(entries)

# ============================================================================
# Format Detection
# ============================================================================

fn is_numeric_text(s: text) -> bool:
    """Check if text represents a number."""
    if s.len() == 0:
        return false

    var start = 0
    if s[0:1] == "-":
        start = 1

    if start >= s.len():
        return false

    var i = start
    while i < s.len():
        val ch = s[i:i+1]
        val is_digit = ch >= "0" and ch <= "9"
        if not is_digit:
            return false
        i = i + 1

    true

fn detect_format(serialized: text) -> text:
    """Detect serialization format from content."""
    if serialized.len() == 0:
        return "unknown"

    val first = serialized[0:1]

    if first == "@":
        return "tagged"
    if first == "{" or first == "[":
        return "sdn"
    if first == "\"":
        return "sdn"
    if serialized == "true" or serialized == "false" or serialized == "nil":
        return "sdn"
    if is_numeric_text(serialized):
        return "sdn"

    "unknown"

fn is_valid_sdn(serialized: text) -> bool:
    """Check if text is valid SDN format (basic validation)."""
    val format = detect_format(serialized)
    format == "sdn" or format == "tagged"

# ============================================================================
# Exports
# ============================================================================

export to_sdn_int, to_sdn_bool, to_sdn_nil, to_sdn_text
export to_sdn_list, to_sdn_tuple, to_sdn_dict
export is_numeric_text, detect_format, is_valid_sdn
