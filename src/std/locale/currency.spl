# Locale Currency Formatting
# Provides currency formatting and parsing for different locales.

import locale::types
import locale::numbers

# ============================================================================
# CURRENCY FORMATTING
# ============================================================================

fn currency_symbol(currency: text, locale: (text, text, text, text)) -> text:
    # Gets the currency symbol for a currency code.
    # Returns: Currency symbol (e.g., "$", "€", "¥")
    #
    # Args:
    #   currency: ISO 4217 currency code (e.g., "USD", "EUR", "JPY")

    if currency == "USD":
        return "$"

    if currency == "EUR":
        return "€"

    if currency == "GBP":
        return "£"

    if currency == "JPY":
        return "¥"

    if currency == "CNY":
        return "¥"

    if currency == "KRW":
        return "₩"

    if currency == "RUB":
        return "₽"

    if currency == "INR":
        return "₹"

    if currency == "BRL":
        return "R$"

    if currency == "CAD":
        return "C$"

    if currency == "AUD":
        return "A$"

    if currency == "CHF":
        return "CHF"

    # Default: return currency code
    currency

fn currency_decimals(currency: text) -> i64:
    # Gets the number of decimal places for a currency.
    # Returns: Number of decimals (usually 2, 0 for JPY/KRW)

    # Zero decimal currencies
    if currency == "JPY" or currency == "KRW":
        return 0

    # Most currencies use 2 decimals
    2

fn currency_position(locale: (text, text, text, text)) -> text:
    # Gets the currency symbol position preference.
    # Returns: "before" or "after"

    var lang = locale.0

    # Most European languages put symbol after
    if lang == "fr" or lang == "es" or lang == "it" or lang == "pt" or lang == "ru" or lang == "nl" or lang == "sv" or lang == "pl":
        return "after"

    # English and most others put symbol before
    "before"

fn format_currency(amount: i64, currency: text, locale: (text, text, text, text)) -> text:
    # Formats a currency amount with locale-specific formatting.
    # Note: amount is in smallest unit (e.g., cents for USD)
    # Returns: Formatted currency string
    #
    # Example:
    #   format_currency(1999, "USD", locale_en_us())  # "$19.99"
    #   format_currency(1999, "EUR", locale_fr_fr())  # "19,99 €"

    var symbol = currency_symbol(currency, locale)
    var decimals = currency_decimals(currency)
    var position = currency_position(locale)

    var num_str = format_decimal(amount, decimals, locale)

    if position == "before":
        return symbol + num_str

    # after
    num_str + " " + symbol

fn parse_currency(text: text, currency: text, locale: (text, text, text, text)) -> i64:
    # Parses a currency string to amount in smallest unit.
    # Returns: Amount or 0 on error
    #
    # Example:
    #   parse_currency("$19.99", "USD", locale_en_us())  # 1999

    var symbol = currency_symbol(currency, locale)
    var dec_sep = get_decimal_separator(locale)
    var thou_sep = get_thousands_separator(locale)

    # Remove currency symbol and whitespace
    var cleaned = text.replace(symbol, "")
    cleaned = cleaned.replace(" ", "")

    # Remove thousands separator
    cleaned = cleaned.replace(thou_sep, "")

    # Split by decimal separator
    var parts = cleaned.split(dec_sep)

    if parts.length() == 0:
        return 0

    var int_part = 0
    var int_str = parts.get(0)
    if int_str != "":
        int_part = int_str.to_int()

    var frac_part = 0
    if parts.length() >= 2:
        var frac_str = parts.get(1)
        if frac_str != "":
            frac_part = frac_str.to_int()

    var decimals = currency_decimals(currency)
    var multiplier = 1
    var i = 0
    while i < decimals:
        multiplier = multiplier * 10
        i = i + 1

    int_part * multiplier + frac_part
