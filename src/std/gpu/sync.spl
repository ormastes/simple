# GPU Synchronization Primitives
#
# Provides synchronization utilities for GPU compute operations.

use gpu.device.*
use app.io.cuda_ffi.*
use app.io.vulkan_ffi.*

# ============================================================================
# Device Synchronization
# ============================================================================

fn gpu_wait(device: Gpu) -> bool:
    if not device.is_valid():
        true
    elif device.backend == GpuBackend.Cuda:
        cuda_sync()
    elif device.backend == GpuBackend.Vulkan:
        vulkan_wait_idle()
    else:
        true

fn gpu_wait_all() -> bool:
    var success = true
    if cuda_available():
        val count = cuda_device_count()
        for i in 0..count:
            cuda_set_device(i)
            if not cuda_sync():
                success = false
    if vulkan_available():
        if not vulkan_wait_idle():
            success = false
    success

# ============================================================================
# CUDA Streams
# ============================================================================

struct GpuStream:
    backend: GpuBackend
    cuda_stream: CudaStream?
    is_valid: bool

fn gpu_stream_create(device: Gpu) -> GpuStream:
    if not device.is_valid():
        GpuStream(backend: GpuBackend.NoGpu, cuda_stream: nil, is_valid: false)
    elif device.backend == GpuBackend.Cuda:
        val stream = cuda_stream_create()
        GpuStream(backend: GpuBackend.Cuda, cuda_stream: Some(stream), is_valid: stream.is_valid)
    elif device.backend == GpuBackend.Vulkan:
        GpuStream(backend: GpuBackend.Vulkan, cuda_stream: nil, is_valid: false)
    else:
        GpuStream(backend: GpuBackend.NoGpu, cuda_stream: nil, is_valid: false)

fn gpu_stream_destroy(stream: GpuStream) -> bool:
    if stream.cuda_stream.?:
        val s = stream.cuda_stream!
        cuda_stream_destroy(s)
    else:
        true

fn gpu_stream_wait(stream: GpuStream) -> bool:
    if not stream.is_valid:
        true
    elif stream.cuda_stream.?:
        val s = stream.cuda_stream!
        cuda_stream_sync(s)
    else:
        true

impl GpuStream:
    fn valid() -> bool:
        self.is_valid

    fn wait() -> bool:
        gpu_stream_wait(self)

    fn destroy_stream() -> bool:
        gpu_stream_destroy(self)

# ============================================================================
# Event/Fence Synchronization
# ============================================================================

struct GpuEvent:
    backend: GpuBackend
    vulkan_fence: i64?
    is_valid: bool

fn gpu_event_create(device: Gpu) -> GpuEvent:
    if not device.is_valid():
        GpuEvent(backend: GpuBackend.NoGpu, vulkan_fence: nil, is_valid: false)
    elif device.backend == GpuBackend.Cuda:
        GpuEvent(backend: GpuBackend.Cuda, vulkan_fence: nil, is_valid: false)
    elif device.backend == GpuBackend.Vulkan:
        val fence = rt_vulkan_create_fence()
        GpuEvent(backend: GpuBackend.Vulkan, vulkan_fence: Some(fence), is_valid: fence != 0)
    else:
        GpuEvent(backend: GpuBackend.NoGpu, vulkan_fence: nil, is_valid: false)

fn gpu_event_destroy(event: GpuEvent) -> bool:
    if event.vulkan_fence.?:
        val f = event.vulkan_fence!
        rt_vulkan_destroy_fence(f)
    else:
        true

fn gpu_event_wait(event: GpuEvent, timeout_ns: i64) -> bool:
    if not event.is_valid:
        true
    elif event.vulkan_fence.?:
        val f = event.vulkan_fence!
        rt_vulkan_wait_fence(f, timeout_ns)
    else:
        true

fn gpu_event_reset(event: GpuEvent) -> bool:
    if not event.is_valid:
        true
    elif event.vulkan_fence.?:
        val f = event.vulkan_fence!
        rt_vulkan_reset_fence(f)
    else:
        true

impl GpuEvent:
    fn valid() -> bool:
        self.is_valid

    fn wait(timeout_ns: i64) -> bool:
        gpu_event_wait(self, timeout_ns)

    fn wait_forever() -> bool:
        gpu_event_wait(self, 0xFFFFFFFFFFFFFFFF)

    fn reset_event() -> bool:
        gpu_event_reset(self)

    fn destroy_event() -> bool:
        gpu_event_destroy(self)

# ============================================================================
# Barrier Utilities
# ============================================================================

enum GpuMemoryScope:
    DeviceScope
    WorkgroupScope
    SubgroupScope

# ============================================================================
# Exports
# ============================================================================

export gpu_wait, gpu_wait_all
export GpuStream, gpu_stream_create, gpu_stream_destroy, gpu_stream_wait
export GpuEvent, gpu_event_create, gpu_event_destroy, gpu_event_wait, gpu_event_reset
export GpuMemoryScope
