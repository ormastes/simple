# HTTP Connection and Protocol Functions

import types
import request
import response

fn serialize_headers(headers: list) -> text:
    var result = ""
    var i = 0
    while i < headers.length():
        var header = headers[i]
        result = result + header.0 + ": " + header.1 + "\r\n"
        i = i + 1
    result

fn serialize_request(request: (text, text, list, text)) -> text:
    var method = request.0
    var url = request.1
    var headers = request.2
    var body = request.3
    var parsed = types.parse_url(url)
    var path = parsed.3
    var query = parsed.4
    var request_line = method + " " + path
    if query.length() > 0:
        request_line = request_line + "?" + query
    request_line = request_line + " " + types.HTTP_VERSION + "\r\n"
    var header_text = serialize_headers(headers)
    var result = request_line + header_text + "\r\n"
    if body.length() > 0:
        result = result + body
    result

fn parse_response(response_text: text) -> (i64, text, list, text):
    var lines = response_text.split("\r\n")
    var status_line = lines[0]
    var parts = status_line.split(" ")
    var status_code = parts[1].parse_int()
    var status_text = parts[2]
    var headers = []
    var i = 1
    var header_end = i
    while i < lines.length():
        var line = lines[i]
        if line.length() == 0:
            header_end = i
            break
        var colon = line.index_of(":")
        if colon >= 0:
            var name = line.substring(0, colon).trim()
            var value = line.substring(colon + 1, line.length()).trim()
            headers.append((name, value))
        i = i + 1
    var body = ""
    if header_end + 1 < lines.length():
        var j = header_end + 1
        while j < lines.length():
            body = body + lines[j]
            if j < lines.length() - 1:
                body = body + "\r\n"
            j = j + 1
    (status_code, status_text, headers, body)

fn mock_http_execute(request: (text, text, list, text)) -> (i64, text, list, text):
    var status_code = 200
    var status_text = "OK"
    var response_headers = []
    response_headers = request.add_header(response_headers, "Content-Type", "text/plain")
    response_headers = request.add_header(response_headers, "Content-Length", "13")
    var response_body = "Hello, World!"
    (status_code, status_text, response_headers, response_body)
