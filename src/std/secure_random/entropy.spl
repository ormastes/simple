# Entropy Collection and Management
#
# Functions for collecting and managing entropy pools

import "platform" as Platform
import "types" as Types

# Initialize entropy pools
fn init_entropy_pools():
    if Types.entropy_pools == nil:
        Types.entropy_pools = []
        var i = 0
        while i < Types.NUM_ENTROPY_POOLS:
            Types.entropy_pools.append([])
            i = i + 1

# Collect entropy from timestamp
fn collect_time_entropy() -> list:
    var timestamp = Platform.get_timestamp_ms()
    var entropy = []
    # Break timestamp into bytes
    var i = 0
    while i < 8:
        var byte_val = (timestamp >> (i * 8)) & 0xFF
        entropy.append(byte_val)
        i = i + 1
    entropy

# Collect entropy from execution state
fn collect_execution_entropy() -> list:
    var entropy = []
    # Use timestamp as primary source
    var time_bytes = collect_time_entropy()
    var i = 0
    while i < time_bytes.length():
        entropy.append(time_bytes.get(i))
        i = i + 1
    # Add some variation based on timestamp
    var timestamp = Platform.get_timestamp_ms()
    var mix = timestamp
    var j = 0
    while j < 8:
        var byte_val = (mix >> (j * 8)) & 0xFF
        mix = (mix * 6364136223846793005 + 1442695040888963407) & 0xFFFFFFFFFFFFFFFF
        entropy.append(byte_val)
        j = j + 1
    entropy

# Mix entropy using simple hash function
fn mix_entropy(data: list) -> list:
    var result = []
    var hash = 2166136261  # FNV offset basis
    var i = 0
    while i < data.length():
        var byte_val = data.get(i)
        hash = hash ^ byte_val
        hash = (hash * 16777619) & 0xFFFFFFFF
        i = i + 1
    # Generate 32 bytes from hash
    var j = 0
    while j < 32:
        result.append(hash & 0xFF)
        hash = (hash * 1103515245 + 12345) & 0xFFFFFFFF
        j = j + 1
    result

# Add entropy to a specific pool
fn add_entropy_to_pool(pool_index: i64, data: list):
    init_entropy_pools()
    if pool_index >= 0:
        if pool_index < Types.NUM_ENTROPY_POOLS:
            var pool = Types.entropy_pools.get(pool_index)
            var i = 0
            while i < data.length():
                pool.append(data.get(i))
                i = i + 1

# Add entropy to pools (round-robin distribution)
fn add_entropy(data: list):
    init_entropy_pools()
    var pool_index = Types.pool_reseed_counter % Types.NUM_ENTROPY_POOLS
    add_entropy_to_pool(pool_index, data)
    Types.pool_reseed_counter = Types.pool_reseed_counter + 1

# Get entropy from pools for reseeding
fn get_reseed_entropy() -> list:
    init_entropy_pools()
    var entropy = []
    # Determine which pools to use based on reseed counter
    var reseed_count = Types.pool_reseed_counter / Types.NUM_ENTROPY_POOLS
    var i = 0
    while i < Types.NUM_ENTROPY_POOLS:
        # Use pool i if 2^i divides reseed_count
        var use_pool = false
        if i == 0:
            use_pool = true
        else:
            var divisor = 1 << i
            use_pool = (reseed_count % divisor) == 0
        if use_pool:
            var pool = Types.entropy_pools.get(i)
            var j = 0
            while j < pool.length():
                entropy.append(pool.get(j))
                j = j + 1
            # Clear pool after use
            Types.entropy_pools.set(i, [])
        i = i + 1
    # Add fresh entropy
    var fresh = collect_execution_entropy()
    var k = 0
    while k < fresh.length():
        entropy.append(fresh.get(k))
        k = k + 1
    # Mix all entropy
    mix_entropy(entropy)

# Add custom entropy to CSPRNG
fn add_custom_entropy(data: text):
    var bytes = []
    var i = 0
    while i < data.length():
        var c = data.char_at(i)
        bytes.append(c & 0xFF)
        i = i + 1
    add_entropy(bytes)

# Get entropy pool sizes
fn get_entropy_pool_sizes() -> list:
    init_entropy_pools()
    var sizes = []
    var i = 0
    while i < Types.NUM_ENTROPY_POOLS:
        var pool = Types.entropy_pools.get(i)
        sizes.append(pool.length())
        i = i + 1
    sizes

export init_entropy_pools
export collect_time_entropy
export collect_execution_entropy
export mix_entropy
export add_entropy_to_pool
export add_entropy
export get_reseed_entropy
export add_custom_entropy
export get_entropy_pool_sizes
