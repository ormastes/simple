# Mock Library Example
# Demonstrates how to use the mock library for testing

import std.testing.mock as mock

# ============================================================================
# Example 1: Basic Mock Usage
# ============================================================================

fn example_basic_mock():
    print "=== Basic Mock Usage ==="
    print ""

    # Create a mock function
    val save_user = mock.create_mock("save_user")

    # Simulate function calls
    save_user.record_call(["user123", "Alice"])
    save_user.record_call(["user456", "Bob"])

    # Verify calls
    print "Was called: {save_user.was_called()}"
    print "Call count: {save_user.call_count()}"
    print "Called 2 times: {save_user.was_called_n_times(2)}"

    # Check specific arguments
    val called_with_alice = save_user.was_called_with(["user123", "Alice"])
    print "Called with Alice: {called_with_alice}"

    # Print summary
    print ""
    print save_user.summary()

# ============================================================================
# Example 2: Mock with Return Values
# ============================================================================

fn example_mock_returns():
    print "=== Mock with Return Values ==="
    print ""

    # Create mock with return values
    val get_user = mock.MockBuilder.new("get_user")
        .returns(["Alice", "Bob", "Charlie"])

    # Simulate calls and get return values
    print "First call:"
    match get_user.next_return_value():
        Some(v): print "  Returned: {v}"
        None: print "  No value"

    get_user.record_call(["user123"])

    print "Second call:"
    match get_user.next_return_value():
        Some(v): print "  Returned: {v}"
        None: print "  No value"

    get_user.record_call(["user456"])

    print "Third call:"
    match get_user.next_return_value():
        Some(v): print "  Returned: {v}"
        None: print "  No value"

    get_user.record_call(["user789"])

    print ""
    print get_user.summary()

# ============================================================================
# Example 3: Mock Registry
# ============================================================================

fn example_mock_registry():
    print "=== Mock Registry ==="
    print ""

    # Create registry
    val registry = mock.MockRegistry.new()

    # Register multiple mocks
    val save_mock = mock.create_mock("save_user")
    val load_mock = mock.create_mock("load_user")
    val delete_mock = mock.create_mock("delete_user")

    registry.register("save", save_mock)
    registry.register("load", load_mock)
    registry.register("delete", delete_mock)

    # Simulate operations
    save_mock.record_call(["user123", "Alice"])
    load_mock.record_call(["user123"])
    save_mock.record_call(["user456", "Bob"])
    delete_mock.record_call(["user123"])

    # Print summary of all mocks
    print registry.summary()

    # Reset all mocks
    print "Resetting all mocks..."
    registry.reset_all()

    # Verify reset
    match registry.get("save"):
        Some(m): print "Save mock call count after reset: {m.call_count()}"
        None: print "Mock not found"

# ============================================================================
# Example 4: Verification Helpers
# ============================================================================

fn example_verification():
    print "=== Verification Helpers ==="
    print ""

    val mock = mock.create_mock("process_data")

    # Record some calls
    mock.record_call(["data1"])
    mock.record_call(["data2"])
    mock.record_call(["data3"])

    # Verify using helper functions
    val called_3_times = mock.verify_called(mock, 3)
    print "Called 3 times: {called_3_times}"

    val called_with_data1 = mock.verify_called_with(mock, ["data1"])
    print "Called with data1: {called_with_data1}"

    val called_with_wrong_args = mock.verify_called_with(mock, ["wrong"])
    print "Called with wrong args: {called_with_wrong_args}"

# ============================================================================
# Example 5: Inspecting Calls
# ============================================================================

fn example_inspect_calls():
    print "=== Inspecting Calls ==="
    print ""

    val mock = mock.create_mock("api_call")

    # Record various calls
    mock.record_call(["GET", "/users"])
    mock.record_call(["POST", "/users", "Alice"])
    mock.record_call(["DELETE", "/users/123"])

    # Inspect individual calls
    print "First call:"
    match mock.get_call(0):
        Some(call):
            print "  Call #{call.call_number}"
            print "  Args: {call.args}"
        None:
            print "  No call found"

    print ""
    print "Last call:"
    match mock.get_last_call():
        Some(call):
            print "  Call #{call.call_number}"
            print "  Args: {call.args}"
        None:
            print "  No call found"

# ============================================================================
# Example 6: Using Mocks in Tests
# ============================================================================

fn example_in_tests():
    print "=== Using Mocks in Tests ==="
    print ""

    # Example: Testing a service that depends on a repository
    fn test_user_service():
        # Create mock repository
        val repo_mock = mock.MockBuilder.new("user_repository")
            .returns(["user_data"])

        # Simulate service calling repository
        print "Service: Fetching user..."
        match repo_mock.next_return_value():
            Some(data):
                print "Service: Got user data: {data}"
                repo_mock.record_call(["user123"])
            None:
                print "Service: No data"

        # Verify repository was called correctly
        if repo_mock.was_called_with(["user123"]):
            print "✅ Test passed: Repository called with correct ID"
        else:
            print "❌ Test failed: Repository not called correctly"

        print ""
        print repo_mock.summary()

    test_user_service()

# ============================================================================
# Example 7: Mock Reset
# ============================================================================

fn example_reset():
    print "=== Mock Reset ==="
    print ""

    val mock = mock.create_mock("operation")

    # First set of calls
    print "Before reset:"
    mock.record_call(["arg1"])
    mock.record_call(["arg2"])
    print "  Call count: {mock.call_count()}"

    # Reset
    mock.reset()
    print "After reset:"
    print "  Call count: {mock.call_count()}"
    print "  Was called: {mock.was_called()}"

    # New calls after reset
    mock.record_call(["arg3"])
    print "After new call:"
    print "  Call count: {mock.call_count()}"

# ============================================================================
# Main Entry Point
# ============================================================================

fn main():
    example_basic_mock()
    print "\n" + "=".repeat(60) + "\n"

    example_mock_returns()
    print "\n" + "=".repeat(60) + "\n"

    example_mock_registry()
    print "\n" + "=".repeat(60) + "\n"

    example_verification()
    print "\n" + "=".repeat(60) + "\n"

    example_inspect_calls()
    print "\n" + "=".repeat(60) + "\n"

    example_in_tests()
    print "\n" + "=".repeat(60) + "\n"

    example_reset()
