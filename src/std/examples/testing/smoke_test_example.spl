# Smoke Testing Example
# Demonstrates post-deployment verification

import std.testing.deployment as smoke
import std.http

# Mock functions for demonstration
fn mock_http_get(url: text) -> HttpResponse:
    # In real code, use actual HTTP client
    # For demo, return mock response
    HttpResponse(status: 200, body: {"status": "ok"})

fn mock_db_ping() -> Result<(), text>:
    # In real code, ping actual database
    Ok(())

# Example: Basic smoke test suite
fn example_basic():
    print "=== Basic Smoke Test Suite ==="
    print ""

    val suite = smoke.SmokeTestSuite.new_default()
        .test("homepage loads", \:
            val resp = mock_http_get("https://myapp.com/")
            resp.status == 200
        )
        .test("database connected", \:
            mock_db_ping().is_ok()
        )
        .test("API health check", \:
            val resp = mock_http_get("https://myapp.com/api/health")
            resp.status == 200 and resp.body["status"] == "ok"
        )

    val results = suite.run()

    for result in results:
        print result.format()

    if suite.all_passed(results):
        print "\n✅ All smoke tests passed!"
    else:
        print "\n❌ Some smoke tests failed!"

# Example: Custom configuration with retries
fn example_retries():
    print "=== Smoke Tests with Retries ==="
    print ""

    var attempt_count = 0

    val config = smoke.SmokeTestConfig(
        timeout_secs: 60.0,
        retry_attempts: 3,
        retry_delay_secs: 2.0,
        fail_fast: false
    )

    val suite = smoke.SmokeTestSuite.new(config)
        .test("flaky service", \:
            attempt_count = attempt_count + 1
            print "  Attempt {attempt_count}..."

            # Simulate flaky service (passes on 2nd attempt)
            attempt_count >= 2
        )

    val results = suite.run()

    for result in results:
        print result.format()

# Example: Fail fast behavior
fn example_fail_fast():
    print "=== Fail Fast Behavior ==="
    print ""

    val config = smoke.SmokeTestConfig.default()  # fail_fast: true

    val suite = smoke.SmokeTestSuite.new(config)
        .test("critical test (fails)", \: false)
        .test("this won't run", \:
            print "  This test should not run!"
            true
        )

    val results = suite.run()

    print "Tests run: {results.len()}"
    for result in results:
        print result.format()

# Example: No fail fast
fn example_no_fail_fast():
    print "=== No Fail Fast (Run All Tests) ==="
    print ""

    val config = smoke.SmokeTestConfig(
        timeout_secs: 30.0,
        retry_attempts: 1,
        retry_delay_secs: 1.0,
        fail_fast: false  # Run all tests
    )

    val suite = smoke.SmokeTestSuite.new(config)
        .test("service A (fails)", \: false)
        .test("service B (passes)", \: true)
        .test("service C (fails)", \: false)

    val results = suite.run()

    print "Tests run: {results.len()}"
    for result in results:
        print result.format()

# Example: Deployment workflow
fn example_deployment():
    print "=== Deployment Workflow ==="
    print ""

    # Simulate deployment
    print "Deploying application..."
    # deploy_to_production()

    # Run smoke tests
    print "Running smoke tests..."
    val suite = smoke.SmokeTestSuite.new_default()
        .test("homepage", \: mock_http_get("/").status == 200)
        .test("database", \: mock_db_ping().is_ok())

    val results = suite.run()

    if suite.all_passed(results):
        print "\n✅ Deployment successful!"
    else:
        print "\n❌ Deployment failed, rolling back..."
        # rollback_deployment()

# Main entry point
fn main():
    example_basic()
    print "\n" + "=".repeat(60) + "\n"

    example_retries()
    print "\n" + "=".repeat(60) + "\n"

    example_fail_fast()
    print "\n" + "=".repeat(60) + "\n"

    example_no_fail_fast()
    print "\n" + "=".repeat(60) + "\n"

    example_deployment()
