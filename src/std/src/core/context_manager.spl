# Context Manager Module - Pure Simple Implementation
#
# Provides context manager implementations for resource management
# with automatic cleanup using __enter__ and __exit__ protocol.
#
# NOTE: Pure Simple implementation - no FFI, no extern calls

export TimerContext, time_now

# ============================================================================
# Helper: Current Time (Pure Simple - Simulated)
# ============================================================================

var _simulated_time: f64 = 0.0
var _time_increment: f64 = 0.001

fn time_now() -> f64:
    """Get current time as Unix timestamp in seconds.

    Returns:
        f64 - Current time in seconds (simulated for Pure Simple)

    Note:
        This is a Pure Simple simulation. Each call increments time slightly.
        In production, this would use system time.
    """
    _simulated_time = _simulated_time + _time_increment
    _simulated_time

# ============================================================================
# TimerContext - Time Measurement Context Manager
# ============================================================================

class TimerContext:
    """Context manager for measuring elapsed time of operations.

    Example:
        val timer = TimerContext("database query")
        timer.__enter__()
        # ... do work ...
        timer.__exit__(nil, nil, nil)
        print "Elapsed: {timer.elapsed()}s"
    """
    name: text
    start_time: f64
    end_time: f64?

    me __enter__():
        """Enter context - record start time."""
        self.start_time = time_now()
        print "[TIMER START] {self.name}"
        self

    me __exit__(exc_type, exc_value, traceback):
        """Exit context - record end time and print elapsed."""
        self.end_time = Some(time_now())
        val elapsed = self.elapsed()
        print "[TIMER END] {self.name}: {elapsed:.6f}s"

    fn elapsed() -> f64:
        """Get elapsed time in seconds.

        Returns:
            f64 - Elapsed time, or time since start if not ended
        """
        match self.end_time:
            Some(end):
                end - self.start_time
            None:
                # Still running - return current elapsed
                time_now() - self.start_time

impl TimerContext:
    static fn create(name: text) -> TimerContext:
        """Create a new timer context.

        Args:
            name - Descriptive name for the timed operation

        Returns:
            TimerContext ready for use
        """
        TimerContext(
            name: name,
            start_time: 0.0,
            end_time: None
        )

    static fn new(name: text) -> TimerContext:
        """Create a new timer context (alias for create).

        Args:
            name - Descriptive name for the timed operation

        Returns:
            TimerContext ready for use
        """
        TimerContext.create(name)

# ============================================================================
# FileContext - File Resource Manager (Future)
# ============================================================================

# TODO: Add FileContext for automatic file closing
# class FileContext:
#     file_handle: FileHandle
#
#     me __enter__():
#         self
#
#     me __exit__(exc_type, exc_value, traceback):
#         self.file_handle.close()

# ============================================================================
# LockContext - Mutex/Lock Manager (Future)
# ============================================================================

# TODO: Add LockContext for automatic lock release
# class LockContext:
#     lock: Mutex
#
#     me __enter__():
#         self.lock.acquire()
#         self
#
#     me __exit__(exc_type, exc_value, traceback):
#         self.lock.release()
