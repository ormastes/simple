# Text/String Utility Functions
#
# Provides common string manipulation functions that are frequently needed
# throughout the codebase.

# Exports
export str_replace, str_find, str_contains
export str_starts_with, str_ends_with
export str_trim, str_trim_left, str_trim_right
export str_to_upper, str_to_lower
export str_split, str_join
export str_substring, str_char_at
export str_index_of, str_last_index_of
export str_count, str_is_empty

# ============================================================================
# String Search and Replacement
# ============================================================================

fn str_replace(s: text, old: text, new: text) -> text:
    """Replace all occurrences of old with new in string s.

    Examples:
        str_replace("hello world", "world", "universe")  # "hello universe"
        str_replace("foo foo foo", "foo", "bar")         # "bar bar bar"
    """
    if old == "":
        return s

    val parts = s.split(old)
    parts.join(new)

fn str_find(s: text, needle: text) -> i64:
    """Find first occurrence of needle in s, return index or -1 if not found.

    Examples:
        str_find("hello world", "world")  # 6
        str_find("hello world", "xyz")    # -1
    """
    if needle == "":
        return 0

    if s.contains(needle):
        s.index_of(needle)
    else:
        -1

fn str_contains(s: text, needle: text) -> bool:
    """Check if s contains needle.

    Examples:
        str_contains("hello world", "world")  # true
        str_contains("hello world", "xyz")    # false
    """
    s.contains(needle)

fn str_index_of(s: text, needle: text) -> i64:
    """Alias for str_find - find first occurrence."""
    str_find(s, needle)

fn str_last_index_of(s: text, needle: text) -> i64:
    """Find last occurrence of needle in s, return index or -1 if not found.

    Examples:
        str_last_index_of("hello world world", "world")  # 12
        str_last_index_of("hello", "xyz")                # -1
    """
    if needle == "":
        return s.len()

    val parts = s.split(needle)
    if parts.len() <= 1:
        return -1

    # Calculate position of last occurrence
    var pos = 0
    var i = 0
    while i < parts.len() - 1:
        pos = pos + parts[i].len() + needle.len()
        i = i + 1

    pos - needle.len()

fn str_count(s: text, needle: text) -> i64:
    """Count occurrences of needle in s.

    Examples:
        str_count("hello world world", "world")  # 2
        str_count("aaa", "a")                    # 3
    """
    if needle == "":
        return s.len() + 1

    val parts = s.split(needle)
    parts.len() - 1

# ============================================================================
# String Prefix/Suffix
# ============================================================================

fn str_starts_with(s: text, prefix: text) -> bool:
    """Check if s starts with prefix.

    Examples:
        str_starts_with("hello world", "hello")  # true
        str_starts_with("hello world", "world")  # false
    """
    s.starts_with(prefix)

fn str_ends_with(s: text, suffix: text) -> bool:
    """Check if s ends with suffix.

    Examples:
        str_ends_with("hello world", "world")  # true
        str_ends_with("hello world", "hello")  # false
    """
    s.ends_with(suffix)

# ============================================================================
# String Trimming
# ============================================================================

fn str_trim(s: text) -> text:
    """Remove leading and trailing whitespace.

    Examples:
        str_trim("  hello  ")  # "hello"
        str_trim("\n\thello\n")  # "hello"
    """
    s.trim()

fn str_trim_left(s: text) -> text:
    """Remove leading whitespace.

    Examples:
        str_trim_left("  hello  ")  # "hello  "
    """
    s.trim_start()

fn str_trim_right(s: text) -> text:
    """Remove trailing whitespace.

    Examples:
        str_trim_right("  hello  ")  # "  hello"
    """
    s.trim_end()

# ============================================================================
# String Case Conversion
# ============================================================================

fn str_to_upper(s: text) -> text:
    """Convert string to uppercase.

    Examples:
        str_to_upper("hello")  # "HELLO"
    """
    s.to_upper()

fn str_to_lower(s: text) -> text:
    """Convert string to lowercase.

    Examples:
        str_to_lower("HELLO")  # "hello"
    """
    s.to_lower()

# ============================================================================
# String Splitting and Joining
# ============================================================================

fn str_split(s: text, delimiter: text) -> [text]:
    """Split string by delimiter.

    Examples:
        str_split("a,b,c", ",")       # ["a", "b", "c"]
        str_split("hello world", " ") # ["hello", "world"]
    """
    s.split(delimiter)

fn str_join(parts: [text], separator: text) -> text:
    """Join array of strings with separator.

    Examples:
        str_join(["a", "b", "c"], ",")  # "a,b,c"
        str_join(["hello", "world"], " ")  # "hello world"
    """
    parts.join(separator)

# ============================================================================
# String Substring and Character Access
# ============================================================================

fn str_substring(s: text, start: i64, end: i64) -> text:
    """Extract substring from start (inclusive) to end (exclusive).

    Examples:
        str_substring("hello", 1, 4)  # "ell"
        str_substring("hello", 0, 5)  # "hello"
    """
    if start < 0 or end > s.len() or start >= end:
        return ""

    s[start:end]

fn str_char_at(s: text, index: i64) -> text:
    """Get character at index (returns empty string if out of bounds).

    Examples:
        str_char_at("hello", 0)  # "h"
        str_char_at("hello", 4)  # "o"
        str_char_at("hello", 10) # ""
    """
    if index < 0 or index >= s.len():
        return ""

    s[index:index + 1]

# ============================================================================
# String Predicates
# ============================================================================

fn str_is_empty(s: text) -> bool:
    """Check if string is empty.

    Examples:
        str_is_empty("")      # true
        str_is_empty("hello") # false
    """
    s.len() == 0
