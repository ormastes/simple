# Mutex Module
#
# Pure Simple wrappers around Rust runtime mutex SFFI.
#
# Usage:
#   val m = mutex_new(0)
#   val v = m.lock()       # returns protected value
#   m.unlock(v + 1)        # update and release

# --- SFFI declarations ---
extern fn rt_mutex_new(initial: Any) -> Any
extern fn rt_mutex_lock(mutex: Any) -> Any
extern fn rt_mutex_try_lock(mutex: Any) -> Any
extern fn rt_mutex_unlock(mutex: Any, new_value: Any) -> Any

# --- Mutex ---

class Mutex:
    _handle: Any

    fn lock() -> Any:
        rt_mutex_lock(self._handle)

    fn try_lock() -> Any:
        rt_mutex_try_lock(self._handle)

    fn unlock(new_value: Any) -> Any:
        rt_mutex_unlock(self._handle, new_value)

# --- API ---

fn mutex_new(initial: Any) -> Mutex:
    val handle = rt_mutex_new(initial)
    Mutex(_handle: handle)
