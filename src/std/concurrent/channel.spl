# Channel Module
#
# Pure Simple wrappers around Rust runtime channel SFFI.
#
# Usage:
#   val ch = channel_new()
#   ch.send(42)
#   val v = ch.recv()      # 42 (blocking)
#   val maybe = ch.try_recv()  # nil if empty
#   ch.close()

# --- SFFI declarations ---
extern fn rt_channel_new() -> i64
extern fn rt_channel_send(channel_id: i64, value: Any)
extern fn rt_channel_try_recv(channel_id: i64) -> Any
extern fn rt_channel_recv(channel_id: i64) -> Any
extern fn rt_channel_close(channel_id: i64)
extern fn rt_channel_is_closed(channel_id: i64) -> i64

# --- Channel ---

class Channel:
    _id: i64

    fn send(value: Any):
        rt_channel_send(self._id, value)

    fn try_recv() -> Any:
        rt_channel_try_recv(self._id)

    fn recv() -> Any:
        rt_channel_recv(self._id)

    fn close():
        rt_channel_close(self._id)

    fn is_closed() -> bool:
        rt_channel_is_closed(self._id) == 1

    fn id() -> i64:
        self._id

# --- API ---

fn channel_new() -> Channel:
    val id = rt_channel_new()
    Channel(_id: id)
