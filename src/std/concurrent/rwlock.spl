# RwLock Module
#
# Pure Simple wrappers around Rust runtime read-write lock SFFI.
#
# Usage:
#   val rw = rwlock_new(0)
#   val v = rw.read()        # shared read access
#   rw.set(42)               # update value

# --- SFFI declarations ---
extern fn rt_rwlock_new(initial: Any) -> Any
extern fn rt_rwlock_read(rwlock: Any) -> Any
extern fn rt_rwlock_write(rwlock: Any) -> Any
extern fn rt_rwlock_try_read(rwlock: Any) -> Any
extern fn rt_rwlock_try_write(rwlock: Any) -> Any
extern fn rt_rwlock_set(rwlock: Any, new_value: Any) -> Any

# --- RwLock ---

class RwLock:
    _handle: Any

    fn read() -> Any:
        rt_rwlock_read(self._handle)

    fn write() -> Any:
        rt_rwlock_write(self._handle)

    fn try_read() -> Any:
        rt_rwlock_try_read(self._handle)

    fn try_write() -> Any:
        rt_rwlock_try_write(self._handle)

    fn set(new_value: Any) -> Any:
        rt_rwlock_set(self._handle, new_value)

# --- API ---

fn rwlock_new(initial: Any) -> RwLock:
    val handle = rt_rwlock_new(initial)
    RwLock(_handle: handle)
