# Skip List Deletion Operations
#
# This module provides functions for removing elements from skip lists.

import types
import search

# Remove key from skip list
fn sl_remove(skiplist: tuple, key: i64) -> tuple:
    var nodes = types.sl_get_nodes(skiplist)
    var current_level = types.sl_get_level(skiplist)
    var size = types.sl_get_size(skiplist)
    var head_idx = types.sl_get_head_idx(skiplist)

    var update = search.sl_find_update_path(skiplist, key)
    var pred_idx = update[0]

    if pred_idx == types.NIL_REF:
        return skiplist

    var pred_node = nodes[pred_idx]
    var target_idx = types.sl_node_get_forward(pred_node, 0)

    if target_idx == types.NIL_REF:
        return skiplist

    var target_node = nodes[target_idx]
    var target_key = types.sl_node_key(target_node)

    if target_key != key:
        return skiplist

    var target_level = types.sl_node_level(target_node)
    var updated_nodes = nodes

    var lvl = 0
    while lvl <= target_level:
        var pred_idx2 = update[lvl]
        var pred_node2 = updated_nodes[pred_idx2]
        var target_next = types.sl_node_get_forward(target_node, lvl)
        var updated_pred = types.sl_node_set_forward(pred_node2, lvl, target_next)

        var temp_nodes = []
        var k = 0
        while k < updated_nodes.len():
            if k == pred_idx2:
                temp_nodes = temp_nodes + [updated_pred]
            else:
                var existing = updated_nodes[k]
                temp_nodes = temp_nodes + [existing]
            k = k + 1
        updated_nodes = temp_nodes

        lvl = lvl + 1

    var head_node = updated_nodes[head_idx]
    var updated_level = current_level
    while updated_level > 0:
        var next_idx = types.sl_node_get_forward(head_node, updated_level)
        if next_idx != types.NIL_REF:
            break
        updated_level = updated_level - 1

    var result = types.sl_set_nodes(skiplist, updated_nodes)
    result = types.sl_set_level(result, updated_level)
    result = types.sl_set_size(result, size - 1)
    result

# Delete key from skip list (alias for remove)
fn sl_delete(skiplist: tuple, key: i64) -> tuple:
    sl_remove(skiplist, key)

# Remove multiple keys
fn sl_remove_many(skiplist: tuple, keys: list) -> tuple:
    var result = skiplist
    var i = 0
    while i < keys.len():
        var key = keys[i]
        result = sl_remove(result, key)
        i = i + 1
    result
