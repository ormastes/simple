# Standard Library â€” Traits System (Layer 3)
#
# @tag:api
# @tag:stdlib
# @tag:experimental
#
# Ergonomic wrappers over the @traits compile-time introspection system.
# Provides high-level helper functions built on the core @traits built-ins.
#
# Uses __traits built-in (handled by eval.spl eval_builtin_call) for
# struct/enum introspection queries at runtime.
#
# Usage:
#   use std.traits.{field_count, has_field, is_integral_type}
#   val count = field_count("Point")
#   val has_x = has_field("Point", "x")
#   val is_i64 = is_integral_type("i64")

# ============================================================================
# Field / Member Enumeration
# ============================================================================

fn field_names(type_name: text) -> [text]:
    # Returns all field names of a struct type.
    # Calls __traits("fields", type_name) built-in.
    __traits("fields", type_name)

fn method_names(type_name: text) -> [text]:
    # Returns all method names of a struct/class type.
    # Calls __traits("methods", type_name) built-in.
    __traits("methods", type_name)

fn all_member_names(type_name: text) -> [text]:
    # Returns all members (fields + methods) of a type.
    # Calls __traits("all_members", type_name) built-in.
    __traits("all_members", type_name)

fn field_count(type_name: text) -> i64:
    # Returns the number of fields in a struct type.
    val names = field_names(type_name)
    names.len()

fn has_field(type_name: text, field_name: text) -> bool:
    # Returns true if type_name has a field named field_name.
    val names = field_names(type_name)
    for n in names:
        if n == field_name:
            return true
    false

fn has_method(type_name: text, method_name: text) -> bool:
    # Returns true if type_name has a method named method_name.
    val names = method_names(type_name)
    for n in names:
        if n == method_name:
            return true
    false

# ============================================================================
# Type Classification
# ============================================================================

fn is_struct_type(type_name: text) -> bool:
    # Returns true if type_name is a struct type.
    # Calls __traits("is_struct", type_name) built-in.
    __traits("is_struct", type_name)

fn is_class_type(type_name: text) -> bool:
    # Returns true if type_name is a class type (struct with methods).
    # Calls __traits("is_class", type_name) built-in.
    __traits("is_class", type_name)

fn is_enum_type(type_name: text) -> bool:
    # Returns true if type_name is an enum type.
    # Calls __traits("is_enum", type_name) built-in.
    __traits("is_enum", type_name)

fn enum_variant_names(type_name: text) -> [text]:
    # Returns all variant names of an enum type.
    # Calls __traits("enum_members", type_name) built-in.
    __traits("enum_members", type_name)

fn enum_variant_count(type_name: text) -> i64:
    # Returns the number of variants in an enum type.
    val names = enum_variant_names(type_name)
    names.len()

# ============================================================================
# Annotation / Attribute Queries
# ============================================================================

fn get_annotations(sym_name: text) -> [text]:
    # Returns list of known annotation names on sym_name (e.g. ["must_use"]).
    # Calls __traits("get_annotations", sym_name) built-in.
    __traits("get_annotations", sym_name)

fn has_annotation(sym_name: text, ann_name: text) -> bool:
    # Returns true if sym_name has the given annotation (e.g. "must_use").
    # Calls __traits("has_annotation", sym_name, ann_name) built-in.
    __traits("has_annotation", sym_name, ann_name)

# ============================================================================
# Numeric Type Classification
# ============================================================================

fn is_integral_type(type_name: text) -> bool:
    # Returns true if type_name is an integral numeric type.
    # Calls __traits("is_integral", type_name) built-in.
    __traits("is_integral", type_name)

fn is_float_type(type_name: text) -> bool:
    # Returns true if type_name is a floating-point type.
    # Calls __traits("is_float", type_name) built-in.
    __traits("is_float", type_name)

fn is_numeric_type(type_name: text) -> bool:
    # Returns true if type_name is a numeric type (integral or float).
    # Calls __traits("is_numeric", type_name) built-in.
    __traits("is_numeric", type_name)

# ============================================================================
# Other Type Classification
# ============================================================================

fn is_text_type(type_name: text) -> bool:
    # Returns true if type_name is the text type.
    type_name == "text"

fn is_bool_type(type_name: text) -> bool:
    # Returns true if type_name is the bool type.
    type_name == "bool"

fn is_array_type(type_name: text) -> bool:
    # Returns true if type_name looks like an array type.
    # Calls __traits("is_array", type_name) built-in.
    __traits("is_array", type_name)

fn is_dict_type(type_name: text) -> bool:
    # Returns true if type_name looks like a dict type.
    # Calls __traits("is_dict", type_name) built-in.
    __traits("is_dict", type_name)

fn is_fn(fn_name: text) -> bool:
    # Returns true if fn_name is a registered function.
    # Calls __traits("is_fn", fn_name) built-in.
    __traits("is_fn", fn_name)

fn enum_count(type_name: text) -> i64:
    # Returns the number of variants in an enum type.
    # Calls __traits("enum_count", type_name) built-in.
    __traits("enum_count", type_name)

fn member_type(type_name: text, field_name: text) -> text:
    # Returns the type name of a struct field.
    # Calls __traits("member_type", type_name, field_name) built-in.
    __traits("member_type", type_name, field_name)

fn set_member(obj, field_name: text, new_val):
    # Sets a struct field by name on obj.
    # Calls __traits("set_member", obj, field_name, new_val) built-in.
    __traits("set_member", obj, field_name, new_val)

# ============================================================================
# Exports
# ============================================================================

export field_names, method_names, all_member_names, field_count
export has_field, has_method
export is_struct_type, is_class_type, is_enum_type
export enum_variant_names, enum_variant_count
export get_annotations, has_annotation
export is_integral_type, is_float_type, is_numeric_type
export is_text_type, is_bool_type
export is_array_type, is_dict_type
export is_fn, enum_count, member_type, set_member
