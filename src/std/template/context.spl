# Template Engine Context Module
# Variable resolution and helpers

import template.types
import template.utilities

# ============================================================================
# VARIABLE RESOLUTION
# ============================================================================

fn resolve_var(ctx: [[text]], name: text) -> text:
    # Handle special loop variables
    if str_starts_with(name, "@"):
        val loop_var = ctx_get(ctx, name)
        if loop_var != nil:
            return loop_var
        return ""

    # Handle parent access ../
    if str_starts_with(name, "../"):
        # Would need parent context support
        return ""

    # Handle property access
    if str_contains(name, "."):
        val parts = str_split(name, ".")
        # For now, just get first part
        if parts.len() > 0:
            val val_opt = ctx_get(ctx, parts[0])
            if val_opt != nil:
                return val_opt
        return ""

    # Simple variable
    val val_opt = ctx_get(ctx, name)
    if val_opt != nil:
        return val_opt
    ""

fn is_truthy(val: text) -> bool:
    if val == "":
        return false
    if val == "0":
        return false
    if val == "false":
        return false
    if val == "nil":
        return false
    true

# ============================================================================
# HELPERS (Built-in functions)
# ============================================================================

fn apply_helper(name: text, args: [text]) -> text:
    if name == "upper":
        if args.len() > 0:
            return str_to_upper(args[0])
    if name == "lower":
        if args.len() > 0:
            return str_to_lower(args[0])
    if name == "capitalize":
        if args.len() > 0:
            return str_capitalize(args[0])
    if name == "trim":
        if args.len() > 0:
            return str_trim(args[0])
    if name == "reverse":
        if args.len() > 0:
            return str_reverse(args[0])
    if name == "truncate":
        if args.len() > 1:
            val max_len = str_to_int(args[1])
            return str_truncate(args[0], max_len)
    if name == "default":
        if args.len() > 1:
            if args[0] == "":
                return args[1]
            return args[0]
    if name == "add":
        if args.len() > 1:
            val a = str_to_int(args[0])
            val b = str_to_int(args[1])
            return int_to_str(a + b)
    if name == "sub":
        if args.len() > 1:
            val a = str_to_int(args[0])
            val b = str_to_int(args[1])
            return int_to_str(a - b)
    if name == "mul":
        if args.len() > 1:
            val a = str_to_int(args[0])
            val b = str_to_int(args[1])
            return int_to_str(a * b)
    if name == "div":
        if args.len() > 1:
            val a = str_to_int(args[0])
            val b = str_to_int(args[1])
            if b != 0:
                return int_to_str(a / b)
    ""

# ============================================================================
# EXPORTS
# ============================================================================

export resolve_var, is_truthy, apply_helper
