# Avro Utility Functions
#
# Character conversion, string/byte conversion, and formatting utilities
# for the Avro serialization system.

# ============================================================================
# Character Code Conversion
# ============================================================================

use string.{char_from_code}

fn avro_char_code(c: text) -> i64:
    """Get ASCII/UTF-8 code of a character."""
    if c == " ": return 32
    if c == "!": return 33
    if c == "\"": return 34
    if c == "#": return 35
    if c == "$": return 36
    if c == "%": return 37
    if c == "&": return 38
    if c == "'": return 39
    if c == "(": return 40
    if c == ")": return 41
    if c == "*": return 42
    if c == "+": return 43
    if c == ",": return 44
    if c == "-": return 45
    if c == ".": return 46
    if c == "/": return 47
    if c == "0": return 48
    if c == "1": return 49
    if c == "2": return 50
    if c == "3": return 51
    if c == "4": return 52
    if c == "5": return 53
    if c == "6": return 54
    if c == "7": return 55
    if c == "8": return 56
    if c == "9": return 57
    if c == ":": return 58
    if c == ";": return 59
    if c == "<": return 60
    if c == "=": return 61
    if c == ">": return 62
    if c == "?": return 63
    if c == "@": return 64
    if c == "A": return 65
    if c == "B": return 66
    if c == "C": return 67
    if c == "D": return 68
    if c == "E": return 69
    if c == "F": return 70
    if c == "G": return 71
    if c == "H": return 72
    if c == "I": return 73
    if c == "J": return 74
    if c == "K": return 75
    if c == "L": return 76
    if c == "M": return 77
    if c == "N": return 78
    if c == "O": return 79
    if c == "P": return 80
    if c == "Q": return 81
    if c == "R": return 82
    if c == "S": return 83
    if c == "T": return 84
    if c == "U": return 85
    if c == "V": return 86
    if c == "W": return 87
    if c == "X": return 88
    if c == "Y": return 89
    if c == "Z": return 90
    if c == "[": return 91
    if c == "\\": return 92
    if c == "]": return 93
    if c == "^": return 94
    if c == "_": return 95
    if c == "`": return 96
    if c == "a": return 97
    if c == "b": return 98
    if c == "c": return 99
    if c == "d": return 100
    if c == "e": return 101
    if c == "f": return 102
    if c == "g": return 103
    if c == "h": return 104
    if c == "i": return 105
    if c == "j": return 106
    if c == "k": return 107
    if c == "l": return 108
    if c == "m": return 109
    if c == "n": return 110
    if c == "o": return 111
    if c == "p": return 112
    if c == "q": return 113
    if c == "r": return 114
    if c == "s": return 115
    if c == "t": return 116
    if c == "u": return 117
    if c == "v": return 118
    if c == "w": return 119
    if c == "x": return 120
    if c == "y": return 121
    if c == "z": return 122
    if c == "{": return 123
    if c == "|": return 124
    if c == "}": return 125
    if c == "~": return 126
    if c == "\n": return 10
    if c == "\r": return 13
    if c == "\t": return 9
    0

fn avro_code_to_char(code: i64) -> text:
    """Wrapper for string.char_from_code."""
    char_from_code(code)
# ============================================================================
# String/Byte Conversion
# ============================================================================

fn avro_string_to_bytes(s: text) -> [i64]:
    """Convert string to byte array (ASCII/UTF-8)."""
    var result = []
    var i = 0
    while i < s.len():
        val ch = s[i:i+1]
        val code = avro_char_code(ch)
        result = result.push(code)
        i = i + 1
    result

fn avro_bytes_to_string(bytes: [i64]) -> text:
    """Convert byte array to string."""
    var result = ""
    for byte_val in bytes:
        val ch = avro_code_to_char(byte_val)
        result = result + ch
    result

# ============================================================================
# Formatting Functions
# ============================================================================

fn avro_format_bytes(bytes: [i64]) -> text:
    """Format byte array as hex string."""
    var result = ""
    for byte_val in bytes:
        val hex = avro_byte_to_hex(byte_val)
        result = result + hex + " "
    result

fn avro_byte_to_hex(n: i64) -> text:
    """Convert byte to hex string."""
    val high = n / 16
    val low = n % 16
    val high_char = avro_hex_digit(high)
    val low_char = avro_hex_digit(low)
    high_char + low_char

fn avro_hex_digit(n: i64) -> text:
    """Convert digit to hex character."""
    if n == 0: return "0"
    if n == 1: return "1"
    if n == 2: return "2"
    if n == 3: return "3"
    if n == 4: return "4"
    if n == 5: return "5"
    if n == 6: return "6"
    if n == 7: return "7"
    if n == 8: return "8"
    if n == 9: return "9"
    if n == 10: return "a"
    if n == 11: return "b"
    if n == 12: return "c"
    if n == 13: return "d"
    if n == 14: return "e"
    if n == 15: return "f"
    "?"
