# Avro JSON Encoding
#
# JSON representation of Avro schemas and values for human-readable
# serialization and debugging.

# ============================================================================
# JSON Encoding - Schema to JSON
# ============================================================================

fn avro_schema_to_json(schema) -> text:
    """Convert Avro schema to JSON representation."""
    val type_id = schema.type

    if type_id == avro_type_null():
        return "\"null\""

    if type_id == avro_type_boolean():
        return "\"boolean\""

    if type_id == avro_type_int():
        return "\"int\""

    if type_id == avro_type_long():
        return "\"long\""

    if type_id == avro_type_float():
        return "\"float\""

    if type_id == avro_type_double():
        return "\"double\""

    if type_id == avro_type_bytes():
        return "\"bytes\""

    if type_id == avro_type_string():
        return "\"string\""

    if type_id == avro_type_array():
        val items_json = avro_schema_to_json(schema.items)
        return "{\"type\":\"array\",\"items\":" + items_json + "}"

    if type_id == avro_type_map():
        val values_json = avro_schema_to_json(schema.values)
        return "{\"type\":\"map\",\"values\":" + values_json + "}"

    if type_id == avro_type_record():
        return avro_record_schema_to_json(schema)

    if type_id == avro_type_enum():
        return avro_enum_schema_to_json(schema)

    if type_id == avro_type_union():
        return avro_union_schema_to_json(schema)

    if type_id == avro_type_fixed():
        return avro_fixed_schema_to_json(schema)

    "\"unknown\""

fn avro_record_schema_to_json(schema) -> text:
    """Convert record schema to JSON."""
    var json = "{\"type\":\"record\",\"name\":\"" + schema.name + "\""

    if schema.namespace != nil:
        json = json + ",\"namespace\":\"" + schema.namespace + "\""

    if schema.doc != nil:
        json = json + ",\"doc\":\"" + schema.doc + "\""

    # Fields
    json = json + ",\"fields\":["
    val fields = schema.fields
    var i = 0
    while i < fields.len():
        if i > 0:
            json = json + ","
        val field = fields[i]
        json = json + avro_field_to_json(field)
        i = i + 1
    json = json + "]"

    json + "}"

fn avro_field_to_json(field) -> text:
    """Convert field to JSON."""
    var json = "{\"name\":\"" + field.name + "\""
    json = json + ",\"type\":" + avro_schema_to_json(field.type)

    if field.doc != nil:
        json = json + ",\"doc\":\"" + field.doc + "\""

    if field.default != nil:
        json = json + ",\"default\":null"  # Simplified

    json + "}"

fn avro_enum_schema_to_json(schema) -> text:
    """Convert enum schema to JSON."""
    var json = "{\"type\":\"enum\",\"name\":\"" + schema.name + "\""

    if schema.namespace != nil:
        json = json + ",\"namespace\":\"" + schema.namespace + "\""

    json = json + ",\"symbols\":["
    val symbols = schema.symbols
    var i = 0
    while i < symbols.len():
        if i > 0:
            json = json + ","
        json = json + "\"" + symbols[i] + "\""
        i = i + 1
    json = json + "]"

    json + "}"

fn avro_union_schema_to_json(schema) -> text:
    """Convert union schema to JSON."""
    var json = "["
    val types = schema.types
    var i = 0
    while i < types.len():
        if i > 0:
            json = json + ","
        json = json + avro_schema_to_json(types[i])
        i = i + 1
    json + "]"

fn avro_fixed_schema_to_json(schema) -> text:
    """Convert fixed schema to JSON."""
    var json = "{\"type\":\"fixed\",\"name\":\"" + schema.name + "\""
    json = json + ",\"size\":" + schema.size.to_text()
    json + "}"

# ============================================================================
# JSON Encoding - Value to JSON
# ============================================================================

fn avro_value_to_json(schema, value) -> text:
    """Convert Avro value to JSON representation."""
    val type_id = schema.type

    if type_id == avro_type_null():
        return "null"

    if type_id == avro_type_boolean():
        if value:
            return "true"
        return "false"

    if type_id == avro_type_int():
        return value.to_text()

    if type_id == avro_type_long():
        return value.to_text()

    if type_id == avro_type_float():
        return value.to_text()

    if type_id == avro_type_double():
        return value.to_text()

    if type_id == avro_type_string():
        return "\"" + value + "\""

    if type_id == avro_type_bytes():
        return avro_bytes_to_json(value)

    if type_id == avro_type_array():
        return avro_array_to_json(schema, value)

    if type_id == avro_type_map():
        return avro_map_to_json(schema, value)

    if type_id == avro_type_record():
        return avro_record_to_json(schema, value)

    if type_id == avro_type_enum():
        return "\"" + avro_enum_index_to_symbol(schema, value) + "\""

    if type_id == avro_type_union():
        # value is (branch_index, actual_value)
        val selected_schema = schema.types[value.0]
        return avro_value_to_json(selected_schema, value.1)

    "null"

fn avro_bytes_to_json(bytes: [i64]) -> text:
    """Convert byte array to JSON string (base64 would be standard)."""
    var json = "\""
    for byte_val in bytes:
        val ch = avro_code_to_char(byte_val)
        json = json + ch
    json + "\""

fn avro_array_to_json(schema, items: [tuple]) -> text:
    """Convert array to JSON."""
    var json = "["
    val item_schema = schema.items
    var i = 0
    while i < items.len():
        if i > 0:
            json = json + ","
        json = json + avro_value_to_json(item_schema, items[i])
        i = i + 1
    json + "]"

fn avro_map_to_json(schema, pairs: [tuple]) -> text:
    """Convert map to JSON."""
    var json = "{"
    val value_schema = schema.values
    var i = 0
    while i < pairs.len():
        if i > 0:
            json = json + ","
        val pair = pairs[i]
        json = json + "\"" + pair.0 + "\":"
        json = json + avro_value_to_json(value_schema, pair.1)
        i = i + 1
    json + "}"

fn avro_record_to_json(schema, field_values: [tuple]) -> text:
    """Convert record to JSON."""
    var json = "{"
    var i = 0
    while i < field_values.len():
        if i > 0:
            json = json + ","
        val field_pair = field_values[i]
        val field_name = field_pair.0
        val field_value = field_pair.1

        # Get field schema
        val field_schema = avro_get_field_schema(schema, field_name)
        json = json + "\"" + field_name + "\":"
        json = json + avro_value_to_json(field_schema, field_value)
        i = i + 1
    json + "}"
