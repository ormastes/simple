# Iterator Transformation
#
# Functions for transforming iterator elements.

import iterator/types (iter_next_internal)
import iterator/create (iter_from_array)

export iter_map, iter_take, iter_drop, iter_skip
export iter_flat_map, iter_flatten, iter_flatten_once
export iter_scan, iter_accumulate, iter_dedupe
export iter_reverse, iter_step_by, iter_alternate, iter_intersperse
export iter_enumerate

fn iter_map(iter, f):
    """Transform each element using function f.

    Example:
        val it = iter_from_array([1, 2, 3])
        val doubled = iter_map(it, \x: x * 2)
        iter_collect(doubled)  # [2, 4, 6]
    """
    var result = []
    var continue = true

    while continue:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            result.push(f(elem))
        else:
            continue = false

    iter_from_array(result)

fn iter_take(iter, n):
    """Take first n elements.

    Example:
        val it = iter_from_range(0, 100, 1)
        val first_five = iter_take(it, 5)
        iter_collect(first_five)  # [0, 1, 2, 3, 4]
    """
    var result = []
    var count = 0

    while count < n:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            result.push(elem)
            count = count + 1
        else:
            count = n  # Force exit

    iter_from_array(result)

fn iter_drop(iter, n):
    """Drop first n elements.

    Example:
        val it = iter_from_array([1, 2, 3, 4, 5])
        val dropped = iter_drop(it, 2)
        iter_collect(dropped)  # [3, 4, 5]
    """
    var count = 0

    # Skip n elements
    while count < n:
        val next_result = iter_next_internal(iter)
        val has_more = next_result[1]

        if has_more:
            count = count + 1
        else:
            count = n  # Force exit

    # Collect remaining
    var result = []
    var continue = true

    while continue:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            result.push(elem)
        else:
            continue = false

    iter_from_array(result)

fn iter_skip(iter, n):
    """Alias for iter_drop. Skip first n elements.

    Example:
        val it = iter_from_array([1, 2, 3, 4, 5])
        val skipped = iter_skip(it, 2)
        iter_collect(skipped)  # [3, 4, 5]
    """
    iter_drop(iter, n)

fn iter_flat_map(iter, f):
    """Map each element to an array and flatten results.

    Example:
        val it = iter_from_array([1, 2, 3])
        val doubled = iter_flat_map(it, \x: [x, x])
        iter_collect(doubled)  # [1, 1, 2, 2, 3, 3]
    """
    var result = []
    var continue = true

    while continue:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            val mapped = f(elem)
            for item in mapped:
                result.push(item)
        else:
            continue = false

    iter_from_array(result)

fn iter_flatten(iter):
    """Flatten an iterator of arrays into single iterator.

    Example:
        val it = iter_from_array([[1, 2], [3, 4], [5]])
        iter_collect(iter_flatten(it))  # [1, 2, 3, 4, 5]
    """
    var result = []
    var continue = true

    while continue:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            for item in elem:
                result.push(item)
        else:
            continue = false

    iter_from_array(result)

fn iter_scan(iter, init, f):
    """Like fold, but returns iterator of intermediate results.

    Example:
        val it = iter_from_array([1, 2, 3, 4])
        iter_collect(iter_scan(it, 0, \acc, x: acc + x))
        # [0, 1, 3, 6, 10]
    """
    var result = [init]
    var acc = init
    var continue = true

    while continue:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            acc = f(acc, elem)
            result.push(acc)
        else:
            continue = false

    iter_from_array(result)

fn iter_accumulate(iter):
    """Accumulate values (running sum).

    Example:
        val it = iter_from_array([1, 2, 3, 4])
        iter_collect(iter_accumulate(it))  # [1, 3, 6, 10]
    """
    var result = []
    var acc = 0
    var continue = true

    while continue:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            acc = acc + elem
            result.push(acc)
        else:
            continue = false

    iter_from_array(result)

fn iter_dedupe(iter):
    """Remove consecutive duplicate elements.

    Example:
        val it = iter_from_array([1, 1, 2, 2, 2, 3, 1])
        iter_collect(iter_dedupe(it))  # [1, 2, 3, 1]
    """
    var result = []
    var last = nil
    var has_last = false
    var continue = true

    while continue:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            if not has_last or elem != last:
                result.push(elem)
                last = elem
                has_last = true
        else:
            continue = false

    iter_from_array(result)

fn iter_reverse(iter):
    """Reverse iterator by collecting and reversing.

    Example:
        val it = iter_from_array([1, 2, 3])
        iter_collect(iter_reverse(it))  # [3, 2, 1]
    """
    import iterator/reduce (iter_collect)
    val items = iter_collect(iter)
    var reversed = []
    var i = items.len() - 1

    while i >= 0:
        reversed.push(items[i])
        i = i - 1

    iter_from_array(reversed)

fn iter_step_by(iter, step):
    """Take every nth element.

    Example:
        val it = iter_from_array([0, 1, 2, 3, 4, 5])
        iter_collect(iter_step_by(it, 2))  # [0, 2, 4]
    """
    import iterator/create (iter_empty)
    if step <= 0:
        return iter_empty()

    var result = []
    var index = 0
    var continue = true

    while continue:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            if index % step == 0:
                result.push(elem)
            index = index + 1
        else:
            continue = false

    iter_from_array(result)

fn iter_alternate(iter):
    """Take every other element (shortcut for step_by(2)).

    Example:
        val it = iter_from_array([1, 2, 3, 4, 5])
        iter_collect(iter_alternate(it))  # [1, 3, 5]
    """
    iter_step_by(iter, 2)

fn iter_intersperse(iter, separator):
    """Insert separator between elements.

    Example:
        val it = iter_from_array([1, 2, 3])
        iter_collect(iter_intersperse(it, 0))  # [1, 0, 2, 0, 3]
    """
    var result = []
    var first = true
    var continue = true

    while continue:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            if not first:
                result.push(separator)
            result.push(elem)
            first = false
        else:
            continue = false

    iter_from_array(result)

fn iter_enumerate(iter):
    """Add indices to elements as tuples (index, element).

    Example:
        val it = iter_from_array([10, 20, 30])
        iter_collect(iter_enumerate(it))  # [(0, 10), (1, 20), (2, 30)]
    """
    var result = []
    var index = 0
    var continue = true

    while continue:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            result.push((index, elem))
            index = index + 1
        else:
            continue = false

    iter_from_array(result)

fn iter_flatten_once(iter):
    """Flatten one level of nesting.

    Alias for iter_flatten.

    Example:
        val it = iter_from_array([[1, 2], [3, 4]])
        iter_collect(iter_flatten_once(it))  # [1, 2, 3, 4]
    """
    iter_flatten(iter)
