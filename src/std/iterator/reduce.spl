# Iterator Reduction
#
# Functions for reducing iterators to single values or collections.

import iterator/types (iter_next_internal)

export iter_collect, iter_fold, iter_reduce, iter_find
export iter_any, iter_all, iter_count, iter_count_matches
export iter_sum, iter_product, iter_min, iter_max, iter_average
export iter_position, iter_last, iter_nth, iter_nth_back
export iter_partition, iter_group_by, iter_unzip

fn iter_collect(iter):
    """Collect all iterator elements into an array.

    Example:
        val it = iter_from_array([1, 2, 3])
        iter_collect(it)  # [1, 2, 3]
    """
    var result = []
    var continue = true

    while continue:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            result.push(elem)
        else:
            continue = false

    result

fn iter_fold(iter, init, f):
    """Fold iterator from left with initial value.

    Example:
        val it = iter_from_array([1, 2, 3, 4])
        iter_fold(it, 0, \acc, x: acc + x)  # 10
    """
    var acc = init
    var continue = true

    while continue:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            acc = f(acc, elem)
        else:
            continue = false

    acc

fn iter_reduce(iter, f):
    """Reduce iterator without initial value (uses first element).

    Returns nil if iterator is empty.

    Example:
        val it = iter_from_array([1, 2, 3, 4])
        iter_reduce(it, \acc, x: acc + x)  # 10
    """
    val first_result = iter_next_internal(iter)
    val first_elem = first_result[0]
    val has_first = first_result[1]

    if not has_first:
        return nil

    var acc = first_elem
    var continue = true

    while continue:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            acc = f(acc, elem)
        else:
            continue = false

    acc

fn iter_find(iter, predicate):
    """Find first element satisfying predicate, or nil.

    Example:
        val it = iter_from_array([1, 2, 3, 4, 5])
        iter_find(it, \x: x > 3)  # 4
    """
    var continue = true

    while continue:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            if predicate(elem):
                return elem
        else:
            continue = false

    nil

fn iter_any(iter, predicate):
    """Check if any element satisfies predicate.

    Example:
        val it = iter_from_array([1, 2, 3, 4])
        iter_any(it, \x: x > 3)  # true
    """
    var continue = true

    while continue:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            if predicate(elem):
                return true
        else:
            continue = false

    false

fn iter_all(iter, predicate):
    """Check if all elements satisfy predicate.

    Example:
        val it = iter_from_array([2, 4, 6, 8])
        iter_all(it, \x: x % 2 == 0)  # true
    """
    var continue = true

    while continue:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            if not predicate(elem):
                return false
        else:
            continue = false

    true

fn iter_count(iter):
    """Count total elements in iterator.

    Example:
        val it = iter_from_array([1, 2, 3, 4, 5])
        iter_count(it)  # 5
    """
    var count = 0
    var continue = true

    while continue:
        val next_result = iter_next_internal(iter)
        val has_more = next_result[1]

        if has_more:
            count = count + 1
        else:
            continue = false

    count

fn iter_count_matches(iter, predicate):
    """Count elements satisfying predicate.

    Example:
        val it = iter_from_array([1, 2, 3, 4, 5])
        iter_count_matches(it, \x: x % 2 == 0)  # 2
    """
    var count = 0
    var continue = true

    while continue:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            if predicate(elem):
                count = count + 1
        else:
            continue = false

    count

fn iter_sum(iter):
    """Sum all numeric elements.

    Example:
        val it = iter_from_array([1, 2, 3, 4])
        iter_sum(it)  # 10
    """
    iter_fold(iter, 0, \acc, x: acc + x)

fn iter_product(iter):
    """Multiply all numeric elements.

    Example:
        val it = iter_from_array([1, 2, 3, 4])
        iter_product(it)  # 24
    """
    iter_fold(iter, 1, \acc, x: acc * x)

fn iter_min(iter):
    """Find minimum element, or nil if empty.

    Example:
        val it = iter_from_array([3, 1, 4, 1, 5])
        iter_min(it)  # 1
    """
    iter_reduce(iter, \acc, x: if x < acc: x else: acc)

fn iter_max(iter):
    """Find maximum element, or nil if empty.

    Example:
        val it = iter_from_array([3, 1, 4, 1, 5])
        iter_max(it)  # 5
    """
    iter_reduce(iter, \acc, x: if x > acc: x else: acc)

fn iter_average(iter):
    """Calculate average of numeric elements, or nil if empty.

    Example:
        val it = iter_from_array([1, 2, 3, 4])
        iter_average(it)  # 2.5
    """
    var sum = 0
    var count = 0
    var continue = true

    while continue:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            sum = sum + elem
            count = count + 1
        else:
            continue = false

    if count == 0:
        nil
    else:
        sum / count

fn iter_position(iter, predicate):
    """Find index of first element satisfying predicate, or nil.

    Example:
        val it = iter_from_array([1, 2, 3, 4, 5])
        iter_position(it, \x: x > 3)  # 3
    """
    var index = 0
    var continue = true

    while continue:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            if predicate(elem):
                return index
            index = index + 1
        else:
            continue = false

    nil

fn iter_last(iter):
    """Get last element, or nil if empty.

    Example:
        val it = iter_from_array([1, 2, 3, 4])
        iter_last(it)  # 4
    """
    var last = nil
    var has_elem = false
    var continue = true

    while continue:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            last = elem
            has_elem = true
        else:
            continue = false

    if has_elem:
        last
    else:
        nil

fn iter_nth(iter, n):
    """Get nth element (0-indexed), or nil if not enough elements.

    Example:
        val it = iter_from_array([10, 20, 30, 40])
        iter_nth(it, 2)  # 30
    """
    var count = 0

    while count <= n:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            if count == n:
                return elem
            count = count + 1
        else:
            return nil

    nil

fn iter_nth_back(iter, n):
    """Get nth element from back (0-indexed), or nil.

    Example:
        val it = iter_from_array([10, 20, 30, 40])
        iter_nth_back(it, 1)  # 30
    """
    val items = iter_collect(iter)
    val len = items.len()

    if n >= len:
        return nil

    items[len - 1 - n]

fn iter_partition(iter, predicate):
    """Partition iterator into two arrays: (matching, not_matching).

    Example:
        val it = iter_from_array([1, 2, 3, 4, 5])
        iter_partition(it, \x: x % 2 == 0)  # ([2, 4], [1, 3, 5])
    """
    var matching = []
    var not_matching = []
    var continue = true

    while continue:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            if predicate(elem):
                matching.push(elem)
            else:
                not_matching.push(elem)
        else:
            continue = false

    (matching, not_matching)

fn iter_group_by(iter, key_fn):
    """Group iterator elements by key function.

    Returns a dict mapping string keys to arrays of elements.

    Example:
        val it = iter_from_array([1, 2, 3, 4, 5])
        iter_group_by(it, \x: x % 2)  # {"0": [2, 4], "1": [1, 3, 5]}
    """
    var groups = {}
    var continue = true

    while continue:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            val key = "{key_fn(elem)}"
            if not groups.contains(key):
                groups[key] = []
            groups[key].push(elem)
        else:
            continue = false

    groups

fn iter_unzip(iter):
    """Unzip iterator of tuples into tuple of arrays.

    Example:
        val it = iter_from_array([(1, 2), (3, 4), (5, 6)])
        iter_unzip(it)  # ([1, 3, 5], [2, 4, 6])
    """
    var first = []
    var second = []
    var continue = true

    while continue:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            first.push(elem[0])
            second.push(elem[1])
        else:
            continue = false

    (first, second)
