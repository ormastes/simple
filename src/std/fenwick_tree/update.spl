# Fenwick Tree Update Operations
#
# Purpose: Point update operations and value modifications
#
# Contains:
# - Point update (add delta to single element)
# - Set value operations
# - Aliases for common update operations

# Import bit manipulation utilities from types module
mod fenwick_tree.types

# ============================================================================
# Point Update Operations
# ============================================================================

# Update single element at index i by adding delta
fn update(fenwick_tree, i: i64, delta: i64) -> (list, i64):
    """Add delta to element at index i (1-indexed).

    Updates tree[i] and all ancestors that depend on it.
    Traverses update path by repeatedly adding LSB.

    Algorithm:
      while i <= n:
        tree[i] += delta
        i = i + (i & -i)  # Move to parent

    Args:
      fenwick_tree: (tree, n) tuple
      i: 1-indexed position to update
      delta: Value to add

    Returns:
      Updated Fenwick tree

    Time: O(log n)

    Example:
      update(tree, 3, 5) adds 5 to position 3
      This updates tree[3], tree[4], tree[8], etc.
    """
    val tree = fenwick_tree.0
    val n = fenwick_tree.1

    if i < 1:
        return fenwick_tree
    if i > n:
        return fenwick_tree

    var idx = i
    while idx <= n:
        val current = tree[idx]
        tree[idx] = current + delta
        idx = get_parent(idx)

    (tree, n)

# Alias for update
fn add(fenwick_tree, i: i64, value: i64) -> (list, i64):
    """Add value to element at index i. Alias for update.

    Time: O(log n)
    """
    update(fenwick_tree, i, value)

# Set element at index i to a specific value
fn set_value(fenwick_tree, i: i64, value: i64) -> (list, i64):
    """Set element at index i to a specific value.

    First gets current value, then updates with difference.

    Args:
      fenwick_tree: (tree, n) tuple
      i: 1-indexed position
      value: New value to set

    Returns:
      Updated Fenwick tree

    Time: O(log n)
    """
    # Compute range sum [i,i] to get current value
    val sum_i = prefix_sum(fenwick_tree, i)
    val sum_prev = prefix_sum(fenwick_tree, i - 1)
    val current = sum_i - sum_prev
    val delta = value - current
    update(fenwick_tree, i, delta)

# Helper: prefix_sum needed for set_value
fn prefix_sum(fenwick_tree, i: i64) -> i64:
    """Compute prefix sum from index 1 to i (inclusive).

    Time: O(log n)
    """
    val tree = fenwick_tree.0
    val n = fenwick_tree.1

    if i < 0:
        return 0
    if i > n:
        return prefix_sum(fenwick_tree, n)

    var sum = 0
    var idx = i
    while idx > 0:
        val current = tree[idx]
        sum = sum + current
        idx = get_next(idx)

    sum
