# Bootstrap Build Script for Simple
#
# This script builds the Simple compiler from the bootstrap interpreter.
# It can be run using: bin/simple_bootstrap run src/build_bootstrap.spl

fn log(msg):
    print "[build] " + msg

fn err(msg):
    print "[ERROR] " + msg

fn run_cmd(cmd):
    log("$ " + cmd)
    val code = shell(cmd)
    if code != 0:
        err("Command failed with exit code " + str(code))
    return code

fn check_dir(path):
    if not is_dir(path):
        err("Directory not found: " + path)
        return false
    return true

fn check_file(path):
    if not file_exists(path):
        err("File not found: " + path)
        return false
    return true

fn copy_template(src, dst):
    log("Copying " + src + " -> " + dst)
    val content = read_file(src)
    if content == nil:
        err("Cannot read: " + src)
        return false
    val ok = write_file(dst, content)
    if not ok:
        err("Cannot write: " + dst)
        return false
    return true

fn build_ffi():
    log("=== Phase 1: Building FFI Wrapper ===")

    val template_dir = "src/app/ffi_gen/templates"
    val build_dir = "build/rust/ffi_gen/src"

    # Copy templates to build directory
    if not copy_template(template_dir + "/bootstrap_ffi.txt", build_dir + "/bootstrap_ffi.rs"):
        return 1

    # Copy other templates if they exist
    if file_exists(template_dir + "/file_io.txt"):
        copy_template(template_dir + "/file_io.txt", build_dir + "/file_io.rs")
    if file_exists(template_dir + "/env.txt"):
        copy_template(template_dir + "/env.txt", build_dir + "/env.rs")
    if file_exists(template_dir + "/gc.txt"):
        copy_template(template_dir + "/gc.txt", build_dir + "/gc.rs")
    if file_exists(template_dir + "/runtime_value.txt"):
        copy_template(template_dir + "/runtime_value.txt", build_dir + "/runtime_value.rs")
    if file_exists(template_dir + "/lib.txt"):
        copy_template(template_dir + "/lib.txt", build_dir + "/lib.rs")

    return 0

fn build_rust():
    log("=== Phase 2: Building Rust Workspace ===")

    # Change to build/rust directory
    val old_dir = getcwd()
    if not chdir("build/rust"):
        err("Cannot change to build/rust")
        return 1

    # Build release
    val code = run_cmd("cargo build --release")

    # Restore directory
    chdir(old_dir)

    if code != 0:
        return 1

    log("Rust build completed successfully")
    return 0

fn install_binary():
    log("=== Phase 3: Installing Binary ===")

    val src = "build/rust/target/release/simple_stub"
    val dst = "bin/simple_bootstrap"

    if not check_file(src):
        err("Build output not found: " + src)
        return 1

    val ok = copy_file(src, dst)
    if not ok:
        # Try with shell as fallback
        val code = run_cmd("cp " + src + " " + dst)
        if code != 0:
            return 1

    # Make executable
    run_cmd("chmod +x " + dst)

    log("Installed: " + dst)
    return 0

fn verify_build():
    log("=== Phase 4: Verifying Build ===")

    val bin = "bin/simple_bootstrap"
    if not check_file(bin):
        return 1

    # Test compile command
    val version = shell_output(bin + " --version")
    log("Version: " + trim(version))

    # Test run command with a simple script
    val test_code = "fn main():\n    return 42\n"
    write_file("/tmp/verify_build.spl", test_code)
    val code = shell(bin + " run /tmp/verify_build.spl")
    remove_file("/tmp/verify_build.spl")

    if code == 42:
        log("Build verification passed!")
        return 0
    else:
        err("Build verification failed, expected exit 42, got " + str(code))
        return 1

fn main():
    print ""
    print "=========================================="
    print "  Simple Bootstrap Build System"
    print "=========================================="
    print ""

    # Find project root
    val cwd = getcwd()
    log("Working directory: " + cwd)

    # Check if we're in the right place
    if not is_dir("build/rust"):
        # Try to find project root
        if is_dir("../build/rust"):
            chdir("..")
        elif is_dir("../../build/rust"):
            chdir("../..")
        else:
            err("Cannot find project root (build/rust not found)")
            return 1
        log("Changed to: " + getcwd())

    # Check required directories
    if not check_dir("build/rust/ffi_gen/src"):
        return 1
    if not check_dir("src/app/ffi_gen/templates"):
        return 1

    # Run build phases
    var code = 0

    code = build_ffi()
    if code != 0:
        return code

    code = build_rust()
    if code != 0:
        return code

    code = install_binary()
    if code != 0:
        return code

    code = verify_build()
    if code != 0:
        return code

    print ""
    print "=========================================="
    print "  Build Complete!"
    print "=========================================="
    print ""
    print "Binary installed: bin/simple_bootstrap"
    print ""
    print "Usage:"
    print "  bin/simple_bootstrap run script.spl"
    print "  bin/simple_bootstrap compile script.spl"
    print ""

    return 0
