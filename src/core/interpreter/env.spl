# Core Interpreter — Arena-Based Environment
#
# Seed-compilable scope/variable management.
# Uses parallel arrays — no generics, no Dict<K,V>.
#
# Each scope is a pair of parallel arrays: names + value_ids.
# Scopes form a stack (innermost last). Globals stored separately.

# ===== Scope Stack =====
# scope_names[i] = [text]   — variable names in scope i
# scope_values[i] = [i64]   — corresponding value_ids in scope i

var scope_names: [[text]] = []
var scope_values: [[i64]] = []
var env_depth: i64 = 0

# ===== Globals =====
var global_names: [text] = []
var global_values: [i64] = []

# ===== Environment Init/Reset =====

fn env_init():
    scope_names = []
    scope_values = []
    env_depth = 0
    global_names = []
    global_values = []
    # Start with one scope (module-level)
    scope_names.push([])
    scope_values.push([])
    env_depth = 1

fn env_reset():
    env_init()

# ===== Scope Management =====

fn env_push_scope():
    scope_names.push([])
    scope_values.push([])
    env_depth = env_depth + 1

fn env_pop_scope():
    if env_depth > 1:
        # Remove last scope
        var new_names: [[text]] = []
        var new_values: [[i64]] = []
        var i: i64 = 0
        for names in scope_names:
            if i < env_depth - 1:
                new_names.push(names)
                new_values.push(scope_values[i])
            i = i + 1
        scope_names = new_names
        scope_values = new_values
        env_depth = env_depth - 1

fn env_scope_depth() -> i64:
    env_depth

# ===== Variable Definition =====

fn env_define(name: text, value_id: i64):
    val top = env_depth - 1
    var names = scope_names[top]
    var values = scope_values[top]
    # Check if already defined in current scope
    var i: i64 = 0
    for n in names:
        if n == name:
            values[i] = value_id
            scope_values[top] = values
            return
        i = i + 1
    # New binding
    names.push(name)
    values.push(value_id)
    scope_names[top] = names
    scope_values[top] = values

# ===== Variable Assignment (search outward) =====

fn env_assign(name: text, value_id: i64) -> bool:
    # Search from innermost scope outward
    var si = env_depth - 1
    for s_names in scope_names:
        val scope_idx = si
        if scope_idx >= 0:
            val names = scope_names[scope_idx]
            val values = scope_values[scope_idx]
            var i: i64 = 0
            for n in names:
                if n == name:
                    var new_values = scope_values[scope_idx]
                    new_values[i] = value_id
                    scope_values[scope_idx] = new_values
                    return true
                i = i + 1
        si = si - 1
    # Check globals
    var gi: i64 = 0
    for gn in global_names:
        if gn == name:
            global_values[gi] = value_id
            return true
        gi = gi + 1
    false

# ===== Variable Lookup =====

fn env_lookup(name: text) -> i64:
    # Search from innermost scope outward
    var si = env_depth - 1
    for s_names in scope_names:
        val scope_idx = si
        if scope_idx >= 0:
            val names = scope_names[scope_idx]
            val values = scope_values[scope_idx]
            var i: i64 = 0
            for n in names:
                if n == name:
                    return values[i]
                i = i + 1
        si = si - 1
    # Check globals
    var gi: i64 = 0
    for gn in global_names:
        if gn == name:
            return global_values[gi]
        gi = gi + 1
    # VAL_NONE sentinel
    -1

# ===== Global Variables =====

fn env_define_global(name: text, value_id: i64):
    # Check if already defined
    var gi: i64 = 0
    for gn in global_names:
        if gn == name:
            global_values[gi] = value_id
            return
        gi = gi + 1
    # New global
    global_names.push(name)
    global_values.push(value_id)

fn env_lookup_global(name: text) -> i64:
    var gi: i64 = 0
    for gn in global_names:
        if gn == name:
            return global_values[gi]
        gi = gi + 1
    -1

export env_init, env_reset
export env_push_scope, env_pop_scope, env_scope_depth
export env_define, env_assign, env_lookup
export env_define_global, env_lookup_global
