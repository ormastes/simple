# Leak Check - CLI Configuration
#
# Parses command line arguments for the leak-check command.

use types

# Parse leak-check command line arguments
fn parse_leak_check_args(args: [text]) -> LeakCheckConfig:
    var cfg = default_leak_check_config()
    var i = 0
    while i < args.len():
        val arg = args[i]

        if arg.starts_with("--mode="):
            val mode_str = arg.substring(7)
            val parsed = leak_check_mode_from_string(mode_str)
            if parsed != nil:
                cfg.mode = parsed
            else:
                print "Error: invalid mode '{mode_str}'. Use: internal, external, both"

        elif arg.starts_with("--external-tool="):
            val tool_str = arg.substring(16)
            val parsed = external_tool_from_string(tool_str)
            if parsed != nil:
                cfg.external_tool = parsed
            else:
                print "Error: invalid external tool '{tool_str}'. Use: asan, valgrind"

        elif arg.starts_with("--report="):
            val fmt_str = arg.substring(9)
            val parsed = report_format_from_string(fmt_str)
            if parsed != nil:
                cfg.report_format = parsed
            else:
                print "Error: invalid report format '{fmt_str}'. Use: console, sdn, md"

        elif arg.starts_with("--output="):
            cfg.output_file = arg.substring(9)

        elif arg.starts_with("--compiler="):
            cfg.compiler_override = arg.substring(11)

        elif arg.starts_with("--gc-window="):
            val window_str = arg.substring(12)
            cfg.gc_leak_window = window_str.to_int()

        elif arg == "--verbose" or arg == "-v":
            cfg.verbose = true

        elif arg == "--track-source":
            cfg.track_source_locations = true

        elif arg == "--help" or arg == "-h":
            print_leak_check_usage()
            cfg.source_file = ""
            return cfg

        elif not arg.starts_with("-"):
            cfg.source_file = arg

        i = i + 1

    cfg

# Print usage information
fn print_leak_check_usage():
    print "Usage: simple leak-check [options] <source.spl>"
    print ""
    print "Unified memory leak detection tool."
    print ""
    print "OPTIONS:"
    print "    --mode=MODE             Detection mode: internal, external, both (default: internal)"
    print "    --external-tool=TOOL    External tool: asan, valgrind (default: asan)"
    print "    --report=FORMAT         Output format: console, sdn, md (default: console)"
    print "    --output=FILE           Write report to file (default: stdout)"
    print "    --compiler=CC           C compiler override (default: auto-detect)"
    print "    --gc-window=N           GC leak detection window size (default: 3)"
    print "    --track-source          Track source locations for allocations"
    print "    --verbose, -v           Verbose output"
    print "    --help, -h              Show this help message"
    print ""
    print "EXAMPLES:"
    print "    simple leak-check examples/hello.spl"
    print "    simple leak-check --mode=external --external-tool=asan examples/hello.spl"
    print "    simple leak-check --mode=both --verbose examples/hello.spl"
    print "    simple leak-check --report=md --output=leak_report.md examples/hello.spl"

export parse_leak_check_args, print_leak_check_usage
