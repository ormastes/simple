# Leak Check - Core Types
#
# Data structures for unified memory leak detection.

# Mode of leak checking
enum LeakCheckMode:
    Internal
    External
    Both

fn leak_check_mode_to_string(m: LeakCheckMode) -> text:
    match m:
        case LeakCheckMode.Internal: "internal"
        case LeakCheckMode.External: "external"
        case LeakCheckMode.Both: "both"

fn leak_check_mode_from_string(s: text) -> Option<LeakCheckMode>:
    match s.lower():
        case "internal": Some(LeakCheckMode.Internal)
        case "external": Some(LeakCheckMode.External)
        case "both": Some(LeakCheckMode.Both)
        case _: nil

# External tool selection
enum ExternalTool:
    Asan
    Valgrind

fn external_tool_to_string(t: ExternalTool) -> text:
    match t:
        case ExternalTool.Asan: "asan"
        case ExternalTool.Valgrind: "valgrind"

fn external_tool_from_string(s: text) -> Option<ExternalTool>:
    match s.lower():
        case "asan": Some(ExternalTool.Asan)
        case "valgrind": Some(ExternalTool.Valgrind)
        case _: nil

# Report output format
enum ReportFormat:
    Console
    Sdn
    Markdown

fn report_format_to_string(f: ReportFormat) -> text:
    match f:
        case ReportFormat.Console: "console"
        case ReportFormat.Sdn: "sdn"
        case ReportFormat.Markdown: "md"

fn report_format_from_string(s: text) -> Option<ReportFormat>:
    match s.lower():
        case "console": Some(ReportFormat.Console)
        case "sdn": Some(ReportFormat.Sdn)
        case "md" | "markdown": Some(ReportFormat.Markdown)
        case _: nil

# Configuration for leak check
class LeakCheckConfig:
    mode: LeakCheckMode
    external_tool: ExternalTool
    report_format: ReportFormat
    verbose: bool
    source_file: text
    output_file: text
    compiler_override: text
    track_source_locations: bool
    gc_leak_window: i64

fn default_leak_check_config() -> LeakCheckConfig:
    LeakCheckConfig(
        mode: LeakCheckMode.Internal,
        external_tool: ExternalTool.Asan,
        report_format: ReportFormat.Console,
        verbose: false,
        source_file: "",
        output_file: "",
        compiler_override: "",
        track_source_locations: false,
        gc_leak_window: 3
    )

# A single allocation record tracked by the internal tracker
class AllocationRecord:
    address: i64
    size: i64
    type_id: text
    source_file: text
    source_line: i64
    source_function: text
    timestamp_us: i64
    freed: bool

# Histogram bucket for allocation grouping
class AllocBucket:
    label: text
    count: i64
    total_bytes: i64

# Overall result of a leak check run
class LeakCheckResult:
    mode: text
    internal_leaks: [AllocationRecord]
    external_report: ExternalLeakReport
    duration_ms: i64
    exit_code: i64

fn empty_leak_check_result() -> LeakCheckResult:
    LeakCheckResult(
        mode: "internal",
        internal_leaks: [],
        external_report: empty_external_leak_report(),
        duration_ms: 0,
        exit_code: 0
    )

# Report from an external leak detection tool
class ExternalLeakReport:
    tool: text
    raw_output: text
    leaks: [ExternalLeak]
    definitely_lost_bytes: i64
    indirectly_lost_bytes: i64
    possibly_lost_bytes: i64
    still_reachable_bytes: i64

fn empty_external_leak_report() -> ExternalLeakReport:
    ExternalLeakReport(
        tool: "",
        raw_output: "",
        leaks: [],
        definitely_lost_bytes: 0,
        indirectly_lost_bytes: 0,
        possibly_lost_bytes: 0,
        still_reachable_bytes: 0
    )

# A single leak detected by an external tool
class ExternalLeak:
    bytes: i64
    blocks: i64
    category: text
    stack_frames: [text]

export LeakCheckMode, ExternalTool, ReportFormat
export leak_check_mode_to_string, leak_check_mode_from_string
export external_tool_to_string, external_tool_from_string
export report_format_to_string, report_format_from_string
export LeakCheckConfig, default_leak_check_config
export AllocationRecord, AllocBucket
export LeakCheckResult, empty_leak_check_result
export ExternalLeakReport, empty_external_leak_report, ExternalLeak
