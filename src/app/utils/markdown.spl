# Markdown generation utilities
# Provides builders for creating well-formatted markdown documents

use app.io

export MarkdownBuilder, heading, bold, italic, code, code_block
export link, bullet_list, numbered_list, table, horizontal_rule

class MarkdownBuilder:
    content: text

    fn append(text: text):
        """Append text to document"""
        self.content = self.content + text

    fn append_line(text: text):
        """Append text with newline"""
        self.content = self.content + text + "\n"

    fn heading(level: i64, text: text):
        """Add heading (level 1-6)"""
        var hashes = ""
        for i in 0..level:
            hashes = hashes + "#"
        self.append_line("{hashes} {text}")

    fn h1(text: text):
        """Add level 1 heading"""
        self.heading(1, text)

    fn h2(text: text):
        """Add level 2 heading"""
        self.heading(2, text)

    fn h3(text: text):
        """Add level 3 heading"""
        self.heading(3, text)

    fn paragraph(text: text):
        """Add paragraph"""
        self.append_line(text)
        self.append_line("")

    fn code_block(code: text, language: text):
        """Add code block with optional language"""
        if language.len() > 0:
            self.append_line("```{language}")
        else:
            self.append_line("```")
        self.append_line(code)
        self.append_line("```")
        self.append_line("")

    fn bullet_list(items: [text]):
        """Add bullet list"""
        for item in items:
            self.append_line("- {item}")
        self.append_line("")

    fn numbered_list(items: [text]):
        """Add numbered list"""
        for i in 0..items.len():
            val num = i + 1
            self.append_line("{num}. {items[i]}")
        self.append_line("")

    fn table(headers: [text], rows: [[text]]):
        """Add table with headers and rows"""
        # Header row
        val header_row = "| " + headers.join(" | ") + " |"
        self.append_line(header_row)

        # Separator row
        var sep_parts = []
        for h in headers:
            sep_parts = sep_parts + ["---"]
        val separator = "| " + sep_parts.join(" | ") + " |"
        self.append_line(separator)

        # Data rows
        for row in rows:
            val row_text = "| " + row.join(" | ") + " |"
            self.append_line(row_text)

        self.append_line("")

    fn horizontal_rule():
        """Add horizontal rule"""
        self.append_line("---")
        self.append_line("")

    fn to_string() -> text:
        """Get the generated markdown"""
        self.content

# Standalone formatter functions

fn heading(level: i64, text: text) -> text:
    """Create heading markdown"""
    var hashes = ""
    for i in 0..level:
        hashes = hashes + "#"
    "{hashes} {text}\n"

fn bold(text: text) -> text:
    """Make text bold"""
    "**{text}**"

fn italic(text: text) -> text:
    """Make text italic"""
    "*{text}*"

fn code(text: text) -> text:
    """Inline code"""
    "`{text}`"

fn code_block(code: text, language: text) -> text:
    """Create code block"""
    if language.len() > 0:
        "```{language}\n{code}\n```\n"
    else:
        "```\n{code}\n```\n"

fn link(text: text, url: text) -> text:
    """Create link"""
    "[{text}]({url})"

fn bullet_list(items: [text]) -> text:
    """Create bullet list"""
    var result = ""
    for item in items:
        result = result + "- {item}\n"
    result + "\n"

fn numbered_list(items: [text]) -> text:
    """Create numbered list"""
    var result = ""
    for i in 0..items.len():
        val num = i + 1
        result = result + "{num}. {items[i]}\n"
    result + "\n"

fn table(headers: [text], rows: [[text]]) -> text:
    """Create table"""
    var result = ""

    # Header
    result = result + "| " + headers.join(" | ") + " |\n"

    # Separator
    var sep_parts = []
    for h in headers:
        sep_parts = sep_parts + ["---"]
    result = result + "| " + sep_parts.join(" | ") + " |\n"

    # Rows
    for row in rows:
        result = result + "| " + row.join(" | ") + " |\n"

    result + "\n"

fn horizontal_rule() -> text:
    """Create horizontal rule"""
    "---\n\n"
