# Parser Loader - Load pure Simple parser with fallback
# Provides unified interface for loading parser (SMF or runtime)

use app.io.mod (env_get, file_exists)

export ParserMode, get_parser_mode, should_use_pure_parser

# Parser mode selection
enum ParserMode:
    Runtime      # Use built-in runtime parser
    Pure         # Use pure Simple parser (SMF)
    Auto         # Auto-detect based on environment

# Get parser mode from environment
fn get_parser_mode() -> ParserMode:
    val mode_str = env_get("SIMPLE_PURE_PARSER")

    if mode_str == "1" or mode_str == "true":
        ParserMode.Pure
    elif mode_str == "0" or mode_str == "false":
        ParserMode.Runtime
    elif mode_str == "auto":
        ParserMode.Auto
    else:
        # Default: use runtime parser
        ParserMode.Runtime

# Check if pure parser should be used
fn should_use_pure_parser() -> bool:
    match get_parser_mode():
        case ParserMode.Pure:
            # Check if SMF file exists
            val smf_path = "build/bootstrap/parser_stage2.smf"
            if file_exists(smf_path):
                true
            else:
                print "[Warning] SIMPLE_PURE_PARSER=1 but SMF not found at {smf_path}"
                print "[Warning] Falling back to runtime parser"
                false
        case ParserMode.Auto:
            # Auto mode: use pure parser if available
            file_exists("build/bootstrap/parser_stage2.smf")
        case ParserMode.Runtime:
            false

# Get parser info string
fn get_parser_info() -> text:
    if should_use_pure_parser():
        "Pure Simple Parser (SMF)"
    else:
        "Runtime Parser (built-in)"
