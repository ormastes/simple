# Public comment coverage statistics calculation and reporting

use std.text.{NL}

# Statistics for public comment coverage in a single module
struct PublicCoverageStats:
    module_path: text
    total_exports: i64
    documented_exports: i64
    undocumented_exports: i64
    coverage_percentage: f64

fn calculate_public_coverage(module_path: text, exports: [text], documented: [text]) -> PublicCoverageStats:
    """Calculate coverage statistics from export and documentation data.

    Args:
        module_path: Path to the module being analyzed
        exports: List of all exported symbol names
        documented: List of documented symbol names

    Returns:
        PublicCoverageStats with calculated metrics
    """
    val total = exports.len()
    val doc_count = documented.len()
    val undoc_count = total - doc_count

    var percentage = 0.0
    if total > 0:
        percentage = (doc_count * 100.0) / total

    PublicCoverageStats(
        module_path: module_path,
        total_exports: total,
        documented_exports: doc_count,
        undocumented_exports: undoc_count,
        coverage_percentage: percentage
    )

fn format_coverage_report(stats: PublicCoverageStats) -> text:
    """Format coverage statistics as human-readable text report.

    Args:
        stats: Coverage statistics to format

    Returns:
        Multi-line text report with formatted statistics
    """
    var report = ""

    report = report + "Public Comment Coverage - {stats.module_path}{NL}"
    report = report + "  Total exports:        {stats.total_exports}{NL}"
    report = report + "  Documented:           {stats.documented_exports}{NL}"
    report = report + "  Undocumented:         {stats.undocumented_exports}{NL}"

    # Format percentage with one decimal place
    val pct_int = stats.coverage_percentage
    val pct_frac = (stats.coverage_percentage - pct_int) * 10.0
    val pct_str = "{pct_int}.{pct_frac}"

    report = report + "  Coverage:             {pct_str}%{NL}"

    report

fn coverage_to_json(stats: PublicCoverageStats) -> text:
    """Convert coverage statistics to JSON format.

    Args:
        stats: Coverage statistics to convert

    Returns:
        JSON string representation
    """
    var json = ""

    json = json + "{{NL}"
    json = json + "  \"module_path\": \"{stats.module_path}\",{NL}"
    json = json + "  \"total_exports\": {stats.total_exports},{NL}"
    json = json + "  \"documented_exports\": {stats.documented_exports},{NL}"
    json = json + "  \"undocumented_exports\": {stats.undocumented_exports},{NL}"
    json = json + "  \"coverage_percentage\": {stats.coverage_percentage}{NL}"
    json = json + "}}{NL}"

    json

fn meets_threshold(stats: PublicCoverageStats, threshold: f64) -> bool:
    """Check if coverage meets minimum threshold.

    Args:
        stats: Coverage statistics to check
        threshold: Minimum required coverage percentage (0.0-100.0)

    Returns:
        true if coverage meets or exceeds threshold, false otherwise
    """
    stats.coverage_percentage >= threshold

fn format_summary_report(all_stats: [PublicCoverageStats]) -> text:
    """Format summary report for multiple modules.

    Args:
        all_stats: List of coverage statistics for multiple modules

    Returns:
        Multi-line text report with overall summary
    """
    var report = ""

    report = report + "Public Comment Coverage Summary{NL}"
    report = report + "==============================={NL}{NL}"

    var total_exports = 0
    var total_documented = 0
    var module_count = 0

    for stats in all_stats:
        total_exports = total_exports + stats.total_exports
        total_documented = total_documented + stats.documented_exports
        module_count = module_count + 1

    val total_undocumented = total_exports - total_documented

    var overall_percentage = 0.0
    if total_exports > 0:
        overall_percentage = (total_documented * 100.0) / total_exports

    report = report + "Overall Statistics:{NL}"
    report = report + "  Modules analyzed:     {module_count}{NL}"
    report = report + "  Total exports:        {total_exports}{NL}"
    report = report + "  Documented:           {total_documented}{NL}"
    report = report + "  Undocumented:         {total_undocumented}{NL}"

    # Format percentage
    val pct_int = overall_percentage
    val pct_frac = (overall_percentage - pct_int) * 10.0
    val pct_str = "{pct_int}.{pct_frac}"

    report = report + "  Coverage:             {pct_str}%{NL}{NL}"

    report = report + "Per-Module Breakdown:{NL}"
    for stats in all_stats:
        val module_pct_int = stats.coverage_percentage
        val module_pct_frac = (stats.coverage_percentage - module_pct_int) * 10.0
        val module_pct_str = "{module_pct_int}.{module_pct_frac}"

        report = report + "  {stats.module_path}: {module_pct_str}% ({stats.documented_exports}/{stats.total_exports}){NL}"

    report

fn summary_to_json(all_stats: [PublicCoverageStats]) -> text:
    """Convert summary statistics to JSON format.

    Args:
        all_stats: List of coverage statistics for multiple modules

    Returns:
        JSON string with overall summary and per-module details
    """
    var total_exports = 0
    var total_documented = 0

    for stats in all_stats:
        total_exports = total_exports + stats.total_exports
        total_documented = total_documented + stats.documented_exports

    val total_undocumented = total_exports - total_documented

    var overall_percentage = 0.0
    if total_exports > 0:
        overall_percentage = (total_documented * 100.0) / total_exports

    var json = ""

    json = json + "{{NL}"
    json = json + "  \"summary\": {{NL}"
    json = json + "    \"module_count\": {all_stats.len()},{NL}"
    json = json + "    \"total_exports\": {total_exports},{NL}"
    json = json + "    \"documented_exports\": {total_documented},{NL}"
    json = json + "    \"undocumented_exports\": {total_undocumented},{NL}"
    json = json + "    \"coverage_percentage\": {overall_percentage}{NL}"
    json = json + "  }},{NL}"
    json = json + "  \"modules\": [{NL}"

    var idx = 0
    for stats in all_stats:
        json = json + "    {{NL}"
        json = json + "      \"module_path\": \"{stats.module_path}\",{NL}"
        json = json + "      \"total_exports\": {stats.total_exports},{NL}"
        json = json + "      \"documented_exports\": {stats.documented_exports},{NL}"
        json = json + "      \"undocumented_exports\": {stats.undocumented_exports},{NL}"
        json = json + "      \"coverage_percentage\": {stats.coverage_percentage}{NL}"

        if idx < all_stats.len() - 1:
            json = json + "    }},{NL}"
        else:
            json = json + "    }}{NL}"

        idx = idx + 1

    json = json + "  ]{NL}"
    json = json + "}}{NL}"

    json

# MDSOC Integration - Statistics for CapsuleVisibility.Public exports
struct MdsocCoverageStats:
    """Coverage statistics for MDSOC virtual capsule public exports."""
    capsule_name: text
    total_public_exports: i64
    documented_public_exports: i64
    undocumented_public_exports: i64
    coverage_percentage: f64
    doc_violations: [text]

fn calculate_mdsoc_coverage(capsule_name: text, public_exports: [text], documented: [text], violations: [text]) -> MdsocCoverageStats:
    """Calculate MDSOC-specific coverage for CapsuleVisibility.Public exports.

    Args:
        capsule_name: Name of the virtual capsule
        public_exports: List of all Public visibility exports
        documented: List of documented exports
        violations: List of violation messages

    Returns:
        MdsocCoverageStats with calculated metrics
    """
    val total = public_exports.len()
    val doc_count = documented.len()
    val undoc_count = total - doc_count

    var percentage = 0.0
    if total > 0:
        percentage = (doc_count * 100.0) / total

    MdsocCoverageStats(
        capsule_name: capsule_name,
        total_public_exports: total,
        documented_public_exports: doc_count,
        undocumented_public_exports: undoc_count,
        coverage_percentage: percentage,
        doc_violations: violations
    )

fn format_mdsoc_report(stats: MdsocCoverageStats) -> text:
    """Format MDSOC coverage report with violation details.

    Args:
        stats: MDSOC coverage statistics

    Returns:
        Multi-line text report for capsule documentation coverage
    """
    var report = ""

    report = report + "MDSOC Capsule Documentation Coverage - {stats.capsule_name}{NL}"
    report = report + "========================================{NL}"
    report = report + "  Public exports:       {stats.total_public_exports}{NL}"
    report = report + "  Documented:           {stats.documented_public_exports}{NL}"
    report = report + "  Undocumented:         {stats.undocumented_public_exports}{NL}"

    val pct_int = stats.coverage_percentage
    val pct_frac = (stats.coverage_percentage - pct_int) * 10.0
    val pct_str = "{pct_int}.{pct_frac}"

    report = report + "  Coverage:             {pct_str}%{NL}{NL}"

    if stats.doc_violations.len() > 0:
        report = report + "Documentation Violations:{NL}"
        for violation in stats.doc_violations:
            report = report + "  - {violation}{NL}"

    report

fn mdsoc_stats_to_json(stats: MdsocCoverageStats) -> text:
    """Convert MDSOC stats to JSON format.

    Args:
        stats: MDSOC coverage statistics

    Returns:
        JSON string representation
    """
    var json = ""

    json = json + "{{NL}"
    json = json + "  \"capsule_name\": \"{stats.capsule_name}\",{NL}"
    json = json + "  \"total_public_exports\": {stats.total_public_exports},{NL}"
    json = json + "  \"documented_public_exports\": {stats.documented_public_exports},{NL}"
    json = json + "  \"undocumented_public_exports\": {stats.undocumented_public_exports},{NL}"
    json = json + "  \"coverage_percentage\": {stats.coverage_percentage},{NL}"
    json = json + "  \"violations\": [{NL}"

    var idx = 0
    for violation in stats.doc_violations:
        json = json + "    \"{violation}\""
        if idx < stats.doc_violations.len() - 1:
            json = json + ",{NL}"
        else:
            json = json + "{NL}"
        idx = idx + 1

    json = json + "  ]{NL}"
    json = json + "}}{NL}"

    json

export PublicCoverageStats
export calculate_public_coverage
export format_coverage_report
export coverage_to_json
export meets_threshold
export format_summary_report
export summary_to_json
export MdsocCoverageStats
export calculate_mdsoc_coverage
export format_mdsoc_report
export mdsoc_stats_to_json
