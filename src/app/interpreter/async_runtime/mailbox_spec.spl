# Mailbox Tests
#
# Tests for off-heap message queue.

from mailbox import {Mailbox, MailboxConfig, MailboxStats, MessageRef, MessagePriority, SendResult}

describe "Mailbox - Configuration":
    it "creates with default config":
        val mailbox = Mailbox.default()

        assert mailbox.config.capacity == 1000
        assert mailbox.config.off_heap
        assert not mailbox.config.priority_enabled

    it "creates unbounded mailbox":
        val mailbox = Mailbox.unbounded()

        assert mailbox.config.capacity == 0

    it "creates bounded mailbox":
        val config = MailboxConfig.bounded(500)
        val mailbox = Mailbox.new(config)

        assert mailbox.config.capacity == 500

    it "creates priority-enabled mailbox":
        val config = MailboxConfig.with_priority()
        val mailbox = Mailbox.new(config)

        assert mailbox.config.priority_enabled

describe "Mailbox - Send":
    it "sends normal message":
        var mailbox = Mailbox.default()
        val result = mailbox.send_normal(12345, 100, Some(1))

        assert result == SendResult.Success
        assert mailbox.total_size() == 1

    it "sends high priority message":
        var mailbox = Mailbox.new(MailboxConfig.with_priority())
        val result = mailbox.send_high(12345, 100, Some(1))

        assert result == SendResult.Success
        assert mailbox.stats.high_priority_count == 1

    it "rejects when queue full":
        var mailbox = Mailbox.new(MailboxConfig.bounded(2))

        mailbox.send_normal(1, 10, None)
        mailbox.send_normal(2, 10, None)
        val result = mailbox.send_normal(3, 10, None)

        assert result == SendResult.QueueFull

    it "reserves space for high priority":
        var mailbox = Mailbox.new(MailboxConfig.bounded(10))

        # Fill most of the queue
        for i in 0..9:
            mailbox.send_normal(i, 10, None)

        # Normal fails, high succeeds
        val normal_result = mailbox.send_normal(100, 10, None)
        val high_result = mailbox.send_high(101, 10, None)

        assert normal_result == SendResult.QueueFull
        assert high_result == SendResult.Success

    it "rejects after close":
        var mailbox = Mailbox.default()
        mailbox.close()

        val result = mailbox.send_normal(1, 10, None)

        assert result == SendResult.MailboxClosed

describe "Mailbox - Receive":
    it "receives in FIFO order":
        var mailbox = Mailbox.default()

        mailbox.send_normal(1, 10, None)
        mailbox.send_normal(2, 10, None)
        mailbox.send_normal(3, 10, None)

        val msg1 = mailbox.receive()
        val msg2 = mailbox.receive()

        assert msg1.?.id == 0
        assert msg2.?.id == 1

    it "receives by priority order":
        var mailbox = Mailbox.new(MailboxConfig.with_priority())

        # Send in mixed order
        mailbox.send(3, 10, None, MessagePriority.Low)
        mailbox.send(2, 10, None, MessagePriority.Normal)
        mailbox.send(1, 10, None, MessagePriority.High)

        # Should receive high first
        val msg = mailbox.receive()
        assert msg.?.priority == MessagePriority.High

    it "returns None when empty":
        var mailbox = Mailbox.default()
        val msg = mailbox.receive()

        assert not msg.?

    it "updates stats on receive":
        var mailbox = Mailbox.default()
        mailbox.send_normal(1, 100, None)
        mailbox.receive()

        val stats = mailbox.get_stats()
        assert stats.total_processed == 1
        assert stats.off_heap_bytes == 0

describe "Mailbox - Selective Receive":
    it "selects by predicate":
        var mailbox = Mailbox.default()

        mailbox.send_normal(100, 10, Some(1))
        mailbox.send_normal(200, 20, Some(2))
        mailbox.send_normal(300, 30, Some(1))

        # Select message from sender 2
        val msg = mailbox.select(\m: m.sender_id == Some(2))

        assert msg.?
        assert msg.unwrap().sender_id == Some(2)
        assert mailbox.total_size() == 2  # Other messages remain

    it "selects by sender":
        var mailbox = Mailbox.default()

        mailbox.send_normal(100, 10, Some(5))
        mailbox.send_normal(200, 20, Some(10))

        val msg = mailbox.select_by_sender(10)

        assert msg.?
        assert msg.unwrap().sender_id == Some(10)

    it "returns None when no match":
        var mailbox = Mailbox.default()
        mailbox.send_normal(100, 10, Some(1))

        val msg = mailbox.select(\m: m.sender_id == Some(999))

        assert not msg.?
        assert mailbox.total_size() == 1  # Message still there

describe "Mailbox - Management":
    it "clears all messages":
        var mailbox = Mailbox.default()

        mailbox.send_normal(1, 10, None)
        mailbox.send_normal(2, 10, None)
        mailbox.clear()

        assert mailbox.is_empty()
        assert mailbox.stats.current_size == 0

    it "drops stale messages":
        var mailbox = Mailbox.default()

        # Send messages (they'll have timestamp 0 from placeholder)
        mailbox.send_normal(1, 10, None)
        mailbox.send_normal(2, 10, None)

        # Drop messages older than -1 (all of them)
        val dropped = mailbox.drop_stale(-1)

        assert dropped == 2
        assert mailbox.is_empty()

    it "closes mailbox":
        var mailbox = Mailbox.default()
        mailbox.send_normal(1, 10, None)

        mailbox.close()

        assert mailbox.is_closed
        # Can still receive existing messages
        val msg = mailbox.receive()
        assert msg.?

describe "Mailbox - Queries":
    it "reports size":
        var mailbox = Mailbox.default()

        assert mailbox.total_size() == 0
        mailbox.send_normal(1, 10, None)
        assert mailbox.total_size() == 1

    it "reports empty status":
        var mailbox = Mailbox.default()

        assert mailbox.is_empty()
        mailbox.send_normal(1, 10, None)
        assert not mailbox.is_empty()

    it "reports full status":
        var mailbox = Mailbox.new(MailboxConfig.bounded(2))

        assert not mailbox.is_full()
        mailbox.send_normal(1, 10, None)
        mailbox.send_normal(2, 10, None)
        assert mailbox.is_full()

describe "Mailbox - Statistics":
    it "tracks throughput":
        var mailbox = Mailbox.default()

        mailbox.send_normal(1, 10, None)
        mailbox.send_normal(2, 10, None)
        mailbox.receive()

        val stats = mailbox.get_stats()
        val throughput = stats.throughput()

        assert throughput == 0.5  # 1 processed / 2 received

    it "tracks drop rate":
        var mailbox = Mailbox.new(MailboxConfig.bounded(1))

        mailbox.send_normal(1, 10, None)
        mailbox.send_normal(2, 10, None)  # Dropped

        val stats = mailbox.get_stats()
        val drop_rate = stats.drop_rate()

        assert drop_rate == 50.0  # 1 dropped / 2 attempted

    it "tracks peak size":
        var mailbox = Mailbox.default()

        mailbox.send_normal(1, 10, None)
        mailbox.send_normal(2, 10, None)
        mailbox.send_normal(3, 10, None)
        mailbox.receive()
        mailbox.receive()

        val stats = mailbox.get_stats()
        assert stats.peak_size == 3

describe "MessagePriority - Ordering":
    it "compares priorities":
        assert MessagePriority.High.cmp(MessagePriority.Normal) < 0
        assert MessagePriority.Normal.cmp(MessagePriority.Low) < 0
        assert MessagePriority.Low.cmp(MessagePriority.High) > 0

    it "converts to i64":
        assert MessagePriority.High.to_i64() == 0
        assert MessagePriority.Normal.to_i64() == 1
        assert MessagePriority.Low.to_i64() == 2

describe "MessageRef - Age":
    it "calculates message age":
        val msg = MessageRef.new(1, None, MessagePriority.Normal, 100, 0)
        # With placeholder current_time_ms() returning 0, age is 0
        assert msg.age_ms() == 0

    it "checks staleness":
        val msg = MessageRef.new(1, None, MessagePriority.Normal, 100, 0)
        # Message with age 0 is not stale for positive threshold
        assert not msg.is_stale(1000)
        # But is stale for negative threshold
        assert msg.is_stale(-1)

describe "Mailbox - Display":
    it "formats mailbox for display":
        val mailbox = Mailbox.default()
        val str = mailbox.fmt()

        assert str.contains("Mailbox")
        assert str.contains("size=0")

    it "formats stats for display":
        val stats = MailboxStats.new()
        val str = stats.fmt()

        assert str.contains("MailboxStats")
