# SDN Extern Functions
#
# FFI wrappers for SDN file operations.
# Port of rust/compiler/src/interpreter_extern/sdn.rs

from ..core import {Value, InterpreterError}

export sdn_version, sdn_check, sdn_to_json, sdn_from_json
export sdn_get, sdn_set, sdn_fmt

val SDN_VERSION = "sdn 0.1.0"

# FFI declarations to runtime SDN functions
@extern("rt_sdn_check")
fn _rt_sdn_check(path: text) -> i64

@extern("rt_sdn_to_json")
fn _rt_sdn_to_json(path: text) -> text

@extern("rt_sdn_from_json")
fn _rt_sdn_from_json(path: text) -> text

@extern("rt_sdn_get")
fn _rt_sdn_get(path: text, key: text) -> text

@extern("rt_sdn_set")
fn _rt_sdn_set(path: text, key: text, value: text) -> i64

@extern("rt_sdn_fmt")
fn _rt_sdn_fmt(path: text) -> i64

fn sdn_version(args: [Value]) -> Result<Value, InterpreterError>:
    Ok(Value.string(SDN_VERSION))

fn sdn_check(args: [Value]) -> Result<Value, InterpreterError>:
    val path = args[0].as_string() ?? return Ok(Value.int(1))
    Ok(Value.int(_rt_sdn_check(path)))

fn sdn_to_json(args: [Value]) -> Result<Value, InterpreterError>:
    val path = args[0].as_string() ?? return Ok(Value.string(""))
    Ok(Value.string(_rt_sdn_to_json(path)))

fn sdn_from_json(args: [Value]) -> Result<Value, InterpreterError>:
    val path = args[0].as_string() ?? return Ok(Value.string(""))
    Ok(Value.string(_rt_sdn_from_json(path)))

fn sdn_get(args: [Value]) -> Result<Value, InterpreterError>:
    val path = args[0].as_string() ?? return Ok(Value.string(""))
    val key = args[1].as_string() ?? return Ok(Value.string(""))
    Ok(Value.string(_rt_sdn_get(path, key)))

fn sdn_set(args: [Value]) -> Result<Value, InterpreterError>:
    val path = args[0].as_string() ?? return Ok(Value.int(1))
    val key = args[1].as_string() ?? return Ok(Value.int(1))
    val value = args[2].as_string() ?? return Ok(Value.int(1))
    Ok(Value.int(_rt_sdn_set(path, key, value)))

fn sdn_fmt(args: [Value]) -> Result<Value, InterpreterError>:
    val path = args[0].as_string() ?? return Ok(Value.int(1))
    Ok(Value.int(_rt_sdn_fmt(path)))
