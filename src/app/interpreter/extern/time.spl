# Time Extern Functions
#
# FFI wrappers for time queries and DateTime operations.
# Port of rust/compiler/src/interpreter_extern/time.rs

from ..core import {Value, InterpreterError}

export time_now_seconds, current_time_unix, current_time_ms
export progress_init, progress_reset, progress_get_elapsed_seconds
export time_now_unix_micros
export timestamp_get_year, timestamp_get_month, timestamp_get_day
export timestamp_get_hour, timestamp_get_minute, timestamp_get_second
export timestamp_get_microsecond, timestamp_from_components
export timestamp_add_days, timestamp_diff_days

# FFI declarations
@extern("rt_time_now_seconds")
fn _rt_time_now_seconds() -> f64

@extern("rt_progress_init")
fn _rt_progress_init()

@extern("rt_progress_reset")
fn _rt_progress_reset()

@extern("rt_progress_get_elapsed_seconds")
fn _rt_progress_get_elapsed_seconds() -> f64

@extern("rt_time_now_unix_micros")
fn _rt_time_now_unix_micros() -> i64

@extern("rt_timestamp_get_year")
fn _rt_timestamp_get_year(micros: i64) -> i32

@extern("rt_timestamp_get_month")
fn _rt_timestamp_get_month(micros: i64) -> i32

@extern("rt_timestamp_get_day")
fn _rt_timestamp_get_day(micros: i64) -> i32

@extern("rt_timestamp_get_hour")
fn _rt_timestamp_get_hour(micros: i64) -> i32

@extern("rt_timestamp_get_minute")
fn _rt_timestamp_get_minute(micros: i64) -> i32

@extern("rt_timestamp_get_second")
fn _rt_timestamp_get_second(micros: i64) -> i32

@extern("rt_timestamp_get_microsecond")
fn _rt_timestamp_get_microsecond(micros: i64) -> i32

@extern("rt_timestamp_from_components")
fn _rt_timestamp_from_components(year: i32, month: i32, day: i32,
                                  hour: i32, minute: i32, second: i32,
                                  microsecond: i32) -> i64

@extern("rt_timestamp_add_days")
fn _rt_timestamp_add_days(micros: i64, days: i64) -> i64

@extern("rt_timestamp_diff_days")
fn _rt_timestamp_diff_days(micros1: i64, micros2: i64) -> i64

fn time_now_seconds(args: [Value]) -> Result<Value, InterpreterError>:
    Ok(Value.float(_rt_time_now_seconds()))

fn current_time_unix(args: [Value]) -> Result<Value, InterpreterError>:
    Ok(Value.int(_rt_time_now_seconds().to_int()))

fn current_time_ms(args: [Value]) -> Result<Value, InterpreterError>:
    Ok(Value.int((_rt_time_now_seconds() * 1000.0).to_int()))

fn progress_init(args: [Value]) -> Result<Value, InterpreterError>:
    _rt_progress_init()
    Ok(Value.nil())

fn progress_reset(args: [Value]) -> Result<Value, InterpreterError>:
    _rt_progress_reset()
    Ok(Value.nil())

fn progress_get_elapsed_seconds(args: [Value]) -> Result<Value, InterpreterError>:
    Ok(Value.float(_rt_progress_get_elapsed_seconds()))

fn time_now_unix_micros(args: [Value]) -> Result<Value, InterpreterError>:
    Ok(Value.int(_rt_time_now_unix_micros()))

fn _get_micros_arg(args: [Value]) -> Result<i64, InterpreterError>:
    if args.len() < 1:
        return Err(InterpreterError.ArityError("requires i64 argument"))
    args[0].as_int() ?? Err(InterpreterError.TypeError("requires i64 argument"))

fn _wrap_timestamp_getter(args: [Value], getter: fn(i64) -> i32) -> Result<Value, InterpreterError>:
    Ok(Value.int(getter(_get_micros_arg(args)?).to_i64()))

fn timestamp_get_year(args: [Value]) -> Result<Value, InterpreterError>:
    _wrap_timestamp_getter(args, _rt_timestamp_get_year)

fn timestamp_get_month(args: [Value]) -> Result<Value, InterpreterError>:
    _wrap_timestamp_getter(args, _rt_timestamp_get_month)

fn timestamp_get_day(args: [Value]) -> Result<Value, InterpreterError>:
    _wrap_timestamp_getter(args, _rt_timestamp_get_day)

fn timestamp_get_hour(args: [Value]) -> Result<Value, InterpreterError>:
    _wrap_timestamp_getter(args, _rt_timestamp_get_hour)

fn timestamp_get_minute(args: [Value]) -> Result<Value, InterpreterError>:
    _wrap_timestamp_getter(args, _rt_timestamp_get_minute)

fn timestamp_get_second(args: [Value]) -> Result<Value, InterpreterError>:
    _wrap_timestamp_getter(args, _rt_timestamp_get_second)

fn timestamp_get_microsecond(args: [Value]) -> Result<Value, InterpreterError>:
    _wrap_timestamp_getter(args, _rt_timestamp_get_microsecond)

fn timestamp_from_components(args: [Value]) -> Result<Value, InterpreterError>:
    if args.len() != 7:
        return Err(InterpreterError.ArityError(
            "rt_timestamp_from_components requires 7 arguments"))
    val year = args[0].as_int() ?? return Err(InterpreterError.TypeError("year must be integer"))
    val month = args[1].as_int() ?? return Err(InterpreterError.TypeError("month must be integer"))
    val day = args[2].as_int() ?? return Err(InterpreterError.TypeError("day must be integer"))
    val hour = args[3].as_int() ?? return Err(InterpreterError.TypeError("hour must be integer"))
    val minute = args[4].as_int() ?? return Err(InterpreterError.TypeError("minute must be integer"))
    val second = args[5].as_int() ?? return Err(InterpreterError.TypeError("second must be integer"))
    val microsecond = args[6].as_int() ?? return Err(InterpreterError.TypeError("microsecond must be integer"))
    Ok(Value.int(_rt_timestamp_from_components(
        year.to_i32(), month.to_i32(), day.to_i32(),
        hour.to_i32(), minute.to_i32(), second.to_i32(), microsecond.to_i32())))

fn timestamp_add_days(args: [Value]) -> Result<Value, InterpreterError>:
    if args.len() != 2:
        return Err(InterpreterError.ArityError("rt_timestamp_add_days requires 2 arguments"))
    val micros = args[0].as_int() ?? return Err(InterpreterError.TypeError("micros must be i64"))
    val days = args[1].as_int() ?? return Err(InterpreterError.TypeError("days must be i64"))
    Ok(Value.int(_rt_timestamp_add_days(micros, days)))

fn timestamp_diff_days(args: [Value]) -> Result<Value, InterpreterError>:
    if args.len() != 2:
        return Err(InterpreterError.ArityError("rt_timestamp_diff_days requires 2 arguments"))
    val micros1 = args[0].as_int() ?? return Err(InterpreterError.TypeError("micros1 must be i64"))
    val micros2 = args[1].as_int() ?? return Err(InterpreterError.TypeError("micros2 must be i64"))
    Ok(Value.int(_rt_timestamp_diff_days(micros1, micros2)))
