# Simple (.spl) replacement for test/test_bootstrap_wrapper.sh
# Test the bin/simple wrapper script functionality

use app.io.mod.{shell, shell_output, shell_bool, cwd, file_exists, is_dir, exit}
use std.string.{contains, trim, starts_with}

fn main():
    print "==========================================="
    print "Bootstrap Wrapper Tests"
    print "==========================================="
    print ""

    # Test 1: Wrapper exists and is executable
    print "Test 1: Wrapper exists and is executable"
    if file_exists("bin/simple"):
        print "PASS bin/simple is executable"
    else:
        print "FAIL bin/simple is not executable"
        exit(1)

    # Test 2: Platform detection
    print ""
    print "Test 2: Platform detection"
    val platform_raw = shell_output("uname -s | tr '[:upper:]' '[:lower:]'")
    val platform = trim(platform_raw)
    val arch = trim(shell_output("uname -m"))
    print "  Detected: " + platform + "-" + arch

    if (platform == "linux" or
        platform == "darwin" or
        starts_with(platform, "mingw") or
        starts_with(platform, "msys") or
        starts_with(platform, "cygwin")):
        print "PASS OS detected: " + platform
    else:
        print "FAIL Unknown OS: " + platform
        exit(1)

    if (arch == "x86_64" or
        arch == "aarch64" or
        arch == "arm64" or
        arch == "riscv64"):
        print "PASS Architecture detected: " + arch
    else:
        print "FAIL Unknown architecture: " + arch
        exit(1)

    # Test 3: Bootstrap binary exists
    print ""
    print "Test 3: Bootstrap binary exists"
    val bootstrap_bin = "bin/release/linux-x86_64/simple"
    if file_exists(bootstrap_bin):
        val size = trim(shell_output("ls -lh " + bootstrap_bin + " | awk '{print $5}'"))
        print "PASS Bootstrap binary found: " + bootstrap_bin
        print "  Size: " + size
    else:
        print "WARN Bootstrap binary not found for linux-x86_64"

    # Test 4: Wrapper can execute a simple script
    print ""
    print "Test 4: Wrapper executes Simple scripts"
    shell("cat > /tmp/wrapper_test.spl << 'EOF'\nfn main():\n    print \"Wrapper test successful\"\nEOF")
    val exec_output = shell_output(bootstrap_bin + " /tmp/wrapper_test.spl 2>&1")
    if contains(exec_output, "Wrapper test successful"):
        print "PASS Wrapper executed script successfully"
    else:
        print "FAIL Wrapper failed to execute script"
        print "Output: " + exec_output
        exit(1)

    # Test 5: Test with arguments
    print ""
    print "Test 5: Wrapper passes arguments"
    shell("cat > /tmp/args_test.spl << 'EOF'\nfn main():\n    print \"Arguments test passed\"\nEOF")
    val args_output = shell_output(bootstrap_bin + " /tmp/args_test.spl 2>&1")
    if contains(args_output, "Arguments test passed"):
        print "PASS Arguments passed correctly"
    else:
        print "FAIL Arguments not passed correctly"
        exit(1)

    # Test 6: Bootstrap binary version
    print ""
    print "Test 6: Bootstrap binary version"
    val version = trim(shell_output(bootstrap_bin + " --version 2>&1 | head -1"))
    print "  Version: " + version
    if contains(version, "Simple Language"):
        print "PASS Version information available"
    else:
        print "WARN Version check produced unexpected output"

    # Test 7: Directory structure
    print ""
    print "Test 7: Directory structure"
    val platforms = [
        "linux-x86_64",
        "linux-arm64",
        "linux-riscv64",
        "macos-x86_64",
        "macos-arm64",
        "windows-x86_64",
        "windows-arm64"
    ]

    for i in 0..platforms.len():
        val plat = platforms[i]
        val plat_dir = "bin/release/" + plat
        if is_dir(plat_dir):
            val bin_path = plat_dir + "/simple"
            val exe_path = plat_dir + "/simple.exe"
            if (file_exists(bin_path) or
                file_exists(exe_path)):
                val sz = trim(shell_output("du -h " + plat_dir + "/simple* 2>/dev/null | awk '{print $1}'"))
                print "PASS " + plat + ": " + sz
            else:
                print "SKIP " + plat + ": directory exists, no binary"
        else:
            print "SKIP " + plat + ": directory not created"

    # Test 8: Documentation exists
    print ""
    print "Test 8: Documentation"
    val docs = [
        "bin/release/README.md",
        "doc/build/bootstrap_multi_platform.md",
        "PLATFORMS.md"
    ]

    for i in 0..docs.len():
        val doc = docs[i]
        if file_exists(doc):
            print "PASS " + doc + " exists"
        else:
            print "FAIL " + doc + " missing"

    # Test 9: Build script exists
    print ""
    print "Test 9: Build script"
    if file_exists("script/build-bootstrap-multi-platform.sh"):
        print "PASS Build script executable: script/build-bootstrap-multi-platform.sh"
    else:
        print "FAIL Build script not executable"

    # Test 10: GitHub Actions workflow
    print ""
    print "Test 10: CI/CD workflow"
    if file_exists(".github/workflows/bootstrap-build.yml"):
        print "PASS GitHub Actions workflow exists"
        print "  Platforms configured:"
        val count = trim(shell_output("grep 'platform:' .github/workflows/bootstrap-build.yml | grep -v '^#' | wc -l"))
        print "  Count: " + count
    else:
        print "FAIL GitHub Actions workflow missing"

    print ""
    print "==========================================="
    print "Bootstrap Wrapper Tests Complete"
    print "==========================================="

main()
