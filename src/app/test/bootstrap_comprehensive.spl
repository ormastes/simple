# Simple (.spl) replacement for test/test_bootstrap_comprehensive.sh
# Comprehensive Bootstrap System Test Report

use app.io.mod.{shell, shell_output, shell_bool, cwd, file_exists, is_dir, exit}
use std.text.{contains, trim, split}

var passed = 0
var failed = 0
var warnings = 0

fn test_pass(msg: text):
    print "PASS " + msg
    passed = passed + 1

fn test_fail(msg: text):
    print "FAIL " + msg
    failed = failed + 1

fn test_warn(msg: text):
    print "WARN " + msg
    warnings = warnings + 1

fn main():
    print "============================================================================"
    print "BOOTSTRAP SYSTEM - COMPREHENSIVE TEST REPORT"
    print "============================================================================"
    print ""
    val date_str = shell_output("date '+%Y-%m-%d %H:%M:%S'")
    val platform_str = shell_output("uname -s && uname -m")
    print "Date: " + trim(date_str)
    print "Platform: " + trim(platform_str)
    print ""

    # =========================================================================
    # 1. CORE FUNCTIONALITY TESTS
    # =========================================================================
    print "============================================================================"
    print "1. CORE FUNCTIONALITY TESTS"
    print "============================================================================"
    print ""

    val bootstrap_bin = "bin/release/linux-x86_64/simple"
    if file_exists(bootstrap_bin):
        test_pass("Bootstrap binary exists and is executable")

        val size_str = shell_output("ls -lh " + bootstrap_bin + " | awk '{print $5}'")
        print "  Size: " + trim(size_str)

        # Test execution
        shell("cat > /tmp/exec_test.spl << 'EOF'\nfn main():\n    print \"exec_ok\"\nEOF")
        val exec_out = shell_output(bootstrap_bin + " /tmp/exec_test.spl 2>&1")
        if contains(exec_out, "exec_ok"):
            test_pass("Bootstrap binary executes Simple code")
        else:
            test_fail("Bootstrap binary execution failed")
    else:
        test_fail("Bootstrap binary not found")

    # Wrapper script
    if file_exists("bin/simple"):
        test_pass("Wrapper script exists and is executable")
        val wrapper_content = shell_output("cat bin/simple")
        if contains(wrapper_content, "find_bootstrap"):
            test_pass("Wrapper has platform detection logic")
        else:
            test_warn("Wrapper missing detection logic")
    else:
        test_fail("Wrapper script not found or not executable")

    # =========================================================================
    # 2. SIMPLE LANGUAGE FEATURE TESTS
    # =========================================================================
    print ""
    print "============================================================================"
    print "2. SIMPLE LANGUAGE FEATURE TESTS"
    print "============================================================================"
    print ""

    val feature_output = shell_output(bootstrap_bin + " test/test_bootstrap.spl 2>&1")

    val feature_tests = [
        "Test 1: Basic execution works",
        "Test 2: Math operations work",
        "Test 3: String interpolation works",
        "Test 4: Functions work",
        "Test 5: Loops work",
        "Test 6: Arrays work",
        "Test 7: Classes work",
        "Test 8: Pattern matching works",
        "Test 9: Optionals work",
        "Test 10: Dictionaries work"
    ]

    val feature_names = [
        "Basic execution",
        "Math operations",
        "String interpolation",
        "Functions",
        "Loops",
        "Arrays",
        "Classes",
        "Pattern matching",
        "Optionals",
        "Dictionaries"
    ]

    for i in 0..feature_tests.len():
        if contains(feature_output, feature_tests[i]):
            test_pass(feature_names[i])

    # =========================================================================
    # 3. MULTI-PLATFORM INFRASTRUCTURE
    # =========================================================================
    print ""
    print "============================================================================"
    print "3. MULTI-PLATFORM INFRASTRUCTURE"
    print "============================================================================"
    print ""

    print "Platform Directory Structure:"

    val platforms = [
        "linux-x86_64",
        "linux-arm64",
        "linux-riscv64",
        "macos-x86_64",
        "macos-arm64",
        "windows-x86_64",
        "windows-arm64"
    ]

    val statuses = [
        "Production",
        "Ready",
        "Experimental",
        "Ready",
        "Ready",
        "Ready",
        "Experimental"
    ]

    for i in 0..platforms.len():
        val plat = platforms[i]
        val status = statuses[i]
        val plat_dir = "bin/release/" + plat
        if is_dir(plat_dir):
            val bin_path = plat_dir + "/simple"
            val exe_path = plat_dir + "/simple.exe"
            if (file_exists(bin_path) or
                file_exists(exe_path)):
                val sz = shell_output("du -h " + plat_dir + "/simple* 2>/dev/null | awk '{print $1}'")
                test_pass(plat + " [" + status + "] - Binary present (" + trim(sz) + ")")
            else:
                test_warn(plat + " [" + status + "] - Directory ready, no binary yet")
        else:
            test_fail(plat + " [" + status + "] - Directory missing")

    # =========================================================================
    # 4. BUILD SYSTEM
    # =========================================================================
    print ""
    print "============================================================================"
    print "4. BUILD SYSTEM"
    print "============================================================================"
    print ""

    if file_exists("scripts/build-bootstrap-multi-platform.sh"):
        test_pass("Multi-platform build script exists")
        if shell_bool("command -v cross"):
            test_pass("Cross-compilation tool installed")
        else:
            test_warn("Cross-compilation tool not installed (optional)")
    else:
        test_fail("Build script missing or not executable")

    if file_exists(".github/workflows/bootstrap-build.yml"):
        test_pass("GitHub Actions workflow configured")
        val plat_count = shell_output("grep 'platform:' .github/workflows/bootstrap-build.yml | grep -v '^#' | wc -l")
        print "  Configured platforms: " + trim(plat_count)
    else:
        test_fail("GitHub Actions workflow missing")

    # =========================================================================
    # 5. DOCUMENTATION
    # =========================================================================
    print ""
    print "============================================================================"
    print "5. DOCUMENTATION"
    print "============================================================================"
    print ""

    val doc_files = [
        "bin/release/README.md",
        "doc/build/bootstrap_multi_platform.md",
        "PLATFORMS.md",
        "doc/report/multi_platform_bootstrap_complete_2026-02-06.md"
    ]

    val doc_descs = [
        "Bootstrap guide",
        "Technical documentation",
        "Platform support overview",
        "Implementation report"
    ]

    for i in 0..doc_files.len():
        val f = doc_files[i]
        val d = doc_descs[i]
        if file_exists(f):
            val lines = shell_output("wc -l < " + f)
            test_pass(d + " (" + trim(lines) + " lines)")
        else:
            test_fail(d + " missing")

    # =========================================================================
    # 6. PERFORMANCE & SIZE
    # =========================================================================
    print ""
    print "============================================================================"
    print "6. PERFORMANCE & SIZE"
    print "============================================================================"
    print ""

    if file_exists(bootstrap_bin):
        val size_bytes_str = shell_output("stat -c%s " + bootstrap_bin + " 2>/dev/null || stat -f%z " + bootstrap_bin)
        val size_bytes = int(trim(size_bytes_str))
        val size_mb = size_bytes / 1024 / 1024
        if size_mb < 40:
            test_pass("Binary size: " + size_mb.to_text() + "MB (optimized)")
        else:
            test_warn("Binary size: " + size_mb.to_text() + "MB (could be optimized)")

        val start_str = shell_output("date +%s%N")
        shell(bootstrap_bin + " --version > /dev/null 2>&1")
        val end_str = shell_output("date +%s%N")
        val start_ns = int(trim(start_str))
        val end_ns = int(trim(end_str))
        val startup_ms = (end_ns - start_ns) / 1000000
        if startup_ms < 200:
            test_pass("Startup time: " + startup_ms.to_text() + "ms (fast)")
        else:
            test_warn("Startup time: " + startup_ms.to_text() + "ms (could be faster)")

    # =========================================================================
    # 7. INTEGRATION TESTS
    # =========================================================================
    print ""
    print "============================================================================"
    print "7. INTEGRATION TESTS"
    print "============================================================================"
    print ""

    if file_exists(bootstrap_bin):
        shell("cat > /tmp/build_test.spl << 'EOF'\nfn main():\n    print \"Build system test\"\nEOF")
        if shell_bool(bootstrap_bin + " /tmp/build_test.spl > /dev/null 2>&1"):
            test_pass("Bootstrap can execute build scripts")
        else:
            test_fail("Bootstrap cannot execute build scripts")

    shell("cat > /tmp/module_test.spl << 'EOF'\nfn main():\n    print \"Module test\"\nEOF")
    if shell_bool(bootstrap_bin + " /tmp/module_test.spl > /dev/null 2>&1"):
        test_pass("Module system functional")
    else:
        test_fail("Module system issues")

    # =========================================================================
    # TEST SUMMARY
    # =========================================================================
    print ""
    print "============================================================================"
    print "TEST SUMMARY"
    print "============================================================================"
    print ""

    val total = passed + failed + warnings
    print "Total Tests: " + total.to_text()
    print "Passed: " + passed.to_text()
    print "Warnings: " + warnings.to_text()
    print "Failed: " + failed.to_text()
    print ""

    if total > 0:
        val pass_rate = passed * 100 / total
        print "Pass Rate: " + pass_rate.to_text() + "%"

    if failed == 0:
        print ""
        print "============================================================================"
        print "ALL TESTS PASSED - BOOTSTRAP SYSTEM OPERATIONAL"
        print "============================================================================"
        exit(0)
    else if failed < 5:
        print ""
        print "============================================================================"
        print "MINOR ISSUES DETECTED - SYSTEM MOSTLY FUNCTIONAL"
        print "============================================================================"
        exit(1)
    else:
        print ""
        print "============================================================================"
        print "MAJOR ISSUES DETECTED - SYSTEM NEEDS ATTENTION"
        print "============================================================================"
        exit(2)

main()
