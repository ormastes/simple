# Simple (.spl) replacement for scripts/docker-build-test-runner.sh
# Build Simple Test Runner Container Image
#
# Builds a lightweight container image for isolated test execution.
# Supports both Docker and Podman.

use app.io.mod.{shell, shell_bool, shell_output, file_exists, exit, cwd}
use std.text.{trim}

fn detect_runtime() -> text:
    if shell_bool("command -v docker"):
        print "Using Docker"
        return "docker"
    if shell_bool("command -v podman"):
        print "Using Podman"
        return "podman"
    print "ERROR: Neither Docker nor Podman found. Install one of them first."
    exit(1)
    return ""

fn main():
    val project_root = cwd()
    val runtime = detect_runtime()

    # Check if runtime binary exists
    if not file_exists("bin/release/simple"):
        print "ERROR: bin/release/simple not found."
        print "Build the release binary first:"
        print "  bin/simple build --release"
        exit(1)

    # Check if Dockerfile exists
    if not file_exists("tools/docker/test-runner.Dockerfile"):
        print "ERROR: tools/docker/test-runner.Dockerfile not found."
        exit(1)

    # Build image
    print "Building container image..."
    val image_name = "simple-test-runner"
    val date_tag = trim(shell_output("date +%Y%m%d"))

    val build_cmd = "{runtime} build -f tools/docker/test-runner.Dockerfile -t {image_name}:latest -t {image_name}:{date_tag} ."
    val result = shell(build_cmd)
    if result.exit_code != 0:
        print "ERROR: Container build failed."
        print result.stderr
        exit(1)

    print ""
    print "Successfully built container image:"
    print "  {image_name}:latest"
    print "  {image_name}:{date_tag}"
    print ""

    # Show image info
    val images_result = shell("{runtime} images {image_name}")
    print images_result.stdout

    print ""
    print "Test the image with:"
    print "  {runtime} run --rm {image_name}:latest test test/unit/std/string_spec.spl"
    print ""
    print "Or use the test runner with container mode:"
    print "  bin/simple test --container"
    print "  bin/simple test --mode=container"

main()
