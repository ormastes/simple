# Simple (.spl) replacement for script/test-macos-self-hosting.sh
#
# Test Simple Self-Hosting on macOS
# Verifies: bootstrap -> check -> build native hello -> verify execution

use app.io.mod.{shell, shell_bool, shell_output, file_exists, file_write, exit}
use std.string.{contains, trim}

fn main():
    print "======================================"
    print "Simple macOS Self-Hosting Test"
    print "======================================"
    print ""

    # Detect platform
    val os_name = trim(shell_output("uname -s"))
    val arch = trim(shell_output("uname -m"))
    print "Platform: {os_name} {arch}"

    if os_name != "Darwin":
        print "Warning: This script is designed for macOS (Darwin)"
        print "   Current OS: {os_name}"

    print ""

    # Step 1: Verify bootstrap binary exists
    print "Step 1: Verify Bootstrap Binary"
    print "--------------------------------------"

    if file_exists("bin/release/simple") == false:
        print "FAIL Bootstrap binary not found at bin/release/simple"
        exit(1)

    val bootstrap_size = trim(shell_output("ls -lh bin/release/simple | awk '{print $5}'"))
    print "PASS Bootstrap binary found: {bootstrap_size}"

    # Test bootstrap execution
    shell("bin/release/simple --version")
    print ""

    # Step 2: Test bootstrap can run Simple code
    print "Step 2: Test Bootstrap Execution"
    print "--------------------------------------"

    val test_code = "fn main():\n    print \"PASS Bootstrap interpreter working!\""
    file_write("/tmp/test_bootstrap.spl", test_code)

    shell("bin/release/simple /tmp/test_bootstrap.spl")
    shell("rm -f /tmp/test_bootstrap.spl")
    print ""

    # Step 3: Test build system is accessible
    print "Step 3: Test Build System"
    print "--------------------------------------"

    if file_exists("src/app/build/main.spl") == false:
        print "FAIL Build system not found at src/app/build/main.spl"
        exit(1)

    print "Build system source: PASS Found"
    print ""

    # Check build system help
    print "Build system commands:"
    val build_help = shell_output("bin/simple build --help 2>&1 | head -10")
    print build_help
    print ""

    # Step 4: Create hello world test program
    print "Step 4: Create Hello World Test"
    print "--------------------------------------"

    var hello_code = "#!/usr/bin/env simple\n"
    hello_code = hello_code + "fn main():\n"
    hello_code = hello_code + "    print \"=========================================\"\n"
    hello_code = hello_code + "    print \"Hello from Simple on macOS!\"\n"
    hello_code = hello_code + "    print \"=========================================\"\n"
    hello_code = hello_code + "    print \"\"\n"
    hello_code = hello_code + "    print \"Platform verification:\"\n"
    hello_code = hello_code + "    print \"  PASS Bootstrap: Working\"\n"
    hello_code = hello_code + "    print \"  PASS Interpreter: Working\"\n"
    hello_code = hello_code + "    print \"  PASS Native compilation: Testing...\"\n"
    hello_code = hello_code + "    print \"\"\n"

    file_write("hello_macos_test.spl", hello_code)
    shell("chmod +x hello_macos_test.spl")

    print "PASS Test program created: hello_macos_test.spl"
    print ""

    # Step 5: Test interpreter mode
    print "Step 5: Test Interpreter Mode"
    print "--------------------------------------"

    shell("bin/simple hello_macos_test.spl")
    print ""

    # Step 6: Test native compilation (clang route)
    print "Step 6: Test Native Compilation (clang)"
    print "--------------------------------------"

    val has_clang = shell_bool("command -v clang >/dev/null 2>&1")
    if has_clang == false:
        print "Warning: clang not found"
        print "   Install Xcode Command Line Tools:"
        print "   xcode-select --install"
        exit(1)

    val clang_ver = trim(shell_output("clang --version 2>&1 | head -1"))
    print "Compiler: {clang_ver}"
    print ""

    print "Compiling with --native flag..."
    shell("bin/simple compile --native -o hello_native hello_macos_test.spl")

    if file_exists("hello_native") == false:
        print "FAIL Native compilation failed - binary not created"
        exit(1)

    val native_size = trim(shell_output("ls -lh hello_native | awk '{print $5}'"))
    print "PASS Native binary created: {native_size}"

    # Verify it's a macOS binary
    val file_info = trim(shell_output("file hello_native"))
    print file_info
    print ""

    # Step 7: Run native binary
    print "Step 7: Test Native Binary Execution"
    print "--------------------------------------"

    shell("chmod +x hello_native")
    shell("./hello_native")
    print ""

    # Step 8: Test LLVM compilation route (if available)
    print "Step 8: Test LLVM Compilation (optional)"
    print "--------------------------------------"

    val has_llc = shell_bool("command -v llc >/dev/null 2>&1")
    var llvm_built = false
    if has_llc:
        print "LLVM tools available, testing LLVM route..."
        shell("bin/release/simple src/app/compile/llvm_direct.spl hello_macos_test.spl hello_llvm -O2")

        if file_exists("hello_llvm"):
            val llvm_size = trim(shell_output("ls -lh hello_llvm | awk '{print $5}'"))
            print "PASS LLVM binary created: {llvm_size}"

            shell("chmod +x hello_llvm")
            shell("./hello_llvm")
            llvm_built = true
        else:
            print "Warning: LLVM compilation failed"
    else:
        print "Warning: LLVM tools not available (optional)"
        print "   Install with: brew install llvm"

    print ""

    # Step 9: Test self-hosting build capability
    print "Step 9: Test Self-Hosting Build (dry-run)"
    print "--------------------------------------"

    print "Self-hosting build command:"
    print "  SIMPLE_BOOTSTRAP=bin/release/simple script/build-bootstrap.sh"
    print ""
    print "This would:"
    print "  1. Use existing bootstrap binary"
    print "  2. Run: bin/release/simple src/app/build/main.spl --bootstrap"
    print "  3. Build new runtime with optimization"
    print "  4. Package as: simple-bootstrap-{version}-darwin-{arch}.spk"
    print ""
    print "PASS Self-hosting capability verified (not executed to save time)"
    print ""

    # Step 10: Cleanup
    print "Step 10: Cleanup"
    print "--------------------------------------"

    shell("rm -f hello_macos_test.spl hello_native hello_llvm")
    print "PASS Test files cleaned up"
    print ""

    # Summary
    print "======================================"
    print "PASS macOS Self-Hosting Test: PASSED"
    print "======================================"
    print ""
    print "Summary:"
    print "  PASS Bootstrap binary: Working ({bootstrap_size})"
    print "  PASS Interpreter mode: Working"
    print "  PASS Native compilation: Working (clang)"
    if llvm_built:
        print "  PASS LLVM compilation: Working"
    else:
        print "  SKIP LLVM compilation: Not tested"
    print "  PASS Native execution: Working"
    print "  PASS Self-hosting: Ready"
    print ""
    print "Platform: macOS {arch}"
    val simple_ver = trim(shell_output("bin/simple --version 2>&1 | head -1"))
    print "Simple: {simple_ver}"
    print ""
    print "Next steps:"
    print "  - Run full test suite: bin/simple test"
    print "  - Build release: bin/simple build --release"
    print "  - Create bootstrap package: script/build-bootstrap.sh"
    print ""

main()
