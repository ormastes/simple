# SDoctest Result Database
#
# Writes sdoctest results to doc/test/sdoctest_db.sdn in SDN table format.

use app.io.mod (file_atomic_write, time_now_unix_micros, getpid, hostname)
use sdoctest.types.*

# =========================================================================
# Public API
# =========================================================================

fn write_sdoctest_db(result: SdoctestRunResult, db_path: text):
    var content = "# SDoctest Results Database\n"
    content = content + "# Auto-generated by sdoctest runner\n\n"

    # Run summary table
    val timestamp = time_now_unix_micros()
    val pid = getpid()
    val host = hostname()

    content = content + "sdoctest_runs |run_id, timestamp, pid, hostname, total, passed, failed, skipped, errors, duration_ms|\n"
    content = content + "    {timestamp}, {timestamp}, {pid}, {host}, {result.total}, {result.passed}, {result.failed}, {result.skipped}, {result.errors}, {result.duration_ms}\n"
    content = content + "\n"

    # Block results table
    content = content + "sdoctest_blocks |source_file, line, status, duration_ms, error|\n"
    for file_result in result.files:
        for br in file_result.blocks:
            val status_str = block_status_to_str(br.status)
            val escaped_error = br.error.replace("\"", "'").replace("\n", " ")
            val error_field = if escaped_error != "": "\"{escaped_error}\"" else: "\"\""
            content = content + "    \"{br.block.source_file}\", {br.block.line_number}, {status_str}, {br.duration_ms}, {error_field}\n"

    file_atomic_write(db_path, content)

# =========================================================================
# Helpers
# =========================================================================

fn block_status_to_str(status: BlockStatus) -> text:
    match status:
        case BlockStatus.Passed: "passed"
        case BlockStatus.Failed: "failed"
        case BlockStatus.Skipped: "skipped"
        case BlockStatus.Error: "error"

# =========================================================================
# Exports
# =========================================================================

export write_sdoctest_db, block_status_to_str
