# SDoctest Result Database
#
# Writes sdoctest results to doc/test/sdoctest_db.sdn in SDN table format.

use app.io.mod (file_atomic_write, time_now_unix_micros, getpid, hostname)
use sdoctest.types.*
use std.text.{NL}

# =========================================================================
# Public API
# =========================================================================

fn write_sdoctest_db(result: SdoctestRunResult, db_path: text):
    var content = "# SDoctest Results Database{NL}"
    content = content + "# Auto-generated by sdoctest runner{NL}{NL}"

    # Run summary table
    val timestamp = time_now_unix_micros()
    val pid = getpid()
    val host = hostname()

    content = content + "sdoctest_runs |run_id, timestamp, pid, hostname, total, passed, failed, skipped, errors, accepted, duration_ms|{NL}"
    content = content + "    {timestamp}, {timestamp}, {pid}, {host}, {result.total}, {result.passed}, {result.failed}, {result.skipped}, {result.errors}, {result.accepted}, {result.duration_ms}{NL}"
    content = content + NL

    # Block results table
    content = content + "sdoctest_blocks |source_file, line, status, duration_ms, error|{NL}"
    for file_result in result.files:
        for br in file_result.blocks:
            val status_str = block_status_to_str(br.status)
            var escaped_error = br.error.replace("\"", "'")
            escaped_error = escaped_error.replace(NL, " ")
            val error_field = if escaped_error != "": "\"{escaped_error}\"" else: "\"\""
            content = content + "    \"{br.block.source_file}\", {br.block.line_number}, {status_str}, {br.duration_ms}, {error_field}{NL}"

    file_atomic_write(db_path, content)

# =========================================================================
# Helpers
# =========================================================================

fn block_status_to_str(status: BlockStatus) -> text:
    match status:
        case BlockStatus.Passed: "passed"
        case BlockStatus.Failed: "failed"
        case BlockStatus.Skipped: "skipped"
        case BlockStatus.Error: "error"

# =========================================================================
# Exports
# =========================================================================

export write_sdoctest_db, block_status_to_str
