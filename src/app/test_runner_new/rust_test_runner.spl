# Rust Test Runner
#
# Invokes `cargo test` for Rust workspace tests and parses output.

extern fn rt_process_run_timeout(cmd: text, args: List<text>, timeout_ms: i64) -> (text, text, i32)

# =========================================================================
# Rust Test Results
# =========================================================================

struct RustTestResult:
    total: i64
    passed: i64
    failed: i64
    ignored: i64
    duration_ms: i64
    output: text
    success: bool

# =========================================================================
# Run Rust Tests
# =========================================================================

fn run_rust_tests(timeout_ms: i64) -> RustTestResult:
    run_cargo_test([], timeout_ms)

fn run_rust_tests_crate(crate_name: text, timeout_ms: i64) -> RustTestResult:
    run_cargo_test(["-p", crate_name], timeout_ms)

fn run_rust_doc_tests(timeout_ms: i64) -> RustTestResult:
    run_cargo_test(["--doc"], timeout_ms)

fn run_rust_doc_tests_crate(crate_name: text, timeout_ms: i64) -> RustTestResult:
    run_cargo_test(["--doc", "-p", crate_name], timeout_ms)

fn run_cargo_test(extra_args: List<text>, timeout_ms: i64) -> RustTestResult:
    var args: List<text> = ["test", "--manifest-path", "rust/Cargo.toml"]
    args.merge(extra_args)

    val result = rt_process_run_timeout("cargo", args, timeout_ms)
    val stdout = result.0
    val stderr = result.1
    val exit_code = result.2

    if exit_code == -1:
        return RustTestResult(
            total: 0, passed: 0, failed: 0, ignored: 0,
            duration_ms: timeout_ms, output: "Timed out",
            success: false
        )

    val combined = stdout + "\n" + stderr
    val counts = parse_cargo_test_output(combined)

    RustTestResult(
        total: counts.0,
        passed: counts.1,
        failed: counts.2,
        ignored: counts.3,
        duration_ms: 0,
        output: combined,
        success: exit_code == 0
    )

# =========================================================================
# H12: List ignored Rust tests
# =========================================================================

fn list_ignored_rust_tests(timeout_ms: i64) -> List<text>:
    var args: List<text> = ["test", "--manifest-path", "rust/Cargo.toml", "--", "--ignored", "--list"]
    val result = rt_process_run_timeout("cargo", args, timeout_ms)
    val stdout = result.0
    val exit_code = result.2

    if exit_code != 0:
        return []

    var tests: List<text> = []
    val lines = stdout.split("\n")
    for line in lines:
        val trimmed = line.trim()
        # cargo test --list outputs "test_name: test" format
        if trimmed.ends_with(": test"):
            tests.push(trimmed[:trimmed.len() - 6])
    tests

# =========================================================================
# Parse cargo test output
# =========================================================================

fn parse_cargo_test_output(output: text) -> (i64, i64, i64, i64):
    # Look for: "test result: ok. N passed; M failed; K ignored;"
    var total = 0
    var passed = 0
    var failed = 0
    var ignored = 0

    val lines = output.split("\n")
    for line in lines:
        val trimmed = line.trim()
        if trimmed.starts_with("test result:"):
            # Parse "N passed"
            val passed_count = extract_count(trimmed, "passed")
            val failed_count = extract_count(trimmed, "failed")
            val ignored_count = extract_count(trimmed, "ignored")
            passed = passed + passed_count
            failed = failed + failed_count
            ignored = ignored + ignored_count
            total = total + passed_count + failed_count + ignored_count

    (total, passed, failed, ignored)

fn extract_count(line: text, keyword: text) -> i64:
    # Find "N keyword" pattern in cargo test output
    val parts = line.split(";")
    for part in parts:
        val trimmed = part.trim()
        if trimmed.contains(keyword):
            # Extract number before keyword
            val words = trimmed.split(" ")
            for w in words:
                val num = w.trim().to_int_or(-1)
                if num >= 0:
                    return num
    0

export RustTestResult
export run_rust_tests, run_rust_tests_crate
export run_rust_doc_tests, run_rust_doc_tests_crate
export list_ignored_rust_tests
export parse_cargo_test_output
