# Test Configuration
#
# Load test runner configuration from config/simple.test.sdn.
# Provides thresholds for CPU, memory, timeouts, and test behavior.

use app.io.mod (file_exists, file_read, env_get)

# =========================================================================
# Config Paths
# =========================================================================

val CONFIG_FILENAME = "config/simple.test.sdn"

# =========================================================================
# Test Config
# =========================================================================

struct TestConfig:
    timeout_seconds: i64
    memory_limit_mb: i64
    cpu_limit_seconds: i64
    max_fds: i64
    max_procs: i64
    parallel: bool
    fail_fast: bool
    slow_threshold_ms: i64
    cpu_threshold: f64
    memory_threshold: f64
    throttle_enabled: bool
    run_spec_tests: bool
    run_sdoctests: bool
    run_slow_tests: bool
    run_spl_doctests: bool
    ci_mode: bool

fn TestConfig__defaults() -> TestConfig:
    TestConfig(
        timeout_seconds: 60,
        memory_limit_mb: 512,
        cpu_limit_seconds: 30,
        max_fds: 256,
        max_procs: 64,
        parallel: false,
        fail_fast: false,
        slow_threshold_ms: 5000,
        cpu_threshold: 80.0,
        memory_threshold: 80.0,
        throttle_enabled: false,
        run_spec_tests: true,
        run_sdoctests: true,
        run_slow_tests: false,
        run_spl_doctests: false,
        ci_mode: false
    )

fn TestConfig__load() -> TestConfig:
    val config = TestConfig__defaults()
    val config_path = find_config_file()
    if config_path == "":
        return config

    val content = file_read(config_path) ?? ""
    if content == "":
        return config
    val lines = content.split("\n")

    for line in lines:
        val trimmed = line.trim()
        if trimmed == "" or trimmed.starts_with("#"):
            continue

        # Parse "key: value" or "key = value"
        val sep_idx = trimmed.index_of(":") ?? -1
        if sep_idx < 0:
            continue
        val key = trimmed[0:sep_idx].trim()
        var value = trimmed[sep_idx + 1:].trim()

        # Strip inline comments (e.g., "80  # comment")
        val comment_idx = value.index_of("#") ?? -1
        if comment_idx >= 0:
            value = value[0:comment_idx].trim()

        match key:
            case "timeout_seconds":
                config.timeout_seconds = value.to_int_or(config.timeout_seconds)
            case "memory_limit_mb":
                config.memory_limit_mb = value.to_int_or(config.memory_limit_mb)
            case "cpu_limit_seconds":
                config.cpu_limit_seconds = value.to_int_or(config.cpu_limit_seconds)
            case "max_fds":
                config.max_fds = value.to_int_or(config.max_fds)
            case "max_procs":
                config.max_procs = value.to_int_or(config.max_procs)
            case "parallel":
                config.parallel = value == "true"
            case "fail_fast":
                config.fail_fast = value == "true"
            case "slow_threshold_ms":
                config.slow_threshold_ms = value.to_int_or(config.slow_threshold_ms)
            case "cpu_threshold":
                config.cpu_threshold = 80.0
            case "memory_threshold":
                config.memory_threshold = 80.0
            case "throttle_enabled":
                config.throttle_enabled = value == "true"
            case "run_spec_tests":
                config.run_spec_tests = value == "true"
            case "run_sdoctests":
                config.run_sdoctests = value == "true"
            case "run_slow_tests":
                config.run_slow_tests = value == "true"
            case "run_spl_doctests":
                config.run_spl_doctests = value == "true"
            case _: ()

    # Apply CI mode overrides from environment
    val ci_env = env_get("CI")
    if ci_env == "true" or ci_env == "1":
        config.ci_mode = true
        config.run_slow_tests = true
        config.fail_fast = false

    config

# =========================================================================
# H1: Multi-level config file search
# =========================================================================

fn find_config_file() -> text:
    # Search current, parent, grandparent directories
    val candidates = [
        CONFIG_FILENAME,
        "../{CONFIG_FILENAME}",
        "../../{CONFIG_FILENAME}"
    ]
    for candidate in candidates:
        if file_exists(candidate):
            return candidate
    ""

export TestConfig, TestConfig__defaults, TestConfig__load, CONFIG_FILENAME, find_config_file
