# Test Configuration
#
# Load test runner configuration from simple.test.sdn.
# Provides thresholds for CPU, memory, timeouts, and test behavior.

extern fn rt_file_exists(path: text) -> bool
extern fn rt_file_read_text(path: text) -> text

# =========================================================================
# Config Paths
# =========================================================================

val CONFIG_PATH = "simple.test.sdn"

# =========================================================================
# Test Config
# =========================================================================

struct TestConfig:
    timeout_seconds: i64
    memory_limit_mb: i64
    cpu_limit_seconds: i64
    max_fds: i64
    max_procs: i64
    parallel: bool
    fail_fast: bool
    slow_threshold_ms: i64

impl TestConfig:
    static fn defaults() -> TestConfig:
        TestConfig(
            timeout_seconds: 60,
            memory_limit_mb: 512,
            cpu_limit_seconds: 30,
            max_fds: 256,
            max_procs: 64,
            parallel: false,
            fail_fast: false,
            slow_threshold_ms: 5000
        )

    static fn load() -> TestConfig:
        val config = TestConfig.defaults()
        if not rt_file_exists(CONFIG_PATH):
            return config

        val content = rt_file_read_text(CONFIG_PATH)
        val lines = content.split("\n")

        for line in lines:
            val trimmed = line.trim()
            if trimmed == "" or trimmed.starts_with("#"):
                continue

            # Parse "key: value" or "key = value"
            val sep_idx = trimmed.index_of(":") ?? -1
            if sep_idx < 0:
                continue
            val key = trimmed[:sep_idx].trim()
            val value = trimmed[sep_idx + 1:].trim()

            match key:
                case "timeout_seconds":
                    config.timeout_seconds = value.to_int_or(config.timeout_seconds)
                case "memory_limit_mb":
                    config.memory_limit_mb = value.to_int_or(config.memory_limit_mb)
                case "cpu_limit_seconds":
                    config.cpu_limit_seconds = value.to_int_or(config.cpu_limit_seconds)
                case "max_fds":
                    config.max_fds = value.to_int_or(config.max_fds)
                case "max_procs":
                    config.max_procs = value.to_int_or(config.max_procs)
                case "parallel":
                    config.parallel = value == "true"
                case "fail_fast":
                    config.fail_fast = value == "true"
                case "slow_threshold_ms":
                    config.slow_threshold_ms = value.to_int_or(config.slow_threshold_ms)
                case _: ()

        config

export TestConfig, CONFIG_PATH
