# Test Runner Argument Parsing
#
# Parses command-line arguments and creates TestOptions.

use test_runner_types.*

# =========================================================================
# Mode String Parsing
# =========================================================================

fn parse_mode_str(m: text) -> TestExecutionMode:
    if m == "native" or m == "binary":
        return TestExecutionMode.Native
    if m == "smf" or m == "loader":
        return TestExecutionMode.Smf
    TestExecutionMode.Interpreter

# =========================================================================
# Argument Parsing
# =========================================================================

fn parse_test_args(args: [text]) -> TestOptions:
    var path = ""
    var level = TestLevel.All
    var tag = ""
    var fail_fast = false
    var mode = TestExecutionMode.Interpreter
    var timeout = 120
    var list = false
    var list_ignored = false
    var only_slow = false
    var only_skipped = false
    var show_tags = false
    var gc_log = false
    var gc_off = false
    var seed = 0
    var has_seed = false
    var safe_mode = false
    var force_rebuild = false
    var keep_artifacts = false
    var run_all = false
    var format = OutputFormat.Default
    var list_skip_features = false
    var planned_only = false
    var no_limits = false
    var sdoctest = false
    var sdoctest_env = ""
    var sdoctest_force = false
    var no_db = false
    var verbose = false

    var i = 0
    while i < args.len():
        val arg = args[i]
        if arg == "--unit":
            level = TestLevel.Unit
        elif arg == "--integration":
            level = TestLevel.Integration
        elif arg == "--system":
            level = TestLevel.System
        elif arg == "--fail-fast":
            fail_fast = true
        elif arg == "--list":
            list = true
        elif arg == "--list-ignored":
            list = true
            list_ignored = true
        elif arg == "--only-slow":
            only_slow = true
        elif arg == "--only-skipped":
            only_skipped = true
        elif arg == "--show-tags":
            show_tags = true
        elif arg == "--gc-log":
            gc_log = true
        elif arg == "--gc=off" or arg == "--gc=OFF":
            gc_off = true
        elif arg == "--safe-mode" or arg == "--safe":
            safe_mode = true
        elif arg == "--force-rebuild":
            force_rebuild = true
        elif arg == "--keep-artifacts":
            keep_artifacts = true
        elif arg == "--all":
            run_all = true
        elif arg == "--list-skip-features" or arg == "--skip-features":
            list_skip_features = true
            only_skipped = true
            list = true
        elif arg == "--planned-only" or arg == "--pending":
            planned_only = true
        elif arg == "--no-limits":
            no_limits = true
        elif arg == "--no-db":
            no_db = true
        elif arg == "--verbose" or arg == "-v":
            verbose = true
        elif arg == "--quick" or arg == "-q":
            no_db = true
        elif arg == "--sdoctest":
            sdoctest = true
        elif arg == "--sdoctest-force":
            sdoctest_force = true
        elif arg.starts_with("--sdoctest-env="):
            sdoctest_env = arg[15:]
        elif arg == "--sdoctest-env":
            i = i + 1
            if i < args.len():
                sdoctest_env = args[i]
        elif arg == "--tag":
            i = i + 1
            if i < args.len():
                tag = args[i]
        elif arg == "--doc":
            format = OutputFormat.Doc
        elif arg == "--format":
            i = i + 1
            if i < args.len():
                if args[i] == "doc":
                    format = OutputFormat.Doc
        elif arg == "--mode":
            i = i + 1
            if i < args.len():
                mode = parse_mode_str(args[i])
        elif arg.starts_with("--mode="):
            val m = arg.replace("--mode=", "")
            mode = parse_mode_str(m)
        elif arg == "--timeout":
            i = i + 1
            if i < args.len():
                timeout = to_int(args[i])
        elif arg == "--seed":
            i = i + 1
            if i < args.len():
                seed = to_int(args[i])
                has_seed = true
        elif not arg.starts_with("-") and path == "":
            path = arg
        i = i + 1

    if path == "":
        path = "test/"

    TestOptions(
        path: path,
        level: level,
        tag: tag,
        fail_fast: fail_fast,
        mode: mode,
        timeout: timeout,
        list: list,
        list_ignored: list_ignored,
        only_slow: only_slow,
        only_skipped: only_skipped,
        show_tags: show_tags,
        gc_log: gc_log,
        gc_off: gc_off,
        seed: seed,
        has_seed: has_seed,
        safe_mode: safe_mode,
        force_rebuild: force_rebuild,
        keep_artifacts: keep_artifacts,
        run_all: run_all,
        format: format,
        list_skip_features: list_skip_features,
        planned_only: planned_only,
        no_limits: no_limits,
        sdoctest: sdoctest,
        sdoctest_env: sdoctest_env,
        sdoctest_force: sdoctest_force,
        no_db: no_db,
        verbose: verbose
    )

# =========================================================================
# Exports
# =========================================================================

export parse_mode_str
export parse_test_args
