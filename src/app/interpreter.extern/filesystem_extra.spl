# Filesystem Extra Extern Functions
#
# Additional FFI wrappers for filesystem operations needed by CLI apps.
# Port of primitives from rust/compiler/src/interpreter_extern/
#
# These extend the base file I/O with directory listing, mtime, and sleep.

from ..core import {Value, InterpreterError}

export fs_dir_list, fs_file_mtime, fs_sleep_ms, fs_dir_remove

# FFI declarations for new primitives

@extern("rt_dir_list")
fn _dir_list(path: text) -> [text]

@extern("rt_file_modified_time")
fn _file_mtime(path: text) -> i64

@extern("rt_sleep_ms")
fn _sleep_ms(ms: i64)

@extern("rt_package_remove_dir_all")
fn _dir_remove(path: text) -> i32

fn _get_text_arg(args: [Value], idx: i64, name: text) -> Result<text, InterpreterError>:
    if idx >= args.len():
        return Err(InterpreterError.ArityError("expected more arguments"))
    args[idx].as_string() ?? Err(InterpreterError.TypeError("expected text, got {args[idx].type_name()}"))

fn fs_dir_list(args: [Value]) -> Result<Value, InterpreterError>:
    if args.len() != 1:
        return Err(InterpreterError.ArityError("rt_dir_list expects 1 argument"))
    val path = _get_text_arg(args, 0, "path")?
    val entries = _dir_list(path)
    Ok(Value.list(entries.map(\e: Value.string(e))))

fn fs_file_mtime(args: [Value]) -> Result<Value, InterpreterError>:
    if args.len() != 1:
        return Err(InterpreterError.ArityError("rt_file_modified_time expects 1 argument"))
    val path = _get_text_arg(args, 0, "path")?
    Ok(Value.int(_file_mtime(path)))

fn fs_sleep_ms(args: [Value]) -> Result<Value, InterpreterError>:
    if args.len() != 1:
        return Err(InterpreterError.ArityError("rt_sleep_ms expects 1 argument"))
    val ms = args[0].as_int() ?? return Err(InterpreterError.TypeError("ms must be integer"))
    _sleep_ms(ms)
    Ok(Value.unit())

fn fs_dir_remove(args: [Value]) -> Result<Value, InterpreterError>:
    if args.len() != 1:
        return Err(InterpreterError.ArityError("rt_package_remove_dir_all expects 1 argument"))
    val path = _get_text_arg(args, 0, "path")?
    Ok(Value.int(_dir_remove(path).to_i64()))
