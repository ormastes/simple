# Release Package Generator
#
# Creates a distributable release package for Simple language.
#
# Usage:
#   simple src/app/release/package.spl [--version=X.Y.Z]

extern fn rt_env_cwd() -> text
extern fn rt_env_get(name: text) -> text
extern fn rt_file_exists(path: text) -> bool
extern fn rt_file_read_text(path: text) -> text
extern fn rt_file_write_text(path: text, content: text) -> bool
extern fn rt_file_copy(src: text, dst: text) -> bool
extern fn rt_dir_create(path: text, recursive: bool) -> bool
extern fn rt_dir_walk(path: text) -> [text]

fn main():
    # TODO: Replace direct FFI call with wrapper (env_cwd) from app.io or compiler.ffi
    val root = rt_env_cwd()
    val version = "0.1.0"
    val release_dir = root + "/build/release"
    val pkg_name = "simple-" + version
    val pkg_dir = release_dir + "/" + pkg_name

    print "Simple Release Packager"
    print "======================="
    print "Version: " + version
    print ""

    # Create release structure
    print "Creating release structure..."
    # TODO: Replace direct FFI call with wrapper (dir_create) from app.io or compiler.ffi
    rt_dir_create(release_dir, true)
    # TODO: Replace direct FFI call with wrapper (dir_create) from app.io or compiler.ffi
    rt_dir_create(pkg_dir, true)
    # TODO: Replace direct FFI call with wrapper (dir_create) from app.io or compiler.ffi
    rt_dir_create(pkg_dir + "/bin", true)
    # TODO: Replace direct FFI call with wrapper (dir_create) from app.io or compiler.ffi
    rt_dir_create(pkg_dir + "/lib", true)
    # TODO: Replace direct FFI call with wrapper (dir_create) from app.io or compiler.ffi
    rt_dir_create(pkg_dir + "/src", true)
    # TODO: Replace direct FFI call with wrapper (dir_create) from app.io or compiler.ffi
    rt_dir_create(pkg_dir + "/src/std", true)
    # TODO: Replace direct FFI call with wrapper (dir_create) from app.io or compiler.ffi
    rt_dir_create(pkg_dir + "/src/app", true)

    # Copy runtime binary
    print "Copying runtime..."
    val runtime_src = root + "/bin/bootstrap/simple_runtime"
    val runtime_dst = pkg_dir + "/bin/simple_runtime"
    # TODO: Replace direct FFI call with wrapper (file_exists) from app.io or compiler.ffi
    if rt_file_exists(runtime_src):
        # TODO: Replace direct FFI call with wrapper (file_copy) from app.io or compiler.ffi
        rt_file_copy(runtime_src, runtime_dst)
        print "  Copied bootstrap runtime (17 MB)"
    else:
        # Fall back to main runtime
        val main_runtime = root + "/bin/simple_runtime"
        # TODO: Replace direct FFI call with wrapper (file_exists) from app.io or compiler.ffi
        if rt_file_exists(main_runtime):
            # TODO: Replace direct FFI call with wrapper (file_copy) from app.io or compiler.ffi
            rt_file_copy(main_runtime, runtime_dst)
            print "  Copied main runtime"
        else:
            print "  ERROR: No runtime found"
            return

    # Copy FFI library
    print "Copying FFI library..."
    val ffi_lib = root + "/build/package/lib/libsimple_ffi_wrapper.so"
    # TODO: Replace direct FFI call with wrapper (file_exists) from app.io or compiler.ffi
    if rt_file_exists(ffi_lib):
        # TODO: Replace direct FFI call with wrapper (file_copy) from app.io or compiler.ffi
        rt_file_copy(ffi_lib, pkg_dir + "/lib/libsimple_ffi_wrapper.so")
        print "  Copied FFI wrapper library"

    # Copy C header
    val ffi_header = root + "/build/package/include/simple_ffi.h"
    # TODO: Replace direct FFI call with wrapper (file_exists) from app.io or compiler.ffi
    if rt_file_exists(ffi_header):
        # TODO: Replace direct FFI call with wrapper (dir_create) from app.io or compiler.ffi
        rt_dir_create(pkg_dir + "/include", true)
        # TODO: Replace direct FFI call with wrapper (file_copy) from app.io or compiler.ffi
        rt_file_copy(ffi_header, pkg_dir + "/include/simple_ffi.h")
        print "  Copied FFI header"

    print ""
    print "Package created: " + pkg_dir
    print ""
    print "To create tarball:"
    print "  cd " + release_dir
    print "  tar -czvf " + pkg_name + "-linux-x86_64.tar.gz " + pkg_name + "/"
EOF
