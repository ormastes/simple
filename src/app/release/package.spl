# Release Package Generator
#
# Creates a distributable release package for Simple language.
#
# Usage:
#   simple src/app/release/package.spl [--version=X.Y.Z]

use app.io.{cwd, file_exists, file_copy, dir_create_all}

fn main():
    val root = cwd()
    val version = "0.1.0"
    val release_dir = root + "/build/release"
    val pkg_name = "simple-" + version
    val pkg_dir = release_dir + "/" + pkg_name

    print "Simple Release Packager"
    print "======================="
    print "Version: " + version
    print ""

    # Create release structure
    print "Creating release structure..."
    dir_create_all(release_dir)
    dir_create_all(pkg_dir)
    dir_create_all(pkg_dir + "/bin")
    dir_create_all(pkg_dir + "/lib")
    dir_create_all(pkg_dir + "/src")
    dir_create_all(pkg_dir + "/src/std")
    dir_create_all(pkg_dir + "/src/app")

    # Copy runtime binary
    print "Copying runtime..."
    val runtime_src = root + "/bin/bootstrap/simple_runtime"
    val runtime_dst = pkg_dir + "/bin/simple_runtime"
    if file_exists(runtime_src):
        file_copy(runtime_src, runtime_dst)
        print "  Copied bootstrap runtime (17 MB)"
    else:
        # Fall back to main runtime
        val main_runtime = root + "/bin/simple_runtime"
        if file_exists(main_runtime):
            file_copy(main_runtime, runtime_dst)
            print "  Copied main runtime"
        else:
            print "  ERROR: No runtime found"
            return

    # Copy FFI library
    print "Copying FFI library..."
    val ffi_lib = root + "/build/package/lib/libsimple_ffi_wrapper.so"
    if file_exists(ffi_lib):
        file_copy(ffi_lib, pkg_dir + "/lib/libsimple_ffi_wrapper.so")
        print "  Copied FFI wrapper library"

    # Copy C header
    val ffi_header = root + "/build/package/include/simple_ffi.h"
    if file_exists(ffi_header):
        dir_create_all(pkg_dir + "/include")
        file_copy(ffi_header, pkg_dir + "/include/simple_ffi.h")
        print "  Copied FFI header"

    print ""
    print "Package created: " + pkg_dir
    print ""
    print "To create tarball:"
    print "  cd " + release_dir
    print "  tar -czvf " + pkg_name + "-linux-x86_64.tar.gz " + pkg_name + "/"
EOF
