#!simple
# Simple Language Installer
#
# Installs Simple language to system or user directory.
#
# Usage:
#   ./install.ssh [--prefix=/usr/local]
#   simple install.ssh [--prefix=/usr/local]

use std.string.{NL}

extern fn rt_env_cwd() -> text
extern fn rt_file_exists(path: text) -> bool
extern fn rt_file_read_text(path: text) -> text
extern fn rt_file_write_text(path: text, content: text) -> bool
extern fn rt_file_copy(src: text, dst: text) -> bool
extern fn rt_dir_create(path: text, recursive: bool) -> bool
extern fn rt_dir_walk(path: text) -> [text]
extern fn rt_process_run(cmd: text, args: [text]) -> text
extern fn rt_cli_get_args() -> [text]

fn parse_prefix_arg() -> text:
    val args = rt_cli_get_args()
    for arg in args:
        if arg.starts_with("--prefix="):
            return arg[9:]
        if arg == "--prefix" or arg == "-p":
            # Next arg should be the path - find it
            var found_flag = false
            for a in args:
                if found_flag:
                    return a
                if a == arg:
                    found_flag = true
    "/usr/local"

fn main():
    val prefix = parse_prefix_arg()
    val script_dir = rt_env_cwd()

    print "Simple Language Installer"
    print "========================="
    print ""
    print "Installing to: " + prefix
    print ""

    # Create directories
    print "Creating directories..."
    rt_dir_create(prefix + "/bin", true)
    rt_dir_create(prefix + "/lib", true)
    rt_dir_create(prefix + "/include", true)
    rt_dir_create(prefix + "/share/simple/src", true)

    # Install runtime binary
    print "Installing binaries..."
    val runtime_src = script_dir + "/bin/simple_runtime"
    val runtime_dst = prefix + "/bin/simple_runtime"
    if rt_file_exists(runtime_src):
        rt_file_copy(runtime_src, runtime_dst)
        rt_process_run("chmod", ["+x", runtime_dst])
        print "  Installed simple_runtime"
    else:
        print "  ERROR: simple_runtime not found"
        return

    # Create CLI wrapper
    val wrapper = "#!/bin/sh{NL}SHARE_DIR=\"" + prefix + "/share/simple\"{NL}RUNTIME=\"" + prefix + "/bin/simple_runtime\"{NL}export LD_LIBRARY_PATH=\"" + prefix + "/lib:$LD_LIBRARY_PATH\"{NL}exec \"$RUNTIME\" \"$SHARE_DIR/src/app/cli/main.spl\" \"$@\"{NL}"
    val wrapper_path = prefix + "/bin/simple"
    rt_file_write_text(wrapper_path, wrapper)
    rt_process_run("chmod", ["+x", wrapper_path])
    print "  Installed simple CLI wrapper"

    # Install libraries
    print "Installing libraries..."
    val lib_src = script_dir + "/lib/libsimple_ffi_wrapper.so"
    if rt_file_exists(lib_src):
        rt_file_copy(lib_src, prefix + "/lib/libsimple_ffi_wrapper.so")
        print "  Installed libsimple_ffi_wrapper.so"

    # Install headers
    print "Installing headers..."
    val header_src = script_dir + "/include/simple_ffi.h"
    if rt_file_exists(header_src):
        rt_file_copy(header_src, prefix + "/include/simple_ffi.h")
        print "  Installed simple_ffi.h"

    # Install source files
    print "Installing source files..."
    copy_source_tree(script_dir + "/src", prefix + "/share/simple/src")

    print ""
    print "Installation complete!"
    print ""
    print "Add to PATH if needed:"
    print "  export PATH=\"" + prefix + "/bin:$PATH\""
    print ""
    print "Test installation:"
    print "  simple --version"

fn copy_source_tree(src: text, dst: text):
    val files = rt_dir_walk(src)
    var count = 0
    for f in files:
        if f.ends_with(".spl") or f.ends_with(".ssh"):
            val rel = f.slice(src.len() + 1)
            val dst_file = dst + "/" + rel
            val parent = get_parent(dst_file)
            rt_dir_create(parent, true)
            rt_file_copy(f, dst_file)
            count = count + 1
    print "  Copied " + count.to_text() + " source files"

fn get_parent(p: text) -> text:
    var i = p.len() - 1
    while i >= 0:
        if p.char_at(i) == "/":
            return p.slice(0, i)
        i = i - 1
    "."
