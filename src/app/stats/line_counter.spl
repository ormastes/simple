# Line counting for source files

use app.io (file_read)
use app.stats.types (LineCount)
use app.stats.file_scanner (dir_walk_recursive)

# Count lines in a single file
fn count_lines(file_path: text) -> LineCount:
    val content = file_read(file_path)
    if content == "":
        return LineCount(code: 0, blank: 0, comment: 0, total: 0)

    val lines = content.split("\n")
    var code = 0
    var blank = 0
    var comment = 0

    for line in lines:
        val trimmed = line.trim()
        if trimmed.len() == 0:
            blank = blank + 1
        elif trimmed.starts_with("#"):
            comment = comment + 1
        else:
            code = code + 1

    val total = lines.len()
    LineCount(code: code, blank: blank, comment: comment, total: total)

# Count lines across all source files
fn count_project_lines() -> LineCount:
    val all_files = dir_walk_recursive("src")
    val spl_files = all_files.filter(\f: f.ends_with(".spl"))

    var total_code = 0
    var total_blank = 0
    var total_comment = 0

    for file in spl_files:
        val counts = count_lines(file)
        total_code = total_code + counts.code
        total_blank = total_blank + counts.blank
        total_comment = total_comment + counts.comment

    val total = total_code + total_blank + total_comment
    LineCount(
        code: total_code,
        blank: total_blank,
        comment: total_comment,
        total: total
    )

export count_project_lines
