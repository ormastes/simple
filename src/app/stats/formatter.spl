# Statistics output formatting

use app.stats.types (ProjectStats)
use std.string.{NL}

# Calculate percentage with formatting
fn percent(part: i64, total: i64) -> text:
    if total == 0:
        return "0.0"
    val ratio = (part * 100.0) / (total * 1.0)
    "{ratio:.1f}"

# Format statistics as a table
fn format_stats_table(stats: ProjectStats) -> text:
    var lines: [text] = []

    lines.push("=========================================")
    lines.push("Simple Project Statistics")
    lines.push("=========================================")
    lines.push("")

    # Tests section
    lines.push("Tests:")
    val test_total = stats.test_stats.total
    val test_passed = stats.test_stats.passed
    val test_failed = stats.test_stats.failed
    val test_skipped = stats.test_stats.skipped

    lines.push("  Total:   {test_total} tests")
    if test_total > 0:
        val pass_pct = percent(test_passed, test_total)
        val fail_pct = percent(test_failed, test_total)
        val skip_pct = percent(test_skipped, test_total)
        lines.push("  Passed:  {test_passed} ({pass_pct}%)")
        lines.push("  Failed:  {test_failed} ({fail_pct}%)")
        lines.push("  Skipped: {test_skipped} ({skip_pct}%)")
    else:
        lines.push("  (No test data available)")
    lines.push("")

    # Files section
    lines.push("Files:")
    val total_files = stats.file_stats.total_files
    val app_files = stats.file_stats.app_files
    val lib_files = stats.file_stats.lib_files
    val std_files = stats.file_stats.std_files
    val test_files = stats.file_stats.test_files

    lines.push("  Total:   {total_files} files")
    lines.push("    app:   {app_files} files")
    lines.push("    lib:   {lib_files} files")
    lines.push("    std:   {std_files} files")
    lines.push("    test:  {test_files} files")
    lines.push("")

    # Lines section
    lines.push("Lines:")
    val total_lines = stats.line_stats.total
    val code_lines = stats.line_stats.code
    val blank_lines = stats.line_stats.blank
    val comment_lines = stats.line_stats.comment

    lines.push("  Total:   {total_lines} lines")
    if total_lines > 0:
        val code_pct = percent(code_lines, total_lines)
        val blank_pct = percent(blank_lines, total_lines)
        val comment_pct = percent(comment_lines, total_lines)
        lines.push("    Code:    {code_lines} ({code_pct}%)")
        lines.push("    Blank:   {blank_lines} ({blank_pct}%)")
        lines.push("    Comment: {comment_lines} ({comment_pct}%)")
    lines.push("")

    # Coverage section
    lines.push("Coverage:")
    val coverage_pct = stats.coverage_stats.percent
    val coverage_covered = stats.coverage_stats.lines_covered
    val coverage_total = stats.coverage_stats.lines_total

    if coverage_total > 0:
        lines.push("  Overall: {coverage_pct:.1f}%")
        lines.push("  Covered: {coverage_covered} / {coverage_total} lines")
    else:
        lines.push("  (No coverage data available)")
    lines.push("")

    # Features section
    lines.push("Features:")
    val feat_total = stats.feature_stats.total
    val feat_complete = stats.feature_stats.complete
    val feat_progress = stats.feature_stats.in_progress
    val feat_planned = stats.feature_stats.planned

    if feat_total > 0:
        val feat_complete_pct = percent(feat_complete, feat_total)
        val feat_progress_pct = percent(feat_progress, feat_total)
        val feat_planned_pct = percent(feat_planned, feat_total)
        lines.push("  Total:       {feat_total} features")
        lines.push("  Complete:    {feat_complete} ({feat_complete_pct}%)")
        lines.push("  In Progress: {feat_progress} ({feat_progress_pct}%)")
        lines.push("  Planned:     {feat_planned} ({feat_planned_pct}%)")
    else:
        lines.push("  (No feature data available)")
    lines.push("")

    # Bugs section
    lines.push("Bugs:")
    val bug_total = stats.bug_stats.total
    val bug_open = stats.bug_stats.open
    val bug_critical = stats.bug_stats.critical
    val bug_fixed = stats.bug_stats.fixed

    if bug_total > 0:
        lines.push("  Total:    {bug_total} bugs")
        lines.push("  Open:     {bug_open}")
        lines.push("  Critical: {bug_critical}")
        lines.push("  Fixed:    {bug_fixed}")
    else:
        lines.push("  (No bug data available)")
    lines.push("")

    lines.push("=========================================")

    lines.join(NL)

export format_stats_table
