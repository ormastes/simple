# Expression Parser - Facade
#
# This module serves as a facade for the expression parsing subsystem.
# The actual implementation is split across focused submodules in expr/.
#
# Pratt parser for expressions with precedence climbing.
# Port of rust/parser/src/expressions/ (all submodules)
#
# Precedence levels (low to high):
#   pipe (|>)  >  parallel (//)  >  or  >  and  >  equality  >
#   comparison  >  range  >  bitwise_or  >  bitwise_xor  >  bitwise_and  >
#   shift  >  matmul (@)  >  term (+-)  >  factor (*/)  >
#   power (**)  >  unary  >  postfix  >  primary

from token import {TokenKind}
from ast import {Expr, Node, AssignOp, AssignmentStmt}

export ExpressionParser

# Import all submodules (extension methods for Parser)
mod expr.binary          # Binary operators with precedence climbing
mod expr.unary           # Unary operators
mod expr.postfix         # Postfix operators (method calls, indexing, etc.)
mod expr.primary         # Primary expression dispatcher
mod expr.literals        # Literal expressions
mod expr.identifiers     # Identifier and struct initialization
mod expr.lambdas         # Lambda expressions
mod expr.collections     # Arrays, dicts, tuples, comprehensions
mod expr.control         # Control flow expressions (if, match, etc.)
mod expr.math            # Math literals (grid, tensor)
mod expr.i18n            # i18n string templates
mod expr.helpers         # Helper functions and utilities

# Extension methods for Parser (entry points)

impl Parser:

    # =========================================================================
    # Core entry points
    # =========================================================================

    fn parse_expression() -> Expr:
        self.parse_pipe()

    fn parse_expression_or_assignment() -> Node:
        val expr = self.parse_expression()

        # Check for assignment operators
        val assign_op = match self.current.kind:
            TokenKind.Assign: AssignOp.Assign
            TokenKind.PlusAssign: AssignOp.AddAssign
            TokenKind.MinusAssign: AssignOp.SubAssign
            TokenKind.StarAssign: AssignOp.MulAssign
            TokenKind.SlashAssign: AssignOp.DivAssign
            TokenKind.PercentAssign: AssignOp.ModAssign
            TokenKind.AmpAssign: AssignOp.BitAndAssign
            TokenKind.PipeAssign: AssignOp.BitOrAssign
            TokenKind.CaretAssign: AssignOp.BitXorAssign
            TokenKind.ShiftLeftAssign: AssignOp.ShiftLeftAssign
            TokenKind.ShiftRightAssign: AssignOp.ShiftRightAssign
            _: return Node.Expression(expr)

        self.advance()
        val value = self.parse_expression()
        Node.Assignment(AssignmentStmt(target: expr, op: assign_op, value: value))
