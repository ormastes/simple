# Parser Error Types
#
# Parse errors with span information for diagnostics.
# Port of rust/parser/src/error.rs

from token import {Span}

export ParseError, ParseContext

struct ParseContext:
    file: text
    fn_name: text
    line: i64
    column: i64
    parser_state: text?

enum ParseError:
    SyntaxError(text, i64, i64, Span?)
    UnexpectedToken(text, text, Span)
    UnexpectedEof
    InvalidInteger(text)
    InvalidFloat(text)
    InvalidEscape(text)
    UnclosedString(Span?)
    InvalidIndentation(i64)
    UnterminatedBlockComment(Span?)
    MissingToken(text, Span)
    InvalidPattern(Span, text)
    InvalidType(Span, text)
    ContextualSyntaxError(text, text, Span, text?, text?)

impl ParseError:
    static fn syntax_error(message: text, line: i64, column: i64) -> ParseError:
        ParseError.SyntaxError(message, line, column, nil)

    static fn syntax_error_with_span(message: text, span: Span) -> ParseError:
        ParseError.SyntaxError(message, span.line, span.column, Some(span))

    static fn unexpected_token(expected: text, found: text, span: Span) -> ParseError:
        ParseError.UnexpectedToken(expected, found, span)

    static fn missing_token(expected: text, span: Span) -> ParseError:
        ParseError.MissingToken(expected, span)

    static fn contextual_error(context: text, message: text, span: Span) -> ParseError:
        ParseError.ContextualSyntaxError(context, message, span, nil, nil)

    static fn contextual_error_with_suggestion(context: text, message: text, span: Span, suggestion: text) -> ParseError:
        ParseError.ContextualSyntaxError(context, message, span, Some(suggestion), nil)

    fn span() -> Span?:
        match self:
            case ParseError.SyntaxError(_, _, _, span): span
            case ParseError.UnexpectedToken(_, _, span): Some(span)
            case ParseError.MissingToken(_, span): Some(span)
            case ParseError.InvalidPattern(span, _): Some(span)
            case ParseError.InvalidType(span, _): Some(span)
            case ParseError.UnclosedString(span): span
            case ParseError.UnterminatedBlockComment(span): span
            case ParseError.ContextualSyntaxError(_, _, span, _, _): Some(span)
            case _: nil

    fn message() -> text:
        match self:
            case ParseError.SyntaxError(msg, line, col, _):
                "Syntax error at {line}:{col}: {msg}"
            case ParseError.UnexpectedToken(expected, found, _):
                "Unexpected token: expected {expected}, found {found}"
            case ParseError.UnexpectedEof:
                "Unexpected end of file"
            case ParseError.InvalidInteger(s):
                "Invalid integer literal: {s}"
            case ParseError.InvalidFloat(s):
                "Invalid float literal: {s}"
            case ParseError.InvalidEscape(s):
                "Invalid escape sequence: {s}"
            case ParseError.UnclosedString(_):
                "Unclosed string literal"
            case ParseError.InvalidIndentation(line):
                "Invalid indentation at line {line}"
            case ParseError.UnterminatedBlockComment(_):
                "Unterminated block comment"
            case ParseError.MissingToken(expected, _):
                "Missing expected token: {expected}"
            case ParseError.InvalidPattern(_, msg):
                "Invalid pattern: {msg}"
            case ParseError.InvalidType(_, msg):
                "Invalid type: {msg}"
            case ParseError.ContextualSyntaxError(ctx, msg, _, _, _):
                "{ctx}: {msg}"
