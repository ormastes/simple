# Bootstrap FFI Generator
#
# Reads embedded Rust code from templates/ and writes to build/rust/ffi_gen/
#
# Usage:
#   simple src/app/ffi_gen/bootstrap_gen.spl
#   cd build/rust && cargo build --release

use app.io.mod (file_read, file_write, file_exists, dir_create, cwd)

fn main():
    val root = cwd()
    val template_dir = root + "/src/app/ffi_gen/templates"
    val output_dir = root + "/build/rust/ffi_gen/src"

    print "Bootstrap FFI Generator"
    print "========================"

    # Ensure output directory exists
    dir_create(root + "/build/rust/ffi_gen", true)
    dir_create(output_dir, true)

    # Read and write bootstrap_ffi template
    val template_path = template_dir + "/bootstrap_ffi.txt"
    val output_path = output_dir + "/bootstrap_ffi.rs"

    if not file_exists(template_path):
        print "ERROR: Template not found: " + template_path
        return

    val content = file_read(template_path)
    if content == "":
        print "ERROR: Failed to read template"
        return

    if file_write(output_path, content):
        print "  Wrote " + output_path
    else:
        print "  ERROR: Failed to write " + output_path
        return

    # Update lib.rs to include bootstrap_ffi
    val lib_path = output_dir + "/lib.rs"
    val lib_template = template_dir + "/lib.txt"

    if file_exists(lib_template):
        val lib_content = file_read(lib_template)
        if file_write(lib_path, lib_content):
            print "  Wrote " + lib_path
        else:
            print "  ERROR: Failed to write " + lib_path
    else:
        print "  WARNING: lib.txt template not found, skipping lib.rs update"

    print ""
    print "Done! Now run:"
    print "  cd build/rust && cargo build --release -p simple-ffi-wrapper"
