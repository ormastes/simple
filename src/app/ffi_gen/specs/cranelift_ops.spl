# Cranelift Ops - Arithmetic, Comparison, Memory, Control Flow
#
# Part of cranelift_core split: arithmetic operations, comparisons,
# memory operations, and control flow instructions.

use app.ffi_gen.types*
use app.ffi_gen.module_gen (ModuleBuilder)

# ============================================================================
# Arithmetic Functions
# ============================================================================

fn add_arithmetic_fns(builder: ModuleBuilder) -> ModuleBuilder:
    var result = builder
    # Add binary operations
    val binops = [
        "rt_cranelift_iadd", "rt_cranelift_isub", "rt_cranelift_imul",
        "rt_cranelift_sdiv", "rt_cranelift_udiv", "rt_cranelift_srem",
        "rt_cranelift_urem", "rt_cranelift_fadd", "rt_cranelift_fsub",
        "rt_cranelift_fmul", "rt_cranelift_fdiv", "rt_cranelift_band",
        "rt_cranelift_bor", "rt_cranelift_bxor", "rt_cranelift_ishl",
        "rt_cranelift_sshr", "rt_cranelift_ushr"
    ]
    for op in binops:
        result = result.add_fn(make_binop_fn(op))
    # Add unary operation
    result = result.add_fn(fn_rt_cranelift_bnot())
    result

fn make_binop_fn(name: text) -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c(name,
        [FFIParamSpec__simple("ctx", "i64"), FFIParamSpec__simple("a", "i64"), FFIParamSpec__simple("b", "i64")],
        "i64",
        CRANELIFT_VALUE_ID_BODY
    )
    spec.doc = "Binary arithmetic operation"
    spec

fn fn_rt_cranelift_bnot() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_bnot",
        [FFIParamSpec__simple("ctx", "i64"), FFIParamSpec__simple("a", "i64")],
        "i64",
        CRANELIFT_VALUE_ID_BODY
    )
    spec.doc = "Bitwise NOT"
    spec

# ============================================================================
# Comparison Functions
# ============================================================================

fn add_comparison_fns(builder: ModuleBuilder) -> ModuleBuilder:
    builder
        .add_fn(fn_rt_cranelift_icmp())
        .add_fn(fn_rt_cranelift_fcmp())

fn fn_rt_cranelift_icmp() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_icmp",
        [FFIParamSpec__simple("ctx", "i64"),
         FFIParamSpec__simple("cond", "i64"),
         FFIParamSpec__simple("a", "i64"),
         FFIParamSpec__simple("b", "i64")],
        "i64",
        CRANELIFT_VALUE_ID_BODY
    )
    spec.doc = "Integer comparison"
    spec

fn fn_rt_cranelift_fcmp() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_fcmp",
        [FFIParamSpec__simple("ctx", "i64"),
         FFIParamSpec__simple("cond", "i64"),
         FFIParamSpec__simple("a", "i64"),
         FFIParamSpec__simple("b", "i64")],
        "i64",
        CRANELIFT_VALUE_ID_BODY
    )
    spec.doc = "Float comparison"
    spec

# ============================================================================
# Memory Functions
# ============================================================================

fn add_memory_fns(builder: ModuleBuilder) -> ModuleBuilder:
    builder
        .add_fn(fn_rt_cranelift_load())
        .add_fn(fn_rt_cranelift_store())
        .add_fn(fn_rt_cranelift_stack_slot())
        .add_fn(fn_rt_cranelift_stack_addr())

fn fn_rt_cranelift_load() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_load",
        [FFIParamSpec__simple("ctx", "i64"),
         FFIParamSpec__simple("type_", "i64"),
         FFIParamSpec__simple("addr", "i64"),
         FFIParamSpec__simple("offset", "i64")],
        "i64",
        CRANELIFT_VALUE_ID_BODY
    )
    spec.doc = "Load from memory. Returns value handle."
    spec

fn fn_rt_cranelift_store() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_store",
        [FFIParamSpec__simple("ctx", "i64"),
         FFIParamSpec__simple("value", "i64"),
         FFIParamSpec__simple("addr", "i64"),
         FFIParamSpec__simple("offset", "i64")],
        "",
        "// Store to memory"
    )
    spec.doc = "Store to memory"
    spec

fn fn_rt_cranelift_stack_slot() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_stack_slot",
        [FFIParamSpec__simple("ctx", "i64"),
         FFIParamSpec__simple("size", "i64"),
         FFIParamSpec__simple("align", "i64")],
        "i64",
        CRANELIFT_VALUE_ID_BODY
    )
    spec.doc = "Create a stack slot. Returns slot handle."
    spec

fn fn_rt_cranelift_stack_addr() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_stack_addr",
        [FFIParamSpec__simple("ctx", "i64"),
         FFIParamSpec__simple("slot", "i64"),
         FFIParamSpec__simple("offset", "i64")],
        "i64",
        CRANELIFT_VALUE_ID_BODY
    )
    spec.doc = "Get address of stack slot. Returns value handle."
    spec

# ============================================================================
# Control Flow Functions
# ============================================================================

fn add_control_flow_fns(builder: ModuleBuilder) -> ModuleBuilder:
    builder
        .add_fn(fn_rt_cranelift_jump())
        .add_fn(fn_rt_cranelift_brif())
        .add_fn(fn_rt_cranelift_return())
        .add_fn(fn_rt_cranelift_return_void())
        .add_fn(fn_rt_cranelift_trap())

fn fn_rt_cranelift_jump() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_jump",
        [FFIParamSpec__simple("ctx", "i64"), FFIParamSpec__simple("block", "i64")],
        "",
        "// Unconditional jump"
    )
    spec.doc = "Unconditional jump to block"
    spec

fn fn_rt_cranelift_brif() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_brif",
        [FFIParamSpec__simple("ctx", "i64"),
         FFIParamSpec__simple("cond", "i64"),
         FFIParamSpec__simple("then_block", "i64"),
         FFIParamSpec__simple("else_block", "i64")],
        "",
        "// Conditional branch"
    )
    spec.doc = "Conditional branch (if-then-else)"
    spec

fn fn_rt_cranelift_return() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_return",
        [FFIParamSpec__simple("ctx", "i64"), FFIParamSpec__simple("value", "i64")],
        "",
        "// Return with value"
    )
    spec.doc = "Return from function with value"
    spec

fn fn_rt_cranelift_return_void() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_return_void",
        [FFIParamSpec__simple("ctx", "i64")],
        "",
        "// Return void"
    )
    spec.doc = "Return from function (void)"
    spec

fn fn_rt_cranelift_trap() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_trap",
        [FFIParamSpec__simple("ctx", "i64"), FFIParamSpec__simple("code", "i64")],
        "",
        "// Trap instruction"
    )
    spec.doc = "Trap (unreachable)"
    spec

export add_arithmetic_fns, add_comparison_fns, add_memory_fns, add_control_flow_fns
