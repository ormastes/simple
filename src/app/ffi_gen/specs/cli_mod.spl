# CLI Module - Full Specification
#
# Complete specification for generating cli.rs with:
# - Readline/REPL support
# - File watching
# - Signal handling
#
# Usage: simple ffi-gen --gen-module specs/cli_mod.spl

use app.ffi_gen.types*
use app.ffi_gen.module_gen (ModuleBuilder)
use std.string.{NL}

# ============================================================================
# Module Specification
# ============================================================================

fn cli_module() -> ModuleSpec:
    var builder = ModuleBuilder__start("cli")
        .doc("CLI Tools FFI{NL}{NL}Readline, file watching, and signal handling.")

    # Imports
    builder = builder
        .add_import_items("std::ffi", ["CStr", "CString"])
        .add_import("std::os::raw::c_char")
        .add_import("rustyline::DefaultEditor")

    # CLI functions
    builder = builder
        .add_fn(fn_rt_readline())
        .add_fn(fn_rt_readline_with_prompt())

    builder.build()

# ============================================================================
# CLI Functions
# ============================================================================

fn fn_rt_readline() -> FFIFnSpec:
    var spec = FFIFnSpec__extern_c("rt_readline",
        [],
        "*mut c_char",
        "match DefaultEditor::new() {{NL}" +
        "    Ok(mut editor) => {{NL}" +
        "        match editor.readline(\"> \") {{NL}" +
        "            Ok(line) => CString::new(line).ok().map(|c| c.into_raw()).unwrap_or(std::ptr::null_mut()),{NL}" +
        "            Err(_) => std::ptr::null_mut(),{NL}" +
        "        }{NL}" +
        "    }{NL}" +
        "    Err(_) => std::ptr::null_mut(),{NL}" +
        "}"
    )
    spec.doc = "Read line from stdin with default prompt"
    spec

fn fn_rt_readline_with_prompt() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_readline_with_prompt",
        [FFIParamSpec__raw_ptr("prompt", "*const c_char")],
        "*mut c_char",
        "let prompt_str = CStr::from_ptr(prompt as *const i8).to_string_lossy();{NL}" +
        "match DefaultEditor::new() {{NL}" +
        "    Ok(mut editor) => {{NL}" +
        "        match editor.readline(prompt_str.as_ref()) {{NL}" +
        "            Ok(line) => CString::new(line).ok().map(|c| c.into_raw()).unwrap_or(std::ptr::null_mut()),{NL}" +
        "            Err(_) => std::ptr::null_mut(),{NL}" +
        "        }{NL}" +
        "    }{NL}" +
        "    Err(_) => std::ptr::null_mut(),{NL}" +
        "}"
    )
    spec.doc = "Read line from stdin with custom prompt"
    spec
export cli_module
