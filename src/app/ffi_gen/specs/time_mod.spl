# Time Module - Full Specification
#
# Complete specification for generating time.rs with:
# - Current time operations
# - Timestamp components
# - Date/time parsing
#
# Usage: simple ffi-gen --gen-module specs/time_mod.spl

use app.ffi_gen.types*
use app.ffi_gen.module_gen (ModuleBuilder)

# ============================================================================
# Module Specification
# ============================================================================

fn time_module() -> ModuleSpec:
    var builder = ModuleBuilder.start("time")
        .doc("Time Operations FFI\n\nCurrent time, timestamps, and date/time components.")

    # Imports
    builder = builder
        .add_import_items("std::time", ["SystemTime", "UNIX_EPOCH"])
        .add_import("chrono::prelude::*")

    # Time functions
    builder = builder
        .add_fn(fn_rt_time_now_unix_micros())
        .add_fn(fn_rt_current_time_ms())
        .add_fn(fn_rt_timestamp_get_year())
        .add_fn(fn_rt_timestamp_get_month())
        .add_fn(fn_rt_timestamp_get_day())
        .add_fn(fn_rt_timestamp_get_hour())
        .add_fn(fn_rt_timestamp_get_minute())
        .add_fn(fn_rt_timestamp_get_second())

    builder.build()

# ============================================================================
# Time Functions
# ============================================================================

fn fn_rt_time_now_unix_micros() -> FFIFnSpec:
    var spec = FFIFnSpec.extern_c("rt_time_now_unix_micros",
        [],
        "i64",
        "SystemTime::now()\n" +
        "    .duration_since(UNIX_EPOCH)\n" +
        "    .map(|d| d.as_micros() as i64)\n" +
        "    .unwrap_or(0)"
    )
    spec.doc = "Get current Unix timestamp in microseconds"
    spec

fn fn_rt_current_time_ms() -> FFIFnSpec:
    var spec = FFIFnSpec.extern_c("rt_current_time_ms",
        [],
        "i64",
        "SystemTime::now()\n" +
        "    .duration_since(UNIX_EPOCH)\n" +
        "    .map(|d| d.as_millis() as i64)\n" +
        "    .unwrap_or(0)"
    )
    spec.doc = "Get current Unix timestamp in milliseconds"
    spec

fn fn_rt_timestamp_get_year() -> FFIFnSpec:
    var spec = FFIFnSpec.extern_c("rt_timestamp_get_year",
        [FFIParamSpec.simple("micros", "i64")],
        "i32",
        "let secs = micros / 1_000_000;\n" +
        "let dt = chrono::DateTime::from_timestamp(secs, 0).unwrap_or_default();\n" +
        "dt.year()"
    )
    spec.doc = "Get year from Unix microseconds"
    spec

fn fn_rt_timestamp_get_month() -> FFIFnSpec:
    var spec = FFIFnSpec.extern_c("rt_timestamp_get_month",
        [FFIParamSpec.simple("micros", "i64")],
        "i32",
        "let secs = micros / 1_000_000;\n" +
        "let dt = chrono::DateTime::from_timestamp(secs, 0).unwrap_or_default();\n" +
        "dt.month() as i32"
    )
    spec.doc = "Get month (1-12) from Unix microseconds"
    spec

fn fn_rt_timestamp_get_day() -> FFIFnSpec:
    var spec = FFIFnSpec.extern_c("rt_timestamp_get_day",
        [FFIParamSpec.simple("micros", "i64")],
        "i32",
        "let secs = micros / 1_000_000;\n" +
        "let dt = chrono::DateTime::from_timestamp(secs, 0).unwrap_or_default();\n" +
        "dt.day() as i32"
    )
    spec.doc = "Get day (1-31) from Unix microseconds"
    spec

fn fn_rt_timestamp_get_hour() -> FFIFnSpec:
    var spec = FFIFnSpec.extern_c("rt_timestamp_get_hour",
        [FFIParamSpec.simple("micros", "i64")],
        "i32",
        "let secs = micros / 1_000_000;\n" +
        "let dt = chrono::DateTime::from_timestamp(secs, 0).unwrap_or_default();\n" +
        "dt.hour() as i32"
    )
    spec.doc = "Get hour (0-23) from Unix microseconds"
    spec

fn fn_rt_timestamp_get_minute() -> FFIFnSpec:
    var spec = FFIFnSpec.extern_c("rt_timestamp_get_minute",
        [FFIParamSpec.simple("micros", "i64")],
        "i32",
        "let secs = micros / 1_000_000;\n" +
        "let dt = chrono::DateTime::from_timestamp(secs, 0).unwrap_or_default();\n" +
        "dt.minute() as i32"
    )
    spec.doc = "Get minute (0-59) from Unix microseconds"
    spec

fn fn_rt_timestamp_get_second() -> FFIFnSpec:
    var spec = FFIFnSpec.extern_c("rt_timestamp_get_second",
        [FFIParamSpec.simple("micros", "i64")],
        "i32",
        "let secs = micros / 1_000_000;\n" +
        "let dt = chrono::DateTime::from_timestamp(secs, 0).unwrap_or_default();\n" +
        "dt.second() as i32"
    )
    spec.doc = "Get second (0-59) from Unix microseconds"
    spec
