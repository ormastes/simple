# Cranelift Codegen - Module Management, Signatures, Function Building, Blocks, Values
#
# Part of cranelift_core split: functions for module creation, signatures,
# function building, block management, and value creation.

use app.ffi_gen.types*
use app.ffi_gen.module_gen (ModuleBuilder)
use std.string.{NL}

# ============================================================================
# Module Management Functions
# ============================================================================

fn add_module_management_fns(builder: ModuleBuilder) -> ModuleBuilder:
    builder
        .add_fn(fn_rt_cranelift_new_module())
        .add_fn(fn_rt_cranelift_finalize_module())
        .add_fn(fn_rt_cranelift_free_module())
        .add_fn(fn_rt_cranelift_module_new())

fn fn_rt_cranelift_new_module() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_new_module",
        [FFIParamSpec__simple("name_ptr", "i64"),
         FFIParamSpec__simple("name_len", "i64"),
         FFIParamSpec__simple("target", "i64")],
        "i64",
        "let name = string_from_ptr(name_ptr, name_len);{NL}" +
        "rt_cranelift_new_module_impl(&name, target)"
    )
    spec.doc = "Create a new JIT or AOT module (low-level with raw pointers). Returns module handle, or 0 on failure."
    spec

fn fn_rt_cranelift_module_new() -> FFIFnSpec:
    var spec = FFIFnSpec(
        name: "rt_cranelift_module_new",
        abi: "C",
        unsafe_fn: false,
        no_mangle: true,
        params: [FFIParamSpec__simple("name", "RuntimeValue"), FFIParamSpec__simple("target", "i64")],
        return_type: "i64",
        body: "let name_str = match extract_string(name) {{NL}" +
              "    Some(s) => s,{NL}" +
              "    None => return 0,{NL}" +
              "};{NL}" +
              "unsafe { rt_cranelift_new_module_impl(&name_str, target) }",
        visibility: "pub",
        generics: [],
        where_clauses: [],
        doc: "Create a new JIT or AOT module (takes RuntimeValue for name). Returns module handle, or 0 on failure."
    )
    spec

fn fn_rt_cranelift_finalize_module() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_finalize_module",
        [FFIParamSpec__simple("module", "i64")],
        "i64",
        "// Try JIT modules first{NL}" +
        "{{NL}" +
        "    let mut modules = JIT_MODULES.lock().unwrap();{NL}" +
        "    if let Some(ctx) = modules.get_mut(&module) {{NL}" +
        "        ctx.module.finalize_definitions().unwrap();{NL}" +
        "        return module;{NL}" +
        "    }{NL}" +
        "}{NL}" +
        "{NL}" +
        "// For AOT modules, check if exists (no finalize needed - done in emit_object){NL}" +
        "{{NL}" +
        "    let modules = AOT_MODULES.lock().unwrap();{NL}" +
        "    if modules.contains_key(&module) {{NL}" +
        "        return module;{NL}" +
        "    }{NL}" +
        "}{NL}" +
        "{NL}" +
        "0"
    )
    spec.doc = "Finalize the module after all functions are defined. Returns the module handle on success, 0 on failure."
    spec

fn fn_rt_cranelift_free_module() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_free_module",
        [FFIParamSpec__simple("module", "i64")],
        "",
        "JIT_MODULES.lock().unwrap().remove(&module);{NL}" +
        "AOT_MODULES.lock().unwrap().remove(&module);"
    )
    spec.doc = "Free module resources."
    spec

# ============================================================================
# Signature Functions
# ============================================================================

fn add_signature_fns(builder: ModuleBuilder) -> ModuleBuilder:
    builder
        .add_fn(fn_rt_cranelift_new_signature())
        .add_fn(fn_rt_cranelift_sig_add_param())
        .add_fn(fn_rt_cranelift_sig_set_return())

fn fn_rt_cranelift_new_signature() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_new_signature",
        [FFIParamSpec__simple("call_conv", "i64")],
        "i64",
        "let conv = match call_conv {{NL}" +
        "    0 => CallConv::SystemV,{NL}" +
        "    _ => CallConv::Fast,{NL}" +
        "};{NL}" +
        "let sig = Signature::new(conv);{NL}" +
        "let handle = next_handle();{NL}" +
        "SIGNATURES.lock().unwrap().insert(handle, sig);{NL}" +
        "handle"
    )
    spec.doc = "Create a new function signature. Returns signature handle."
    spec

fn fn_rt_cranelift_sig_add_param() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_sig_add_param",
        [FFIParamSpec__simple("sig", "i64"), FFIParamSpec__simple("type_", "i64")],
        "",
        "let mut sigs = SIGNATURES.lock().unwrap();{NL}" +
        "if let Some(signature) = sigs.get_mut(&sig) {{NL}" +
        "    let ty = type_from_code(type_);{NL}" +
        "    signature.params.push(AbiParam::new(ty));{NL}" +
        "}"
    )
    spec.doc = "Add a parameter to a signature."
    spec

fn fn_rt_cranelift_sig_set_return() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_sig_set_return",
        [FFIParamSpec__simple("sig", "i64"), FFIParamSpec__simple("type_", "i64")],
        "",
        "let mut sigs = SIGNATURES.lock().unwrap();{NL}" +
        "if let Some(signature) = sigs.get_mut(&sig) {{NL}" +
        "    let ty = type_from_code(type_);{NL}" +
        "    signature.returns.push(AbiParam::new(ty));{NL}" +
        "}"
    )
    spec.doc = "Set the return type of a signature."
    spec

# ============================================================================
# Function Building Functions
# ============================================================================

fn add_function_building_fns(builder: ModuleBuilder) -> ModuleBuilder:
    builder
        .add_fn(fn_rt_cranelift_begin_function())
        .add_fn(fn_rt_cranelift_end_function())
        .add_fn(fn_rt_cranelift_define_function())
        .add_fn(fn_rt_cranelift_call_function_ptr())

fn fn_rt_cranelift_begin_function() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_begin_function",
        [FFIParamSpec__simple("module", "i64"),
         FFIParamSpec__simple("name_ptr", "i64"),
         FFIParamSpec__simple("name_len", "i64"),
         FFIParamSpec__simple("sig", "i64")],
        "i64",
        "let name = string_from_ptr(name_ptr, name_len);{NL}" +
        "let handle = next_handle();{NL}" +
        "let ctx = Context::new();{NL}" +
        "let func_builder_ctx = FunctionBuilderContext::new();{NL}" +
        "let fctx = FuncBuildContext {{NL}" +
        "    module_handle: module,{NL}" +
        "    is_jit: true,{NL}" +
        "    ctx,{NL}" +
        "    func_builder_ctx,{NL}" +
        "    blocks: HashMap::new(),{NL}" +
        "    values: HashMap::new(),{NL}" +
        "    next_block_id: 0,{NL}" +
        "    next_value_id: 0,{NL}" +
        "};{NL}" +
        "FUNC_CONTEXTS.lock().unwrap().insert(handle, fctx);{NL}" +
        "handle"
    )
    spec.doc = "Begin defining a function. Returns function context handle."
    spec

fn fn_rt_cranelift_end_function() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_end_function",
        [FFIParamSpec__simple("ctx", "i64")],
        "i64",
        "let contexts = FUNC_CONTEXTS.lock().unwrap();{NL}" +
        "if contexts.contains_key(&ctx) {{NL}" +
        "    ctx{NL}" +
        "} else {{NL}" +
        "    0{NL}" +
        "}"
    )
    spec.doc = "End function definition. Returns function ID."
    spec

fn fn_rt_cranelift_define_function() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_define_function",
        [FFIParamSpec__simple("module", "i64"),
         FFIParamSpec__simple("func_id", "i64"),
         FFIParamSpec__simple("ctx", "i64")],
        "bool",
        "true"
    )
    spec.doc = "Define a function in the module. Returns success status."
    spec

fn fn_rt_cranelift_call_function_ptr() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_call_function_ptr",
        [FFIParamSpec__simple("ctx", "i64"),
         FFIParamSpec__simple("func_ptr", "i64")],
        "i64",
        CRANELIFT_VALUE_ID_BODY
    )
    spec.doc = "Call function through pointer. Returns value handle."
    spec

# ============================================================================
# Block Management Functions
# ============================================================================

fn add_block_management_fns(builder: ModuleBuilder) -> ModuleBuilder:
    builder
        .add_fn(fn_rt_cranelift_create_block())
        .add_fn(fn_rt_cranelift_switch_to_block())
        .add_fn(fn_rt_cranelift_seal_block())
        .add_fn(fn_rt_cranelift_seal_all_blocks())

fn fn_rt_cranelift_create_block() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_create_block",
        [FFIParamSpec__simple("ctx", "i64")],
        "i64",
        "let mut contexts = FUNC_CONTEXTS.lock().unwrap();{NL}" +
        "if let Some(fctx) = contexts.get_mut(&ctx) {{NL}" +
        "    let block_id = fctx.next_block_id;{NL}" +
        "    fctx.next_block_id += 1;{NL}" +
        "    block_id{NL}" +
        "} else {{NL}" +
        "    0{NL}" +
        "}"
    )
    spec.doc = "Create a new basic block. Returns block handle."
    spec

fn fn_rt_cranelift_switch_to_block() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_switch_to_block",
        [FFIParamSpec__simple("ctx", "i64"), FFIParamSpec__simple("block", "i64")],
        "",
        "// Switch to block"
    )
    spec.doc = "Switch to a block for instruction emission."
    spec

fn fn_rt_cranelift_seal_block() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_seal_block",
        [FFIParamSpec__simple("ctx", "i64"), FFIParamSpec__simple("block", "i64")],
        "",
        "// Seal block"
    )
    spec.doc = "Seal a block (no more predecessors)."
    spec

fn fn_rt_cranelift_seal_all_blocks() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_seal_all_blocks",
        [FFIParamSpec__simple("ctx", "i64")],
        "",
        "// Seal all blocks"
    )
    spec.doc = "Seal all blocks in the function."
    spec

# ============================================================================
# Value Creation Functions
# ============================================================================

fn add_value_creation_fns(builder: ModuleBuilder) -> ModuleBuilder:
    builder
        .add_fn(fn_rt_cranelift_iconst())
        .add_fn(fn_rt_cranelift_fconst())
        .add_fn(fn_rt_cranelift_bconst())
        .add_fn(fn_rt_cranelift_null())

fn fn_rt_cranelift_iconst() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_iconst",
        [FFIParamSpec__simple("ctx", "i64"),
         FFIParamSpec__simple("type_", "i64"),
         FFIParamSpec__simple("value", "i64")],
        "i64",
        "let mut contexts = FUNC_CONTEXTS.lock().unwrap();{NL}" +
        "if let Some(fctx) = contexts.get_mut(&ctx) {{NL}" +
        "    fctx.ctx.func.dfg.constants{NL}" +
        "        .insert(cranelift_codegen::ir::ConstantData::from({NL}" +
        "            value.to_le_bytes().as_slice(),{NL}" +
        "        ));{NL}" +
        "    let value_id = fctx.next_value_id;{NL}" +
        "    fctx.next_value_id += 1;{NL}" +
        "    value_id{NL}" +
        "} else {{NL}" +
        "    0{NL}" +
        "}"
    )
    spec.doc = "Create an integer constant. Returns value handle."
    spec

fn fn_rt_cranelift_fconst() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_fconst",
        [FFIParamSpec__simple("ctx", "i64"),
         FFIParamSpec__simple("type_", "i64"),
         FFIParamSpec__simple("value", "f64")],
        "i64",
        CRANELIFT_VALUE_ID_BODY
    )
    spec.doc = "Create a float constant. Returns value handle."
    spec

fn fn_rt_cranelift_bconst() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_bconst",
        [FFIParamSpec__simple("ctx", "i64"), FFIParamSpec__simple("value", "bool")],
        "i64",
        "rt_cranelift_iconst(ctx, CL_TYPE_I8, if value { 1 } else { 0 })"
    )
    spec.doc = "Create a boolean constant. Returns value handle."
    spec

fn fn_rt_cranelift_null() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_cranelift_null",
        [FFIParamSpec__simple("ctx", "i64"), FFIParamSpec__simple("type_", "i64")],
        "i64",
        "rt_cranelift_iconst(ctx, type_, 0)"
    )
    spec.doc = "Create a null pointer constant. Returns value handle."
    spec

export add_module_management_fns, add_signature_fns, add_function_building_fns
export add_block_management_fns, add_value_creation_fns
