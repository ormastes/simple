# System Module - Full Specification
#
# Complete specification for generating system.rs with:
# - Hostname
# - CPU count
# - System information
#
# Usage: simple ffi-gen --gen-module specs/system_mod.spl

use app.ffi_gen.types*
use app.ffi_gen.module_gen (ModuleBuilder)
use std.text.{NL}

# ============================================================================
# Module Specification
# ============================================================================

fn system_module() -> ModuleSpec:
    var builder = ModuleBuilder__start("system")
        .doc("System Information FFI{NL}{NL}Hostname, CPU count, and system info.")

    # Imports
    builder = builder
        .add_import_items("std::ffi", ["CString"])
        .add_import("std::os::raw::c_char")
        .add_import("hostname::get")

    # System functions
    builder = builder
        .add_fn(fn_rt_hostname())
        .add_fn(fn_rt_system_cpu_count())

    builder.build()

# ============================================================================
# System Functions
# ============================================================================

fn fn_rt_hostname() -> FFIFnSpec:
    var spec = FFIFnSpec__extern_c("rt_hostname",
        [],
        "*mut c_char",
        "match get() {{NL}" +
        "    Ok(name) => {{NL}" +
        "        let name_str = name.to_string_lossy().to_string();{NL}" +
        "        CString::new(name_str).ok().map(|c| c.into_raw()).unwrap_or(std::ptr::null_mut()){NL}" +
        "    }{NL}" +
        "    Err(_) => std::ptr::null_mut(),{NL}" +
        "}"
    )
    spec.doc = "Get system hostname"
    spec

fn fn_rt_system_cpu_count() -> FFIFnSpec:
    var spec = FFIFnSpec__extern_c("rt_system_cpu_count",
        [],
        "i64",
        "num_cpus::get() as i64"
    )
    spec.doc = "Get number of logical CPU cores"
    spec
export system_module
