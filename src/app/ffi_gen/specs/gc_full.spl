# Garbage Collector Module - Full Specification
#
# Complete specification for generating gc.rs with:
# - GC initialization
# - Memory allocation functions (using bdwgc-alloc)
# - Collection control
# - Unit tests
#
# Usage: simple ffi-gen --gen-module specs/gc_full.spl

use app.ffi_gen.types*
use app.ffi_gen.module_gen (ModuleBuilder)
use std.string.{NL}

# ============================================================================
# Module Specification
# ============================================================================

fn gc_module() -> ModuleSpec:
    var builder = ModuleBuilder__start("gc")
        .doc("Garbage Collector FFI{NL}{NL}Uses Boehm-Demers-Weiser GC (bdwgc) as the garbage collector.{NL}This is a conservative, portable GC used by many language runtimes.")

    # Imports
    builder = builder
        .add_import_items("std::alloc", ["GlobalAlloc", "Layout"])

    # GC functions
    builder = builder
        .add_fn(fn_rt_gc_init())
        .add_fn(fn_rt_gc_malloc())
        .add_fn(fn_rt_gc_malloc_atomic())
        .add_fn(fn_rt_gc_collect())
        .add_fn(fn_rt_gc_get_heap_size())
        .add_fn(fn_rt_gc_get_free_bytes())

    # Tests (ignored since bdwgc has issues in test environment)
    builder = builder
        .add_test(test_gc_malloc())
        .add_test(test_gc_malloc_atomic())

    builder.build()

# ============================================================================
# GC Functions
# ============================================================================

fn fn_rt_gc_init() -> FFIFnSpec:
    var spec = FFIFnSpec__extern_c("rt_gc_init", [], "()",
        "// bdwgc initializes automatically on first allocation{NL}" +
        "// This is a no-op but kept for API compatibility"
    )
    spec.doc = "Initialize the GC"
    spec

fn fn_rt_gc_malloc() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_gc_malloc",
        [FFIParamSpec__simple("size", "usize")],
        "*mut u8",
        "if size == 0 {{NL}" +
        "    return std::ptr::null_mut();{NL}" +
        "}{NL}" +
        "{NL}" +
        "let layout = Layout::from_size_align_unchecked(size, 8);{NL}" +
        "bdwgc_alloc::Allocator.alloc(layout)"
    )
    spec.doc = "Allocate memory (GC-managed)"
    spec

fn fn_rt_gc_malloc_atomic() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_gc_malloc_atomic",
        [FFIParamSpec__simple("size", "usize")],
        "*mut u8",
        "// For now, use same as regular malloc{NL}" +
        "// bdwgc has atomic allocation but not exposed in bdwgc-alloc crate yet{NL}" +
        "rt_gc_malloc(size)"
    )
    spec.doc = "Allocate atomic memory (no pointers, won't be scanned)"
    spec

fn fn_rt_gc_collect() -> FFIFnSpec:
    var spec = FFIFnSpec__extern_c("rt_gc_collect", [], "()",
        "// bdwgc-alloc doesn't expose explicit collection{NL}" +
        "// Collection happens automatically"
    )
    spec.doc = "Force garbage collection"
    spec

fn fn_rt_gc_get_heap_size() -> FFIFnSpec:
    var spec = FFIFnSpec__extern_c("rt_gc_get_heap_size", [], "usize",
        "// Not available in bdwgc-alloc{NL}0"
    )
    spec.doc = "Get heap size"
    spec

fn fn_rt_gc_get_free_bytes() -> FFIFnSpec:
    var spec = FFIFnSpec__extern_c("rt_gc_get_free_bytes", [], "usize",
        "// Not available in bdwgc-alloc{NL}0"
    )
    spec.doc = "Get free bytes"
    spec

# ============================================================================
# Test Specifications
# ============================================================================

fn test_gc_malloc() -> TestSpec:
    TestSpec__ignored_test("test_gc_malloc",
        "TODO: bdwgc has issues in test environment - test in integration tests instead",
        "rt_gc_init();{NL}" +
        "unsafe {{NL}" +
        "    let ptr = rt_gc_malloc(1024);{NL}" +
        "    assert!(!ptr.is_null());{NL}" +
        "    // Write some data{NL}" +
        "    *ptr = 42;{NL}" +
        "    assert_eq!(*ptr, 42);{NL}" +
        "}"
    )

fn test_gc_malloc_atomic() -> TestSpec:
    TestSpec__ignored_test("test_gc_malloc_atomic",
        "TODO: bdwgc has issues in test environment - test in integration tests instead",
        "unsafe {{NL}" +
        "    let ptr = rt_gc_malloc_atomic(512);{NL}" +
        "    assert!(!ptr.is_null());{NL}" +
        "}"
    )
export gc_module
