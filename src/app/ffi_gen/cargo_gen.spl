# FFI Wrapper Generator - Cargo.toml Generation
#
# Generates a Cargo.toml for the FFI wrapper crate with the correct
# dependencies from @Lib annotations.

use app.ffi_gen.parser*
use std.string.{NL}

# ============================================================================
# Cargo.toml Generation
# ============================================================================

# Generate Cargo.toml content for a set of @Lib specs
# edition: Rust edition from simple.sdn ffi.rust.edition (e.g. "2021")
fn generate_cargo_toml(specs: [LibExternSpec], edition: text) -> text:
    val ed = if edition != "": edition else: "2021"
    var out = ""
    out = out + "# Auto-generated by Simple FFI wrapper generator{NL}"
    out = out + "# Do not edit manually.{NL}{NL}"
    out = out + "[package]{NL}"
    out = out + "name = \"simple-ffi-wrapper\"{NL}"
    out = out + "version = \"0.1.0\"{NL}"
    out = out + "edition = \"{ed}\"{NL}{NL}"
    out = out + "[lib]{NL}"
    out = out + "crate-type = [\"cdylib\", \"rlib\"]{NL}{NL}"
    out = out + "[dependencies]{NL}"

    # Collect unique dependencies
    var seen: [text] = []
    for spec in specs:
        if seen.contains(spec.lib_name):
            pass
        else:
            seen.push(spec.lib_name)
            out = out + generate_dependency(spec)

    out = out + NL
    out = out + "[profile.release]{NL}"
    out = out + "opt-level = 3{NL}"
    out = out + "lto = true{NL}"
    out = out + "codegen-units = 1{NL}"

    out

# Generate a single dependency line
fn generate_dependency(spec: LibExternSpec) -> text:
    val name = spec.lib_name
    val version = spec.lib_version
    val features = spec.lib_features

    if features.len() > 0:
        # Dependency with features
        var feat_str = features.map(\f: "\"{f}\"").join(", ")
        if version != "":
            "{name} = {{ version = \"{version}\", features = [{feat_str}] }}{NL}"
        else:
            "{name} = {{ features = [{feat_str}] }}{NL}"
    elif version != "":
        "{name} = \"{version}\"{NL}"
    else:
        "{name} = \"*\"{NL}"
