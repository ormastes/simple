# Net Module - Full Specification
#
# Complete specification for generating net.rs with:
# - HTTP requests
# - Socket operations
#
# Usage: simple ffi-gen --gen-module specs/net_mod.spl

use app.ffi_gen.types*
use app.ffi_gen.module_gen (ModuleBuilder)
use std.string.{NL}

# ============================================================================
# Module Specification
# ============================================================================

fn net_module() -> ModuleSpec:
    var builder = ModuleBuilder__start("net")
        .doc("Network Operations FFI{NL}{NL}HTTP requests and socket operations.")

    # Imports
    builder = builder
        .add_import_items("std::ffi", ["CStr", "CString"])
        .add_import("std::os::raw::c_char")

    # Net functions
    builder = builder
        .add_fn(fn_rt_http_get())
        .add_fn(fn_rt_http_post())

    builder.build()

# ============================================================================
# Net Functions
# ============================================================================

fn fn_rt_http_get() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_http_get",
        [FFIParamSpec__raw_ptr("url", "*const c_char")],
        "*mut c_char",
        "let url_str = CStr::from_ptr(url as *const i8).to_string_lossy();{NL}" +
        "match ureq::get(url_str.as_ref()).call() {{NL}" +
        "    Ok(response) => {{NL}" +
        "        match response.into_string() {{NL}" +
        "            Ok(body) => CString::new(body).ok().map(|c| c.into_raw()).unwrap_or(std::ptr::null_mut()),{NL}" +
        "            Err(_) => std::ptr::null_mut(),{NL}" +
        "        }{NL}" +
        "    }{NL}" +
        "    Err(_) => std::ptr::null_mut(),{NL}" +
        "}"
    )
    spec.doc = "HTTP GET request"
    spec

fn fn_rt_http_post() -> FFIFnSpec:
    var spec = FFIFnSpec__unsafe_extern_c("rt_http_post",
        [FFIParamSpec__raw_ptr("url", "*const c_char"),
         FFIParamSpec__raw_ptr("body", "*const c_char")],
        "*mut c_char",
        "let url_str = CStr::from_ptr(url as *const i8).to_string_lossy();{NL}" +
        "let body_str = CStr::from_ptr(body as *const i8).to_string_lossy();{NL}" +
        "match ureq::post(url_str.as_ref()).send_string(body_str.as_ref()) {{NL}" +
        "    Ok(response) => {{NL}" +
        "        match response.into_string() {{NL}" +
        "            Ok(resp_body) => CString::new(resp_body).ok().map(|c| c.into_raw()).unwrap_or(std::ptr::null_mut()),{NL}" +
        "            Err(_) => std::ptr::null_mut(),{NL}" +
        "        }{NL}" +
        "    }{NL}" +
        "    Err(_) => std::ptr::null_mut(),{NL}" +
        "}"
    )
    spec.doc = "HTTP POST request"
    spec
export net_module
