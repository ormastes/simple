# GC FFI Specification - COMPLETE
#
# Defines FFI interface for garbage collector operations.
# Generate Rust implementation with: simple ffi-gen --gen-intern specs/gc.spl
#
# COMPLETE COVERAGE of rust/runtime/src/memory/gc.rs GcRuntime API
#
# Architecture:
# - Tier 1: extern fn rt_gc_* (this file - FFI spec)
# - Tier 2: fn gc_* (src/app/gc/mod.spl - Simple wrappers)
#
# Following CLAUDE.md:
# - ✅ FFI spec in Simple
# - ✅ Generate Rust with ffi-gen
# - ✅ Simple wrappers in src/app/
# - ✅ Covers ALL Rust GcRuntime functions

# ============================================================================
# GC Configuration & Creation
# ============================================================================

## Create a new GC runtime with default settings (1 GB limit)
extern fn rt_gc_new() -> i64

## Create a GC runtime with unlimited memory
extern fn rt_gc_unlimited() -> i64

## Create a GC runtime with memory limit (bytes)
extern fn rt_gc_with_limit(limit_bytes: i64) -> i64

## Create a GC runtime with memory limit (MB)
extern fn rt_gc_with_limit_mb(limit_mb: i64) -> i64

## Create a GC runtime with memory limit (GB)
extern fn rt_gc_with_limit_gb(limit_gb: i64) -> i64

## Create a GC runtime with verbose stdout logging
extern fn rt_gc_verbose_stdout() -> i64

## Create a GC runtime with custom options
## Options format: "limit_mb=512;fail_on_exceeded=true;verbose=true"
extern fn rt_gc_with_options(options: text) -> i64

## Destroy/free a GC runtime
extern fn rt_gc_destroy(gc: i64)

# ============================================================================
# GC Logging
# ============================================================================

## Enable GC logging to stdout
extern fn rt_gc_enable_logging(gc: i64, enabled: bool)

## Enable verbose GC logging
extern fn rt_gc_enable_verbose(gc: i64, enabled: bool)

## Set custom log callback (function pointer)
extern fn rt_gc_set_logger(gc: i64, callback: i64)

# ============================================================================
# GC Statistics
# ============================================================================

## Get heap size in bytes
extern fn rt_gc_heap_bytes(gc: i64) -> i64

## Get tracked memory in bytes
extern fn rt_gc_tracked_memory(gc: i64) -> i64

## Get memory limit in bytes (0 if unlimited)
extern fn rt_gc_memory_limit(gc: i64) -> i64

## Check if memory limit is enabled
extern fn rt_gc_is_limited(gc: i64) -> bool

## Get memory usage percentage (0.0-100.0)
extern fn rt_gc_memory_usage_percent(gc: i64) -> f64

## Get unique root count
extern fn rt_gc_unique_root_count() -> i64

## Get shared root count
extern fn rt_gc_shared_root_count() -> i64

## Get list of unique root pointers
extern fn rt_gc_get_unique_roots() -> [i64]

## Get list of shared root pointers
extern fn rt_gc_get_shared_roots() -> [i64]

# ============================================================================
# GC Operations
# ============================================================================

## Trigger garbage collection manually
## Returns number of bytes freed
extern fn rt_gc_collect(gc: i64, reason: text) -> i64

## Force garbage collection now (immediate, no checks)
extern fn rt_gc_force_collect(gc: i64) -> i64

## Register a unique root pointer
extern fn rt_gc_register_unique_root(ptr: i64)

## Unregister a unique root pointer
extern fn rt_gc_unregister_unique_root(ptr: i64)

## Register a shared root pointer
extern fn rt_gc_register_shared_root(ptr: i64)

## Unregister a shared root pointer
extern fn rt_gc_unregister_shared_root(ptr: i64)

# ============================================================================
# GC Allocation
# ============================================================================

## Allocate object on GC heap
## Returns pointer to allocated object
extern fn rt_gc_allocate(gc: i64, size: i64, type_id: i64) -> i64

## Try to allocate object (checks memory limit)
## Returns pointer on success, 0 on failure
extern fn rt_gc_try_allocate(gc: i64, size: i64, size_hint: i64, type_id: i64) -> i64

## Deallocate object (manual free, use with caution)
extern fn rt_gc_deallocate(gc: i64, ptr: i64)

# ============================================================================
# GC Control
# ============================================================================

## Enable/disable GC globally
extern fn rt_gc_set_enabled(enabled: bool)

## Check if GC is enabled
extern fn rt_gc_is_enabled() -> bool

## Set GC threshold (bytes of allocation before collection)
extern fn rt_gc_set_threshold(threshold_bytes: i64)

## Get current GC threshold
extern fn rt_gc_get_threshold() -> i64

## Set fail-on-exceeded behavior
extern fn rt_gc_set_fail_on_exceeded(gc: i64, fail: bool)

## Check if GC will fail on memory exceeded
extern fn rt_gc_get_fail_on_exceeded(gc: i64) -> bool

# ============================================================================
# Leak Detection
# ============================================================================

## Enable leak detection
extern fn rt_gc_enable_leak_detection(enabled: bool)

## Check if leak detection is enabled
extern fn rt_gc_leak_detection_enabled() -> bool

## Get leak detection window size (number of GC cycles)
extern fn rt_gc_leak_detection_window() -> i64

## Set leak detection window size
extern fn rt_gc_set_leak_detection_window(window_size: i64)

# ============================================================================
# Performance Tuning
# ============================================================================

## Set GC collection frequency (0.0-1.0, 0=never, 1=always)
extern fn rt_gc_set_collection_frequency(frequency: f64)

## Get current collection frequency
extern fn rt_gc_get_collection_frequency() -> f64

## Set minimum heap size before collection
extern fn rt_gc_set_min_heap_size(bytes: i64)

## Get minimum heap size
extern fn rt_gc_get_min_heap_size() -> i64

## Set maximum heap growth rate (factor, e.g., 2.0 = double)
extern fn rt_gc_set_max_heap_growth(factor: f64)

## Get maximum heap growth rate
extern fn rt_gc_get_max_heap_growth() -> f64

# ============================================================================
# Advanced Features
# ============================================================================

## Run finalizers for unreachable objects
extern fn rt_gc_run_finalizers(gc: i64) -> i64

## Get number of live objects
extern fn rt_gc_live_object_count(gc: i64) -> i64

## Get total bytes allocated (including freed)
extern fn rt_gc_total_allocated(gc: i64) -> i64

## Get total bytes freed
extern fn rt_gc_total_freed(gc: i64) -> i64

## Get number of collections performed
extern fn rt_gc_collection_count(gc: i64) -> i64

## Get average collection time (milliseconds)
extern fn rt_gc_average_collection_time(gc: i64) -> f64

## Get last collection time (milliseconds)
extern fn rt_gc_last_collection_time(gc: i64) -> f64

# ============================================================================
# Heap Inspection
# ============================================================================

## Dump heap statistics to string
extern fn rt_gc_dump_heap_stats(gc: i64) -> text

## Dump object graph to DOT format (GraphViz)
extern fn rt_gc_dump_object_graph(gc: i64, path: text) -> bool

## Find objects by type ID
extern fn rt_gc_find_objects_by_type(gc: i64, type_id: i64) -> [i64]

## Get object size
extern fn rt_gc_object_size(ptr: i64) -> i64

## Get object type ID
extern fn rt_gc_object_type(ptr: i64) -> i64

## Check if pointer is valid GC object
extern fn rt_gc_is_valid_object(gc: i64, ptr: i64) -> bool

# ============================================================================
# Concurrent GC (Future)
# ============================================================================

## Enable concurrent collection
extern fn rt_gc_set_concurrent(gc: i64, enabled: bool)

## Check if concurrent collection is enabled
extern fn rt_gc_is_concurrent(gc: i64) -> bool

## Set number of GC worker threads
extern fn rt_gc_set_worker_threads(count: i64)

## Get number of GC worker threads
extern fn rt_gc_get_worker_threads() -> i64

# ============================================================================
# FFI Generation Metadata
# ============================================================================

# @ffi-gen-target: build/rust/ffi_gen/src/gc.rs
# @ffi-gen-impl: rust/runtime/src/memory/gc.rs
# @ffi-gen-test: test/ffi/gc_spec.spl
# @ffi-gen-perf: test/perf/gc_perf.spl
# @ffi-gen-robust: test/robust/gc_robust.spl
