# Documentation Coverage Scanner - Main Module
# Coordinates file scanning, comment extraction, and declaration detection

use app.io.mod (file_read, file_exists)
use std.string.{NL}
use app.doc_coverage.scanner.comment_extractor.{extract_comments, associate_comments, extract_docstring}
use app.doc_coverage.scanner.file_scanner.{discover_source_files, filter_public_only}

# ============================================================================
# Data Types
# ============================================================================

# Simplified doc item for Phase 1
struct DocItem:
    name: text          # Function/struct/class name
    kind: text          # fn, struct, class, enum, val, var
    file: text          # File path
    line: i64           # Line number
    has_comment: bool   # Has preceding comment
    has_docstring: bool # Has docstring
    comment_text: text  # Comment content
    docstring_text: text # Docstring content

# ============================================================================
# File Scanning
# ============================================================================

# Scan a single file for documentation
fn scan_file_for_docs(file_path: text) -> [DocItem]:
    if not file_exists(file_path):
        return []

    val source = file_read(file_path)
    val lines = source.split(NL)

    # Extract all comments first
    val comment_result = extract_comments(source)
    val comment_lines = comment_result.0
    val comment_texts = comment_result.1

    var items: [DocItem] = []

    # Scan for declarations
    var line_num = 0
    for line in lines:
        line_num = line_num + 1
        val trimmed = line.trim()

        # Detect function declarations
        if trimmed.starts_with("fn "):
            val name = extract_fn_name(trimmed)
            if name.len() > 0:
                val assoc = associate_comments(comment_lines, comment_texts, line_num)
                val has_comment = assoc.0
                val comment_text = assoc.1
                val docstring = extract_docstring(source, line_num)
                val has_docstring = docstring.0
                val docstring_text = docstring.1

                items.push(DocItem(
                    name: name,
                    kind: "fn",
                    file: file_path,
                    line: line_num,
                    has_comment: has_comment,
                    has_docstring: has_docstring,
                    comment_text: comment_text,
                    docstring_text: docstring_text
                ))

        # Detect static function declarations
        if trimmed.starts_with("static fn "):
            val name = extract_fn_name(trimmed[7:])
            if name.len() > 0:
                val assoc = associate_comments(comment_lines, comment_texts, line_num)
                val has_comment = assoc.0
                val comment_text = assoc.1
                val docstring = extract_docstring(source, line_num)
                val has_docstring = docstring.0
                val docstring_text = docstring.1

                items.push(DocItem(
                    name: name,
                    kind: "static fn",
                    file: file_path,
                    line: line_num,
                    has_comment: has_comment,
                    has_docstring: has_docstring,
                    comment_text: comment_text,
                    docstring_text: docstring_text
                ))

        # Detect struct declarations
        if trimmed.starts_with("struct "):
            val name = extract_type_name(trimmed, "struct ")
            if name.len() > 0:
                val assoc = associate_comments(comment_lines, comment_texts, line_num)
                val has_comment = assoc.0
                val comment_text = assoc.1
                val docstring = extract_docstring(source, line_num)
                val has_docstring = docstring.0
                val docstring_text = docstring.1

                items.push(DocItem(
                    name: name,
                    kind: "struct",
                    file: file_path,
                    line: line_num,
                    has_comment: has_comment,
                    has_docstring: has_docstring,
                    comment_text: comment_text,
                    docstring_text: docstring_text
                ))

        # Detect class declarations
        if trimmed.starts_with("class "):
            val name = extract_type_name(trimmed, "class ")
            if name.len() > 0:
                val assoc = associate_comments(comment_lines, comment_texts, line_num)
                val has_comment = assoc.0
                val comment_text = assoc.1
                val docstring = extract_docstring(source, line_num)
                val has_docstring = docstring.0
                val docstring_text = docstring.1

                items.push(DocItem(
                    name: name,
                    kind: "class",
                    file: file_path,
                    line: line_num,
                    has_comment: has_comment,
                    has_docstring: has_docstring,
                    comment_text: comment_text,
                    docstring_text: docstring_text
                ))

        # Detect enum declarations
        if trimmed.starts_with("enum "):
            val name = extract_type_name(trimmed, "enum ")
            if name.len() > 0:
                val assoc = associate_comments(comment_lines, comment_texts, line_num)
                val has_comment = assoc.0
                val comment_text = assoc.1
                val docstring = extract_docstring(source, line_num)
                val has_docstring = docstring.0
                val docstring_text = docstring.1

                items.push(DocItem(
                    name: name,
                    kind: "enum",
                    file: file_path,
                    line: line_num,
                    has_comment: has_comment,
                    has_docstring: has_docstring,
                    comment_text: comment_text,
                    docstring_text: docstring_text
                ))

    items

# ============================================================================
# Name Extraction Helpers
# ============================================================================

# Extract function name from declaration line
fn extract_fn_name(line: text) -> text:
    val trimmed = line.trim()
    # Remove "fn " prefix if present
    var rest = trimmed
    if rest.starts_with("fn "):
        rest = rest[3:]

    # Find first '(' or ':'
    val paren_idx = rest.index_of("(") ?? 999999
    val colon_idx = rest.index_of(":") ?? 999999
    val end_idx = if paren_idx < colon_idx: paren_idx else: colon_idx

    if end_idx == 999999:
        return ""

    val name = rest[0:end_idx]
    name.trim()

# Extract type name from declaration line
fn extract_type_name(line: text, prefix: text) -> text:
    val trimmed = line.trim()
    if not trimmed.starts_with(prefix):
        return ""

    val after_prefix = trimmed[prefix.len():]
    # Find first ':' or '<' (for generics)
    val colon_idx = after_prefix.index_of(":") ?? 999999
    val angle_idx = after_prefix.index_of("<") ?? 999999
    val end_idx = if colon_idx < angle_idx: colon_idx else: angle_idx

    if end_idx == 999999:
        return ""

    val name = after_prefix[0:end_idx]
    name.trim()

# ============================================================================
# Exports
# ============================================================================

export DocItem
export scan_file_for_docs
export discover_source_files
export filter_public_only
