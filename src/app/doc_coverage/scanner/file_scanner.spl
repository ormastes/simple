# File Discovery and Filtering for Doc Coverage

use app.io.mod (dir_walk, is_dir)

# ============================================================================
# File Discovery
# ============================================================================

# Discover all source files matching patterns
fn discover_source_files(root: text, patterns: [text]) -> [text]:
    var results: [text] = []

    # Default scan directories (public API only)
    val scan_dirs = ["src/std", "src/core", "src/app", "src/lib"]

    for scan_dir in scan_dirs:
        val full_path = "{root}/{scan_dir}"
        if not is_dir(full_path):
            continue

        val walked = dir_walk(full_path)
        for f in walked:
            if should_include_file(f, patterns):
                results.push(f)

    results

# Check if file matches any pattern
fn should_include_file(path: text, patterns: [text]) -> bool:
    # Must be .spl file
    if not path.ends_with(".spl"):
        return false

    # Skip test files
    if path.contains("/test/"):
        return false
    if path.ends_with("_spec.spl"):
        return false

    # Skip build artifacts
    if path.contains("/target/"):
        return false
    if path.contains("/build/"):
        return false
    if path.contains("/.git/"):
        return false

    # Skip archived/deprecated code
    if path.contains("/archive/"):
        return false
    if path.contains("/deprecated/"):
        return false

    # If patterns provided, must match at least one
    if patterns.len() > 0:
        var matched = false
        for pattern in patterns:
            if path.contains(pattern):
                matched = true
        if not matched:
            return false

    true

# ============================================================================
# Public API Filtering
# ============================================================================

# Filter to only public API files
fn filter_public_only(files: [text]) -> [text]:
    var results: [text] = []

    for f in files:
        if is_public_api_file(f):
            results.push(f)

    results

# Check if file is part of public API
fn is_public_api_file(path: text) -> bool:
    # Public API directories
    if path.contains("/src/std/"):
        return true
    if path.contains("/src/core/"):
        return true
    if path.contains("/src/lib/"):
        return true

    # Select app modules (public CLI tools)
    if path.contains("/src/app/cli/"):
        return true
    if path.contains("/src/app/io/"):
        return true

    # Exclude internal implementation details
    if path.contains("/src/app/interpreter/"):
        return false
    if path.contains("/src/app/desugar/"):
        return false
    if path.contains("/src/compiler/"):
        return false

    false

# ============================================================================
# Exports
# ============================================================================

export discover_source_files
export filter_public_only
export should_include_file
export is_public_api_file
