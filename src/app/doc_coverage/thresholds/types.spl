# Doc Coverage Threshold Types
#
# Data structures for coverage threshold configuration and results.

struct ThresholdConfig:
    default_threshold: i64
    scope_names: [text]
    scope_values: [i64]
    exclusions: [text]
    enforce: bool
    fail_on_below: bool
    public_api_group_threshold: i64
    public_api_item_threshold: i64
    enforce_public_api_at_build: bool

fn threshold_config_default() -> ThresholdConfig:
    ThresholdConfig(
        default_threshold: 70,
        scope_names: [],
        scope_values: [],
        exclusions: [],
        enforce: false,
        fail_on_below: false,
        public_api_group_threshold: 80,
        public_api_item_threshold: 90,
        enforce_public_api_at_build: false
    )

fn threshold_config_get(config: ThresholdConfig, scope: text) -> i64:
    # Find matching scope threshold
    var idx = 0
    val scope_count = config.scope_names.len()
    while idx < scope_count:
        val name = config.scope_names[idx]
        if scope.starts_with(name):
            return config.scope_values[idx]
        idx = idx + 1
    return config.default_threshold

struct ScopeCoverage:
    scope: text
    threshold: i64
    actual: i64
    passed: bool
    total_items: i64
    covered_items: i64
    missing_items: [text]

fn scope_coverage_create(
    scope: text,
    threshold: i64,
    total: i64,
    covered: i64,
    missing: [text]
) -> ScopeCoverage:
    var actual_pct = 0
    if total > 0:
        actual_pct = (covered * 100) / total

    val is_passed = actual_pct >= threshold

    ScopeCoverage(
        scope: scope,
        threshold: threshold,
        actual: actual_pct,
        passed: is_passed,
        total_items: total,
        covered_items: covered,
        missing_items: missing
    )

fn scope_coverage_to_text(cov: ScopeCoverage) -> text:
    val status = if cov.passed: "PASS" else: "FAIL"
    val pct_str = "{cov.actual}%"
    val threshold_str = "{cov.threshold}%"
    val items_str = "{cov.covered_items}/{cov.total_items}"

    "[{status}] {cov.scope}: {pct_str} (threshold: {threshold_str}, items: {items_str})"

export threshold_config_default
export threshold_config_get
export scope_coverage_create
export scope_coverage_to_text
