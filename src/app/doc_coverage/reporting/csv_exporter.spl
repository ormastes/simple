# CSV exporter for documentation coverage
#
# Exports coverage data in CSV format for spreadsheet analysis.

use doc_coverage.types.doc_item.{DocItem}
use std.string.{NL}

# Export doc items as CSV
# Flat structure: one row per item
fn export_coverage_csv(items: [DocItem]) -> text:
    var csv = "name,file,line,kind,is_public,has_sdoctest,has_inline_comment,tags{NL}"

    var i = 0
    while i < items.len():
        val item = items[i]
        val row = _item_to_csv_row(item)
        csv = "{csv}{row}{NL}"

        i = i + 1

    csv

fn _item_to_csv_row(item: DocItem) -> text:
    # Escape CSV fields
    val name = _escape_csv_field(item.name)
    val file = _escape_csv_field(item.file)
    val line = "{item.line}"
    val kind = item.kind_str()
    val is_public = _bool_to_csv(item.is_public)
    val has_sdoctest = _bool_to_csv(item.has_sdoctest)
    val has_inline = _bool_to_csv(item.has_inline_comment)

    # Combine tags into pipe-separated string
    val tags = _tags_to_csv(item.sdoctest_tags)

    "{name},{file},{line},{kind},{is_public},{has_sdoctest},{has_inline},{tags}"

fn _escape_csv_field(field: text) -> text:
    # Escape CSV field - quote if contains comma, quote, or newline
    var needs_quote = false

    if field.contains(","):
        needs_quote = true
    if field.contains("\""):
        needs_quote = true
    if field.contains("\n"):
        needs_quote = true

    if needs_quote:
        # Escape existing quotes by doubling them
        val escaped = field.replace("\"", "\"\"")
        "\"{escaped}\""
    else:
        field

fn _bool_to_csv(b: bool) -> text:
    if b:
        "true"
    else:
        "false"

fn _tags_to_csv(tags: [text]) -> text:
    # Convert tag array to pipe-separated string
    if tags.len() == 0:
        return ""

    var result = ""
    var i = 0
    while i < tags.len():
        val tag = tags[i]

        if i > 0:
            result = "{result}|{tag}"
        else:
            result = tag

        i = i + 1

    _escape_csv_field(result)

export export_coverage_csv
