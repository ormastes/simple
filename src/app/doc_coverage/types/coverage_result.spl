# Coverage report types for documentation analysis

use doc_item.{DocItem}

# Coverage statistics for a single file
struct FileCoverage:
    file_path: text
    total_items: i64
    documented_items: i64
    missing_docs: i64
    has_sdoctest: i64
    missing_sdoctest: i64
    items: [DocItem]

impl FileCoverage:
    static fn create(file_path: text) -> FileCoverage:
        FileCoverage(
            file_path: file_path,
            total_items: 0,
            documented_items: 0,
            missing_docs: 0,
            has_sdoctest: 0,
            missing_sdoctest: 0,
            items: []
        )

    fn coverage_percent() -> f64:
        if self.total_items == 0:
            return 100.0
        val documented = self.documented_items
        val total = self.total_items
        val ratio = documented / total
        ratio * 100.0

    fn sdoctest_percent() -> f64:
        val public_funcs = self._count_public_functions()
        if public_funcs == 0:
            return 100.0
        val has_tests = self.has_sdoctest
        val ratio = has_tests / public_funcs
        ratio * 100.0

    fn _count_public_functions() -> i64:
        var count = 0
        val items = self.items
        for item in items:
            val needs_test = item.needs_sdoctest()
            if needs_test:
                count = count + 1
        count

# Overall coverage report for the entire codebase
struct CoverageReport:
    files: [FileCoverage]
    total_items: i64
    documented_items: i64
    missing_docs: i64
    sdoctest_coverage: i64
    missing_sdoctest: i64
    timestamp: i64

impl CoverageReport:
    static fn create() -> CoverageReport:
        CoverageReport(
            files: [],
            total_items: 0,
            documented_items: 0,
            missing_docs: 0,
            sdoctest_coverage: 0,
            missing_sdoctest: 0,
            timestamp: 0
        )

    fn overall_percent() -> f64:
        if self.total_items == 0:
            return 100.0
        val documented = self.documented_items
        val total = self.total_items
        val ratio = documented / total
        ratio * 100.0

    fn sdoctest_percent() -> f64:
        val total_testable = self._count_total_public_functions()
        if total_testable == 0:
            return 100.0
        val has_tests = self.sdoctest_coverage
        val ratio = has_tests / total_testable
        ratio * 100.0

    fn _count_total_public_functions() -> i64:
        var count = 0
        val files = self.files
        for file in files:
            val items = file.items
            for item in items:
                val needs_test = item.needs_sdoctest()
                if needs_test:
                    count = count + 1
        count

export FileCoverage, CoverageReport
