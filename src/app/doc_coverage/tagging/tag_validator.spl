# Tag Validation and Normalization
#
# Validates and normalizes documentation coverage tags.

# ============================================================================
# Tag Validation
# ============================================================================

fn validate_tag(tag: text) -> bool:
    # Validate tag format: "category:value"
    # - Must contain exactly one colon
    # - Category and value must be non-empty
    # - Only lowercase letters, numbers, and underscores allowed

    val colon_idx = tag.index_of(":") ?? -1
    if colon_idx < 0:
        return false

    # Check for only one colon
    val after_colon = tag[colon_idx + 1:]
    val second_colon = after_colon.index_of(":") ?? -1
    if second_colon >= 0:
        return false

    # Extract category and value
    val category = tag[0:colon_idx]
    val value = after_colon

    # Both must be non-empty
    if category.len() == 0:
        return false
    if value.len() == 0:
        return false

    # Validate category characters
    val category_valid = _is_valid_tag_part(category)
    if not category_valid:
        return false

    # Validate value characters
    val value_valid = _is_valid_tag_part(value)
    if not value_valid:
        return false

    true

fn _is_valid_tag_part(part: text) -> bool:
    # Check if tag part contains only lowercase, numbers, underscores
    var i = 0
    while i < part.len():
        val ch = part[i:i + 1]

        val is_lowercase = ch >= "a" and ch <= "z"
        val is_digit = ch >= "0" and ch <= "9"
        val is_underscore = ch == "_"

        val is_valid = is_lowercase or is_digit or is_underscore
        if not is_valid:
            return false

        i = i + 1

    true

# ============================================================================
# Tag Normalization
# ============================================================================

fn normalize_tag(tag: text) -> text:
    # Normalize tag to lowercase with underscores
    # - Convert to lowercase
    # - Replace spaces and hyphens with underscores
    # - Remove invalid characters

    var normalized = tag.to_lower()

    # Replace spaces with underscores
    normalized = normalized.replace(" ", "_")

    # Replace hyphens with underscores
    normalized = normalized.replace("-", "_")

    # Remove invalid characters
    normalized = _remove_invalid_chars(normalized)

    normalized

fn _remove_invalid_chars(s: text) -> text:
    # Remove characters that aren't lowercase, digit, underscore, or colon
    var result = ""

    var i = 0
    while i < s.len():
        val ch = s[i:i + 1]

        val is_lowercase = ch >= "a" and ch <= "z"
        val is_digit = ch >= "0" and ch <= "9"
        val is_underscore = ch == "_"
        val is_colon = ch == ":"

        val is_valid = is_lowercase or is_digit or is_underscore or is_colon
        if is_valid:
            result = result + ch

        i = i + 1

    result

# ============================================================================
# Tag Category Validation
# ============================================================================

fn is_valid_category(category: text) -> bool:
    # Check if category is a known valid category
    if category == "coverage":
        return true
    if category == "doc":
        return true
    if category == "scope":
        return true
    if category == "api":
        return true
    if category == "kind":
        return true
    if category == "group_comment":
        return true
    if category == "var_group":
        return true
    false

fn extract_category(tag: text) -> text:
    # Extract category from tag
    val colon_idx = tag.index_of(":") ?? -1
    if colon_idx < 0:
        return ""
    tag[0:colon_idx]

fn extract_value(tag: text) -> text:
    # Extract value from tag
    val colon_idx = tag.index_of(":") ?? -1
    if colon_idx < 0:
        return ""
    tag[colon_idx + 1:]

# ============================================================================
# Tag Set Validation
# ============================================================================

fn validate_tag_set(tags: [text]) -> (bool, [text]):
    # Validate a set of tags
    # Returns (all_valid, invalid_tags)

    var invalid_tags: [text] = []
    var all_valid = true

    var i = 0
    while i < tags.len():
        val tag = tags[i]
        val is_valid = validate_tag(tag)

        if not is_valid:
            all_valid = false
            invalid_tags.push(tag)

        i = i + 1

    (all_valid, invalid_tags)

fn normalize_tag_set(tags: [text]) -> [text]:
    # Normalize all tags in a set
    var normalized: [text] = []

    var i = 0
    while i < tags.len():
        val tag = tags[i]
        val norm_tag = normalize_tag(tag)
        normalized.push(norm_tag)
        i = i + 1

    normalized

# ============================================================================
# Duplicate Detection
# ============================================================================

fn remove_duplicate_tags(tags: [text]) -> [text]:
    # Remove duplicate tags from a list
    var unique: [text] = []

    var i = 0
    while i < tags.len():
        val tag = tags[i]

        # Check if already in unique list
        var exists = false
        var j = 0
        while j < unique.len():
            if unique[j] == tag:
                exists = true
            j = j + 1

        if not exists:
            unique.push(tag)

        i = i + 1

    unique

# ============================================================================
# Exports
# ============================================================================

export validate_tag
export normalize_tag
export is_valid_category
export extract_category
export extract_value
export validate_tag_set
export normalize_tag_set
export remove_duplicate_tags
