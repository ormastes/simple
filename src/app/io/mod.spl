# Shared I/O module for CLI apps
# Wraps common FFI functions so apps can import instead of declaring extern fn

# --- File operations ---

extern fn rt_file_exists(path: text) -> bool
extern fn rt_file_read_text(path: text) -> text
extern fn rt_file_write_text(path: text, content: text) -> bool
extern fn rt_file_copy(src: text, dst: text) -> bool
extern fn rt_file_delete(path: text) -> bool
extern fn rt_file_atomic_write(path: text, content: text) -> bool

fn file_exists(path: text) -> bool:
    rt_file_exists(path)

fn file_read(path: text) -> text:
    rt_file_read_text(path)

fn file_write(path: text, content: text) -> bool:
    rt_file_write_text(path, content)

fn file_copy(src: text, dst: text) -> bool:
    rt_file_copy(src, dst)

fn file_delete(path: text) -> bool:
    rt_file_delete(path)

fn file_atomic_write(path: text, content: text) -> bool:
    rt_file_atomic_write(path, content)

# --- Directory operations ---

extern fn rt_dir_create(path: text, recursive: bool) -> bool
extern fn rt_dir_walk(path: text) -> [text]
extern fn rt_dir_create_all(path: text) -> bool
extern fn rt_package_remove_dir_all(path: text) -> i32
extern fn rt_package_is_dir(path: text) -> i32

fn dir_create(path: text, recursive: bool) -> bool:
    rt_dir_create(path, recursive)

fn dir_create_all(path: text) -> bool:
    rt_dir_create_all(path)

fn dir_walk(path: text) -> [text]:
    rt_dir_walk(path)

fn dir_remove_all(path: text) -> i32:
    rt_package_remove_dir_all(path)

fn is_dir(path: text) -> bool:
    rt_package_is_dir(path) == 1

# --- Environment operations ---

extern fn rt_env_cwd() -> text
extern fn rt_env_home() -> text
extern fn rt_env_get(key: text) -> text

fn cwd() -> text:
    rt_env_cwd()

fn home() -> text:
    rt_env_home()

fn env_get(key: text) -> text:
    rt_env_get(key)

# --- Package/file metadata ---

extern fn rt_package_file_size(path: text) -> i64

fn file_size(path: text) -> i64:
    rt_package_file_size(path)

# --- Process execution ---

extern fn rt_process_run(cmd: text, args: [text]) -> (text, text, i64)
extern fn rt_process_run_timeout(cmd: text, args: [text], timeout_ms: i64) -> (text, text, i32)

fn process_run(cmd: text, args: [text]) -> (text, text, i64):
    rt_process_run(cmd, args)

fn process_run_timeout(cmd: text, args: [text], timeout_ms: i64) -> (text, text, i32):
    rt_process_run_timeout(cmd, args, timeout_ms)

# --- CLI delegation wrappers (Rust-backed commands) ---

extern fn rt_cli_run_replay(args: [str]) -> i64
extern fn rt_cli_run_constr(args: [str]) -> i64
extern fn rt_cli_run_check(args: [str]) -> i64
extern fn rt_cli_handle_compile(args: [str]) -> i64
extern fn rt_cli_run_todo_scan(args: [str]) -> i64
extern fn rt_cli_run_gen_lean(args: [str]) -> i64
extern fn rt_cli_run_info(args: [str]) -> i64
extern fn rt_process_output(cmd: text, args: [text]) -> text

fn cli_replay(args: [str]) -> i64:
    rt_cli_run_replay(args)

fn cli_constr(args: [str]) -> i64:
    rt_cli_run_constr(args)

fn cli_check(args: [str]) -> i64:
    rt_cli_run_check(args)

fn cli_compile(args: [str]) -> i64:
    rt_cli_handle_compile(args)

fn cli_todo_scan(args: [str]) -> i64:
    rt_cli_run_todo_scan(args)

fn cli_gen_lean(args: [str]) -> i64:
    rt_cli_run_gen_lean(args)

fn cli_info(args: [str]) -> i64:
    rt_cli_run_info(args)

fn process_output(cmd: text, args: [text]) -> text:
    rt_process_output(cmd, args)

# --- Output ---

extern fn rt_eprintln(msg: text)

fn eprintln(msg: text):
    rt_eprintln(msg)

# --- File extended operations ---

extern fn rt_file_append_text(path: text, content: text) -> bool
extern fn rt_file_modified_time(path: text) -> i64
extern fn rt_file_remove(path: text) -> bool
extern fn rt_file_hash_sha256(path: text) -> text
extern fn rt_file_read_lines(path: text) -> [text]?
extern fn rt_file_lock(path: text, timeout_secs: i64) -> i64
extern fn rt_file_unlock(handle: i64) -> bool

fn file_append(path: text, content: text) -> bool:
    rt_file_append_text(path, content)

fn file_modified_time(path: text) -> i64:
    rt_file_modified_time(path)

fn file_remove(path: text) -> bool:
    rt_file_remove(path)

fn file_hash_sha256(path: text) -> text:
    rt_file_hash_sha256(path)

fn file_read_lines(path: text) -> [text]?:
    rt_file_read_lines(path)

fn file_lock(path: text, timeout_secs: i64) -> i64:
    rt_file_lock(path, timeout_secs)

fn file_unlock(handle: i64) -> bool:
    rt_file_unlock(handle)

# --- Directory extended operations ---

extern fn rt_dir_list(path: text) -> [text]
extern fn rt_dir_remove(path: text, recursive: bool) -> bool

fn dir_list(path: text) -> [text]:
    rt_dir_list(path)

fn dir_remove(path: text, recursive: bool) -> bool:
    rt_dir_remove(path, recursive)

# --- Time operations ---

extern fn rt_time_now_unix_micros() -> i64
extern fn _current_time_unix() -> i64

fn time_now_unix_micros() -> i64:
    rt_time_now_unix_micros()

fn current_time_unix() -> i64:
    _current_time_unix()

# --- System info ---

extern fn rt_getpid() -> i64
extern fn rt_hostname() -> text
extern fn rt_system_cpu_count() -> i64
extern fn rt_path_basename(path: text) -> text

fn getpid() -> i64:
    rt_getpid()

fn hostname() -> text:
    rt_hostname()

fn cpu_count() -> i64:
    rt_system_cpu_count()

fn path_basename(path: text) -> text:
    rt_path_basename(path)

# --- Timestamp operations ---

extern fn rt_timestamp_get_year(micros: i64) -> i32
extern fn rt_timestamp_get_month(micros: i64) -> i32
extern fn rt_timestamp_get_day(micros: i64) -> i32
extern fn rt_timestamp_get_hour(micros: i64) -> i32
extern fn rt_timestamp_get_minute(micros: i64) -> i32
extern fn rt_timestamp_get_second(micros: i64) -> i32

fn timestamp_year(micros: i64) -> i32:
    rt_timestamp_get_year(micros)

fn timestamp_month(micros: i64) -> i32:
    rt_timestamp_get_month(micros)

fn timestamp_day(micros: i64) -> i32:
    rt_timestamp_get_day(micros)

fn timestamp_hour(micros: i64) -> i32:
    rt_timestamp_get_hour(micros)

fn timestamp_minute(micros: i64) -> i32:
    rt_timestamp_get_minute(micros)

fn timestamp_second(micros: i64) -> i32:
    rt_timestamp_get_second(micros)

# --- Environment extended ---

extern fn rt_env_set(key: text, value: text) -> bool

fn env_set(key: text, value: text) -> bool:
    rt_env_set(key, value)

# --- Process extended ---

extern fn rt_process_run_with_limits(cmd: text, args: [text], timeout_ms: i64, memory_bytes: i64, cpu_seconds: i64, max_fds: i64, max_procs: i64) -> (text, text, i32)
extern fn rt_shell(command: text) -> text

fn process_run_with_limits(cmd: text, args: [text], timeout_ms: i64, memory_bytes: i64, cpu_seconds: i64, max_fds: i64, max_procs: i64) -> (text, text, i32):
    rt_process_run_with_limits(cmd, args, timeout_ms, memory_bytes, cpu_seconds, max_fds, max_procs)

fn shell(command: text) -> text:
    rt_shell(command)

# --- System utilities ---

extern fn sys_get_args() -> [String]
extern fn sys_exit(code: i64)
extern fn rt_cli_get_args() -> [str]
extern fn rt_cli_exit(code: i64)
extern fn rt_cli_file_exists(path: str) -> bool

fn get_args() -> [String]:
    sys_get_args()

fn exit(code: i64):
    sys_exit(code)

fn cli_get_args() -> [str]:
    rt_cli_get_args()

fn cli_exit(code: i64):
    rt_cli_exit(code)

fn cli_file_exists(path: str) -> bool:
    rt_cli_file_exists(path)

# --- CLI delegation wrappers (additional) ---

extern fn rt_cli_run_code(code: str, gc_log: bool, gc_off: bool) -> i64
extern fn rt_cli_run_file(path: str, args: [str], gc_log: bool, gc_off: bool) -> i64
extern fn rt_cli_watch_file(path: str) -> i64
extern fn rt_cli_run_repl(gc_log: bool, gc_off: bool) -> i64
extern fn rt_cli_run_tests(args: [str], gc_log: bool, gc_off: bool) -> i64
extern fn rt_cli_run_lint(args: [str]) -> i64
extern fn rt_cli_run_fmt(args: [str]) -> i64
extern fn rt_cli_run_fix(args: [str]) -> i64
extern fn rt_cli_run_verify(args: [str], gc_log: bool, gc_off: bool) -> i64
extern fn rt_cli_run_migrate(args: [str]) -> i64
extern fn rt_cli_run_mcp(args: [str]) -> i64
extern fn rt_cli_run_diff(args: [str]) -> i64
extern fn rt_cli_run_query(args: [str]) -> i64
extern fn rt_cli_run_spec_coverage(args: [str]) -> i64
extern fn rt_cli_run_gen_lean(args: [str]) -> i64
extern fn rt_cli_run_feature_gen(args: [str]) -> i64
extern fn rt_cli_run_task_gen(args: [str]) -> i64
extern fn rt_cli_run_spec_gen(args: [str]) -> i64
extern fn rt_cli_run_sspec_docgen(args: [str]) -> i64
extern fn rt_cli_run_todo_gen(args: [str]) -> i64
extern fn rt_cli_run_lex(args: [str]) -> i64
extern fn rt_cli_run_brief(args: [str]) -> i64
extern fn rt_cli_run_ffi_gen(args: [str]) -> i64
extern fn rt_cli_run_i18n(args: [str]) -> i64
extern fn rt_cli_handle_web(args: [str]) -> i64
extern fn rt_cli_handle_diagram(args: [str]) -> i64
extern fn rt_cli_handle_run(args: [str], gc_log: bool, gc_off: bool) -> i64
extern fn rt_cli_handle_linkers() -> i64
extern fn rt_cli_read_file(path: str) -> str
extern fn rt_context_generate(path: str, target: str, format: str) -> str
extern fn rt_context_stats(path: str, target: str) -> str
extern fn rt_settlement_main() -> i64
extern fn rt_fault_set_stack_overflow_detection(enabled: bool)
extern fn rt_fault_set_max_recursion_depth(depth: i64)
extern fn rt_fault_set_timeout(secs: i64)
extern fn rt_fault_set_execution_limit(limit: i64)

fn cli_run_code(code: str, gc_log: bool, gc_off: bool) -> i64:
    rt_cli_run_code(code, gc_log, gc_off)

fn cli_run_file(path: str, args: [str], gc_log: bool, gc_off: bool) -> i64:
    rt_cli_run_file(path, args, gc_log, gc_off)

fn cli_watch_file(path: str) -> i64:
    rt_cli_watch_file(path)

fn cli_run_repl(gc_log: bool, gc_off: bool) -> i64:
    rt_cli_run_repl(gc_log, gc_off)

fn cli_run_tests(args: [str], gc_log: bool, gc_off: bool) -> i64:
    rt_cli_run_tests(args, gc_log, gc_off)

fn cli_run_lint(args: [str]) -> i64:
    rt_cli_run_lint(args)

fn cli_run_fmt(args: [str]) -> i64:
    rt_cli_run_fmt(args)

fn cli_run_fix(args: [str]) -> i64:
    rt_cli_run_fix(args)

fn cli_run_verify(args: [str], gc_log: bool, gc_off: bool) -> i64:
    rt_cli_run_verify(args, gc_log, gc_off)

fn cli_run_migrate(args: [str]) -> i64:
    rt_cli_run_migrate(args)

fn cli_run_mcp(args: [str]) -> i64:
    rt_cli_run_mcp(args)

fn cli_run_diff(args: [str]) -> i64:
    rt_cli_run_diff(args)

fn cli_run_query(args: [str]) -> i64:
    rt_cli_run_query(args)

fn cli_run_spec_coverage(args: [str]) -> i64:
    rt_cli_run_spec_coverage(args)

fn cli_run_feature_gen(args: [str]) -> i64:
    rt_cli_run_feature_gen(args)

fn cli_run_task_gen(args: [str]) -> i64:
    rt_cli_run_task_gen(args)

fn cli_run_spec_gen(args: [str]) -> i64:
    rt_cli_run_spec_gen(args)

fn cli_run_sspec_docgen(args: [str]) -> i64:
    rt_cli_run_sspec_docgen(args)

fn cli_run_todo_gen(args: [str]) -> i64:
    rt_cli_run_todo_gen(args)

fn cli_run_lex(args: [str]) -> i64:
    rt_cli_run_lex(args)

fn cli_run_brief(args: [str]) -> i64:
    rt_cli_run_brief(args)

fn cli_run_ffi_gen(args: [str]) -> i64:
    rt_cli_run_ffi_gen(args)

fn cli_run_i18n(args: [str]) -> i64:
    rt_cli_run_i18n(args)

fn cli_handle_web(args: [str]) -> i64:
    rt_cli_handle_web(args)

fn cli_handle_diagram(args: [str]) -> i64:
    rt_cli_handle_diagram(args)

fn cli_handle_run(args: [str], gc_log: bool, gc_off: bool) -> i64:
    rt_cli_handle_run(args, gc_log, gc_off)

fn cli_handle_linkers() -> i64:
    rt_cli_handle_linkers()

fn cli_read_file(path: str) -> str:
    rt_cli_read_file(path)

fn context_generate(path: str, target: str, format: str) -> str:
    rt_context_generate(path, target, format)

fn context_stats(path: str, target: str) -> str:
    rt_context_stats(path, target)

fn settlement_main() -> i64:
    rt_settlement_main()

fn fault_set_stack_overflow_detection(enabled: bool):
    rt_fault_set_stack_overflow_detection(enabled)

fn fault_set_max_recursion_depth(depth: i64):
    rt_fault_set_max_recursion_depth(depth)

fn fault_set_timeout(secs: i64):
    rt_fault_set_timeout(secs)

fn fault_set_execution_limit(limit: i64):
    rt_fault_set_execution_limit(limit)

# --- Cargo build system ---

extern fn rt_cargo_build(profile: text, features: [text], feature_count: i64) -> dict
extern fn rt_cargo_test(package: text, filter: text) -> dict
extern fn rt_cargo_test_doc(package: text) -> dict
extern fn rt_cargo_clean() -> i64
extern fn rt_cargo_check() -> dict
extern fn rt_cargo_lint(fix: i64) -> dict
extern fn rt_cargo_fmt(check_only: i64) -> dict

fn cargo_build(profile: text, features: [text], feature_count: i64) -> dict:
    rt_cargo_build(profile, features, feature_count)

fn cargo_test(package: text, filter: text) -> dict:
    rt_cargo_test(package, filter)

fn cargo_test_doc(package: text) -> dict:
    rt_cargo_test_doc(package)

fn cargo_clean() -> i64:
    rt_cargo_clean()

fn cargo_check() -> dict:
    rt_cargo_check()

fn cargo_lint(fix: i64) -> dict:
    rt_cargo_lint(fix)

fn cargo_fmt(check_only: i64) -> dict:
    rt_cargo_fmt(check_only)

# --- Coverage ---

extern fn rt_coverage_dump_sdn() -> text
extern fn rt_coverage_enabled() -> bool
extern fn rt_coverage_clear()

fn coverage_dump_sdn() -> text:
    rt_coverage_dump_sdn()

fn coverage_enabled() -> bool:
    rt_coverage_enabled()

fn coverage_clear():
    rt_coverage_clear()

# --- Misc build/test ---

extern fn rt_file_size(path: text) -> i64
extern fn rt_current_time_ms() -> i64
extern fn rt_glob(pattern: text) -> [text]
extern fn rt_shell_exec(cmd: text) -> i64
extern fn rt_read_file(path: text) -> text
extern fn rt_write_file(path: text, content: text) -> bool

fn file_size_raw(path: text) -> i64:
    rt_file_size(path)

fn current_time_ms() -> i64:
    rt_current_time_ms()

fn glob(pattern: text) -> [text]:
    rt_glob(pattern)

fn shell_exec(cmd: text) -> i64:
    rt_shell_exec(cmd)

fn read_file(path: text) -> text:
    rt_read_file(path)

fn write_file(path: text, content: text) -> bool:
    rt_write_file(path, content)

# --- Exports ---

# File operations
export file_exists, file_read, file_write, file_copy, file_delete, file_atomic_write
export file_append, file_modified_time, file_remove, file_hash_sha256, file_read_lines
export file_lock, file_unlock, file_size, file_size_raw

# Directory operations
export dir_create, dir_create_all, dir_walk, dir_remove_all, is_dir
export dir_list, dir_remove

# Environment operations
export cwd, home, env_get, env_set

# Process execution
export process_run, process_run_timeout, process_run_with_limits
export process_output, shell

# Time operations
export time_now_unix_micros, current_time_unix, current_time_ms
export timestamp_year, timestamp_month, timestamp_day
export timestamp_hour, timestamp_minute, timestamp_second

# System info
export getpid, hostname, cpu_count, path_basename

# System utilities
export get_args, exit, cli_get_args, cli_exit, cli_file_exists

# CLI delegation wrappers
export cli_replay, cli_constr, cli_check, cli_compile, cli_todo_scan, cli_gen_lean, cli_info
export cli_run_code, cli_run_file, cli_watch_file, cli_run_repl, cli_run_tests
export cli_run_lint, cli_run_fmt, cli_run_fix, cli_run_verify, cli_run_migrate
export cli_run_mcp, cli_run_diff, cli_run_query, cli_run_spec_coverage
export cli_run_feature_gen, cli_run_task_gen, cli_run_spec_gen, cli_run_sspec_docgen
export cli_run_todo_gen, cli_run_lex, cli_run_brief, cli_run_ffi_gen, cli_run_i18n
export cli_handle_web, cli_handle_diagram, cli_handle_run, cli_handle_linkers
export cli_read_file

# Context and settlement
export context_generate, context_stats, settlement_main

# Fault handling
export fault_set_stack_overflow_detection, fault_set_max_recursion_depth
export fault_set_timeout, fault_set_execution_limit

# Cargo build system
export cargo_build, cargo_test, cargo_test_doc, cargo_clean
export cargo_check, cargo_lint, cargo_fmt

# Coverage
export coverage_dump_sdn, coverage_enabled, coverage_clear

# Misc utilities
export glob, shell_exec, read_file, write_file

# Output
export eprintln
