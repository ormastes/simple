# I/O Hub Module - Backward Compatibility Shim
#
# SFFI wrappers have moved to src/lib/nogc_sync_mut/io/ (Phase 0 migration).
# This shim re-exports everything from the new locations so existing
# `use app.io.{...}` imports continue working during gradual transition.
#
# New code should import from `use std.nogc_sync_mut.io.X.{...}` directly.
#
# @tag:api

# ============================================================================
# Re-imports from std.nogc_sync_mut.io.* (moved SFFI wrappers)
# ============================================================================

# File operations
use std.nogc_sync_mut.io.file_ops.{file_exists, file_read, file_write, file_copy, file_delete, file_atomic_write}
use std.nogc_sync_mut.io.file_ops.{file_append, file_modified_time, file_stat, file_remove, file_hash_sha256, file_read_lines}
use std.nogc_sync_mut.io.file_ops.{file_lock, file_unlock, file_size, file_size_raw}
use std.nogc_sync_mut.io.file_ops.{file_read_text, file_read_bytes, file_mmap_read_text, file_mmap_read_bytes}
use std.nogc_sync_mut.io.file_ops.{rt_file_rename}

# Directory operations
use std.nogc_sync_mut.io.dir_ops.{dir_create, dir_create_all, dir_walk, dir_remove_all, is_dir}
use std.nogc_sync_mut.io.dir_ops.{dir_list, dir_remove}

# Process operations
use std.nogc_sync_mut.io.process_ops.{ProcessResult}
use std.nogc_sync_mut.io.process_ops.{process_run, process_run_timeout, process_run_with_limits}
use std.nogc_sync_mut.io.process_ops.{process_output, shell}
use std.nogc_sync_mut.io.process_ops.{shell_bool, shell_output, shell_output_trimmed, shell_lines, shell_int}
use std.nogc_sync_mut.io.process_ops.{eprint}

# Process limit enforcer
use std.nogc_sync_mut.io.process_limit_enforcer.{build_ulimit_command, build_timeout_wrapper}
use std.nogc_sync_mut.io.process_limit_enforcer.{detect_violation, detect_violation_from_profile, format_violation_message}
use std.nogc_sync_mut.io.process_limit_enforcer.{supports_ulimit, get_ulimit_flags}
use std.nogc_sync_mut.io.process_limit_enforcer.{bytes_to_kb, ms_to_seconds, profile_to_ulimit_params}

# Environment operations
use std.nogc_sync_mut.io.env_ops.{env_get, env_set, cwd, home, env_vars}
use std.nogc_sync_mut.io.env_ops.{host_arch, host_os}

# Time operations
use std.nogc_sync_mut.io.time_ops.{time_now_unix_micros, current_time_unix, current_time_ms}
use std.nogc_sync_mut.io.time_ops.{timestamp_year, timestamp_month, timestamp_day}
use std.nogc_sync_mut.io.time_ops.{timestamp_hour, timestamp_minute, timestamp_second}
use std.nogc_sync_mut.io.time_ops.{rt_timestamp_now, rt_sleep_ms}

# System info
use std.nogc_sync_mut.io.sysinfo_ops.{getpid, hostname, cpu_count, path_basename}

# Volatile memory operations
use std.nogc_sync_mut.io.volatile_ops.{volatile_read_u8, volatile_read_u16, volatile_read_u32, volatile_read_u64}
use std.nogc_sync_mut.io.volatile_ops.{volatile_write_u8, volatile_write_u16, volatile_write_u32, volatile_write_u64}
use std.nogc_sync_mut.io.volatile_ops.{memory_barrier, load_barrier, store_barrier}
use std.nogc_sync_mut.io.volatile_ops.{volatile_read_modify_write_u32}

# Debug stubs
use std.nogc_sync_mut.io.debug_stubs.{rt_debug_set_active, rt_hook_enable_debugging}
use std.nogc_sync_mut.io.debug_stubs.{rt_debug_add_breakpoint_at, rt_debug_remove_breakpoint_at}
use std.nogc_sync_mut.io.debug_stubs.{rt_debug_continue_exec, rt_debug_pause_exec, rt_debug_set_step_mode_val}
use std.nogc_sync_mut.io.debug_stubs.{rt_debug_stack_trace_lines, rt_debug_local_vars}
use std.nogc_sync_mut.io.debug_stubs.{rt_debug_get_current_file, rt_debug_get_current_line, rt_debug_run_file_debug}
use std.nogc_sync_mut.io.debug_stubs.{rt_debug_add_breakpoint_rich, rt_debug_add_function_breakpoint}
use std.nogc_sync_mut.io.debug_stubs.{rt_debug_set_breakpoint_enabled, rt_debug_get_breakpoint_info}
use std.nogc_sync_mut.io.debug_stubs.{rt_debug_list_breakpoints, rt_debug_get_pending_condition, rt_debug_report_condition_result}
use std.nogc_sync_mut.io.debug_stubs.{rt_debug_select_frame, rt_debug_get_selected_frame, rt_debug_frame_locals}
use std.nogc_sync_mut.io.debug_stubs.{rt_debug_get_source_lines}
use std.nogc_sync_mut.io.debug_stubs.{rt_debug_add_watch, rt_debug_remove_watch, rt_debug_list_watches}
use std.nogc_sync_mut.io.debug_stubs.{rt_debug_set_variable, rt_debug_eval_expression, rt_debug_terminate}
use std.nogc_sync_mut.io.debug_stubs.{rt_fault_set_stack_overflow_detection, rt_fault_set_max_recursion_depth}
use std.nogc_sync_mut.io.debug_stubs.{rt_fault_set_timeout, rt_fault_set_execution_limit}
use std.nogc_sync_mut.io.debug_stubs.{atomic_i64_new, atomic_bool_new}
use std.nogc_sync_mut.io.debug_stubs.{rt_vulkan_is_available, upx_is_available}

# String helpers
use std.nogc_sync_mut.io.string_helpers.{hex_to_char, byte_to_char, char_code}
use std.nogc_sync_mut.io.string_helpers.{text_hash_native}


# Thread management
use std.nogc_sync_mut.io.thread.{thread_available_parallelism, thread_sleep_ms, thread_yield, thread_current_id}
use std.nogc_sync_mut.io.thread.{atomic_i64_load, atomic_i64_store, atomic_i64_fetch_add, atomic_i64_compare_exchange}

# Math (advanced functions from moved module)
use std.nogc_sync_mut.io.math.{math_log, math_log10, math_log2}
use std.nogc_sync_mut.io.math.{math_asin, math_acos, math_atan, math_atan2}
use std.nogc_sync_mut.io.math.{math_sinh, math_cosh, math_tanh}
use std.nogc_sync_mut.io.math.{math_ceil, math_floor, math_round}

# ============================================================================
# CLI imports (remain in app/io/)
# ============================================================================

use app.io.cli_ops.{get_args, exit, cli_get_args, cli_exit, cli_file_exists}
use app.io.cli_ops.{cli_read_file, context_generate, context_stats, settlement_main}
use app.io.cli_ops.{fault_set_stack_overflow_detection, fault_set_max_recursion_depth}
use app.io.cli_ops.{fault_set_timeout, fault_set_execution_limit}

use app.io.cli_commands.{cli_run_code, cli_run_file, cli_watch_file, cli_run_repl, cli_run_tests}
use app.io.cli_commands.{cli_run_lint, cli_run_fmt, cli_run_fix, cli_run_verify, cli_run_migrate}
use app.io.cli_commands.{cli_run_mcp, cli_run_lsp, cli_run_diff, cli_run_query, cli_run_spec_coverage}
use app.io.cli_commands.{cli_run_feature_gen, cli_run_task_gen, cli_run_spec_gen, cli_run_sspec_docgen, cli_run_feature_doc}
use app.io.cli_commands.{cli_run_todo_gen, cli_run_lex, cli_run_brief, cli_run_ffi_gen, cli_run_i18n}
use app.io.cli_commands.{cli_handle_web, cli_handle_diagram, cli_handle_run, cli_handle_compile, cli_handle_linkers}
use app.io.cli_commands.{cli_replay, cli_constr, cli_check, cli_info}
use app.io.cli_commands.{cli_todo_scan, cli_gen_lean}

use app.io.cli_compile.{cli_compile, compile_baremetal, compile_vhdl}

# JIT (remains in app/io/)
use app.io.jit_ffi.{jit_available, set_jit_backend, get_jit_backend}
use app.io.jit_ffi.{exec_manager_create, exec_manager_compile, exec_manager_execute}
use app.io.jit_ffi.{exec_manager_has_function, exec_manager_backend_name, exec_manager_cleanup}

# ============================================================================
# Hub-local functions (kept here for backward compatibility)
# ============================================================================

# Platform detection
extern fn rt_env_get(key: text) -> text

fn is_windows_platform() -> bool:
    val os_env = rt_env_get("OS")
    if os_env == nil:
        false
    else:
        os_env.lower().contains("windows")

# Random number generation
extern fn rt_random_uniform(min: f64, max: f64) -> f64
extern fn rt_random_randint(min: i64, max: i64) -> i64

fn random_uniform(min: f64, max: f64) -> f64:
    rt_random_uniform(min, max)

fn random_randint(min: i64, max: i64) -> i64:
    rt_random_randint(min, max)

# Logging
extern fn rt_log_emit(level: i64, scope_ptr: i64, scope_len: i64, msg_ptr: i64, msg_len: i64)
extern fn rt_log_get_global_level() -> i64
extern fn rt_log_set_global_level(level: i64)
extern fn rt_log_get_scope_level(scope_ptr: i64, scope_len: i64) -> i64
extern fn rt_log_set_scope_level(scope_ptr: i64, scope_len: i64, level: i64)
extern fn rt_log_is_enabled(level: i64, scope_ptr: i64, scope_len: i64) -> i64
extern fn rt_log_clear_scope_levels()

fn log_emit(level: i64, scope_ptr: i64, scope_len: i64, msg_ptr: i64, msg_len: i64):
    rt_log_emit(level, scope_ptr, scope_len, msg_ptr, msg_len)

fn log_get_global_level() -> i64:
    rt_log_get_global_level()

fn log_set_global_level(level: i64):
    rt_log_set_global_level(level)

fn log_get_scope_level(scope_ptr: i64, scope_len: i64) -> i64:
    rt_log_get_scope_level(scope_ptr, scope_len)

fn log_set_scope_level(scope_ptr: i64, scope_len: i64, level: i64):
    rt_log_set_scope_level(scope_ptr, scope_len, level)

fn log_is_enabled(level: i64, scope_ptr: i64, scope_len: i64) -> i64:
    rt_log_is_enabled(level, scope_ptr, scope_len)

fn log_clear_scope_levels():
    rt_log_clear_scope_levels()

# Thread sleep alias
fn thread_sleep(millis: i64):
    thread_sleep_ms(millis)

# Math functions (bc-based shell calculations)
fn shell_bc_calc(bc_expr: text, default: f64) -> f64:
    val result = shell("echo '{bc_expr}' | bc -l")
    if result.exit_code == 0:
        result.stdout.trim().to_float_or(default)
    else:
        default

fn math_exp(x: f64) -> f64:
    shell_bc_calc("e({x})", 0.0)

fn math_ln(x: f64) -> f64:
    if x <= 0.0:
        return -999999.0
    shell_bc_calc("l({x})", 0.0)

fn math_sqrt(x: f64) -> f64:
    if x < 0.0:
        return 0.0
    shell_bc_calc("sqrt({x})", 0.0)

fn math_cos(x: f64) -> f64:
    shell_bc_calc("c({x})", 0.0)

fn math_sin(x: f64) -> f64:
    shell_bc_calc("s({x})", 0.0)


fn math_random() -> f64:
    val result = shell("od -An -N4 -tu4 /dev/urandom | awk '{print $1}'")
    if result.exit_code == 0:
        val trimmed_rand = result.stdout.trim()
        var rand_int = 0
        if trimmed_rand.len() > 0:
            rand_int = int(trimmed_rand)
        rand_int / 4294967296.0
    else:
        0.5

# Volatile memory access
extern fn rt_read_volatile_i64(addr: i64) -> i64
extern fn rt_write_volatile_i64(addr: i64, value: i64)

fn read_volatile(addr: i64) -> i64:
    rt_read_volatile_i64(addr)

fn write_volatile(addr: i64, value: i64):
    rt_write_volatile_i64(addr, value)

# ============================================================================
# All re-exports (backward compatibility)
# ============================================================================

# Volatile memory
export volatile_read_u8, volatile_read_u16, volatile_read_u32, volatile_read_u64
export volatile_write_u8, volatile_write_u16, volatile_write_u32, volatile_write_u64
export memory_barrier, load_barrier, store_barrier
export volatile_read_modify_write_u32

# Debug stubs
export rt_debug_set_active, rt_hook_enable_debugging
export rt_debug_add_breakpoint_at, rt_debug_remove_breakpoint_at
export rt_debug_continue_exec, rt_debug_pause_exec, rt_debug_set_step_mode_val
export rt_debug_stack_trace_lines, rt_debug_local_vars
export rt_debug_get_current_file, rt_debug_get_current_line, rt_debug_run_file_debug
export rt_debug_add_breakpoint_rich, rt_debug_add_function_breakpoint
export rt_debug_set_breakpoint_enabled, rt_debug_get_breakpoint_info
export rt_debug_list_breakpoints, rt_debug_get_pending_condition, rt_debug_report_condition_result
export rt_debug_select_frame, rt_debug_get_selected_frame, rt_debug_frame_locals
export rt_debug_get_source_lines
export rt_debug_add_watch, rt_debug_remove_watch, rt_debug_list_watches
export rt_debug_set_variable, rt_debug_eval_expression, rt_debug_terminate
export rt_fault_set_stack_overflow_detection, rt_fault_set_max_recursion_depth
export rt_fault_set_timeout, rt_fault_set_execution_limit
export atomic_i64_new, atomic_bool_new
export rt_vulkan_is_available, upx_is_available

# String helpers
export hex_to_char, byte_to_char, char_code

# File operations
export file_exists, file_read, file_write, file_copy, file_delete, file_atomic_write
export file_append, file_modified_time, file_remove, file_hash_sha256, file_read_lines
export file_lock, file_unlock, file_size, file_size_raw
export rt_file_rename
export file_read_text, file_read_bytes, file_mmap_read_text, file_mmap_read_bytes

# Time operations
export rt_sleep_ms
export rt_timestamp_now
export time_now_unix_micros, current_time_unix, current_time_ms
export timestamp_year, timestamp_month, timestamp_day
export timestamp_hour, timestamp_minute, timestamp_second

# Directory operations
export dir_create, dir_create_all, dir_walk, dir_remove_all, is_dir
export dir_list, dir_remove

# Environment operations
export cwd, home, env_get, env_set
export host_arch, host_os
export env_vars

# Process operations
export ProcessResult
export process_run, process_run_timeout, process_run_with_limits
export process_output, shell
export shell_bool, shell_output, shell_output_trimmed, shell_lines, shell_int
export eprint

# Process limit enforcer
export build_ulimit_command, build_timeout_wrapper
export detect_violation, detect_violation_from_profile, format_violation_message
export supports_ulimit, get_ulimit_flags
export bytes_to_kb, ms_to_seconds, profile_to_ulimit_params

# System info
export getpid, hostname, cpu_count, path_basename

# CLI operations
export get_args, exit, cli_get_args, cli_exit, cli_file_exists
export cli_replay, cli_constr, cli_check, cli_compile, cli_todo_scan, cli_gen_lean, cli_info
export cli_run_code, cli_run_file, cli_watch_file, cli_run_repl, cli_run_tests
export cli_run_lint, cli_run_fmt, cli_run_fix, cli_run_verify, cli_run_migrate
export cli_run_mcp, cli_run_lsp, cli_run_diff, cli_run_query, cli_run_spec_coverage
export cli_run_feature_gen, cli_run_task_gen, cli_run_spec_gen, cli_run_sspec_docgen, cli_run_feature_doc
export cli_run_todo_gen, cli_run_lex, cli_run_brief, cli_run_ffi_gen, cli_run_i18n
export cli_handle_web, cli_handle_diagram, cli_handle_run, cli_handle_compile, cli_handle_linkers
export cli_read_file, context_generate, context_stats, settlement_main
export fault_set_stack_overflow_detection, fault_set_max_recursion_depth
export fault_set_timeout, fault_set_execution_limit
export compile_baremetal, compile_vhdl

# Hub-local exports
export math_exp, math_ln, math_sqrt, math_cos, math_sin, math_random
export math_log, math_log10, math_log2
export math_asin, math_acos, math_atan, math_atan2
export math_sinh, math_cosh, math_tanh
export math_ceil, math_floor, math_round
export random_uniform, random_randint
export log_emit, log_get_global_level, log_set_global_level
export log_get_scope_level, log_set_scope_level
export log_is_enabled, log_clear_scope_levels
export thread_available_parallelism, thread_sleep_ms, thread_yield, thread_current_id
export atomic_i64_load, atomic_i64_store, atomic_i64_fetch_add, atomic_i64_compare_exchange
export thread_sleep
export jit_available
export is_windows_platform
export read_volatile, write_volatile
