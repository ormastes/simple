#!/usr/bin/env simple
# FTP/FTPS Client SFFI Wrapper
#
# Two-tier SFFI pattern for FTP and FTPS (FTP over TLS) operations.
# Supports file upload/download, directory listing, and secure connections.
#
# Rust crate: suppaftp (https://docs.rs/suppaftp/)

use app.io.sffi_common.{is_valid_handle, is_invalid_handle}

# ============================================================================
# Tier 1: Extern Declarations (Raw FFI)
# ============================================================================

# --- Connection Management ---

extern fn rt_ftp_connect(host: text, port: i64) -> i64
extern fn rt_ftp_connect_secure(host: text, port: i64) -> i64  # FTPS (TLS)
extern fn rt_ftp_login(conn: i64, username: text, password: text) -> bool
extern fn rt_ftp_disconnect(conn: i64) -> bool
extern fn rt_ftp_quit(conn: i64) -> bool

# --- Directory Operations ---

extern fn rt_ftp_pwd(conn: i64) -> text
extern fn rt_ftp_cwd(conn: i64, path: text) -> bool
extern fn rt_ftp_cdup(conn: i64) -> bool
extern fn rt_ftp_mkdir(conn: i64, dirname: text) -> bool
extern fn rt_ftp_rmdir(conn: i64, dirname: text) -> bool
extern fn rt_ftp_list(conn: i64, path: text) -> text  # Newline-separated list

# --- File Operations ---

extern fn rt_ftp_get(conn: i64, remote_file: text, local_file: text) -> bool
extern fn rt_ftp_put(conn: i64, local_file: text, remote_file: text) -> bool
extern fn rt_ftp_append(conn: i64, local_file: text, remote_file: text) -> bool
extern fn rt_ftp_delete(conn: i64, filename: text) -> bool
extern fn rt_ftp_rename(conn: i64, from: text, to: text) -> bool
extern fn rt_ftp_size(conn: i64, filename: text) -> i64
extern fn rt_ftp_mdtm(conn: i64, filename: text) -> text  # Modification time

# --- Transfer Settings ---

extern fn rt_ftp_set_mode_passive(conn: i64) -> bool
extern fn rt_ftp_set_mode_active(conn: i64) -> bool
extern fn rt_ftp_set_transfer_type_binary(conn: i64) -> bool
extern fn rt_ftp_set_transfer_type_ascii(conn: i64) -> bool

# --- Status ---

extern fn rt_ftp_noop(conn: i64) -> bool  # Keep-alive
extern fn rt_ftp_get_welcome_msg(conn: i64) -> text
extern fn rt_ftp_is_connected(conn: i64) -> bool

# ============================================================================
# Tier 2: Simple-Friendly Wrapper Functions
# ============================================================================

# --- Core Types ---

struct FtpConnection:
    handle: i64
    host: text
    port: i64
    is_secure: bool
    is_valid: bool

enum TransferType:
    Binary
    ASCII

enum TransferMode:
    Passive
    Active

# --- Connection Management ---

fn ftp_connect(host: text, port: i64) -> FtpConnection:
    """Connect to FTP server (insecure)

    Args:
        host: FTP server hostname
        port: Port number (usually 21)

    Returns: FtpConnection (check is_valid)

    Example:
        conn = ftp_connect("ftp.example.com", 21)
        if conn.is_valid:
            ftp_login(conn, "user", "pass")
    """
    val handle = rt_ftp_connect(host, port)
    FtpConnection(handle: handle, host: host, port: port, is_secure: false, is_valid: is_valid_handle(handle))

fn ftp_connect_secure(host: text, port: i64) -> FtpConnection:
    """Connect to FTPS server (TLS encrypted)

    Args:
        host: FTPS server hostname
        port: Port number (usually 990 for implicit TLS, 21 for explicit)

    Returns: FtpConnection with TLS encryption

    Example:
        conn = ftp_connect_secure("ftps.example.com", 990)
    """
    val handle = rt_ftp_connect_secure(host, port)
    FtpConnection(handle: handle, host: host, port: port, is_secure: true, is_valid: is_valid_handle(handle))

fn ftp_login(conn: FtpConnection, username: text, password: text) -> bool:
    """Login to FTP server

    Args:
        conn: FTP connection
        username: Username (use "anonymous" for anonymous FTP)
        password: Password (use email for anonymous FTP)

    Returns: true if login successful

    Example:
        if ftp_login(conn, "user", "pass"):
            print "Logged in successfully"
    """
    if is_invalid_handle(conn.handle):
        return false

    rt_ftp_login(conn.handle, username, password)

fn ftp_disconnect(conn: FtpConnection) -> bool:
    """Disconnect from FTP server"""
    if is_invalid_handle(conn.handle):
        return false

    rt_ftp_disconnect(conn.handle)

fn ftp_quit(conn: FtpConnection) -> bool:
    """Send QUIT command and disconnect gracefully"""
    if is_invalid_handle(conn.handle):
        return false

    rt_ftp_quit(conn.handle)

# --- Directory Operations ---

fn ftp_pwd(conn: FtpConnection) -> text:
    """Get current working directory

    Returns: Current directory path

    Example:
        dir = ftp_pwd(conn)
        print "Current directory: {dir}"
    """
    if is_invalid_handle(conn.handle):
        return ""

    rt_ftp_pwd(conn.handle)

fn ftp_cwd(conn: FtpConnection, path: text) -> bool:
    """Change working directory

    Args:
        path: Directory path

    Returns: true if successful
    """
    if is_invalid_handle(conn.handle):
        return false

    rt_ftp_cwd(conn.handle, path)

fn ftp_cdup(conn: FtpConnection) -> bool:
    """Change to parent directory"""
    if is_invalid_handle(conn.handle):
        return false

    rt_ftp_cdup(conn.handle)

fn ftp_mkdir(conn: FtpConnection, dirname: text) -> bool:
    """Create directory on server"""
    if is_invalid_handle(conn.handle):
        return false

    rt_ftp_mkdir(conn.handle, dirname)

fn ftp_rmdir(conn: FtpConnection, dirname: text) -> bool:
    """Remove directory from server"""
    if is_invalid_handle(conn.handle):
        return false

    rt_ftp_rmdir(conn.handle, dirname)

fn ftp_list(conn: FtpConnection, path: text) -> [text]:
    """List files in directory

    Args:
        path: Directory path (empty for current dir)

    Returns: Array of filenames/directory entries

    Example:
        files = ftp_list(conn, "/pub")
        for file in files:
            print file
    """
    if is_invalid_handle(conn.handle):
        return []

    val result = rt_ftp_list(conn.handle, path)
    if result == "":
        return []

    result.split("\n")

# --- File Operations ---

fn ftp_download(conn: FtpConnection, remote_file: text, local_file: text) -> bool:
    """Download file from server

    Args:
        remote_file: Path on FTP server
        local_file: Local file path to save

    Returns: true if successful

    Example:
        if ftp_download(conn, "report.pdf", "/tmp/report.pdf"):
            print "Download successful"
    """
    if is_invalid_handle(conn.handle):
        return false

    rt_ftp_get(conn.handle, remote_file, local_file)

fn ftp_upload(conn: FtpConnection, local_file: text, remote_file: text) -> bool:
    """Upload file to server

    Args:
        local_file: Local file to upload
        remote_file: Destination path on server

    Returns: true if successful

    Example:
        if ftp_upload(conn, "/tmp/data.txt", "data.txt"):
            print "Upload successful"
    """
    if is_invalid_handle(conn.handle):
        return false

    rt_ftp_put(conn.handle, local_file, remote_file)

fn ftp_append(conn: FtpConnection, local_file: text, remote_file: text) -> bool:
    """Append local file to remote file"""
    if is_invalid_handle(conn.handle):
        return false

    rt_ftp_append(conn.handle, local_file, remote_file)

fn ftp_delete(conn: FtpConnection, filename: text) -> bool:
    """Delete file on server"""
    if is_invalid_handle(conn.handle):
        return false

    rt_ftp_delete(conn.handle, filename)

fn ftp_rename(conn: FtpConnection, from_name: text, to_name: text) -> bool:
    """Rename file on server"""
    if is_invalid_handle(conn.handle):
        return false

    rt_ftp_rename(conn.handle, from_name, to_name)

fn ftp_size(conn: FtpConnection, filename: text) -> i64:
    """Get file size in bytes

    Returns: File size, or -1 on error
    """
    if is_invalid_handle(conn.handle):
        return -1

    rt_ftp_size(conn.handle, filename)

fn ftp_get_modify_time(conn: FtpConnection, filename: text) -> text:
    """Get file modification time

    Returns: Timestamp string (FTP format: YYYYMMDDhhmmss)
    """
    if is_invalid_handle(conn.handle):
        return ""

    rt_ftp_mdtm(conn.handle, filename)

# --- Transfer Settings ---

fn ftp_set_passive_mode(conn: FtpConnection) -> bool:
    """Enable passive mode (recommended for firewalls)"""
    if is_invalid_handle(conn.handle):
        return false

    rt_ftp_set_mode_passive(conn.handle)

fn ftp_set_active_mode(conn: FtpConnection) -> bool:
    """Enable active mode"""
    if is_invalid_handle(conn.handle):
        return false

    rt_ftp_set_mode_active(conn.handle)

fn ftp_set_binary_mode(conn: FtpConnection) -> bool:
    """Set binary transfer mode (for images, executables, etc.)"""
    if is_invalid_handle(conn.handle):
        return false

    rt_ftp_set_transfer_type_binary(conn.handle)

fn ftp_set_ascii_mode(conn: FtpConnection) -> bool:
    """Set ASCII transfer mode (for text files)"""
    if is_invalid_handle(conn.handle):
        return false

    rt_ftp_set_transfer_type_ascii(conn.handle)

# --- Status Functions ---

fn ftp_noop(conn: FtpConnection) -> bool:
    """Send NOOP command (keep-alive)"""
    if is_invalid_handle(conn.handle):
        return false

    rt_ftp_noop(conn.handle)

fn ftp_get_welcome(conn: FtpConnection) -> text:
    """Get server welcome message"""
    if is_invalid_handle(conn.handle):
        return ""

    rt_ftp_get_welcome_msg(conn.handle)

fn ftp_is_connected(conn: FtpConnection) -> bool:
    """Check if connection is still alive"""
    if is_invalid_handle(conn.handle):
        return false

    rt_ftp_is_connected(conn.handle)

# ============================================================================
# Export Functions
# ============================================================================

export FtpConnection, TransferType, TransferMode
export ftp_connect, ftp_connect_secure, ftp_login, ftp_disconnect, ftp_quit
export ftp_pwd, ftp_cwd, ftp_cdup, ftp_mkdir, ftp_rmdir, ftp_list
export ftp_download, ftp_upload, ftp_append, ftp_delete, ftp_rename
export ftp_size, ftp_get_modify_time
export ftp_set_passive_mode, ftp_set_active_mode
export ftp_set_binary_mode, ftp_set_ascii_mode
export ftp_noop, ftp_get_welcome, ftp_is_connected
