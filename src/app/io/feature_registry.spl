# Feature Registry â€” runtime DI for optional I/O capabilities
#
# Typed port registry with noop defaults.
# Call init_features() at startup to probe and register available features.
#
# GPU priority: CUDA > Vulkan > noop (first available wins)

use app.io.feature_ports.{GpuComputePort, AudioPort, WindowPort}
use std.gc_async_mut.io.cuda_ffi.{cuda_available, make_cuda_port}
use std.gc_async_mut.io.vulkan_ffi.{vulkan_available, make_vulkan_port}
use std.nogc_sync_mut.io.audio_ffi.{audio_available}
use std.nogc_sync_mut.io.window_ffi.{window_available}

var _gpu = nil
var _audio = nil
var _window = nil

# ============================================================================
# Noop port factories (fallbacks when feature is unavailable)
# ============================================================================

fn noop_gpu_port() -> GpuComputePort:
    GpuComputePort(
        name: "none",
        is_available_fn: \: false,
        device_count_fn: \: 0,
        device_name_fn: \id: "unavailable",
        alloc_fn: \size: 0,
        free_fn: \ptr: true,
        sync_fn: \: true
    )

fn noop_audio_port() -> AudioPort:
    AudioPort(
        name: "none",
        is_available_fn: \: false,
        init_fn: \: 0,
        shutdown_fn: \handle: true
    )

fn noop_window_port() -> WindowPort:
    WindowPort(
        name: "none",
        is_available_fn: \: false
    )

# ============================================================================
# Registration
# ============================================================================

fn register_gpu(port: GpuComputePort):
    _gpu = port

fn register_audio(port: AudioPort):
    _audio = port

fn register_window(port: WindowPort):
    _window = port

# ============================================================================
# Port accessors (return noop default if not registered)
# ============================================================================

fn gpu_port() -> GpuComputePort:
    _gpu ?? noop_gpu_port()

fn audio_port() -> AudioPort:
    _audio ?? noop_audio_port()

fn window_port() -> WindowPort:
    _window ?? noop_window_port()

# ============================================================================
# Feature initialization (call once at program startup)
# ============================================================================

fn init_features():
    if cuda_available():
        register_gpu(make_cuda_port())
    elif vulkan_available():
        register_gpu(make_vulkan_port())
    # else: noop_gpu_port is the default

export register_gpu, register_audio, register_window
export gpu_port, audio_port, window_port
export noop_gpu_port, noop_audio_port, noop_window_port
export init_features
