# Simple CLI - diff command
# Semantic diff between Simple source files

use app.cli_util (get_cli_args)
use app.io.mod (file_exists, file_read)
use std.text.{NL}
use std.log.{error, warn, info, debug}

fn print_help():
    print "Usage: simple diff <old-file> <new-file> [options]"
    print ""
    print "Show differences between two Simple source files."
    print ""
    print "Options:"
    print "  --unified    Unified diff format (default)"
    print "  --stat       Show only statistics"
    print "  --context=N  Lines of context (default: 3)"
    print "  -h, --help   Show this help"

fn compute_diff(old_lines: [text], new_lines: [text], context: i64) -> [text]:
    var result = []
    val max_len = if old_lines.len() > new_lines.len(): old_lines.len() else: new_lines.len()
    var i = 0

    while i < max_len:
        val old_line = if i < old_lines.len(): old_lines[i] else: ""
        val new_line = if i < new_lines.len(): new_lines[i] else: ""

        if old_line != new_line:
            if i < old_lines.len():
                result.push("- {old_line}")
            if i < new_lines.len():
                result.push("+ {new_line}")
        i = i + 1

    result

fn main() -> i64:
    val args = get_cli_args()

    var old_path = ""
    var new_path = ""
    var stat_only = false
    var context = 3

    for arg in args:
        if arg == "-h" or arg == "--help":
            print_help()
            return 0
        elif arg == "--stat":
            stat_only = true
        elif arg.starts_with("--context="):
            context = arg[10:].to_int()
        elif arg == "--unified":
            pass
        elif not arg.starts_with("-"):
            if old_path == "":
                old_path = arg
            else:
                new_path = arg

    if old_path == "" or new_path == "":
        error("diff", "two files required")
        print ""
        print_help()
        return 1

    if not file_exists(old_path):
        error("diff", "file not found: {old_path}")
        return 1
    if not file_exists(new_path):
        error("diff", "file not found: {new_path}")
        return 1

    val old_content = file_read(old_path)
    val new_content = file_read(new_path)

    val old_lines = old_content.split(NL)
    val new_lines = new_content.split(NL)

    if stat_only:
        var added = 0
        var removed = 0
        var changed = 0
        val max_len = if old_lines.len() > new_lines.len(): old_lines.len() else: new_lines.len()
        var i = 0
        while i < max_len:
            val old_line = if i < old_lines.len(): old_lines[i] else: ""
            val new_line = if i < new_lines.len(): new_lines[i] else: ""
            if old_line != new_line:
                if i >= old_lines.len():
                    added = added + 1
                elif i >= new_lines.len():
                    removed = removed + 1
                else:
                    changed = changed + 1
            i = i + 1
        print "{old_path} -> {new_path}"
        print "  {added} additions, {removed} deletions, {changed} modifications"
        return 0

    # Unified diff output
    print "--- {old_path}"
    print "+++ {new_path}"

    val diff_lines = compute_diff(old_lines, new_lines, context)
    if diff_lines.len() == 0:
        print "Files are identical."
    else:
        for line in diff_lines:
            print line

    0
