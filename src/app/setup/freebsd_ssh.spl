# Simple (.spl) replacement for scripts/configure_freebsd_vm_ssh.sh
#
# Configure SSH in FreeBSD VM (One-Time Setup)
# Automates the initial SSH configuration for FreeBSD VM.
# Run this once before using --qemu-freebsd bootstrap.

use app.io.mod.{shell, shell_bool, env_get, file_exists, exit, get_args}

fn main():
    val args = get_args()
    var port = "2222"
    if args.len() > 0:
        port = args[0]

    print "================================================================"
    print "  FreeBSD VM SSH Configuration"
    print "================================================================"
    print ""
    print "This script will configure SSH access to the FreeBSD VM."
    print "VM must be running on port {port}"
    print ""

    # Check if VM is running
    val vm_check = shell_bool("nc -z localhost {port} 2>/dev/null")
    if vm_check == false:
        val home = env_get("HOME")
        print "ERROR: No VM found on port {port}"
        print ""
        print "Start the VM first with:"
        print "  {home}/vms/freebsd/start-freebsd-daemon.sh"
        print ""
        print "Or manually:"
        print "  qemu-system-x86_64 \\"
        print "    -machine accel=kvm:tcg \\"
        print "    -cpu host -m 4G -smp 4 \\"
        print "    -drive file=build/freebsd/vm/FreeBSD-14.3-RELEASE-amd64.qcow2,format=qcow2,if=virtio \\"
        print "    -net nic,model=virtio \\"
        print "    -net user,hostfwd=tcp::{port}-:22 \\"
        print "    -display none \\"
        print "    -daemonize \\"
        print "    -pidfile /tmp/freebsd-qemu.pid"
        exit(1)

    print "VM detected on port {port}"
    print ""

    # Generate SSH key if needed
    val home = env_get("HOME")
    val ssh_key = "{home}/.ssh/simple_freebsd_vm"
    if file_exists(ssh_key) == false:
        print "Generating SSH key: {ssh_key}"
        shell("ssh-keygen -t ed25519 -f '{ssh_key}' -N '' -C 'simple-freebsd-vm'")
        print ""

    # Instructions for manual configuration
    print "================================================================"
    print "  Manual Configuration Required (One-Time, ~2 minutes)"
    print "================================================================"
    print ""
    print "The FreeBSD VM requires initial setup via console."
    print ""
    print "1. Connect to VM console:"
    print "   - The VM is running in the background"
    print "   - You need to connect to its serial console"
    print ""
    print "2. Login:"
    print "   - Username: root"
    print "   - Password: (press Enter - no password by default)"
    print ""
    print "3. Run these commands:"
    print ""
    print "   # Enable SSH daemon"
    print r"   echo 'sshd_enable=""YES""' >> /etc/rc.conf"
    print "   service sshd start"
    print ""
    print "   # Set root password (or press Enter for no password)"
    print "   passwd"
    print ""
    print "   # Create freebsd user"
    print "   pw useradd -n freebsd -m -s /bin/sh -G wheel"
    print "   passwd freebsd"
    print ""
    print "   # Enable passwordless sudo"
    print "   pkg install -y sudo"
    print "   echo '%wheel ALL=(ALL) NOPASSWD: ALL' >> /usr/local/etc/sudoers"
    print ""
    print "   # Install required packages"
    print "   pkg install -y cmake gmake git"
    print ""
    print "4. Exit and test:"
    print "   exit"
    print ""
    print "   # Test SSH connection"
    print "   ssh -p PORT freebsd@localhost"
    print ""
    print "================================================================"
    print ""
    print "ALTERNATIVE: Use cross-compilation (no VM setup needed)"
    print "========================================================"
    print ""
    print "If you prefer not to configure the VM, you can build for FreeBSD"
    print "using cross-compilation:"
    print ""
    print "  # Cross-compile FreeBSD seed compiler (already working)"
    print "  cd build/freebsd"
    print "  cmake -S ../../seed -B . \\"
    print "    -DCMAKE_SYSTEM_NAME=FreeBSD \\"
    print "    -DCMAKE_SYSTEM_PROCESSOR=x86_64 \\"
    print "    -DCMAKE_C_COMPILER=clang \\"
    print "    -DCMAKE_CXX_COMPILER=clang++ \\"
    print "    -DCMAKE_SYSROOT=/opt/sysroots/freebsd-x86_64"
    print ""
    print "  make -j$(nproc)"
    print ""
    print "  # Result: FreeBSD seed compiler at build/freebsd/seed_cpp"
    print ""

    # Provide simplified one-liner for testing SSH
    print ""
    print "To test SSH after configuration:"
    print "  ssh -o StrictHostKeyChecking=no -p {port} freebsd@localhost 'echo SSH works'"
    print ""

main()
