# Test Runner Output Formatting
#
# Format test results for display in various styles.

use lib.json.builder.{escape_json}
use std.string.{NL}

# =========================================================================
# Status Constants Reference (use inline values)
# =========================================================================
#
# Test Status:
#   PENDING=0, RUNNING=1, PASSED=2, FAILED=3, SKIPPED=4, TIMEOUT=5, CRASHED=6
#
# Format styles:
#   FORMAT_SIMPLE=0, FORMAT_VERBOSE=1, FORMAT_DOC=2, FORMAT_JSON=3, FORMAT_JUNIT=4

# =========================================================================
# Status Formatting
# =========================================================================

fn format_status(status: i32) -> text:
    if status == 0:       # TEST_STATUS_PENDING
        "[    ]"
    elif status == 1:     # TEST_STATUS_RUNNING
        "[....]"
    elif status == 2:     # TEST_STATUS_PASSED
        "[PASS]"
    elif status == 3:     # TEST_STATUS_FAILED
        "[FAIL]"
    elif status == 4:     # TEST_STATUS_SKIPPED
        "[SKIP]"
    elif status == 5:     # TEST_STATUS_TIMEOUT
        "[TIME]"
    elif status == 6:     # TEST_STATUS_CRASHED
        "[BOOM]"
    else:
        "[????]"

fn format_status_colored(status: i32) -> text:
    # ANSI color codes
    val RESET = "\x1b[0m"
    val GREEN = "\x1b[32m"
    val RED = "\x1b[31m"
    val YELLOW = "\x1b[33m"
    val GRAY = "\x1b[90m"

    if status == 2:       # TEST_STATUS_PASSED
        "{GREEN}[PASS]{RESET}"
    elif status == 3:     # TEST_STATUS_FAILED
        "{RED}[FAIL]{RESET}"
    elif status == 4:     # TEST_STATUS_SKIPPED
        "{YELLOW}[SKIP]{RESET}"
    elif status == 5:     # TEST_STATUS_TIMEOUT
        "{RED}[TIME]{RESET}"
    elif status == 6:     # TEST_STATUS_CRASHED
        "{RED}[BOOM]{RESET}"
    elif status == 1:     # TEST_STATUS_RUNNING
        "{GRAY}[....]{RESET}"
    else:
        "{GRAY}[????]{RESET}"

# =========================================================================
# Duration Formatting
# =========================================================================

fn format_duration(ms: i64) -> text:
    if ms < 1000:
        "{ms}ms"
    elif ms < 60000:
        val secs = ms / 1000
        val rem = ms % 1000
        "{secs}.{rem / 100}s"
    else:
        val mins = ms / 60000
        val secs = (ms % 60000) / 1000
        "{mins}m {secs}s"

fn format_duration_compact(ms: i64) -> text:
    if ms < 1:
        "<1ms"
    elif ms < 1000:
        "{ms}ms"
    else:
        val secs = ms / 1000
        "{secs}s"

# =========================================================================
# Test Result Line Formatting
# =========================================================================

fn format_test_line_with_formatter(name: text, suite: text, status_str: text, duration_ms: i64) -> text:
    val dur_str = format_duration_compact(duration_ms)
    if suite == "":
        "{status_str} {name} ({dur_str})"
    else:
        "{status_str} {suite} :: {name} ({dur_str})"

fn format_test_line(name: text, suite: text, status: i32, duration_ms: i64) -> text:
    val status_str = format_status(status)
    format_test_line_with_formatter(name, suite, status_str, duration_ms)

fn format_test_line_colored(name: text, suite: text, status: i32, duration_ms: i64) -> text:
    val status_str = format_status_colored(status)
    format_test_line_with_formatter(name, suite, status_str, duration_ms)

# =========================================================================
# Failure Details Formatting
# =========================================================================

fn format_failure(message: text, file: text, line: i32) -> text:
    if file == "":
        "       Error: {message}"
    else:
        "       Error: {message}{NL}       at {file}:{line}"

fn format_failure_indent(message: text, file: text, line: i32, indent: i32) -> text:
    var prefix = ""
    for _ in 0..indent:
        prefix = prefix + " "
    if file == "":
        "{prefix}Error: {message}"
    else:
        "{prefix}Error: {message}{NL}{prefix}at {file}:{line}"

# =========================================================================
# Summary Formatting
# =========================================================================

fn format_summary_line(total: i32, passed: i32, failed: i32, skipped: i32, duration_ms: i64) -> text:
    val dur_str = format_duration(duration_ms)
    "Total: {total}, Passed: {passed}, Failed: {failed}, Skipped: {skipped}, Duration: {dur_str}"

fn calculate_pass_rate(total: i32, passed: i32, skipped: i32) -> f64:
    val executed = total - skipped
    if executed > 0:
        (passed as f64 / executed as f64) * 100.0
    else:
        100.0

fn format_summary_with_rate(total: i32, passed: i32, failed: i32, skipped: i32, timeout: i32, duration_ms: i64) -> text:
    val dur_str = format_duration(duration_ms)
    val rate = calculate_pass_rate(total, passed, skipped)

    var parts = "Total: {total}, Passed: {passed}, Failed: {failed}"
    if skipped > 0:
        parts = parts + ", Skipped: {skipped}"
    if timeout > 0:
        parts = parts + ", Timeout: {timeout}"
    parts + ", Duration: {dur_str} ({rate:.1}%)"

fn format_summary_box(total: i32, passed: i32, failed: i32, skipped: i32, duration_ms: i64) -> text:
    val dur_str = format_duration(duration_ms)
    val rate = calculate_pass_rate(total, passed, skipped)

    var lines = ""
    lines = lines + "========================================{NL}"
    lines = lines + "              TEST SUMMARY              {NL}"
    lines = lines + "========================================{NL}"
    lines = lines + "  Total:    {total}{NL}"
    lines = lines + "  Passed:   {passed}{NL}"
    lines = lines + "  Failed:   {failed}{NL}"
    if skipped > 0:
        lines = lines + "  Skipped:  {skipped}{NL}"
    lines = lines + "  Duration: {dur_str}{NL}"
    lines = lines + "  Success:  {rate:.1}%{NL}"
    lines = lines + "========================================{NL}"
    lines

# =========================================================================
# Doc-Style Formatting (RSpec-like)
# =========================================================================

fn format_doc_suite_start(name: text) -> text:
    "{NL}{name}"

fn format_doc_test(name: text, status: i32, duration_ms: i64, indent: i32) -> text:
    var prefix = ""
    for _ in 0..indent:
        prefix = prefix + "  "

    val status_char = if status == 2:  # TEST_STATUS_PASSED
        "."
    elif status == 3:  # TEST_STATUS_FAILED
        "F"
    elif status == 4:  # TEST_STATUS_SKIPPED
        "*"
    elif status == 5:  # TEST_STATUS_TIMEOUT
        "T"
    else:
        "?"

    val dur_str = format_duration_compact(duration_ms)
    "{prefix}{status_char} {name} ({dur_str})"

# =========================================================================
# JSON Formatting
# =========================================================================

fn escape_json_string(s: text) -> text:
    escape_json(s)

fn format_json_test(name: text, suite: text, status: i32, duration_ms: i64, message: text, file: text, line: i32) -> text:
    val status_str = if status == 2: "passed"     # TEST_STATUS_PASSED
        elif status == 3: "failed"   # TEST_STATUS_FAILED
        elif status == 4: "skipped"  # TEST_STATUS_SKIPPED
        elif status == 5: "timeout"  # TEST_STATUS_TIMEOUT
        else: "unknown"

    var json = "{"
    json = json + "\"name\": \"{escape_json_string(name)}\","
    json = json + "\"suite\": \"{escape_json_string(suite)}\","
    json = json + "\"status\": \"{status_str}\","
    json = json + "\"duration_ms\": {duration_ms}"

    if status == 3 and message != "":  # TEST_STATUS_FAILED
        json = json + ",\"message\": \"{escape_json_string(message)}\""
        if file != "":
            json = json + ",\"file\": \"{escape_json_string(file)}\""
            json = json + ",\"line\": {line}"

    json + "}"

fn format_json_summary(total: i32, passed: i32, failed: i32, skipped: i32, timeout: i32, duration_ms: i64) -> text:
    var rate: f64 = 100.0
    val executed = total - skipped
    if executed > 0:
        rate = (passed as f64 / executed as f64) * 100.0

    var json = "{"
    json = json + "\"total\": {total},"
    json = json + "\"passed\": {passed},"
    json = json + "\"failed\": {failed},"
    json = json + "\"skipped\": {skipped},"
    json = json + "\"timeout\": {timeout},"
    json = json + "\"duration_ms\": {duration_ms},"
    json = json + "\"success_rate\": {rate:.2}"
    json + "}"

# =========================================================================
# Progress Indicator
# =========================================================================

fn format_progress(current: i32, total: i32) -> text:
    "[{current}/{total}]"

fn format_progress_bar(current: i32, total: i32, width: i32) -> text:
    if total == 0:
        var bar = ""
        for _ in 0..width:
            bar = bar + "-"
        return "[{bar}]"

    val filled = (current * width) / total
    val empty = width - filled

    var bar = ""
    for _ in 0..filled:
        bar = bar + "="
    for _ in 0..empty:
        bar = bar + "-"
    "[{bar}] {current}/{total}"
