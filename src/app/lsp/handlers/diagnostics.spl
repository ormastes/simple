# LSP Diagnostics Handler
#
# Provides error and warning diagnostics

export handle_diagnostics, Diagnostic, DiagnosticSeverity

use parser.treesitter.{Node, Tree}

# Diagnostic severity levels
enum DiagnosticSeverity:
    Error = 1
    Warning = 2
    Information = 3
    Hint = 4

# Diagnostic message
struct Diagnostic:
    message: text
    severity: i64
    line: i64
    character: i64
    end_line: i64
    end_character: i64

# Handle diagnostics request
fn handle_diagnostics(tree: Tree?, source: text, uri: text) -> [Diagnostic]:
    """Generate diagnostics (errors/warnings) for document.

    Args:
        tree - Optional syntax tree
        source - Source code
        uri - Document URI

    Returns:
        List of diagnostics
    """
    var diagnostics: [Diagnostic] = []

    # Check for parse errors
    if not tree.?:
        diagnostics.push(Diagnostic(
            message: "Failed to parse document",
            severity: DiagnosticSeverity.Error.to_i64(),
            line: 0,
            character: 0,
            end_line: 0,
            end_character: 0
        ))
        return diagnostics

    val tree_val = tree.unwrap()
    val root = tree_val.root_node()

    # Check for error nodes in tree
    if root.has_error():
        diagnostics.push(Diagnostic(
            message: "Syntax error in document",
            severity: DiagnosticSeverity.Error.to_i64(),
            line: 0,
            character: 0,
            end_line: 0,
            end_character: 0
        ))

    # TODO: Add more sophisticated error checking
    # - Type errors
    # - Undefined variables
    # - Unused imports
    # etc.

    diagnostics

impl DiagnosticSeverity:
    fn to_i64() -> i64:
        match self:
            case Error: 1
            case Warning: 2
            case Information: 3
            case Hint: 4
