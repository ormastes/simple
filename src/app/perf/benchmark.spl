# Benchmark Runner - Pure Simple Implementation
# Run performance benchmarks and compare results


import io
import json
import perf.profiler

# Benchmark result
class BenchResult:
    name: text
    iterations: i64
    total_ns: i64
    avg_ns: i64
    min_ns: i64
    max_ns: i64
    stddev_ns: i64

    fn to_dict() -> Dict:
        {
            "name": self.name,
            "iterations": self.iterations,
            "total_ns": self.total_ns,
            "avg_ns": self.avg_ns,
            "min_ns": self.min_ns,
            "max_ns": self.max_ns,
            "stddev_ns": self.stddev_ns,
            "avg_us": self.avg_ns / 1000,
            "ops_per_sec": if self.avg_ns > 0: 1000000000 / self.avg_ns else: 0
        }

# Benchmark suite
class BenchSuite:
    name: text
    benchmarks: List<BenchResult>
    baseline: Dict<text, BenchResult>?

    static fn create(name: text) -> BenchSuite:
        BenchSuite(
            name: name,
            benchmarks: [],
            baseline: nil
        )

    me load_baseline(path: text):
        if not io.file_exists(path):
            return

        val content = io.read_file(path)
        val data = json.parse(content)

        if val Some(bench_list) = data["benchmarks"]:
            var baseline_map = {}
            for bench_data in bench_list:
                if val Some(name) = bench_data["name"]:
                    baseline_map[name] = BenchResult(
                        name: name,
                        iterations: bench_data["iterations"] ?? 0,
                        total_ns: bench_data["total_ns"] ?? 0,
                        avg_ns: bench_data["avg_ns"] ?? 0,
                        min_ns: bench_data["min_ns"] ?? 0,
                        max_ns: bench_data["max_ns"] ?? 0,
                        stddev_ns: bench_data["stddev_ns"] ?? 0
                    )
            self.baseline = Some(baseline_map)

    me run_bench(name: text, iterations: i64, f: fn() -> ()) -> BenchResult:
        # Warmup
        val warmup = iterations / 10
        for i in 0..warmup:
            f()

        # Collect samples
        var times = []
        for i in 0..iterations:
            val start = rt_time_monotonic_ns()
            f()
            val elapsed = rt_time_monotonic_ns() - start
            times.push(elapsed)

        # Calculate statistics
        var total = 0
        var min_val = times[0]
        var max_val = times[0]

        for t in times:
            total = total + t
            if t < min_val:
                min_val = t
            if t > max_val:
                max_val = t

        val avg = total / iterations

        # Calculate standard deviation
        var variance_sum = 0
        for t in times:
            val diff = t - avg
            variance_sum = variance_sum + (diff * diff)
        val variance = variance_sum / iterations
        val stddev = variance.sqrt()

        BenchResult(
            name: name,
            iterations: iterations,
            total_ns: total,
            avg_ns: avg,
            min_ns: min_val,
            max_ns: max_val,
            stddev_ns: stddev
        )

    me add_result(result: BenchResult):
        self.benchmarks.push(result)

    fn report() -> text:
        var lines = ["Benchmark Results: {self.name}", "=" * 80, ""]

        lines.push("Benchmark".pad_right(40) + "Avg(µs)".pad_right(12) + "Min(µs)".pad_right(12) + "Max(µs)".pad_right(12) + "Change")
        lines.push("-" * 90)

        for result in self.benchmarks:
            val avg_us = result.avg_ns / 1000
            val min_us = result.min_ns / 1000
            val max_us = result.max_ns / 1000

            var change_str = ""
            if val Some(baseline_map) = self.baseline:
                if val Some(baseline) = baseline_map[result.name]:
                    val diff_pct = ((result.avg_ns - baseline.avg_ns) * 100) / baseline.avg_ns
                    if diff_pct < -5:
                        change_str = "✓ {diff_pct}% faster"
                    elif diff_pct > 5:
                        change_str = "✗ +{diff_pct}% slower"
                    else:
                        change_str = "≈ {diff_pct}%"

            val line = result.name.pad_right(40) +
                       avg_us.to_string().pad_right(12) +
                       min_us.to_string().pad_right(12) +
                       max_us.to_string().pad_right(12) +
                       change_str
            lines.push(line)

        lines.push("")
        lines.join("\n")

    fn save(path: text):
        var bench_list = []
        for result in self.benchmarks:
            bench_list.push(result.to_dict())

        val data = {
            "suite": self.name,
            "timestamp": rt_timestamp_iso8601(),
            "benchmarks": bench_list
        }

        io.write_file(path, json.stringify(data))
        print "Results saved to {path}"

# Helper functions
fn run_benchmark_suite(name: text, baseline_path: text?) -> BenchSuite:
    var suite = BenchSuite.create(name)

    if val Some(path) = baseline_path:
        suite.load_baseline(path)

    suite

fn compare_with_baseline(current_path: text, baseline_path: text):
    val current_data = json.parse(io.read_file(current_path))
    val baseline_data = json.parse(io.read_file(baseline_path))

    print "Comparison: Current vs Baseline"
    print "=" * 80
    print ""

    if val Some(current_benches) = current_data["benchmarks"]:
        if val Some(baseline_benches) = baseline_data["benchmarks"]:
            var baseline_map = {}
            for bench in baseline_benches:
                if val Some(name) = bench["name"]:
                    baseline_map[name] = bench

            for bench in current_benches:
                if val Some(name) = bench["name"]:
                    if val Some(baseline) = baseline_map[name]:
                        val current_avg = bench["avg_ns"] ?? 0
                        val baseline_avg = baseline["avg_ns"] ?? 0

                        if baseline_avg > 0:
                            val diff_pct = ((current_avg - baseline_avg) * 100) / baseline_avg
                            val current_us = current_avg / 1000
                            val baseline_us = baseline_avg / 1000

                            if diff_pct < -5:
                                print "✓ {name}: {current_us}µs vs {baseline_us}µs ({diff_pct}% faster)"
                            elif diff_pct > 5:
                                print "✗ {name}: {current_us}µs vs {baseline_us}µs (+{diff_pct}% slower)"
                            else:
                                print "≈ {name}: {current_us}µs vs {baseline_us}µs ({diff_pct}%)"

# SFFI hooks
extern fn rt_time_monotonic_ns() -> i64
extern fn rt_timestamp_iso8601() -> text
