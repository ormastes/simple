#!/usr/bin/env simple
# Feature Documentation Migration Progress Tracker
# Compares doc/old_features/ (baseline) with doc/features/ (generated)
# Migrated from scripts/build/compare_features.sh

use app.io
use app.utils.colors (success, error, warning, info)
use std.text.{NL}

export main, compare_features

fn main():
    compare_features()

fn compare_features():
    """Compare feature documentation migration progress"""

    val old_dir = "doc/old_features"
    val new_dir = "doc/features"

    print "=========================================="
    print "Feature Documentation Migration Progress"
    print "=========================================="
    print ""

    # Count files
    val old_count = count_md_files(old_dir)
    val new_count = count_md_files(new_dir)

    print "Baseline (old): {old_count} files"
    print "Generated (new): {new_count} files"
    print ""

    # Calculate progress
    if old_count > 0:
        val percent = (new_count * 100) / old_count
        print "Migration Progress: {percent}% ({new_count}/{old_count})"
    else:
        print "Migration Progress: N/A (no baseline)"
    print ""

    # Show category status
    print "Category Status:"
    print "----------------"

    show_category_status(old_dir, new_dir)

    print ""
    print "=========================================="

    # Show recently generated files
    if new_count > 0:
        print "Recently Generated Files:"
        print "------------------------"
        show_recent_files(new_dir)

fn count_md_files(directory: text) -> i64:
    """Count markdown files in directory"""
    if not is_dir(directory):
        return 0

    val (stdout, _, code) = process_run("find",
        [directory, "-type", "f", "-name", "*.md"])

    if code != 0:
        return 0

    val lines = stdout.split(NL)
    var count = 0
    for line in lines:
        if line.trim().len() > 0:
            count = count + 1
    count

fn show_category_status(old_dir: text, new_dir: text):
    """Show migration status for each category"""

    if not is_dir(old_dir):
        return

    val categories = dir_list(old_dir)

    for category in categories:
        val category_path = "{old_dir}/{category}"

        if not is_dir(category_path):
            continue

        # Skip special directories
        if category == "done":
            continue

        # Count files in old category
        val old_files = count_category_files(category_path)

        # Count files in new category
        val new_category_path = "{new_dir}/{category}"
        val new_files = count_category_files(new_category_path)

        # Show status
        if new_files == old_files:
            print success("âœ… {category}: {new_files}/{old_files} files")
        elif new_files > 0:
            print warning("ðŸ”„ {category}: {new_files}/{old_files} files")
        else:
            print error("âŒ {category}: {new_files}/{old_files} files")

fn count_category_files(category_path: text) -> i64:
    """Count markdown files in a category directory"""
    if not is_dir(category_path):
        return 0

    val (stdout, _, code) = process_run("find",
        [category_path, "-maxdepth", "1", "-type", "f", "-name", "*.md"])

    if code != 0:
        return 0

    val lines = stdout.split(NL)
    var count = 0
    for line in lines:
        if line.trim().len() > 0:
            count = count + 1
    count

fn show_recent_files(new_dir: text):
    """Show recently modified files"""
    val (stdout, _, code) = process_run("find",
        [new_dir, "-type", "f", "-name", "*.md", "-mtime", "-1"])

    if code != 0:
        return

    val lines = stdout.split(NL)
    var shown = 0

    for line in lines:
        if shown >= 10:
            break

        val trimmed = line.trim()
        if trimmed.len() > 0:
            # Remove doc/features/ prefix
            val display = trimmed.replace("doc/features/", "")
            print "  {display}"
            shown = shown + 1
