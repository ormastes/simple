# Simple (.spl) replacement for script/verify-baremetal-setup.sh
# Verify Bare-Metal Build System Setup
#
# Checks that all infrastructure is in place for bare-metal builds.

use app.io.mod.{shell_bool, shell_output, file_exists, exit}
use std.string.{trim}

val COLOR_GREEN = "\x1b[0;32m"
val COLOR_RED = "\x1b[0;31m"
val COLOR_YELLOW = "\x1b[1;33m"
val COLOR_RESET = "\x1b[0m"

fn check_file(path: text) -> bool:
    if file_exists(path):
        print "{COLOR_GREEN}OK{COLOR_RESET} {path}"
        return true
    else:
        print "{COLOR_RED}FAIL{COLOR_RESET} {path} (missing)"
        return false

fn check_executable(name: text, purpose: text) -> bool:
    if shell_bool("command -v {name}"):
        val version = trim(shell_output("{name} --version 2>&1 | head -1"))
        print "{COLOR_GREEN}OK{COLOR_RESET} {name} ({version})"
        return true
    else:
        print "{COLOR_YELLOW}WARN{COLOR_RESET} {name} (not installed - required for {purpose})"
        return false

fn main():
    print "=== Bare-Metal Build System Verification ==="
    print ""

    var errors = 0

    # Check linker scripts
    print "Linker Scripts:"
    if not check_file("src/compiler/baremetal/arm/linker.ld"):
        errors = errors + 1
    if not check_file("src/compiler/baremetal/x86_64/linker.ld"):
        errors = errors + 1
    if not check_file("src/compiler/baremetal/riscv/linker.ld"):
        errors = errors + 1
    print ""

    # Check startup code
    print "Startup Code (crt0.s):"
    if not check_file("src/compiler/baremetal/arm/crt0.s"):
        errors = errors + 1
    if not check_file("src/compiler/baremetal/x86_64/crt0.s"):
        errors = errors + 1
    if not check_file("src/compiler/baremetal/riscv/crt0.s"):
        errors = errors + 1
    print ""

    # Check build system files
    print "Build System:"
    if not check_file("src/app/build/baremetal.spl"):
        errors = errors + 1
    if not check_file("src/app/build/main.spl"):
        errors = errors + 1
    if not check_file("src/app/build/types.spl"):
        errors = errors + 1
    print ""

    # Check tests
    print "Tests:"
    if not check_file("test/integration/baremetal_build_spec.spl"):
        errors = errors + 1
    print ""

    # Check documentation
    print "Documentation:"
    if not check_file("doc/guide/baremetal_quick_start.md"):
        errors = errors + 1
    if not check_file("doc/report/baremetal_build_system_integration_2026-02-14.md"):
        errors = errors + 1
    print ""

    # Check toolchains (optional)
    print "Toolchains (optional - required for actual builds):"
    check_executable("arm-none-eabi-as", "ARM builds")
    check_executable("arm-none-eabi-ld", "ARM builds")
    check_executable("qemu-system-arm", "ARM testing")
    print ""
    check_executable("as", "x86_64 builds")
    check_executable("ld", "x86_64 builds")
    check_executable("qemu-system-x86_64", "x86_64 testing")
    print ""
    var has_riscv_as = check_executable("riscv64-unknown-elf-as", "RISC-V builds")
    if not has_riscv_as:
        check_executable("riscv64-linux-gnu-as", "RISC-V builds")
    var has_riscv_ld = check_executable("riscv64-unknown-elf-ld", "RISC-V builds")
    if not has_riscv_ld:
        check_executable("riscv64-linux-gnu-ld", "RISC-V builds")
    check_executable("qemu-system-riscv64", "RISC-V testing")
    print ""

    # Summary
    print "=== Summary ==="
    if errors == 0:
        print "{COLOR_GREEN}All infrastructure files present!{COLOR_RESET}"
        print ""
        print "Next steps:"
        print "  1. Implement compiler backend for bare-metal targets"
        print "  2. Run: simple build baremetal --list-targets"
        print "  3. Build: simple build baremetal --target=x86_64 hello.spl"
        print ""
        exit(0)
    else:
        print "{COLOR_RED}{errors} file(s) missing!{COLOR_RESET}"
        print ""
        print "Please ensure all infrastructure files are in place."
        exit(1)

main()
