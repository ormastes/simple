# Simple (.spl) replacement for scripts/verify-docker-setup.sh
# Verify Phase 2 Docker container setup
#
# Verifies that all Phase 2 container infrastructure is properly set up.

use app.io.mod.{shell, shell_bool, shell_output, file_exists, exit}
use std.text.{trim}

val COLOR_GREEN = "\x1b[0;32m"
val COLOR_RED = "\x1b[0;31m"
val COLOR_YELLOW = "\x1b[1;33m"
val COLOR_RESET = "\x1b[0m"

fn pass_msg(msg: text):
    print "{COLOR_GREEN}OK{COLOR_RESET} {msg}"

fn fail_msg(msg: text):
    print "{COLOR_RED}FAIL{COLOR_RESET} {msg}"

fn warn_msg(msg: text):
    print "{COLOR_YELLOW}WARN{COLOR_RESET} {msg}"

fn main():
    print "Phase 2 Container Setup Verification"
    print "====================================="
    print ""

    var passed = 0
    var failed = 0

    # Check 1: Files exist
    print "Checking files..."
    val files = [
        "tools/docker/Dockerfile.test-isolation",
        "tools/docker/Dockerfile.test-full",
        ".dockerignore",
        "config/docker-compose.test.yml",
        "scripts/docker-test.sh",
        "tools/docker/README_TEST_CONTAINERS.md"
    ]

    for file in files:
        if file_exists(file):
            pass_msg("{file} exists")
            passed = passed + 1
        else:
            fail_msg("{file} missing")
            failed = failed + 1

    # Check 2: docker-test.sh is executable
    print ""
    print "Checking permissions..."
    if shell_bool("test -x scripts/docker-test.sh"):
        pass_msg("scripts/docker-test.sh is executable")
        passed = passed + 1
    else:
        fail_msg("scripts/docker-test.sh is not executable")
        failed = failed + 1

    # Check 3: Runtime binary exists
    print ""
    print "Checking prerequisites..."
    if file_exists("bin/release/simple"):
        val size = trim(shell_output("ls -lh bin/release/simple | awk '{print $5}'"))
        pass_msg("Runtime binary exists ({size})")
        passed = passed + 1
    else:
        fail_msg("Runtime binary missing (bin/release/simple)")
        warn_msg("Run: bin/simple build --release")
        failed = failed + 1

    # Check 4: Docker is available
    print ""
    print "Checking Docker..."
    if shell_bool("command -v docker"):
        val version = trim(shell_output("docker --version | cut -d' ' -f3 | cut -d',' -f1"))
        pass_msg("Docker installed (v{version})")
        passed = passed + 1
    else:
        fail_msg("Docker not installed")
        failed = failed + 1

    # Check 5: Docker daemon is running
    if shell_bool("docker info 2>/dev/null 1>/dev/null"):
        pass_msg("Docker daemon is running")
        passed = passed + 1
    else:
        fail_msg("Docker daemon is not running")
        failed = failed + 1

    # Check 6: Docker Compose is available
    if shell_bool("docker compose version 2>/dev/null 1>/dev/null"):
        val compose_ver = trim(shell_output("docker compose version | cut -d' ' -f4 | cut -d'v' -f2"))
        pass_msg("Docker Compose available (v{compose_ver})")
        passed = passed + 1
    else:
        warn_msg("Docker Compose not available (optional)")

    # Check 7: File sizes
    print ""
    print "Checking file sizes..."
    if file_exists(".dockerignore"):
        val di_lines = trim(shell_output("wc -l < .dockerignore"))
        val di_count = int(di_lines)
        if di_count >= 90:
            pass_msg(".dockerignore has {di_lines} lines (optimized)")
            passed = passed + 1
        else:
            fail_msg(".dockerignore only has {di_lines} lines (expected 90+)")
            failed = failed + 1

    if file_exists("config/docker-compose.test.yml"):
        val compose_lines = trim(shell_output("wc -l < config/docker-compose.test.yml"))
        val compose_count = int(compose_lines)
        if compose_count >= 180:
            pass_msg("docker-compose.test.yml has {compose_lines} lines")
            passed = passed + 1
        else:
            fail_msg("docker-compose.test.yml only has {compose_lines} lines (expected 180+)")
            failed = failed + 1

    # Check 8: Dockerfile validation
    print ""
    print "Checking Dockerfile syntax..."
    if shell_bool("docker build --no-cache --dry-run -f tools/docker/Dockerfile.test-isolation . 2>/dev/null"):
        pass_msg("Dockerfile.test-isolation syntax valid")
        passed = passed + 1
    else:
        warn_msg("Cannot validate Dockerfile.test-isolation (dry-run not supported)")

    # Check 9: Docker images built
    print ""
    print "Checking Docker images..."
    if shell_bool("docker images | grep -q simple-test-isolation"):
        val iso_size = trim(shell_output("docker images simple-test-isolation:latest --format '{{.Size}}'"))
        pass_msg("simple-test-isolation:latest exists ({iso_size})")
        passed = passed + 1
    else:
        warn_msg("simple-test-isolation:latest not built yet")
        warn_msg("Run: scripts/docker-test.sh build")

    if shell_bool("docker images | grep -q simple-test-full"):
        val full_size = trim(shell_output("docker images simple-test-full:latest --format '{{.Size}}'"))
        pass_msg("simple-test-full:latest exists ({full_size})")
        passed = passed + 1
    else:
        warn_msg("simple-test-full:latest not built yet")
        warn_msg("Run: scripts/docker-test.sh build")

    # Summary
    print ""
    print "==========================================="
    print "Verification Summary"
    print "==========================================="
    print "Passed: {passed}"
    print "Failed: {failed}"

    if failed == 0:
        print ""
        pass_msg("All checks passed! Phase 2 setup is complete.")
        print ""
        print "Next steps:"
        print "  1. Build images: scripts/docker-test.sh build"
        print "  2. Run tests: scripts/docker-test.sh run"
        print "  3. See documentation: tools/docker/README_TEST_CONTAINERS.md"
        exit(0)
    else:
        print ""
        fail_msg("Some checks failed. Please fix the issues above.")
        exit(1)

main()
