# Lean Project Generator
#
# Generates a complete Lean 4 / Lake project structure for verification,
# including lakefile.lean, lean-toolchain, root module, and directories.

use app.io.mod.{file_write, file_exists, dir_create_all}
use std.text.{NL}

# ============================================================================
# Project Config
# ============================================================================

struct ProjectConfig:
    """Configuration for a Lean verification project."""
    name: text
    output_dir: text
    lean_version: text
    mathlib: bool
    modules: [text]

impl ProjectConfig:
    static fn default(name: text, output_dir: text) -> ProjectConfig:
        ProjectConfig(
            name: name,
            output_dir: output_dir,
            lean_version: "leanprover/lean4:v4.14.0",
            mathlib: false,
            modules: []
        )

    fn with_mathlib() -> ProjectConfig:
        ProjectConfig(
            name: self.name,
            output_dir: self.output_dir,
            lean_version: self.lean_version,
            mathlib: true,
            modules: self.modules
        )

    fn with_module(module_name: text) -> ProjectConfig:
        var mods = self.modules
        mods = mods.push(module_name)
        ProjectConfig(
            name: self.name,
            output_dir: self.output_dir,
            lean_version: self.lean_version,
            mathlib: self.mathlib,
            modules: mods
        )

# ============================================================================
# Project Generator
# ============================================================================

class ProjectGenerator:
    """Generates Lean 4 Lake projects for verification."""
    config: ProjectConfig

fn ProjectGenerator__new(config: ProjectConfig) -> ProjectGenerator:
    ProjectGenerator(config: config)

impl ProjectGenerator:
    fn generate() -> Result<text, text>:
        """Generate the complete project structure."""
        val dir = self.config.output_dir

        # Create directory structure
        dir_create_all(dir)
        dir_create_all("{dir}/src")

        # Generate lakefile.lean
        val lakefile_ok = self._write_lakefile()
        if not lakefile_ok:
            return Err("Failed to write lakefile.lean")

        # Generate lean-toolchain
        val toolchain_ok = self._write_toolchain()
        if not toolchain_ok:
            return Err("Failed to write lean-toolchain")

        # Generate root module
        val root_ok = self._write_root_module()
        if not root_ok:
            return Err("Failed to write root module")

        # Generate sub-modules
        for module_name in self.config.modules:
            val mod_ok = self._write_module(module_name)
            if not mod_ok:
                return Err("Failed to write module: {module_name}")

        Ok("Project generated at {dir}")

    fn _write_lakefile() -> bool:
        """Generate lakefile.lean."""
        val name = self.config.name
        var content = "import Lake{NL}open Lake DSL{NL}{NL}"
        content = "{content}package «{name}» where{NL}"
        content = "{content}  leanOptions := #[{NL}"
        content = "{content}    \u2039`autoImplicit, false\u203a{NL}"
        content = "{content}  ]{NL}{NL}"

        if self.config.mathlib:
            content = "{content}require mathlib from git{NL}"
            content = "{content}  \"https://github.com/leanprover-community/mathlib4\"{NL}{NL}"

        content = "{content}@[default_target]{NL}"
        content = "{content}lean_lib «{name}» where{NL}"
        content = "{content}  srcDir := \"src\"{NL}"

        file_write("{self.config.output_dir}/lakefile.lean", content)

    fn _write_toolchain() -> bool:
        """Generate lean-toolchain file."""
        file_write("{self.config.output_dir}/lean-toolchain", "{self.config.lean_version}{NL}")

    fn _write_root_module() -> bool:
        """Generate root .lean module file."""
        val name = self.config.name
        var content = "-- {name}{NL}"
        content = "{content}-- Auto-generated verification project root module.{NL}{NL}"

        for module_name in self.config.modules:
            content = "{content}import {name}.{module_name}{NL}"

        if self.config.modules.is_empty():
            content = "{content}-- Add imports here{NL}"

        file_write("{self.config.output_dir}/src/{name}.lean", content)

    fn _write_module(module_name: text) -> bool:
        """Generate a sub-module .lean file."""
        val name = self.config.name
        var content = "-- {name}.{module_name}{NL}"
        content = "{content}-- Auto-generated verification module.{NL}{NL}"
        content = "{content}namespace {name}.{module_name}{NL}{NL}"
        content = "{content}-- TODO: Add definitions and proofs{NL}{NL}"
        content = "{content}end {name}.{module_name}{NL}"

        file_write("{self.config.output_dir}/src/{name}/{module_name}.lean", content)

# ============================================================================
# Convenience Functions
# ============================================================================

fn generate_verification_project(name: text, output_dir: text) -> Result<text, text>:
    """Generate a basic verification project."""
    val config = ProjectConfig__default(name, output_dir)
    val gen = ProjectGenerator__new(config)
    gen.generate()

fn generate_verification_project_with_mathlib(name: text, output_dir: text, modules: [text]) -> Result<text, text>:
    """Generate a verification project with Mathlib and sub-modules."""
    var config = ProjectConfig__default(name, output_dir).with_mathlib()
    for m in modules:
        config = config.with_module(m)
    val gen = ProjectGenerator__new(config)
    gen.generate()

# ============================================================================
# Exports
# ============================================================================

export ProjectConfig, ProjectGenerator
export generate_verification_project, generate_verification_project_with_mathlib
