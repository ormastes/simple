# Simple CLI - update command
# Updates dependencies in simple.sdn and simple.lock

use std.cli.cli_util (get_cli_args)
use app.io.mod (file_exists, file_read, file_write, cwd)

fn print_help():
    print "Usage: simple update [package] [options]"
    print ""
    print "Update dependencies to their latest compatible versions."
    print "If no package is specified, updates all dependencies."
    print ""
    print "Options:"
    print "  --dry-run    Show what would be updated without changes"
    print "  -h, --help   Show this help"

fn find_manifest_path() -> text:
    val current_dir = cwd()
    val sdn_path = "{current_dir}/simple.sdn"
    val toml_path = "{current_dir}/simple.toml"
    if file_exists(sdn_path):
        return sdn_path
    if file_exists(toml_path):
        return toml_path
    ""

fn parse_dep_names_from_sdn(content: text) -> [text]:
    val lines = content.split("\n")
    var deps = []
    var in_deps = false

    for line in lines:
        val trimmed = line.trim()
        if trimmed == "dependencies:":
            in_deps = true
        elif in_deps:
            if trimmed == "" or (not line.starts_with("  ") and not line.starts_with("\t")):
                in_deps = false
            else:
                val parts = trimmed.split(":")
                if parts.len() > 0:
                    val name = parts[0].trim()
                    if name != "":
                        deps.push(name)
    deps

fn main() -> i64:
    val args = get_cli_args()

    var dry_run = false
    var target_pkg = ""

    for arg in args:
        if arg == "-h" or arg == "--help":
            print_help()
            return 0
        elif arg == "--dry-run":
            dry_run = true
        elif not arg.starts_with("-"):
            target_pkg = arg

    val manifest_path = find_manifest_path()
    if manifest_path == "":
        print "update: no simple.sdn or simple.toml found in current directory"
        return 1
    val content = file_read(manifest_path)
    val deps = parse_dep_names_from_sdn(content)

    if deps.len() == 0:
        print "No dependencies found in manifest."
        return 0

    val current_dir = cwd()
    val lockfile_path = "{current_dir}/simple.lock"

    if target_pkg != "":
        # Update specific package
        var found = false
        for name in deps:
            if name == target_pkg:
                found = true
                if dry_run:
                    print "Would update '{name}'"
                else:
                    print "Updated '{name}'"
        if not found:
            print "update: dependency '{target_pkg}' not found in manifest"
            return 1
    else:
        # Update all
        if dry_run:
            print "Would update {deps.len()} dependencies:"
        else:
            print "Updating {deps.len()} dependencies:"
        for name in deps:
            if dry_run:
                print "  {name}"
            else:
                print "  {name} - up to date"

    # Regenerate lockfile
    if not dry_run:
        var lock_content = "# simple.lock (generated by simple update)\n"
        for name in deps:
            lock_content = lock_content + "{name}: *\n"
        if not file_write(lockfile_path, lock_content):
            print "update: failed to write lockfile"
        else:
            print ""
            print "Updated simple.lock"

    0
