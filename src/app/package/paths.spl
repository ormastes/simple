# Path Management for Package Installation
# Handles platform-specific path resolution

use app.ioimport std.env

class PackagePaths:
    prefix: text
    is_system: bool
    platform: text

    static fn from_args(args: [text]) -> PackagePaths:
        var prefix = ""
        var is_system = false

        # Parse arguments
        for arg in args:
            if arg.starts_with("--prefix="):
                prefix = arg[9:]
            else if arg == "--system":
                is_system = true

        # Resolve prefix
        if prefix == "":
            if is_system:
                prefix = "/usr/local"
            else:
                prefix = env.home_dir() + "/.local"

        # Expand ~ to home directory
        if prefix.starts_with("~/"):
            prefix = env.home_dir() + prefix[1:]

        PackagePaths(
            prefix: prefix,
            is_system: is_system,
            platform: detect_platform()
        )

    fn bin_dir() -> text:
        self.prefix + "/bin"

    fn lib_dir() -> text:
        self.prefix + "/lib/simple"

    fn runtime_path() -> text:
        self.lib_dir() + "/simple_runtime"

    fn stdlib_dir() -> text:
        self.lib_dir() + "/stdlib"

    fn app_dir() -> text:
        self.lib_dir() + "/app"

    fn config_dir() -> text:
        if self.is_system:
            "/etc/simple"
        else:
            env.home_dir() + "/.config/simple"

    fn cache_dir() -> text:
        if self.is_system:
            "/var/cache/simple"
        else:
            env.home_dir() + "/.cache/simple"

    fn manifest_path() -> text:
        self.lib_dir() + "/manifest.sdn"

fn detect_platform() -> text:
    val os = env.os()
    val arch = env.arch()

    # Normalize OS name
    val os_name = match os:
        "linux": "linux"
        "macos": "darwin"
        "darwin": "darwin"
        "windows": "windows"
        _: os.lower()

    # Normalize architecture
    val arch_name = match arch:
        "x86_64": "x86_64"
        "amd64": "x86_64"
        "arm64": "arm64"
        "aarch64": "arm64"
        _: arch.lower()

    os_name + "-" + arch_name
