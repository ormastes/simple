# Package Uninstallation Logic

import std.fs
import std.env

class PackageUninstall:
    static fn run(args: [text]):
        var purge = false

        for arg in args:
            if arg == "--purge":
                purge = true

        val paths = PackagePaths.from_args(args)

        # Check if package is installed
        if not fs.exists(paths.manifest_path()):
            print "No package installation found at {paths.prefix}"
            return

        # Read manifest
        val manifest = PackageManifest.from_file(paths.manifest_path())

        print "Uninstalling {manifest.name} v{manifest.version}"
        print "Install prefix: {paths.prefix}"
        print ""

        # Remove symlinks
        print "Removing symlinks..."
        val symlink = paths.bin_dir() + "/simple"
        if fs.exists(symlink):
            fs.remove_file(symlink)
            print "  Removed: {symlink}"

        # Remove runtime
        print "Removing runtime..."
        if fs.exists(paths.runtime_path()):
            fs.remove_file(paths.runtime_path())
            print "  Removed: {paths.runtime_path()}"

        # Remove stdlib
        print "Removing stdlib..."
        if fs.exists(paths.stdlib_dir()):
            fs.remove_dir_all(paths.stdlib_dir())
            print "  Removed: {paths.stdlib_dir()}"

        # Remove apps
        print "Removing apps..."
        if fs.exists(paths.app_dir()):
            fs.remove_dir_all(paths.app_dir())
            print "  Removed: {paths.app_dir()}"

        # Remove manifest
        if fs.exists(paths.manifest_path()):
            fs.remove_file(paths.manifest_path())

        # Remove lib/simple directory if empty
        if fs.is_empty_dir(paths.lib_dir()):
            fs.remove_dir(paths.lib_dir())

        # Purge config and cache if requested
        if purge:
            print "Purging configuration and cache..."

            if fs.exists(paths.config_dir()):
                fs.remove_dir_all(paths.config_dir())
                print "  Removed: {paths.config_dir()}"

            if fs.exists(paths.cache_dir()):
                fs.remove_dir_all(paths.cache_dir())
                print "  Removed: {paths.cache_dir()}"

        print ""
        print "Uninstallation complete."
        print ""
        print "Note: You may need to remove {paths.bin_dir()} from your PATH"
