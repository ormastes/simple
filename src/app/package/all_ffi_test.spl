# Complete FFI Test - All 11 Functions
# Calls extern functions directly

use app.io
use std.string.{NL}
print "Testing All 11 Package FFI Functions"
print "======================================"

var passed = 0
var failed = 0

# Test 1: rt_package_exists
print "{NL}1. rt_package_exists"
val exists_result = rt_package_exists("/tmp")
if exists_result == 1:
    print "   ✓ Works (returns 1 for existing path)"
    passed = passed + 1
else:
    print "   ✗ Failed"
    failed = failed + 1

# Test 2: rt_package_is_dir
print "{NL}2. rt_package_is_dir"
val isdir_result = rt_package_is_dir("/tmp")
if isdir_result == 1:
    print "   ✓ Works (returns 1 for directory)"
    passed = passed + 1
else:
    print "   ✗ Failed"
    failed = failed + 1

# Test 3: rt_package_mkdir_all
print "{NL}3. rt_package_mkdir_all"
val test_dir = "/tmp/ffi-all-test/nested/deep"
# Clean up first
if rt_package_exists("/tmp/ffi-all-test") == 1:
    rt_package_remove_dir_all("/tmp/ffi-all-test")
val mkdir_result = rt_package_mkdir_all(test_dir)
if mkdir_result == 0:
    print "   ✓ Works (returns 0 on success)"
    passed = passed + 1
else:
    print "   ✗ Failed (returned " + mkdir_result.to_string() + ")"
    failed = failed + 1

# Test 4: rt_package_file_size
print "{NL}4. rt_package_file_size"
val size = rt_package_file_size("/etc/passwd")
if size > 0:
    print "   ✓ Works (size: " + size.to_string() + " bytes)"
    passed = passed + 1
else:
    print "   ✗ Failed"
    failed = failed + 1

# Test 5: rt_package_copy_file
print "{NL}5. rt_package_copy_file"
val copy_dest = "/tmp/ffi-all-test/passwd_copy"
val copy_result = rt_package_copy_file("/etc/passwd", copy_dest)
if copy_result == 0:
    print "   ✓ Works (returns 0 on success)"
    passed = passed + 1
else:
    print "   ✗ Failed"
    failed = failed + 1

# Test 6: rt_package_chmod
print "{NL}6. rt_package_chmod"
val chmod_result = rt_package_chmod(copy_dest, 0o644)
if chmod_result == 0:
    print "   ✓ Works (returns 0 on success)"
    passed = passed + 1
else:
    print "   ✗ Failed"
    failed = failed + 1

# Test 7: rt_package_sha256
print "{NL}7. rt_package_sha256"
val checksum = rt_package_sha256(copy_dest)
if checksum.starts_with("sha256:"):
    print "   ✓ Works (checksum format correct)"
    passed = passed + 1
else:
    print "   ✗ Failed (bad format: " + checksum + ")"
    failed = failed + 1

# Test 8: rt_package_create_symlink
print "{NL}8. rt_package_create_symlink"
val link_path = "/tmp/ffi-all-test/link"
val symlink_result = rt_package_create_symlink(copy_dest, link_path)
if symlink_result == 0:
    print "   ✓ Works (returns 0 on success)"
    passed = passed + 1
else:
    print "   ✗ Failed"
    failed = failed + 1

# Test 9: rt_package_create_tarball
print "{NL}9. rt_package_create_tarball"
val tarball_path = "/tmp/ffi-all-test.tar.gz"
val create_tar_result = rt_package_create_tarball("/tmp/ffi-all-test", tarball_path)
if create_tar_result == 0:
    val tar_size = rt_package_file_size(tarball_path)
    print "   ✓ Works (tarball: " + tar_size.to_string() + " bytes)"
    passed = passed + 1
else:
    print "   ✗ Failed"
    failed = failed + 1

# Test 10: rt_package_extract_tarball
print "{NL}10. rt_package_extract_tarball"
val extract_dir = "/tmp/ffi-all-test-extract"
rt_package_mkdir_all(extract_dir)
val extract_result = rt_package_extract_tarball(tarball_path, extract_dir)
if extract_result == 0:
    print "   ✓ Works (returns 0 on success)"
    passed = passed + 1
else:
    print "   ✗ Failed"
    failed = failed + 1

# Test 11: rt_package_remove_dir_all
print "{NL}11. rt_package_remove_dir_all"
val remove_result = rt_package_remove_dir_all("/tmp/ffi-all-test")
if remove_result == 0:
    if rt_package_exists("/tmp/ffi-all-test") == 0:
        print "   ✓ Works (directory removed)"
        passed = passed + 1
    else:
        print "   ✗ Remove succeeded but dir still exists"
        failed = failed + 1
else:
    print "   ✗ Failed"
    failed = failed + 1

# Cleanup
rt_package_remove_dir_all(extract_dir)

# Summary
print "{NL}======================================"
print "Results: " + passed.to_string() + "/11 tests passed"
if failed == 0:
    print "✅ ALL 11 FFI FUNCTIONS WORKING!"
else:
    print "❌ " + failed.to_string() + " tests failed"
print "======================================"
