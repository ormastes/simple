# Package Manifest Operations
# Parse and generate manifest.sdn files

use app.io.{file_read, shell_output_trimmed}
use std.string.{NL}

class PackageManifest:
    name: text
    version: text
    package_type: text  # "bootstrap" or "full"
    platform: text
    build_timestamp: text
    build_profile: text
    build_commit: text
    runtime_binary: text
    runtime_size: i64
    runtime_checksum: text
    stdlib_files: [text]
    app_dirs: [text]

    static fn from_file(path: text) -> PackageManifest:
        val content = file_read(path)
        val data = sdn.parse(content)

        PackageManifest(
            name: data.get("package.name") ?? "simple",
            version: data.get("package.version") ?? "0.0.0",
            package_type: data.get("package.type") ?? "bootstrap",
            platform: data.get("package.platform") ?? "unknown",
            build_timestamp: data.get("build.timestamp") ?? "",
            build_profile: data.get("build.profile") ?? "release-opt",
            build_commit: data.get("build.commit") ?? "",
            runtime_binary: data.get("runtime.binary") ?? "simple",
            runtime_size: data.get("runtime.size") ?? 0,
            runtime_checksum: data.get("runtime.checksum") ?? "",
            stdlib_files: data.get("contents.stdlib") ?? [],
            app_dirs: data.get("contents.apps") ?? []
        )

    static fn generate_bootstrap(version: text, platform: text) -> PackageManifest:
        PackageManifest(
            name: "simple-bootstrap",
            version: version,
            package_type: "bootstrap",
            platform: platform,
            build_timestamp: current_timestamp(),
            build_profile: "release-opt",
            build_commit: get_git_commit(),
            runtime_binary: "simple",
            runtime_size: 0,  # Will be filled during build
            runtime_checksum: "",  # Will be filled during build
            stdlib_files: ["core.spl", "io.spl", "json.spl", "http.spl"],
            app_dirs: ["cli", "run", "compile", "check", "repl"]
        )

    fn to_sdn() -> text:
        """
package:
  name: {self.name}
  version: {self.version}
  type: {self.package_type}
  platform: {self.platform}

build:
  timestamp: {self.build_timestamp}
  profile: {self.build_profile}
  commit: {self.build_commit}

runtime:
  binary: {self.runtime_binary}
  size: {self.runtime_size}
  checksum: {self.runtime_checksum}

contents:
  stdlib: {format_list(self.stdlib_files)}
  apps: {format_list(self.app_dirs)}

install:
  default_prefix: ~/.local
  system_prefix: /usr/local
  binaries:
    - name: simple
      target: lib/simple/simple
      type: symlink

  paths:
    runtime: lib/simple/
    stdlib: lib/simple/stdlib/
    apps: lib/simple/app/
"""

fn format_list(items: [text]) -> text:
    if items.is_empty():
        return "[]"

    var parts = []
    for item in items:
        parts.push("    " + item + ",")
    "[{NL}" + parts.join(NL) + "{NL}  ]"

fn current_timestamp() -> text:
    shell_output_trimmed("date -u +%Y-%m-%dT%H:%M:%SZ", "unknown")

fn get_git_commit() -> text:
    shell_output_trimmed("git rev-parse HEAD 2>/dev/null", "unknown")

export PackageManifest
