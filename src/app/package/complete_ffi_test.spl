# Complete FFI Function Test
# Tests all 11 package FFI functions

use std.package_ffi

fn test_all_ffi():
    print "Testing All 11 Package FFI Functions..."
    print "=========================================="

    var passed = 0
    var failed = 0

    # Test 1: path_exists
    print "\nTest 1: rt_package_exists"
    if package_ffi.path_exists("/tmp"):
        print "  ✓ /tmp exists"
        passed = passed + 1
    else:
        print "  ✗ Failed"
        failed = failed + 1

    # Test 2: is_directory
    print "\nTest 2: rt_package_is_dir"
    if package_ffi.is_directory("/tmp"):
        print "  ✓ /tmp is a directory"
        passed = passed + 1
    else:
        print "  ✗ Failed"
        failed = failed + 1

    # Test 3: mkdir_all
    print "\nTest 3: rt_package_mkdir_all"
    val test_dir = "/tmp/complete-ffi-test/nested/deep"
    if package_ffi.path_exists("/tmp/complete-ffi-test"):
        package_ffi.remove_dir_all("/tmp/complete-ffi-test")
    if package_ffi.mkdir_all(test_dir):
        print "  ✓ Created nested directory"
        passed = passed + 1
    else:
        print "  ✗ Failed to create directory"
        failed = failed + 1

    # Test 4: file_size (use /etc/passwd as test file - exists on all Unix systems)
    print "\nTest 4: rt_package_file_size"
    val size = package_ffi.get_file_size("/etc/passwd")
    if size > 0:
        print "  ✓ File size: " + size.to_string() + " bytes"
        passed = passed + 1
    else:
        print "  ✗ Failed to get file size"
        failed = failed + 1

    # Test 5: copy_file (copy /etc/hostname to test dir)
    print "\nTest 5: rt_package_copy_file"
    val copy_dest = "/tmp/complete-ffi-test/hostname_copy"
    if package_ffi.copy_file("/etc/hostname", copy_dest):
        if package_ffi.path_exists(copy_dest):
            print "  ✓ File copied successfully"
            passed = passed + 1
        else:
            print "  ✗ Copy succeeded but file not found"
            failed = failed + 1
    else:
        print "  ✗ Failed to copy file"
        failed = failed + 1

    # Test 6: chmod (Unix only) - change permissions on our copy
    print "\nTest 6: rt_package_chmod"
    if package_ffi.set_permissions(copy_dest, 0o644):
        print "  ✓ Set permissions to 0644"
        passed = passed + 1
    else:
        print "  ✗ Failed to set permissions"
        failed = failed + 1

    # Test 7: sha256 - checksum our copied file
    print "\nTest 7: rt_package_sha256"
    val checksum = package_ffi.calculate_checksum(copy_dest)
    if checksum.starts_with("sha256:"):
        print "  ✓ Checksum: " + checksum.substring(0, 20) + "..."
        passed = passed + 1
    else:
        print "  ✗ Invalid checksum format: " + checksum
        failed = failed + 1

    # Test 8: create_symlink (Unix only)
    print "\nTest 8: rt_package_create_symlink"
    val link_path = "/tmp/complete-ffi-test/hostname_link"
    if package_ffi.create_symlink(copy_dest, link_path):
        if package_ffi.path_exists(link_path):
            print "  ✓ Symlink created successfully"
            passed = passed + 1
        else:
            print "  ✗ Symlink creation succeeded but link not found"
            failed = failed + 1
    else:
        print "  ✗ Failed to create symlink"
        failed = failed + 1

    # Test 9: create_tarball
    print "\nTest 9: rt_package_create_tarball"
    val tarball_path = "/tmp/complete-ffi-test.tar.gz"
    if package_ffi.create_tarball("/tmp/complete-ffi-test", tarball_path):
        if package_ffi.path_exists(tarball_path):
            val tar_size = package_ffi.get_file_size(tarball_path)
            print "  ✓ Tarball created (" + tar_size.to_string() + " bytes)"
            passed = passed + 1
        else:
            print "  ✗ Tarball creation succeeded but file not found"
            failed = failed + 1
    else:
        print "  ✗ Failed to create tarball"
        failed = failed + 1

    # Test 10: extract_tarball
    print "\nTest 10: rt_package_extract_tarball"
    val extract_dir = "/tmp/complete-ffi-test-extract"
    if package_ffi.path_exists(extract_dir):
        package_ffi.remove_dir_all(extract_dir)
    package_ffi.mkdir_all(extract_dir)
    if package_ffi.extract_tarball(tarball_path, extract_dir):
        print "  ✓ Tarball extracted successfully"
        passed = passed + 1
    else:
        print "  ✗ Failed to extract tarball"
        failed = failed + 1

    # Test 11: remove_dir_all (cleanup)
    print "\nTest 11: rt_package_remove_dir_all"
    if package_ffi.remove_dir_all("/tmp/complete-ffi-test"):
        if not package_ffi.path_exists("/tmp/complete-ffi-test"):
            print "  ✓ Directory removed successfully"
            passed = passed + 1
        else:
            print "  ✗ Remove succeeded but directory still exists"
            failed = failed + 1
    else:
        print "  ✗ Failed to remove directory"
        failed = failed + 1

    # Final cleanup
    if package_ffi.path_exists(extract_dir):
        package_ffi.remove_dir_all(extract_dir)
    if package_ffi.path_exists(tarball_path):
        # Can't delete without file delete function, but that's ok

    # Summary
    print "\n=========================================="
    print "Results: " + passed.to_string() + "/11 tests passed"
    if failed > 0:
        print "Failed: " + failed.to_string()
    else:
        print "✅ All FFI functions working!"
    print "=========================================="

    passed

# Run the test
test_all_ffi()
