# Simple CLI - init command
# Initialize a new Simple project

use app.cli_util (get_cli_args)
use std.path as path

extern fn rt_file_exists(path: text) -> bool
extern fn rt_file_write_text(path: text, content: text) -> bool
extern fn rt_dir_create(path: text, recursive: bool) -> bool
extern fn rt_env_cwd() -> text

fn print_help():
    print "Usage: simple init [name] [options]"
    print ""
    print "Initialize a new Simple project in the current directory."
    print ""
    print "Arguments:"
    print "  [name]         Project name (default: directory name)"
    print ""
    print "Options:"
    print "  --lib          Create a library project (no main.spl)"
    print "  --minimal      Minimal project (manifest only)"
    print "  -h, --help     Show this help"

fn main() -> i64:
    val args = get_cli_args()
    val cwd = rt_env_cwd()

    var name = ""
    var is_lib = false
    var minimal = false

    for arg in args:
        if arg == "-h" or arg == "--help":
            print_help()
            return 0
        elif arg == "--lib":
            is_lib = true
        elif arg == "--minimal":
            minimal = true
        elif not arg.starts_with("-"):
            name = arg

    # Check if already initialized
    if rt_file_exists("{cwd}/simple.sdn"):
        print "error: project already initialized (simple.sdn exists)"
        return 1
    if rt_file_exists("{cwd}/simple.toml"):
        print "error: project already initialized (simple.toml exists)"
        return 1

    # Determine project name
    if name == "":
        name = path.basename(cwd)
    if name == "":
        name = "my-project"

    # Write simple.sdn manifest
    val main_entry = if is_lib: "src/lib.spl" else: "src/main.spl"
    val manifest = "# Simple Package Manifest\n# SDN (Simple Data Notation) format\n\npackage:\n  name: {name}\n  version: 0.1.0\n  license: MIT\n  main: {main_entry}\n"
    if not rt_file_write_text("{cwd}/simple.sdn", manifest):
        print "error: failed to write simple.sdn"
        return 1

    if minimal:
        print "Initialized Simple project '{name}' (minimal)"
        return 0

    # Create directories
    if not rt_dir_create("{cwd}/src", true):
        print "error: failed to create src/"
        return 1

    if not rt_dir_create("{cwd}/test", true):
        print "error: failed to create test/"
        return 1

    # Write main source file
    if is_lib:
        val lib_path = "{cwd}/src/lib.spl"
        if not rt_file_exists(lib_path):
            val lib_content = "# {name} - Simple Library\n\nfn hello() -> text:\n    \"Hello from {name}!\"\n\nexport hello\n"
            rt_file_write_text(lib_path, lib_content)
    else:
        val main_path = "{cwd}/src/main.spl"
        if not rt_file_exists(main_path):
            val main_content = "# {name} - Simple Project\n# Run with: simple run\n\nfn main() -> i32:\n    print \"Hello, Simple!\"\n    0\n"
            rt_file_write_text(main_path, main_content)

    # Write test file
    val test_path = "{cwd}/test/{name}_spec.spl"
    if not rt_file_exists(test_path):
        val test_content = "# {name} tests\n\ndescribe \"{name}\":\n    it \"should work\":\n        assert true\n"
        rt_file_write_text(test_path, test_content)

    print "Initialized Simple project '{name}'"
    print ""
    print "  simple.sdn       - package manifest"
    if is_lib:
        print "  src/lib.spl      - source code"
    else:
        print "  src/main.spl     - source code"
    print "  test/             - tests"
    print ""
    print "Get started:"
    if is_lib:
        print "  simple test"
    else:
        print "  simple run"
    0
