# Bug Database MCP Resource
#
# Provides MCP access to the unified bug database

use lib.database.bug.{create_bug_database, BugDatabase, Bug, BugSeverity, BugStatus}

export get_all_bugs, get_open_bugs, get_critical_bugs, get_bug_stats

# ============================================================================
# Bug Database Resource Provider
# ============================================================================

# Get all bugs from database
fn get_all_bugs(db_path: text) -> text:
    var bugdb = create_bug_database(db_path)
    val bugs = bugdb.all_bugs()

    # Convert to JSON
    var json = "{"
    json = json + "\"total\": {bugs.len()},"
    json = json + "\"bugs\": ["

    var first = true
    for bug in bugs:
        if not first:
            json = json + ","
        first = false

        json = json + bug_to_json(bug)

    json = json + "]"
    json = json + "}"
    json

# Get open bugs
fn get_open_bugs(db_path: text) -> text:
    var bugdb = create_bug_database(db_path)
    
        

    
    val bugs = bugdb.open_bugs()

    # Convert to JSON
    var json = "{"
    json = json + "\"total\": {bugs.len()},"
    json = json + "\"bugs\": ["

    var first = true
    for bug in bugs:
        if not first:
            json = json + ","
        first = false

        json = json + bug_to_json(bug)

    json = json + "]"
    json = json + "}"
    json

# Get critical bugs (P0 + P1)
fn get_critical_bugs(db_path: text) -> text:
    var bugdb = create_bug_database(db_path)
    
        

    
    val bugs = bugdb.critical_bugs()

    # Convert to JSON
    var json = "{"
    json = json + "\"total\": {bugs.len()},"
    json = json + "\"bugs\": ["

    var first = true
    for bug in bugs:
        if not first:
            json = json + ","
        first = false

        json = json + bug_to_json(bug)

    json = json + "]"
    json = json + "}"
    json

# Get bug statistics
fn get_bug_stats(db_path: text) -> text:
    var bugdb = create_bug_database(db_path)
    
        

    
    val stats = bugdb.stats()

    var json = "{"
    json = json + "\"total\": {stats.total},"
    json = json + "\"open\": {stats.open},"
    json = json + "\"fixed\": {stats.fixed},"
    json = json + "\"p0\": {stats.p0},"
    json = json + "\"p1\": {stats.p1},"
    json = json + "\"important\": {stats.important},"
    json = json + "\"health\": \"{stats.health}\""
    json = json + "}"
    json

# Convert bug to JSON
fn bug_to_json(bug: Bug) -> text:
    var json = "{"
    json = json + "\"id\": \"{bug.id}\","
    json = json + "\"severity\": \"{severity_to_string(bug.severity)}\","
    json = json + "\"status\": \"{status_to_string(bug.status)}\","
    json = json + "\"title\": \"{escape_json(bug.title)}\","
    json = json + "\"file\": \"{bug.file}\","
    json = json + "\"line\": {bug.line},"
    json = json + "\"reproducible_by\": \"{bug.reproducible_by}\","
    json = json + "\"description\": "
    json = json + array_to_json(bug.description)
    json = json + "}"
    json

# Convert array to JSON
fn array_to_json(arr: [text]) -> text:
    var json = "["
    var first = true
    for item in arr:
        if not first:
            json = json + ","
        first = false
        json = json + "\"{escape_json(item)}\""
    json = json + "]"
    json

# Escape JSON string
fn escape_json(s: text) -> text:
    var result = s
    result = result.replace("\\", "\\\\")
    result = result.replace("\"", "\\\"")
    result = result.replace("\n", "\\n")
    result = result.replace("\r", "\\r")
    result = result.replace("\t", "\\t")
    result

# Convert severity to string
fn severity_to_string(severity: BugSeverity) -> text:
    match severity:
        BugSeverity.P0: "P0"
        BugSeverity.P1: "P1"
        BugSeverity.P2: "P2"
        BugSeverity.P3: "P3"
        BugSeverity.Important: "Important"

# Convert status to string
fn status_to_string(status: BugStatus) -> text:
    match status:
        BugStatus.Open: "Open"
        BugStatus.Investigating: "Investigating"
        BugStatus.Confirmed: "Confirmed"
        BugStatus.Fixed: "Fixed"
        BugStatus.Closed: "Closed"
        BugStatus.Wontfix: "Wontfix"
