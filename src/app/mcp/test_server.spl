# Simple (.spl) replacement for test_mcp_server.sh
# Tests if the MCP server responds correctly to basic MCP protocol messages

use app.io.mod.{shell, shell_output, cwd, file_exists, exit}
use std.string.{contains}

fn main():
    val base_dir = cwd()
    val mcp_server = base_dir + "/bin/simple_mcp_server_optimized"

    print "=== Testing Simple MCP Server ==="
    print ""

    # Test 1: Initialize
    print "Test 1: Sending initialize message..."
    val init_msg = "{\"jsonrpc\":\"2.0\",\"method\":\"initialize\",\"params\":{\"protocolVersion\":\"2025-06-18\",\"capabilities\":{}},\"id\":1}"

    val init_cmd = "(echo 'Content-Length: " + init_msg.len().to_text() + "'; echo ''; echo '" + init_msg + "'; sleep 0.5) | timeout 2 " + mcp_server + " server 2>/dev/null"
    val init_result = shell(init_cmd)

    if contains(init_result.stdout, "protocolVersion"):
        print "PASS Initialize successful"
    else:
        print "FAIL Initialize failed"
        print "  Response: " + init_result.stdout
        exit(1)

    # Test 2: Listing available tools
    print ""
    print "Test 2: Listing available tools..."
    val tools_msg = "{\"jsonrpc\":\"2.0\",\"method\":\"tools/list\",\"id\":2}"
    val tools_cmd = "(echo 'Content-Length: " + init_msg.len().to_text() + "'; echo ''; echo '" + init_msg + "'; echo 'Content-Length: " + tools_msg.len().to_text() + "'; echo ''; echo '" + tools_msg + "'; sleep 0.5) | timeout 2 " + mcp_server + " server 2>/dev/null"
    val tools_result = shell(tools_cmd)

    if contains(tools_result.stdout, "tools"):
        print "PASS Tools list successful"
        # Count tool names
        val count_cmd = "echo '" + tools_result.stdout + "' | grep -o '\"name\"' | wc -l"
        val count_out = shell_output(count_cmd)
        print "  Found " + count_out.trim() + " tools"
    else:
        print "FAIL Tools list failed"
        print "  Response: " + tools_result.stdout
        exit(1)

    print ""
    print "=== All tests passed! ==="
    print ""
    print "The MCP server is working correctly."
    print "You can now use it with Claude Desktop or any MCP client."
    print ""
    print "Configuration for Claude Desktop is already set at:"
    print "  ~/.config/Claude/claude_desktop_config.json"
    print ""
    print "Restart Claude Desktop to activate the MCP server."

main()
