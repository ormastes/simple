# Simple (.spl) replacement for test_mcp_working.sh
# Simple MCP Server Functional Test
#
# Verifies the MCP server binary exists and configuration is correct.

use app.io.mod.{shell_bool, shell_output, file_exists, file_read, exit, cwd, env_get}
use std.string.{trim, contains}

fn main():
    print "=== Simple MCP Server Functional Test ==="
    print ""

    # Check binary exists
    if not shell_bool("test -x bin/simple_mcp_server_optimized"):
        print "FAIL: bin/simple_mcp_server_optimized not found or not executable"
        exit(1)

    print "OK: MCP server binary exists: bin/simple_mcp_server_optimized"

    # Check configuration exists
    val home = env_get("HOME")
    val config_path = "{home}/.config/Claude/claude_desktop_config.json"
    val project_root = cwd()

    if not file_exists(config_path):
        print "WARN: Claude Desktop config not found"
        print "  Create {config_path} with:"
        print "  {"
        print "    \"mcpServers\": {"
        print "      \"simple-lang\": {"
        print "        \"command\": \"{project_root}/bin/simple_mcp_server_optimized\","
        print "        \"args\": [\"server\"],"
        print "        \"env\": {"
        print "          \"SIMPLE_PROJECT_ROOT\": \"{project_root}\""
        print "        }"
        print "      }"
        print "    }"
        print "  }"
    else:
        print "OK: Claude Desktop config exists"
        val config_content = file_read(config_path)
        if contains(config_content, "simple-lang"):
            print "OK: simple-lang MCP server is configured"
        else:
            print "WARN: simple-lang not found in config"

    print ""
    print "=== Server Details ==="
    val binary_path = trim(shell_output("readlink -f bin/simple_mcp_server_optimized"))
    val source_path = trim(shell_output("readlink -f src/app/mcp/bootstrap/main_optimized.spl"))
    print "Binary: {binary_path}"
    print "Source: {source_path}"
    print "Project Root: {project_root}"

    print ""
    print "=== Available MCP Tools ==="
    print "The server provides these tool categories:"
    print "  - Bug Database (bugdb_get, bugdb_add, bugdb_update)"
    print "  - File Operations (simple_read, simple_edit, simple_multi_edit)"
    print "  - Diagnostics (simple_check, simple_symbols, simple_status)"
    print "  - Version Control (simple_diff, simple_log, simple_squash, simple_new)"
    print "  - Debugging (debug_create_session, debug_set_breakpoint, etc.)"
    print "  - Debug Logging (debug_log_enable, debug_log_query, etc.)"

    print ""
    print "=== How to Use ==="
    print "1. Restart Claude Desktop to load the MCP server"
    print "2. Look for the MCP indicator in Claude Desktop UI"
    print "3. Ask Claude to use MCP tools, for example:"
    print "   \"Show me bug BUG-001 using bugdb_get\""
    print "   \"List all files in src/app/mcp/\""
    print "   \"What is the current project status?\""

    print ""
    print "=== Test Result: MCP Server is installed and configured ==="
    print ""
    print "Note: The server uses stdio protocol which is designed for"
    print "      process communication, not direct terminal testing."
    print "      Use Claude Desktop to interact with it."

main()
