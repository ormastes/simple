# Feature Documentation Generator - App (Manual-like) Doc Generator
#
# Generates user-manual style documentation from test/feature/app/ spec files.
# Maps: describe -> Command/Feature section, context -> When subsection, it -> bullet

use app.io.mod (file_write, dir_create)
use app.feature_doc.types.*
use app.feature_doc.usage_docgen (extract_doc_filename)
use std.text.{NL}

# ============================================================================
# App Doc Generation
# ============================================================================

fn generate_app_doc(info: FeatureFileInfo, output_dir: text) -> text:
    """Generate a manual-like markdown doc from an app feature file.

    Returns the output path on success, empty string on failure.
    """
    var md = ""

    # Title
    md = md + "# {info.title}{NL}"
    md = md + "*Source:* `{info.file_path}`{NL}{NL}"

    # Overview from first doc block
    if info.doc_blocks.len() > 0:
        md = md + "## Overview{NL}{NL}"
        val first_block = info.doc_blocks[0]
        val blines = first_block.split(NL)
        var in_syntax = false
        var syntax_lines = []

        for bl in blines:
            val bt = bl.trim()
            # Skip title
            if bt.starts_with("# ") and not bt.starts_with("## "):
                continue
            # Skip metadata
            if bt.starts_with("**Feature") or bt.starts_with("**Category") or bt.starts_with("**Status") or bt.starts_with("**Keywords"):
                continue
            # Detect syntax/command sections for separate rendering
            if bt.starts_with("## Syntax") or bt.starts_with("## Command") or bt.starts_with("## Usage"):
                in_syntax = true
                continue
            if in_syntax and bt.starts_with("## "):
                in_syntax = false
            if in_syntax:
                syntax_lines.push(bl)
                continue
            md = md + bl + NL

        md = md + NL

        # Usage section if syntax found
        if syntax_lines.len() > 0:
            md = md + "## Usage{NL}{NL}"
            for sl in syntax_lines:
                md = md + "    {sl}{NL}"
            md = md + NL

    # Behavior section from describe/context/it structure
    if info.describes.len() > 0:
        md = md + "## Behavior{NL}{NL}"

        for desc in info.describes:
            # Only add describe heading if more than one
            if info.describes.len() > 1:
                md = md + "### {desc.name}{NL}{NL}"

            if desc.doc != "":
                md = md + desc.doc + NL + NL

            for ctx in desc.contexts:
                if ctx.name != "":
                    md = md + "### When {ctx.name}{NL}{NL}"

                if ctx.doc != "":
                    md = md + ctx.doc + NL + NL

                # Its as bullet points
                for it_block in ctx.its:
                    md = md + "- {it_block.name}{NL}"

                md = md + NL

    # Write output
    val filename = extract_doc_filename(info.file_path)
    val output_path = "{output_dir}/{filename}.md"
    dir_create(output_dir, true)
    file_write(output_path, md)
    output_path

export generate_app_doc
