# Feature Documentation Generator - App Index
#
# Generates INDEX.md for app (CLI/tool) documentation.

use app.io.mod (file_write, dir_create)
use app.feature_doc.types.*

fn generate_app_index(infos: [FeatureFileInfo], output_dir: text) -> text:
    """Generate INDEX.md for app docs.

    Returns the output path.
    """
    var md = ""
    md = md + "# App Feature Documentation Index\n\n"
    md = md + "CLI and tool system tests with manual-style documentation.\n\n"

    md = md + "**Total commands/tools:** {infos.len()}\n\n"
    md = md + "---\n\n"

    md = md + "| Command/Tool | Status | Details |\n"
    md = md + "|-------------|--------|---------|\n"

    for info in infos:
        val filename = extract_app_index_filename(info.file_path)
        val status = if info.metadata.status != "": info.metadata.status else: "N/A"
        var it_count = 0
        for desc in info.describes:
            for ctx in desc.contexts:
                it_count = it_count + ctx.its.len()
        md = md + "| [{info.title}]({filename}.md) | {status} | {it_count} behaviors |\n"

    md = md + "\n"

    # Write
    val output_path = "{output_dir}/INDEX.md"
    dir_create(output_dir, true)
    file_write(output_path, md)
    output_path

fn extract_app_index_filename(file_path: text) -> text:
    """Get filename stem from path."""
    val parts = file_path.split("/")
    val filename = parts[-1]
    if filename.ends_with("_spec.spl"):
        return filename[:-9]
    if filename.ends_with(".spl"):
        return filename[:-4]
    filename

export generate_app_index
