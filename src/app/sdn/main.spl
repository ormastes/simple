# SDN CLI - Command line interface for SDN files (Written in Simple)
#
# Usage:
#   sdn check <file>              Validate SDN file
#   sdn to-json <file>            Convert SDN to JSON
#   sdn from-json <file>          Convert JSON to SDN
#   sdn get <file> <path>         Get value at path
#   sdn set <file> <path> <value> Set value at path
#   sdn fmt <file>                Format SDN file

# Use Simple SDN library directly (no FFI needed)
use sdn.{SdnValue, to_sdn, to_json, parse}

# File I/O helpers
use app.io.mod (file_read, file_write, file_exists, cli_get_args, cli_exit)

# Helper to load and parse SDN file
fn load_sdn_file(path: text) -> Result<SdnValue, text>:
    if not file_exists(path):
        return Err("File not found: {path}")

    val content = file_read(path)
    if content == "":
        return Err("Failed to read file: {path}")

    match parse(content):
        Ok(value):
            Ok(value)
        Err(e):
            Err("Parse error: {e}")

# CLI helpers (reuse from io module)

# SDN version constant
val SDN_VERSION = "sdn 0.1.0"

# ============================================================================
# SDN Operation Wrappers
# ============================================================================

fn sdn_check(path: text) -> i64:
    """Validate SDN file - returns 0 on success, 1 on error"""
    match load_sdn_file(path):
        Ok(_):
            0
        Err(e):
            print "error: {e}"
            1

fn sdn_to_json(path: text) -> text:
    """Convert SDN file to JSON string"""
    match load_sdn_file(path):
        Ok(value):
            to_json(value)
        Err(e):
            print "error: {e}"
            ""

fn sdn_from_json(path: text) -> text:
    """Convert JSON file to SDN string"""
    if not file_exists(path):
        print "error: File not found: {path}"
        return ""

    val content = file_read(path)
    if content == "":
        print "error: Failed to read file: {path}"
        return ""

    # TODO: Parse JSON and convert to SDN
    # For now, return error message
    print "error: JSON to SDN conversion not yet implemented"
    ""

fn sdn_get(path: text, key: text) -> text:
    """Get value at path from SDN file"""
    match load_sdn_file(path):
        Ok(root):
            match root.get_path(key):
                Some(value):
                    # Format the value as string
                    to_sdn(value)
                _:
                    ""
        Err(e):
            print "error: {e}"
            ""

fn sdn_set(path: text, key: text, value_str: text) -> i64:
    """Set value at path in SDN file"""
    # TODO: Implement set functionality
    # This requires mutable document API which isn't easily accessible
    # without SdnDocument.from_file() working
    print "error: Set operation not yet implemented"
    1

fn sdn_fmt(path: text) -> i64:
    """Format SDN file (rewrites with proper formatting)"""
    match load_sdn_file(path):
        Ok(value):
            # Re-serialize with proper formatting
            val formatted = to_sdn(value)
            # Write back to file
            if file_write(path, formatted):
                0
            else:
                print "error: Failed to write file: {path}"
                1
        Err(e):
            print "error: {e}"
            1

fn parse_sdn_value(s: text) -> SdnValue:
    """Parse a simple value string into SdnValue"""
    # Handle special keywords
    if s == "null" or s == "nil":
        return SdnValue.Null
    if s == "true":
        return SdnValue.Bool(true)
    if s == "false":
        return SdnValue.Bool(false)

    # Try parsing as integer
    val trimmed = s.trim()
    if try_parse_int(trimmed):
        val num = trimmed.to_int_or(0)
        return SdnValue.Int(num)

    # Try parsing as float
    if trimmed.contains("."):
        val num = trimmed.to_float_or(0.0)
        return SdnValue.Float(num)

    # Default to string
    SdnValue.String(s)

fn try_parse_int(s: text) -> bool:
    """Check if string is a valid integer"""
    if s.is_empty():
        return false

    var start = 0
    # Handle negative sign
    if s[0] == '-':
        if s.len() == 1:
            return false
        start = 1

    # Check all remaining characters are digits
    var i = start
    while i < s.len():
        if not s[i].is_digit():
            return false
        i = i + 1

    true

fn print_usage():
    print "SDN - Simple Data Notation CLI"
    print ""
    print "Usage: sdn <command> [args]"
    print ""
    print "Commands:"
    print "    check <file>                Validate SDN file"
    print "    to-json <file>              Convert SDN to JSON"
    print "    from-json <file>            Convert JSON to SDN (outputs to stdout)"
    print "    get <file> <path>           Get value at path (e.g., server.port)"
    print "    set <file> <path> <value>   Set value at path (modifies file)"
    print "    fmt <file>                  Format SDN file (modifies file)"
    print "    help                        Show this help message"
    print "    version                     Show version"
    print ""
    print "Examples:"
    print "    sdn check config.sdn"
    print "    sdn to-json config.sdn > config.json"
    print "    sdn get config.sdn server.port"
    print "    sdn set config.sdn server.port 9090"
    print "    sdn fmt config.sdn"

fn main() -> i64:
    val all_args = cli_get_args()

    # Skip program name (argv[0]) and script name (argv[1])
    var args = []
    var i = 2
    while i < all_args.len():
        args.push(all_args[i])
        i = i + 1

    if args.len() == 0:
        print_usage()
        return 1

    val cmd = args[0]

    match cmd:
        case "check":
            if args.len() < 2:
                print "error: Usage: sdn check <file>"
                return 1
            val result = sdn_check(args[1])
            if result == 0:
                print "OK: {args[1]}"
            return result

        case "to-json":
            if args.len() < 2:
                print "error: Usage: sdn to-json <file>"
                return 1
            val json = sdn_to_json(args[1])
            if json == "":
                return 1
            print json
            return 0

        case "from-json":
            if args.len() < 2:
                print "error: Usage: sdn from-json <file>"
                return 1
            val sdn_str = sdn_from_json(args[1])
            if sdn_str == "":
                return 1
            print sdn_str
            return 0

        case "get":
            if args.len() < 3:
                print "error: Usage: sdn get <file> <path>"
                return 1
            val value = sdn_get(args[1], args[2])
            if value == "":
                print "error: Path not found: {args[2]}"
                return 1
            print value
            return 0

        case "set":
            if args.len() < 4:
                print "error: Usage: sdn set <file> <path> <value>"
                return 1
            val result = sdn_set(args[1], args[2], args[3])
            if result == 0:
                print "Updated: {args[2]} = {args[3]}"
            return result

        case "fmt":
            if args.len() < 2:
                print "error: Usage: sdn fmt <file>"
                return 1
            val result = sdn_fmt(args[1])
            if result == 0:
                print "Formatted: {args[1]}"
            return result

        case "help" | "--help" | "-h":
            print_usage()
            return 0

        case "version" | "--version" | "-v":
            print SDN_VERSION
            return 0

        case _:
            print "error: Unknown command: {cmd}"
            print_usage()
            return 1
