# SDN CLI - Command line interface for SDN files (Written in Simple)
#
# Usage:
#   sdn check <file>              Validate SDN file
#   sdn to-json <file>            Convert SDN to JSON
#   sdn from-json <file>          Convert JSON to SDN
#   sdn get <file> <path>         Get value at path
#   sdn set <file> <path> <value> Set value at path
#   sdn fmt <file>                Format SDN file

# Use Simple SDN library directly (no FFI needed)
use sdn.{SdnValue, to_sdn, to_json, parse}
use std.json.{JsonValue}

# File I/O helpers
use app.io.io (file_read, file_write, file_exists, cli_get_args, cli_exit)

# Helper to load and parse SDN file
fn load_sdn_file(path: text) -> Result<SdnValue, text>:
    if not file_exists(path):
        return Err("File not found: {path}")

    val content = file_read(path)
    if content == "":
        return Err("Failed to read file: {path}")

    match parse(content):
        Ok(value):
            Ok(value)
        Err(e):
            Err("Parse error: {e}")

# CLI helpers (reuse from io module)

# SDN version constant
val SDN_VERSION = "sdn 0.1.0"

# ============================================================================
# SDN Operation Wrappers
# ============================================================================

fn sdn_check(path: text) -> i64:
    """Validate SDN file - returns 0 on success, 1 on error"""
    match load_sdn_file(path):
        Ok(_):
            0
        Err(e):
            print "error: {e}"
            1

fn sdn_to_json(path: text) -> text:
    """Convert SDN file to JSON string"""
    match load_sdn_file(path):
        Ok(value):
            to_json(value)
        Err(e):
            print "error: {e}"
            ""

fn sdn_from_json(path: text) -> text:
    """Convert JSON file to SDN string"""
    if not file_exists(path):
        print "error: File not found: {path}"
        return ""

    val content = file_read(path)
    if content == "":
        print "error: Failed to read file: {path}"
        return ""

    # Parse JSON
    match JsonValue.parse(content):
        Ok(json_value):
            # Convert to SDN
            val sdn_value = json_to_sdn(json_value)
            # Serialize to SDN format
            to_sdn(sdn_value)
        Err(e):
            print "error: Failed to parse JSON: {e}"
            ""

fn json_to_sdn(json: JsonValue) -> SdnValue:
    """Convert JsonValue to SdnValue.

    Args:
        json - JSON value to convert

    Returns:
        Equivalent SDN value
    """
    match json:
        case JsonValue.Null:
            SdnValue.Null
        case JsonValue.Bool(b):
            SdnValue.Bool(b)
        case JsonValue.Number(n):
            # Check if it's an integer
            if n == n.floor():
                SdnValue.Int(n.to_i64())
            else:
                SdnValue.Float(n)
        case JsonValue.String(s):
            SdnValue.String(s)
        case JsonValue.Array(arr):
            var sdn_arr: [SdnValue] = []
            for item in arr:
                sdn_arr.push(json_to_sdn(item))
            SdnValue.Array(sdn_arr)
        case JsonValue.Object(obj):
            var sdn_dict: Dict<text, SdnValue> = {}
            for key, value in obj:
                sdn_dict[key] = json_to_sdn(value)
            SdnValue.Dict(sdn_dict)

fn sdn_get(path: text, key: text) -> text:
    """Get value at path from SDN file"""
    match load_sdn_file(path):
        Ok(root):
            match root.get_path(key):
                Some(value):
                    # Format the value as string
                    to_sdn(value)
                _:
                    ""
        Err(e):
            print "error: {e}"
            ""

fn sdn_set(path: text, key: text, value_str: text) -> i64:
    """Set value at path in SDN file"""
    # Load the file
    match load_sdn_file(path):
        Ok(root):
            # Parse the value string
            val new_value = parse_sdn_value(value_str)

            # Set the value at the path
            var modified_root = root
            if set_value_at_path(modified_root, key, new_value):
                # Write back to file
                val formatted = to_sdn(modified_root)
                if file_write(path, formatted):
                    0
                else:
                    print "error: Failed to write file: {path}"
                    1
            else:
                print "error: Failed to set value at path '{key}'"
                1
        Err(e):
            print "error: {e}"
            1

fn set_value_at_path(root: SdnValue, path: text, value: SdnValue) -> bool:
    """Set value at a dot-separated path in SDN structure.

    Args:
        root - Root SDN value (must be dict)
        path - Dot-separated path (e.g., "user.name")
        value - Value to set

    Returns:
        true if successful, false otherwise
    """
    # Split path by dots
    val parts = path.split(".")

    if parts.len() == 0:
        return false

    # Navigate to the parent and set the final key
    match root:
        case SdnValue.Dict(dict):
            if parts.len() == 1:
                # Direct assignment
                dict[parts[0]] = value
                return true
            else:
                # Navigate deeper
                val key = parts[0]
                if not dict.contains_key(key):
                    # Create intermediate dict
                    dict[key] = SdnValue.empty_dict()

                # Get or create nested dict
                match dict[key]:
                    case SdnValue.Dict(_):
                        # Recursive call with rest of path
                        val rest_path = parts[1..].join(".")
                        return set_value_at_path(dict[key], rest_path, value)
                    case _:
                        # Can't navigate into non-dict
                        return false
        case _:
            return false

fn sdn_fmt(path: text) -> i64:
    """Format SDN file (rewrites with proper formatting)"""
    match load_sdn_file(path):
        Ok(value):
            # Re-serialize with proper formatting
            val formatted = to_sdn(value)
            # Write back to file
            if file_write(path, formatted):
                0
            else:
                print "error: Failed to write file: {path}"
                1
        Err(e):
            print "error: {e}"
            1

fn parse_sdn_value(s: text) -> SdnValue:
    """Parse a simple value string into SdnValue"""
    # Handle special keywords
    if s == "null" or s == "nil":
        return SdnValue.Null
    if s == "true":
        return SdnValue.Bool(true)
    if s == "false":
        return SdnValue.Bool(false)

    # Try parsing as integer
    val trimmed = s.trim()
    if try_parse_int(trimmed):
        val num = trimmed.to_int_or(0)
        return SdnValue.Int(num)

    # Try parsing as float
    if trimmed.contains("."):
        val num = trimmed.to_float_or(0.0)
        return SdnValue.Float(num)

    # Default to string
    SdnValue.String(s)

fn try_parse_int(s: text) -> bool:
    """Check if string is a valid integer"""
    if s.is_empty():
        return false

    var start = 0
    # Handle negative sign
    if s[0] == '-':
        if s.len() == 1:
            return false
        start = 1

    # Check all remaining characters are digits
    var i = start
    while i < s.len():
        if not s[i].is_digit():
            return false
        i = i + 1

    true

fn print_usage():
    print "SDN - Simple Data Notation CLI"
    print ""
    print "Usage: sdn <command> [args]"
    print ""
    print "Commands:"
    print "    check <file>                Validate SDN file"
    print "    to-json <file>              Convert SDN to JSON"
    print "    from-json <file>            Convert JSON to SDN (outputs to stdout)"
    print "    get <file> <path>           Get value at path (e.g., server.port)"
    print "    set <file> <path> <value>   Set value at path (modifies file)"
    print "    fmt <file>                  Format SDN file (modifies file)"
    print "    help                        Show this help message"
    print "    version                     Show version"
    print ""
    print "Examples:"
    print "    sdn check config.sdn"
    print "    sdn to-json config.sdn > config.json"
    print "    sdn get config.sdn server.port"
    print "    sdn set config.sdn server.port 9090"
    print "    sdn fmt config.sdn"

fn main() -> i64:
    val all_args = cli_get_args()

    # Skip program name (argv[0]) and script name (argv[1])
    var args = []
    var i = 2
    while i < all_args.len():
        args.push(all_args[i])
        i = i + 1

    if args.len() == 0:
        print_usage()
        return 1

    val cmd = args[0]

    match cmd:
        case "check":
            if args.len() < 2:
                print "error: Usage: sdn check <file>"
                return 1
            val result = sdn_check(args[1])
            if result == 0:
                print "OK: {args[1]}"
            return result

        case "to-json":
            if args.len() < 2:
                print "error: Usage: sdn to-json <file>"
                return 1
            val json = sdn_to_json(args[1])
            if json == "":
                return 1
            print json
            return 0

        case "from-json":
            if args.len() < 2:
                print "error: Usage: sdn from-json <file>"
                return 1
            val sdn_str = sdn_from_json(args[1])
            if sdn_str == "":
                return 1
            print sdn_str
            return 0

        case "get":
            if args.len() < 3:
                print "error: Usage: sdn get <file> <path>"
                return 1
            val value = sdn_get(args[1], args[2])
            if value == "":
                print "error: Path not found: {args[2]}"
                return 1
            print value
            return 0

        case "set":
            if args.len() < 4:
                print "error: Usage: sdn set <file> <path> <value>"
                return 1
            val result = sdn_set(args[1], args[2], args[3])
            if result == 0:
                print "Updated: {args[2]} = {args[3]}"
            return result

        case "fmt":
            if args.len() < 2:
                print "error: Usage: sdn fmt <file>"
                return 1
            val result = sdn_fmt(args[1])
            if result == 0:
                print "Formatted: {args[1]}"
            return result

        case "help" | "--help" | "-h":
            print_usage()
            return 0

        case "version" | "--version" | "-v":
            print SDN_VERSION
            return 0

        case _:
            print "error: Unknown command: {cmd}"
            print_usage()
            return 1
