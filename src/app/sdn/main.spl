# SDN CLI - Command line interface for SDN files (Written in Simple)
#
# Usage:
#   sdn check <file>              Validate SDN file
#   sdn to-json <file>            Convert SDN to JSON
#   sdn from-json <file>          Convert JSON to SDN
#   sdn get <file> <path>         Get value at path
#   sdn set <file> <path> <value> Set value at path
#   sdn fmt <file>                Format SDN file

# FFI function declarations for SDN operations
extern fn rt_sdn_check(path: str) -> i64
extern fn rt_sdn_to_json(path: str) -> str
extern fn rt_sdn_from_json(path: str) -> str
extern fn rt_sdn_get(path: str, key: str) -> str
extern fn rt_sdn_set(path: str, key: str, value: str) -> i64
extern fn rt_sdn_fmt(path: str) -> i64
extern fn rt_sdn_version() -> str

# CLI helpers (reuse from cli module)
extern fn rt_cli_get_args() -> [str]
extern fn rt_cli_exit(code: i64)

fn print_usage():
    print "SDN - Simple Data Notation CLI"
    print ""
    print "Usage: sdn <command> [args]"
    print ""
    print "Commands:"
    print "    check <file>                Validate SDN file"
    print "    to-json <file>              Convert SDN to JSON"
    print "    from-json <file>            Convert JSON to SDN (outputs to stdout)"
    print "    get <file> <path>           Get value at path (e.g., server.port)"
    print "    set <file> <path> <value>   Set value at path (modifies file)"
    print "    fmt <file>                  Format SDN file (modifies file)"
    print "    help                        Show this help message"
    print "    version                     Show version"
    print ""
    print "Examples:"
    print "    sdn check config.sdn"
    print "    sdn to-json config.sdn > config.json"
    print "    sdn get config.sdn server.port"
    print "    sdn set config.sdn server.port 9090"
    print "    sdn fmt config.sdn"

fn main() -> i64:
    val all_args = rt_cli_get_args()

    # Skip program name (argv[0]) and script name (argv[1])
    var args = []
    var i = 2
    while i < all_args.len():
        args.push(all_args[i])
        i = i + 1

    if args.len() == 0:
        print_usage()
        return 1

    val cmd = args[0]

    match cmd:
        case "check":
            if args.len() < 2:
                print "error: Usage: sdn check <file>"
                return 1
            val result = rt_sdn_check(args[1])
            if result == 0:
                print "OK: {args[1]}"
            return result

        case "to-json":
            if args.len() < 2:
                print "error: Usage: sdn to-json <file>"
                return 1
            val json = rt_sdn_to_json(args[1])
            if json == "":
                return 1
            print json
            return 0

        case "from-json":
            if args.len() < 2:
                print "error: Usage: sdn from-json <file>"
                return 1
            val sdn = rt_sdn_from_json(args[1])
            if sdn == "":
                return 1
            print sdn
            return 0

        case "get":
            if args.len() < 3:
                print "error: Usage: sdn get <file> <path>"
                return 1
            val value = rt_sdn_get(args[1], args[2])
            if value == "":
                print "error: Path not found: {args[2]}"
                return 1
            print value
            return 0

        case "set":
            if args.len() < 4:
                print "error: Usage: sdn set <file> <path> <value>"
                return 1
            val result = rt_sdn_set(args[1], args[2], args[3])
            if result == 0:
                print "Updated: {args[2]} = {args[3]}"
            return result

        case "fmt":
            if args.len() < 2:
                print "error: Usage: sdn fmt <file>"
                return 1
            val result = rt_sdn_fmt(args[1])
            if result == 0:
                print "Formatted: {args[1]}"
            return result

        case "help" | "--help" | "-h":
            print_usage()
            return 0

        case "version" | "--version" | "-v":
            val ver = rt_sdn_version()
            print ver
            return 0

        case _:
            print "error: Unknown command: {cmd}"
            print_usage()
            return 1
