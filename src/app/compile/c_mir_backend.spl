# MIR-Based C++20 Backend Entry Point
#
# Compiles Simple source to C++20 via the full compiler pipeline:
#   Parse -> HIR -> MIR -> MirToC -> .cpp file
#
# Usage:
#   bin/release/simple src/app/compile/c_mir_backend.spl <source.spl> <output.cpp> [--verbose]
#
# For bootstrap, generate to src/compiler_cpp/:
#   bin/simple compile --backend=c -o src/compiler_cpp/ src/app/cli/main.spl

extern fn rt_cli_get_args() -> [str]

use compiler.driver.driver.*
use compiler.driver.driver_types.{CompileOptions, CompileOptions__default, CompileMode, CompileResult}

fn main() -> i64:
    val args = rt_cli_get_args()
    # args[0] = binary, args[1] = script path, args[2..] = user args
    if args.len() < 4:
        print "Usage: c_mir_backend.spl <source.spl> <output.cpp> [--verbose]"
        return 1

    val source_file = args[2]
    val output_file = args[3]
    var verbose = false
    var i = 4
    while i < args.len():
        if args[i] == "--verbose" or args[i] == "-v":
            verbose = true
        i = i + 1

    val options = CompileOptions__default()
    options.input_files = [source_file]
    options.mode = CompileMode.Aot
    options.output_file = Some(output_file)
    options.backend = "c"
    options.verbose = verbose

    val driver = CompilerDriver__create(options)
    val result = driver.compile()

    match result:
        case CompileResult.Success(_):
            0
        case _:
            val errors = result.get_errors()
            for err in errors:
                print err
            1
