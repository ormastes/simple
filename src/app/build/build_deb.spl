#!/usr/bin/env simple
# Build Debian/Ubuntu .deb package
# Migrated from scripts/build-deb.sh

use app.io
use app.utils.colors (success, error, warning, info)
use std.text.{NL}

export main, build_deb

struct DebConfig:
    version: text
    package_name: text
    package_dir: text

fn main():
    build_deb()

fn build_deb():
    """Build Debian package"""
    print info("Building Debian Package")
    print ""

    # Get version
    val version = get_version()
    val package_name = "simple-lang_{version}_amd64"
    val package_dir = "pkg-deb/{package_name}"

    val config = DebConfig(
        version: version,
        package_name: package_name,
        package_dir: package_dir
    )

    print info("Version: {version}")
    print ""

    # Clean previous build
    clean_previous_build()

    # Create package structure
    print success("Creating package structure...")
    create_package_structure(config)

    # Build runtime
    print success("Building runtime...")
    build_runtime()

    # Copy files
    print success("Copying files...")
    copy_files(config)

    # Create control file
    print success("Generating control file...")
    create_control_file(config)

    # Create maintainer scripts
    create_maintainer_scripts(config)

    # Copy documentation
    print success("Copying documentation...")
    copy_documentation(config)

    # Create changelog
    create_changelog(config)

    # Build package
    print success("Building .deb package...")
    build_package(config)

    # Move to root
    val (_, _, _) = process_run("mv", ["pkg-deb/{package_name}.deb", "."])

    # Show summary
    show_summary(config)

    # Cleanup
    clean_build_dir()

fn get_version() -> text:
    """Get version from VERSION file or Cargo.toml"""
    if file_exists("VERSION"):
        return file_read("VERSION").trim()

    # Fallback to Cargo.toml
    val cargo_path = "rust/driver/Cargo.toml"
    if file_exists(cargo_path):
        val content = file_read(cargo_path)
        val lines = content.split(NL)
        for line in lines:
            if line.starts_with("version = "):
                val start = line.find("\"")
                val end = line.rfind("\"")
                if start >= 0 and end > start:
                    return line.substring(start + 1, end)

    "0.0.0"

fn clean_previous_build():
    """Clean previous build artifacts"""
    if is_dir("pkg-deb"):
        dir_remove("pkg-deb", recursive: true)

fn create_package_structure(config: DebConfig):
    """Create Debian package directory structure"""
    dir_create("{config.package_dir}/DEBIAN", recursive: true)
    dir_create("{config.package_dir}/usr/bin", recursive: true)
    dir_create("{config.package_dir}/usr/lib/simple", recursive: true)
    dir_create("{config.package_dir}/usr/lib/simple/stdlib", recursive: true)
    dir_create("{config.package_dir}/usr/lib/simple/app", recursive: true)
    dir_create("{config.package_dir}/usr/share/doc/simple-lang", recursive: true)
    dir_create("{config.package_dir}/usr/share/man/man1", recursive: true)

fn build_runtime():
    """Build the runtime with release-opt profile"""
    val (_, stderr, code) = process_run("cargo",
        ["build", "--profile", "release-opt", "--manifest-path", "rust/Cargo.toml"])

    if code != 0:
        print error("Failed to build runtime")
        print stderr
        exit(1)

fn copy_files(config: DebConfig):
    """Copy binary and source files"""
    # Copy binary
    val src_binary = "rust/target/release-opt/simple"
    val dst_binary = "{config.package_dir}/usr/lib/simple/simple"
    file_copy(src_binary, dst_binary)

    val (_, _, _) = process_run("chmod", ["755", dst_binary])

    # Create symlink
    val (_, _, _) = process_run("ln", ["-s", "/usr/lib/simple/simple",
                                       "{config.package_dir}/usr/bin/simple"])

    # Copy apps
    val apps = ["cli", "run", "compile", "check", "repl"]
    for app in apps:
        val app_src = "src/app/{app}"
        if is_dir(app_src):
            val (_, _, _) = process_run("cp", ["-r", app_src,
                                               "{config.package_dir}/usr/lib/simple/app/"])

    # Copy stdlib if exists
    if is_dir("src/std/src"):
        val (_, _, _) = process_run("cp", ["-r", "src/std/src/.",
                                           "{config.package_dir}/usr/lib/simple/stdlib/"])

fn create_control_file(config: DebConfig):
    """Create DEBIAN/control file"""
    # Calculate installed size
    val (size_out, _, _) = process_run("du", ["-sk", "{config.package_dir}/usr"])
    val size = size_out.split("\t")[0].trim()

    var control = "Package: simple-lang{NL}"
    control = control + "Version: {config.version}{NL}"
    control = control + "Section: devel{NL}"
    control = control + "Priority: optional{NL}"
    control = control + "Architecture: amd64{NL}"
    control = control + "Maintainer: Simple Language Team <team@simple-lang.org>{NL}"
    control = control + "Homepage: https://simple-lang.org{NL}"
    control = control + "Description: Simple Language Compiler and Runtime{NL}"
    control = control + " The Simple programming language - a modern, fast, and expressive language{NL}"
    control = control + " designed for clarity and productivity.{NL}"
    control = control + " .{NL}"
    control = control + " This package includes:{NL}"
    control = control + "  - Simple runtime and compiler{NL}"
    control = control + "  - Standard library{NL}"
    control = control + "  - Command-line tools (REPL, compiler, checker){NL}"
    control = control + "  - Documentation and examples{NL}"
    control = control + "Depends: libc6 (>= 2.31){NL}"
    control = control + "Installed-Size: {size}{NL}"

    file_write("{config.package_dir}/DEBIAN/control", control)

fn create_maintainer_scripts(config: DebConfig):
    """Create postinst, prerm, postrm scripts"""
    # postinst
    var postinst = "#!/bin/bash{NL}"
    postinst = postinst + "set -e{NL}{NL}"
    postinst = postinst + "# Create cache directory{NL}"
    postinst = postinst + "mkdir -p /var/cache/simple{NL}"
    postinst = postinst + "chmod 755 /var/cache/simple{NL}{NL}"
    postinst = postinst + "# Update ldconfig if needed{NL}"
    postinst = postinst + "if [ -x \"$(command -v ldconfig)\" ]; then{NL}"
    postinst = postinst + "    ldconfig{NL}"
    postinst = postinst + "fi{NL}{NL}"
    postinst = postinst + "echo \"Simple Language installed successfully!\"{NL}"
    postinst = postinst + "echo \"Run: simple --version\"{NL}"

    file_write("{config.package_dir}/DEBIAN/postinst", postinst)
    val (_, _, _) = process_run("chmod", ["755", "{config.package_dir}/DEBIAN/postinst"])

    # prerm
    var prerm = "#!/bin/bash{NL}"
    prerm = prerm + "set -e{NL}"
    prerm = prerm + "# Cleanup will be done by postrm{NL}"

    file_write("{config.package_dir}/DEBIAN/prerm", prerm)
    val (_, _, _) = process_run("chmod", ["755", "{config.package_dir}/DEBIAN/prerm"])

    # postrm
    var postrm = "#!/bin/bash{NL}"
    postrm = postrm + "set -e{NL}{NL}"
    postrm = postrm + "if [ \"$1\" = \"purge\" ]; then{NL}"
    postrm = postrm + "    # Remove cache directory on purge{NL}"
    postrm = postrm + "    rm -rf /var/cache/simple{NL}"
    postrm = postrm + "fi{NL}"

    file_write("{config.package_dir}/DEBIAN/postrm", postrm)
    val (_, _, _) = process_run("chmod", ["755", "{config.package_dir}/DEBIAN/postrm"])

fn copy_documentation(config: DebConfig):
    """Copy documentation files"""
    if file_exists("README.md"):
        file_copy("README.md", "{config.package_dir}/usr/share/doc/simple-lang/README.md")

    if file_exists("LICENSE"):
        file_copy("LICENSE", "{config.package_dir}/usr/share/doc/simple-lang/LICENSE")

fn create_changelog(config: DebConfig):
    """Create Debian changelog"""
    val (date_out, _, _) = process_run("date", ["-R"])
    val date = date_out.trim()

    var changelog = "simple-lang ({config.version}) unstable; urgency=low{NL}{NL}"
    changelog = changelog + "  * Release version {config.version}{NL}{NL}"
    changelog = changelog + " -- Simple Language Team <team@simple-lang.org>  {date}{NL}"

    file_write("{config.package_dir}/usr/share/doc/simple-lang/changelog.Debian", changelog)

    # Compress changelog
    val (_, _, _) = process_run("gzip", ["-9", "{config.package_dir}/usr/share/doc/simple-lang/changelog.Debian"])

fn build_package(config: DebConfig):
    """Build the .deb package"""
    val (_, stderr, code) = process_run("dpkg-deb",
        ["--build", "--root-owner-group", config.package_dir])

    if code != 0:
        print error("Failed to build .deb package")
        print stderr
        exit(1)

fn show_summary(config: DebConfig):
    """Show build summary"""
    val deb_file = "{config.package_name}.deb"
    val size = file_size(deb_file)

    print ""
    print info("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")
    print success("✓ Debian package built successfully")
    print info("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")
    print ""
    print "Package:  {deb_file}"
    print "Size:     {format_size(size)}"
    print "Version:  {config.version}"
    print ""
    print "To install:"
    print "  sudo dpkg -i {deb_file}"
    print "  sudo apt-get install -f  # Fix dependencies if needed"
    print ""
    print "To remove:"
    print "  sudo apt-get remove simple-lang"
    print "  sudo apt-get purge simple-lang  # Remove config and cache"
    print ""

fn clean_build_dir():
    """Clean up build directory"""
    if is_dir("pkg-deb"):
        dir_remove("pkg-deb", recursive: true)

fn format_size(bytes: i64) -> text:
    """Format byte size as human readable"""
    if bytes < 1024:
        return "{bytes}B"

    val kb = bytes / 1024
    if kb < 1024:
        return "{kb}KB"

    val mb = kb / 1024
    if mb < 1024:
        return "{mb}MB"

    val gb = mb / 1024
    "{gb}GB"
