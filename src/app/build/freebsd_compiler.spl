# Simple (.spl) replacement for bin/freebsd/build-freebsd-full-compiler.sh
#
# Build Full FreeBSD Simple Compiler (Incremental Approach)
# Run this script IN the FreeBSD VM
#
# Prerequisites:
# - FreeBSD 14.x system
# - clang++ installed (pkg install clang)
# - seed_cpp binary and runtime files present

use app.io.mod.{shell, shell_bool, shell_output, file_exists, file_write, dir_create_all, exit}
use std.string.{trim}

fn check_freebsd_prerequisites(seed_cpp: text):
    # Returns true if all prerequisites are met
    if not file_exists(seed_cpp):
        print "ERROR: seed_cpp not found at {seed_cpp}"
        print "Please ensure you've extracted the freebsd-simple-compiler.tar.gz package"
        return false

    if not shell_bool("which clang++ >/dev/null 2>&1"):
        print "ERROR: clang++ not found"
        print "Install with: pkg install clang"
        return false

    return true

fn print_limitation_info():
    print "========================================================================"
    print "  LIMITATION DISCOVERED"
    print "========================================================================"
    print ""
    print "The seed_cpp compiler cannot build the full Simple compiler because:"
    print ""
    print "1. seed_cpp supports Core Simple subset only"
    print "   - No generics, lambdas, classes, async"
    print "   - Designed for ~50 files max"
    print ""
    print "2. Full compiler requires 411 files with advanced features"
    print "   - Uses generics, traits, complex type system"
    print "   - Requires full runtime support"
    print ""
    print "3. Available options for full compiler:"
    print "   a) Cross-compile Rust runtime (not automated yet)"
    print "   b) Use LLVM backend (not implemented)"
    print "   c) Build progressively larger subsets (manual process)"
    print ""
    print "========================================================================"
    print ""
    print "RECOMMENDATION: Use seed_cpp for Core Simple programs"
    print ""
    print "The 79KB seed_cpp binary is production-ready for:"
    print "- Functions, structs, enums, control flow"
    print "- String manipulation, arrays"
    print "- Simple applications and scripts"
    print ""
    print "For full Simple language features, the Linux bin/release/simple"
    print "(32MB Rust-based runtime) is currently the reference implementation."
    print ""
    print "To cross-compile full FreeBSD compiler:"
    print "  1. Set up Rust cross-compilation toolchain"
    print "  2. rustup target add x86_64-unknown-freebsd"
    print "  3. cargo build --target x86_64-unknown-freebsd --release"
    print ""
    print "========================================================================"
    print ""

fn build_demo(seed_cpp: text, runtime_c: text, build_dir: text):
    val demo_path = "{build_dir}/demo.spl"
    val demo_source = "# FreeBSD Simple Compiler Demo\n# This demonstrates what seed_cpp CAN compile\n\nfn factorial(n: i64) -> i64:\n    if n <= 1:\n        return 1\n    return n * factorial(n - 1)\n\nfn main():\n    print \"=== FreeBSD Simple Compiler (seed_cpp) ===\"\n    print \"\"\n    print \"Platform: FreeBSD\"\n    print \"Compiler: seed_cpp (Core Simple subset)\"\n    print \"\"\n\n    val numbers: [i64] = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\n    print \"Factorials:\"\n    for n in numbers:\n        val result = factorial(n)\n        print \"  {n}! = {result}\"\n\n    print \"\"\n    print \"* Compilation successful!\"\n    print \"\"\n    print \"Features supported:\"\n    print \"  * Functions and recursion\"\n    print \"  * Variables (val/var)\"\n    print \"  * Arrays and loops\"\n    print \"  * Structs and enums\"\n    print \"  * String interpolation\"\n    print \"\"\n    print \"Features NOT supported:\"\n    print \"  - Generics (<T>)\"\n    print \"  - Lambdas (\\\\x: expr)\"\n    print \"  - Classes\"\n    print \"  - Async/await\"\n"

    file_write(demo_path, demo_source)

    print "Compiling demo.spl..."
    val transpile_result = shell("{seed_cpp} {demo_path} > {build_dir}/demo.cpp")
    if transpile_result.exit_code != 0:
        print "Error: Failed to transpile demo.spl"
        exit(1)
    print "  Generated: demo.cpp"

    val compile_result = shell("clang++ -std=c++20 -o {build_dir}/demo {build_dir}/demo.cpp {runtime_c} -I./runtime")
    if compile_result.exit_code != 0:
        print "Error: Failed to compile demo"
        exit(1)
    print "  Compiled: demo binary"
    print ""

    print "Running demo..."
    print ""
    val run_result = shell("{build_dir}/demo")
    print run_result.stdout

fn main():
    val seed_cpp = "./bin/seed_cpp"
    val runtime_c = "./runtime/runtime.c"
    val build_dir = "./build_output"

    print "========================================================================"
    print "  FreeBSD Full Simple Compiler - Incremental Build"
    print "========================================================================"
    print ""

    # Check prerequisites
    val prereqs_ok = check_freebsd_prerequisites(seed_cpp)
    if not prereqs_ok:
        exit(1)

    dir_create_all(build_dir)

    print "[STATUS] Prerequisites OK"
    print ""

    # Print limitation info
    print_limitation_info()

    # Demonstrate seed_cpp capabilities with a test
    print "Demonstrating seed_cpp capabilities..."
    print ""

    build_demo(seed_cpp, runtime_c, build_dir)

    print ""
    print "========================================================================"
    print "  Summary"
    print "========================================================================"
    print ""
    print "* seed_cpp works perfectly for Core Simple programs"
    print "- Full compiler cannot be built with seed_cpp alone"
    print ""
    print "Next steps:"
    print "  1. Use seed_cpp for production Core Simple programs"
    print "  2. For full features, use Linux bin/release/simple"
    print "  3. For FreeBSD full compiler, need Rust cross-compilation"
    print ""

main()
