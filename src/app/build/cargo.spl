# Cargo Wrapper
#
# Simple wrapper around Rust cargo FFI functions

use app.build.types (BuildResult, BuildError, TestResult, TestError, BuildConfig, profile_to_string)

# FFI declarations
extern fn rt_cargo_build(profile: text, features: [text], feature_count: i64) -> BuildResult
extern fn rt_cargo_test(package: text, filter: text) -> TestResult
extern fn rt_cargo_clean() -> i64
extern fn rt_cargo_check() -> BuildResult

# Cargo class - static methods for cargo operations
class Cargo:
    # Build with given configuration
    static fn build(config: BuildConfig) -> BuildResult:
        val profile_str = profile_to_string(config.profile)
        val feature_count = config.features.len()
        rt_cargo_build(profile_str, config.features, feature_count)

    # Run tests
    static fn test(package: text, filter: text) -> TestResult:
        rt_cargo_test(package, filter)

    # Run all workspace tests
    static fn test_workspace() -> TestResult:
        rt_cargo_test("", "")

    # Clean build artifacts
    static fn clean() -> i64:
        rt_cargo_clean()

    # Check without building
    static fn check() -> BuildResult:
        rt_cargo_check()

# Print build result
fn print_build_result(result: BuildResult):
    if result.success:
        print "Build succeeded in {result.duration_ms}ms"
        if result.stdout.len() > 0:
            print result.stdout
    else:
        print "Build failed with exit code {result.exit_code}"
        if result.stderr.len() > 0:
            print result.stderr

# Print test result
fn print_test_result(result: TestResult):
    if result.success:
        print "Tests passed: {result.tests_passed}/{result.tests_run}"
        if result.tests_failed > 0:
            print "Tests failed: {result.tests_failed}"
    else:
        print "Tests failed with exit code {result.exit_code}"
        if result.stderr.len() > 0:
            print result.stderr

# Check if build succeeded
fn is_build_success(result: BuildResult) -> bool:
    result.success

# Check if tests passed
fn is_test_success(result: TestResult) -> bool:
    result.success
