#!/usr/bin/env simple
# Download mold linker binary for bundling with Simple.
#
# This script downloads pre-built mold binaries from GitHub releases.
# Mold 2.0+ is MIT licensed and can be freely distributed.
#
# Usage:
#   download_mold [--version VERSION] [--output DIR]
#
# Examples:
#   download_mold                     # Download to bin/mold
#   download_mold --version 2.34.0    # Specific version
#   download_mold --output /opt/mold  # Custom output dir
#
# Migrated from scripts/build/download-mold.sh

use app.io
use app.utils.colors (success, error, warning, info)
use std.text.{NL}

export main, download_mold

struct DownloadConfig:
    mold_version: text
    output_dir: text

struct PlatformInfo:
    platform: text
    archive: text
    url: text
    binary_name: text
    prebuilt_available: bool

fn main():
    val args = get_args()
    val config = parse_args(args)
    download_mold(config)

fn parse_args(args: [text]) -> DownloadConfig:
    """Parse command line arguments"""
    var version = env_get("MOLD_VERSION")
    if version.len() == 0:
        version = "2.34.0"

    var output = env_get("OUTPUT_DIR")
    if output.len() == 0:
        output = "bin"

    var i = 0
    while i < args.len():
        val arg = args[i]

        if arg == "--version":
            if i + 1 < args.len():
                version = args[i + 1]
                i = i + 2
            else:
                print error("--version requires a value")
                exit(1)
        elif arg == "--output":
            if i + 1 < args.len():
                output = args[i + 1]
                i = i + 2
            else:
                print error("--output requires a value")
                exit(1)
        elif arg == "--help":
            show_help()
            exit(0)
        else:
            print error("Unknown option: {arg}")
            exit(1)

    DownloadConfig(mold_version: version, output_dir: output)

fn show_help():
    """Show help message"""
    print "Usage: download_mold [--version VERSION] [--output DIR]"
    print ""
    print "Download mold linker binary for bundling with Simple."
    print ""
    print "Options:"
    print "  --version VERSION   Mold version to download (default: 2.34.0)"
    print "  --output DIR        Output directory (default: bin)"
    print ""
    print "Environment variables:"
    print "  MOLD_VERSION        Alternative way to set version"
    print "  OUTPUT_DIR          Alternative way to set output directory"

fn download_mold(config: DownloadConfig):
    """Download and install mold linker"""
    val platform = detect_platform(config)

    print "Detected platform: {platform.platform}"

    # Create output directory
    if not is_dir(config.output_dir):
        dir_create(config.output_dir, recursive: true)

    # Download based on platform
    if platform.prebuilt_available:
        download_prebuilt(config, platform)
    else:
        download_from_system(config, platform)

    # Verify installation
    verify_installation(config, platform)

    print ""
    print success("Installation complete!")
    print ""
    print "Binary location: {config.output_dir}/mold"
    print "To use with Simple:"
    print "  export PATH=\"$(pwd)/{config.output_dir}:$PATH\""
    print "  simple build --native your_program.spl"

fn detect_platform(config: DownloadConfig) -> PlatformInfo:
    """Detect platform and return download configuration"""
    val (os_name, _, _) = process_run("uname", ["-s"])
    val (arch, _, _) = process_run("uname", ["-m"])

    val os = os_name.trim()
    val machine = arch.trim()
    val platform = "{os}-{machine}"

    if os == "Linux" and machine == "x86_64":
        val archive = "mold-{config.mold_version}-x86_64-linux.tar.gz"
        val url = "https://github.com/rui314/mold/releases/download/v{config.mold_version}/{archive}"
        PlatformInfo(
            platform: platform,
            archive: archive,
            url: url,
            binary_name: "mold-linux-x86_64",
            prebuilt_available: true
        )
    elif os == "Linux" and machine == "aarch64":
        val archive = "mold-{config.mold_version}-aarch64-linux.tar.gz"
        val url = "https://github.com/rui314/mold/releases/download/v{config.mold_version}/{archive}"
        PlatformInfo(
            platform: platform,
            archive: archive,
            url: url,
            binary_name: "mold-linux-aarch64",
            prebuilt_available: true
        )
    elif os == "Darwin" and machine == "x86_64":
        print warning("Note: mold for macOS Intel - using Homebrew is recommended")
        print "Install with: brew install mold"
        print ""
        PlatformInfo(
            platform: platform,
            archive: "",
            url: "",
            binary_name: "mold-macos-x86_64",
            prebuilt_available: false
        )
    elif os == "Darwin" and machine == "arm64":
        print warning("Note: mold for macOS Apple Silicon - using Homebrew is recommended")
        print "Install with: brew install mold"
        print ""
        PlatformInfo(
            platform: platform,
            archive: "",
            url: "",
            binary_name: "mold-macos-aarch64",
            prebuilt_available: false
        )
    else:
        print error("Unsupported platform: {platform}")
        print "Supported platforms: Linux-x86_64, Linux-aarch64, Darwin-x86_64, Darwin-arm64"
        exit(1)
        # Unreachable but needed for type checker
        PlatformInfo(platform: "", archive: "", url: "", binary_name: "", prebuilt_available: false)

fn download_prebuilt(config: DownloadConfig, platform: PlatformInfo):
    """Download pre-built binary for Linux"""
    print "Downloading mold v{config.mold_version}..."
    print "URL: {platform.url}"

    # Create temp directory
    val temp_dir = create_temp_dir()

    # Download and extract
    print "Downloading and extracting..."
    val download_cmd = "curl -L --progress-bar \"{platform.url}\" | tar xz -C \"{temp_dir}\""
    val (_, stderr, code) = process_run("sh", ["-c", download_cmd])

    if code != 0:
        print error("Failed to download and extract mold")
        print stderr
        cleanup_temp_dir(temp_dir)
        exit(1)

    # Find the mold binary
    val (find_out, _, find_code) = process_run("find",
        [temp_dir, "-name", "mold", "-type", "f", "-executable"])

    if find_code != 0 or find_out.trim().len() == 0:
        print error("Could not find mold binary in archive")
        cleanup_temp_dir(temp_dir)
        exit(1)

    val mold_bin = find_out.split(NL)[0].trim()

    # Copy to output directory
    val dest = "{config.output_dir}/{platform.binary_name}"
    val (_, _, copy_code) = process_run("cp", [mold_bin, dest])
    if copy_code != 0:
        print error("Failed to copy mold binary")
        cleanup_temp_dir(temp_dir)
        exit(1)

    val (_, _, chmod_code) = process_run("chmod", ["+x", dest])
    if chmod_code != 0:
        print error("Failed to make mold executable")

    # Create symlink
    val (_, _, _) = process_run("ln", ["-sf", platform.binary_name, "{config.output_dir}/mold"])

    print success("Successfully installed mold to {dest}")
    print ""

    # Download license
    print "Downloading MIT license..."
    val license_url = "https://raw.githubusercontent.com/rui314/mold/v{config.mold_version}/LICENSE"
    val license_dest = "{config.output_dir}/MOLD_LICENSE"
    val (_, _, license_code) = process_run("curl", ["-sL", license_url, "-o", license_dest])

    if license_code == 0:
        print "License saved to {license_dest}"
    else:
        print warning("Failed to download license file")

    # Cleanup
    cleanup_temp_dir(temp_dir)

fn download_from_system(config: DownloadConfig, platform: PlatformInfo):
    """Copy mold from system (macOS)"""
    # Check if mold is available in system
    val (which_out, _, which_code) = process_run("which", ["mold"])

    if which_code == 0 and which_out.trim().len() > 0:
        val system_mold = which_out.trim()
        print "Found system mold at: {system_mold}"
        print "Copying to {config.output_dir}/{platform.binary_name}"

        val dest = "{config.output_dir}/{platform.binary_name}"
        val (_, _, copy_code) = process_run("cp", [system_mold, dest])
        if copy_code != 0:
            print error("Failed to copy mold binary")
            exit(1)

        val (_, _, chmod_code) = process_run("chmod", ["+x", dest])
        if chmod_code != 0:
            print error("Failed to make mold executable")

        # Create symlink
        val (_, _, _) = process_run("ln", ["-sf", platform.binary_name, "{config.output_dir}/mold"])
    else:
        print error("Error: mold not found on this macOS system.")
        print ""
        print "Please install mold using Homebrew:"
        print "  brew install mold"
        print ""
        print "Then run this script again."
        exit(1)

fn verify_installation(config: DownloadConfig, platform: PlatformInfo):
    """Verify that mold was installed correctly"""
    print ""
    print "Verifying installation..."

    val mold_path = "{config.output_dir}/mold"
    val (version_out, _, version_code) = process_run(mold_path, ["--version"])

    if version_code == 0:
        print version_out
    else:
        print error("Failed to verify mold installation")
        exit(1)

fn create_temp_dir() -> text:
    """Create a temporary directory"""
    val (temp_out, _, code) = process_run("mktemp", ["-d"])
    if code != 0:
        print error("Failed to create temporary directory")
        exit(1)
    temp_out.trim()

fn cleanup_temp_dir(temp_dir: text):
    """Clean up temporary directory"""
    if is_dir(temp_dir):
        dir_remove(temp_dir, recursive: true)
