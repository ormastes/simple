# Pure Simple Compilation to LLVM IR
#
# Compiles Simple source files to LLVM IR using the pure Simple compiler.
# No Rust FFI required - everything is in Simple!

use compiler.driver (CompilerDriver, CompileOptions, CompileMode, CompileResult)
use compiler.backend.llvm_backend (LlvmBackend, MirToLlvm, CodegenTarget, OptimizationLevel)
use compiler.mir_data (MirModule)

export compile_to_llvm_ir_pure

# Compile Simple source file to LLVM IR text
fn compile_to_llvm_ir_pure(source_file: text, target_triple: text, bare_metal: bool) -> (text, text, i64):
    """
    Compile Simple source to LLVM IR using pure Simple compiler.

    Returns: (llvm_ir: text, stderr: text, exit_code: i64)
    """

    # Step 1: Parse and compile to MIR using CompilerDriver
    val options = CompileOptions.default()
    options.input_files = [source_file]
    options.mode = CompileMode.Check  # Parse + type check + lower to MIR

    val driver = CompilerDriver.create(options)
    val result = driver.compile()

    match result:
        case CompileResult.ParseError(errors):
            val error_msg = errors.join("\n")
            return ("", "Parse error:\n{error_msg}", 1)

        case CompileResult.TypeError(errors):
            val error_msg = errors.join("\n")
            return ("", "Type error:\n{error_msg}", 1)

        case CompileResult.Success(mir_module):
            # Step 2: Translate MIR to LLVM IR
            val backend = if bare_metal:
                LlvmBackend.create_baremetal(CodegenTarget.X86, OptimizationLevel.Size)
            else:
                LlvmBackend.create(CodegenTarget.X86, OptimizationLevel.Speed)

            # Get the MIR module (need to extract from result)
            # NOTE: Fix this - need to get MIR from CompileResult
            val mir = MirModule.empty()  # Placeholder

            # Create translator
            val translator = MirToLlvm.create("module", CodegenTarget.X86, nil)
            val llvm_ir = translator.translate_module(mir)

            return (llvm_ir, "", 0)

        case _:
            return ("", "Unknown compilation error", 1)
