# Build Configuration
#
# Loads and parses build configuration from simple.sdn

use app.build.types (BuildConfig, BuildProfile, profile_from_string, OptimizationLevel, opt_level_from_string, default_opt_level_for_profile)

# Default configuration
fn default_config() -> BuildConfig:
    BuildConfig(
        profile: BuildProfile.Debug,
        features: [],
        workspace_root: "build/rust/ffi_gen",  # Generated by simple ffi-gen
        target_dir: "build/rust/ffi_gen/target",
        jobs: 4,
        verbose: false,
        opt_level: OptimizationLevel.None,  # No optimization for debug
        show_opt_stats: false
    )

# Load configuration from simple.sdn
fn load_config(profile: BuildProfile, verbose: bool, opt_level: OptimizationLevel?, show_opt_stats: bool) -> BuildConfig:
    var config = default_config()
    config.profile = profile
    config.verbose = verbose
    config.show_opt_stats = show_opt_stats

    # Set optimization level (use provided or default for profile)
    config.opt_level = if opt_level.?:
        opt_level.unwrap()
    else:
        default_opt_level_for_profile(profile)

    # TODO: Parse simple.sdn for custom build settings
    # For now, use defaults

    config

# Parse command-line arguments
fn parse_build_args(args: [text]) -> BuildConfig:
    var profile = BuildProfile.Debug
    var features: [text] = []
    var verbose = false
    var opt_level: OptimizationLevel? = nil
    var show_opt_stats = false

    for arg in args:
        if arg == "--verbose" or arg == "-v":
            verbose = true
        elif arg.starts_with("--profile="):
            val profile_str: text = arg[10:]
            profile = profile_from_string(profile_str)
        elif arg == "--release":
            profile = BuildProfile.Release
        elif arg == "--bootstrap":
            profile = BuildProfile.Bootstrap
        # TODO: Re-enable features flag parsing after fixing type inference bug
        # elif arg.starts_with("--features="):
        #     val features_str: text = arg[11:]
        #     features = features_str.split(",")
        # MIR Optimization flags (NEW!)
        elif arg.starts_with("--opt-level="):
            val level_str: text = arg[12:]
            opt_level = Some(opt_level_from_string(level_str))
        elif arg == "-O0":
            opt_level = Some(OptimizationLevel.None)
        elif arg == "-Os":
            opt_level = Some(OptimizationLevel.Size)
        elif arg == "-O2":
            opt_level = Some(OptimizationLevel.Speed)
        elif arg == "-O3":
            opt_level = Some(OptimizationLevel.Aggressive)
        elif arg == "--show-opt-stats":
            show_opt_stats = true

    load_config(profile, verbose, opt_level, show_opt_stats)
