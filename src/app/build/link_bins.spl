# Link Binaries
#
# Simple (.spl) replacement for script/build/link-bins.bat
# Links binaries from bin/rust/ to bin/simple/ for cross-platform use

use app.io.mod.{shell, cwd, file_exists, file_delete, dir_create_all, is_dir}
use std.log.{warn}

fn main():
    val project_root = cwd()
    val bin_rust = "bin/rust"
    val bin_simple = "bin/simple"

    print "Creating binary symlinks..."

    # Create bin/simple directory if it doesn't exist
    if not is_dir(bin_simple):
        dir_create_all(bin_simple)

    # Define binaries to link
    val binaries = ["simple", "simple-fmt", "simple-lint", "simple-test", "smh_coverage"]

    var linked_count = 0
    var skipped_count = 0

    for binary in binaries:
        val src_path = "{bin_rust}/{binary}"
        val dst_path = "{bin_simple}/{binary}"

        if file_exists(src_path):
            print "  Linking {binary}..."

            # Remove existing link if present
            if file_exists(dst_path):
                file_delete(dst_path)

            # Create symlink (relative path from bin/simple/ to bin/rust/)
            val link_target = "../rust/{binary}"
            val result = shell("ln -sf '{link_target}' '{dst_path}'")

            if result.exit_code == 0:
                linked_count = linked_count + 1
            else:
                print "  Failed to link {binary}"
        else:
            warn("build", "{src_path} not found, skipping")
            skipped_count = skipped_count + 1

    print ""
    print "Binary links created in {bin_simple} ({linked_count} linked, {skipped_count} skipped)"
    print ""
    print "Add to your PATH:"
    print "  export PATH=\"$(pwd)/{bin_simple}:$PATH\""

main()
