#!/usr/bin/env simple
# Link binaries from bin/rust/ to bin/simple/ for cross-platform compatibility
# Migrated from script/build/link-bins.sh

use app.io
use app.utils.colors (success, error, warning, info)

export main, link_bins

fn main():
    val result = link_bins()
    if not result:
        exit(1)

fn link_bins() -> bool:
    """Create symlinks for binaries from bin/rust/ to bin/simple/"""

    # Get project root (assuming we're in script/build/)
    val script_dir = cwd()
    val project_root = script_dir  # cwd() is project root when run via `bin/simple`

    val bin_rust = "bin/rust"
    val bin_simple = "bin/simple"

    print info("Creating binary symlinks...")

    # Create bin/simple directory if it doesn't exist
    if not is_dir(bin_simple):
        dir_create(bin_simple, recursive: true)

    # Define binaries to link
    val binaries = [
        "simple",
        "simple-fmt",
        "simple-lint",
        "simple-test",
        "smh_coverage"
    ]

    var all_success = true
    var linked_count = 0
    var skipped_count = 0

    # Create symlinks
    for binary in binaries:
        val src_path = "{bin_rust}/{binary}"
        val dst_path = "{bin_simple}/{binary}"

        if file_exists(src_path):
            print "  Linking {binary}..."

            # Remove existing link if present
            if file_exists(dst_path):
                file_delete(dst_path)

            # Create symlink (relative path from bin/simple/ to bin/rust/)
            val link_target = "../rust/{binary}"
            val result = shell("ln -sf '{link_target}' '{dst_path}'")

            if result.exit_code == 0:
                linked_count = linked_count + 1
            else:
                print error("  Failed to link {binary}")
                all_success = false
        else:
            print warning("  Warning: {src_path} not found, skipping")
            skipped_count = skipped_count + 1

    print ""
    if all_success:
        print success("✅ Binary links created in {bin_simple}")
        print ""
        print "Add to your PATH:"
        print "  export PATH=\"$(pwd)/{bin_simple}:\$PATH\""
        true
    else:
        print error("❌ Some links failed to create")
        false
