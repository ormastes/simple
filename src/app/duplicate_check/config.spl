# Configuration handling for duplication detection

use app.io.mod.{file_exists, file_read}
use std.config_parser.{parse_sdn_config, find_section, get_config_int, get_config_bool, get_config_field, get_config_float}

struct DuplicationConfig:
    min_tokens: i64
    min_lines: i64
    ignore_identifiers: bool
    ignore_literals: bool
    ignore_comments: bool
    ignore_whitespace: bool
    similarity_threshold: f64
    output_format: text
    report_path: text
    max_allowed: i64
    min_impact: i64
    exclude_patterns: [text]
    use_ast_features: bool
    use_cosine_similarity: bool
    verbose: bool
    quiet: bool
    use_parallel: bool          # Enable parallel processing
    num_workers: i64            # Number of workers (0 = auto)
    use_incremental: bool       # Enable incremental analysis
    incremental_cache_path: text  # Path to incremental cache
    use_semantic: bool            # Enable semantic doc similarity
    semantic_threshold: f64       # Similarity threshold (default: 0.90)
    semantic_drift_threshold: f64 # Drift warning threshold (default: 0.40)
    semantic_model: text          # Ollama model (default: nomic-embed-text)
    ollama_url: text              # Ollama base URL
    rebuild_embeddings: bool      # Force rebuild embedding cache

fn default_config() -> DuplicationConfig:
    DuplicationConfig(
        min_tokens: 30,
        min_lines: 5,
        ignore_identifiers: true,
        ignore_literals: false,
        ignore_comments: true,
        ignore_whitespace: true,
        similarity_threshold: 0.85,
        output_format: "text",
        report_path: "doc/analysis/duplicate_db.sdn",
        max_allowed: 0,
        min_impact: 50,
        exclude_patterns: ["test/", "doc/", "**/*_spec.spl", "**/*_test.spl"],
        use_ast_features: false,
        use_cosine_similarity: false,
        verbose: false,
        quiet: false,
        use_parallel: false,
        num_workers: 0,
        use_incremental: false,
        incremental_cache_path: ".duplicate_cache.sdn",
        use_semantic: false,
        semantic_threshold: 0.90,
        semantic_drift_threshold: 0.40,
        semantic_model: "nomic-embed-text",
        ollama_url: "http://localhost:11434",
        rebuild_embeddings: false
    )

fn parse_config_file(content: text) -> DuplicationConfig:
    var config = default_config()

    val result = parse_sdn_config(content)
    val section_opt = find_section(result, "duplicate-check")

    if not section_opt.?:
        return config

    val section = section_opt ?? default_section()

    # Parse simple key-value fields
    config.min_tokens = get_config_int(section, "min-tokens", config.min_tokens)
    config.min_lines = get_config_int(section, "min-lines", config.min_lines)
    config.max_allowed = get_config_int(section, "max-allowed", config.max_allowed)
    config.min_impact = get_config_int(section, "min-impact", config.min_impact)

    config.ignore_identifiers = get_config_bool(section, "ignore-identifiers", config.ignore_identifiers)
    config.ignore_literals = get_config_bool(section, "ignore-literals", config.ignore_literals)
    config.ignore_comments = get_config_bool(section, "ignore-comments", config.ignore_comments)
    config.ignore_whitespace = get_config_bool(section, "ignore-whitespace", config.ignore_whitespace)
    config.use_ast_features = get_config_bool(section, "use-ast-features", config.use_ast_features)
    config.use_cosine_similarity = get_config_bool(section, "use-cosine-similarity", config.use_cosine_similarity)

    config.similarity_threshold = get_config_float(section, "similarity-threshold", config.similarity_threshold)

    config.output_format = get_config_field(section, "output-format", config.output_format)
    config.report_path = get_config_field(section, "report-path", config.report_path)

    # Semantic analysis config
    config.use_semantic = get_config_bool(section, "use-semantic", config.use_semantic)
    config.semantic_threshold = get_config_float(section, "semantic-threshold", config.semantic_threshold)
    config.semantic_drift_threshold = get_config_float(section, "semantic-drift-threshold", config.semantic_drift_threshold)
    config.semantic_model = get_config_field(section, "semantic-model", config.semantic_model)
    config.ollama_url = get_config_field(section, "ollama-url", config.ollama_url)
    config.rebuild_embeddings = get_config_bool(section, "rebuild-embeddings", config.rebuild_embeddings)

    # Parse exclude patterns (list field)
    val exclude_str = get_config_field(section, "exclude", "")
    if exclude_str.len() > 0:
        config.exclude_patterns = parse_exclude_patterns(exclude_str)

    config

fn default_section():
    # Helper for unwrapping Optional - never called
    val fields = {}
    val sec = ConfigSection(name: "", fields: fields)
    sec

fn parse_exclude_patterns(patterns_str: text) -> [text]:
    """Parse exclude patterns from comma-separated string or array format."""
    var result = []

    # Remove brackets if present: ["pattern1", "pattern2"] -> pattern1", "pattern2
    var cleaned = patterns_str
    if cleaned.starts_with("["):
        cleaned = cleaned[1:]
    if cleaned.ends_with("]"):
        val end_idx = cleaned.len() - 1
        cleaned = cleaned[0:end_idx]

    # Split by comma
    val parts = cleaned.split(",")
    for part in parts:
        var trimmed = part.trim()

        # Remove quotes
        if trimmed.len() >= 2:
            val first = trimmed[0:1]
            val last_idx = trimmed.len() - 1
            val last = trimmed[last_idx:]
            val both_double = (first == "\"" and last == "\"")
            val both_single = (first == "'" and last == "'")
            if both_double or both_single:
                trimmed = trimmed[1:last_idx]

        if trimmed.len() > 0:
            result = result + [trimmed]

    result

# Need to import ConfigSection type for default_section helper
use std.config_parser.{ConfigSection}

fn load_config() -> DuplicationConfig:
    val config_path = "simple.duplicate-check.sdn"

    if file_exists(config_path):
        val content = file_read(config_path)
        parse_config_file(content)
    else:
        default_config()

export DuplicationConfig, default_config, parse_config_file, load_config
