#!/usr/bin/env simple
# Standalone Parser - Uses patched lib.parser
# Compiles to native executable that supports ?? return

use lib.parser.parser (parse, parse_expr)
use app.io.mod (env_get, cli_read_file)

fn main():
    val args_raw = env_get("ARGS")
    val args = if args_raw == nil: "" else: args_raw

    if args == "" or args == "--help":
        print "Simple Standalone Parser (with ?? return support)"
        print ""
        print "Usage:"
        print "  standalone_parser <file.spl>          Parse and validate file"
        print "  standalone_parser --expr \"code\"       Parse expression"
        print "  standalone_parser --test               Run self-test"
        return

    if args == "--test":
        run_self_test()
        return

    var is_expr = false
    var code_start = 0
    if args.len() >= 7:
        val prefix = args[0:7]
        if prefix == "--expr ":
            is_expr = true
            code_start = 7

    if is_expr:
        val code = args[code_start:]
        test_expression(code)
        return

    # Parse file
    val content = cli_read_file(args)
    test_file(content, args)

fn run_self_test():
    print "Running self-tests..."
    print ""

    # Test 1: Simple expression
    test_expression("1 + 2")

    # Test 2: Return expression (THE FIX!)
    test_expression("return Err(\"error\")")

    # Test 3: ?? return (FULL FIX!)
    test_expression("x ?? return Err(\"failed\")")

    print ""
    print "Self-tests complete!"

fn test_expression(code: text):
    print "Testing: {code}"

    match parse_expr(code):
        case Ok(expr):
            print "  ✓ Parse succeeded"
        case Err(e):
            print "  ✗ Parse failed: {e.message}"

fn test_file(content: text, filename: text):
    print "Parsing file: {filename}"

    match parse(content):
        case Ok(module):
            val count = module.statements.len()
            print "  ✓ Parse succeeded: {count} statements"
        case Err(e):
            print "  ✗ Parse failed: {e.message}"
            print "     Line {e.line}, Column {e.column}"
