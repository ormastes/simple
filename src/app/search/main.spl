# Simple CLI - search command
# Search the package registry index

use lib.cli.cli_util (get_cli_args)
use app.package.registry.config (default_config)
use app.package.registry.index (search_packages)
use std.log.{error}

fn print_help():
    print "Usage: simple search <query> [options]"
    print ""
    print "Search the Simple package registry."
    print ""
    print "Options:"
    print "  --limit=N     Max results (default: 20)"
    print "  -h, --help    Show this help"
    print ""
    print "Examples:"
    print "  simple search http"
    print "  simple search json --limit=5"

fn print_error(msg: text):
    error("search", msg)

fn main() -> i64:
    val args = get_cli_args()

    var query = ""
    var limit = 20

    var i = 0
    while i < args.len():
        val arg = args[i]
        if arg == "-h" or arg == "--help":
            print_help()
            return 0
        elif arg.starts_with("--limit="):
            limit = arg[8:].to_int()
        elif arg == "search":
            pass
        elif query == "":
            query = arg
        i = i + 1

    if query == "":
        print_error("search requires a query argument")
        print ""
        print_help()
        return 1

    val config = default_config()
    val results = search_packages(config, query, limit)

    if results.len() == 0:
        print "No packages found matching '{query}'"
        return 0

    print "Packages matching '{query}':"
    print ""

    for result in results:
        print "  {result.name} ({result.latest_version})"
        if result.description != "":
            print "    {result.description}"
        print ""

    print "{results.len()} package(s) found"
    return 0
