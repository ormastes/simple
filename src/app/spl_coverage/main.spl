# Simple Code Coverage Analyzer
#
# Analyzes branch/decision coverage for Simple language (.spl) source files

use std.cli.cli_util (get_cli_args)

# Coverage imports from io module
use app.io.mod (coverage_dump_sdn, coverage_enabled, coverage_clear)

fn print_help():
    print "Usage: simple spl-coverage [command]"
    print ""
    print "Commands:"
    print "  dump      Dump coverage data to stdout (redirect to save)"
    print "            Example: simple spl-coverage dump > coverage.sdn"
    print ""
    print "  status    Show coverage status and summary"
    print ""
    print "  clear     Clear coverage data"
    print ""
    print "Note: Set SIMPLE_COVERAGE=1 before running tests to enable coverage tracking"

fn get_arg(args: [text], flag: text, default_val: text) -> text:
    var i = 0
    while i < args.len() - 1:
        if args[i] == flag:
            return args[i + 1]
        i = i + 1
    default_val

fn cmd_dump(args: [text]) -> i64:
    if not coverage_enabled():
        print "Error: Coverage not enabled. Set SIMPLE_COVERAGE=1 environment variable."
        return 1

    val coverage_sdn = coverage_dump_sdn()
    print coverage_sdn
    return 0

fn cmd_status() -> i64:
    if coverage_enabled():
        print "✓ Coverage tracking is ENABLED (SIMPLE_COVERAGE=1)"

        # Dump current stats
        val coverage_sdn = coverage_dump_sdn()
        print ""
        print "Current coverage data:"
        print coverage_sdn
        return 0
    else:
        print "✗ Coverage tracking is DISABLED"
        print ""
        print "To enable coverage tracking:"
        print "  export SIMPLE_COVERAGE=1"
        print "  simple test"
        return 1

fn cmd_clear() -> i64:
    if not coverage_enabled():
        print "Warning: Coverage not enabled"
        return 1

    coverage_clear()
    print "✓ Coverage data cleared"
    return 0

fn main() -> i64:
    val args = get_cli_args()

    if args.len() < 1:
        print_help()
        return 0

    val command = args[0]

    match command:
        case "dump":
            return cmd_dump(args)
        case "status":
            return cmd_status()
        case "clear":
            return cmd_clear()
        case "--help" | "-h" | "help":
            print_help()
            return 0
        case _:
            print "Unknown command: {command}"
            print_help()
            return 1
