# Registry Authentication
# GitHub PAT token management for GHCR access

use app.package.registry.types (Credentials)
use app.package.registry.config (default_config)

use app.io.mod (env_get, file_exists, file_read, file_write, dir_create, home)
use std.db_atomic.{atomic_write, DbConfig}
use std.log.{error}

# Resolve credentials in priority order:
# 1. SIMPLE_TOKEN env var
# 2. ~/.simple/credentials.sdn file
# 3. nil (returns empty token)
fn resolve_credentials() -> Credentials:
    # Check environment variable first (CI/CD friendly)
    val env_token = env_get("SIMPLE_TOKEN")
    if env_token != "":
        return Credentials(token: env_token, token_type: "env")

    # Check credentials file
    val config = default_config()
    if file_exists(config.credentials_path):
        val content = file_read(config.credentials_path)
        val token = parse_token_from_sdn(content)
        if token != "":
            return Credentials(token: token, token_type: "file")

    # No credentials found
    Credentials(token: "", token_type: "none")

fn has_credentials() -> bool:
    val creds = resolve_credentials()
    creds.token != ""

# Save a token to the credentials file atomically (CRITICAL - contains auth tokens!)
fn save_credentials(token: text) -> bool:
    val home = home()
    val dir = "{home}/.simple"
    dir_create(dir, true)

    val content = "# Simple Registry Credentials\n# Generated by 'simple login'\n\nregistry:\n  token: {token}\n  type: github_pat\n"
    val write_result = atomic_write("{dir}/credentials.sdn", content, DbConfig__defaults())
    write_result.ok.?

# Parse token from SDN credentials file
# Simple line-based parsing for the credentials format
fn parse_token_from_sdn(content: text) -> text:
    val lines = content.split("\n")
    for line in lines:
        val trimmed = line.trim()
        if trimmed.starts_with("token:"):
            val value = trimmed[6:].trim()
            return value
    ""

# Get token for use with oras CLI
fn get_token() -> text:
    val creds = resolve_credentials()
    creds.token

fn print_auth_error():
    error("registry", "not authenticated - no credentials found")
    print "error: not authenticated"
    print ""
    print "To authenticate, either:"
    print "  1. Set SIMPLE_TOKEN environment variable"
    print "  2. Run 'simple login' to save credentials"
    print ""
    print "Required GitHub PAT scopes: read:packages, write:packages"
