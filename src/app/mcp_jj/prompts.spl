# prompts.spl - MCP Prompts for jj-git server
#
# Provides 4 prompts:
#   jj-workflow       - Standard jj workflow guide
#   git-to-jj         - Git to jj translation guide
#   revset-reference   - Revset language quick reference
#   jj-concepts        - Key jj concepts explained

use app.mcp_jj.helpers.{LB, RB, Q, jp, js, jo1, jo2, jo3, escape_json}

fn get_all_prompts() -> String:
    var prompts = "["

    # jj-workflow
    var p1 = LB()
    p1 = p1 + jp("name", js("jj-workflow"))
    p1 = p1 + "," + jp("description", js("Standard Jujutsu (jj) workflow guide: creating changes, describing, pushing"))
    p1 = p1 + RB()
    prompts = prompts + p1

    # git-to-jj
    var p2 = LB()
    p2 = p2 + jp("name", js("git-to-jj"))
    p2 = p2 + "," + jp("description", js("Translation guide from Git commands and concepts to jj equivalents"))
    p2 = p2 + RB()
    prompts = prompts + "," + p2

    # revset-reference
    var p3 = LB()
    p3 = p3 + jp("name", js("revset-reference"))
    p3 = p3 + "," + jp("description", js("Revset expression language quick reference for querying commits"))
    p3 = p3 + RB()
    prompts = prompts + "," + p3

    # jj-concepts
    var p4 = LB()
    p4 = p4 + jp("name", js("jj-concepts"))
    p4 = p4 + "," + jp("description", js("Key Jujutsu concepts: working copy as commit, change IDs, operations, conflicts"))
    p4 = p4 + RB()
    prompts = prompts + "," + p4

    prompts = prompts + "]"
    prompts

fn get_prompt(name: String) -> String:
    if name == "jj-workflow":
        return make_prompt_response(get_jj_workflow_content())
    elif name == "git-to-jj":
        return make_prompt_response(get_git_to_jj_content())
    elif name == "revset-reference":
        return make_prompt_response(get_revset_reference_content())
    elif name == "jj-concepts":
        return make_prompt_response(get_jj_concepts_content())
    else:
        return ""

fn make_prompt_response(content: String) -> String:
    var msg = LB()
    msg = msg + jp("role", js("user"))
    var text_content = LB()
    text_content = text_content + jp("type", js("text"))
    text_content = text_content + "," + jp("text", js(escape_json(content)))
    text_content = text_content + RB()
    msg = msg + "," + jp("content", text_content)
    msg = msg + RB()

    var result = LB()
    result = result + jp("messages", "[" + msg + "]")
    result = result + RB()
    result

fn get_jj_workflow_content() -> String:
    var s = "# Jujutsu (jj) Workflow Guide\n\n"
    s = s + "## Basic Workflow\n\n"
    s = s + "1. **Start working**: Your working copy IS already a commit in jj.\n"
    s = s + "   Just start editing files - changes are automatically tracked.\n\n"
    s = s + "2. **Describe your change**:\n"
    s = s + "   ```\n   jj describe -m 'Add feature X'\n   ```\n\n"
    s = s + "3. **Create a new change** (when ready to start next task):\n"
    s = s + "   ```\n   jj new -m 'Next task'\n   ```\n\n"
    s = s + "4. **Push to remote**:\n"
    s = s + "   ```\n   jj bookmark set main -r @-\n"
    s = s + "   jj git push --bookmark main\n   ```\n\n"
    s = s + "## Key Differences from Git\n\n"
    s = s + "- No staging area (no `git add`)\n"
    s = s + "- Working copy is always a commit\n"
    s = s + "- No stash needed (just `jj new` to start fresh)\n"
    s = s + "- Branches are called 'bookmarks'\n"
    s = s + "- Every operation is undoable (`jj op undo`)\n"
    s = s + "- Conflicts are stored in commits (not blocking)\n\n"
    s = s + "## Common Operations\n\n"
    s = s + "| Task | Command |\n"
    s = s + "|------|--------|\n"
    s = s + "| See status | `jj status` or `jj st` |\n"
    s = s + "| See log | `jj log` |\n"
    s = s + "| See diff | `jj diff` |\n"
    s = s + "| Describe change | `jj describe -m 'msg'` |\n"
    s = s + "| New change | `jj new` |\n"
    s = s + "| Squash into parent | `jj squash` |\n"
    s = s + "| Edit older change | `jj edit <rev>` |\n"
    s = s + "| Undo last operation | `jj op undo` |\n"
    s = s + "| Rebase | `jj rebase -d <dest>` |\n"
    s

fn get_git_to_jj_content() -> String:
    var s = "# Git to Jujutsu (jj) Translation Guide\n\n"
    s = s + "| Git Command | jj Equivalent | Notes |\n"
    s = s + "|-------------|---------------|-------|\n"
    s = s + "| `git status` | `jj status` | Direct |\n"
    s = s + "| `git add .` | (automatic) | jj tracks all changes |\n"
    s = s + "| `git commit -m 'msg'` | `jj commit -m 'msg'` | Or `jj describe` + `jj new` |\n"
    s = s + "| `git commit --amend` | `jj describe -m 'msg'` | Amend = update description |\n"
    s = s + "| `git log` | `jj log` | Better default output |\n"
    s = s + "| `git diff` | `jj diff` | No staged/unstaged distinction |\n"
    s = s + "| `git diff --staged` | `jj diff` | No staging area in jj |\n"
    s = s + "| `git show <rev>` | `jj show <rev>` | Direct |\n"
    s = s + "| `git blame` | `jj file annotate` | Direct |\n"
    s = s + "| `git branch` | `jj bookmark list` | Branches = bookmarks |\n"
    s = s + "| `git branch <name>` | `jj bookmark create <name>` | Create bookmark |\n"
    s = s + "| `git checkout <rev>` | `jj new <rev>` or `jj edit <rev>` | new=child, edit=direct |\n"
    s = s + "| `git merge <branch>` | `jj new @ <branch>` | Multi-parent change |\n"
    s = s + "| `git rebase -i` | `jj rebase` + `jj squash` | No interactive mode |\n"
    s = s + "| `git cherry-pick` | `jj duplicate` | Direct |\n"
    s = s + "| `git fetch` | `jj git fetch` | Direct |\n"
    s = s + "| `git pull` | `jj git fetch` | Fetch is sufficient |\n"
    s = s + "| `git push` | `jj git push` | Direct |\n"
    s = s + "| `git remote` | `jj git remote` | Direct |\n"
    s = s + "| `git tag` | `jj tag list` | List only |\n"
    s = s + "| `git reset --hard` | `jj restore` | Restore from parent |\n"
    s = s + "| `git reset --soft` | (not needed) | Working copy is commit |\n"
    s = s + "| `git clean` | (not needed) | No untracked concept |\n"
    s = s + "| `git stash` | `jj new` | Not needed |\n"
    s = s + "| `git revert` | `jj revert` | Direct |\n"
    s = s + "| `git worktree` | `jj workspace` | Direct |\n"
    s = s + "| `git config` | `jj config` | Direct |\n"
    s

fn get_revset_reference_content() -> String:
    var s = "# Revset Expression Reference\n\n"
    s = s + "Revsets are jj's powerful query language for selecting commits.\n\n"
    s = s + "## Basic Symbols\n\n"
    s = s + "| Symbol | Meaning |\n"
    s = s + "|--------|--------|\n"
    s = s + "| `@` | Working copy commit |\n"
    s = s + "| `@-` | Parent of working copy |\n"
    s = s + "| `root()` | Root commit |\n"
    s = s + "| `<change_id>` | Specific change by ID |\n"
    s = s + "| `<bookmark>` | Bookmark name |\n\n"
    s = s + "## Operators\n\n"
    s = s + "| Operator | Meaning |\n"
    s = s + "|----------|--------|\n"
    s = s + "| `x-` | Parents of x |\n"
    s = s + "| `x+` | Children of x |\n"
    s = s + "| `::x` | Ancestors of x (inclusive) |\n"
    s = s + "| `x::` | Descendants of x (inclusive) |\n"
    s = s + "| `x::y` | x to y (DAG range) |\n"
    s = s + "| `x \\| y` | Union of x and y |\n"
    s = s + "| `x & y` | Intersection |\n"
    s = s + "| `x ~ y` | Difference (x minus y) |\n"
    s = s + "| `!x` | Negation |\n\n"
    s = s + "## Functions\n\n"
    s = s + "| Function | Meaning |\n"
    s = s + "|----------|--------|\n"
    s = s + "| `ancestors(x)` | All ancestors |\n"
    s = s + "| `descendants(x)` | All descendants |\n"
    s = s + "| `parents(x)` | Direct parents |\n"
    s = s + "| `children(x)` | Direct children |\n"
    s = s + "| `heads(x)` | Heads of set |\n"
    s = s + "| `roots(x)` | Roots of set |\n"
    s = s + "| `all()` | All commits |\n"
    s = s + "| `mine()` | My commits |\n"
    s = s + "| `empty()` | Empty commits |\n"
    s = s + "| `description(pattern)` | Match description |\n"
    s = s + "| `author(pattern)` | Match author |\n"
    s = s + "| `committer(pattern)` | Match committer |\n"
    s = s + "| `file(path)` | Commits touching path |\n"
    s = s + "| `conflict()` | Commits with conflicts |\n"
    s = s + "| `present(x)` | x if it exists, else empty |\n\n"
    s = s + "## Examples\n\n"
    s = s + "```\n"
    s = s + "# Recent commits\n"
    s = s + "jj log -r '@ | @-'\n\n"
    s = s + "# All my commits on main\n"
    s = s + "jj log -r 'mine() & ::main'\n\n"
    s = s + "# Commits with conflicts\n"
    s = s + "jj log -r 'conflict()'\n\n"
    s = s + "# Commits touching a file\n"
    s = s + "jj log -r 'file(src/main.rs)'\n"
    s = s + "```\n"
    s

fn get_jj_concepts_content() -> String:
    var s = "# Key Jujutsu (jj) Concepts\n\n"
    s = s + "## 1. Working Copy is a Commit\n\n"
    s = s + "In jj, your working copy IS a commit. There's no staging area.\n"
    s = s + "Every change you make is automatically part of the current commit.\n"
    s = s + "When you run `jj new`, you create a new empty commit on top.\n\n"
    s = s + "## 2. Change IDs vs Commit IDs\n\n"
    s = s + "jj has two types of identifiers:\n"
    s = s + "- **Change ID**: Stable identifier that follows a change through rebases/amends.\n"
    s = s + "  Shown as letters (e.g., `kkmpptxz`). Stays the same even after rewriting.\n"
    s = s + "- **Commit ID**: Git-compatible SHA hash. Changes when commit is rewritten.\n\n"
    s = s + "Use change IDs for day-to-day work - they're shorter and more stable.\n\n"
    s = s + "## 3. Operations and Undo\n\n"
    s = s + "Every jj command that modifies the repo creates an 'operation'.\n"
    s = s + "Operations form a log (`jj op log`) and can be undone:\n"
    s = s + "```\n"
    s = s + "jj op undo    # Undo last operation\n"
    s = s + "jj op restore <op-id>  # Restore to any point\n"
    s = s + "```\n"
    s = s + "This makes jj very safe - almost nothing is irreversible.\n\n"
    s = s + "## 4. Conflicts are First-Class\n\n"
    s = s + "Unlike git, conflicts in jj are stored IN commits.\n"
    s = s + "You can:\n"
    s = s + "- Continue working with conflicts present\n"
    s = s + "- Rebase conflicted commits\n"
    s = s + "- Resolve conflicts at any time\n"
    s = s + "- Check conflicts: `jj resolve --list`\n\n"
    s = s + "## 5. Bookmarks (not Branches)\n\n"
    s = s + "jj calls branches 'bookmarks'. They're just named pointers to commits.\n"
    s = s + "Unlike git branches, bookmarks don't automatically move on commit.\n"
    s = s + "You explicitly set them: `jj bookmark set main -r @`\n\n"
    s = s + "## 6. Anonymous Branches\n\n"
    s = s + "You can work without any bookmarks. jj tracks all changes by their\n"
    s = s + "change IDs. Bookmarks are only needed for pushing to remotes.\n\n"
    s = s + "## 7. Revsets\n\n"
    s = s + "jj has a powerful query language called 'revsets' for selecting commits.\n"
    s = s + "See the revset-reference prompt for details.\n"
    s

export get_all_prompts, get_prompt
