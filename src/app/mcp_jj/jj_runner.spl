# jj_runner.spl - Core jj command executor
#
# Runs jj commands via shell() and parses results.
# All jj invocations use --no-pager --color never for machine-readable output.

use app.io.mod (shell, shell_bool, shell_output_trimmed, cwd, env_get, file_exists, is_dir)

class JjResult:
    stdout: String
    stderr: String
    exit_code: Int
    success: Bool

fn jj_run(args_str: String, repo_path: String) -> JjResult:
    var cmd = "jj --no-pager --color never"
    if repo_path != "" and repo_path != "." and repo_path != nil:
        cmd = cmd + " -R " + shell_quote(repo_path)
    cmd = cmd + " " + args_str
    val result = shell(cmd)
    val stdout = result.stdout ?? ""
    val stderr = result.stderr ?? ""
    val code = result.exit_code
    JjResult(stdout: stdout, stderr: stderr, exit_code: code, success: code == 0)

fn jj_run_with_args(args: [String], repo_path: String) -> JjResult:
    var args_str = ""
    var first = true
    for arg in args:
        if not first:
            args_str = args_str + " "
        first = false
        args_str = args_str + shell_quote(arg)
    jj_run(args_str, repo_path)

fn is_jj_repo(path: String) -> Bool:
    is_dir(path + "/.jj")

fn get_jj_version() -> String:
    shell_output_trimmed("jj --version", "unknown")

fn get_default_repo_path() -> String:
    val env_path = env_get("JJ_MCP_REPO_PATH")
    if env_path != "" and env_path != nil:
        return env_path
    val current = cwd()
    if current == nil:
        return "."
    current

fn shell_quote(s: String) -> String:
    # Simple quoting: wrap in single quotes, escape existing single quotes
    if s == "":
        return "''"
    # Check if it needs quoting (contains spaces, special chars)
    var needs_quote = false
    for ch in s:
        if ch == " " or ch == "'" or ch == "\"" or ch == "\\" or ch == "(" or ch == ")" or ch == "&" or ch == "|" or ch == ";" or ch == "<" or ch == ">" or ch == "$" or ch == "`":
            needs_quote = true
            break
    if not needs_quote:
        return s
    # Use single quotes and escape single quotes within
    var result = "'"
    for ch in s:
        if ch == "'":
            result = result + "'\\''"
        else:
            result = result + ch
    result = result + "'"
    result

export JjResult, jj_run, jj_run_with_args, is_jj_repo, get_jj_version, get_default_repo_path, shell_quote
