# GPU Intrinsics - Recognition and Validation
#
# Provides utilities for recognizing and validating GPU intrinsic functions.
# These are special built-in functions for GPU programming.

use compiler_core.parser_types.GpuIntrinsicKind
use compiler_core.lexer.Span

# ============================================================================
# GPU Intrinsic Recognition
# ============================================================================

"""
Check if a function name is a GPU intrinsic.
Returns the intrinsic kind if it is, nil otherwise.
"""
fn recognize_gpu_intrinsic(name: text) -> has_GpuIntrinsicKind:
    match name:
        # Thread ID accessors
        case "gpu_global_id": GpuIntrinsicKind.GlobalId(0)  # dim filled later
        case "gpu_local_id": GpuIntrinsicKind.LocalId(0)
        case "gpu_block_id": GpuIntrinsicKind.BlockId(0)
        case "gpu_block_dim": GpuIntrinsicKind.BlockDim(0)
        case "gpu_grid_dim": GpuIntrinsicKind.GridDim(0)

        # Synchronization
        case "gpu_sync": GpuIntrinsicKind.Sync
        case "gpu_barrier": GpuIntrinsicKind.Barrier
        case "gpu_mem_fence": GpuIntrinsicKind.MemFence

        # Atomic operations
        case "gpu_atomic_add": GpuIntrinsicKind.AtomicAdd
        case "gpu_atomic_sub": GpuIntrinsicKind.AtomicSub
        case "gpu_atomic_min": GpuIntrinsicKind.AtomicMin
        case "gpu_atomic_max": GpuIntrinsicKind.AtomicMax
        case "gpu_atomic_and": GpuIntrinsicKind.AtomicAnd
        case "gpu_atomic_or": GpuIntrinsicKind.AtomicOr
        case "gpu_atomic_xor": GpuIntrinsicKind.AtomicXor
        case "gpu_atomic_exchange": GpuIntrinsicKind.AtomicExchange
        case "gpu_atomic_cas": GpuIntrinsicKind.AtomicCas

        case _: nil

"""
Check if a function name is a GPU intrinsic (boolean).
"""
fn is_gpu_intrinsic(name: text) -> bool:
    recognize_gpu_intrinsic(name)

"""
Get expected argument count for a GPU intrinsic.
"""
fn gpu_intrinsic_arg_count(kind: GpuIntrinsicKind) -> i64:
    match kind:
        # Thread ID accessors take one dimension argument
        case GlobalId(_):
            1

        case LocalId(_):
            1

        case BlockId(_):
            1

        case BlockDim(_):
            1

        case GridDim(_):
            1

        # Synchronization takes no arguments
        case Sync:
            0

        case Barrier:
            0

        case MemFence:
            0

        # Atomic operations take 2 arguments (ptr, value)
        case AtomicAdd:
            2
        case AtomicSub:
            2
        case AtomicMin:
            2
        case AtomicMax:
            2
        case AtomicAnd:
            2
        case AtomicOr:
            2
        case AtomicXor:
            2
        case AtomicExchange:
            2

        # Compare-and-swap takes 3 arguments (ptr, expected, desired)
        case AtomicCas:
            3

"""
Get description of a GPU intrinsic for error messages.
"""
fn gpu_intrinsic_description(kind: GpuIntrinsicKind) -> text:
    match kind:
        case GlobalId(_): "get global thread ID"
        case LocalId(_): "get local thread ID within block"
        case BlockId(_): "get block/workgroup ID"
        case BlockDim(_): "get block dimensions"
        case GridDim(_): "get grid dimensions"
        case Sync: "synchronize threads"
        case Barrier: "thread barrier"
        case MemFence: "memory fence"
        case AtomicAdd: "atomic add"
        case AtomicSub: "atomic subtract"
        case AtomicMin: "atomic minimum"
        case AtomicMax: "atomic maximum"
        case AtomicAnd: "atomic bitwise AND"
        case AtomicOr: "atomic bitwise OR"
        case AtomicXor: "atomic bitwise XOR"
        case AtomicExchange: "atomic exchange"
        case AtomicCas: "atomic compare-and-swap"

"""
Check if a GPU intrinsic requires being inside a kernel function.
"""
fn requires_kernel_context(kind: GpuIntrinsicKind) -> bool:
    # All GPU intrinsics require kernel context
    true

"""
Check if a GPU intrinsic has side effects.
"""
fn has_side_effects(kind: GpuIntrinsicKind) -> bool:
    match kind:
        # ID accessors are pure
        case GlobalId(_):
            false

        case LocalId(_):
            false

        case BlockId(_):
            false

        case BlockDim(_):
            false

        case GridDim(_):
            false

        # Synchronization and atomics have side effects
        case Sync:
            true
        case Barrier:
            true
        case MemFence:
            true
        case AtomicAdd:
            true
        case AtomicSub:
            true
        case AtomicMin:
            true
        case AtomicMax:
            true
        case AtomicAnd:
            true
        case AtomicOr:
            true
        case AtomicXor:
            true
        case AtomicExchange:
            true
        case AtomicCas:
            true

"""
All GPU intrinsic function names.
"""
fn all_gpu_intrinsic_names() -> [text]:
    [
        "gpu_global_id",
        "gpu_local_id",
        "gpu_block_id",
        "gpu_block_dim",
        "gpu_grid_dim",
        "gpu_sync",
        "gpu_barrier",
        "gpu_mem_fence",
        "gpu_atomic_add",
        "gpu_atomic_sub",
        "gpu_atomic_min",
        "gpu_atomic_max",
        "gpu_atomic_and",
        "gpu_atomic_or",
        "gpu_atomic_xor",
        "gpu_atomic_exchange",
        "gpu_atomic_cas"
    ]

# ============================================================================
# Validation Errors
# ============================================================================

struct GpuIntrinsicError:
    """Error for GPU intrinsic validation."""
    message: text
    span: Span

fn validate_gpu_intrinsic_args(kind: GpuIntrinsicKind, arg_count: i64, span: Span) -> has_GpuIntrinsicError:
    """Validate argument count for a GPU intrinsic."""
    val expected = gpu_intrinsic_arg_count(kind)
    if arg_count != expected:
        val desc = gpu_intrinsic_description(kind)
        GpuIntrinsicError(
            message: "GPU intrinsic '{desc}' expects {expected} argument(s), got {arg_count}",
            span: span
        )
    else:
        nil

# ============================================================================
# Export
# ============================================================================

export recognize_gpu_intrinsic, is_gpu_intrinsic
export gpu_intrinsic_arg_count, gpu_intrinsic_description
export requires_kernel_context, has_side_effects
export all_gpu_intrinsic_names
export GpuIntrinsicError, validate_gpu_intrinsic_args
