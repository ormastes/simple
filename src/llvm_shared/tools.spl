# LLVM Tool Invocations
#
# Shared LLVM tool discovery and invocation functions.
# Used by both Full Simple and Core Simple LLVM backends.
#
# Bootstrap-compatible: No generics, no Option types, seed_cpp compilable.

use app.io.mod (shell, file_write, file_delete, file_read_bytes, getpid)

# ============================================================================
# LLVM Tool Discovery
# ============================================================================

fn find_llc() -> text:
    """
    Find llc binary with fallback chain: llc-18 → llc-17 → llc-16 → llc.

    Returns the command name if found, otherwise empty string.
    Bootstrap-safe: Returns text (not text?) with "" for not found.
    """
    val candidates = ["llc-18", "llc-17", "llc-16", "llc"]
    for candidate in candidates:
        val result = shell("command -v {candidate} >/dev/null 2>&1")
        if result.exit_code == 0:
            return candidate
    ""

fn find_opt() -> text:
    """
    Find LLVM opt binary with fallback chain: opt-18 → opt-17 → opt-16 → opt.

    Returns the command name if found, otherwise empty string.
    Bootstrap-safe: Returns text (not text?) with "" for not found.
    """
    val candidates = ["opt-18", "opt-17", "opt-16", "opt"]
    for candidate in candidates:
        val result = shell("command -v {candidate} >/dev/null 2>&1")
        if result.exit_code == 0:
            return candidate
    ""

fn find_clang() -> text:
    """
    Find clang binary with fallback chain: clang-18 → clang-17 → clang-16 → clang.

    Returns the command name if found, otherwise empty string.
    Bootstrap-safe: Returns text (not text?) with "" for not found.
    """
    val candidates = ["clang-18", "clang-17", "clang-16", "clang"]
    for candidate in candidates:
        val result = shell("command -v {candidate} >/dev/null 2>&1")
        if result.exit_code == 0:
            return candidate
    ""

# ============================================================================
# Tool Availability Checks
# ============================================================================

fn opt_available() -> bool:
    """Check if opt (LLVM optimizer) is available on PATH."""
    val tool = find_opt()
    tool != ""

fn llc_available() -> bool:
    """Check if llc (LLVM static compiler) is available on PATH."""
    val tool = find_llc()
    tool != ""

fn clang_available() -> bool:
    """Check if clang (C compiler with LLVM backend) is available on PATH."""
    val tool = find_clang()
    tool != ""

# ============================================================================
# Exports
# ============================================================================

export find_llc, find_opt, find_clang
export llc_available, opt_available, clang_available
