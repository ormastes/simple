# Runtime Validation System
#
# Comprehensive runtime validation with three modes:
# - check_only: Validate all logic paths without training
# - train_only: Skip validation, train normally
# - check_and_train: Validate then train if passed
#
# ## Features
# - Memory validation (model + activation memory)
# - Shape validation (tensor dimensions through model)
# - Gradient flow validation (detect dead layers, NaN/Inf)
# - Numeric stability (NaN/Inf in outputs/loss)
# - Device placement (model/data consistency)
# - DataLoader validation (iteration tests)
# - Optimizer validation (parameter tracking)
# - Training loop validation (mini-epochs)
#
# ## Example
# ```simple
# import ml.torch.validation.{RuntimeValidator, ValidationMode}
#
# val validator = RuntimeValidator(ValidationMode.CheckAndTrain)
# val report = validator.validate_all(model, dataloader, optimizer, loss_fn)
# report.print()
#
# if report.has_errors():
#     sys.exit(1)
#
# # Proceed with training
# train(model, dataloader)
# ```

export RuntimeValidator, ValidationMode, ValidationReport, ValidationSection

use validation_checks.{RuntimeValidator}


# ============================================================================
# Enums
# ============================================================================

# Validation execution mode:
# - CheckOnly: Run checks, no training
# - TrainOnly: Skip checks, train normally
# - CheckAndTrain: Run checks then train
enum ValidationMode:
    CheckOnly
    TrainOnly
    CheckAndTrain

impl ValidationMode:
    # =========================================================================
    # Helper Methods
    # =========================================================================

    fn is_check_only() -> bool:
        """Check if this is CheckOnly mode.

        Returns:
            true for CheckOnly

        Example:
            ValidationMode.CheckOnly.is_check_only()  # → true
        """
        match self:
            case CheckOnly: true
            case _: false

    fn is_train_only() -> bool:
        """Check if this is TrainOnly mode.

        Returns:
            true for TrainOnly

        Example:
            ValidationMode.TrainOnly.is_train_only()  # → true
        """
        match self:
            case TrainOnly: true
            case _: false

    fn is_check_and_train() -> bool:
        """Check if this is CheckAndTrain mode.

        Returns:
            true for CheckAndTrain

        Example:
            ValidationMode.CheckAndTrain.is_check_and_train()  # → true
        """
        match self:
            case CheckAndTrain: true
            case _: false

    fn runs_validation() -> bool:
        """Check if mode runs validation checks.

        Returns:
            true for CheckOnly and CheckAndTrain

        Example:
            ValidationMode.CheckOnly.runs_validation()  # → true
            ValidationMode.TrainOnly.runs_validation()  # → false
        """
        match self:
            case CheckOnly: true
            case CheckAndTrain: true
            case TrainOnly: false

    fn runs_training() -> bool:
        """Check if mode runs training.

        Returns:
            true for TrainOnly and CheckAndTrain

        Example:
            ValidationMode.TrainOnly.runs_training()  # → true
            ValidationMode.CheckOnly.runs_training()  # → false
        """
        match self:
            case TrainOnly: true
            case CheckAndTrain: true
            case CheckOnly: false

    fn stops_on_error() -> bool:
        """Check if mode stops training on validation error.

        Returns:
            true for CheckOnly and CheckAndTrain

        Example:
            ValidationMode.CheckAndTrain.stops_on_error()  # → true
        """
        match self:
            case CheckOnly: true
            case CheckAndTrain: true
            case TrainOnly: false

    fn to_string() -> text:
        """Convert mode to string.

        Returns:
            Mode name

        Example:
            ValidationMode.CheckOnly.to_string()  # → "check_only"
        """
        match self:
            case CheckOnly: "check_only"
            case TrainOnly: "train_only"
            case CheckAndTrain: "check_and_train"

    fn description() -> text:
        """Get mode description.

        Returns:
            Human-readable description

        Example:
            ValidationMode.CheckOnly.description()
            # → "Run checks, no training"
        """
        match self:
            case CheckOnly: "Run checks, no training"
            case TrainOnly: "Skip checks, train normally"
            case CheckAndTrain: "Run checks then train"

    fn summary() -> text:
        """Get summary of validation mode.

        Returns:
            Human-readable summary

        Example:
            ValidationMode.CheckAndTrain.summary()
            # → "ValidationMode: check_and_train (runs validation, runs training, stops on error)"
        """
        val name = self.to_string()
        val val = if self.runs_validation(): "runs validation" else: "no validation"
        val train = if self.runs_training(): "runs training" else: "no training"
        val stop = if self.stops_on_error(): "stops on error" else: "continues"
        return "ValidationMode: {name} ({val}, {train}, {stop})"


# ============================================================================
# Validation Section
# ============================================================================

class ValidationSection:
    """Single validation section (e.g., "Memory Validation").

    Attributes:
        name: Section name
        infos: Info messages
        warnings: Warning messages
        errors: Error messages
        passed: Whether section passed
    """
    name: str
    infos: [str]
    warnings: [str]
    errors: [str]
    passed: bool

    fn __init__(name: str):
        self.name = name
        self.infos = []
        self.warnings = []
        self.errors = []
        self.passed = false

    fn add_info(msg: str):
        """Add info message."""
        self.infos.append(msg)

    fn add_warning(msg: str):
        """Add warning message."""
        self.warnings.append(msg)

    fn add_error(msg: str):
        """Add error message."""
        self.errors.append(msg)

    fn add_pass(msg: str):
        """Mark section as passed."""
        self.passed = true
        self.infos.append("✓ {msg}")

    fn has_errors() -> bool:
        """Check if section has errors."""
        return self.errors.len() > 0


# ============================================================================
# Validation Report
# ============================================================================

class ValidationReport:
    """Validation report containing all sections.

    Attributes:
        sections: List of validation sections
        skipped: Whether validation was skipped
    """
    sections: [ValidationSection]
    skipped: bool

    fn __init__(skipped: bool):
        self.sections = []
        self.skipped = skipped

    fn add_section(section: ValidationSection):
        """Add validation section."""
        self.sections.append(section)

    fn has_errors() -> bool:
        """Check if any section has errors."""
        return any(s.has_errors() for s in self.sections)

    fn print():
        """Print validation report."""
        if self.skipped:
            print("Validation skipped (train_only mode)")
            return

        print("=" * 70)
        print("RUNTIME VALIDATION REPORT")
        print("=" * 70)

        for section in self.sections:
            print(f"\n{section.name}")
            print("-" * 70)

            for info in section.infos:
                print(f"  [INFO] {info}")

            for warning in section.warnings:
                print(f"  [WARN] {warning}")

            for error in section.errors:
                print(f"  [ERROR] {error}")

        print("\n" + "=" * 70)
        if self.has_errors():
            print("VALIDATION FAILED ❌")
        else:
            print("VALIDATION PASSED ✓")
        print("=" * 70)


# ============================================================================
# Runtime Validator
# ============================================================================
