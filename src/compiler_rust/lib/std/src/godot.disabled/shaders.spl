# Godot Shader System
#
# Type-safe wrappers for Godot's shader system
#
# Features:
# - Shader resource (GLSL-like shaders)
# - ShaderMaterial (material with custom shader)
# - Shader parameters
# - Built-in shader types (canvas, spatial, particles)
#
# Based on: https://docs.godotengine.org/en/stable/classes/class_shader.html
#
# Split into:
# - shaders_effects.spl (ShaderBuilder, UniformType, helper functions, preset shaders)

use godot.ffi
use godot.variant
use godot.resource

mod shaders

# Shader Resource
# Custom shader code (vertex, fragment, light)
pub struct Shader:
    resource: resource.Resource

impl Shader:
    # Create from resource
    pub fn from_resource(res: resource.Resource) -> Shader:
        return Shader(resource: res)

    # Create new shader
    pub fn new() -> Shader:
        val ptr = ffi.godot_new_object("Shader")
        val res = resource.Resource.from_ptr(ptr)
        return Shader.from_resource(res)

    # Load shader from file
    pub fn load(path: text) -> Result<Shader, text>:
        val loader = resource.ResourceLoader.get_singleton()
        val result = loader.load(path)

        if result.is_ok():
            return Ok(Shader.from_resource(result.unwrap()))
        else:
            return Err(result.unwrap_err())

    # Set shader code
    pub fn set_code(mut self, code: text):
        val obj = self.resource.as_object()
        val code_var = variant.Variant.from_string(code)
        obj.call1("set_code", code_var)

    # Get shader code
    pub fn get_code(self) -> text:
        val obj = self.resource.as_object()
        val result = obj.call0("get_code")
        return result.as_string()

    # Get shader mode
    pub fn get_mode(self) -> ShaderMode:
        val obj = self.resource.as_object()
        val result = obj.call0("get_mode")
        val mode_int = result.as_int()
        return shader_mode_from_int(mode_int as i32)

    # Check if shader has parameter
    pub fn has_parameter(self, name: text) -> bool:
        val obj = self.resource.as_object()
        val name_var = variant.Variant.from_string(name)
        val result = obj.call1("has_parameter", name_var)
        return result.as_bool()


# Shader Material
# Material using a custom shader
pub struct ShaderMaterial:
    resource: resource.Resource

impl ShaderMaterial:
    # Create from resource
    pub fn from_resource(res: resource.Resource) -> ShaderMaterial:
        return ShaderMaterial(resource: res)

    # Create new shader material
    pub fn new() -> ShaderMaterial:
        val ptr = ffi.godot_new_object("ShaderMaterial")
        val res = resource.Resource.from_ptr(ptr)
        return ShaderMaterial.from_resource(res)

    # Set shader
    pub fn set_shader(mut self, shader: Shader):
        val obj = self.resource.as_object()
        val shader_var = variant.Variant.from_object(shader.resource.as_object())
        obj.call1("set_shader", shader_var)

    # Get shader
    pub fn get_shader(self) -> Option<Shader>:
        val obj = self.resource.as_object()
        val result = obj.call0("get_shader")

        if result.is_null():
            return None
        else:
            val res = resource.Resource.from_ptr(result.as_object().ptr())
            return Some(Shader.from_resource(res))

    # Set shader parameter
    pub fn set_shader_parameter(mut self, param_name: text, value: variant.Variant):
        val obj = self.resource.as_object()
        val name_var = variant.Variant.from_string(param_name)
        obj.call2("set_shader_parameter", name_var, value)

    # Get shader parameter
    pub fn get_shader_parameter(self, param_name: text) -> variant.Variant:
        val obj = self.resource.as_object()
        val name_var = variant.Variant.from_string(param_name)
        return obj.call1("get_shader_parameter", name_var)


# Shader Mode
pub enum ShaderMode:
    Spatial = 0      # 3D shaders
    CanvasItem = 1   # 2D shaders
    Particles = 2    # Particle shaders
    Sky = 3          # Sky shaders
    Fog = 4          # Fog shaders

impl ShaderMode:
    # =========================================================================
    # Helper Methods
    # =========================================================================

    pub fn is_spatial(self) -> bool:
        """Check if this is Spatial shader mode.

        Returns:
            true for Spatial

        Example:
            ShaderMode.Spatial.is_spatial()  # → true
        """
        self == ShaderMode.Spatial

    pub fn is_canvas_item(self) -> bool:
        """Check if this is CanvasItem shader mode.

        Returns:
            true for CanvasItem

        Example:
            ShaderMode.CanvasItem.is_canvas_item()  # → true
        """
        self == ShaderMode.CanvasItem

    pub fn is_particles(self) -> bool:
        """Check if this is Particles shader mode.

        Returns:
            true for Particles

        Example:
            ShaderMode.Particles.is_particles()  # → true
        """
        self == ShaderMode.Particles

    pub fn is_sky(self) -> bool:
        """Check if this is Sky shader mode.

        Returns:
            true for Sky

        Example:
            ShaderMode.Sky.is_sky()  # → true
        """
        self == ShaderMode.Sky

    pub fn is_fog(self) -> bool:
        """Check if this is Fog shader mode.

        Returns:
            true for Fog

        Example:
            ShaderMode.Fog.is_fog()  # → true
        """
        self == ShaderMode.Fog

    pub fn is_3d(self) -> bool:
        """Check if this is 3D shader mode.

        Returns:
            true for Spatial, Sky, or Fog

        Example:
            ShaderMode.Spatial.is_3d()  # → true
            ShaderMode.CanvasItem.is_3d()  # → false
        """
        self == ShaderMode.Spatial or self == ShaderMode.Sky or self == ShaderMode.Fog

    pub fn is_2d(self) -> bool:
        """Check if this is 2D shader mode.

        Returns:
            true for CanvasItem

        Example:
            ShaderMode.CanvasItem.is_2d()  # → true
        """
        self == ShaderMode.CanvasItem

    pub fn supports_vertex_shader(self) -> bool:
        """Check if mode supports vertex shader.

        Returns:
            true for all modes

        Example:
            ShaderMode.Spatial.supports_vertex_shader()  # → true
        """
        true

    pub fn supports_fragment_shader(self) -> bool:
        """Check if mode supports fragment shader.

        Returns:
            true for all modes

        Example:
            ShaderMode.Spatial.supports_fragment_shader()  # → true
        """
        true

    pub fn supports_light_shader(self) -> bool:
        """Check if mode supports light shader.

        Returns:
            true for Spatial and CanvasItem

        Example:
            ShaderMode.Spatial.supports_light_shader()  # → true
            ShaderMode.Particles.supports_light_shader()  # → false
        """
        self == ShaderMode.Spatial or self == ShaderMode.CanvasItem

    pub fn to_string(self) -> text:
        """Convert shader mode to string.

        Returns:
            Mode name as used in shader code

        Example:
            ShaderMode.Spatial.to_string()  # → "spatial"
        """
        shader_mode_to_string(self)

    pub fn description(self) -> text:
        """Get shader mode description.

        Returns:
            Human-readable description

        Example:
            ShaderMode.Spatial.description()
            # → "3D shaders for spatial rendering"
        """
        if self == ShaderMode.Spatial:
            "3D shaders for spatial rendering"
        elif self == ShaderMode.CanvasItem:
            "2D shaders for canvas items"
        elif self == ShaderMode.Particles:
            "Particle system shaders"
        elif self == ShaderMode.Sky:
            "Sky and atmosphere shaders"
        elif self == ShaderMode.Fog:
            "Volumetric fog shaders"
        else:
            "Unknown shader mode"

    pub fn summary(self) -> text:
        """Get summary of shader mode.

        Returns:
            Human-readable summary

        Example:
            ShaderMode.Spatial.summary()
            # → "ShaderMode: spatial (3D, vertex+fragment+light)"
        """
        val name = self.to_string()
        var attrs: Array<text> = []

        if self.is_3d():
            attrs.push("3D")
        if self.is_2d():
            attrs.push("2D")

        var shaders: Array<text> = []
        if self.supports_vertex_shader():
            shaders.push("vertex")
        if self.supports_fragment_shader():
            shaders.push("fragment")
        if self.supports_light_shader():
            shaders.push("light")

        val shader_str = shaders.join("+")
        attrs.push(shader_str)

        val attrs_str = attrs.join(", ")
        return "ShaderMode: {name} ({attrs_str})"


# Helper functions used by shaders_effects.spl

fn shader_mode_from_int(value: i32) -> ShaderMode:
    if value == 0:
        return ShaderMode.Spatial
    elif value == 1:
        return ShaderMode.CanvasItem
    elif value == 2:
        return ShaderMode.Particles
    elif value == 3:
        return ShaderMode.Sky
    elif value == 4:
        return ShaderMode.Fog
    else:
        return ShaderMode.Spatial

fn shader_mode_to_string(mode: ShaderMode) -> text:
    if mode == ShaderMode.Spatial:
        return "spatial"
    elif mode == ShaderMode.CanvasItem:
        return "canvas_item"
    elif mode == ShaderMode.Particles:
        return "particles"
    elif mode == ShaderMode.Sky:
        return "sky"
    elif mode == ShaderMode.Fog:
        return "fog"
    else:
        return "spatial"


# Array placeholder
pub struct Array<T>:
    items: Vec<T>

impl<T> Array<T>:
    pub fn push(mut self, item: T):
        pass
