# Compiler Interface Implementations
# Language compiler trait, registry, and multi-language orchestrator

use tooling.core.project.{Language, LanguageConfig}
use tooling.compiler.compiler_interface.{CompilationMode, CompilationResult, Artifact, ArtifactType, CompilationError, ErrorSeverity}
use core.result.{Result, Ok, Err}

# Language compiler interface (adapter pattern)
pub trait LanguageCompiler:
    """Interface for language-specific compilers.

    Each language (Simple, Rust, Python, etc.) implements this trait
    to provide unified compilation interface.
    """

    fn compile(config: LanguageConfig, mode: CompilationMode, incremental: bool) -> CompilationResult

    fn get_language() -> Language

    fn supports_incremental() -> bool

    fn get_executable_extension() -> text

    fn get_library_extension() -> text

# Compiler registry - manages language-specific compilers
pub class CompilerRegistry:
    pub compilers: Dict<Language, LanguageCompiler>

    pub fn new() -> CompilerRegistry:
        """Create compiler registry."""
        CompilerRegistry {
            compilers: {}
        }

    pub fn register(self, language: Language, compiler: LanguageCompiler):
        """Register language compiler.

        Args:
            language: Language to register
            compiler: Compiler implementation

        Example:
            val registry = CompilerRegistry.new()
            registry.register(Language.Simple, SimpleCompiler.new())
            registry.register(Language.Rust, RustCompiler.new())
        """
        self.compilers[language] = compiler

    pub fn get_compiler(self, language: Language) -> Option<LanguageCompiler>:
        """Get compiler for language.

        Args:
            language: Language to get compiler for

        Returns:
            Compiler if registered
        """
        self.compilers.get(language)

    pub fn has_compiler(self, language: Language) -> bool:
        """Check if compiler is registered.

        Args:
            language: Language to check

        Returns:
            True if compiler is available
        """
        self.compilers.contains_key(language)

# Multi-language compiler orchestrator
pub class MultiLanguageCompiler:
    pub registry: CompilerRegistry
    pub mode: CompilationMode
    pub incremental: bool
    pub parallel: bool

    pub fn new() -> MultiLanguageCompiler:
        """Create multi-language compiler.

        Returns:
            Compiler with default settings

        Example:
            val compiler = MultiLanguageCompiler.new()
            compiler.set_mode(CompilationMode.Release)
            compiler.set_parallel(true)
        """
        val registry = CompilerRegistry.new()

        MultiLanguageCompiler {
            registry: registry,
            mode: CompilationMode.Debug,
            incremental: false,
            parallel: false
        }

    pub fn set_mode(self, mode: CompilationMode):
        """Set compilation mode.

        Args:
            mode: Debug, Release, or Profile
        """
        self.mode = mode

    pub fn set_incremental(self, enabled: bool):
        """Enable/disable incremental compilation.

        Args:
            enabled: True to enable incremental builds
        """
        self.incremental = enabled

    pub fn set_parallel(self, enabled: bool):
        """Enable/disable parallel compilation.

        Args:
            enabled: True to compile languages in parallel
        """
        self.parallel = enabled

    pub fn compile_all(self, languages: List<LanguageConfig>) -> CompilationResult:
        """Compile all languages.

        Args:
            languages: List of language configurations to compile

        Returns:
            Combined compilation result

        Example:
            val compiler = MultiLanguageCompiler.new()
            val result = compiler.compile_all(project.languages)

            if result.is_ok():
                print("âœ“ Built {result.artifacts.len()} artifacts")
            else:
                for error in result.errors:
                    print(error.format())
        """
        @extern("runtime", "rt_time_now_unix_micros")
        fn _rt_time_now_unix_micros() -> i64

        val combined = CompilationResult.new()
        val start_time = _rt_time_now_unix_micros() / 1000  # Convert microseconds to milliseconds

        for lang_config in languages:
            val compiler = self.registry.get_compiler(lang_config.language)

            match compiler:
                some(c):
                    val result = c.compile(lang_config, self.mode, self.incremental)

                    # Merge results
                    combined.artifacts.extend(result.artifacts)
                    combined.errors.extend(result.errors)
                    combined.warnings.extend(result.warnings)

                    if not result.is_ok():
                        combined.success = false
                none:
                    val error = CompilationError.new(
                        file: "",
                        line: 0,
                        column: 0,
                        message: "No compiler registered for {lang_config.language}",
                        severity: ErrorSeverity.Error,
                        language: lang_config.language
                    )
                    combined.add_error(error)

        val end_time = _rt_time_now_unix_micros() / 1000  # Convert microseconds to milliseconds
        combined.duration_ms = end_time - start_time

        combined

    pub fn compile_single(
        self,
        language: Language,
        config: LanguageConfig
    ) -> CompilationResult:
        """Compile single language.

        Args:
            language: Language to compile
            config: Language configuration

        Returns:
            Compilation result
        """
        match self.registry.get_compiler(language):
            some(compiler):
                compiler.compile(config, self.mode, self.incremental)
            none:
                val result = CompilationResult.new()
                val error = CompilationError.new(
                    file: "",
                    line: 0,
                    column: 0,
                    message: "No compiler registered for {language}",
                    severity: ErrorSeverity.Error,
                    language: language
                )
                result.add_error(error)
                result
