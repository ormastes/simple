# Rust Language Grammar for Tree-sitter
# Complete Rust grammar implementation

use simple_grammar.{Grammar, Token}

class RustGrammar:
    grammar: Grammar

class RustGrammarBuilder:
    grammar: Grammar

impl RustGrammar:
    static fn new() -> RustGrammar:
        var grammar = Grammar.new("rust")

        # Set entry point
        grammar.entry_point = "source_file"

        # Build all grammar rules
        var builder = RustGrammarBuilder(grammar: grammar)
        builder.build_grammar()

        RustGrammar(grammar: builder.grammar)

impl RustGrammarBuilder:
    me build_grammar():
        # Entry point
        self.add_source_file()

        # Items (declarations)
        self.add_items()

        # Statements
        self.add_statements()

        # Expressions
        self.add_expressions()

        # Patterns
        self.add_patterns()

        # Types
        self.add_types()

        # Common elements
        self.add_common()

    # Source file (entry point)
    me add_source_file():
        self.grammar.add_rule("source_file", repeat(choice([
            ref("item"),
            ref("attribute"),
            token(Newline)
        ])))

    # Items (top-level declarations)
    me add_items():
        self.grammar.add_rule("item", choice([
            ref("function_item"),
            ref("struct_item"),
            ref("enum_item"),
            ref("trait_item"),
            ref("impl_item"),
            ref("mod_item"),
            ref("use_item"),
            ref("const_item"),
            ref("static_item"),
            ref("type_alias")
        ]))

        # Function
        self.grammar.add_rule("function_item", seq([
            optional(ref("visibility")),
            optional(token(Const)),
            optional(token(Async)),
            optional(token(Unsafe)),
            optional(ref("extern_abi")),
            token(Fn),
            field("name", ref("identifier")),
            optional(ref("generic_params")),
            token(LParen),
            optional(ref("parameters")),
            token(RParen),
            optional(seq([token(Arrow), field("return_type", ref("type"))])),
            optional(ref("where_clause")),
            ref("block")
        ]))

        # Struct
        self.grammar.add_rule("struct_item", seq([
            optional(ref("visibility")),
            token(Struct),
            field("name", ref("type_identifier")),
            optional(ref("generic_params")),
            optional(ref("where_clause")),
            choice([
                seq([token(Semicolon)]),  # Unit struct
                seq([  # Tuple struct
                    token(LParen),
                    optional(ref("tuple_fields")),
                    token(RParen),
                    token(Semicolon)
                ]),
                seq([  # Struct with fields
                    token(LBrace),
                    optional(ref("fields")),
                    token(RBrace)
                ])
            ])
        ]))

        # Enum
        self.grammar.add_rule("enum_item", seq([
            optional(ref("visibility")),
            token(Enum),
            field("name", ref("type_identifier")),
            optional(ref("generic_params")),
            optional(ref("where_clause")),
            token(LBrace),
            optional(ref("enum_variants")),
            token(RBrace)
        ]))

        self.grammar.add_rule("enum_variants", seq([
            ref("enum_variant"),
            repeat(seq([token(Comma), ref("enum_variant")])),
            optional(token(Comma))
        ]))

        self.grammar.add_rule("enum_variant", seq([
            optional(ref("attribute")),
            ref("identifier"),
            optional(choice([
                seq([token(LParen), optional(ref("tuple_fields")), token(RParen)]),
                seq([token(LBrace), optional(ref("fields")), token(RBrace)])
            ]))
        ]))

        # Trait
        self.grammar.add_rule("trait_item", seq([
            optional(ref("visibility")),
            optional(token(Unsafe)),
            token(Trait),
            field("name", ref("type_identifier")),
            optional(ref("generic_params")),
            optional(ref("type_bounds")),
            optional(ref("where_clause")),
            token(LBrace),
            repeat(ref("trait_member")),
            token(RBrace)
        ]))

        self.grammar.add_rule("trait_member", choice([
            ref("function_signature"),
            ref("associated_type"),
            ref("const_item")
        ]))

        # Impl
        self.grammar.add_rule("impl_item", seq([
            optional(token(Unsafe)),
            token(Impl),
            optional(ref("generic_params")),
            choice([
                seq([ref("type"), token(For), ref("type")]),  # Trait impl
                ref("type")  # Inherent impl
            ]),
            optional(ref("where_clause")),
            token(LBrace),
            repeat(ref("impl_member")),
            token(RBrace)
        ]))

        self.grammar.add_rule("impl_member", choice([
            ref("function_item"),
            ref("const_item"),
            ref("type_alias")
        ]))

        # Module
        self.grammar.add_rule("mod_item", seq([
            optional(ref("visibility")),
            token(Mod),
            ref("identifier"),
            choice([
                token(Semicolon),
                seq([token(LBrace), repeat(ref("item")), token(RBrace)])
            ])
        ]))

        # Use
        self.grammar.add_rule("use_item", seq([
            optional(ref("visibility")),
            token(Use),
            ref("use_tree"),
            token(Semicolon)
        ]))

        self.grammar.add_rule("use_tree", choice([
            ref("use_path"),
            seq([ref("use_path"), token(As), ref("identifier")]),
            seq([ref("use_path"), token(ColonColon), token(Star)]),
            seq([ref("use_path"), token(ColonColon), token(LBrace), ref("use_list"), token(RBrace)])
        ]))

        # Const/static
        self.grammar.add_rule("const_item", seq([
            optional(ref("visibility")),
            token(Const),
            ref("identifier"),
            token(Colon),
            ref("type"),
            token(Equals),
            ref("expression"),
            token(Semicolon)
        ]))

        self.grammar.add_rule("static_item", seq([
            optional(ref("visibility")),
            token(Static),
            optional(token(Mut)),
            ref("identifier"),
            token(Colon),
            ref("type"),
            token(Equals),
            ref("expression"),
            token(Semicolon)
        ]))

        # Type alias
        self.grammar.add_rule("type_alias", seq([
            optional(ref("visibility")),
            token(Type),
            ref("type_identifier"),
            optional(ref("generic_params")),
            token(Equals),
            ref("type"),
            token(Semicolon)
        ]))
