# Tree-sitter CLI Tools
# Command-line interface for tree-sitter operations

use sys
use io.stdio as stdio
use parser.{TreeSitterParser, Grammar}
use language_detect as detect
use grammar_test as gt
use grammar_compile as compile

# CLI command result
enum CliResult:
    Success(message: text)
    Error(error: text)
    Help

impl CliResult:
    # =========================================================================
    # Helper Methods
    # =========================================================================

    fn is_success() -> bool:
        """Check if result is Success.

        Returns:
            true for Success

        Example:
            CliResult.Success("OK").is_success()  # → true
        """
        match self:
            case Success(_): true
            case _: false

    fn is_error() -> bool:
        """Check if result is Error.

        Returns:
            true for Error

        Example:
            CliResult.Error("failed").is_error()  # → true
        """
        match self:
            case Error(_): true
            case _: false

    fn is_help() -> bool:
        """Check if result is Help.

        Returns:
            true for Help

        Example:
            CliResult.Help.is_help()  # → true
        """
        match self:
            case Help: true
            case _: false

    fn has_message() -> bool:
        """Check if result contains a message.

        Returns:
            true for Success or Error (both have messages)

        Example:
            CliResult.Success("done").has_message()  # → true
            CliResult.Help.has_message()  # → false
        """
        match self:
            case Success(_): true
            case Error(_): true
            case Help: false

    fn get_message() -> Option<text>:
        """Get message if available.

        Returns:
            Message string or nil

        Example:
            CliResult.Success("done").get_message()  # → Some("done")
            CliResult.Help.get_message()  # → nil
        """
        match self:
            case Success(msg): Some(msg)
            case Error(err): Some(err)
            case Help: nil

    fn exit_code() -> i32:
        """Get appropriate exit code.

        Returns:
            0 for Success/Help, 1 for Error

        Example:
            CliResult.Success("OK").exit_code()  # → 0
            CliResult.Error("fail").exit_code()  # → 1
        """
        match self:
            case Success(_): 0
            case Help: 0
            case Error(_): 1

    fn to_string() -> text:
        """Convert result to string.

        Returns:
            Result type name

        Example:
            CliResult.Success("OK").to_string()  # → "success"
        """
        match self:
            case Success(_): "success"
            case Error(_): "error"
            case Help: "help"

    fn description() -> text:
        """Get CLI result description.

        Returns:
            Human-readable description

        Example:
            CliResult.Success("OK").description()
            # → "Successful operation"
        """
        match self:
            case Success(_): "Successful operation"
            case Error(_): "Operation failed with error"
            case Help: "Help information requested"

    fn summary() -> text:
        """Get summary of CLI result.

        Returns:
            Human-readable summary

        Example:
            CliResult.Success("done").summary()
            # → "CliResult: success (done)"
        """
        val name = self.to_string()
        match self:
            case Success(msg):
                val preview = if msg.len() > 40:
                    msg.substring(0, 40) + "..."
                else:
                    msg
                "CliResult: {name} ({preview})"
            case Error(err):
                val preview = if err.len() > 40:
                    err.substring(0, 40) + "..."
                else:
                    err
                "CliResult: {name} ({preview})"
            case Help:
                "CliResult: {name}"

# CLI commands
enum Command:
    Parse(file_path: text, language: Option<text>, show_tree: bool)
    Query(file_path: text, query_str: text, language: Option<text>)
    Test(test_file: text)
    Highlight(file_path: text, language: Option<text>)
    Validate(grammar_file: text)
    Languages
    Help
    Version

impl Command:
    # =========================================================================
    # Helper Methods
    # =========================================================================

    fn is_parse() -> bool:
        """Check if this is Parse command.

        Returns:
            true for Parse

        Example:
            Command.Parse("test.spl", nil, false).is_parse()  # → true
        """
        match self:
            case Parse(_, _, _): true
            case _: false

    fn is_query() -> bool:
        """Check if this is Query command.

        Returns:
            true for Query

        Example:
            Command.Query("test.spl", "(func)", nil).is_query()  # → true
        """
        match self:
            case Query(_, _, _): true
            case _: false

    fn is_test() -> bool:
        """Check if this is Test command.

        Returns:
            true for Test

        Example:
            Command.Test("test.spl").is_test()  # → true
        """
        match self:
            case Test(_): true
            case _: false

    fn is_highlight() -> bool:
        """Check if this is Highlight command.

        Returns:
            true for Highlight

        Example:
            Command.Highlight("test.spl", nil).is_highlight()  # → true
        """
        match self:
            case Highlight(_, _): true
            case _: false

    fn is_validate() -> bool:
        """Check if this is Validate command.

        Returns:
            true for Validate

        Example:
            Command.Validate("grammar.spl").is_validate()  # → true
        """
        match self:
            case Validate(_): true
            case _: false

    fn is_languages() -> bool:
        """Check if this is Languages command.

        Returns:
            true for Languages

        Example:
            Command.Languages.is_languages()  # → true
        """
        match self:
            case Languages: true
            case _: false

    fn is_help() -> bool:
        """Check if this is Help command.

        Returns:
            true for Help

        Example:
            Command.Help.is_help()  # → true
        """
        match self:
            case Help: true
            case _: false

    fn is_version() -> bool:
        """Check if this is Version command.

        Returns:
            true for Version

        Example:
            Command.Version.is_version()  # → true
        """
        match self:
            case Version: true
            case _: false

    fn requires_file() -> bool:
        """Check if command requires a file path.

        Returns:
            true for Parse, Query, Highlight, Test, Validate

        Example:
            Command.Parse("test.spl", nil, false).requires_file()  # → true
            Command.Languages.requires_file()  # → false
        """
        match self:
            case Parse(_, _, _): true
            case Query(_, _, _): true
            case Test(_): true
            case Highlight(_, _): true
            case Validate(_): true
            case _: false

    fn is_meta_command() -> bool:
        """Check if this is a meta command (Help, Version, Languages).

        Returns:
            true for Help, Version, Languages

        Example:
            Command.Help.is_meta_command()  # → true
            Command.Parse("test.spl", nil, false).is_meta_command()  # → false
        """
        match self:
            case Help: true
            case Version: true
            case Languages: true
            case _: false

    fn is_processing_command() -> bool:
        """Check if command processes source code.

        Returns:
            true for Parse, Query, Highlight, Test

        Example:
            Command.Parse("test.spl", nil, false).is_processing_command()  # → true
            Command.Languages.is_processing_command()  # → false
        """
        match self:
            case Parse(_, _, _): true
            case Query(_, _, _): true
            case Test(_): true
            case Highlight(_, _): true
            case _: false

    fn accepts_language_option() -> bool:
        """Check if command accepts --language option.

        Returns:
            true for Parse, Query, Highlight

        Example:
            Command.Parse("test.spl", nil, false).accepts_language_option()  # → true
            Command.Test("test.spl").accepts_language_option()  # → false
        """
        match self:
            case Parse(_, _, _): true
            case Query(_, _, _): true
            case Highlight(_, _): true
            case _: false

    fn to_string() -> text:
        """Convert command to string.

        Returns:
            Command name

        Example:
            Command.Parse("test.spl", nil, false).to_string()  # → "parse"
        """
        match self:
            case Parse(_, _, _): "parse"
            case Query(_, _, _): "query"
            case Test(_): "test"
            case Highlight(_, _): "highlight"
            case Validate(_): "validate"
            case Languages: "languages"
            case Help: "help"
            case Version: "version"

    fn description() -> text:
        """Get command description.

        Returns:
            Human-readable description

        Example:
            Command.Parse("test.spl", nil, false).description()
            # → "Parse a file and show parse statistics"
        """
        match self:
            case Parse(_, _, _): "Parse a file and show parse statistics"
            case Query(_, _, _): "Run a tree-sitter query against a file"
            case Test(_): "Run grammar tests from a test file"
            case Highlight(_, _): "Show syntax highlighting tokens for a file"
            case Validate(_): "Validate a grammar definition file"
            case Languages: "List all supported languages"
            case Help: "Show help message"
            case Version: "Show version information"

    fn summary() -> text:
        """Get summary of command.

        Returns:
            Human-readable summary

        Example:
            Command.Parse("test.spl", nil, true).summary()
            # → "Command: parse (test.spl, show_tree=true)"
        """
        val name = self.to_string()
        match self:
            case Parse(file, lang, show_tree):
                val lang_str = match lang:
                    case Some(l): ", lang={l}"
                    case nil: ""
                val tree_str = if show_tree: ", show_tree=true" else: ""
                "Command: {name} ({file}{lang_str}{tree_str})"
            case Query(file, query, lang):
                val lang_str = match lang:
                    case Some(l): ", lang={l}"
                    case nil: ""
                "Command: {name} ({file}, query={query}{lang_str})"
            case Test(file):
                "Command: {name} ({file})"
            case Highlight(file, lang):
                val lang_str = match lang:
                    case Some(l): ", lang={l}"
                    case nil: ""
                "Command: {name} ({file}{lang_str})"
            case Validate(file):
                "Command: {name} ({file})"
            case Languages:
                "Command: {name} (meta)"
            case Help:
                "Command: {name} (meta)"
            case Version:
                "Command: {name} (meta)"
