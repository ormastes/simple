# REPL Execution FFI Bindings
# Provides execution capabilities for REPL via Rust Runner

# FFI declarations for REPL runner functions
extern fn simple_repl_runner_init() -> bool
extern fn simple_repl_runner_cleanup()
extern fn simple_repl_runner_execute(code_ptr: *u8, code_len: usize, result_buffer: *u8, result_capacity: usize) -> i32
extern fn simple_repl_runner_clear_prelude() -> bool
extern fn simple_repl_runner_get_prelude(buffer: *u8, capacity: usize) -> usize

## Initialize the REPL runner
## Must be called before executing any code
pub fn runner_init() -> bool:
    return simple_repl_runner_init()

## Cleanup the REPL runner
pub fn runner_cleanup():
    simple_repl_runner_cleanup()

## Execute code and get result
## Returns (success: bool, result: text)
pub fn execute(code: text) -> (bool, text):
    var result_buffer = alloc[u8](4096)
    val result_code = simple_repl_runner_execute(
        code.as_ptr(),
        code.len(),
        result_buffer.as_mut_ptr(),
        result_buffer.len()
    )

    val success = (result_code == 0)  # 0 = success, 1 = error
    val result_str = text.from_utf8(&result_buffer[0..result_buffer.len()]).unwrap()

    return (success, result_str)

## Clear the prelude (definitions)
pub fn clear_prelude() -> bool:
    return simple_repl_runner_clear_prelude()

## Get the current prelude
pub fn get_prelude() -> text:
    var buffer = alloc[u8](8192)
    val len = simple_repl_runner_get_prelude(
        buffer.as_mut_ptr(),
        buffer.len()
    )

    return text.from_utf8(&buffer[0..len]).unwrap()
