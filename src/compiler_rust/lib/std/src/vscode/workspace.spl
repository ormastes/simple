# VSCode Workspace API
# Access and manipulate workspace settings, files, and folders

use core.json.{parse, JsonValue}

# External FFI declarations
extern fn vscode_workspace_get_folders(): text
extern fn vscode_workspace_get_configuration(section: text): text
extern fn vscode_workspace_update_configuration(section: text, key: text, value: text): void
extern fn vscode_workspace_find_files(pattern: text, exclude_pattern: text): text
extern fn vscode_workspace_open_text_document(uri: text): text
extern fn vscode_workspace_save_text_document(uri: text): bool
extern fn vscode_workspace_close_text_document(uri: text): bool
extern fn vscode_workspace_get_workspace_folder(uri: text): text

# Import types
use vscode.languages.TextDocument

# Workspace folder
pub class WorkspaceFolder:
    pub uri: text
    pub name: text
    pub index: i32

    pub fn new(uri: text, name: text, index: i32): WorkspaceFolder =
        """Create workspace folder."""
        WorkspaceFolder {uri: uri, name: name, index: index}

# Configuration API
pub class WorkspaceConfiguration:
    pub section: text

    pub fn new(section: text): WorkspaceConfiguration =
        """Create configuration accessor for a section."""
        WorkspaceConfiguration {
            section: section
        }

    pub fn get(self, key: text): text =
        """Get configuration value.

        Args:
            key: Configuration key (e.g., "editor.tabSize")

        Returns:
            Configuration value as string

        Example:
            config = workspace.get_configuration("simple")
            tab_size = config.get("tabSize")
        """
        val full_key = self.section + "." + key
        vscode_workspace_get_configuration(full_key)

    pub fn update(self, key: text, value: text):
        """Update configuration value.

        Args:
            key: Configuration key
            value: New value

        Example:
            config = workspace.get_configuration("simple")
            config.update("tabSize", "4")
        """
        vscode_workspace_update_configuration(self.section, key, value)

    pub fn has(self, key: text): bool =
        """Check if configuration key exists."""
        val value = self.get(key)
        value != ""

# Get workspace configuration
pub fn get_configuration(section: text): WorkspaceConfiguration =
    """Get configuration for a section.

    Args:
        section: Configuration section (e.g., "editor", "simple")

    Returns:
        WorkspaceConfiguration object

    Example:
        config = workspace.get_configuration("simple")
        format_on_save = config.get("formatOnSave")
    """
    WorkspaceConfiguration.new(section)

# Get workspace folders
pub fn get_workspace_folders(): List<WorkspaceFolder> =
    """Get list of workspace folders.

    Returns:
        List of workspace folders (empty if no workspace)

    Example:
        folders = workspace.get_workspace_folders()
        for folder in folders:
            print "Folder: " + folder.name + " at " + folder.uri
    """
    val json = vscode_workspace_get_folders()

    # Parse JSON array to WorkspaceFolder list
    var folders: List<WorkspaceFolder> = []
    match parse(json):
        case Ok(JsonValue.Array(items)):
            var idx = 0
            for item in items:
                if val JsonValue.Object(obj) = item:
                    val uri = match obj.get("uri"):
                        Some(JsonValue.String(s)): s
                        _: ""
                    val name = match obj.get("name"):
                        Some(JsonValue.String(s)): s
                        _: ""
                    folders.append(WorkspaceFolder.new(uri, name, idx))
                    idx += 1
        case _:
            pass
    folders

# Get workspace folder for URI
pub fn get_workspace_folder(uri: text): Option<WorkspaceFolder> =
    """Get workspace folder containing a URI.

    Args:
        uri: File or folder URI

    Returns:
        WorkspaceFolder if found, none otherwise

    Example:
        folder = workspace.get_workspace_folder("file:///path/to/file.spl")
    """
    val json = vscode_workspace_get_workspace_folder(uri)

    if json == "":
        return none

    # Parse JSON to WorkspaceFolder
    match parse(json):
        case Ok(JsonValue.Object(obj)):
            val uri = match obj.get("uri"):
                Some(JsonValue.String(s)): s
                _: ""
            val name = match obj.get("name"):
                Some(JsonValue.String(s)): s
                _: ""
            val index = match obj.get("index"):
                Some(JsonValue.Number(n)): n as i32
                _: 0
            some(WorkspaceFolder.new(uri, name, index))
        case _:
            none

# Find files in workspace
pub fn find_files(pattern: text, exclude: text): List<text> =
    """Find files matching glob pattern.

    Args:
        pattern: Glob pattern (e.g., "**/*.spl")
        exclude: Exclude pattern (e.g., "**/node_modules/**")

    Returns:
        List of file URIs

    Example:
        files = workspace.find_files("**/*.spl", "**/target/**")
        for file in files:
            print "Found: " + file
    """
    val json = vscode_workspace_find_files(pattern, exclude)

    # Parse JSON array to string list
    var files: List<text> = []
    match parse(json):
        case Ok(JsonValue.Array(items)):
            for item in items:
                if val JsonValue.String(s) = item:
                    files.append(s)
        case _:
            pass
    files

# Open text document
pub fn open_text_document(uri: text): Option<TextDocument> =
    """Open a text document.

    Args:
        uri: Document URI

    Returns:
        TextDocument if successful, none otherwise

    Example:
        doc = workspace.open_text_document("file:///path/to/file.spl")
        match doc:
            some(d): print "Opened: " + d.uri
            none: print "Failed to open"
    """
    val json = vscode_workspace_open_text_document(uri)

    if json == "":
        return none

    # Parse JSON to TextDocument - document opened successfully
    some(TextDocument.new())

# Save text document
pub fn save_text_document(uri: text): bool =
    """Save a text document.

    Args:
        uri: Document URI

    Returns:
        true if saved successfully, false otherwise

    Example:
        success = workspace.save_text_document("file:///path/to/file.spl")
    """
    vscode_workspace_save_text_document(uri)

# Close text document
pub fn close_text_document(uri: text): bool =
    """Close a text document.

    Args:
        uri: Document URI

    Returns:
        true if closed successfully, false otherwise
    """
    vscode_workspace_close_text_document(uri)

# File system watcher
pub class FileSystemWatcher:
    pub pattern: text
    pub ignore_create_events: bool
    pub ignore_change_events: bool
    pub ignore_delete_events: bool

    pub fn new(pattern: text): FileSystemWatcher =
        """Create file system watcher.

        Args:
            pattern: Glob pattern to watch

        Example:
            watcher = FileSystemWatcher.new("**/*.spl")
            watcher.on_change(fn(uri):
                print "File changed: " + uri
            )
        """
        FileSystemWatcher {
            pattern: pattern,
            ignore_create_events: false,
            ignore_change_events: false,
            ignore_delete_events: false
        }

    pub fn on_create(self, handler: fn(uri: text): void):
        """Register handler for file creation."""
        # FFI call
        pass

    pub fn on_change(self, handler: fn(uri: text): void):
        """Register handler for file changes."""
        # FFI call
        pass

    pub fn on_delete(self, handler: fn(uri: text): void):
        """Register handler for file deletion."""
        # FFI call
        pass

    pub fn dispose(self):
        """Dispose watcher."""
        # FFI call
        pass

# Create file system watcher
pub fn create_file_system_watcher(pattern: text): FileSystemWatcher =
    """Create file system watcher.

    Example:
        watcher = workspace.create_file_system_watcher("**/*.spl")
        watcher.on_change(fn(uri):
            # Recompile on file change
            compile_file(uri)
        )
    """
    FileSystemWatcher.new(pattern)
