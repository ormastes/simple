# x86 Port I/O
#
# Low-level port I/O instructions for x86 bare-metal programming.
# These are used to communicate with hardware devices via I/O ports.

export outb, inb, outw, inw, outl, inl
export io_wait

# Write a byte to an I/O port
@inline
fn outb(port: u16, value: u8):
    asm """
        mov dx, {port}
        mov al, {value}
        out dx, al
    """

# Read a byte from an I/O port
@inline
fn inb(port: u16) -> u8:
    var result: u8 = 0
    asm """
        mov dx, {port}
        in al, dx
        mov {result}, al
    """
    result

# Write a word (16-bit) to an I/O port
@inline
fn outw(port: u16, value: u16):
    asm """
        mov dx, {port}
        mov ax, {value}
        out dx, ax
    """

# Read a word (16-bit) from an I/O port
@inline
fn inw(port: u16) -> u16:
    var result: u16 = 0
    asm """
        mov dx, {port}
        in ax, dx
        mov {result}, ax
    """
    result

# Write a double word (32-bit) to an I/O port
@inline
fn outl(port: u16, value: u32):
    asm """
        mov dx, {port}
        mov eax, {value}
        out dx, eax
    """

# Read a double word (32-bit) from an I/O port
@inline
fn inl(port: u16) -> u32:
    var result: u32 = 0
    asm """
        mov dx, {port}
        in eax, dx
        mov {result}, eax
    """
    result

# I/O wait (short delay) by writing to unused port
# Port 0x80 is traditionally used for POST codes and causes a small delay
@inline
fn io_wait():
    outb(0x80, 0)
