/// Integration tests for doctest discovery
/// 
/// Tests file walking and doctest extraction from real files

use std.doctest.discovery::{discover_all, discover_file, DiscoveryConfig}
use std.doctest.parser::{DoctestExample}
use std.spec

describe "Doctest Discovery":
    context "Single File Discovery":
        it "discovers doctests from .spl file":
            # Given a Simple source file with doctests in docstrings
            file_path = "test/fixtures/doctest/sample.spl"
            
            # When discovering doctests
            examples = discover_file(file_path)
            
            # Then it should find the examples
            expect examples.len to be_gt 0
            expect examples[0].source to eq file_path
        
        it "discovers doctests from .sdt file":
            # Given a standalone doctest file
            file_path = "test/fixtures/doctest/sample.sdt"
            
            # When discovering doctests
            examples = discover_file(file_path)
            
            # Then it should find the examples
            expect examples.len to be_gt 0
            expect examples[0].source to eq file_path
        
        it "discovers doctests from Markdown file":
            # Given a Markdown file with ```simple-doctest blocks
            file_path = "test/fixtures/doctest/tutorial.md"
            
            # When discovering doctests
            examples = discover_file(file_path)
            
            # Then it should find the examples
            expect examples.len to be_gt 0
            expect examples[0].source to eq file_path
        
        it "returns empty list for unsupported file types":
            # Given a non-doctest file
            file_path = "test/fixtures/doctest/readme.txt"
            
            # When discovering doctests
            examples = discover_file(file_path)
            
            # Then it should return empty
            expect examples.len to eq 0
    
    context "Directory Discovery":
        it "discovers all doctests in directory tree":
            # Given a configuration for a test directory
            config = DiscoveryConfig(
                search_paths: ["test/fixtures/doctest"],
                include_patterns: ["**/*.spl", "**/*.sdt", "**/*.md"],
                exclude_patterns: ["**/ignored/**"]
            )
            
            # When discovering all doctests
            examples = discover_all(config)
            
            # Then it should find examples from multiple files
            expect examples.len to be_gt 0
            
            # And it should include different file types
            sources = examples.map(|ex| ex.source).to_set()
            expect sources.any(|s| s.ends_with(".spl")) to be True
            expect sources.any(|s| s.ends_with(".sdt")) to be True
            expect sources.any(|s| s.ends_with(".md")) to be True
        
        it "excludes files matching exclude patterns":
            # Given a configuration with exclude patterns
            config = DiscoveryConfig(
                search_paths: ["test/fixtures/doctest"],
                include_patterns: ["**/*.spl"],
                exclude_patterns: ["**/ignored/**", "**/temp/**"]
            )
            
            # When discovering doctests
            examples = discover_all(config)
            
            # Then it should not include excluded files
            sources = examples.map(|ex| ex.source)
            expect sources.any(|s| s.contains("/ignored/")) to be False
            expect sources.any(|s| s.contains("/temp/")) to be False
        
        it "handles non-existent directories gracefully":
            # Given a config with non-existent path
            config = DiscoveryConfig(
                search_paths: ["nonexistent/path"],
                include_patterns: ["**/*.spl"],
                exclude_patterns: []
            )
            
            # When discovering doctests
            examples = discover_all(config)
            
            # Then it should return empty without error
            expect examples.len to eq 0
    
    context "Source Location Tracking":
        it "tracks correct line numbers for .spl doctests":
            # Given a .spl file with docstring at known line
            file_path = "test/fixtures/doctest/with_line_numbers.spl"
            
            # When discovering doctests
            examples = discover_file(file_path)
            
            # Then line numbers should match source
            expect examples[0].location.line to be_gt 0
            expect examples[0].location.file to eq file_path
        
        it "tracks correct line numbers for Markdown doctests":
            # Given a .md file with doctest at known line
            file_path = "test/fixtures/doctest/tutorial.md"
            
            # When discovering doctests
            examples = discover_file(file_path)
            
            # Then line numbers should point to code block content
            expect examples[0].location.line to be_gt 0
            expect examples[0].location.file to eq file_path
    
    context "Tag and Metadata Extraction":
        it "extracts tags from @doctest annotations":
            # Given a file with tagged doctests
            file_path = "test/fixtures/doctest/tagged.spl"
            
            # When discovering doctests
            examples = discover_file(file_path)
            
            # Then tags should be present
            tagged = examples.filter(|ex| not ex.tags.is_empty)
            expect tagged.len to be_gt 0
            expect tagged[0].tags.contains("slow") to be True
        
        it "extracts timeout from @doctest annotations":
            # Given a file with timeout annotations
            file_path = "test/fixtures/doctest/with_timeout.spl"
            
            # When discovering doctests
            examples = discover_file(file_path)
            
            # Then custom timeout should be set
            custom = examples.filter(|ex| ex.timeout_ms != 5000)
            expect custom.len to be_gt 0
