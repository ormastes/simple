/// Advanced tests for doctest framework
/// Tests edge cases, error handling, and complex scenarios

import test.unit.*
import std.doctest.parser.*
import std.doctest.matcher.*
import std.doctest.runner.*
import std.spec

describe "Doctest Advanced Parser":
    context "edge cases in parsing":
        it "handles empty docstring":
            let content = ""
            let examples = parse_docstring(content)
            expect examples.len == 0

        it "handles whitespace-only docstring":
            let content = "   \n  \n  "
            let examples = parse_docstring(content)
            expect examples.len to eq 0

        it "handles single example without newline":
            let content = ">>> 1 + 1\n2"
            let examples = parse_docstring(content)
            expect examples.len to eq 1

        it "handles consecutive blank lines":
            let content = ">>> 1\n1\n\n\n>>> 2\n2\n"
            let examples = parse_docstring(content)
            expect examples.len to eq 2

        it "handles mixed line endings":
            let content = ">>> 1\n1\n"
            let examples = parse_docstring(content)
            expect examples.len to eq 1

    context "code continuation lines":
        it "handles continuation with ellipsis":
            let content = ">>> if true:\n...     print(1)\n1\n"
            let examples = parse_docstring(content)
            expect examples.len to eq 1

        it "handles multiple continuation lines":
            let content = ">>> for i in [1, 2, 3]:\n...     print(i)\n...     print(i * 2)\n1\n2\n2\n4\n3\n6\n"
            let examples = parse_docstring(content)
            expect examples.len to eq 1

        it "handles nested indentation":
            let content = ">>> if true:\n...     if true:\n...         print(1)\n1\n"
            let examples = parse_docstring(content)
            expect examples.len to eq 1

    context "expected output variations":
        it "handles output with empty lines":
            let content = ">>> 1\n1\n\n>>> 2\n2\n"
            let examples = parse_docstring(content)
            expect examples.len to eq 2

        it "handles multiline output":
            let content = ">>> print('a'); print('b'); print('c')\na\nb\nc\n"
            let examples = parse_docstring(content)
            expect examples.len to eq 1

        it "handles output with special characters":
            let content = ">>> 'hello@#$%^&*()'  \nhello@#$%^&*()\n"
            let examples = parse_docstring(content)
            expect examples.len to eq 1

        it "handles output with tabs":
            let content = ">>> 'tab\\there'\ntab\there\n"
            let examples = parse_docstring(content)
            expect examples.len to eq 1

    context "exception parsing":
        it "parses simple exception":
            let content = ">>> 1 / 0\nError: DivisionByZero\n"
            let examples = parse_docstring(content)
            match examples[0].expected:
                case Expected.Exception(typ, msg):
                    expect typ to include "Division"

        it "parses exception with colon message":
            let content = ">>> x\nError: NameError: undefined variable\n"
            let examples = parse_docstring(content)
            expect examples.len to eq 1

        it "parses exception without message":
            let content = ">>> error_func()\nError: RuntimeError\n"
            let examples = parse_docstring(content)
            expect examples.len to eq 1

    context "setup and teardown blocks":
        it "handles setup before example":
            let content = "Setup:\n>>> x = 5\n\nExample:\n>>> x + 1\n6\n"
            let examples = parse_docstring(content)
            expect examples.len to eq 1

        it "handles teardown after example":
            let content = ">>> f = open('file')\n\nTeardown:\n>>> f.close()\n"
            let examples = parse_docstring(content)
            expect examples.len to eq 1

        it "handles setup and teardown together":
            let content = "Setup:\n>>> x = 10\n\nExample:\n>>> x * 2\n20\n\nTeardown:\n>>> print('done')\ndone\n"
            let examples = parse_docstring(content)
            expect examples.len to eq 1

describe "Doctest Advanced Matcher":
    context "wildcard patterns":
        it "matches with single character wildcard":
            expect wildcard_match("abc", "a.c") to be True
            expect wildcard_match("axc", "a.c") to be True

        it "matches with star at beginning":
            expect wildcard_match("hello", "*llo") to be True

        it "matches with star at end":
            expect wildcard_match("hello", "hel*") to be True

        it "matches with star in middle":
            expect wildcard_match("hello world", "hel*orld") to be True

        it "matches multiple wildcards":
            expect wildcard_match("abcde", "a.c.e") to be True
            expect wildcard_match("hello123world", "hello*world") to be True

        it "fails on non-matching wildcard":
            expect wildcard_match("abc", "a.d") to be False
            expect wildcard_match("hello", "h*z") to be False

    context "whitespace normalization":
        it "normalizes trailing whitespace":
            expect normalize("hello  ") to eq "hello"
            expect normalize("hello\t") to eq "hello"
            expect normalize("hello\n") to eq "hello"

        it "normalizes per-line trailing whitespace":
            expect normalize("line1  \nline2  ") to eq "line1\nline2"

        it "preserves leading whitespace":
            expect normalize("  hello") to eq "  hello"

        it "preserves internal whitespace":
            expect normalize("hello   world") to eq "hello   world"

    context "exact matching with normalization":
        it "exact_match normalizes strings":
            expect exact_match("hello  ", "hello") to be True
            expect exact_match("hello\n", "hello") to be True

        it "exact_match is case sensitive":
            expect exact_match("Hello", "hello") to be False
            expect exact_match("Hello", "Hello") to be True

        it "exact_match with empty strings":
            expect exact_match("", "") to be True
            expect exact_match(" ", "") to be True

    context "output matching results":
        it "match_output success case":
            let actual = "42"
            let expected = Expected.Output("42")
            let res_val = match_output(actual, expected)
            match result:
                case MatchResult.Pass:
                    pass
                case _:
                    fail "Expected pass"

        it "match_output failure case":
            let actual = "42"
            let expected = Expected.Output("43")
            let res_val = match_output(actual, expected)
            match result:
                case MatchResult.Fail(msg):
                    expect msg.len > 0

    context "empty output matching":
        it "matches empty output":
            let actual = ""
            let expected = Expected.Empty
            let res_val = match_output(actual, expected)
            match result:
                case MatchResult.Pass:
                    pass
                case _:
                    fail "Expected pass"

        it "fails when expecting empty but got output":
            let actual = "unexpected"
            let expected = Expected.Empty
            let res_val = match_output(actual, expected)
            match result:
                case MatchResult.Fail(msg):
                    expect msg.len > 0

describe "Doctest Advanced Runner":
    context "example execution":
        it "executes simple example":
            let runner = DoctestRunner.new()
            let example = DoctestExample(
                source: "test",
                location: SourceLocation(file: "test", line: 1),
                setup: [],
                code: ["1 + 1"],
                expected: Expected.Output("2"),
                teardown: [],
                tags: Set.new(),
                mode: "inline",
                timeout_ms: 5000
            )
            let res_val = runner.run_example(example)
            expect res_val.passed() to be True

        it "executes example with setup":
            let runner = DoctestRunner.new()
            let example = DoctestExample(
                source: "test",
                location: SourceLocation(file: "test", line: 1),
                setup: ["x = 5"],
                code: ["x + 10"],
                expected: Expected.Output("15"),
                teardown: [],
                tags: Set.new(),
                mode: "inline",
                timeout_ms: 5000
            )
            let res_val = runner.run_example(example)
            expect res_val.passed() to be True

        it "executes example with teardown":
            let runner = DoctestRunner.new()
            let example = DoctestExample(
                source: "test",
                location: SourceLocation(file: "test", line: 1),
                setup: [],
                code: ["1 + 1"],
                expected: Expected.Output("2"),
                teardown: ["# cleanup"],
                tags: Set.new(),
                mode: "inline",
                timeout_ms: 5000
            )
            let res_val = runner.run_example(example)
            expect res_val.passed() to be True

    context "error handling in examples":
        it "fails when output doesn't match":
            let runner = DoctestRunner.new()
            let example = DoctestExample(
                source: "test",
                location: SourceLocation(file: "test", line: 1),
                setup: [],
                code: ["1 + 1"],
                expected: Expected.Output("3"),
                teardown: [],
                tags: Set.new(),
                mode: "inline",
                timeout_ms: 5000
            )
            let res_val = runner.run_example(example)
            expect res_val.passed() to be False

        it "fails when setup throws":
            let runner = DoctestRunner.new()
            let example = DoctestExample(
                source: "test",
                location: SourceLocation(file: "test", line: 1),
                setup: ["raise ValueError('setup error')"],
                code: ["1 + 1"],
                expected: Expected.Output("2"),
                teardown: [],
                tags: Set.new(),
                mode: "inline",
                timeout_ms: 5000
            )
            let res_val = runner.run_example(example)
            expect res_val.passed() to be False

    context "batch execution":
        it "executes multiple examples":
            let runner = DoctestRunner.new()
            let examples = [
                DoctestExample(
                    source: "test",
                    location: SourceLocation(file: "test", line: 1),
                    setup: [],
                    code: ["1 + 1"],
                    expected: Expected.Output("2"),
                    teardown: [],
                    tags: Set.new(),
                    mode: "inline",
                    timeout_ms: 5000
                ),
                DoctestExample(
                    source: "test",
                    location: SourceLocation(file: "test", line: 3),
                    setup: [],
                    code: ["2 + 2"],
                    expected: Expected.Output("4"),
                    teardown: [],
                    tags: Set.new(),
                    mode: "inline",
                    timeout_ms: 5000
                )
            ]
            let results = runner.run_examples(examples)
            expect results.len to eq 2

        it "reports mixed pass/fail in batch":
            let runner = DoctestRunner.new()
            let examples = [
                DoctestExample(
                    source: "test",
                    location: SourceLocation(file: "test", line: 1),
                    setup: [],
                    code: ["1 + 1"],
                    expected: Expected.Output("2"),
                    teardown: [],
                    tags: Set.new(),
                    mode: "inline",
                    timeout_ms: 5000
                ),
                DoctestExample(
                    source: "test",
                    location: SourceLocation(file: "test", line: 3),
                    setup: [],
                    code: ["1 + 1"],
                    expected: Expected.Output("3"),
                    teardown: [],
                    tags: Set.new(),
                    mode: "inline",
                    timeout_ms: 5000
                )
            ]
            let results = runner.run_examples(examples)
            expect results.len to eq 2
            # First should pass, second should fail

describe "Doctest Framework Edge Cases":
    context "Unicode handling":
        it "handles unicode in docstring":
            let content = ">>> 'café'\ncafé\n"
            let examples = parse_docstring(content)
            expect examples.len to eq 1

        it "handles unicode in expected output":
            let content = ">>> print('∑∏∂')\n∑∏∂\n"
            let examples = parse_docstring(content)
            expect examples.len to eq 1

    context "special characters":
        it "handles backslash escapes":
            let content = ">>> 'path\\\\to\\\\file'\npath\\to\\file\n"
            let examples = parse_docstring(content)
            expect examples.len to eq 1

        it "handles quotes in output":
            let content = ">>> \"test 'single' and \\\"double\\\"\"\ntest 'single' and \"double\"\n"
            let examples = parse_docstring(content)
            expect examples.len to eq 1

    context "line endings and whitespace":
        it "preserves meaningful whitespace in output":
            let content = ">>> 'a  b  c'\na  b  c\n"
            let examples = parse_docstring(content)
            expect examples.len to eq 1

        it "handles mixed indentation":
            let content = ">>> if true:\n...   x = 1\n...   y = 2\n"
            let examples = parse_docstring(content)
            expect examples.len to eq 1

    context "recovery and resilience":
        it "continues after malformed example":
            let content = ">>> 1 + 1\n2\n\n>>> 2 + 2\n4\n"
            let examples = parse_docstring(content)
            expect examples.len to eq 2

        it "handles incomplete example gracefully":
            let content = ">>> 1 +"
            let examples = parse_docstring(content)
            # Should either parse as incomplete or skip
            expect examples.len >= 0
