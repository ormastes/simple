# LZ77 Sliding Window Operations
#
# Functions for managing the sliding window and lookahead buffer.

# ============================================================================
# Exports
# ============================================================================

export window_add_byte, window_get_byte, window_get_bytes, window_copy_bytes
export window_slide, window_reset, window_current_size, window_get_buffer
export lookahead_add_byte, lookahead_add_bytes, lookahead_get_byte, lookahead_get_bytes
export lookahead_remove_bytes, lookahead_clear, lookahead_current_length, lookahead_get_data

# ============================================================================
# Sliding Window Operations
# ============================================================================

fn window_add_byte(window: any, byte: i64):
    # Add byte to sliding window
    val buf = window.buffer
    val pos = window.position
    buf.push(byte)
    val new_count = window.count + 1
    window.count = new_count
    val new_pos = pos + 1
    window.position = new_pos
    window.tail = new_pos

fn window_get_byte(window: any, index: i64) -> i64:
    # Get byte from window at index
    val buf = window.buffer
    val len = buf.len()
    if index >= 0:
        if index < len:
            buf[index]
        else:
            0
    else:
        0

fn window_get_bytes(window: any, start: i64, count: i64) -> list:
    # Get multiple bytes from window
    val result = []
    var i = 0
    while i < count:
        val idx = start + i
        val byte = window_get_byte(window, idx)
        result.push(byte)
        i = i + 1
    result

fn window_copy_bytes(window: any, start: i64, count: i64, dest: list):
    # Copy bytes from window to destination
    var i = 0
    while i < count:
        val idx = start + i
        val byte = window_get_byte(window, idx)
        dest.push(byte)
        i = i + 1

fn window_slide(window: any, distance: i64):
    # Slide window by distance
    val new_head = window.head + distance
    window.head = new_head
    val new_count = window.count - distance
    window.count = new_count

fn window_reset(window: any):
    # Reset window to empty
    window.buffer = []
    window.position = 0
    window.head = 0
    window.tail = 0
    window.count = 0

fn window_current_size(window: any) -> i64:
    # Get current window size
    window.count

fn window_get_buffer(window: any) -> list:
    # Get window buffer
    window.buffer

# ============================================================================
# Lookahead Buffer Operations
# ============================================================================

fn lookahead_add_byte(lookahead: any, byte: i64):
    # Add byte to lookahead buffer
    val data = lookahead.data
    data.push(byte)
    val new_len = lookahead.length + 1
    lookahead.length = new_len

fn lookahead_add_bytes(lookahead: any, bytes: list, count: i64):
    # Add multiple bytes to lookahead
    var i = 0
    val src_len = bytes.len()
    while i < count:
        if i >= src_len:
            ()
        else:
            val byte = bytes[i]
            lookahead_add_byte(lookahead, byte)
            i = i + 1

fn lookahead_get_byte(lookahead: any, index: i64) -> i64:
    # Get byte from lookahead at index
    val data = lookahead.data
    val len = data.len()
    if index >= 0:
        if index < len:
            data[index]
        else:
            0
    else:
        0

fn lookahead_get_bytes(lookahead: any, start: i64, count: i64) -> list:
    # Get multiple bytes from lookahead
    val result = []
    var i = 0
    while i < count:
        val idx = start + i
        val byte = lookahead_get_byte(lookahead, idx)
        result.push(byte)
        i = i + 1
    result

fn lookahead_remove_bytes(lookahead: any, count: i64):
    # Remove bytes from front of lookahead
    val data = lookahead.data
    var i = 0
    while i < count:
        if data.len() > 0:
            data.remove(0)
            val new_len = lookahead.length - 1
            lookahead.length = new_len
        i = i + 1

fn lookahead_clear(lookahead: any):
    # Clear lookahead buffer
    lookahead.data = []
    lookahead.length = 0

fn lookahead_current_length(lookahead: any) -> i64:
    # Get current lookahead length
    lookahead.length

fn lookahead_get_data(lookahead: any) -> list:
    # Get lookahead data
    lookahead.data
