# Predicate Utilities
#
# Helper functions for working with predicates (boolean functions).
# Pure Simple implementation - no external dependencies.
#
# Provides predicate combinators, logical operations, and utilities
# for composing and transforming boolean functions.
#
# Functions:
# - Combinators: and_pred, or_pred, not_pred, xor_pred
# - Composition: all_of, any_of, none_of
# - Factories: always_true, always_false, equals_pred
# - Utilities: negate, memoize_pred, count_satisfying

# ============================================================================
# Basic Predicate Combinators
# ============================================================================

fn and_pred(pred1, pred2):
    """Combine two predicates with AND.

    Returns a new predicate that is true when both are true.

    Example:
        val is_positive = \\x: x > 0
        val is_small = \\x: x < 10
        val pred = and_pred(is_positive, is_small)
        pred(5)  # true
        pred(-1)  # false
        pred(15)  # false
    """
    \\x: pred1(x) and pred2(x)

fn or_pred(pred1, pred2):
    """Combine two predicates with OR.

    Returns a new predicate that is true when either is true.

    Example:
        val is_zero = \\x: x == 0
        val is_positive = \\x: x > 0
        val pred = or_pred(is_zero, is_positive)
        pred(5)  # true
        pred(0)  # true
        pred(-1)  # false
    """
    \\x: pred1(x) or pred2(x)

fn not_pred(pred):
    """Negate a predicate.

    Returns a new predicate that is true when pred is false.

    Example:
        val is_positive = \\x: x > 0
        val is_not_positive = not_pred(is_positive)
        is_not_positive(-1)  # true
        is_not_positive(1)  # false
    """
    \\x: not pred(x)

fn xor_pred(pred1, pred2):
    """Combine two predicates with XOR.

    Returns true when exactly one predicate is true.

    Example:
        val is_even = \\x: x % 2 == 0
        val is_small = \\x: x < 10
        val pred = xor_pred(is_even, is_small)
        pred(5)  # true (small but odd)
        pred(12)  # true (even but not small)
        pred(4)  # false (both true)
    """
    \\x:
        val p1 = pred1(x)
        val p2 = pred2(x)
        (p1 or p2) and not (p1 and p2)

fn implies_pred(pred1, pred2):
    """Logical implication: pred1 implies pred2.

    Returns false only when pred1 is true and pred2 is false.

    Example:
        val is_student = \\x: x.is_student
        val has_discount = \\x: x.has_discount
        val pred = implies_pred(is_student, has_discount)
        # "If student, then must have discount"
    """
    \\x: not pred1(x) or pred2(x)

# ============================================================================
# Multiple Predicate Combinators
# ============================================================================

fn all_of(preds):
    """Combine multiple predicates with AND.

    Returns true when all predicates are true.

    Example:
        val pred = all_of([
            \\x: x > 0,
            \\x: x < 10,
            \\x: x % 2 == 0
        ])
        pred(4)  # true
        pred(11)  # false
    """
    \\x:
        for pred in preds:
            if not pred(x):
                return false
        true

fn any_of(preds):
    """Combine multiple predicates with OR.

    Returns true when any predicate is true.

    Example:
        val pred = any_of([
            \\x: x == 0,
            \\x: x > 100,
            \\x: x < -100
        ])
        pred(0)  # true
        pred(150)  # true
        pred(50)  # false
    """
    \\x:
        for pred in preds:
            if pred(x):
                return true
        false

fn none_of(preds):
    """Returns true when none of the predicates are true.

    Example:
        val pred = none_of([
            \\x: x < 0,
            \\x: x > 100
        ])
        pred(50)  # true (in valid range)
        pred(-1)  # false
    """
    \\x:
        for pred in preds:
            if pred(x):
                return false
        true

fn exactly_n_of(preds, n: i64):
    """Returns true when exactly n predicates are true.

    Example:
        val pred = exactly_n_of([
            \\x: x > 0,
            \\x: x % 2 == 0,
            \\x: x < 10
        ], 2)
        pred(4)  # true (positive, even, small - 3 match, fails)
        pred(6)  # true (positive, even, small - 3 match, fails)
        pred(11)  # true (positive, odd, big - 1 match, fails)
        pred(-2)  # true (negative, even, small - 2 match, succeeds)
    """
    \\x:
        var count = 0
        for pred in preds:
            if pred(x):
                count = count + 1
        count == n

fn at_least_n_of(preds, n: i64):
    """Returns true when at least n predicates are true.

    Example:
        val pred = at_least_n_of([
            \\x: x > 0,
            \\x: x % 2 == 0,
            \\x: x < 10
        ], 2)
    """
    \\x:
        var count = 0
        for pred in preds:
            if pred(x):
                count = count + 1
                if count >= n:
                    return true
        false

fn at_most_n_of(preds, n: i64):
    """Returns true when at most n predicates are true.

    Example:
        val pred = at_most_n_of([
            \\x: x > 0,
            \\x: x % 2 == 0,
            \\x: x < 10
        ], 1)
    """
    \\x:
        var count = 0
        for pred in preds:
            if pred(x):
                count = count + 1
                if count > n:
                    return false
        true

# ============================================================================
# Predicate Factories
# ============================================================================

fn always_true():
    """Create a predicate that always returns true.

    Example:
        val pred = always_true()
        pred(anything)  # true
    """
    \\x: true

fn always_false():
    """Create a predicate that always returns false.

    Example:
        val pred = always_false()
        pred(anything)  # false
    """
    \\x: false

fn equals_pred(value):
    """Create a predicate that checks equality with value.

    Example:
        val is_five = equals_pred(5)
        is_five(5)  # true
        is_five(3)  # false
    """
    \\x: x == value

fn not_equals_pred(value):
    """Create a predicate that checks inequality with value.

    Example:
        val is_not_zero = not_equals_pred(0)
        is_not_zero(5)  # true
        is_not_zero(0)  # false
    """
    \\x: x != value

fn in_set_pred(values):
    """Create a predicate that checks if value is in set.

    Example:
        val is_vowel = in_set_pred(["a", "e", "i", "o", "u"])
        is_vowel("a")  # true
        is_vowel("b")  # false
    """
    \\x:
        for value in values:
            if x == value:
                return true
        false

fn not_in_set_pred(values):
    """Create a predicate that checks if value is not in set.

    Example:
        val is_consonant = not_in_set_pred(["a", "e", "i", "o", "u"])
    """
    \\x:
        for value in values:
            if x == value:
                return false
        true

# ============================================================================
# Numeric Range Predicates
# ============================================================================

fn greater_than_pred(threshold):
    """Create predicate for > threshold.

    Example:
        val is_big = greater_than_pred(100)
        is_big(150)  # true
    """
    \\x: x > threshold

fn less_than_pred(threshold):
    """Create predicate for < threshold.

    Example:
        val is_small = less_than_pred(10)
        is_small(5)  # true
    """
    \\x: x < threshold

fn between_pred(lower, upper):
    """Create predicate for lower <= x <= upper.

    Example:
        val is_in_range = between_pred(1, 10)
        is_in_range(5)  # true
        is_in_range(15)  # false
    """
    \\x: x >= lower and x <= upper

fn between_exclusive_pred(lower, upper):
    """Create predicate for lower < x < upper.

    Example:
        val is_in_range = between_exclusive_pred(1, 10)
        is_in_range(5)  # true
        is_in_range(1)  # false
    """
    \\x: x > lower and x < upper

# ============================================================================
# Key-Based Predicates
# ============================================================================

fn by_key_pred(key_fn, pred):
    """Transform predicate to work on key of value.

    Example:
        val has_long_name = by_key_pred(
            \\person: person.name,
            \\name: name.len() > 10
        )
    """
    \\x: pred(key_fn(x))

fn equals_by_key(key_fn, value):
    """Check if key equals value.

    Example:
        val is_named_alice = equals_by_key(
            \\person: person.name,
            "Alice"
        )
    """
    \\x: key_fn(x) == value

# ============================================================================
# Predicate Utilities
# ============================================================================

fn negate(pred):
    """Alias for not_pred.

    Example:
        val is_odd = negate(\\x: x % 2 == 0)
    """
    not_pred(pred)

fn count_satisfying(arr, pred):
    """Count how many elements satisfy predicate.

    Example:
        count_satisfying([1, 2, 3, 4, 5], \\x: x % 2 == 0)  # 2
    """
    var count = 0
    for item in arr:
        if pred(item):
            count = count + 1
    count

fn find_satisfying(arr, pred):
    """Find first element satisfying predicate.

    Returns Some(element) or nil.

    Example:
        find_satisfying([1, 2, 3, 4], \\x: x > 2)  # Some(3)
    """
    for item in arr:
        if pred(item):
            return Some(item)
    nil

fn find_index_satisfying(arr, pred):
    """Find index of first element satisfying predicate.

    Returns Some(index) or nil.

    Example:
        find_index_satisfying([1, 2, 3, 4], \\x: x > 2)  # Some(2)
    """
    var i = 0
    while i < arr.len():
        if pred(arr[i]):
            return Some(i)
        i = i + 1
    nil

fn filter_by_pred(arr, pred):
    """Filter array by predicate (alias for clarity).

    Example:
        filter_by_pred([1, 2, 3, 4, 5], \\x: x % 2 == 0)  # [2, 4]
    """
    var result = []
    for item in arr:
        if pred(item):
            result.push(item)
    result

fn partition_by_pred(arr, pred):
    """Partition array into (satisfying, not_satisfying).

    Example:
        partition_by_pred([1, 2, 3, 4, 5], \\x: x % 2 == 0)
        # ([2, 4], [1, 3, 5])
    """
    var satisfying = []
    var not_satisfying = []

    for item in arr:
        if pred(item):
            satisfying.push(item)
        else:
            not_satisfying.push(item)

    (satisfying, not_satisfying)

# ============================================================================
# Predicate Testing
# ============================================================================

fn test_predicate(pred, test_cases):
    """Test predicate with array of (input, expected) pairs.

    Returns array of failed test cases.

    Example:
        val is_even = \\x: x % 2 == 0
        test_predicate(is_even, [
            (2, true),
            (3, false),
            (4, true)
        ])
        # [] (all passed)
    """
    var failures = []

    for (input, expected) in test_cases:
        val actual = pred(input)
        if actual != expected:
            failures.push((input, expected, actual))

    failures

fn all_satisfy(arr, pred):
    """Check if all elements satisfy predicate.

    Example:
        all_satisfy([2, 4, 6], \\x: x % 2 == 0)  # true
    """
    for item in arr:
        if not pred(item):
            return false
    true

fn any_satisfy(arr, pred):
    """Check if any element satisfies predicate.

    Example:
        any_satisfy([1, 2, 3], \\x: x % 2 == 0)  # true
    """
    for item in arr:
        if pred(item):
            return true
    false

fn none_satisfy(arr, pred):
    """Check if no elements satisfy predicate.

    Example:
        none_satisfy([1, 3, 5], \\x: x % 2 == 0)  # true
    """
    for item in arr:
        if pred(item):
            return false
    true

# ============================================================================
# Cached/Memoized Predicates
# ============================================================================

fn memoize_predicate(pred, max_cache: i64):
    """Memoize a predicate (cache results).

    Note: Simple caching for i64 inputs only.

    Example:
        val expensive_pred = \\x: expensive_check(x)
        val cached = memoize_predicate(expensive_pred, 100)
    """
    var cache = []

    fn memoized(x: i64) -> bool:
        # Check cache
        for (input, result) in cache:
            if input == x:
                return result

        # Compute and cache
        val result = pred(x)

        if cache.len() < max_cache:
            cache.push((x, result))

        result

    memoized

# ============================================================================
# Predicate Composition Patterns
# ============================================================================

fn if_then_else_pred(condition, then_pred, else_pred):
    """Conditional predicate composition.

    If condition is true, use then_pred, otherwise else_pred.

    Example:
        val pred = if_then_else_pred(
            \\x: x > 0,
            \\x: x % 2 == 0,  # Check even if positive
            \\x: true          # Accept all negative
        )
    """
    \\x:
        if condition(x):
            then_pred(x)
        else:
            else_pred(x)

fn chain_predicates(preds):
    """Chain predicates with short-circuit AND.

    Evaluates predicates in order, stops at first false.

    Example:
        val pred = chain_predicates([
            \\x: x != 0,           # Check not zero first
            \\x: 100 % x == 0      # Then check divisibility
        ])
    """
    \\x:
        for pred in preds:
            if not pred(x):
                return false
        true

fn try_predicates(preds):
    """Try predicates in order, return true on first match.

    Short-circuit OR with explicit order.

    Example:
        val pred = try_predicates([
            \\x: x == 0,
            \\x: x > 100,
            \\x: x < -100
        ])
    """
    \\x:
        for pred in preds:
            if pred(x):
                return true
        false
