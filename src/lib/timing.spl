# Timing and Profiling Utilities
#
# Provides functions for measuring execution time and profiling performance.

use app.io.{rt_time_now_unix_micros}

# ============================================================================
# Time Measurement
# ============================================================================

struct Instant:
    """Represents a point in time for performance measurement."""
    micros: i64

fn time_now() -> Instant:
    """Get current time as an Instant."""
    Instant(micros: rt_time_now_unix_micros())

fn time_elapsed(start: Instant) -> i64:
    """
    Get elapsed time in milliseconds since start.

    Returns the number of milliseconds that have passed.
    """
    val end_micros = rt_time_now_unix_micros()
    val elapsed_micros = end_micros - start.micros
    elapsed_micros / 1000  # Convert to milliseconds

fn time_elapsed_micros(start: Instant) -> i64:
    """
    Get elapsed time in microseconds since start.

    Returns the number of microseconds that have passed.
    """
    val end_micros = rt_time_now_unix_micros()
    end_micros - start.micros

impl Instant:
    fn elapsed_ms() -> i64:
        """Get elapsed time in milliseconds since this instant."""
        time_elapsed(self)

    fn elapsed_micros() -> i64:
        """Get elapsed time in microseconds since this instant."""
        time_elapsed_micros(self)

# ============================================================================
# Profiling
# ============================================================================

struct ProfileResult:
    """Result of profiling a code block."""
    elapsed_ms: i64
    elapsed_micros: i64

fn profile<T>(name: text, block: fn() -> T) -> (T, ProfileResult):
    """
    Profile execution of a code block.

    Returns tuple of (result, ProfileResult).

    Example:
        val (result, timing) = profile("my_function"):
            expensive_computation()
        print "Took {timing.elapsed_ms}ms"
    """
    val start = time_now()
    val result = block()
    val elapsed_micros = time_elapsed_micros(start)
    val elapsed_ms = elapsed_micros / 1000

    (result, ProfileResult(
        elapsed_ms: elapsed_ms,
        elapsed_micros: elapsed_micros
    ))

fn time_block<T>(block: fn() -> T) -> (T, i64):
    """
    Time execution of a block, returning (result, elapsed_ms).

    Example:
        val (result, ms) = time_block:
            expensive_computation()
        print "Took {ms}ms"
    """
    val start = time_now()
    val result = block()
    val elapsed_ms = time_elapsed(start)
    (result, elapsed_ms)

# ============================================================================
# Benchmark Utilities
# ============================================================================

struct BenchmarkResult:
    """Result of running a benchmark."""
    iterations: i64
    total_ms: i64
    avg_ms: f64
    min_ms: i64
    max_ms: i64

fn benchmark(iterations: i64, block: fn()):
    """
    Run a block multiple times and report statistics.

    Example:
        benchmark(1000):
            my_function()
    """
    var times = []
    var total_ms = 0

    for i in 0..iterations:
        val start = time_now()
        block()
        val elapsed = time_elapsed(start)

        times.push(elapsed)
        total_ms = total_ms + elapsed

    # Calculate statistics
    times.sort()
    val min_ms = times[0]
    val max_ms = times[times.len() - 1]
    val avg_ms = float(total_ms) / float(iterations)

    BenchmarkResult(
        iterations: iterations,
        total_ms: total_ms,
        avg_ms: avg_ms,
        min_ms: min_ms,
        max_ms: max_ms
    )

fn bench_once<T>(name: text, block: fn() -> T) -> T:
    """
    Benchmark a single execution and print timing.

    Example:
        val result = bench_once("my_function"):
            expensive_computation()
    """
    val start = time_now()
    val result = block()
    val elapsed = time_elapsed(start)

    print "[BENCH] {name}: {elapsed}ms"
    result

# ============================================================================
# Exports
# ============================================================================

export Instant, ProfileResult, BenchmarkResult
export time_now, time_elapsed, time_elapsed_micros
export profile, time_block, benchmark, bench_once
