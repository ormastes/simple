# Base32 Encoding Module

use base_encoding.types.{BASE32_STD_ALPHABET, BASE32_HEX_ALPHABET, PADDING_CHAR}
use base_encoding.utilities.{alphabet_char_at, alphabet_find_index, text_char_at, padding_add, padding_remove, padding_validate, power_of_2}

# ============================================================================
# BASE32 ENCODING
# ============================================================================

fn base32_encode(bytes: list) -> text:
    """Encode bytes to Base32 standard with padding."""
    base32_encode_with_config(bytes, BASE32_STD_ALPHABET, true)

fn base32_encode_no_pad(bytes: list) -> text:
    """Encode bytes to Base32 standard without padding."""
    base32_encode_with_config(bytes, BASE32_STD_ALPHABET, false)

fn base32_encode_hex(bytes: list) -> text:
    """Encode bytes to Base32 extended hex with padding."""
    base32_encode_with_config(bytes, BASE32_HEX_ALPHABET, true)

fn base32_encode_hex_no_pad(bytes: list) -> text:
    """Encode bytes to Base32 extended hex without padding."""
    base32_encode_with_config(bytes, BASE32_HEX_ALPHABET, false)

fn base32_encode_with_config(bytes: list, alphabet: text, use_padding: bool) -> text:
    """Encode bytes to Base32 with custom alphabet and padding option."""
    var result = ""
    var i = 0
    while i < bytes.len():
        var bits = 0
        var bit_count = 0
        var j = 0
        while j < 5:
            if i + j < bytes.len():
                var byte = bytes[i + j]
                bits = bits * 256 + byte
                bit_count = bit_count + 8
            j = j + 1
        var remaining_bits = bit_count
        while remaining_bits > 0:
            if remaining_bits >= 5:
                var shift = remaining_bits - 5
                var index = bits / power_of_2(shift)
                var mask = 31
                index = index % 32
                var c = alphabet_char_at(alphabet, index)
                result = result + c
                remaining_bits = remaining_bits - 5
            else:
                var shift = 5 - remaining_bits
                var index = bits * power_of_2(shift)
                var mask = 31
                index = index % 32
                var c = alphabet_char_at(alphabet, index)
                result = result + c
                remaining_bits = 0
        i = i + 5
    if use_padding:
        result = padding_add(result, 8)
    result

fn base32_decode(encoded: text) -> list:
    """Decode Base32 standard to bytes."""
    base32_decode_with_alphabet(encoded, BASE32_STD_ALPHABET)

fn base32_decode_hex(encoded: text) -> list:
    """Decode Base32 extended hex to bytes."""
    base32_decode_with_alphabet(encoded, BASE32_HEX_ALPHABET)

fn base32_decode_with_alphabet(encoded: text, alphabet: text) -> list:
    """Decode Base32 with custom alphabet to bytes."""
    var clean = padding_remove(encoded)
    var bytes = []
    var bits = 0
    var bit_count = 0
    var i = 0
    while i < clean.len():
        var c = text_char_at(clean, i)
        var index = alphabet_find_index(alphabet, c)
        if index == -1:
            return bytes
        bits = bits * 32 + index
        bit_count = bit_count + 5
        if bit_count >= 8:
            var shift = bit_count - 8
            var byte = bits / power_of_2(shift)
            byte = byte % 256
            bytes.push(byte)
            bit_count = bit_count - 8
        i = i + 1
    bytes

fn base32_validate(encoded: text) -> bool:
    """Validate Base32 standard encoded string."""
    base32_validate_with_alphabet(encoded, BASE32_STD_ALPHABET)

fn base32_validate_hex(encoded: text) -> bool:
    """Validate Base32 extended hex encoded string."""
    base32_validate_with_alphabet(encoded, BASE32_HEX_ALPHABET)

fn base32_validate_with_alphabet(encoded: text, alphabet: text) -> bool:
    """Validate Base32 encoded string with custom alphabet."""
    var i = 0
    while i < encoded.len():
        var c = text_char_at(encoded, i)
        if c == PADDING_CHAR:
            i = i + 1
            pass
        else:
            var index = alphabet_find_index(alphabet, c)
            if index == -1:
                return false
            i = i + 1
    padding_validate(encoded, 8)
