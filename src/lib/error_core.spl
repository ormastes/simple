# Error Core - Base Error Handling Primitives
#
# Provides foundational error handling primitives shared across all error types.
# Implements the Option pattern (NO try/catch/throw in Simple runtime).
#
# Design:
# - ErrorBase struct for consistent error structure
# - Pure functions for error creation and manipulation
# - Location tracking with line/column information
# - Optional source chain support
#
# Usage:
#   val error = error_new("Something failed", 42, 10)
#   val formatted = error_message(error)
#
# Architecture:
# - Simple struct-based errors (no traits at runtime)
# - Option pattern: nil = success, ErrorBase = failure
# - Zero allocation when no errors occur

# ============================================================================
# Core Error Structure
# ============================================================================

struct ErrorBase:
    """Base error structure for all error types.

    Fields:
    - message: Error message text
    - line: Source line number (0 if unknown)
    - col: Source column number (0 if unknown)
    - file: Source file path (empty if unknown)
    - kind: Error category identifier
    - cause: Optional nested error message

    Example:
        val error = ErrorBase(
            message: "Division by zero",
            line: 42,
            col: 15,
            file: "calc.spl",
            kind: "runtime",
            cause: nil
        )
    """
    message: text
    line: i64
    col: i64
    file: text
    kind: text
    cause: text?

# ============================================================================
# Error Creation Functions
# ============================================================================

fn error_new(message: text, line: i64, col: i64) -> ErrorBase:
    """Create basic error with location.

    Args:
        message: Error description
        line: Source line number
        col: Source column number

    Returns:
        ErrorBase structure

    Example:
        val error = error_new("Unexpected token", 10, 5)
    """
    ErrorBase(
        message: message,
        line: line,
        col: col,
        file: "",
        kind: "error",
        cause: nil
    )

fn error_with_file(message: text, line: i64, col: i64, file: text) -> ErrorBase:
    """Create error with file location.

    Args:
        message: Error description
        line: Source line number
        col: Source column number
        file: Source file path

    Returns:
        ErrorBase with file context
    """
    ErrorBase(
        message: message,
        line: line,
        col: col,
        file: file,
        kind: "error",
        cause: nil
    )

fn error_with_kind(message: text, line: i64, col: i64, kind: text) -> ErrorBase:
    """Create error with specific kind.

    Args:
        message: Error description
        line: Source line number
        col: Source column number
        kind: Error category (e.g., "parse", "type", "runtime")

    Returns:
        ErrorBase with kind label
    """
    ErrorBase(
        message: message,
        line: line,
        col: col,
        file: "",
        kind: kind,
        cause: nil
    )

fn error_with_cause(base: ErrorBase, cause: text) -> ErrorBase:
    """Add cause to existing error.

    Args:
        base: Original error
        cause: Underlying cause description

    Returns:
        ErrorBase with cause chain

    Example:
        val io_err = error_new("Failed to read file", 0, 0)
        val full_err = error_with_cause(io_err, "Permission denied")
    """
    ErrorBase(
        message: base.message,
        line: base.line,
        col: base.col,
        file: base.file,
        kind: base.kind,
        cause: cause
    )

fn error_simple(message: text) -> ErrorBase:
    """Create simple error without location.

    Args:
        message: Error description

    Returns:
        ErrorBase with no location info

    Example:
        val error = error_simple("Invalid configuration")
    """
    ErrorBase(
        message: message,
        line: 0,
        col: 0,
        file: "",
        kind: "error",
        cause: nil
    )

# ============================================================================
# Error Accessors
# ============================================================================

fn error_message(error: ErrorBase) -> text:
    """Get error message.

    Args:
        error: Error structure

    Returns:
        Message text
    """
    error.message

fn error_location(error: ErrorBase) -> (i64, i64):
    """Get error location.

    Args:
        error: Error structure

    Returns:
        (line, column) tuple
    """
    (error.line, error.col)

fn error_file(error: ErrorBase) -> text:
    """Get error source file.

    Args:
        error: Error structure

    Returns:
        File path (empty if unknown)
    """
    error.file

fn error_kind(error: ErrorBase) -> text:
    """Get error kind.

    Args:
        error: Error structure

    Returns:
        Kind identifier
    """
    error.kind

fn error_has_cause(error: ErrorBase) -> bool:
    """Check if error has a cause.

    Args:
        error: Error structure

    Returns:
        true if cause is present
    """
    if error.cause:
        error.cause != ""
    else:
        false

fn error_get_cause(error: ErrorBase) -> text:
    """Get error cause (empty if none).

    Args:
        error: Error structure

    Returns:
        Cause text or empty string
    """
    if error.cause:
        error.cause
    else:
        ""

# ============================================================================
# Exports
# ============================================================================

export ErrorBase
export error_new, error_with_file, error_with_kind, error_with_cause, error_simple
export error_message, error_location, error_file, error_kind
export error_has_cause, error_get_cause
