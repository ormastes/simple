# OAuth 2.0 Validation Module
# Token validation, scopes, security checks

import string
import array
import oauth.types
import oauth.utilities

# ============================================================================
# Scope Management
# ============================================================================

# Parse scope string into array of scopes
fn parse_scopes(scope_string: text):
    if string.length(scope_string) == 0:
        []
    else:
        text.split(scope_string, " ")

# Build scope string from array of scopes
fn build_scope_string(scopes):
    array.join(scopes, " ")

# Check if token has specific scope
fn has_scope(token, scope: text) -> bool:
    val token_scope = get_token_scope(token)
    val scopes = parse_scopes(token_scope)
    array_contains(scopes, scope)

# Check if token has all required scopes
fn has_all_scopes(token, required_scopes) -> bool:
    var i = 0
    var has_all = true
    while i < array.length(required_scopes):
        val scope = array.get(required_scopes, i)
        if not has_scope(token, scope):
            has_all = false
        i = i + 1
    has_all

# Check if token has any of the required scopes
fn has_any_scope(token, required_scopes) -> bool:
    var i = 0
    var has_any = false
    while i < array.length(required_scopes):
        val scope = array.get(required_scopes, i)
        if has_scope(token, scope):
            has_any = true
        i = i + 1
    has_any

# Validate scope format (alphanumeric, dots, underscores, hyphens)
fn validate_scope(scope: text) -> bool:
    val len = string.length(scope)
    if len == 0:
        return false

    var i = 0
    var valid = true
    while i < len:
        val char = string.char_at(scope, i)
        val is_alpha = is_alphanumeric(char)
        val is_dot = string.equals(char, ".")
        val is_underscore = string.equals(char, "_")
        val is_hyphen = string.equals(char, "-")

        if not is_alpha:
            if not is_dot:
                if not is_underscore:
                    if not is_hyphen:
                        valid = false
        i = i + 1
    valid

# Validate all scopes in array
fn validate_scopes(scopes) -> bool:
    var i = 0
    var valid = true
    while i < array.length(scopes):
        val scope = array.get(scopes, i)
        if not validate_scope(scope):
            valid = false
        i = i + 1
    valid

# ============================================================================
# Token Validation and Expiry
# ============================================================================

# Check if token is expired
fn is_token_expired(token) -> bool:
    val issued_at = get_token_issued_at(token)
    val expires_in = get_expires_in(token)
    val now = get_current_timestamp()
    val expiry_time = issued_at + expires_in
    now >= expiry_time

# Get token expiry timestamp
fn get_token_expiry(token) -> i64:
    val issued_at = get_token_issued_at(token)
    val expires_in = get_expires_in(token)
    issued_at + expires_in

# Get seconds until token expires (negative if expired)
fn get_time_until_expiry(token) -> i64:
    val expiry = get_token_expiry(token)
    val now = get_current_timestamp()
    expiry - now

# Validate access token (basic validation)
fn validate_access_token(token_string: text) -> bool:
    # Token should not be empty
    if string.length(token_string) == 0:
        return false

    # Token should be at least 20 characters (common minimum)
    if string.length(token_string) < 20:
        return false

    true

# Check if token needs refresh (expires within threshold seconds)
fn token_needs_refresh(token, threshold_seconds: i64) -> bool:
    val time_left = get_time_until_expiry(token)
    time_left <= threshold_seconds

# Check token age in seconds
fn get_token_age(token) -> i64:
    val issued_at = get_token_issued_at(token)
    val now = get_current_timestamp()
    now - issued_at

# ============================================================================
# Security Validation
# ============================================================================

# Validate redirect URI is in allowed list
fn validate_redirect_uri(uri: text, allowed_uris) -> bool:
    array_contains(allowed_uris, uri)

# Check if URL uses HTTPS
fn is_secure_url(url: text) -> bool:
    string.starts_with(url, "https://")

# Validate client ID format
fn validate_client_id(client_id: text) -> bool:
    val len = string.length(client_id)
    if len < 5:
        return false
    if len > 256:
        return false

    # Should contain only alphanumeric and hyphens
    var i = 0
    var valid = true
    while i < len:
        val char = string.char_at(client_id, i)
        val is_valid_char = is_alphanumeric(char)
        val is_hyphen = string.equals(char, "-")

        if not is_valid_char:
            if not is_hyphen:
                valid = false

        i = i + 1

    valid

# Validate authorization code format
fn validate_auth_code(code: text) -> bool:
    val len = string.length(code)
    if len < 20:
        return false
    if len > 512:
        return false
    true

# ============================================================================
# Token Introspection
# ============================================================================

# Build token introspection request
fn build_introspection_request(token: text, client_id: text, client_secret: text) -> text:
    var body = ""

    val token_param = string.concat("token=", url_encode(token))
    body = string.concat(body, token_param)

    val client_id_param = string.concat("&client_id=", url_encode(client_id))
    body = string.concat(body, client_id_param)

    val client_secret_param = string.concat("&client_secret=", url_encode(client_secret))
    body = string.concat(body, client_secret_param)

    body

# Parse introspection response
# Returns: (active, scope, client_id, username, token_type, exp, iat)
fn parse_introspection_response(json: text):
    val active_str = extract_json_value(json, "active")
    val active = string.equals(active_str, "true")
    val scope = extract_json_value(json, "scope")
    val client_id = extract_json_value(json, "client_id")
    val username = extract_json_value(json, "username")
    val token_type = extract_json_value(json, "token_type")
    val exp_str = extract_json_value(json, "exp")
    val iat_str = extract_json_value(json, "iat")

    val exp = text_to_i64(exp_str)
    val iat = text_to_i64(iat_str)

    (active, scope, client_id, username, token_type, exp, iat)

# Check if introspection response indicates active token
fn is_token_active(introspection_response) -> bool:
    introspection_response.0

# ============================================================================
# Token Revocation
# ============================================================================

# Build token revocation request
fn build_revocation_request(token: text, token_type_hint: text, client_id: text, client_secret: text) -> text:
    var body = ""

    val token_param = string.concat("token=", url_encode(token))
    body = string.concat(body, token_param)

    if string.length(token_type_hint) > 0:
        val hint_param = string.concat("&token_type_hint=", url_encode(token_type_hint))
        body = string.concat(body, hint_param)

    val client_id_param = string.concat("&client_id=", url_encode(client_id))
    body = string.concat(body, client_id_param)

    val client_secret_param = string.concat("&client_secret=", url_encode(client_secret))
    body = string.concat(body, client_secret_param)

    body

# Revoke access token
fn revoke_access_token(token: text, config):
    build_revocation_request(token, "access_token", get_config_client_id(config), get_config_client_secret(config))

# Revoke refresh token
fn revoke_refresh_token(token: text, config):
    build_revocation_request(token, "refresh_token", get_config_client_id(config), get_config_client_secret(config))

# ============================================================================
# EXPORTS
# ============================================================================

export parse_scopes, build_scope_string, has_scope, has_all_scopes, has_any_scope
export validate_scope, validate_scopes
export is_token_expired, get_token_expiry, get_time_until_expiry, validate_access_token
export token_needs_refresh, get_token_age
export validate_redirect_uri, is_secure_url, validate_client_id, validate_auth_code
export build_introspection_request, parse_introspection_response, is_token_active
export build_revocation_request, revoke_access_token, revoke_refresh_token
