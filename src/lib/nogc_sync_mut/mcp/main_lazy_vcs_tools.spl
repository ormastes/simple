# MCP Lazy Server - VCS tool handlers
# Extracted from main_lazy.spl
# Handles: simple_diff, simple_log, simple_squash, simple_new

# ============================================================================
# simple_diff — jj diff with file list
# ============================================================================

fn handle_simple_diff(id: text, body: text) -> text:
    val revision = extract_field(body, "revision")
    val paths_str = extract_field(body, "paths")

    var rev = "@"
    if revision != "":
        rev = revision

    var diff_cmd = "jj --no-pager --color never diff -r " + rev
    if paths_str != "":
        val path_parts = paths_str.split(",")
        for pp in path_parts:
            val pt = pp.trim()
            if pt != "":
                diff_cmd = diff_cmd + " " + pt
    diff_cmd = diff_cmd + " 2>&1"

    val (diff_out, _) = shell_cmd(diff_cmd)

    var out_parts: [text] = []
    out_parts.push("-- simple_diff -r " + rev + " --" + NL)
    out_parts.push(diff_out)
    make_tool_result(id, out_parts.join(""))

# ============================================================================
# simple_log — jj log
# ============================================================================

fn handle_simple_log(id: text, body: text) -> text:
    val limit_str = extract_field(body, "limit")
    val revsets = extract_field(body, "revsets")

    var limit = 10
    if limit_str != "":
        limit = int(limit_str)
        if limit < 1:
            limit = 10

    var log_cmd = "jj --no-pager --color never log --limit " + str(limit)
    if revsets != "":
        log_cmd = log_cmd + " -r " + revsets
    log_cmd = log_cmd + " 2>&1"

    val (log_out, _) = shell_cmd(log_cmd)

    var out_parts: [text] = []
    out_parts.push("-- simple_log --" + NL)
    out_parts.push(log_out)
    make_tool_result(id, out_parts.join(""))

# ============================================================================
# simple_squash — jj squash
# ============================================================================

fn handle_simple_squash(id: text, body: text) -> text:
    val revision = extract_field(body, "revision")
    val message = extract_field(body, "message")

    var squash_cmd = "jj --no-pager --color never squash"
    if revision != "":
        squash_cmd = squash_cmd + " -r " + revision
    if message != "":
        squash_cmd = squash_cmd + " -m '" + message + "'"
    squash_cmd = squash_cmd + " 2>&1"

    val (squash_out, squash_exit) = shell_cmd(squash_cmd)

    var out_parts: [text] = []
    out_parts.push("-- simple_squash --" + NL)
    out_parts.push(squash_out)
    if squash_exit == 0:
        out_parts.push(NL + "Squash completed successfully.")
    else:
        out_parts.push(NL + "Squash failed (exit code " + str(squash_exit) + ").")
    make_tool_result(id, out_parts.join(""))

# ============================================================================
# simple_new — jj new
# ============================================================================

fn handle_simple_new(id: text, body: text) -> text:
    val revision = extract_field(body, "revision")
    val message = extract_field(body, "message")

    var new_cmd = "jj --no-pager --color never new"
    if revision != "":
        new_cmd = new_cmd + " " + revision
    if message != "":
        new_cmd = new_cmd + " -m '" + message + "'"
    new_cmd = new_cmd + " 2>&1"

    val (new_out, new_exit) = shell_cmd(new_cmd)

    # Get revision info
    val (rev_info, _) = shell_cmd("jj --no-pager --color never log -r @ --limit 1 2>&1")

    var out_parts: [text] = []
    out_parts.push("-- simple_new --" + NL)
    out_parts.push(new_out + NL)
    out_parts.push(rev_info)
    if new_exit == 0:
        out_parts.push(NL + "New revision created.")
    else:
        out_parts.push(NL + "Failed (exit code " + str(new_exit) + ").")
    make_tool_result(id, out_parts.join(""))
