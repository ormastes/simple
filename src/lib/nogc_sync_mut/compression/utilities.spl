# compression/utilities.spl - Compression utilities and helpers
#
# Bit manipulation, statistics, and conversion utilities

# =============================================================================
# BIT MANIPULATION
# =============================================================================

# Pack bit string into bytes
fn pack_bits(bit_string):
    if bit_string == nil:
        return []

    val len = bit_string.length()
    var bytes = []
    var current = 0
    var bit_count = 0
    var i = 0

    loop:
        if i >= len:
            break

        val bit_char = bit_string[i]

        var bit = 0
        if bit_char == "1":
            bit = 1

        current = current * 2 + bit
        bit_count = bit_count + 1

        if bit_count == 8:
            bytes = bytes + [current]
            current = 0
            bit_count = 0

        i = i + 1

    # Add remaining bits
    if bit_count > 0:
        # Pad with zeros
        var j = bit_count
        loop:
            if j >= 8:
                break
            current = current * 2
            j = j + 1

        bytes = bytes + [current]

    return bytes

# Unpack bytes into bit string
fn unpack_bits(bytes, bit_count):
    if bytes == nil:
        return ""

    var bits = ""
    var i = 0
    var bits_written = 0

    loop:
        if i >= bytes.length():
            break
        if bits_written >= bit_count:
            break

        val byte = bytes[i]

        # Extract 8 bits
        var j = 7
        loop:
            if j < 0:
                break
            if bits_written >= bit_count:
                break

            val bit = (byte >> j) & 1

            if bit == 1:
                bits = bits + "1"
            else:
                bits = bits + "0"

            bits_written = bits_written + 1
            j = j - 1

        i = i + 1

    return bits

# Convert byte to 8-bit string
fn byte_to_bits(byte):
    var bits = ""
    var i = 7

    loop:
        if i < 0:
            break

        val bit = (byte >> i) & 1

        if bit == 1:
            bits = bits + "1"
        else:
            bits = bits + "0"

        i = i - 1

    return bits

# Convert 8-bit string to byte
fn bits_to_byte(bits):
    if bits == nil:
        return 0

    var result = 0
    var i = 0

    loop:
        if i >= bits.length():
            break
        if i >= 8:
            break

        result = result * 2

        if bits[i] == "1":
            result = result + 1

        i = i + 1

    return result

# =============================================================================
# COMPRESSION STATISTICS
# =============================================================================

# Calculate compression ratio (compressed / original)
fn compression_ratio(original, compressed):
    if original == nil:
        return 1.0
    if compressed == nil:
        return 1.0

    val orig_size = original.length()
    val comp_size = compressed.length()

    if orig_size == 0:
        return 1.0

    val ratio = comp_size.to_float() / orig_size.to_float()
    return ratio

# Calculate space savings percentage
fn space_savings(original, compressed):
    if original == nil:
        return 0.0
    if compressed == nil:
        return 0.0

    val orig_size = original.length()
    val comp_size = compressed.length()

    if orig_size == 0:
        return 0.0

    val saved = orig_size - comp_size
    val savings = (saved.to_float() / orig_size.to_float()) * 100.0

    return savings

# Calculate compression ratio for byte arrays
fn compression_ratio_bytes(original, compressed):
    if original == nil:
        return 1.0
    if compressed == nil:
        return 1.0

    val orig_size = original.length()
    val comp_size = compressed.length()

    if orig_size == 0:
        return 1.0

    val ratio = comp_size.to_float() / orig_size.to_float()
    return ratio

# Calculate bits per character for encoded data
fn bits_per_char(encoded_bits, original_length):
    if original_length == 0:
        return 0.0

    val bit_count = encoded_bits.length()
    val bpc = bit_count.to_float() / original_length.to_float()

    return bpc

# =============================================================================
# CONVERSION UTILITIES
# =============================================================================

# Convert text to byte array (ASCII)
fn text_to_bytes(text):
    if text == nil:
        return []

    var bytes = []
    var i = 0

    loop:
        if i >= text.length():
            break

        val ch = text[i]
        val code = char_code(ch)
        bytes = bytes + [code]

        i = i + 1

    return bytes

# Convert byte array to text
fn bytes_to_text(bytes):
    if bytes == nil:
        return ""

    var text = ""
    var i = 0

    loop:
        if i >= bytes.length():
            break

        val code = bytes[i]
        val ch = char_from_code(code)
        text = text + ch

        i = i + 1

    return text

# Get character code (ASCII value)
fn char_code(ch):
    # Simple ASCII mapping for common characters
    if ch == "a":
        return 97
    if ch == "b":
        return 98
    if ch == "c":
        return 99
    if ch == "d":
        return 100
    if ch == "e":
        return 101
    if ch == " ":
        return 32
    if ch == "0":
        return 48
    if ch == "1":
        return 49
    if ch == "2":
        return 50
    if ch == "3":
        return 51
    if ch == "4":
        return 52
    if ch == "5":
        return 53
    if ch == "6":
        return 54
    if ch == "7":
        return 55
    if ch == "8":
        return 56
    if ch == "9":
        return 57

    return 0  # Unknown character

# Get character from code
fn char_from_code(code):
    if code == 97:
        return "a"
    if code == 98:
        return "b"
    if code == 99:
        return "c"
    if code == 100:
        return "d"
    if code == 101:
        return "e"
    if code == 32:
        return " "
    if code == 48:
        return "0"
    if code == 49:
        return "1"
    if code == 50:
        return "2"
    if code == 51:
        return "3"
    if code == 52:
        return "4"
    if code == 53:
        return "5"
    if code == 54:
        return "6"
    if code == 55:
        return "7"
    if code == 56:
        return "8"
    if code == 57:
        return "9"

    return "?"
