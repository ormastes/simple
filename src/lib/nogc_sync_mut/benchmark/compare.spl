# Benchmark Comparison and Regression Detection

# ============================================================================
# Comparison
# ============================================================================

fn compare_benchmarks(result1, result2):
    """Compare two benchmark results.

    Returns: (name1, name2, speedup, faster_name, significant)

    Example:
        val comp = compare_benchmarks(result1, result2)
        val (_, _, speedup, faster, sig) = comp
        print "Speedup: {speedup}x, Significant: {sig}"
    """
    val (name1, _, stats1, _) = result1
    val (name2, _, stats2, _) = result2

    val mean1 = get_stat_mean(stats1)
    val mean2 = get_stat_mean(stats2)

    val speedup = speedup_ratio(mean1, mean2)

    var faster_name = name1
    if mean2 < mean1:
        faster_name = name2

    val significant = is_significant_difference(mean1, mean2)

    (name1, name2, speedup, faster_name, significant)

fn speedup_ratio(baseline: i64, new_val: i64):
    """Calculate speedup ratio.

    Returns: Speedup as percentage (e.g., 150 for 1.5x speedup)

    Example:
        speedup_ratio(100, 50)  # 200 (2x faster)
    """
    if new_val == 0:
        return 0

    (baseline * 100) / new_val

fn is_significant_difference(val1: i64, val2: i64):
    """Check if difference is statistically significant.

    Uses 10% threshold.

    Example:
        is_significant_difference(100, 115)  # true (>10% diff)
    """
    var larger = val1
    var smaller = val2

    if val2 > val1:
        larger = val2
        smaller = val1

    if larger == 0:
        return false

    val diff_percent = ((larger - smaller) * 100) / larger
    diff_percent > 10  # 10% threshold

fn compare_to_baseline(baseline_result, current_result):
    """Compare current result to baseline.

    Returns: Comparison tuple

    Example:
        val comp = compare_to_baseline(baseline, current)
    """
    compare_benchmarks(baseline_result, current_result)

# ============================================================================
# Regression Detection
# ============================================================================

fn detect_regression(baseline_result, current_result, threshold: i64):
    """Detect performance regression.

    Args:
        baseline_result: Baseline benchmark result
        current_result: Current benchmark result
        threshold: Regression threshold percentage (e.g., 5 for 5%)

    Returns: true if regression detected (current slower by threshold%)

    Example:
        val regressed = detect_regression(baseline, current, 5)
        if regressed:
            print "Performance regression detected!"
    """
    val (_, _, baseline_stats, _) = baseline_result
    val (_, _, current_stats, _) = current_result

    val baseline_mean = get_stat_mean(baseline_stats)
    val current_mean = get_stat_mean(current_stats)

    # Regression if current is slower by threshold%
    if baseline_mean == 0:
        return false

    val percent_change = ((current_mean - baseline_mean) * 100) / baseline_mean
    percent_change > threshold

fn regression_percentage(baseline_result, current_result):
    """Calculate regression percentage.

    Returns: Percentage change (positive = regression, negative = improvement)

    Example:
        val change = regression_percentage(baseline, current)
        # 15 means 15% slower (regression)
        # -10 means 10% faster (improvement)
    """
    val (_, _, baseline_stats, _) = baseline_result
    val (_, _, current_stats, _) = current_result

    val baseline_mean = get_stat_mean(baseline_stats)
    val current_mean = get_stat_mean(current_stats)

    if baseline_mean == 0:
        return 0

    ((current_mean - baseline_mean) * 100) / baseline_mean

fn is_performance_improvement(baseline_result, current_result, threshold: i64):
    """Check if current is faster than baseline by threshold%.

    Example:
        val improved = is_performance_improvement(baseline, current, 10)
    """
    val change = regression_percentage(baseline_result, current_result)
    change < (0 - threshold)

