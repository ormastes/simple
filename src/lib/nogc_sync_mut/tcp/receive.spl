# TCP Receive Operations
#
# Functions for receiving data from TCP connections

import "types" as Types

# Receive data (read from receive buffer)
fn tcp_receive(conn: (text, i64, i64, text, text, list, i64), max_bytes: i64) -> (text, (text, i64, i64, text, text, list, i64)):
    val state = Types.tcp_connection_get_state(conn)
    val can_recv = Types.tcp_state_can_receive(state)
    if can_recv:
        val buffer = Types.tcp_connection_get_recv_buffer(conn)
        val buf_len = buffer.len()
        if buf_len > max_bytes:
            val data = buffer.substring(0, max_bytes)
            val remaining = buffer.substring(max_bytes, buf_len)
            val new_conn = Types.tcp_connection_set_recv_buffer(conn, remaining)
            (data, new_conn)
        else:
            val empty = ""
            val new_conn = Types.tcp_connection_set_recv_buffer(conn, empty)
            (buffer, new_conn)
    else:
        val empty = ""
        (empty, conn)

# Add data to receive buffer (simulates incoming data)
fn tcp_buffer_receive(conn: (text, i64, i64, text, text, list, i64), data: text) -> (text, i64, i64, text, text, list, i64):
    val current_buf = Types.tcp_connection_get_recv_buffer(conn)
    val new_buf = current_buf + data
    val new_len = new_buf.len()
    val exceeds = new_len > Types.TCP_MAX_BUFFER_SIZE
    if exceeds:
        conn
    else:
        Types.tcp_connection_set_recv_buffer(conn, new_buf)

# Get receive buffer size
fn tcp_get_recv_buffer_size(conn: (text, i64, i64, text, text, list, i64)) -> i64:
    val buffer = Types.tcp_connection_get_recv_buffer(conn)
    buffer.len()

# Check if receive buffer is empty
fn tcp_recv_buffer_is_empty(conn: (text, i64, i64, text, text, list, i64)) -> bool:
    val size = tcp_get_recv_buffer_size(conn)
    size == 0

# Check if connection is readable
fn tcp_connection_is_readable(conn: (text, i64, i64, text, text, list, i64)) -> bool:
    val state = Types.tcp_connection_get_state(conn)
    val can_recv = Types.tcp_state_can_receive(state)
    if can_recv:
        val buf_size = tcp_get_recv_buffer_size(conn)
        buf_size > 0
    else:
        false

export tcp_receive
export tcp_buffer_receive
export tcp_get_recv_buffer_size
export tcp_recv_buffer_is_empty
export tcp_connection_is_readable
