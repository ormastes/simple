# LSP Utilities - Shared helpers for LSP handlers
# Used by completion, hover, definition, references handlers

export node_at_position, for_each_query_match

fn node_at_position(tree: Tree, position: Position) -> Node?:
    """Find node at exact position in tree.

    Args:
        tree - Syntax tree
        position - Position to search

    Returns:
        Deepest node containing the position, or nil
    """
    # Helper to check if position is within node range
    fn position_in_range(pos: Position, start_row: i64, start_col: i64, end_row: i64, end_col: i64) -> bool:
        # Position before start
        if pos.line < start_row:
            return false
        if pos.line == start_row and pos.character < start_col:
            return false

        # Position after end
        if pos.line > end_row:
            return false
        if pos.line == end_row and pos.character > end_col:
            return false

        true

    # Recursive search for deepest node at position
    fn search_recursive(node: Node) -> Node?:
        val start_point = node.start_point()
        val end_point = node.end_point()

        # Check if position is within this node
        val in_range = position_in_range(
            position,
            start_point.row,
            start_point.column,
            end_point.row,
            end_point.column
        )

        if in_range:
            # Search children first (prefer more specific/leaf nodes)
            var child_count = node.child_count()
            var i = 0
            while i < child_count:
                val child = node.child(i)
                val result = search_recursive(child)
                if result.?:
                    return result
                i = i + 1

            # No child matched - return this node
            return Some(node)

        nil

    search_recursive(tree.root_node())

fn for_each_query_match(cursor: QueryCursor, process: fn(any)):
    """Iterate through all query matches and call process function for each.

    Args:
        cursor - Query cursor to iterate
        process - Function to call for each match (accepts any type)

    Note: Using 'any' type since Match type is not yet defined in treesitter_types.spl
    """
    while true:
        val match_opt = cursor.next_match()
        if not match_opt.?:
            break
        val match_value = match_opt.unwrap()
        process(match_value)
