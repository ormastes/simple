# Feature Definitions
# All debug capabilities expressed as FeatureId values.
# Each backend registers handlers for features at a numeric rank.

# Debug capability identifier
enum FeatureId:
    # Execution control
    Halt
    Resume
    SingleStep
    StepOver
    Reset

    # Memory
    ReadMemory
    WriteMemory

    # Registers
    ReadRegister
    WriteRegister
    ReadAllRegisters

    # Breakpoints
    SetBreakpoint
    ClearBreakpoint
    SetWatchpoint
    ConditionalBreakpoint
    FunctionBreakpoint
    EnableBreakpoint
    DisableBreakpoint
    ListBreakpoints

    # Inspection
    ReadLocals
    ReadGlobals
    ReadArguments
    EvaluateExpression
    ReadStackTrace

    # Frame navigation
    SelectFrame
    FrameLocals
    FrameArguments
    SetVariable

    # Ptrace (native process tracing)
    PtraceAttach
    PtraceDetach
    PtraceContinue
    PtraceSingleStep
    PtraceReadMemory
    PtraceWriteMemory

    # DWARF (debug info)
    DwarfAddrToSource
    DwarfSourceToAddr
    DwarfFunctionName

    # System operations (used by emulation)
    ProfileSample
    FlashProgram
    SystemReset

    # Trace32-unique operations
    TraceCapture
    CoverageCollect

    fn to_string() -> text:
        match self:
            Halt: "Halt"
            Resume: "Resume"
            SingleStep: "SingleStep"
            StepOver: "StepOver"
            Reset: "Reset"
            ReadMemory: "ReadMemory"
            WriteMemory: "WriteMemory"
            ReadRegister: "ReadRegister"
            WriteRegister: "WriteRegister"
            ReadAllRegisters: "ReadAllRegisters"
            SetBreakpoint: "SetBreakpoint"
            ClearBreakpoint: "ClearBreakpoint"
            SetWatchpoint: "SetWatchpoint"
            ConditionalBreakpoint: "ConditionalBreakpoint"
            FunctionBreakpoint: "FunctionBreakpoint"
            EnableBreakpoint: "EnableBreakpoint"
            DisableBreakpoint: "DisableBreakpoint"
            ListBreakpoints: "ListBreakpoints"
            ReadLocals: "ReadLocals"
            ReadGlobals: "ReadGlobals"
            ReadArguments: "ReadArguments"
            EvaluateExpression: "EvaluateExpression"
            ReadStackTrace: "ReadStackTrace"
            SelectFrame: "SelectFrame"
            FrameLocals: "FrameLocals"
            FrameArguments: "FrameArguments"
            SetVariable: "SetVariable"
            PtraceAttach: "PtraceAttach"
            PtraceDetach: "PtraceDetach"
            PtraceContinue: "PtraceContinue"
            PtraceSingleStep: "PtraceSingleStep"
            PtraceReadMemory: "PtraceReadMemory"
            PtraceWriteMemory: "PtraceWriteMemory"
            DwarfAddrToSource: "DwarfAddrToSource"
            DwarfSourceToAddr: "DwarfSourceToAddr"
            DwarfFunctionName: "DwarfFunctionName"
            ProfileSample: "ProfileSample"
            FlashProgram: "FlashProgram"
            SystemReset: "SystemReset"
            TraceCapture: "TraceCapture"
            CoverageCollect: "CoverageCollect"

    fn eq(other: FeatureId) -> bool:
        self.to_string() == other.to_string()

# Rank constants for feature handler priority
# Lower rank = preferred handler
class FeatureRank:
    # Rank 0: Native support (zero overhead, direct protocol command)
    static fn NATIVE() -> i32:
        0

    # Rank 1: Bridge translation (minor overhead, translated command)
    static fn BRIDGE() -> i32:
        1

    # Rank 2: Secondary native (alternative protocol, higher overhead)
    static fn SECONDARY() -> i32:
        2

    # Rank 3: External tool (OpenOCD, etc.)
    static fn EXTERNAL() -> i32:
        3

    # Rank 4: Emulated (synthesized from lower-level operations)
    static fn EMULATED() -> i32:
        4

# Feature rank table: default rankings per backend
#
# | Feature              | GDB | Ptrace | DWARF | Emulated | T32 |
# |----------------------|-----|--------|-------|----------|------|
# | Halt                 |  0  |   -    |   -   |    -     |
# | Resume               |  0  |   -    |   -   |    -     |
# | SingleStep           |  0  |   -    |   -   |    -     |
# | ReadMemory           |  0  |   -    |   -   |    -     |
# | WriteMemory          |  0  |   -    |   -   |    -     |
# | ReadRegister         |  0  |   -    |   -   |    -     |
# | ReadLocals           |  0  |   -    |   -   |    4     |
# | ReadArguments        |  0  |   -    |   -   |    4     |
# | ReadStackTrace       |  0  |   -    |   -   |    4     |
# | EvaluateExpression   |  0  |   -    |   -   |    -     |
# | SetBreakpoint        |  0  |   -    |   -   |    -     |
# | ConditionalBreakpoint|  0  |   -    |   -   |    -     |
# | FunctionBreakpoint   |  0  |   -    |   -   |    -     |
# | EnableBreakpoint     |  0  |   -    |   -   |    -     |
# | DisableBreakpoint    |  0  |   -    |   -   |    -     |
# | ListBreakpoints      |  0  |   -    |   -   |    -     |
# | SelectFrame          |  0  |   -    |   -   |    -     |
# | FrameLocals          |  0  |   -    |   -   |    -     |
# | FrameArguments       |  0  |   -    |   -   |    -     |
# | SetVariable          |  0  |   -    |   -   |    -     |
# | PtraceAttach         |  -  |   0    |   -   |    -     |
# | PtraceDetach         |  -  |   0    |   -   |    -     |
# | PtraceContinue       |  -  |   0    |   -   |    -     |
# | PtraceSingleStep     |  -  |   0    |   -   |    -     |
# | PtraceReadMemory     |  -  |   0    |   -   |    -     |
# | PtraceWriteMemory    |  -  |   0    |   -   |    -     |
# | DwarfAddrToSource    |  -  |   -    |   0   |    -     |
# | DwarfSourceToAddr    |  -  |   -    |   0   |    -     |
# | DwarfFunctionName    |  -  |   -    |   0   |    -     |
# | ProfileSample        |  -  |   -    |   -   |    3     |
# | FlashProgram         |  -  |   -    |   -   |    3     |   0    |
# | SystemReset          |  -  |   -    |   -   |    3     |   0    |
# | TraceCapture         |  -  |   -    |   -   |    4     |   0    |
# | CoverageCollect      |  -  |   -    |   -   |    4     |   0    |
