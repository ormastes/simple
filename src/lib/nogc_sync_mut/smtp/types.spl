# SMTP Response Codes
# RFC 5321 (SMTP)

fn smtp_code_220() -> i64: 220  # Service ready
fn smtp_code_221() -> i64: 221  # Service closing
fn smtp_code_250() -> i64: 250  # OK
fn smtp_code_354() -> i64: 354  # Start mail input
fn smtp_code_421() -> i64: 421  # Service not available
fn smtp_code_450() -> i64: 450  # Mailbox unavailable
fn smtp_code_500() -> i64: 500  # Syntax error
fn smtp_code_501() -> i64: 501  # Syntax error in parameters
fn smtp_code_502() -> i64: 502  # Command not implemented
fn smtp_code_503() -> i64: 503  # Bad sequence of commands
fn smtp_code_550() -> i64: 550  # Mailbox unavailable
fn smtp_code_551() -> i64: 551  # User not local
fn smtp_code_552() -> i64: 552  # Exceeded storage allocation

fn smtp_code_description(code: i64) -> text:
    if code == 220:
        return "Service ready"
    if code == 221:
        return "Service closing transmission channel"
    if code == 250:
        return "Requested mail action okay, completed"
    if code == 354:
        return "Start mail input; end with <CRLF>.<CRLF>"
    if code == 421:
        return "Service not available, closing transmission channel"
    if code == 450:
        return "Requested mail action not taken: mailbox unavailable"
    if code == 500:
        return "Syntax error, command unrecognized"
    if code == 501:
        return "Syntax error in parameters or arguments"
    if code == 502:
        return "Command not implemented"
    if code == 503:
        return "Bad sequence of commands"
    if code == 550:
        return "Requested action not taken: mailbox unavailable"
    if code == 551:
        return "User not local; please try forward path"
    if code == 552:
        return "Requested mail action aborted: exceeded storage allocation"
    return "Unknown response code"

fn smtp_is_success_code(code: i64) -> bool:
    var is_2xx = code >= 200
    var less_than_300 = code < 300
    return is_2xx and less_than_300

fn smtp_is_error_code(code: i64) -> bool:
    var is_4xx = code >= 400
    var less_than_600 = code < 600
    return is_4xx and less_than_600

fn smtp_code_502_not_implemented() -> i64:
    return 502

# SMTP Session State Management

fn smtp_session_new() -> text:
    return "INITIAL"

fn smtp_session_after_helo() -> text:
    return "HELO"

fn smtp_session_after_mail() -> text:
    return "MAIL"

fn smtp_session_after_rcpt() -> text:
    return "RCPT"

fn smtp_session_after_data() -> text:
    return "DATA"

fn smtp_can_mail(state: text) -> bool:
    return state == "HELO"

fn smtp_can_rcpt(state: text) -> bool:
    var after_mail = state == "MAIL"
    var after_rcpt = state == "RCPT"
    return after_mail or after_rcpt

fn smtp_can_data(state: text) -> bool:
    return state == "RCPT"

# Response Parsing

fn response_parse_code(response: text) -> i64:
    if response.length() < 3:
        return 0

    var code_str = response.substring(0, 3)
    return code_str.to_int()

fn response_parse_message(response: text) -> text:
    if response.length() < 4:
        return ""
    var len = response.length()
    return response.substring(4, len)

fn response_is_multiline(response: text) -> bool:
    if response.length() < 4:
        return false
    var fourth_char = response.char_at(3)
    return fourth_char == "-"
