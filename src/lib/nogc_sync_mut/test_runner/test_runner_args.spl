# Test Runner Argument Parsing
#
# Parses command-line arguments and creates TestOptions.

use test_runner_types.*

# =========================================================================
# Mode String Parsing
# =========================================================================

fn parse_mode_str(m: text) -> TestExecutionMode:
    if m == "native" or m == "binary":
        return TestExecutionMode.Native
    if m == "smf" or m == "loader":
        return TestExecutionMode.Smf
    # Support composite platform specs like "baremetal(riscv32)",
    # "interpreter(baremetal(riscv32))", "remote(arm32)", etc.
    if m.contains("baremetal") or m.contains("remote") or m.contains("container"):
        # Normalize: if no base runtime prefix, add "interpreter("
        if not m.starts_with("interpreter(") and not m.starts_with("smf(") and not m.starts_with("native("):
            return TestExecutionMode.Composite("interpreter(" + m + ")")
        return TestExecutionMode.Composite(m)
    TestExecutionMode.Interpreter

# =========================================================================
# Argument Parsing
# =========================================================================

fn parse_test_args(args: [text]) -> TestOptions:
    var path = ""
    var level = TestLevel.All
    var tag = ""
    var fail_fast = false
    var mode = TestExecutionMode.Interpreter
    var timeout = 120
    var list = false
    var list_ignored = false
    var only_slow = false
    var only_skipped = false
    var show_tags = false
    var gc_log = false
    var gc_off = false
    var seed = 0
    var has_seed = false
    var safe_mode = false
    var force_rebuild = false
    var keep_artifacts = false
    var run_all = false
    var format = OutputFormat.Default
    var list_skip_features = false
    var planned_only = false
    var no_limits = false
    var sdoctest = false
    var sdoctest_env = ""
    var sdoctest_force = false
    var no_db = false
    var verbose = false
    var coverage = false
    var execution_mode = ""
    var container_sequential = false
    var self_protect = false  # Disabled by default (shell calls slow down tests)
    var resume = false
    var cpu_threshold = 80.0  # Stop at 80% CPU to leave more headroom (was 90%)
    var mem_threshold = 80.0  # Stop at 80% RAM to prevent OOM killer (was 90%)
    var parallel = false  # ALWAYS false - parallel execution permanently disabled
    var max_workers = 0
    var parallel_timeout = 300
    var closure_warnings = false
    var ci_mode = false
    # Advanced testing modes
    var fuzz_mode = false
    var fuzz_time_secs = 60
    var fuzz_corpus_dir = "test/fuzz/corpus"
    var fuzz_differential = false
    var fuzz_shrink = true
    var chaos_mode = false
    var chaos_trials = 100
    var chaos_fault_rate = 10
    var deploy_mode = false
    var deploy_platform = ""
    var deploy_upgrade = false
    var security_mode = false
    var security_scan = false
    var security_supply_chain = false
    var spl_doctest = false
    var max_mem_gb = 16
    var mem_check = false
    var fork_mode = false

    var i = 0
    while i < args.len():
        val arg = args[i]
        if arg == "--unit":
            level = TestLevel.Unit
        elif arg == "--integration":
            level = TestLevel.Integration
        elif arg == "--system":
            level = TestLevel.System
        elif arg == "--fail-fast":
            fail_fast = true
        elif arg == "--list":
            list = true
        elif arg == "--list-ignored":
            list = true
            list_ignored = true
        elif arg == "--only-slow":
            only_slow = true
        elif arg == "--only-skipped":
            only_skipped = true
        elif arg == "--show-tags":
            show_tags = true
        elif arg == "--gc-log":
            gc_log = true
        elif arg == "--gc=off" or arg == "--gc=OFF":
            gc_off = true
        elif arg == "--safe-mode" or arg == "--safe":
            safe_mode = true
        elif arg == "--force-rebuild":
            force_rebuild = true
        elif arg == "--keep-artifacts":
            keep_artifacts = true
        elif arg == "--all":
            run_all = true
        elif arg == "--list-skip-features" or arg == "--skip-features":
            list_skip_features = true
            only_skipped = true
            list = true
        elif arg == "--planned-only" or arg == "--pending":
            planned_only = true
        elif arg == "--no-limits":
            no_limits = true
        elif arg == "--max-mem":
            i = i + 1
            if i < args.len():
                max_mem_gb = to_int(args[i])
        elif arg.starts_with("--max-mem="):
            max_mem_gb = to_int(arg[10:])
        elif arg == "--no-db":
            no_db = true
        elif arg == "--verbose" or arg == "-v":
            verbose = true
        elif arg == "--quick" or arg == "-q":
            no_db = true
        elif arg == "--coverage":
            coverage = true
        elif arg == "--execution-mode":
            i = i + 1
            if i < args.len():
                execution_mode = args[i]
        elif arg.starts_with("--execution-mode="):
            execution_mode = arg[17:]
        elif arg == "--container-sequential" or arg == "--container-seq":
            container_sequential = true
            execution_mode = "container-seq"
        elif arg == "--self-protect":
            self_protect = true
        elif arg == "--no-self-protect":
            self_protect = false
        elif arg == "--resume":
            resume = true
        elif arg == "--cpu-threshold":
            i = i + 1
            if i < args.len():
                cpu_threshold = parse_f64(args[i])
        elif arg.starts_with("--cpu-threshold="):
            cpu_threshold = parse_f64(arg[16:])
        elif arg == "--mem-threshold":
            i = i + 1
            if i < args.len():
                mem_threshold = parse_f64(args[i])
        elif arg.starts_with("--mem-threshold="):
            mem_threshold = parse_f64(arg[16:])
        elif arg == "--parallel":
            # Parallel execution disabled - always run one by one
            parallel = false
        elif arg == "--max-workers":
            i = i + 1
            if i < args.len():
                max_workers = to_int(args[i])
        elif arg.starts_with("--max-workers="):
            max_workers = to_int(arg[14:])
        elif arg == "--parallel-timeout":
            i = i + 1
            if i < args.len():
                parallel_timeout = to_int(args[i])
        elif arg.starts_with("--parallel-timeout="):
            parallel_timeout = to_int(arg[19:])
        elif arg == "--closure-warnings":
            closure_warnings = true
        elif arg == "--ci":
            ci_mode = true
            run_all = true
            fail_fast = false
        elif arg == "--fuzz":
            fuzz_mode = true
        elif arg == "--fuzz-time":
            i = i + 1
            if i < args.len():
                fuzz_time_secs = to_int(args[i])
        elif arg.starts_with("--fuzz-time="):
            fuzz_time_secs = to_int(arg[12:])
        elif arg == "--fuzz-corpus":
            i = i + 1
            if i < args.len():
                fuzz_corpus_dir = args[i]
        elif arg.starts_with("--fuzz-corpus="):
            fuzz_corpus_dir = arg[14:]
        elif arg == "--fuzz-differential":
            fuzz_differential = true
        elif arg == "--no-shrink":
            fuzz_shrink = false
        elif arg == "--chaos":
            chaos_mode = true
        elif arg == "--chaos-trials":
            i = i + 1
            if i < args.len():
                chaos_trials = to_int(args[i])
        elif arg.starts_with("--chaos-trials="):
            chaos_trials = to_int(arg[15:])
        elif arg == "--chaos-fault-rate":
            i = i + 1
            if i < args.len():
                chaos_fault_rate = to_int(args[i])
        elif arg.starts_with("--chaos-fault-rate="):
            chaos_fault_rate = to_int(arg[19:])
        elif arg == "--deploy":
            deploy_mode = true
        elif arg == "--deploy-platform":
            i = i + 1
            if i < args.len():
                deploy_platform = args[i]
        elif arg.starts_with("--deploy-platform="):
            deploy_platform = arg[18:]
        elif arg == "--deploy-upgrade":
            deploy_upgrade = true
        elif arg == "--security":
            security_mode = true
        elif arg == "--security-scan":
            security_scan = true
        elif arg == "--security-supply-chain":
            security_supply_chain = true
        elif arg == "--spl-doctest":
            spl_doctest = true
        elif arg == "--mem-check":
            mem_check = true
        elif arg == "--fork-mode" or arg == "--fork":
            fork_mode = true
        elif arg == "--sdoctest":
            sdoctest = true
        elif arg == "--sdoctest-force":
            sdoctest_force = true
        elif arg.starts_with("--sdoctest-env="):
            sdoctest_env = arg[15:]
        elif arg == "--sdoctest-env":
            i = i + 1
            if i < args.len():
                sdoctest_env = args[i]
        elif arg == "--tag":
            i = i + 1
            if i < args.len():
                tag = args[i]
        elif arg == "--doc":
            format = OutputFormat.Doc
        elif arg == "--format":
            i = i + 1
            if i < args.len():
                if args[i] == "doc":
                    format = OutputFormat.Doc
        elif arg == "--mode":
            i = i + 1
            if i < args.len():
                mode = parse_mode_str(args[i])
        elif arg.starts_with("--mode="):
            val m = arg.replace("--mode=", "")
            mode = parse_mode_str(m)
        elif arg == "--timeout":
            i = i + 1
            if i < args.len():
                timeout = to_int(args[i])
        elif arg == "--seed":
            i = i + 1
            if i < args.len():
                seed = to_int(args[i])
                has_seed = true
        elif not arg.starts_with("-") and path == "":
            path = arg
        i = i + 1

    if path == "":
        path = "test/"

    if no_limits:
        max_mem_gb = 0

    TestOptions(
        path: path,
        level: level,
        tag: tag,
        fail_fast: fail_fast,
        mode: mode,
        timeout: timeout,
        list: list,
        list_ignored: list_ignored,
        only_slow: only_slow,
        only_skipped: only_skipped,
        show_tags: show_tags,
        gc_log: gc_log,
        gc_off: gc_off,
        seed: seed,
        has_seed: has_seed,
        safe_mode: safe_mode,
        force_rebuild: force_rebuild,
        keep_artifacts: keep_artifacts,
        run_all: run_all,
        format: format,
        list_skip_features: list_skip_features,
        planned_only: planned_only,
        no_limits: no_limits,
        sdoctest: sdoctest,
        sdoctest_env: sdoctest_env,
        sdoctest_force: sdoctest_force,
        no_db: no_db,
        verbose: verbose,
        coverage: coverage,
        execution_mode: execution_mode,
        container_sequential: container_sequential,
        self_protect: self_protect,
        resume: resume,
        cpu_threshold: cpu_threshold,
        mem_threshold: mem_threshold,
        parallel: parallel,
        max_workers: max_workers,
        parallel_timeout: parallel_timeout,
        closure_warnings: closure_warnings,
        ci_mode: ci_mode,
        fuzz_mode: fuzz_mode,
        fuzz_time_secs: fuzz_time_secs,
        fuzz_corpus_dir: fuzz_corpus_dir,
        fuzz_differential: fuzz_differential,
        fuzz_shrink: fuzz_shrink,
        chaos_mode: chaos_mode,
        chaos_trials: chaos_trials,
        chaos_fault_rate: chaos_fault_rate,
        deploy_mode: deploy_mode,
        deploy_platform: deploy_platform,
        deploy_upgrade: deploy_upgrade,
        security_mode: security_mode,
        security_scan: security_scan,
        security_supply_chain: security_supply_chain,
        spl_doctest: spl_doctest,
        max_mem_gb: max_mem_gb,
        mem_check: mem_check,
        fork_mode: fork_mode
    )

# =========================================================================
# Helper Functions
# =========================================================================

fn parse_f64(s: text) -> f64:
    """Parse float from string (simple implementation)"""
    var result = 0.0
    var decimal_part = 0.0
    var decimal_divisor = 1.0
    var seen_dot = false

    for i in s.len():
        val ch = s[i:i + 1]

        if ch == ".":
            seen_dot = true
        else:
            val is_digit = ch >= "0" and ch <= "9"
            if is_digit:
                var digit = 0
                if ch == "0": digit = 0
                if ch == "1": digit = 1
                if ch == "2": digit = 2
                if ch == "3": digit = 3
                if ch == "4": digit = 4
                if ch == "5": digit = 5
                if ch == "6": digit = 6
                if ch == "7": digit = 7
                if ch == "8": digit = 8
                if ch == "9": digit = 9

                if seen_dot:
                    decimal_divisor = decimal_divisor * 10.0
                    decimal_part = decimal_part + (digit * 1.0)
                else:
                    result = result * 10.0 + (digit * 1.0)

    if seen_dot:
        result = result + (decimal_part / decimal_divisor)

    result

# =========================================================================
# Exports
# =========================================================================

export parse_mode_str
export parse_test_args
