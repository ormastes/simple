# std.glob - Glob pattern matching utilities
# Pure Simple implementation
# Supports: *, ?, [abc], [a-z], [!abc]

fn glob_match(path: text, pattern: text) -> bool:
    _glob_at(path, 0, pattern, 0)

fn _glob_at(s: text, si: i64, p: text, pi: i64) -> bool:
    if pi >= p.len():
        return si >= s.len()

    val pc = p[pi:pi + 1]

    if pc == "*":
        # Star: try matching 0..N characters from current position
        for i in si..s.len() + 1:
            if _glob_at(s, i, p, pi + 1):
                return true
        return false

    if si >= s.len():
        return false

    if pc == "?":
        return _glob_at(s, si + 1, p, pi + 1)

    if pc == "[":
        # Character class: find first closing ]
        var close = -1
        for ci in (pi + 1)..p.len():
            if close == -1 and p[ci:ci + 1] == "]":
                close = ci
        if close > pi + 1:
            val class_str = p[pi + 1:close]
            if _char_in_class(s[si:si + 1], class_str):
                return _glob_at(s, si + 1, p, close + 1)
        return false

    # Literal match
    if s[si:si + 1] == pc:
        return _glob_at(s, si + 1, p, pi + 1)

    false

fn _char_in_class(ch: text, class_str: text) -> bool:
    # Match character against class: abc, a-z, !abc
    var negate = false
    var check_start = 0
    if class_str.len() > 0 and class_str[0:1] == "!":
        negate = true
        check_start = 1

    var found = false
    var skip_count = 0
    for i in check_start..class_str.len():
        if skip_count > 0:
            skip_count = skip_count - 1
            continue
        val c = class_str[i:i + 1]
        val has_dash = i + 1 < class_str.len() and class_str[i + 1:i + 2] == "-"
        val has_end = i + 2 < class_str.len()
        if has_dash and has_end:
            val range_end = class_str[i + 2:i + 3]
            if ch >= c and ch <= range_end:
                found = true
            skip_count = 2
        else:
            if c == ch:
                found = true

    if negate: not found else: found

export glob_match
