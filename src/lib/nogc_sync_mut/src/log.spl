# Log Module - Unified logging with levels 0-10
#
# Log levels:
#   0 = Off      - No logging
#   1 = Fatal    - Unrecoverable errors
#   2 = Error    - Recoverable errors
#   3 = Warn     - Potential issues
#   4 = Info     - High-level events
#   5 = Debug    - Detailed events
#   6 = Trace    - Very detailed
#   7 = Verbose  - Every instruction
#   8-9 = Reserved
#   10 = All     - Everything
#
# Uses simple-hir-core LogLevel for shared type definitions.

use app.io.{log_emit, log_get_global_level, log_set_global_level}
use app.io.{log_get_scope_level, log_set_scope_level}
use app.io.{log_is_enabled, log_clear_scope_levels}

# Log level constants (matches hir-core LogLevel)
val LOG_OFF = 0
val LOG_FATAL = 1
val LOG_ERROR = 2
val LOG_WARN = 3
val LOG_INFO = 4
val LOG_DEBUG = 5
val LOG_TRACE = 6
val LOG_VERBOSE = 7
val LOG_ALL = 10

# ============================================================================
# Log Level Enum
# ============================================================================

pub enum LogLevel:
    Off
    Fatal
    Error
    Warn
    Info
    Debug
    Trace
    Verbose
    All

    fn to_i64() -> i64:
        match self:
            case Off: 0
            case Fatal: 1
            case Error: 2
            case Warn: 3
            case Info: 4
            case Debug: 5
            case Trace: 6
            case Verbose: 7
            case All: 10

    static fn from_i64(level: i64) -> LogLevel:
        match level:
            case 0: LogLevel.Off
            case 1: LogLevel.Fatal
            case 2: LogLevel.Error
            case 3: LogLevel.Warn
            case 4: LogLevel.Info
            case 5: LogLevel.Debug
            case 6: LogLevel.Trace
            case 7: LogLevel.Verbose
            case 10: LogLevel.All
            case _: LogLevel.Info

    pub fn to_string() -> text:
        match self:
            case Off: "off"
            case Fatal: "fatal"
            case Error: "error"
            case Warn: "warn"
            case Info: "info"
            case Debug: "debug"
            case Trace: "trace"
            case Verbose: "verbose"
            case All: "all"

# ============================================================================
# Configuration
# ============================================================================

pub fn set_level(level: LogLevel):
    """Set global log level."""
    log_set_global_level(level.to_i64())

pub fn set_scope_level(scope: text, level: LogLevel):
    """Set log level for specific scope."""
    log_set_scope_level(scope.ptr(), scope.len(), level.to_i64())

pub fn get_level(scope: text) -> LogLevel:
    """Get effective log level for scope."""
    LogLevel.from_i64(log_get_scope_level(scope.ptr(), scope.len()))

pub fn get_global_level() -> LogLevel:
    """Get global log level."""
    LogLevel.from_i64(log_get_global_level())

pub fn is_enabled(level: LogLevel, scope: text) -> bool:
    """Check if logging is enabled at level for scope."""
    log_is_enabled(level.to_i64(), scope.ptr(), scope.len()) != 0

pub fn clear_scopes():
    """Clear all scope-specific log levels."""
    log_clear_scope_levels()

# ============================================================================
# Logging Functions
# ============================================================================

fn emit(level: i64, scope: text, msg: text):
    """Emit a log message via centralized wrapper."""
    log_emit(level, scope.ptr(), scope.len(), msg.ptr(), msg.len())

pub fn fatal(scope: text, msg: text):
    """Log fatal error (level 1)."""
    emit(LOG_FATAL, scope, msg)

pub fn error(scope: text, msg: text):
    """Log error (level 2)."""
    emit(LOG_ERROR, scope, msg)

pub fn warn(scope: text, msg: text):
    """Log warning (level 3)."""
    emit(LOG_WARN, scope, msg)

pub fn info(scope: text, msg: text):
    """Log info (level 4)."""
    emit(LOG_INFO, scope, msg)

pub fn debug(scope: text, msg: text):
    """Log debug (level 5)."""
    emit(LOG_DEBUG, scope, msg)

pub fn trace(scope: text, msg: text):
    """Log trace (level 6)."""
    emit(LOG_TRACE, scope, msg)

pub fn verbose(scope: text, msg: text):
    """Log verbose (level 7)."""
    emit(LOG_VERBOSE, scope, msg)

# ============================================================================
# Convenience Functions (default scope)
# ============================================================================

pub fn log_fatal(msg: text):
    """Log fatal with default scope."""
    fatal("app", msg)

pub fn log_error(msg: text):
    """Log error with default scope."""
    error("app", msg)

pub fn log_warn(msg: text):
    """Log warning with default scope."""
    warn("app", msg)

pub fn log_info(msg: text):
    """Log info with default scope."""
    info("app", msg)

pub fn log_debug(msg: text):
    """Log debug with default scope."""
    debug("app", msg)

pub fn log_trace(msg: text):
    """Log trace with default scope."""
    trace("app", msg)

pub fn log_verbose(msg: text):
    """Log verbose with default scope."""
    verbose("app", msg)

# ============================================================================
# Level Names
# ============================================================================

pub fn level_name(level: LogLevel) -> text:
    """Get human-readable name for log level."""
    level.to_string()

pub fn parse_level(name: text) -> LogLevel:
    """Parse log level from name."""
    match name.lower():
        case "off": LogLevel.Off
        case "fatal": LogLevel.Fatal
        case "error": LogLevel.Error
        case "warn": LogLevel.Warn
        case "info": LogLevel.Info
        case "debug": LogLevel.Debug
        case "trace": LogLevel.Trace
        case "verbose": LogLevel.Verbose
        case "all": LogLevel.All
        case _: LogLevel.Info  # Default to INFO

# ============================================================================
# Exports
# ============================================================================

export LOG_OFF, LOG_FATAL, LOG_ERROR, LOG_WARN, LOG_INFO
export LOG_DEBUG, LOG_TRACE, LOG_VERBOSE, LOG_ALL
export LogLevel
export set_level, set_scope_level, get_level, get_global_level
export is_enabled, clear_scopes
export fatal, error, warn, info, debug, trace, verbose
export log_fatal, log_error, log_warn, log_info, log_debug, log_trace, log_verbose
export level_name, parse_level
