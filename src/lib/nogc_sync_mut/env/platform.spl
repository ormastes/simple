# Platform Detection and System Information
#
# Functions for detecting OS, architecture, and retrieving system information.

import std.env.types
import std.env.variables
import std.path

# ============================================================================
# Platform Detection
# ============================================================================

fn detect_os() -> text:
    """Detect operating system.

    Returns: "linux", "macos", "windows", "freebsd", "openbsd", "netbsd", or "unknown"

    Example:
        detect_os()  # "linux"
    """
    # Check OS environment variable for Windows
    val os_env = variables.env_get("OS")
    if os_env != "":
        if os_env.lower().contains("windows"):
            return "windows"

    # Try uname for Unix-like systems
    val (stdout, stderr, code) = types.rt_process_run("/bin/sh", ["-c", "uname -s"])
    if code == 0:
        val os_name = stdout.trim()
        if os_name == "Linux":
            return "linux"
        elif os_name == "Darwin":
            return "macos"
        elif os_name == "FreeBSD":
            return "freebsd"
        elif os_name == "OpenBSD":
            return "openbsd"
        elif os_name == "NetBSD":
            return "netbsd"

    "unknown"

fn detect_arch() -> text:
    """Detect CPU architecture.

    Returns: "x86_64", "aarch64", "arm", "i686", "riscv64", or "unknown"

    Example:
        detect_arch()  # "x86_64"
    """
    val os = detect_os()

    if os == "windows":
        # Windows: Use PROCESSOR_ARCHITECTURE
        val arch_env = variables.env_get("PROCESSOR_ARCHITECTURE")
        if arch_env == "AMD64" or arch_env == "x64":
            return "x86_64"
        elif arch_env == "ARM64":
            return "aarch64"
        elif arch_env == "x86":
            return "i686"
        else:
            return arch_env.lower()
    else:
        # Unix: Use uname -m
        val (stdout, stderr, code) = types.rt_process_run("/bin/sh", ["-c", "uname -m"])
        if code == 0:
            val arch = stdout.trim()
            if arch == "x86_64" or arch == "amd64":
                return "x86_64"
            elif arch == "aarch64" or arch == "arm64":
                return "aarch64"
            elif arch == "armv7l" or arch == "armv7":
                return "arm"
            elif arch == "i686" or arch == "i386":
                return "i686"
            elif arch == "riscv64":
                return "riscv64"
            else:
                return arch

    "unknown"

fn is_windows() -> bool:
    """Check if running on Windows.

    Example:
        is_windows()  # false on Linux
    """
    detect_os() == "windows"

fn is_unix() -> bool:
    """Check if running on Unix-like system.

    Example:
        is_unix()  # true on Linux/macOS
    """
    val os = detect_os()
    os == "linux" or os == "macos" or os == "freebsd" or os == "openbsd" or os == "netbsd"

fn is_linux() -> bool:
    """Check if running on Linux.

    Example:
        is_linux()  # true on Linux
    """
    detect_os() == "linux"

fn is_macos() -> bool:
    """Check if running on macOS.

    Example:
        is_macos()  # false on Linux
    """
    detect_os() == "macos"

# ============================================================================
# User Information
# ============================================================================

fn get_username() -> text:
    """Get current username.

    Example:
        get_username()  # "alice"
    """
    # Try USER first (Unix)
    var username = variables.env_get("USER")
    if username != "":
        return username

    # Try USERNAME (Windows)
    username = variables.env_get("USERNAME")
    if username != "":
        return username

    # Try whoami command
    val (stdout, stderr, code) = types.rt_process_run("/bin/sh", ["-c", "whoami"])
    if code == 0:
        return stdout.trim()

    "unknown"

fn get_home_dir() -> text:
    """Get user home directory.

    Example:
        get_home_dir()  # "/home/alice"
    """
    val home = types.rt_env_home()
    if home != "" and home != nil:
        return home

    # Fallback to HOME environment variable
    val home_env = variables.env_get("HOME")
    if home_env != "":
        return home_env

    # Windows fallback
    val userprofile = variables.env_get("USERPROFILE")
    if userprofile != "":
        return userprofile

    "."

fn get_config_dir() -> text:
    """Get user configuration directory.

    Returns:
    - Linux: ~/.config
    - macOS: ~/Library/Application Support
    - Windows: %APPDATA%

    Example:
        get_config_dir()  # "/home/alice/.config"
    """
    val os = detect_os()

    if os == "windows":
        val appdata = variables.env_get("APPDATA")
        if appdata != "":
            return appdata
        val home = get_home_dir()
        return path.join2(home, "AppData/Roaming")
    elif os == "macos":
        val home = get_home_dir()
        return path.join2(home, "Library/Application Support")
    else:
        # Linux and other Unix
        val xdg_config = variables.env_get("XDG_CONFIG_HOME")
        if xdg_config != "":
            return xdg_config
        val home = get_home_dir()
        return path.join2(home, ".config")

fn get_cache_dir() -> text:
    """Get user cache directory.

    Returns:
    - Linux: ~/.cache
    - macOS: ~/Library/Caches
    - Windows: %LOCALAPPDATA%

    Example:
        get_cache_dir()  # "/home/alice/.cache"
    """
    val os = detect_os()

    if os == "windows":
        val localappdata = variables.env_get("LOCALAPPDATA")
        if localappdata != "":
            return localappdata
        val home = get_home_dir()
        return path.join2(home, "AppData/Local")
    elif os == "macos":
        val home = get_home_dir()
        return path.join2(home, "Library/Caches")
    else:
        # Linux and other Unix
        val xdg_cache = variables.env_get("XDG_CACHE_HOME")
        if xdg_cache != "":
            return xdg_cache
        val home = get_home_dir()
        return path.join2(home, ".cache")

fn get_data_dir() -> text:
    """Get user data directory.

    Returns:
    - Linux: ~/.local/share
    - macOS: ~/Library/Application Support
    - Windows: %APPDATA%

    Example:
        get_data_dir()  # "/home/alice/.local/share"
    """
    val os = detect_os()

    if os == "windows":
        val appdata = variables.env_get("APPDATA")
        if appdata != "":
            return appdata
        val home = get_home_dir()
        return path.join2(home, "AppData/Roaming")
    elif os == "macos":
        val home = get_home_dir()
        return path.join2(home, "Library/Application Support")
    else:
        # Linux and other Unix
        val xdg_data = variables.env_get("XDG_DATA_HOME")
        if xdg_data != "":
            return xdg_data
        val home = get_home_dir()
        return path.join2(home, ".local/share")

# ============================================================================
# System Information
# ============================================================================

fn get_hostname() -> text:
    """Get system hostname.

    Example:
        get_hostname()  # "my-computer"
    """
    val hostname = types.rt_hostname()
    if hostname != "" and hostname != nil:
        return hostname

    # Fallback to hostname command
    val (stdout, stderr, code) = types.rt_process_run("/bin/sh", ["-c", "hostname"])
    if code == 0:
        return stdout.trim()

    "localhost"

fn get_current_dir() -> text:
    """Get current working directory.

    Example:
        get_current_dir()  # "/home/alice/project"
    """
    val cwd = types.rt_env_cwd()
    if cwd != "" and cwd != nil:
        return cwd

    # Fallback to pwd command
    val (stdout, stderr, code) = types.rt_process_run("/bin/sh", ["-c", "pwd"])
    if code == 0:
        return stdout.trim()

    "."

fn get_temp_dir() -> text:
    """Get temporary directory.

    Example:
        get_temp_dir()  # "/tmp"
    """
    # Try TMPDIR first (Unix)
    var tmp = variables.env_get("TMPDIR")
    if tmp != "":
        return tmp

    # Try TMP (Windows)
    tmp = variables.env_get("TMP")
    if tmp != "":
        return tmp

    # Try TEMP (Windows)
    tmp = variables.env_get("TEMP")
    if tmp != "":
        return tmp

    # Default fallbacks
    val os = detect_os()
    if os == "windows":
        "C:/Windows/Temp"
    else:
        "/tmp"

export detect_os, detect_arch, is_windows, is_unix, is_linux, is_macos
export get_username, get_home_dir, get_config_dir, get_cache_dir, get_data_dir
export get_hostname, get_current_dir, get_temp_dir
