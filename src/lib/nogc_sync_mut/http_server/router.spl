# HTTP Server Router Module
# Route matching and parameter extraction

# =============================================================================
# Route Matching
# =============================================================================

# Match path against route pattern: "/users/:id" matches "/users/123"
fn match_route_pattern(pattern: text, path: text) -> bool:
    var pattern_parts = pattern.split("/")
    var path_parts = path.split("/")

    if pattern_parts.length() != path_parts.length():
        return false

    var i = 0
    var matches = true
    while i < pattern_parts.length():
        var pattern_part = pattern_parts.at(i)
        var path_part = path_parts.at(i)

        var is_param = pattern_part.starts_with(":")
        var is_wildcard = pattern_part == "*"

        if is_param:
            i = i + 1
            continue

        if is_wildcard:
            i = i + 1
            continue

        if pattern_part != path_part:
            matches = false
            break

        i = i + 1

    matches

# Extract route parameters from path: "/users/:id" + "/users/123" -> [("id", "123")]
fn extract_route_params(pattern: text, path: text) -> list:
    var params = []
    var pattern_parts = pattern.split("/")
    var path_parts = path.split("/")

    if pattern_parts.length() != path_parts.length():
        return params

    var i = 0
    while i < pattern_parts.length():
        var pattern_part = pattern_parts.at(i)
        var path_part = path_parts.at(i)

        if pattern_part.starts_with(":"):
            var param_start = 1
            var param_name = pattern_part.substring(param_start, pattern_part.length())
            params.append((param_name, path_part))

        i = i + 1

    params

# Find matching route from route list: [(pattern, method, handler)]
fn find_matching_route(routes: list, method: text, path: text) -> (text, text, text):
    var i = 0
    var found_route = ("", "", "")

    while i < routes.length():
        var route = routes.at(i)
        var pattern = route.at(0)
        var route_method = route.at(1)
        var handler = route.at(2)

        var method_matches = route_method == method
        var path_matches = match_route_pattern(pattern, path)

        if method_matches:
            if path_matches:
                found_route = route
                break

        i = i + 1

    found_route
