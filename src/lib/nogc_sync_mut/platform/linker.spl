# Platform Linker Detection
#
# Self-contained linker detection using process execution.
# Detects the best available system linker (mold > lld > ld).

extern fn rt_process_run(cmd: text, args: [text]) -> (text, text, i64)

enum SystemLinker:
    Mold
    Lld
    Ld
    Unknown

impl SystemLinker:
    fn name() -> text:
        match self:
            case SystemLinker.Mold: "mold"
            case SystemLinker.Lld: "lld"
            case SystemLinker.Ld: "ld"
            case SystemLinker.Unknown: "unknown"

fn command_exists(cmd: text) -> bool:
    val (_, _, code) = rt_process_run("/bin/sh", ["-c", "command -v {cmd} >/dev/null 2>&1"])
    code == 0

fn auto_detect_linker() -> SystemLinker:
    if command_exists("mold"):
        SystemLinker.Mold
    elif command_exists("lld"):
        SystemLinker.Lld
    elif command_exists("ld"):
        SystemLinker.Ld
    else:
        SystemLinker.Unknown

fn get_linker_info() -> text:
    val linker = auto_detect_linker()
    linker.name()

export SystemLinker, auto_detect_linker, get_linker_info
