# Test Attributes - Runtime Support
#
# Provides attribute-based test configuration without parser changes.
# Uses decoratorpattern - attributes are function calls that modify test behavior.
#
# Usage:
#   use std.testing.attributes.{timeout, retry, tag, skip_test}
#
#   timeout(5000):
#   retry(3):
#   tag("slow", "integration"):
#   it "performs database operation":
#       # test code

# ================================================================
# Attribute State
# ================================================================

# Current test configuration (set by attribute decorators)
var current_timeout_ms: i64 = 30000  # Default 30s
var current_retry_count: i64 = 1
var current_tags: [text] = []
var current_skip_reason = nil  # nil or text

# Test metadata storage (for querying)
var test_metadata: Dict<text, TestMeta> = {}

struct TestMeta:
    """Metadata for a single test."""
    name: text
    timeout_ms: i64
    retry_count: i64
    tags: [text]
    skip_reason: text?
    is_flaky: bool

# ================================================================
# Attribute Functions
# ================================================================

fn timeout(ms: i64, block: fn()):
    """Set timeout for next test.

    Usage:
        timeout(5000):
            it "slow test":
                # test body
    """
    val saved_timeout = current_timeout_ms
    current_timeout_ms = ms
    block()
    current_timeout_ms = saved_timeout

fn retry(count: i64, block: fn()):
    """Set retry count for next test.

    Usage:
        retry(3):
            it "flaky test":
                # test body
    """
    val saved_retry = current_retry_count
    current_retry_count = count
    block()
    current_retry_count = saved_retry

fn tag(tags_list: [text], block: fn()):
    """Add tags to next test.

    Usage:
        tag(["slow", "integration"]):
            it "integration test":
                # test body
    """
    val saved_tags = current_tags
    current_tags = tags_list
    block()
    current_tags = saved_tags

fn skip_test(reason: text, block: fn()):
    """Skip next test with reason.

    Usage:
        skip_test("Not implemented yet"):
            it "future feature":
                # test body
    """
    val saved_skip = current_skip_reason
    current_skip_reason = reason
    block()
    current_skip_reason = saved_skip

fn flaky(block: fn()):
    """Mark next test as flaky.

    Flaky tests are retried automatically (retry count = 3).

    Usage:
        flaky():
            it "timing sensitive test":
                # test body
    """
    val saved_retry = current_retry_count
    current_retry_count = 3
    block()
    current_retry_count = saved_retry

# ================================================================
# Attribute Application
# ================================================================

fn register_test_metadata(name: text):
    """Register current test with its attributes."""
    val meta = TestMeta(
        name: name,
        timeout_ms: current_timeout_ms,
        retry_count: current_retry_count,
        tags: current_tags,
        skip_reason: current_skip_reason,
        is_flaky: current_retry_count > 1
    )
    test_metadata.insert(name, meta)

    # Reset for next test
    current_timeout_ms = 30000
    current_retry_count = 1
    current_tags = []
    current_skip_reason = nil

fn get_test_metadata(name: text) -> TestMeta?:
    """Get metadata for a test."""
    test_metadata.get(name)

# ================================================================
# Query Functions
# ================================================================

fn find_tests_with_tag(tag_name: text) -> [text]:
    """Find all tests with a specific tag."""
    var results = []
    for (name, meta) in test_metadata:
        if meta.tags.contains(tag_name):
            results.push(name)
    results

fn find_slow_tests() -> [text]:
    """Find all tests tagged as 'slow'."""
    find_tests_with_tag("slow")

fn find_flaky_tests() -> [text]:
    """Find all flaky tests."""
    var results = []
    for (name, meta) in test_metadata:
        if meta.is_flaky:
            results.push(name)
    results

fn find_skipped_tests() -> [text]:
    """Find all skipped tests."""
    var results = []
    for (name, meta) in test_metadata:
        if meta.skip_reason.?:
            results.push(name)
    results

# ================================================================
# Validation
# ================================================================

fn validate_timeout(ms: i64) -> bool:
    """Validate timeout value."""
    ms > 0 and ms <= 3600000  # Max 1 hour

fn validate_retry(count: i64) -> bool:
    """Validate retry count."""
    count >= 1 and count <= 10  # Max 10 retries
