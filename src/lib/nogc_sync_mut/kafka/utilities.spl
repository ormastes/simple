# Apache Kafka Utilities Module
# Helper functions and utilities

import kafka.types

# ============================================================================

# Get current timestamp in milliseconds (mock implementation)
fn get_current_timestamp_ms() -> i64:
    # In real implementation, this would call external time function
    1234567890000

# Generate correlation ID (mock implementation)
fn generate_correlation_id() -> i64:
    # In real implementation, this would be a counter or random number
    42

# Validate topic name
fn is_valid_topic_name(topic: text) -> bool:
    var length = topic.len()
    if length == 0:
        return false
    if length > 249:
        return false

    # Must not be "." or ".."
    if topic == ".":
        return false
    if topic == "..":
        return false

    # Must contain only alphanumeric, dots, underscores, hyphens
    var idx = 0
    while idx < length:
        var char = topic[idx]
        var is_valid_char = false

        if char >= "a":
            if char <= "z":
                is_valid_char = true
        if char >= "A":
            if char <= "Z":
                is_valid_char = true
        if char >= "0":
            if char <= "9":
                is_valid_char = true
        if char == ".":
            is_valid_char = true
        if char == "_":
            is_valid_char = true
        if char == "-":
            is_valid_char = true

        if is_valid_char == false:
            return false

        idx = idx + 1

    true

# Validate group ID
fn is_valid_group_id(group_id: text) -> bool:
    var length = group_id.len()
    if length == 0:
        return false
    if length > 255:
        return false
    true

# Calculate record batch size
fn calculate_record_batch_size(batch: list) -> i64:
    var records = get_record_batch_records(batch)
    var record_count = records.len()
    var base_size = 61
    var total_size = base_size
    var idx = 0

    while idx < record_count:
        var record = records[idx]
        var key = get_record_key(record)
        var value = get_record_value(record)
        var headers = get_record_headers(record)

        var record_size = 10
        record_size = record_size + key.len()
        record_size = record_size + value.len()
        record_size = record_size + (headers.len() * 20)

        total_size = total_size + record_size
        idx = idx + 1

    total_size

# Find broker by node ID
fn find_broker_by_node_id(brokers: list, node_id: i64) -> list:
    var idx = 0
    var broker_count = brokers.len()

    while idx < broker_count:
        var broker = brokers[idx]
        var broker_node_id = get_broker_node_id(broker)

        if broker_node_id == node_id:
            return broker

        idx = idx + 1

    []

# Find partition leader
fn find_partition_leader(partition_metadata: list, partition_id: i64) -> i64:
    var idx = 0
    var partition_count = partition_metadata.len()

    while idx < partition_count:
        var metadata = partition_metadata[idx]
        var metadata_id = get_partition_metadata_id(metadata)

        if metadata_id == partition_id:
            return get_partition_metadata_leader(metadata)

        idx = idx + 1

    -1

# Check if partition is in-sync
fn is_partition_in_sync(partition_metadata: list, replica_id: i64) -> bool:
    var isr = get_partition_metadata_isr(partition_metadata)
    var idx = 0
    var isr_count = isr.len()

    while idx < isr_count:
        var isr_replica = isr[idx]

        if isr_replica == replica_id:
            return true

        idx = idx + 1

    false
