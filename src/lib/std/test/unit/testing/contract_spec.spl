/// Contract Testing Framework Tests.
/// Validates Pact-style consumer-driven contract testing including
/// ContractBuilder, request/response building, matchers, and mock server.

# Contract Testing Framework Tests
# Tests for Pact-style consumer-driven contract testing

import std.spec
import std.testing.contract as ct

describe "Contract Testing":
    /// Tests the contract testing library for consumer-driven contract
    /// testing with ContractBuilder, matchers, MockServer, and PactBroker.

    # =========================================================================
    # Group 1: ContractBuilder Core (3 tests)
    # =========================================================================

    context "ContractBuilder":
        it "creates contract builder":
            val builder = ct.ContractBuilder.new("consumer", "provider")
            assert builder.consumer == "consumer"
            assert builder.provider == "provider"

        it "defines provider state":
            val builder = ct.ContractBuilder.new("client", "service")
            builder.given("user exists")
            assert builder.current_state.is_some()

        it "defines interaction description":
            val builder = ct.ContractBuilder.new("client", "service")
            builder.upon_receiving("a GET request")
            assert builder.current_description == "a GET request"

    # =========================================================================
    # Group 2: Request Building (3 tests)
    # =========================================================================

    context "Request Building":
        it "builds GET request":
            val builder = ct.ContractBuilder.new("client", "service")
            builder.with_request("GET", "/users/123")
            assert builder.pending_request.is_some()

        it "adds request headers":
            val builder = ct.ContractBuilder.new("client", "service")
            builder
                .with_request("GET", "/users/123")
                .with_header("Accept", "application/json")
            assert builder.pending_request.is_some()

        it "adds request body":
            val builder = ct.ContractBuilder.new("client", "service")
            builder
                .with_request("POST", "/users")
                .with_body("" + "{" + "\"name\": \"Alice\"" + "}")
            assert builder.pending_request.is_some()

    # =========================================================================
    # Group 3: Response Building (3 tests)
    # =========================================================================

    context "Response Building":
        it "sets response status":
            val builder = ct.ContractBuilder.new("client", "service")
            builder
                .with_request("GET", "/users/123")
                .will_respond_with()
                .status(200)
            assert builder.pending_response.is_some()

        it "adds response body":
            val builder = ct.ContractBuilder.new("client", "service")
            builder
                .with_request("GET", "/users/123")
                .will_respond_with()
                .status(200)
                .with_response_body("" + "{" + "\"id\": 123, \"name\": \"Alice\"" + "}")
            assert builder.pending_response.is_some()

        it "adds response headers":
            val builder = ct.ContractBuilder.new("client", "service")
            builder
                .with_request("GET", "/users/123")
                .will_respond_with()
                .status(200)
                .with_response_header("Content-Type", "application/json")
            assert builder.pending_response.is_some()

    # =========================================================================
    # Group 4: Matchers (3 tests)
    # =========================================================================

    context "Matchers":
        it "creates like matcher":
            val matcher = ct.Matcher.like("Alice")
            assert matcher.match_type == "like"
            assert matcher.example == "Alice"

        it "creates term matcher":
            val matcher = ct.Matcher.term("\\d{3}", "123")
            assert matcher.match_type == "term"
            assert matcher.regex.is_some()

        it "creates each_like matcher":
            val json_str = "" + "{" + "\"id\": 1" + "}"
            val matcher = ct.Matcher.each_like(json_str)
            assert matcher.match_type == "each_like"
            assert matcher.example == json_str

    # =========================================================================
    # Group 5: Persistence (2 tests)
    # =========================================================================

    context "Persistence":
        it "converts contract to Pact JSON":
            val contract = ct.Contract.new("client", "provider")
            val request = ct.HttpRequest.new("GET", "/users")
            val response = ct.HttpResponse.new(200)
            val interaction = ct.Interaction.new("get users", request, response)
            contract.add_interaction(interaction)

            val json = contract.to_pact_json()
            assert json.size() > 0
            assert json.contains("client")
            assert json.contains("provider")

        it "saves contract to file":
            val contract = ct.Contract.new("client", "provider")
            val request = ct.HttpRequest.new("GET", "/users")
            val response = ct.HttpResponse.new(200)
            val interaction = ct.Interaction.new("get users", request, response)
            contract.add_interaction(interaction)

            val result = contract.save("/tmp/test_contract.json")
            assert result.is_ok()

    # =========================================================================
    # Group 6: MockServer (3 tests)
    # =========================================================================

    context "MockServer":
        it "creates mock server from contract":
            val contract = ct.Contract.new("client", "provider")
            val server = ct.MockServer.new(contract)
            assert server.get_url() == "http://mock.local:0"

        it "simulates requests against contract":
            val contract = ct.Contract.new("client", "provider")
            val request = ct.HttpRequest.new("GET", "/users/123")
            val response = ct.HttpResponse.new(200)
            response.set_body("" + "{" + "\"id\": 123" + "}")
            val interaction = ct.Interaction.new("get user", request, response)
            contract.add_interaction(interaction)

            val server = ct.MockServer.new(contract)
            val result = server.simulate_request("GET", "/users/123")
            assert result.status == 200

        it "tracks matched interactions":
            val contract = ct.Contract.new("client", "provider")
            val request = ct.HttpRequest.new("GET", "/users/123")
            val response = ct.HttpResponse.new(200)
            val interaction = ct.Interaction.new("get user", request, response)
            contract.add_interaction(interaction)

            val server = ct.MockServer.new(contract)
            server.simulate_request("GET", "/users/123")
            assert server.verify()

    # =========================================================================
    # Group 7: Provider Verification (2 tests)
    # =========================================================================

    context "Provider Verification":
        it "creates contract verifier":
            val verifier = ct.ContractVerifier.new()
            verifier
                .with_provider("service")
                .with_contract_file("/path/to/contract.json")
                .with_provider_base_url("http://localhost:8080")

            assert verifier.provider_name == "service"

        it "verifies provider against contract":
            val verifier = ct.ContractVerifier.new()
            verifier
                .with_provider("service")
                .with_contract_file("/path/to/contract.json")
                .with_provider_base_url("http://localhost:8080")

            val result = verifier.verify()
            assert result

    # =========================================================================
    # Group 8: PactBroker (3 tests)
    # =========================================================================

    context "PactBroker":
        it "publishes contract to broker":
            val broker = ct.PactBroker.new("http://broker.example.com")
            val contract = ct.Contract.new("client", "provider")
            val result = broker.publish(contract, "1.0.0")
            assert result.is_ok()

        it "fetches contracts for provider":
            val broker = ct.PactBroker.new("http://broker.example.com")
            val contract1 = ct.Contract.new("client1", "provider")
            val contract2 = ct.Contract.new("client2", "provider")
            val contract3 = ct.Contract.new("client3", "other")

            broker.publish(contract1, "1.0.0")
            broker.publish(contract2, "1.0.0")
            broker.publish(contract3, "1.0.0")

            val contracts = broker.fetch_for_provider("provider")
            assert contracts.size() == 2

        it "counts contracts in broker":
            val broker = ct.PactBroker.new("http://broker.example.com")
            val contract1 = ct.Contract.new("client", "provider1")
            val contract2 = ct.Contract.new("client", "provider2")

            broker.publish(contract1, "1.0.0")
            broker.publish(contract2, "1.0.0")

            assert broker.count() == 2
