# Godot GDExtension FFI Declarations
#
# Low-level FFI bindings to Godot's C API
# These are the raw C function declarations that will be
# implemented in the Rust runtime
#
# Reference: extension_api.json from Godot 4.3+

# Opaque pointer types for Godot objects
pub type GDExtensionObjectPtr = u64
pub type GDExtensionClassInstancePtr = u64
pub type GDExtensionMethodBindPtr = u64
pub type GDExtensionScriptInstancePtr = u64

# Variant type (Godot's universal value type)
pub type GDExtensionVariantPtr = u64

# text types
pub type GDExtensionStringPtr = u64
pub type GDExtensionStringNamePtr = u64

# GDExtension initialization
extern "C" fn godot_gdextension_init(
    p_get_proc_address: u64,
    p_library: u64,
    r_initialization: u64
) -> u8

# Variant operations
extern "C" fn godot_variant_new_copy(dst: GDExtensionVariantPtr, src: GDExtensionVariantPtr)
extern "C" fn godot_variant_new_nil(dst: GDExtensionVariantPtr)
extern "C" fn godot_variant_destroy(ptr: GDExtensionVariantPtr)

# Variant type conversions
extern "C" fn godot_variant_new_bool(dst: GDExtensionVariantPtr, value: bool)
extern "C" fn godot_variant_new_int(dst: GDExtensionVariantPtr, value: i64)
extern "C" fn godot_variant_new_float(dst: GDExtensionVariantPtr, value: f64)
extern "C" fn godot_variant_new_string(dst: GDExtensionVariantPtr, value: GDExtensionStringPtr)
extern "C" fn godot_variant_new_object(dst: GDExtensionVariantPtr, value: GDExtensionObjectPtr)

extern "C" fn godot_variant_as_bool(ptr: GDExtensionVariantPtr) -> bool
extern "C" fn godot_variant_as_int(ptr: GDExtensionVariantPtr) -> i64
extern "C" fn godot_variant_as_float(ptr: GDExtensionVariantPtr) -> f64
extern "C" fn godot_variant_as_string(ptr: GDExtensionVariantPtr) -> GDExtensionStringPtr
extern "C" fn godot_variant_as_object(ptr: GDExtensionVariantPtr) -> GDExtensionObjectPtr

# text operations
extern "C" fn godot_string_new(dst: GDExtensionStringPtr)
extern "C" fn godot_string_new_with_utf8_chars(dst: GDExtensionStringPtr, contents: *const u8, size: i64)
extern "C" fn godot_string_to_utf8_chars(ptr: GDExtensionStringPtr, r_text: *mut u8, max_len: i64) -> i64
extern "C" fn godot_string_destroy(ptr: GDExtensionStringPtr)

# StringName operations
extern "C" fn godot_string_name_new_with_utf8_chars(dst: GDExtensionStringNamePtr, contents: *const u8, size: i64)
extern "C" fn godot_string_name_destroy(ptr: GDExtensionStringNamePtr)

# Object operations
extern "C" fn godot_object_method_bind_call(
    method_bind: GDExtensionMethodBindPtr,
    instance: GDExtensionObjectPtr,
    args: *const GDExtensionVariantPtr,
    arg_count: i64,
    ret: GDExtensionVariantPtr,
    error: *mut i32
)

extern "C" fn godot_object_get_instance_binding(
    object: GDExtensionObjectPtr,
    token: u64,
    callbacks: u64
) -> u64

extern "C" fn godot_object_set_instance_binding(
    object: GDExtensionObjectPtr,
    token: u64,
    binding: u64,
    callbacks: u64
)

extern "C" fn godot_object_destroy(ptr: GDExtensionObjectPtr)

# Method binding
extern "C" fn godot_classdb_get_method_bind(
    class_name: GDExtensionStringNamePtr,
    method_name: GDExtensionStringNamePtr,
    hash: i64
) -> GDExtensionMethodBindPtr

# Class registration
extern "C" fn godot_classdb_register_extension_class(
    library: u64,
    class_name: GDExtensionStringNamePtr,
    parent_class_name: GDExtensionStringNamePtr,
    extension_funcs: u64
) -> bool

extern "C" fn godot_classdb_register_extension_class_method(
    library: u64,
    class_name: GDExtensionStringNamePtr,
    method_info: u64
)

extern "C" fn godot_classdb_register_extension_class_property(
    library: u64,
    class_name: GDExtensionStringNamePtr,
    property_info: u64,
    setter: GDExtensionStringNamePtr,
    getter: GDExtensionStringNamePtr
)

# Signal operations
extern "C" fn godot_object_emit_signal(
    instance: GDExtensionObjectPtr,
    signal_name: GDExtensionStringNamePtr,
    args: *const GDExtensionVariantPtr,
    arg_count: i64
)

extern "C" fn godot_signal_connect(
    instance: GDExtensionObjectPtr,
    signal_name: GDExtensionStringNamePtr,
    target: GDExtensionObjectPtr,
    method_name: GDExtensionStringNamePtr,
    flags: i32
) -> i32

extern "C" fn godot_signal_disconnect(
    instance: GDExtensionObjectPtr,
    signal_name: GDExtensionStringNamePtr,
    target: GDExtensionObjectPtr,
    method_name: GDExtensionStringNamePtr
)

# Utility functions
extern "C" fn godot_get_class_constructor(class_name: GDExtensionStringNamePtr) -> u64
extern "C" fn godot_print_warning(message: *const u8, function: *const u8, file: *const u8, line: i32)
extern "C" fn godot_print_error(message: *const u8, function: *const u8, file: *const u8, line: i32)

# Vector2/Vector3 operations (for position/rotation)
extern "C" fn godot_variant_new_vector2(dst: GDExtensionVariantPtr, x: f64, y: f64)
extern "C" fn godot_variant_new_vector3(dst: GDExtensionVariantPtr, x: f64, y: f64, z: f64)
extern "C" fn godot_variant_as_vector2(ptr: GDExtensionVariantPtr, out_x: *mut f64, out_y: *mut f64)
extern "C" fn godot_variant_as_vector3(ptr: GDExtensionVariantPtr, out_x: *mut f64, out_y: *mut f64, out_z: *mut f64)

# Color operations
extern "C" fn godot_variant_new_color(dst: GDExtensionVariantPtr, r: f32, g: f32, b: f32, a: f32)

# Array/Dictionary operations
extern "C" fn godot_variant_new_array(dst: GDExtensionVariantPtr)
extern "C" fn godot_variant_new_dictionary(dst: GDExtensionVariantPtr)

# Vector2i operations (integer vectors)
extern "C" fn godot_variant_new_vector2i(dst: GDExtensionVariantPtr, x: i32, y: i32)
extern "C" fn godot_variant_as_vector2i(ptr: GDExtensionVariantPtr, out_x: *mut i32, out_y: *mut i32)

# RID operations
extern "C" fn godot_variant_as_rid(ptr: GDExtensionVariantPtr) -> u64

# Packed array operations
extern "C" fn godot_variant_as_packed_int32_array(ptr: GDExtensionVariantPtr, out_length: *mut i32) -> *const i32
extern "C" fn godot_variant_as_packed_string_array(ptr: GDExtensionVariantPtr, out_length: *mut i32) -> *const GDExtensionStringPtr

# Singleton access
extern "C" fn godot_get_singleton(name: *const u8, name_len: i64) -> GDExtensionObjectPtr

# RenderingDevice Vulkan access (Godot 4.x)
# These retrieve raw Vulkan handles from Godot's RenderingDevice
extern "C" fn godot_rd_get_driver_resource(
    device_ptr: GDExtensionObjectPtr,
    resource_type: i32,  # 0=VkInstance, 1=VkPhysicalDevice, 2=VkDevice, 3=VkQueue
    rid: u64,            # Resource ID (0 for device-level resources)
    index: u64           # Index for queues, 0 otherwise
) -> u64

# RenderingDevice shader operations
extern "C" fn godot_rd_shader_create_from_spirv(
    device_ptr: GDExtensionObjectPtr,
    spirv_data: *const u8,
    spirv_len: u64
) -> u64  # Returns ShaderRID

extern "C" fn godot_rd_free_rid(device_ptr: GDExtensionObjectPtr, rid: u64)

# RenderingDevice buffer operations
extern "C" fn godot_rd_buffer_create(
    device_ptr: GDExtensionObjectPtr,
    size: u64,
    usage: u32  # 0=vertex, 1=index, 2=uniform, 3=storage
) -> u64  # Returns BufferRID

extern "C" fn godot_rd_buffer_update(
    device_ptr: GDExtensionObjectPtr,
    buffer_rid: u64,
    offset: u64,
    data: *const u8,
    data_len: u64
) -> i32

# RenderingDevice draw operations
extern "C" fn godot_rd_draw_list_begin(
    device_ptr: GDExtensionObjectPtr,
    framebuffer_rid: u64,
    clear_color_r: f32,
    clear_color_g: f32,
    clear_color_b: f32,
    clear_color_a: f32
) -> u64  # Returns draw list ID

extern "C" fn godot_rd_draw_list_bind_render_pipeline(
    device_ptr: GDExtensionObjectPtr,
    draw_list: u64,
    pipeline_rid: u64
)

extern "C" fn godot_rd_draw_list_bind_vertex_array(
    device_ptr: GDExtensionObjectPtr,
    draw_list: u64,
    vertex_array_rid: u64
)

extern "C" fn godot_rd_draw_list_draw(
    device_ptr: GDExtensionObjectPtr,
    draw_list: u64,
    use_indices: bool,
    instances: u32
)

extern "C" fn godot_rd_draw_list_end(device_ptr: GDExtensionObjectPtr)

# RenderingDevice pipeline operations
extern "C" fn godot_rd_render_pipeline_create(
    device_ptr: GDExtensionObjectPtr,
    shader_rid: u64,
    framebuffer_format: u64,
    vertex_stride: u32,
    vertex_attribute_count: u32
) -> u64  # Returns PipelineRID

# RenderingDevice vertex array operations
extern "C" fn godot_rd_vertex_array_create(
    device_ptr: GDExtensionObjectPtr,
    vertex_count: u32,
    vertex_stride: u32,
    buffer_rid: u64
) -> u64  # Returns VertexArrayRID

# RenderingDevice framebuffer format
extern "C" fn godot_rd_framebuffer_format_create(
    device_ptr: GDExtensionObjectPtr,
    color_format: u32,
    depth_format: u32
) -> u64  # Returns framebuffer format ID

# RenderingDevice texture operations
extern "C" fn godot_rd_texture_create(
    device_ptr: GDExtensionObjectPtr,
    width: u32,
    height: u32,
    format: u32,          # 37=R8G8B8A8_UNORM, 50=R8_UNORM (grayscale)
    usage: u32,           # 1=sampling, 2=color_attachment, 4=storage
    initial_data: *const u8,
    data_len: u64
) -> u64  # Returns TextureRID

extern "C" fn godot_rd_texture_update(
    device_ptr: GDExtensionObjectPtr,
    texture_rid: u64,
    layer: u32,
    data: *const u8,
    data_len: u64
) -> i32

extern "C" fn godot_rd_texture_get_data(
    device_ptr: GDExtensionObjectPtr,
    texture_rid: u64,
    layer: u32,
    out_data: *mut u8,
    max_len: u64
) -> u64  # Returns actual data length

# RenderingDevice sampler operations
extern "C" fn godot_rd_sampler_create(
    device_ptr: GDExtensionObjectPtr,
    min_filter: u32,      # 0=nearest, 1=linear
    mag_filter: u32,
    mip_filter: u32,
    address_mode_u: u32,  # 0=repeat, 1=mirrored_repeat, 2=clamp_to_edge
    address_mode_v: u32,
    address_mode_w: u32
) -> u64  # Returns SamplerRID

# RenderingDevice uniform set operations (for binding textures to shaders)
extern "C" fn godot_rd_uniform_set_create(
    device_ptr: GDExtensionObjectPtr,
    shader_rid: u64,
    set_index: u32,
    uniforms_data: *const u8,  # Serialized uniform descriptions
    uniforms_len: u64
) -> u64  # Returns UniformSetRID

extern "C" fn godot_rd_draw_list_bind_uniform_set(
    device_ptr: GDExtensionObjectPtr,
    draw_list: u64,
    uniform_set_rid: u64,
    set_index: u32
)

# RenderingDevice index buffer operations
extern "C" fn godot_rd_draw_list_bind_index_array(
    device_ptr: GDExtensionObjectPtr,
    draw_list: u64,
    index_array_rid: u64
)

extern "C" fn godot_rd_index_array_create(
    device_ptr: GDExtensionObjectPtr,
    index_buffer_rid: u64,
    index_offset: u32,
    index_count: u32
) -> u64  # Returns IndexArrayRID

# RenderingDevice push constants (for simple uniforms like transforms)
extern "C" fn godot_rd_draw_list_set_push_constant(
    device_ptr: GDExtensionObjectPtr,
    draw_list: u64,
    data: *const u8,
    data_len: u32
)

# Helper function to get singleton by name (wraps godot_get_singleton)
pub fn get_singleton(name: &str) -> GDExtensionObjectPtr:
    return godot_get_singleton(name.as_ptr(), name.len() as i64)
