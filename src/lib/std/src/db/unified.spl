# Unified Database API
#
# Provides a consistent interface for database operations across different record types.
# Since Simple doesn't have full generics yet, uses type-specific classes.

use db.records.*
use db.persistence.*

# ===== DatabaseTodo =====

pub class DatabaseTodo:
    path: text
    records: Dict<text, TodoRecord>

impl DatabaseTodo:
    pub static fn create(path: text) -> DatabaseTodo:
        """Create empty database for TodoRecord"""
        DatabaseTodo(path: path, records: {})

    pub static fn load(path: text) -> Result<DatabaseTodo, text>:
        """Load database from file"""
        val db_result = load_todo_db(path)
        match db_result:
            Ok(todo_db) => Ok(DatabaseTodo(path: path, records: todo_db.records))
            Err(e) => Err(e)

    pub fn get(id: text) -> Option<TodoRecord>:
        """Get record by ID"""
        match self.records.get(id):
            Some(record) => Some(record)
            None => None

    pub me insert(record: TodoRecord):
        """Insert or update record"""
        self.records[record.id] = record

    pub me delete(id: text) -> Option<TodoRecord>:
        """Delete record by ID, returns deleted record if existed"""
        self.records.remove(id)

    pub fn all() -> [TodoRecord]:
        """Get all records"""
        self.records.values()

    pub fn count() -> i64:
        """Get record count"""
        self.records.len()

    pub fn save() -> Result<(), text>:
        """Save database to file"""
        val todo_db = TodoDb(records: self.records)
        save_todo_db(self.path, todo_db)

# ===== DatabaseFeature =====

pub class DatabaseFeature:
    path: text
    records: Dict<text, FeatureRecord>

impl DatabaseFeature:
    pub static fn create(path: text) -> DatabaseFeature:
        """Create empty database for FeatureRecord"""
        DatabaseFeature(path: path, records: {})

    pub static fn load(path: text) -> Result<DatabaseFeature, text>:
        """Load database from file"""
        val db_result = load_feature_db(path)
        match db_result:
            Ok(feature_db) => Ok(DatabaseFeature(path: path, records: feature_db.records))
            Err(e) => Err(e)

    pub fn get(id: text) -> Option<FeatureRecord>:
        """Get record by ID"""
        match self.records.get(id):
            Some(record) => Some(record)
            None => None

    pub me insert(record: FeatureRecord):
        """Insert or update record"""
        self.records[record.id] = record

    pub me delete(id: text) -> Option<FeatureRecord>:
        """Delete record by ID, returns deleted record if existed"""
        self.records.remove(id)

    pub fn all() -> [FeatureRecord]:
        """Get all records"""
        self.records.values()

    pub fn count() -> i64:
        """Get record count"""
        self.records.len()

    pub fn save() -> Result<(), text>:
        """Save database to file"""
        val feature_db = FeatureDb(records: self.records)
        save_feature_db(self.path, feature_db)

# ===== DatabaseTask =====

pub class DatabaseTask:
    path: text
    records: Dict<text, TaskRecord>

impl DatabaseTask:
    pub static fn create(path: text) -> DatabaseTask:
        """Create empty database for TaskRecord"""
        DatabaseTask(path: path, records: {})

    pub static fn load(path: text) -> Result<DatabaseTask, text>:
        """Load database from file"""
        val db_result = load_task_db(path)
        match db_result:
            Ok(task_db) => Ok(DatabaseTask(path: path, records: task_db.records))
            Err(e) => Err(e)

    pub fn get(id: text) -> Option<TaskRecord>:
        """Get record by ID"""
        match self.records.get(id):
            Some(record) => Some(record)
            None => None

    pub me insert(record: TaskRecord):
        """Insert or update record"""
        self.records[record.id] = record

    pub me delete(id: text) -> Option<TaskRecord>:
        """Delete record by ID, returns deleted record if existed"""
        self.records.remove(id)

    pub fn all() -> [TaskRecord]:
        """Get all records"""
        self.records.values()

    pub fn count() -> i64:
        """Get record count"""
        self.records.len()

    pub fn save() -> Result<(), text>:
        """Save database to file"""
        val task_db = TaskDb(records: self.records)
        save_task_db(self.path, task_db)

# ===== Public API Functions =====

pub fn create_database_unified(path: text) -> DatabaseTodo:
    """Create empty unified database for TodoRecord"""
    DatabaseTodo.create(path)

pub fn load_database_unified_todo(path: text) -> Result<DatabaseTodo, text>:
    """Load unified database for TodoRecord"""
    DatabaseTodo.load(path)

pub fn load_database_unified_feature(path: text) -> Result<DatabaseFeature, text>:
    """Load unified database for FeatureRecord"""
    DatabaseFeature.load(path)

pub fn load_database_unified_task(path: text) -> Result<DatabaseTask, text>:
    """Load unified database for TaskRecord"""
    DatabaseTask.load(path)
