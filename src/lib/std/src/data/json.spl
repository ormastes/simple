# JSON Serialization and Deserialization
# Provides JSON encoding for Simple data structures

use core.option.{Option, Some}
use core.result.{Result, Ok, Err}
use core.string.*

# JSON value types
pub enum JsonValue:
    Object(List<(text, JsonValue)>)
    Array(List<JsonValue>)
    String(text)
    Number(f64)
    Bool(bool)
    Null

impl JsonValue:
    # Serialize to JSON string
    pub fn to_string() -> text:
        self.to_string_internal(0, false)

    # Serialize to pretty-printed JSON
    pub fn to_pretty_string() -> text:
        self.to_string_internal(0, true)

    # Internal serialization with indentation
    fn to_string_internal(indent: u64, pretty: bool) -> text:
        match self:
            JsonValue.Object(pairs):
                if pairs.is_empty():
                    return "{}"

                var result = "{"
                if pretty:
                    result = result + "\n"

                var i = 0
                while i < pairs.len():
                    val (key, value) = pairs[i]

                    if pretty:
                        result = result + repeat_string("  ", indent + 1)

                    result = result + "\"" + escape_string(key) + "\":"

                    if pretty:
                        result = result + " "

                    result = result + value.to_string_internal(indent + 1, pretty)

                    if i < pairs.len() - 1:
                        result = result + ","

                    if pretty:
                        result = result + "\n"

                    i = i + 1

                if pretty:
                    result = result + repeat_string("  ", indent)

                result = result + "}"
                result

            JsonValue.Array(items):
                if items.is_empty():
                    return "[]"

                var result = "["
                if pretty:
                    result = result + "\n"

                var i = 0
                while i < items.len():
                    if pretty:
                        result = result + repeat_string("  ", indent + 1)

                    result = result + items[i].to_string_internal(indent + 1, pretty)

                    if i < items.len() - 1:
                        result = result + ","

                    if pretty:
                        result = result + "\n"

                    i = i + 1

                if pretty:
                    result = result + repeat_string("  ", indent)

                result = result + "]"
                result

            JsonValue.String(s):
                "\"" + escape_string(s) + "\""

            JsonValue.Number(n):
                number_to_string(n)

            JsonValue.Bool(b):
                if b: "true" else: "false"

            JsonValue.Null:
                "null"

# JSON object builder for ergonomic construction
pub struct JsonObject:
    pairs: List<(text, JsonValue)>

impl JsonObject:
    # Create a new empty JSON object
    pub static fn new() -> JsonObject:
        JsonObject(pairs: [])

    # Add a string field
    pub me add_string(key: text, value: text):
        self.pairs.append((key, JsonValue.String(value)))

    # Add a number field
    pub me add_number(key: text, value: f64):
        self.pairs.append((key, JsonValue.Number(value)))

    # Add a boolean field
    pub me add_bool(key: text, value: bool):
        self.pairs.append((key, JsonValue.Bool(value)))

    # Add a null field
    pub me add_null(key: text):
        self.pairs.append((key, JsonValue.Null))

    # Add an array field
    pub me add_array(key: text, value: JsonArray):
        self.pairs.append((key, JsonValue.Array(value.items)))

    # Add an object field
    pub me add_object(key: text, value: JsonObject):
        self.pairs.append((key, JsonValue.Object(value.pairs)))

    # Add a raw JsonValue
    pub me add_value(key: text, value: JsonValue):
        self.pairs.append((key, value))

    # Convert to JsonValue
    pub fn to_value() -> JsonValue:
        JsonValue.Object(self.pairs)

    # Serialize to JSON string
    pub fn to_string() -> text:
        self.to_value().to_string()

    # Serialize to pretty JSON string
    pub fn to_pretty_string() -> text:
        self.to_value().to_pretty_string()

# JSON array builder for ergonomic construction
pub struct JsonArray:
    items: List<JsonValue>

impl JsonArray:
    # Create a new empty JSON array
    pub static fn new() -> JsonArray:
        JsonArray(items: [])

    # Add a string element
    pub me push_string(value: text):
        self.items.append(JsonValue.String(value))

    # Add a number element
    pub me push_number(value: f64):
        self.items.append(JsonValue.Number(value))

    # Add a boolean element
    pub me push_bool(value: bool):
        self.items.append(JsonValue.Bool(value))

    # Add a null element
    pub me push_null():
        self.items.append(JsonValue.Null)

    # Add an array element
    pub me push_array(value: JsonArray):
        self.items.append(JsonValue.Array(value.items))

    # Add an object element
    pub me push_object(value: JsonObject):
        self.items.append(JsonValue.Object(value.pairs))

    # Add a raw JsonValue
    pub me push_value(value: JsonValue):
        self.items.append(value)

    # Convert to JsonValue
    pub fn to_value() -> JsonValue:
        JsonValue.Array(self.items)

    # Serialize to JSON string
    pub fn to_string() -> text:
        self.to_value().to_string()

    # Serialize to pretty JSON string
    pub fn to_pretty_string() -> text:
        self.to_value().to_pretty_string()

# Helper: Escape string for JSON
fn escape_string(s: text) -> text:
    var result = ""
    var i = 0

    while i < s.len():
        val c = s.char_at(i)

        if c == '\\':
            result = result + "\\\\"
        elif c == '"':
            result = result + "\\\""
        elif c == '\n':
            result = result + "\\n"
        elif c == '\r':
            result = result + "\\r"
        elif c == '\t':
            result = result + "\\t"
        elif c == '\b':
            result = result + "\\b"
        elif c == '\f':
            result = result + "\\f"
        else:
            result.push(c)

        i = i + 1

    result

# Helper: Repeat a string n times
fn repeat_string(s: text, count: u64) -> text:
    var result = ""
    var i = 0

    while i < count:
        result = result + s
        i = i + 1

    result

# Helper: Convert number to string
fn number_to_string(n: f64) -> text:
    # Check if it's a whole number
    val int_val = n as i64
    if (int_val as f64) == n:
        # It's a whole number, format without decimal
        "{int_val}"
    else:
        # Has decimal places
        "{n}"
}

# Convenience function: Create a JSON object
pub fn json_object() -> JsonObject:
    JsonObject::new()

# Convenience function: Create a JSON array
pub fn json_array() -> JsonArray:
    JsonArray::new()

# Convenience function: Serialize any JsonValue to string
pub fn to_json(value: JsonValue) -> text:
    value.to_string()

# Convenience function: Serialize any JsonValue to pretty string
pub fn to_json_pretty(value: JsonValue) -> text:
    value.to_pretty_string()

# Example usage:
# ```simple
# use data.json.{json_object, json_array, to_json_pretty}
#
# # Create a JSON object
# var obj = json_object()
# obj.add_string("name", "Alice")
# obj.add_number("age", 30.0)
# obj.add_bool("active", true)
#
# # Create a nested array
# var hobbies = json_array()
# hobbies.push_string("reading")
# hobbies.push_string("coding")
# obj.add_array("hobbies", hobbies)
#
# # Serialize to JSON
# val json = obj.to_string()
# print json  # {"name":"Alice","age":30,"active":true,"hobbies":["reading","coding"]}
#
# # Pretty print
# val pretty = obj.to_pretty_string()
# print pretty
# # {
# #   "name": "Alice",
# #   "age": 30,
# #   "active": true,
# #   "hobbies": [
# #     "reading",
# #     "coding"
# #   ]
# # }
# ```
