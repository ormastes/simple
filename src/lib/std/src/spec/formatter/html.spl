# HTML Documentation Generator for BDD Specs
# Converts describe/context/it blocks into interactive HTML documentation

use core.collections.{List, Dict}
use core.string.text

class HtmlFormatter:
    output: text
    html_template: text

    static fn new() -> HtmlFormatter:
        return HtmlFormatter(
            output: text.empty(),
            html_template: default_html_template()
        )

    static fn new_with_html_template(html_template: text) -> HtmlFormatter:
        return HtmlFormatter(
            output: text.empty(),
            html_template: html_template
        )

    static fn escape_html(text: text) -> text:
        return text
            .replace("&", "&amp;")
            .replace("<", "&lt;")
            .replace(">", "&gt;")
            .replace("\"", "&quot;")
            .replace("'", "&#39;")

    fn format_describe(name: text, id: text) -> text:
        val escaped = HtmlFormatter.escape_html(name)
        return """
        <section class="describe" id="{id}">
            <h2 class="describe-title">{escaped}</h2>
            <div class="describe-content">
        """

    fn format_context(name: text, id: text) -> text:
        val escaped = HtmlFormatter.escape_html(name)
        return """
            <div class="context" id="{id}">
                <h3 class="context-title">{escaped}</h3>
                <div class="context-examples">
        """

    fn format_example(name: text, status: text, error: Option<text>, code: Option<text>) -> text:
        val escaped_name = HtmlFormatter.escape_html(name)
        val status_class = match status:
            "pass" => "success"
            "fail" => "failure"
            "skip" => "skipped"
            _ => "unknown"

        val icon = match status:
            "pass" => "✅"
            "fail" => "❌"
            "skip" => "⏭️"
            _ => "❓"

        var result = """
                    <div class="example {status_class}">
                        <h4 class="example-title">
                            <span class="status-icon">{icon}</span>
                            {escaped_name}
                        </h4>
        """

        if val Some(err) = error:
            val escaped_err = HtmlFormatter.escape_html(err)
            result = result + """
                        <div class="error-message">
                            <strong>Error:</strong>
                            <pre>{escaped_err}</pre>
                        </div>
            """

        if val Some(c) = code:
            val escaped_code = HtmlFormatter.escape_html(c)
            result = result + """
                        <div class="code-block">
                            <pre><code class="language-simple">{escaped_code}</code></pre>
                        </div>
            """

        result = result + "                    </div>\n"
        return result

    fn close_context() -> text:
        return "                </div>\n            </div>\n"

    fn close_describe() -> text:
        return "            </div>\n        </section>\n"

# Default HTML html_template with CSS
fn default_html_template() -> text:
    return """<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{suite_name}} - Test Specifications</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; margin-bottom: 10px; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
        .timestamp { color: #7f8c8d; font-size: 0.9em; margin-bottom: 30px; }
        .describe { margin: 30px 0; padding: 20px; background: #f8f9fa; border-left: 4px solid #3498db; }
        .describe-title { color: #2c3e50; font-size: 1.5em; margin-bottom: 15px; }
        .context { margin: 20px 0; padding: 15px; background: white; border-left: 3px solid #95a5a6; }
        .context-title { color: #34495e; font-size: 1.2em; margin-bottom: 10px; }
        .example { margin: 10px 0; padding: 12px; border-radius: 4px; border-left: 3px solid #bdc3c7; }
        .example.success { background: #d5f4e6; border-left-color: #27ae60; }
        .example.failure { background: #fadbd8; border-left-color: #e74c3c; }
        .example.skipped { background: #fef5e7; border-left-color: #f39c12; }
        .example-title { font-size: 1em; margin-bottom: 8px; display: flex; align-items: center; }
        .status-icon { margin-right: 8px; font-size: 1.2em; }
        .error-message { margin-top: 10px; padding: 10px; background: #fbe9e7; border-left: 3px solid #e74c3c; }
        .error-message pre { white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', monospace; font-size: 0.9em; }
        .code-block { margin-top: 10px; }
        .code-block pre { background: #282c34; color: #abb2bf; padding: 15px; border-radius: 4px; overflow-x: auto; }
        .code-block code { font-family: 'Courier New', Consolas, Monaco, monospace; font-size: 0.9em; }
        .summary { margin-top: 40px; padding: 20px; background: #ecf0f1; border-radius: 4px; }
        .summary h2 { color: #2c3e50; margin-bottom: 15px; }
        .summary-stats { display: flex; gap: 20px; flex-wrap: wrap; }
        .stat { padding: 10px 20px; background: white; border-radius: 4px; border-left: 3px solid #3498db; }
        .stat-label { font-weight: bold; color: #7f8c8d; font-size: 0.9em; }
        .stat-value { font-size: 1.5em; color: #2c3e50; }
    </style>
</head>
<body>
    <div class="container">
        <h1>{{suite_name}}</h1>
        <div class="timestamp">Generated: {{timestamp}}</div>
        {{content}}
        {{summary}}
    </div>
</body>
</html>"""

# Convert spec results to HTML documentation
fn format_spec_to_html(spec_results: Dict<text, Any>) -> text:
    val formatter = HtmlFormatter.new()
    var content = text.empty()

    # Process describe blocks
    if val Some(describes) = spec_results.get("describe_blocks"):
        var describe_id = 0
        for describe in describes:
            val desc_id = "describe-{describe_id}"
            content = content + formatter.format_describe(
                describe.get("description").unwrap_or(""),
                desc_id
            )

            # Process contexts
            if val Some(contexts) = describe.get("contexts"):
                var context_id = 0
                for context in contexts:
                    val ctx_id = "{desc_id}-context-{context_id}"
                    content = content + formatter.format_context(
                        context.get("description").unwrap_or(""),
                        ctx_id
                    )

                    # Process examples
                    if val Some(example_list) = context.get("examples"):
                        for example in example_list:
                            val status = example.get("status").unwrap_or("unknown")
                            val name = example.get("description").unwrap_or("")
                            val error = example.get("error")
                            val code = example.get("code")

                            content = content + formatter.format_example(name, status, error, code)

                    content = content + formatter.close_context()
                    context_id = context_id + 1

            content = content + formatter.close_describe()
            describe_id = describe_id + 1

    # Build summary section
    var summary = text.empty()
    if val Some(summary_data) = spec_results.get("summary"):
        val total = summary_data.get("total").unwrap_or(0)
        val passed = summary_data.get("passed").unwrap_or(0)
        val failed = summary_data.get("failed").unwrap_or(0)
        val skipped = summary_data.get("skipped").unwrap_or(0)

        summary = """
        <div class="summary">
            <h2>Summary</h2>
            <div class="summary-stats">
                <div class="stat">
                    <div class="stat-label">Total</div>
                    <div class="stat-value">{total}</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Passed ✅</div>
                    <div class="stat-value">{passed}</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Failed ❌</div>
                    <div class="stat-value">{failed}</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Skipped ⏭️</div>
                    <div class="stat-value">{skipped}</div>
                </div>
            </div>
        </div>
        """

    # Replace html_template variables
    val suite_name = spec_results.get("suite_name").unwrap_or("Test Suite")
    val timestamp = spec_results.get("timestamp").unwrap_or("Unknown")

    return formatter.html_template
        .replace("{{suite_name}}", suite_name)
        .replace("{{timestamp}}", timestamp)
        .replace("{{content}}", content)
        .replace("{{summary}}", summary)

