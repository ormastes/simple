# Diagram Integration for SSpec (Simplified)
#
# Provides basic diagram integration for test execution.

use diagram.{DiagramType, DiagramConfig, enable_ffi_recording, disable_ffi_recording, clear_ffi_recording, generate_sequence_ffi, generate_class_ffi, generate_arch_ffi}

# Global state for diagram generation
val _diagram_enabled: bool = false
val _diagram_types: List<DiagramType> = []
val _diagram_output_dir: text = "doc/spec/diagrams"
val _current_test_file: text = ""
val _current_test_name: text = ""

fn enable_diagrams(types: List<DiagramType>) -> void:
    _diagram_enabled = true
    _diagram_types = types

fn enable_all_diagrams() -> void:
    _diagram_enabled = true
    _diagram_types = [DiagramType.Sequence, DiagramType.Class, DiagramType.Architecture]

fn disable_diagrams() -> void:
    _diagram_enabled = false
    _diagram_types = []

fn is_diagram_enabled() -> bool:
    return _diagram_enabled

fn set_diagram_output(dir: text) -> void:
    _diagram_output_dir = dir

fn set_test_context(test_file: text, test_name: text) -> void:
    _current_test_file = test_file
    _current_test_name = test_name

fn clear_test_context() -> void:
    _current_test_file = ""
    _current_test_name = ""

fn with_seq_diagram(block: fn() -> void) -> void:
    enable_ffi_recording()
    clear_ffi_recording()
    block()
    disable_ffi_recording()

fn with_class_diagram(block: fn() -> void) -> void:
    enable_ffi_recording()
    clear_ffi_recording()
    block()
    disable_ffi_recording()

fn with_arch_diagram(block: fn() -> void) -> void:
    enable_ffi_recording()
    clear_ffi_recording()
    block()
    disable_ffi_recording()

fn with_all_diagram_types(block: fn() -> void) -> void:
    enable_ffi_recording()
    clear_ffi_recording()
    block()
    disable_ffi_recording()

fn traced_it(description: text, block: fn() -> void) -> void:
    enable_ffi_recording()
    clear_ffi_recording()
    block()
    disable_ffi_recording()

fn generate_diagrams_for_spec(test_name: text) -> Dict<text, text>:
    val diagrams: Dict<text, text> = {}
    diagrams["sequence"] = generate_sequence_ffi()
    diagrams["class"] = generate_class_ffi()
    diagrams["architecture"] = generate_arch_ffi()
    return diagrams

fn embed_diagrams_in_markdown(diagrams: Dict<text, text>) -> text:
    return "```mermaid\n" + diagrams.get("sequence", "") + "\n```"

fn get_diagram_path(test_name: text, diagram_type: DiagramType) -> text:
    return _diagram_output_dir + "/" + test_name + ".mmd"

# Exports
export enable_diagrams, enable_all_diagrams, disable_diagrams, is_diagram_enabled
export set_diagram_output, set_test_context, clear_test_context
export with_seq_diagram, with_class_diagram, with_arch_diagram, with_all_diagram_types
export traced_it
export generate_diagrams_for_spec, embed_diagrams_in_markdown, get_diagram_path
