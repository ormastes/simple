# Skinning - Skinned mesh for skeletal animation
#
# Mesh with bone weights for GPU skinning.

pub use SkinnedMesh, SkinData, Vec4i

use graphics.math.*
use graphics.scene.mesh.*
use skeleton.*

# =============================================================================
# Skinned Mesh - Mesh with bone weights
# =============================================================================

pub struct SkinnedMesh:
    mesh: Mesh
    skeleton: Skeleton
    skin_data: SkinData

pub struct SkinData:
    bone_indices: Array<Vec4i>        # 4 bone indices per vertex
    bone_weights: Array<Vec4>         # 4 weights per vertex (sum = 1.0)

pub struct Vec4i:
    x: i32
    y: i32
    z: i32
    w: i32

impl SkinnedMesh:
    pub fn new(mesh: Mesh, skeleton: Skeleton, skin_data: SkinData) -> SkinnedMesh:
        return SkinnedMesh {
            mesh: mesh,
            skeleton: skeleton,
            skin_data: skin_data
        }

    # Upload skinning data to GPU
    pub fn upload_skin_data(self) -> u64:
        # Create GPU buffer with bone indices and weights
        return extern_create_skin_buffer(
            &self.skin_data.bone_indices,
            &self.skin_data.bone_weights
        )

    # Render with skinning
    pub fn render(
        self,
        skinning_matrices: &Array<Mat4>,
        material: &Material,
        view_proj: Mat4
    ):
        # Upload skinning matrices to GPU
        extern_upload_skinning_matrices(skinning_matrices)

        # Render mesh with skinning shader
        extern_render_skinned_mesh(
            self.mesh.get_id(),
            self.upload_skin_data(),
            material.get_id(),
            view_proj
        )

# =============================================================================
# External FFI Functions
# =============================================================================

extern fn extern_create_skin_buffer(
    bone_indices: &Array<Vec4i>,
    bone_weights: &Array<Vec4>
) -> u64

extern fn extern_upload_skinning_matrices(matrices: &Array<Mat4>)

extern fn extern_render_skinned_mesh(
    mesh_id: u64,
    skin_buffer_id: u64,
    material_id: u64,
    view_proj: Mat4
)
