# VulkanDeviceManager - Singleton Vulkan device manager
#
# Provides shared Vulkan device for both 2D UI and 3D graphics rendering.
# Ensures only one device is created and properly shared.
#
# Based on: doc/plans/floating-booping-coral.md (3D Graphics Library)

use core.*
use ui.gui.vulkan_device.*

# =============================================================================
# VulkanDeviceManager - Singleton pattern for Vulkan device
# =============================================================================

# Global singleton instance (lazy initialization)
static mut DEVICE_MANAGER: Option<VulkanDeviceManager> = None

pub struct VulkanDeviceManager:
    device: VulkanDevice
    ref_count: i32

impl VulkanDeviceManager:
    # Get or create the singleton instance
    pub fn get() -> VulkanDeviceManager:
        unsafe:
            match DEVICE_MANAGER:
                case Some(manager):
                    # Increment reference count
                    manager.ref_count = manager.ref_count + 1
                    return manager
                case None:
                    # Create new instance
                    val device = VulkanDevice.new()
                    val manager = VulkanDeviceManager {device: device, ref_count: 1}
                    DEVICE_MANAGER = Some(manager)
                    return manager

    # Get the Vulkan device
    pub fn device(self) -> VulkanDevice:
        return self.device

    # Release a reference
    pub fn release(mut self):
        self.ref_count = self.ref_count - 1
        if self.ref_count <= 0:
            unsafe:
                # Clean up the singleton
                DEVICE_MANAGER = None

    # Check if device is initialized
    pub fn is_initialized() -> bool:
        unsafe:
            return DEVICE_MANAGER.is_some()

    # Get reference count
    pub fn get_ref_count(self) -> i32:
        return self.ref_count

# =============================================================================
# DeviceHandle - RAII wrapper for automatic cleanup
# =============================================================================

pub struct DeviceHandle:
    manager: VulkanDeviceManager

impl DeviceHandle:
    pub fn new() -> DeviceHandle:
        return DeviceHandle {
            manager: VulkanDeviceManager.get()
        }

    pub fn device(self) -> VulkanDevice:
        return self.manager.device()

    # Explicit cleanup
    pub fn release(mut self):
        self.manager.release()

# Automatic cleanup when handle goes out of scope
impl Drop for DeviceHandle:
    me drop():
        self.manager.release()
