# SDN Error Types
# Provides error handling for SDN parsing and document operations

# Source location in SDN document
struct Span:
    start: i32
    end: i32
    line: i32
    column: i32

impl Span:
    static fn new(start: i32, end: i32, line: i32, column: i32) -> Span:
        return Span(start: start, end: end, line: line, column: column)

    static fn default() -> Span:
        return Span.new(0, 0, 1, 1)

    fn to_string() -> text:
        return "{self.line}:{self.column}"

    fn is_empty() -> bool:
        return self.start == self.end

    fn len() -> i32:
        return self.end - self.start

    fn contains(pos: i32) -> bool:
        return pos >= self.start and pos < self.end

    fn overlaps(other: Span) -> bool:
        return self.start < other.end and other.start < self.end

    fn merge(other: Span) -> Span:
        val min_start = if self.start < other.start: self.start else: other.start
        val max_end = if self.end > other.end: self.end else: other.end
        return Span(start: min_start, end: max_end, line: self.line, column: self.column)

# SDN parse and document errors
enum SdnError:
    SyntaxError(text, i32, i32)
    UnexpectedToken(text, text, Span)
    UnexpectedEof
    InvalidNumber(text)
    UnclosedString
    InvalidIndentation(i32)
    InvalidEscape(text)
    PathNotFound(text)
    TypeMismatch(text, text)
    InvalidTableRow(i32, i32)
    IoError(text)

impl SdnError:
    fn to_string() -> text:
        match self:
            case SyntaxError(msg, line, col):
                return "Syntax error at {line}:{col}: {msg}"
            case UnexpectedToken(exp, found, span):
                val loc = span.to_string()
                return "Unexpected token at {loc}: expected {exp}, found {found}"
            case UnexpectedEof:
                return "Unexpected end of file"
            case InvalidNumber(lit):
                return "Invalid number literal: {lit}"
            case UnclosedString:
                return "Unclosed string literal"
            case InvalidIndentation(line):
                return "Invalid indentation at line {line}"
            case InvalidEscape(seq):
                return "Invalid escape sequence: {seq}"
            case PathNotFound(path):
                return "Path not found: {path}"
            case TypeMismatch(exp, found):
                return "Type mismatch: expected {exp}, found {found}"
            case InvalidTableRow(exp, found):
                return "Invalid table row: expected {exp} columns, found {found}"
            case IoError(msg):
                return "I/O error: {msg}"

# Helper functions for creating errors
fn syntax_error(message: text, line: i32, column: i32) -> SdnError:
    return SdnError.SyntaxError(message, line, column)

fn syntax_error_with_span(message: text, span: Span) -> SdnError:
    return SdnError.SyntaxError(message, span.line, span.column)

fn unexpected_token(expected: text, found: text, span: Span) -> SdnError:
    return SdnError.UnexpectedToken(expected, found, span)
