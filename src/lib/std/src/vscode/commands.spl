# VSCode Commands API
# Register and execute commands

# External FFI declarations
extern fn vscode_commands_register(command: text, callback_id: i64): i64
extern fn vscode_commands_execute(command: text, args_json: text): text
extern fn vscode_commands_get_commands(): text

# Command callback registry
val command_callbacks: Dict<text, fn(args: List<text>): void> = {}
val next_callback_id: i64 = 0

# Extension context for subscriptions
pub class ExtensionContext:
    pub subscriptions: List<i64>
    pub workspace_state: Dict<text, text>
    pub global_state: Dict<text, text>

    pub fn new(): ExtensionContext =
        """Create new extension context."""
        ExtensionContext {
            subscriptions: [],
            workspace_state: {},
            global_state: {}
        }

    pub fn push(self, subscription_id: i64):
        """Add a subscription to be disposed on deactivation."""
        self.subscriptions.append(subscription_id)

# Register a command
pub fn register_command(command: text, handler: fn(args: List<text>): void): i64 =
    """Register a command handler.

    Args:
        command: Command ID (e.g., "simple.formatDocument")
        handler: Function to call when command executed

    Returns:
        Subscription ID for disposal

    Example:
        sub_id = commands.register_command("simple.hello", fn(args):
            window.show_message("Hello from Simple!")
        )
    """
    # Store callback
    val callback_id = next_callback_id
    next_callback_id = next_callback_id + 1

    command_callbacks[command] = handler

    # Register with VSCode
    vscode_commands_register(command, callback_id)

# Execute a command
pub fn execute_command(command: text, args: List<text>): text =
    """Execute a VSCode command.

    Args:
        command: Command ID
        args: Command arguments

    Returns:
        Result from command (JSON string)

    Example:
        # Execute built-in command
        commands.execute_command("editor.action.formatDocument", [])

        # Execute custom command
        commands.execute_command("simple.analyze", ["file.spl"])
    """
    # Serialize args to JSON
    val args_json = "[" + args.map(fn(arg): '"' + arg + '"').join(",") + "]"

    vscode_commands_execute(command, args_json)

# Get all registered commands
pub fn get_commands(): List<text> =
    """Get list of all registered commands.

    Returns:
        List of command IDs
    """
    use core.json.{parse, JsonValue}

    val json = vscode_commands_get_commands()

    # Parse JSON array
    var commands: List<text> = []
    match parse(json):
        case Ok(JsonValue.Array(items)):
            for item in items:
                if val JsonValue.String(s) = item:
                    commands.append(s)
        case _:
            pass
    commands

# Trigger callback from FFI
pub fn _trigger_callback(callback_id: i64, args_json: text):
    """Internal: Called by FFI when command executed."""
    # Find command by callback ID
    for command, handler in command_callbacks.items():
        # Parse args from JSON array
        import core.json.{parse, JsonValue}

        var args: List<text> = []

        # Parse JSON array: ["arg1", "arg2", ...]
        match parse(args_json):
            case Ok(JsonValue.Array(items)):
                for item in items:
                    if val JsonValue.String(s) = item:
                        args.append(s)
                    elif val JsonValue.Number(n) = item:
                        args.append(n.to_string())
                    elif val JsonValue.Boolean(b) = item:
                        args.append(if b: "true" else: "false")
            case Ok(JsonValue.String(s)):
                # Single string argument
                args.append(s)
            case _:
                # Invalid JSON - use raw string
                if args_json.len() > 0:
                    args.append(args_json)

        handler(args)
