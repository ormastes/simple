# Error - Error trait and common error types
#
# Provides the core Error trait for error handling.

# Core error trait
trait Error:
    # Get error message
    fn message() -> text

    # Get optional error source/cause
    fn source() -> Option<Error>:
        return Option.none()

    # Get error chain as list of messages
    fn chain() -> List<text>:
        var messages: List<text> = [self.message()]
        var current = self.source()
        while current.is_some():
            messages.push(current.unwrap().message())
            current = current.unwrap().source()
        return messages

# Generic error with message
struct GenericError:
    msg: text
    cause: Option<Error>

    static fn new(msg: text) -> GenericError:
        return GenericError(msg: msg, cause: Option.none())

    static fn with_cause(msg: text, cause: Error) -> GenericError:
        return GenericError(msg: msg, cause: Option.some(cause))

impl GenericError: Error:
    fn message() -> text:
        return self.msg

    fn source() -> Option<Error>:
        return self.cause

# IO Error types
enum IoErrorKind:
    NotFound
    PermissionDenied
    ConnectionRefused
    ConnectionReset
    ConnectionAborted
    NotConnected
    AddrInUse
    AddrNotAvailable
    BrokenPipe
    Duplicate
    WouldBlock
    InvalidInput
    InvalidData
    TimedOut
    WriteZero
    Interrupted
    UnexpectedEof
    Other

struct IoError:
    kind: IoErrorKind
    msg: text

    static fn new(kind: IoErrorKind, msg: text) -> IoError:
        return IoError(kind: kind, msg: msg)

    static fn not_found(msg: text) -> IoError:
        return IoError(kind: IoErrorKind.NotFound, msg: msg)

    static fn permission_denied(msg: text) -> IoError:
        return IoError(kind: IoErrorKind.PermissionDenied, msg: msg)

    fn kind() -> IoErrorKind:
        return self.kind

impl IoError: Error:
    fn message() -> text:
        return self.msg

# Parse error for conversion failures
struct ParseError:
    msg: text
    input: text
    position: i64

    static fn new(msg: text, input: text, position: i64) -> ParseError:
        return ParseError(msg: msg, input: input, position: position)

impl ParseError: Error:
    fn message() -> text:
        return "{self.msg} at position {self.position}: '{self.input}'"

# Utility to convert any Error to text
fn error_to_string(err: Error) -> text:
    return err.message()

# Utility to create error chain message
fn error_chain_string(err: Error) -> text:
    return err.chain().join(" caused by: ")

export Error, GenericError, IoError, IoErrorKind, ParseError
export error_to_string, error_chain_string
