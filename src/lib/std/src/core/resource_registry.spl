# ResourceRegistry - Global tracking of open resources for leak detection
#
# This module provides a global registry for tracking resources that implement
# the Resource trait. It enables detection of resource leaks at runtime,
# particularly useful in tests and debugging.
#
# ## How It Works
#
# 1. When a resource is created, it registers itself with `ResourceRegistry.register()`
# 2. The registry assigns a unique ID and stores metadata about the resource
# 3. When the resource is closed, it calls `ResourceRegistry.unregister()`
# 4. At any point, you can call `check_leaks()` to see unclosed resources
#
# ## Basic Usage
#
# ```simple
# use core.resource_registry.ResourceRegistry
#
# # In resource implementations:
# val id = ResourceRegistry.register("File", "File.open(\"test.txt\")")
# # ... when closing:
# ResourceRegistry.unregister(id)
#
# # In tests:
# val leaks = ResourceRegistry.check_leaks()
# if leaks.len() > 0:
#     print "WARNING: Resource leaks detected!"
#     print ResourceRegistry.leak_report()
# ```
#
# ## Using LeakTracked Mixin
#
# For automatic tracking, use the LeakTracked mixin instead of
# calling ResourceRegistry directly:
#
# ```simple
# use core.leak_tracked.LeakTracked
#
# struct MyResource with LeakTracked:
#     handle: i64
#
# impl MyResource:
#     static fn open() -> MyResource:
#         var r = MyResource(handle: ...)
#         r._start_tracking("MyResource.open()")
#         return r
#
#     fn close():
#         self._stop_tracking()
#         ...
# ```
#
# ## Thread Safety
#
# The registry is thread-safe and can be accessed from multiple threads.
# The underlying implementation uses Rust's thread-safe data structures.
#
# ## See Also
#
# - `core.resource` - Resource trait definition
# - `core.leak_tracked` - LeakTracked mixin for automatic tracking
# - `doc/guide/resource_cleanup.md` - User guide

use core.option.Option
use core.result.Result
use core.list.List

# Entry in the resource registry
struct ResourceEntry:
    id: i64
    resource_name: text
    location: text         # Source location where resource was created
    created_at: i64        # Timestamp when registered (for debugging)

impl ResourceEntry:
    fn new(id: i64, resource_name: text, location: text) -> ResourceEntry:
        ResourceEntry(
            id: id,
            resource_name: resource_name,
            location: location,
            created_at: __native_time_now()
        )

    fn to_string() -> text:
        "{self.resource_name} created at {self.location}"

# Global registry for tracking resources
# Uses FFI for thread-safe, efficient implementation
struct ResourceRegistry:
    # Empty struct - all methods are static

impl ResourceRegistry:
    # Register a resource for tracking
    # Returns a unique ID for later unregistration
    static fn register(resource_name: text, location: text) -> i64:
        __native_resource_registry_register(resource_name, location)

    # Unregister a resource (call when closed)
    static fn unregister(id: i64):
        __native_resource_registry_unregister(id)

    # Get all currently open resources
    static fn get_open_resources() -> List<ResourceEntry>:
        __native_resource_registry_get_all()

    # Check for leaks - returns list of unclosed resources
    static fn check_leaks() -> List<ResourceEntry>:
        ResourceRegistry.get_open_resources()

    # Close all tracked resources (emergency cleanup)
    static fn close_all():
        __native_resource_registry_close_all()

    # Clear the registry (for testing)
    static fn clear():
        __native_resource_registry_clear()

    # Get a human-readable leak report
    static fn leak_report() -> text:
        val leaks = ResourceRegistry.check_leaks()
        if leaks.len() == 0:
            return "No resource leaks detected."

        var report = "Resource Leaks Detected ({leaks.len()}):\n"
        for entry in leaks:
            report = report + "  - {entry.to_string()}\n"
        return report


# Native FFI declarations
extern fn __native_resource_registry_register(resource_name: text, location: text) -> i64
extern fn __native_resource_registry_unregister(id: i64)
extern fn __native_resource_registry_get_all() -> List<ResourceEntry>
extern fn __native_resource_registry_close_all()
extern fn __native_resource_registry_clear()
extern fn __native_time_now() -> i64
