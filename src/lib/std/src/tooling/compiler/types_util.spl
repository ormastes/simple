//! Type conversion utilities shared between AOT and JIT codegen.
//!
//! This module provides type mapping functions that convert Simple language
//! types (TypeId) to their native machine representations (CraneliftType)
//! for efficient code generation.

/// Simple language type identifier (maps to HIR TypeId).
///
/// Uses u32 internally for compact representation.
/// Built-in types occupy IDs 0-13.
struct TypeId:
    id: u32

impl TypeId:
    /// Built-in type constants (match HIR definitions)
    static fn VOID() -> TypeId:
        TypeId(id: 0)

    static fn BOOL() -> TypeId:
        TypeId(id: 1)

    static fn I8() -> TypeId:
        TypeId(id: 2)

    static fn I16() -> TypeId:
        TypeId(id: 3)

    static fn I32() -> TypeId:
        TypeId(id: 4)

    static fn I64() -> TypeId:
        TypeId(id: 5)

    static fn U8() -> TypeId:
        TypeId(id: 6)

    static fn U16() -> TypeId:
        TypeId(id: 7)

    static fn U32() -> TypeId:
        TypeId(id: 8)

    static fn U64() -> TypeId:
        TypeId(id: 9)

    static fn F32() -> TypeId:
        TypeId(id: 10)

    static fn F64() -> TypeId:
        TypeId(id: 11)

    static fn STRING() -> TypeId:
        TypeId(id: 12)

    static fn NIL() -> TypeId:
        TypeId(id: 13)

    fn equals(other: TypeId) -> bool:
        self.id == other.id

/// Cranelift IR type representation.
///
/// Subset of Cranelift types used for Simple codegen.
enum CraneliftType:
    I8
    I16
    I32
    I64
    F32
    F64

impl CraneliftType:
    fn to_string() -> text:
        match self:
            CraneliftType.I8:
                "i8"
            CraneliftType.I16:
                "i16"
            CraneliftType.I32:
                "i32"
            CraneliftType.I64:
                "i64"
            CraneliftType.F32:
                "f32"
            CraneliftType.F64:
                "f64"

/// Convert TypeId to Cranelift type for zero-cost codegen.
///
/// This maps Simple language types to their native machine representations
/// for efficient codegen without RuntimeValue boxing.
///
/// # Type Mappings
/// - VOID → I64 (use I64 for void, no actual value)
/// - BOOL → I8
/// - I8/U8 → I8
/// - I16/U16 → I16
/// - I32/U32/F32 → I32/F32
/// - I64/U64/F64 → I64/F64
/// - STRING → I64 (pointer)
/// - NIL → I64 (tagged value)
/// - Others → I64 (RuntimeValue)
fn type_id_to_cranelift(type_id: TypeId) -> CraneliftType:
    if type_id.equals(TypeId.VOID()):
        CraneliftType.I64
    else if type_id.equals(TypeId.BOOL()):
        CraneliftType.I8
    else if type_id.equals(TypeId.I8()) or type_id.equals(TypeId.U8()):
        CraneliftType.I8
    else if type_id.equals(TypeId.I16()) or type_id.equals(TypeId.U16()):
        CraneliftType.I16
    else if type_id.equals(TypeId.I32()) or type_id.equals(TypeId.U32()):
        CraneliftType.I32
    else if type_id.equals(TypeId.I64()) or type_id.equals(TypeId.U64()):
        CraneliftType.I64
    else if type_id.equals(TypeId.F32()):
        CraneliftType.F32
    else if type_id.equals(TypeId.F64()):
        CraneliftType.F64
    else if type_id.equals(TypeId.STRING()) or type_id.equals(TypeId.NIL()):
        CraneliftType.I64
    else:
        CraneliftType.I64  # All other types (objects, closures, arrays) use I64

/// Get the size in bytes for a TypeId.
///
/// Returns the native size of the type for memory layout calculations.
///
/// # Sizes
/// - VOID: 0 bytes
/// - BOOL/I8/U8: 1 byte
/// - I16/U16: 2 bytes
/// - I32/U32/F32: 4 bytes
/// - I64/U64/F64/STRING/NIL: 8 bytes
/// - Others: 8 bytes (pointer-sized)
fn type_id_size(type_id: TypeId) -> u32:
    if type_id.equals(TypeId.VOID()):
        0
    else if type_id.equals(TypeId.BOOL()) or type_id.equals(TypeId.I8()) or type_id.equals(TypeId.U8()):
        1
    else if type_id.equals(TypeId.I16()) or type_id.equals(TypeId.U16()):
        2
    else if type_id.equals(TypeId.I32()) or type_id.equals(TypeId.U32()) or type_id.equals(TypeId.F32()):
        4
    else if type_id.equals(TypeId.I64()) or type_id.equals(TypeId.U64()) or type_id.equals(TypeId.F64()):
        8
    else if type_id.equals(TypeId.STRING()) or type_id.equals(TypeId.NIL()):
        8
    else:
        8  # All other types are pointer-sized

/// Convert TypeId to Cranelift type for function signatures.
///
/// This maps types to their native ABI representation for function calls.
/// Note: BOOL uses I8 for native ABI compatibility.
///
/// # ABI Mappings
/// - VOID → I64 (void returns use I64 for ABI compatibility)
/// - BOOL → I8
/// - I8/U8 → I8
/// - I16/U16 → I16
/// - I32/U32 → I32
/// - I64/U64 → I64
/// - F32 → F32
/// - F64 → F64
/// - STRING/NIL → I64 (pointers)
/// - Custom types → I64 (default pointer-sized)
fn type_to_cranelift(ty: TypeId) -> CraneliftType:
    type_id_to_cranelift(ty)  # Same mapping as type_id_to_cranelift
