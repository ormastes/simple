# Test discovery and summarization
# Migrated from: src/driver/src/cli/test_runner/discovery.rs
# Purpose: Print test discovery summaries

use super.test_discovery.is_test_file
use super.test_args.TestOptions

# Print test discovery summary
fn print_discovery_summary(test_files: List<text>, options: TestOptions, quiet: bool):
    if quiet:
        return

    val spec_count = test_files
        .iter()
        .filter(\p: get_filename(p).ends_with("_spec.spl"))
        .count()
    val test_count = test_files.len() - spec_count

    println "───────────────────────────────────────────────────────────────"
    println "Test Discovery"
    println "───────────────────────────────────────────────────────────────"
    println "  Spec files (*_spec.spl):  {spec_count}"
    println "  Test files (*_test.spl):  {test_count}"

    # Count doctests if enabled
    print_doctest_counts(options)

    println "───────────────────────────────────────────────────────────────"
    println ""

# Print doctest counts
fn print_doctest_counts(options: TestOptions):
    if not options.doctest_src and not options.doctest_doc and not options.doctest_md:
        return

    val cwd = get_current_dir()

    if options.doctest_src:
        val src_dir = options.doctest_src_dir
            .unwrap_or("{cwd}/simple/std_lib/src")

        if is_directory(src_dir):
            match discover_doctests(src_dir):
                Ok(examples) =>
                    println "  Src doctests (.spl):      {examples.len()}"
                Err(_) =>
                    {}

    if options.doctest_doc:
        val doc_dir = options.doctest_doc_dir
            .unwrap_or("{cwd}/doc")

        if is_directory(doc_dir):
            match discover_doctests(doc_dir):
                Ok(examples) =>
                    println "  Doc doctests (.md):       {examples.len()}"
                Err(_) =>
                    {}

    if options.doctest_md:
        val md_dir = options.doctest_md_dir
            .unwrap_or("{cwd}/doc")

        if is_directory(md_dir):
            match discover_md_doctests(md_dir):
                Ok(examples) =>
                    println "  MD doctests (README.md):  {examples.len()}"
                Err(_) =>
                    {}


# ===================================================================
# Stub functions
# ===================================================================

fn get_filename(path: text) -> text:
    val parts = path.split("/")
    if parts.len() > 0:
        parts[parts.len() - 1]
    else:
        path

fn get_current_dir() -> text:
    # Stub: would get current working directory
    "."

fn is_directory(path: text) -> bool:
    # Stub: would check if path is a directory
    not path.contains(".")

fn discover_doctests(dir: text) -> Result<List<text>, text>:
    # Stub: would discover doctests in .spl files
    Ok([])

fn discover_md_doctests(dir: text) -> Result<List<text>, text>:
    # Stub: would discover doctests in .md files
    Ok([])
