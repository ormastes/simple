# Feature database update utilities
# Migrated from: src/driver/src/cli/test_runner/feature_db.rs
# Purpose: Handle updating the feature database from test results

# Update feature database from test results
fn update_feature_database(test_files: List<text>, results: List<TestFileResult>, total_failed: i32) -> UpdateResult:
    val feature_db_path = "doc/features/feature_db.sdn"

    # Filter for SSpec files
    val sspec_files = test_files.filter(\path: is_sspec_file(path))

    # Find failed specs
    val failed_specs = results
        .filter(\result: result.failed > 0 or result.error.is_some())
        .map(\result: result.path)

    # Update feature database
    match update_feature_db_from_sspec(feature_db_path, sspec_files, failed_specs):
        Err(e) =>
            # Add error result
            val new_total_failed = total_failed + 1
            val error_result = TestFileResult(
                path: feature_db_path,
                passed: 0,
                failed: 1,
                duration_ms: 0,
                error: Some("feature db update failed: {e}")
            )
            UpdateResult(
                total_failed: new_total_failed,
                results: results.append(error_result)
            )
        Ok(_) =>
            UpdateResult(
                total_failed: total_failed,
                results: results
            )

# Helper: Check if path is SSpec file
fn is_sspec_file(path: text) -> bool:
    get_filename(path).ends_with("_spec.spl")

# Helper: Get filename from path
fn get_filename(path: text) -> text:
    val parts = path.split("/")
    if parts.len() > 0:
        parts[parts.len() - 1]
    else:
        path


# Stub types and functions
# NOTE: Placeholder - integrate with test_runner module when available

struct TestFileResult:
    path: text
    passed: i32
    failed: i32
    duration_ms: i32
    error: Option<text>

struct UpdateResult:
    total_failed: i32
    results: List<TestFileResult>

# Stub functions for feature database operations
fn update_feature_db_from_sspec(db_path: text, sspec_files: List<text>, failed_specs: List<text>) -> Result<text, text>:
    # Stub: would update feature database
    print "[feature_db] Would update {db_path} with {sspec_files.len()} specs (stub)"
    Ok("updated")
