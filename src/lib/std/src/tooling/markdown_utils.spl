# Markdown formatting utilities
# Generate Markdown text from structured data

use super.string_utils.{repeat, trim}
use super.list_utils.{map_list}

# =====================================
# Headers
# =====================================

# Create markdown header (# to ######)
fn heading(text: text, level: i32) -> text:
    val hashes = repeat("#", level)
    "{hashes} {text}"

fn h1(text: text) -> text:
    heading(text, 1)

fn h2(text: text) -> text:
    heading(text, 2)

fn h3(text: text) -> text:
    heading(text, 3)

fn h4(text: text) -> text:
    heading(text, 4)

fn h5(text: text) -> text:
    heading(text, 5)

fn h6(text: text) -> text:
    heading(text, 6)

# =====================================
# Text Formatting
# =====================================

# Bold text
fn bold(text: text) -> text:
    "**{text}**"

# Italic text
fn italic(text: text) -> text:
    "*{text}*"

# Bold and italic
fn bold_italic(text: text) -> text:
    "***{text}***"

# Inline code
fn code(text: text) -> text:
    "`{text}`"

# Strikethrough
fn strikethrough(text: text) -> text:
    "~~{text}~~"

# =====================================
# Links and Images
# =====================================

# Create markdown link
fn link(text: text, url: text) -> text:
    "[{text}]({url})"

# Create markdown image
fn image(alt_text: text, url: text) -> text:
    "![{alt_text}]({url})"

# Create link with title
fn link_with_title(text: text, url: text, title: text) -> text:
    "[{text}]({url} \"{title}\")"

# Reference-style link
fn reference_link(text: text, ref: text) -> text:
    "[{text}][{ref}]"

# =====================================
# Lists
# =====================================

# Unordered list
fn unordered_list(items: List<text>) -> text:
    var result = ""
    for item in items:
        result = result + "- {item}\n"
    result

# Ordered list
fn ordered_list(items: List<text>) -> text:
    var result = ""
    var i = 1
    for item in items:
        result = result + "{i}. {item}\n"
        i = i + 1
    result

# Nested unordered list
fn nested_unordered_list(items: List<text>, indent: i32) -> text:
    var result = ""
    val spaces = repeat(" ", indent * 2)
    for item in items:
        result = result + "{spaces}- {item}\n"
    result

# Checklist item
fn checklist_item(text: text, checked: bool) -> text:
    val checkbox = if checked: "[x]" else: "[ ]"
    "- {checkbox} {text}"

# =====================================
# Code Blocks
# =====================================

# Fenced code block
fn code_block(code: text, language: text) -> text:
    "```{language}\n{code}\n```"

# Code block without language
fn code_block_plain(code: text) -> text:
    "```\n{code}\n```"

# =====================================
# Blockquotes
# =====================================

# Single-line blockquote
fn blockquote(text: text) -> text:
    "> {text}"

# Multi-line blockquote
fn blockquote_multi(lines: List<text>) -> text:
    var result = ""
    for line in lines:
        result = result + "> {line}\n"
    result

# =====================================
# Horizontal Rules
# =====================================

# Horizontal rule
fn horizontal_rule() -> text:
    "---"

fn hr() -> text:
    horizontal_rule()

# =====================================
# Tables
# =====================================

# Create markdown table
fn table(headers: List<text>, rows: List<List<text>>) -> text:
    var result = ""

    # Header row
    result = result + "| " + headers.join(" | ") + " |\n"

    # Separator row
    result = result + "| "
    for _ in headers:
        result = result + "--- | "
    result = result + "\n"

    # Data rows
    for row in rows:
        result = result + "| " + row.join(" | ") + " |\n"

    result

# Table with alignment
enum TableAlign:
    Left
    Center
    Right

fn table_with_align(
    headers: List<text>,
    rows: List<List<text>>,
    alignments: List<TableAlign>
) -> text:
    var result = ""

    # Header row
    result = result + "| " + headers.join(" | ") + " |\n"

    # Separator row with alignment
    result = result + "| "
    for align in alignments:
        val sep = match align:
            TableAlign.Left => ":---"
            TableAlign.Center => ":---:"
            TableAlign.Right => "---:"
        result = result + sep + " | "
    result = result + "\n"

    # Data rows
    for row in rows:
        result = result + "| " + row.join(" | ") + " |\n"

    result

# =====================================
# Task Lists
# =====================================

# Create task list
fn task_list(tasks: List<(text, bool)>) -> text:
    var result = ""
    for (task_text, is_done) in tasks:
        result = result + checklist_item(task_text, is_done) + "\n"
    result

# =====================================
# Definitions
# =====================================

# Definition list item
fn definition(term: text, description: text) -> text:
    "{term}\n: {description}"

# =====================================
# Footnotes
# =====================================

# Footnote reference
fn footnote_ref(id: text) -> text:
    "[^{id}]"

# Footnote definition
fn footnote_def(id: text, text: text) -> text:
    "[^{id}]: {text}"

# =====================================
# Document Structure
# =====================================

# Front matter (YAML)
fn front_matter(yaml: text) -> text:
    "---\n{yaml}\n---"

# Table of contents marker
fn toc() -> text:
    "<!-- TOC -->"

# =====================================
# Helpers
# =====================================

# Escape markdown special characters
fn escape_markdown(text: text) -> text:
    text
        .replace("\\", "\\\\")
        .replace("*", "\\*")
        .replace("_", "\\_")
        .replace("#", "\\#")
        .replace("[", "\\[")
        .replace("]", "\\]")
        .replace("(", "\\(")
        .replace(")", "\\)")

# Create document from sections
struct MarkdownSection:
    heading: text
    level: i32
    content: text

fn document(sections: List<MarkdownSection>) -> text:
    var result = ""

    for section in sections:
        # Add heading
        result = result + heading(section.heading, section.level) + "\n\n"

        # Add content
        result = result + section.content + "\n\n"

    result

# =====================================
# Common Patterns
# =====================================

# Create README structure
fn readme_template(
    title: text,
    description: text,
    installation: text,
    usage: text
) -> text:
    var doc = h1(title) + "\n\n"
    doc = doc + description + "\n\n"
    doc = doc + h2("Installation") + "\n\n"
    doc = doc + installation + "\n\n"
    doc = doc + h2("Usage") + "\n\n"
    doc = doc + usage + "\n\n"
    doc

# Badge
fn badge(label: text, value: text, color: text) -> text:
    "![{label}](https://img.shields.io/badge/{label}-{value}-{color})"

# Alert/Admonition
fn alert(type: text, message: text) -> text:
    "> **{type.to_uppercase()}:** {message}"

fn note(message: text) -> text:
    alert("Note", message)

fn warning(message: text) -> text:
    alert("Warning", message)

fn important(message: text) -> text:
    alert("Important", message)
