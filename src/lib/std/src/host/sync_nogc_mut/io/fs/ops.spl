# File System Operations - Sync NoGC Mutable Variant
# Testing what causes hang

export read_text, write_text, exists, append_text, read_text_result

import units.size.ByteCount

extern fn native_fs_read_string(path: str) -> str
extern fn native_fs_write_string(path: str, content: str) -> i32
extern fn native_fs_exists(path: str) -> bool

type FilePath = str

enum IoError:
    NotFound
    Other(str)

impl IoError:
    # =========================================================================
    # Helper Methods
    # =========================================================================

    fn is_not_found() -> bool:
        """Check if this is NotFound error.

        Returns:
            true for NotFound

        Example:
            IoError.NotFound.is_not_found()  # → true
            IoError.Other("err").is_not_found()  # → false
        """
        match self:
            case NotFound: true
            case _: false

    fn is_other() -> bool:
        """Check if this is Other error.

        Returns:
            true for Other

        Example:
            IoError.Other("err").is_other()  # → true
        """
        match self:
            case Other(_): true
            case _: false

    fn to_string() -> str:
        """Convert error to string.

        Returns:
            Error name

        Example:
            IoError.NotFound.to_string()  # → "not_found"
        """
        match self:
            case NotFound: "not_found"
            case Other(_): "other"

    fn description() -> str:
        """Get detailed error description.

        Returns:
            Human-readable description

        Example:
            IoError.NotFound.description()
            # → "File or directory not found"
        """
        match self:
            case NotFound: "File or directory not found"
            case Other(msg): msg

    fn message() -> str:
        """Get error message (alias for description)."""
        return self.description()

    fn summary() -> str:
        """Get comprehensive error summary.

        Returns:
            Human-readable summary

        Example:
            IoError.NotFound.summary()
            # → "IoError: not_found (File or directory not found)"
        """
        val name = self.to_string()
        val desc = self.description()
        return "IoError: {name} ({desc})"

pub fn read_text(path: FilePath) -> str:
    return native_fs_read_string(path)

pub fn write_text(path: FilePath, text: str) -> Result<ByteCount, IoError>:
    """Write text to file.

    Returns:
        Ok(bytes_written) on success, Err on failure
    """
    val result = native_fs_write_string(path, text)
    if result < 0:
        return Err(IoError.Other("Write failed"))
    val bytes_val = (result as u64)
    return Ok(bytes_val_bytes)

pub fn exist(path: FilePath) -> bool:
    return native_fs_exists(path)

# Test: function with match expression
pub fn append_text(path: FilePath, text: str) -> Result<ByteCount, IoError>:
    """Append text to file.

    Returns:
        Ok(bytes_written) on success, Err on failure
    """
    val existing = read_text(path)
    val combined = match existing:
        "" => text
        _ => existing + text
    return write_text(path, combined)

# Test: function returning Result
pub fn read_text_result(path: FilePath) -> Result<str, IoError>:
    if exist(path):
        return Ok(read_text(path))
    else:
        return Err(IoError.NotFound)
