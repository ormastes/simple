# Common File System Operations
#
# High-level file system operations shared across all host variants.

use units.file.*
use units.size.*
use host.common.io.error.IoError
use host.common.io.types.*
use host.common.io.fs_ffi.*

export read, read_text, write, write_text, append, append_text
export create_dir, create_dir_all, remove, remove_dir, remove_dir_all
export rename, copy, exists, metadata, read_dir
export read_sync, read_text_sync, write_sync, write_text_sync
export exists_sync, metadata_sync

# ===============================
# File System Operations
# ===============================

# Read entire file as bytes
@fs
pub async fn read(path: FilePath) -> Result<Bytes, IoError>:
    return native_fs_read(path)

# Read entire file as text (UTF-8)
@fs
pub async fn read_text(path: FilePath) -> Result<Text, IoError>:
    val bytes = await read(path)?
    match bytes.to_utf8():
        case Ok(s): return Ok(s_text)
        case Err(_): return Err(IoError::InvalidData)

# Write bytes to file (creates or overwrites)
@fs
pub async fn write(path: FilePath, data: &Bytes) -> Result<ByteCount, IoError>:
    return native_fs_write(path, data)

# Write text to file (UTF-8)
@fs
pub async fn write_text(path: FilePath, text: &Text) -> Result<ByteCount, IoError>:
    val bytes = (text as str).to_bytes()
    return await write(path, &bytes)

# Append bytes to file
@fs
pub async fn append(path: FilePath, data: &Bytes) -> Result<ByteCount, IoError>:
    return native_fs_append(path, data)

# Append text to file
@fs
pub async fn append_text(path: FilePath, text: &Text) -> Result<ByteCount, IoError>:
    val bytes = (text as str).to_bytes()
    return await append(path, &bytes)

# ===============================
# Directory Operations
# ===============================

# Create directory
@fs
pub async fn create_dir(path: DirPath) -> Result<(), IoError>:
    return native_fs_create_dir(path, false)

# Create directory and all parent directories
@fs
pub async fn create_dir_all(path: DirPath) -> Result<(), IoError>:
    return native_fs_create_dir(path, true)

# Remove file
@fs
pub async fn remove(path: FilePath) -> Result<(), IoError>:
    return native_fs_remove_file(path)

# Remove empty directory
@fs
pub async fn remove_dir(path: DirPath) -> Result<(), IoError>:
    return native_fs_remove_dir(path, false)

# Remove directory and all contents
@fs
pub async fn remove_dir_all(path: DirPath) -> Result<(), IoError>:
    return native_fs_remove_dir(path, true)

# Rename file or directory
@fs
pub async fn rename(src: FilePath, dst: FilePath) -> Result<(), IoError>:
    return native_fs_rename(src, dst)

# Copy file (standard method)
@fs
pub async fn copy(src: FilePath, dst: FilePath) -> Result<ByteCount, IoError>:
    return native_fs_copy(src, dst)

# ===============================
# Metadata Operations
# ===============================

# Check if path exists
@fs
pub async fn path_exists(path: FilePath) -> bool:
    match native_fs_metadata(path):
        case Ok(_): return true
        case Err(_): return false

# Get file metadata
@fs
pub async fn metadata(path: FilePath) -> Result<FileMetadata, IoError>:
    return native_fs_metadata(path)

# List directory contents
@fs
pub async fn read_dir(path: DirPath) -> Result<DirEntries, IoError>:
    return native_fs_read_dir(path)

# ===============================
# Synchronous File System Operations
# ===============================

# Read entire file as bytes (sync)
@fs
pub fn read_sync(path: FilePath) -> Result<Bytes, IoError>:
    return native_fs_read_sync(path)

# Read entire file as text (sync, UTF-8)
@fs
pub fn read_text_sync(path: FilePath) -> Result<Text, IoError>:
    val bytes = read_sync(path)?
    match bytes.to_utf8():
        case Ok(s): return Ok(s_text)
        case Err(_): return Err(IoError::InvalidData)

# Write bytes to file (sync, creates or overwrites)
@fs
pub fn write_sync(path: FilePath, data: &Bytes) -> Result<ByteCount, IoError>:
    return native_fs_write_sync(path, data)

# Write text to file (sync, UTF-8)
@fs
pub fn write_text_sync(path: FilePath, text: &Text) -> Result<ByteCount, IoError>:
    val bytes = (text as str).to_bytes()
    return write_sync(path, &bytes)

# Check if path exists (sync)
@fs
pub fn exists_sync(path: FilePath) -> bool:
    return native_file_exists_sync(path)

# Get file metadata (sync)
@fs
pub fn metadata_sync(path: FilePath) -> Result<FileMetadata, IoError>:
    return native_fs_metadata_sync(path)
