# Linear Algebra Operations
#
# Matrix operations including determinant, inverse, and linear system solving.
#
# ## Functions
# - `det(x)` - Matrix determinant
# - `inv(x)` - Matrix inverse
# - `solve(A, b)` - Solve linear system Ax = b
#
# ## Example
# ```simple
# import ml.torch as torch
# import ml.torch.linalg as linalg
#
# val A = torch.randn([10, 10])
# val b = torch.randn([10, 1])
#
# # Solve Ax = b
# val x = linalg.solve(A, b)
#
# # Compute determinant
# val det = linalg.det(A)
#
# # Compute inverse
# val A_inv = linalg.inv(A)
# ```

export det, inv, solve

import ml.torch.tensor_class.{Tensor}


# ============================================================================
# Linear Algebra Operations
# ============================================================================

fn det(x: Tensor) -> Tensor:
    """Compute matrix determinant.

    Computes the determinant of a square matrix.

    Args:
        x: Input square tensor (2D or batched 2D)

    Returns:
        Scalar tensor containing the determinant
    """
    val handle = @rt_torch_linalg_det(x.handle)
    if handle == 0:
        panic("Determinant computation failed")
    return Tensor(handle)


fn inv(x: Tensor) -> Tensor:
    """Compute matrix inverse.

    Computes the inverse of a square matrix.
    Will fail if matrix is singular (non-invertible).

    Args:
        x: Input square tensor (2D or batched 2D)

    Returns:
        Inverse matrix (same shape as input)
    """
    val handle = @rt_torch_linalg_inv(x.handle)
    if handle == 0:
        panic("Matrix inversion failed (singular matrix)")
    return Tensor(handle)


fn solve(A: Tensor, b: Tensor) -> Tensor:
    """Solve linear system Ax = b.

    Solves the linear system using LU decomposition.

    Args:
        A: Coefficient matrix (n x n or batched n x n)
        b: Right-hand side (n x m or batched n x m)

    Returns:
        Solution x (n x m or batched n x m)
    """
    val handle = @rt_torch_linalg_solve(A.handle, b.handle)
    if handle == 0:
        panic("Linear system solving failed")
    return Tensor(handle)


# ============================================================================
# External FFI Functions
# ============================================================================

extern fn rt_torch_linalg_det(x: u64) -> u64
extern fn rt_torch_linalg_inv(x: u64) -> u64
extern fn rt_torch_linalg_solve(A: u64, b: u64) -> u64
