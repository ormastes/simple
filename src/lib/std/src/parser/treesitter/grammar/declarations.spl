# Grammar Declarations
#
# Top-level declaration rules: function, class, struct, enum, trait, import.

import parser.treesitter.{Grammar}
import tokens.{TokenKind, token, ref, seq, choice, optional, field, repeat}

export add_declaration_rules

# Add all declaration rules to grammar
fn add_declaration_rules(grammar: Grammar):
    # Top-level declarations
    grammar.add_rule("declaration", choice([
        ref("function_def"),
        ref("class_def"),
        ref("struct_def"),
        ref("enum_def"),
        ref("trait_def"),
        ref("import_stmt")
    ]))

    # Function definition
    grammar.add_rule("function_def", seq([
        token(Fn),
        field("name", ref("identifier")),
        token(LParen),
        optional(ref("parameter_list")),
        token(RParen),
        optional(seq([token(Arrow), field("return_type", ref("type"))])),
        token(Colon),
        ref("block")
    ]))

    # Parameter list
    grammar.add_rule("parameter_list", seq([
        ref("parameter"),
        repeat(seq([token(Comma), ref("parameter")]))
    ]))

    # Parameter
    grammar.add_rule("parameter", seq([
        field("name", ref("identifier")),
        token(Colon),
        field("type", ref("type"))
    ]))

    # Class definition
    grammar.add_rule("class_def", seq([
        token(Class),
        field("name", ref("type_identifier")),
        optional(ref("type_parameters")),
        token(Colon),
        ref("class_block")
    ]))

    # Class block
    grammar.add_rule("class_block", seq([
        token(Newline),
        token(Indent),
        repeat(choice([
            ref("field_def"),
            ref("function_def"),
            token(Newline)
        ])),
        token(Dedent)
    ]))

    # Field definition
    grammar.add_rule("field_def", seq([
        field("name", ref("identifier")),
        token(Colon),
        field("type", ref("type")),
        token(Newline)
    ]))

    # Struct definition
    grammar.add_rule("struct_def", seq([
        token(Struct),
        field("name", ref("type_identifier")),
        optional(ref("type_parameters")),
        token(Colon),
        ref("struct_block")
    ]))

    # Struct block (same as class block)
    grammar.add_rule("struct_block", ref("class_block"))

    # Enum definition
    grammar.add_rule("enum_def", seq([
        token(Enum),
        field("name", ref("type_identifier")),
        optional(ref("type_parameters")),
        token(Colon),
        ref("enum_block")
    ]))

    # Enum block
    grammar.add_rule("enum_block", seq([
        token(Newline),
        token(Indent),
        repeat(choice([
            ref("enum_variant"),
            token(Newline)
        ])),
        token(Dedent)
    ]))

    # Enum variant
    grammar.add_rule("enum_variant", choice([
        field("name", ref("type_identifier")),
        seq([
            field("name", ref("type_identifier")),
            token(LParen),
            ref("type_list"),
            token(RParen)
        ]),
        seq([
            field("name", ref("type_identifier")),
            token(LBrace),
            ref("field_list"),
            token(RBrace)
        ])
    ]))

    # Trait definition
    grammar.add_rule("trait_def", seq([
        token(Trait),
        field("name", ref("type_identifier")),
        optional(ref("type_parameters")),
        token(Colon),
        ref("trait_block")
    ]))

    # Trait block
    grammar.add_rule("trait_block", seq([
        token(Newline),
        token(Indent),
        repeat(choice([
            ref("trait_method"),
            token(Newline)
        ])),
        token(Dedent)
    ]))

    # Trait method
    grammar.add_rule("trait_method", seq([
        token(Fn),
        field("name", ref("identifier")),
        token(LParen),
        optional(ref("parameter_list")),
        token(RParen),
        optional(seq([token(Arrow), field("return_type", ref("type"))])),
        token(Newline)
    ]))

    # Import statement
    grammar.add_rule("import_stmt", seq([
        token(Import),
        ref("import_path"),
        optional(seq([
            token(As),
            ref("identifier")
        ])),
        token(Newline)
    ]))

    # Import path
    grammar.add_rule("import_path", seq([
        ref("identifier"),
        repeat(seq([token(Dot), ref("identifier")]))
    ]))
