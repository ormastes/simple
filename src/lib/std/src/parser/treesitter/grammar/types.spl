# Grammar Types
#
# Type rules: named, generic, function, tuple, array, dict, option, result.

import parser.treesitter.{Grammar}
import tokens.{TokenKind, token, ref, seq, choice, optional, field, repeat}

export add_type_rules

# Add all type rules to grammar
fn add_type_rules(grammar: Grammar):
    # Types
    grammar.add_rule("type", choice([
        ref("named_type"),
        ref("generic_type"),
        ref("function_type"),
        ref("tuple_type"),
        ref("array_type"),
        ref("dict_type"),
        ref("option_type"),
        ref("result_type")
    ]))

    # Named type
    grammar.add_rule("named_type", ref("type_identifier"))

    # Generic type
    grammar.add_rule("generic_type", seq([
        field("name", ref("type_identifier")),
        token(Lt),
        ref("type_list"),
        token(Gt)
    ]))

    # Type list
    grammar.add_rule("type_list", seq([
        ref("type"),
        repeat(seq([token(Comma), ref("type")])),
        optional(token(Comma))
    ]))

    # Function type
    grammar.add_rule("function_type", seq([
        token(Fn),
        token(LParen),
        optional(ref("type_list")),
        token(RParen),
        token(Arrow),
        ref("type")
    ]))

    # Tuple type
    grammar.add_rule("tuple_type", seq([
        token(LParen),
        ref("type"),
        token(Comma),
        optional(ref("type_list")),
        token(RParen)
    ]))

    # Array type
    grammar.add_rule("array_type", seq([
        token(LBracket),
        ref("type"),
        token(RBracket)
    ]))

    # Dict type
    grammar.add_rule("dict_type", seq([
        token(LBrace),
        field("key", ref("type")),
        token(Colon),
        field("value", ref("type")),
        token(RBrace)
    ]))

    # Option type (sugar for Option<T>)
    grammar.add_rule("option_type", seq([
        ref("type"),
        token(Question)
    ]))

    # Result type (sugar for Result<T, E>)
    grammar.add_rule("result_type", seq([
        ref("type"),
        token(Exclamation)
    ]))

    # Type parameters
    grammar.add_rule("type_parameters", seq([
        token(Lt),
        ref("type_parameter_list"),
        token(Gt)
    ]))

    # Type parameter list
    grammar.add_rule("type_parameter_list", seq([
        ref("type_parameter"),
        repeat(seq([token(Comma), ref("type_parameter")])),
        optional(token(Comma))
    ]))

    # Type parameter
    grammar.add_rule("type_parameter", seq([
        field("name", ref("type_identifier")),
        optional(seq([
            token(Colon),
            ref("trait_bounds")
        ]))
    ]))

    # Trait bounds
    grammar.add_rule("trait_bounds", seq([
        ref("type_identifier"),
        repeat(seq([token(Plus), ref("type_identifier")]))
    ]))

    # Field list (for struct/enum variants)
    grammar.add_rule("field_list", seq([
        ref("field_def"),
        repeat(seq([token(Comma), ref("field_def")])),
        optional(token(Comma))
    ]))

    # Identifiers
    grammar.add_rule("identifier", token(Identifier))
    grammar.add_rule("type_identifier", token(TypeIdentifier))
