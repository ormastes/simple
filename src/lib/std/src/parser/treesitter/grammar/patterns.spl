# Grammar Patterns
#
# Pattern matching rules: identifier, wildcard, tuple, struct, enum, or patterns.

use simple_grammar.{Grammar}
use tokens.{TokenKind, token, ref, seq, choice, optional, field, repeat}

pub use add_pattern_rules

# Add all pattern rules to grammar
fn add_pattern_rules(grammar: Grammar):
    # Patterns
    grammar.add_rule("pattern", choice([
        ref("identifier_pattern"),
        ref("wildcard_pattern"),
        ref("literal_pattern"),
        ref("tuple_pattern"),
        ref("struct_pattern"),
        ref("enum_pattern"),
        ref("or_pattern")
    ]))

    # Identifier pattern
    grammar.add_rule("identifier_pattern", ref("identifier"))

    # Wildcard pattern
    grammar.add_rule("wildcard_pattern", token(Underscore))

    # Literal pattern
    grammar.add_rule("literal_pattern", ref("literal"))

    # Tuple pattern
    grammar.add_rule("tuple_pattern", seq([
        token(LParen),
        ref("pattern"),
        token(Comma),
        optional(ref("pattern_list")),
        token(RParen)
    ]))

    # Pattern list
    grammar.add_rule("pattern_list", seq([
        ref("pattern"),
        repeat(seq([token(Comma), ref("pattern")])),
        optional(token(Comma))
    ]))

    # Struct pattern
    grammar.add_rule("struct_pattern", seq([
        field("name", ref("type_identifier")),
        token(LParen),
        optional(ref("field_pattern_list")),
        token(RParen)
    ]))

    # Field pattern list
    grammar.add_rule("field_pattern_list", seq([
        ref("field_pattern"),
        repeat(seq([token(Comma), ref("field_pattern")])),
        optional(token(Comma))
    ]))

    # Field pattern
    grammar.add_rule("field_pattern", seq([
        field("name", ref("identifier")),
        token(Colon),
        field("pattern", ref("pattern"))
    ]))

    # Enum pattern
    grammar.add_rule("enum_pattern", seq([
        field("variant", ref("type_identifier")),
        optional(choice([
            seq([
                token(LParen),
                optional(ref("pattern_list")),
                token(RParen)
            ]),
            seq([
                token(LBrace),
                optional(ref("field_pattern_list")),
                token(RBrace)
            ])
        ]))
    ]))

    # Or pattern
    grammar.add_rule("or_pattern", seq([
        ref("pattern"),
        token(Pipe),
        ref("pattern")
    ]))
