# Color Utilities - Shared color parsing for UI components
#
# Provides color parsing from string names and hex values,
# used by both TUI and GUI renderers.

use core.*

# Color enum for UI rendering
pub enum Color:
    Black
    Red
    Green
    Yellow
    Blue
    Magenta
    Cyan
    White
    Default
    Rgb(u8, u8, u8)

impl Color:
    # Create color from hex value (0xRRGGBB)
    pub fn hex(value: u32) -> Color:
        val r = ((value >> 16) & 0xFF) as u8
        val g = ((value >> 8) & 0xFF) as u8
        val b = (value & 0xFF) as u8
        return Color::Rgb(r, g, b)

    # Create color from RGB values
    pub fn rgb(r: u8, g: u8, b: u8) -> Color:
        return Color::Rgb(r, g, b)

    # =========================================================================
    # Helper Methods
    # =========================================================================

    pub fn is_black(self) -> bool:
        """Check if this is Black color.

        Returns:
            true for Black

        Example:
            Color::Black.is_black()  # → true
        """
        match self:
            case Black: true
            case _: false

    pub fn is_red(self) -> bool:
        """Check if this is Red color.

        Returns:
            true for Red

        Example:
            Color::Red.is_red()  # → true
        """
        match self:
            case Red: true
            case _: false

    pub fn is_green(self) -> bool:
        """Check if this is Green color.

        Returns:
            true for Green

        Example:
            Color::Green.is_green()  # → true
        """
        match self:
            case Green: true
            case _: false

    pub fn is_yellow(self) -> bool:
        """Check if this is Yellow color.

        Returns:
            true for Yellow

        Example:
            Color::Yellow.is_yellow()  # → true
        """
        match self:
            case Yellow: true
            case _: false

    pub fn is_blue(self) -> bool:
        """Check if this is Blue color.

        Returns:
            true for Blue

        Example:
            Color::Blue.is_blue()  # → true
        """
        match self:
            case Blue: true
            case _: false

    pub fn is_magenta(self) -> bool:
        """Check if this is Magenta color.

        Returns:
            true for Magenta

        Example:
            Color::Magenta.is_magenta()  # → true
        """
        match self:
            case Magenta: true
            case _: false

    pub fn is_cyan(self) -> bool:
        """Check if this is Cyan color.

        Returns:
            true for Cyan

        Example:
            Color::Cyan.is_cyan()  # → true
        """
        match self:
            case Cyan: true
            case _: false

    pub fn is_white(self) -> bool:
        """Check if this is White color.

        Returns:
            true for White

        Example:
            Color::White.is_white()  # → true
        """
        match self:
            case White: true
            case _: false

    pub fn is_default(self) -> bool:
        """Check if this is Default color.

        Returns:
            true for Default

        Example:
            Color::Default.is_default()  # → true
        """
        match self:
            case Default: true
            case _: false

    pub fn is_rgb(self) -> bool:
        """Check if this is custom RGB color.

        Returns:
            true for Rgb

        Example:
            Color::Rgb(255, 0, 0).is_rgb()  # → true
        """
        match self:
            case Rgb(_, _, _): true
            case _: false

    pub fn is_named(self) -> bool:
        """Check if this is a named color.

        Returns:
            true for named colors (not Rgb or Default)

        Example:
            Color::Red.is_named()  # → true
            Color::Rgb(255, 0, 0).is_named()  # → false
        """
        match self:
            case Black: true
            case Red: true
            case Green: true
            case Yellow: true
            case Blue: true
            case Magenta: true
            case Cyan: true
            case White: true
            case _: false

    pub fn is_ansi_compatible(self) -> bool:
        """Check if color can be represented as ANSI.

        Returns:
            true for named colors

        Example:
            Color::Red.is_ansi_compatible()  # → true
            Color::Rgb(128, 64, 32).is_ansi_compatible()  # → false
        """
        self.is_named()

    pub fn to_string(self) -> text:
        """Convert color to string name.

        Returns:
            Color name

        Example:
            Color::Red.to_string()  # → "red"
        """
        match self:
            case Black: "black"
            case Red: "red"
            case Green: "green"
            case Yellow: "yellow"
            case Blue: "blue"
            case Magenta: "magenta"
            case Cyan: "cyan"
            case White: "white"
            case Default: "default"
            case Rgb(r, g, b): "rgb({r}, {g}, {b})"

    pub fn description(self) -> text:
        """Get color description.

        Returns:
            Human-readable description

        Example:
            Color::Red.description()  # → "Named color: red"
        """
        match self:
            case Black: "Named color: black"
            case Red: "Named color: red"
            case Green: "Named color: green"
            case Yellow: "Named color: yellow"
            case Blue: "Named color: blue"
            case Magenta: "Named color: magenta"
            case Cyan: "Named color: cyan"
            case White: "Named color: white"
            case Default: "Default/inherit color"
            case Rgb(r, g, b): "Custom RGB color: ({r}, {g}, {b})"

    pub fn summary(self) -> text:
        """Get summary of color.

        Returns:
            Human-readable summary

        Example:
            Color::Red.summary()
            # → "Color: red (named, ANSI compatible)"
        """
        val name = self.to_string()
        var attrs: Array<text> = []

        if self.is_named():
            attrs.push("named")
        if self.is_rgb():
            attrs.push("custom RGB")
        if self.is_default():
            attrs.push("default")
        if self.is_ansi_compatible():
            attrs.push("ANSI compatible")

        val attrs_str = attrs.join(", ")
        return "Color: {name} ({attrs_str})"

# Parse color string to Color enum
# Supports named colors (black, red, green, etc.) and hex (#RRGGBB)
pub fn parse_color(s: &str) -> Color:
    match s.to_lowercase().as_str():
        case "black": return Color::Black
        case "red": return Color::Red
        case "green": return Color::Green
        case "yellow": return Color::Yellow
        case "blue": return Color::Blue
        case "magenta": return Color::Magenta
        case "cyan": return Color::Cyan
        case "white": return Color::White
        case "default" | "": return Color::Default
        case _:
            # Try hex color
            if s.starts_with("#") and s.len() == 7:
                val hex = s[1..].parse_hex().unwrap_or(0)
                return Color::hex(hex as u32)
            # Try rgb(...) format
            if s.starts_with("rgb(") and s.ends_with(")"):
                return parse_rgb_string(s)
            return Color::Default

# Parse rgb(r, g, b) format
fn parse_rgb_string(s: &str) -> Color:
    # Extract "r, g, b" from "rgb(r, g, b)"
    val inner = s[4..s.len()-1]  # Remove "rgb(" and ")"
    val parts = inner.split(",")
    if parts.len() == 3:
        val r = parts[0].trim().parse_u8().unwrap_or(0)
        val g = parts[1].trim().parse_u8().unwrap_or(0)
        val b = parts[2].trim().parse_u8().unwrap_or(0)
        return Color::Rgb(r, g, b)
    return Color::Default

# Alias for compatibility
pub fn parse_color_string(s: &str) -> Color:
    return parse_color(s)

# Convert Color to ANSI escape code index
pub fn color_to_ansi(color: Color) -> Option<u8>:
    match color:
        case Color::Black: return Some(0)
        case Color::Red: return Some(1)
        case Color::Green: return Some(2)
        case Color::Yellow: return Some(3)
        case Color::Blue: return Some(4)
        case Color::Magenta: return Some(5)
        case Color::Cyan: return Some(6)
        case Color::White: return Some(7)
        case Color::Default: return None
        case Color::Rgb(_, _, _): return None  # Not a simple ANSI color

# Convert Color to CSS-compatible string
pub fn color_to_css(color: Color) -> text:
    match color:
        case Color::Black: return "black".to_string()
        case Color::Red: return "red".to_string()
        case Color::Green: return "green".to_string()
        case Color::Yellow: return "yellow".to_string()
        case Color::Blue: return "blue".to_string()
        case Color::Magenta: return "magenta".to_string()
        case Color::Cyan: return "cyan".to_string()
        case Color::White: return "white".to_string()
        case Color::Default: return "inherit".to_string()
        case Color::Rgb(r, g, b): return format("rgb({}, {}, {})", r, g, b)
