# MCP SDK - Input Validation
#
# Validates MCP protocol inputs: content length, strings, URIs, tool names.

use lib.mcp_sdk.core.errors.{mcp_error, ERR_VALIDATION}

# Validation limits configuration
struct ValidationLimits:
    max_content_length: i64
    max_string_length: i64
    max_uri_length: i64
    max_tool_name_length: i64
    max_array_length: i64

fn default_validation_limits() -> ValidationLimits:
    ValidationLimits(
        max_content_length: 1048576,
        max_string_length: 65536,
        max_uri_length: 2048,
        max_tool_name_length: 256,
        max_array_length: 1000
    )

fn strict_validation_limits() -> ValidationLimits:
    ValidationLimits(
        max_content_length: 524288,
        max_string_length: 32768,
        max_uri_length: 1024,
        max_tool_name_length: 128,
        max_array_length: 500
    )

# --- Validation functions ---
# Return "" for valid, or error message string for invalid.
# Using text return instead of Option to avoid import issues.

fn validate_content_length(limits: ValidationLimits, length: i64) -> text:
    if length < 0:
        return "Content length cannot be negative"
    if length > limits.max_content_length:
        return "Content length exceeds maximum of " + limits.max_content_length.to_string()
    ""

fn validate_string_length(limits: ValidationLimits, s: text) -> text:
    val length = s.len()
    if length > limits.max_string_length:
        return "String length " + length.to_string() + " exceeds maximum of " + limits.max_string_length.to_string()
    ""

fn validate_uri(limits: ValidationLimits, uri: text) -> text:
    if uri.len() == 0:
        return "URI cannot be empty"
    if uri.len() > limits.max_uri_length:
        return "URI length exceeds maximum of " + limits.max_uri_length.to_string()

    # Check for valid URI scheme
    val is_file = uri.starts_with("file://")
    val is_http = uri.starts_with("http://")
    val is_https = uri.starts_with("https://")
    val is_custom = uri.contains("://")

    val is_valid = is_file or is_http or is_https or is_custom
    if not is_valid:
        return "Invalid URI scheme"
    ""

fn validate_tool_name(limits: ValidationLimits, name: text) -> text:
    if name.len() == 0:
        return "Tool name cannot be empty"
    if name.len() > limits.max_tool_name_length:
        return "Tool name length exceeds maximum of " + limits.max_tool_name_length.to_string()

    var i = 0
    for ch in name:
        val is_lower = ch >= "a" and ch <= "z"
        val is_upper = ch >= "A" and ch <= "Z"
        val is_digit = ch >= "0" and ch <= "9"
        val is_special = ch == "/" or ch == "-" or ch == "_"
        val is_valid = is_lower or is_upper or is_digit or is_special
        if not is_valid:
            return "Tool name contains invalid character: " + ch
        i = i + 1
    ""

fn validate_array_length(limits: ValidationLimits, length: i64) -> text:
    if length < 0:
        return "Array length cannot be negative"
    if length > limits.max_array_length:
        return "Array length " + length.to_string() + " exceeds maximum of " + limits.max_array_length.to_string()
    ""

# --- Exports ---

export ValidationLimits
export default_validation_limits, strict_validation_limits
export validate_content_length, validate_string_length, validate_uri
export validate_tool_name, validate_array_length
