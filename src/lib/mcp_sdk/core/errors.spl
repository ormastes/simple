# MCP SDK - Error Types and Factory Functions
#
# Defines MCP error categories with JSON-RPC error codes.

use std.mcp_sdk.core.json.{LB, RB, jp, js, escape_json}

# Error category constants (avoid enum for import compatibility)
fn ERR_PARSE_ERROR() -> text:
    "parse_error"

fn ERR_INVALID_REQUEST() -> text:
    "invalid_request"

fn ERR_METHOD_NOT_FOUND() -> text:
    "method_not_found"

fn ERR_INVALID_PARAMS() -> text:
    "invalid_params"

fn ERR_INTERNAL_ERROR() -> text:
    "internal_error"

fn ERR_TIMEOUT() -> text:
    "timeout"

fn ERR_TOO_MANY_REQUESTS() -> text:
    "too_many_requests"

fn ERR_VALIDATION() -> text:
    "validation"

# Map error category to JSON-RPC error code
fn error_category_to_code(category: text) -> i64:
    if category == "parse_error":
        return -32700
    elif category == "invalid_request":
        return -32600
    elif category == "method_not_found":
        return -32601
    elif category == "invalid_params":
        return -32602
    elif category == "internal_error":
        return -32603
    elif category == "timeout":
        return -32000
    elif category == "too_many_requests":
        return -32001
    elif category == "validation":
        return -32002
    -32603

# MCP Error as a struct
struct McpError:
    category: text
    message: text
    recoverable: bool
    details: text

fn mcp_error(category: text, message: text) -> McpError:
    McpError(
        category: category,
        message: message,
        recoverable: true,
        details: ""
    )

fn mcp_error_with_details(category: text, message: text, details: text) -> McpError:
    McpError(
        category: category,
        message: message,
        recoverable: true,
        details: details
    )

fn mcp_error_unrecoverable(category: text, message: text) -> McpError:
    McpError(
        category: category,
        message: message,
        recoverable: false,
        details: ""
    )

fn mcp_error_to_jsonrpc(err: McpError) -> text:
    val code = error_category_to_code(err.category)
    var r = LB()
    r = r + jp("code", code.to_string())
    r = r + "," + jp("message", js(escape_json(err.message)))
    if err.details != "":
        var data = LB()
        data = data + jp("category", js(err.category))
        data = data + "," + jp("details", js(escape_json(err.details)))
        data = data + RB()
        r = r + "," + jp("data", data)
    r = r + RB()
    r

# Convenience error constructors
fn parse_error(message: text) -> McpError:
    mcp_error("parse_error", message)

fn invalid_request(message: text) -> McpError:
    mcp_error("invalid_request", message)

fn method_not_found(method: text) -> McpError:
    mcp_error("method_not_found", "Method not found: " + method)

fn invalid_params(message: text) -> McpError:
    mcp_error("invalid_params", message)

fn internal_error(message: text) -> McpError:
    mcp_error("internal_error", message)

# --- Exports ---

export ERR_PARSE_ERROR, ERR_INVALID_REQUEST, ERR_METHOD_NOT_FOUND
export ERR_INVALID_PARAMS, ERR_INTERNAL_ERROR, ERR_TIMEOUT
export ERR_TOO_MANY_REQUESTS, ERR_VALIDATION
export error_category_to_code
export McpError, mcp_error, mcp_error_with_details, mcp_error_unrecoverable, mcp_error_to_jsonrpc
export parse_error, invalid_request, method_not_found, invalid_params, internal_error
