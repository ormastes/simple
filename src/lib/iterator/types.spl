# Iterator Types and Internal Helpers
#
# Core iterator representation and internal iteration logic.
#
# Iterator Representation:
# An iterator is a dict with:
#   - "type": "iterator"
#   - "data": array of buffered elements (for finite iterators)
#   - "index": current position in data array
#   - "generator": generator type string (or nil for finite)
#   - "state": generator-specific state dict
#   - "done": boolean indicating if iterator is exhausted

export iter_next_internal

fn iter_next_internal(iter):
    """Internal: Get next element from iterator. Returns (element, has_more)."""
    if iter["done"]:
        return (nil, false)

    # Use buffered data if available
    if iter["index"] < iter["data"].len():
        val elem = iter["data"][iter["index"]]
        iter["index"] = iter["index"] + 1
        return (elem, true)

    # Check if finite iterator exhausted
    if iter["generator"] == nil:
        iter["done"] = true
        return (nil, false)

    # Generate next element based on generator type
    val gen_type = iter["generator"]
    val state = iter["state"]

    if gen_type == "repeat":
        val value = state["value"]
        return (value, true)

    if gen_type == "cycle":
        val items = state["items"]
        val pos = state["position"]
        val value = items[pos]
        state["position"] = (pos + 1) % items.len()
        return (value, true)

    if gen_type == "function":
        val fn = state["fn"]
        val current = state["current"]
        val has_more = fn(current)
        val elem = has_more[0]
        val continues = has_more[1]

        if continues:
            state["current"] = elem
            return (elem, true)
        else:
            iter["done"] = true
            return (nil, false)

    if gen_type == "range":
        val current = state["current"]
        val end = state["end"]
        val step = state["step"]

        if (step > 0 and current >= end) or (step < 0 and current <= end):
            iter["done"] = true
            return (nil, false)

        val value = current
        state["current"] = current + step
        return (value, true)

    # Unknown generator
    iter["done"] = true
    (nil, false)
