# Map Iteration Functions

fn map_keys(map):
    """Get array of all keys in map.

    Example:
        val m = map_put(map_put(map_create(), "x", 1), "y", 2)
        map_keys(m)  # ["x", "y"]
    """
    var result = []
    var i = 0
    while i < map.len():
        val entry = map[i]
        result.push(entry[0])
        i = i + 1
    result

fn map_values(map):
    """Get array of all values in map.

    Example:
        val m = map_put(map_put(map_create(), "x", 1), "y", 2)
        map_values(m)  # [1, 2]
    """
    var result = []
    var i = 0
    while i < map.len():
        val entry = map[i]
        result.push(entry[1])
        i = i + 1
    result

fn map_entries(map):
    """Get array of all (key, value) tuples.

    Same as the map itself, but provided for consistency.

    Example:
        val m = map_put(map_create(), "x", 1)
        map_entries(m)  # [("x", 1)]
    """
    map

fn map_for_each(map, fn):
    """Apply function to each key-value pair.

    Function receives (key, value) as arguments.

    Example:
        val m = map_put(map_create(), "x", 1)
        map_for_each(m, \k, v: print "{k} -> {v}")
    """
    var i = 0
    while i < map.len():
        val entry = map[i]
        fn(entry[0], entry[1])
        i = i + 1
    nil

fn map_is_empty(map) -> bool:
    """Check if map is empty.

    Example:
        map_is_empty(map_create())  # true
        map_is_empty(map_put(map_create(), "x", 1))  # false
    """
    map.len() == 0

fn map_size(map) -> i64:
    """Get number of key-value pairs in map.

    Example:
        val m = map_put(map_create(), "x", 10)
        map_size(m)  # 1
    """
    map.len()

fn map_map_keys(map, key_fn):
    """Transform all keys using function. Returns new map.

    Warning: If transformation creates duplicate keys, last one wins.

    Example:
        val m = map_put(map_create(), "x", 1)
        val m2 = map_map_keys(m, \k: k.to_upper())
        map_keys(m2)  # ["X"]
    """
    var result = []
    var i = 0
    while i < map.len():
        val entry = map[i]
        val new_key = key_fn(entry[0])
        result.push((new_key, entry[1]))
        i = i + 1
    result

fn map_map_values(map, value_fn):
    """Transform all values using function. Returns new map.

    Example:
        val m = map_put(map_create(), "x", 1)
        val m2 = map_map_values(m, \v: v * 2)
        map_get(m2, "x")  # 2
    """
    var result = []
    var i = 0
    while i < map.len():
        val entry = map[i]
        val new_value = value_fn(entry[1])
        result.push((entry[0], new_value))
        i = i + 1
    result

fn map_map_entries(map, entry_fn):
    """Transform all entries using function. Returns new map.

    Function receives (key, value) and returns new (key, value) tuple.

    Example:
        val m = map_put(map_create(), "x", 1)
        val m2 = map_map_entries(m, \k, v: (k.to_upper(), v * 2))
        map_get(m2, "X")  # 2
    """
    var result = []
    var i = 0
    while i < map.len():
        val entry = map[i]
        val new_entry = entry_fn(entry[0], entry[1])
        result.push(new_entry)
        i = i + 1
    result

fn map_filter(map, predicate):
    """Filter map by predicate. Returns new map with matching entries.

    Predicate receives (key, value) and returns bool.

    Example:
        val m = map_put(map_put(map_create(), "x", 1), "y", 2)
        val m2 = map_filter(m, \k, v: v > 1)
        map_size(m2)  # 1
        map_get(m2, "y")  # 2
    """
    var result = []
    var i = 0
    while i < map.len():
        val entry = map[i]
        if predicate(entry[0], entry[1]):
            result.push(entry)
        i = i + 1
    result

fn map_filter_keys(map, key_predicate):
    """Filter map by key predicate.

    Example:
        val m = map_put(map_put(map_create(), "x", 1), "y", 2)
        val m2 = map_filter_keys(m, \k: k == "x")
        map_size(m2)  # 1
    """
    map_filter(map, \k, v: key_predicate(k))

fn map_filter_values(map, value_predicate):
    """Filter map by value predicate.

    Example:
        val m = map_put(map_put(map_create(), "x", 1), "y", 2)
        val m2 = map_filter_values(m, \v: v > 1)
        map_get(m2, "y")  # 2
    """
    map_filter(map, \k, v: value_predicate(v))

fn map_partition(map, predicate):
    """Partition map into two maps based on predicate.

    Returns tuple: (matching_map, non_matching_map)

    Example:
        val m = map_put(map_put(map_create(), "x", 1), "y", 2)
        val parts = map_partition(m, \k, v: v > 1)
        val high = parts[0]  # {"y": 2}
        val low = parts[1]   # {"x": 1}
    """
    var true_map = []
    var false_map = []

    var i = 0
    while i < map.len():
        val entry = map[i]
        if predicate(entry[0], entry[1]):
            true_map.push(entry)
        else:
            false_map.push(entry)
        i = i + 1

    (true_map, false_map)

fn map_reduce(map, init, reduce_fn):
    """Reduce map to single value using accumulator function.

    reduce_fn receives (accumulator, key, value) and returns new accumulator.

    Example:
        val m = map_put(map_put(map_create(), "x", 1), "y", 2)
        val sum = map_reduce(m, 0, \acc, k, v: acc + v)  # 3
    """
    var acc = init
    var i = 0
    while i < map.len():
        val entry = map[i]
        acc = reduce_fn(acc, entry[0], entry[1])
        i = i + 1
    acc

fn map_every(map, predicate) -> bool:
    """Check if all entries match predicate.

    Example:
        val m = map_put(map_put(map_create(), "x", 1), "y", 2)
        map_every(m, \k, v: v > 0)  # true
    """
    var i = 0
    while i < map.len():
        val entry = map[i]
        if not predicate(entry[0], entry[1]):
            return false
        i = i + 1
    true

fn map_some(map, predicate) -> bool:
    """Check if any entry matches predicate.

    Example:
        val m = map_put(map_put(map_create(), "x", 1), "y", 2)
        map_some(m, \k, v: v > 1)  # true
    """
    var i = 0
    while i < map.len():
        val entry = map[i]
        if predicate(entry[0], entry[1]):
            return true
        i = i + 1
    false
