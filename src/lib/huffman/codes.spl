# Huffman Codes Module
# Code table generation and analysis

import huffman.types

# ============================================================================
# CODE TABLE GENERATION
# ============================================================================

fn huffman_build_code_table_helper(node, prefix, table):
    """Recursive helper to build code table"""
    if node == nil:
        table
    else:
        val is_leaf = huffman_is_leaf(node)
        if is_leaf:
            val symbol = huffman_get_symbol(node)
            array_set(table, symbol, prefix)
            table
        else:
            val left = huffman_get_left(node)
            val right = huffman_get_right(node)
            val left_prefix = string_concat(prefix, HUFFMAN_BIT_ZERO)
            val right_prefix = string_concat(prefix, HUFFMAN_BIT_ONE)

            var updated_table = huffman_build_code_table_helper(left, left_prefix, table)
            updated_table = huffman_build_code_table_helper(right, right_prefix, updated_table)
            updated_table

fn huffman_build_code_table(tree):
    """Build code table mapping symbols to bit strings"""
    var table = array_new(HUFFMAN_MAX_SYMBOLS, "")
    huffman_build_code_table_helper(tree, "", table)

fn huffman_get_code(code_table, symbol):
    """Get Huffman code for a symbol"""
    array_get(code_table, symbol)

# ============================================================================
# CODE LENGTH ANALYSIS
# ============================================================================

fn huffman_code_length_distribution(code_table):
    """Get distribution of code lengths"""
    var dist = array_new(32, 0)
    var i = 0

    while i < HUFFMAN_MAX_SYMBOLS:
        val code = array_get(code_table, i)
        val code_len = string_length(code)
        if code_len > 0:
            val old_count = array_get(dist, code_len)
            var new_count = old_count + 1
            dist = array_set(dist, code_len, new_count)
        i = i + 1

    dist

fn huffman_average_code_length(code_table, freq_table):
    """Calculate weighted average code length"""
    var total_bits = 0
    var total_symbols = 0
    var i = 0

    while i < HUFFMAN_MAX_SYMBOLS:
        val freq = array_get(freq_table, i)
        if freq > 0:
            val code = array_get(code_table, i)
            val code_len = string_length(code)
            total_bits = total_bits + code_len * freq
            total_symbols = total_symbols + freq
        i = i + 1

    if total_symbols == 0:
        0
    else:
        total_bits / total_symbols

fn huffman_min_code_length(code_table):
    """Find minimum code length"""
    var min_len = 999999
    var i = 0

    while i < HUFFMAN_MAX_SYMBOLS:
        val code = array_get(code_table, i)
        val code_len = string_length(code)
        if code_len > 0:
            if code_len < min_len:
                min_len = code_len
        i = i + 1

    if min_len == 999999:
        0
    else:
        min_len

fn huffman_max_code_length(code_table):
    """Find maximum code length"""
    var max_len = 0
    var i = 0

    while i < HUFFMAN_MAX_SYMBOLS:
        val code = array_get(code_table, i)
        val code_len = string_length(code)
        if code_len > max_len:
            max_len = code_len
        i = i + 1

    max_len

# ============================================================================
# CANONICAL HUFFMAN CODES
# ============================================================================

fn huffman_sort_by_length_then_symbol(code_table):
    """Create sorted list of (symbol, code_length) pairs"""
    var pairs = []
    var i = 0

    while i < HUFFMAN_MAX_SYMBOLS:
        val code = array_get(code_table, i)
        val code_len = string_length(code)
        if code_len > 0:
            pairs = array_append(pairs, (i, code_len))
        i = i + 1

    huffman_sort_pairs(pairs)

fn huffman_sort_pairs(pairs):
    """Sort (symbol, length) pairs by length then symbol (bubble sort)"""
    var result = pairs
    val n = array_length(result)
    var i = 0

    while i < n:
        var j = 0
        while j < n - 1 - i:
            val pair1 = array_get(result, j)
            val pair2 = array_get(result, j + 1)
            val len1 = pair1[1]
            val len2 = pair2[1]
            val sym1 = pair1[0]
            val sym2 = pair2[0]

            var should_swap = false
            if len1 > len2:
                should_swap = true
            else:
                if len1 == len2:
                    if sym1 > sym2:
                        should_swap = true

            if should_swap:
                result = array_set(result, j, pair2)
                result = array_set(result, j + 1, pair1)

            j = j + 1
        i = i + 1

    result

fn huffman_int_to_binary(value, length):
    """Convert integer to binary string of specified length"""
    var result = ""
    var v = value
    var i = 0

    while i < length:
        val bit = v % 2
        val bit_str = if bit == 0: HUFFMAN_BIT_ZERO else: HUFFMAN_BIT_ONE
        result = string_concat(bit_str, result)
        v = v / 2
        i = i + 1

    result

fn huffman_build_canonical_codes(sorted_pairs):
    """Build canonical Huffman codes from sorted pairs"""
    var table = array_new(HUFFMAN_MAX_SYMBOLS, "")
    var code_value = 0
    var prev_length = 0
    var i = 0
    val pairs_len = array_length(sorted_pairs)

    while i < pairs_len:
        val pair = array_get(sorted_pairs, i)
        val symbol = pair[0]
        val length = pair[1]

        if i > 0:
            code_value = code_value << (length - prev_length)

        val code_str = huffman_int_to_binary(code_value, length)
        table = array_set(table, symbol, code_str)

        code_value = code_value + 1
        prev_length = length
        i = i + 1

    table

fn huffman_canonicalize(code_table):
    """Convert code table to canonical Huffman codes"""
    val sorted = huffman_sort_by_length_then_symbol(code_table)
    huffman_build_canonical_codes(sorted)

# ============================================================================
# PREFIX CODE VALIDATION
# ============================================================================

fn huffman_is_prefix(code1, code2):
    """Check if code1 is prefix of code2"""
    val len1 = string_length(code1)
    val len2 = string_length(code2)

    if len1 > len2:
        false
    else:
        val prefix = string_substring(code2, 0, len1)
        code1 == prefix

fn huffman_validate_prefix_property(code_table):
    """Validate that no code is prefix of another"""
    var codes = []
    var i = 0

    while i < HUFFMAN_MAX_SYMBOLS:
        val code = array_get(code_table, i)
        val code_len = string_length(code)
        if code_len > 0:
            codes = array_append(codes, code)
        i = i + 1

    val codes_len = array_length(codes)
    var j = 0

    while j < codes_len:
        val code1 = array_get(codes, j)
        var k = 0

        while k < codes_len:
            if j != k:
                val code2 = array_get(codes, k)
                val is_prefix = huffman_is_prefix(code1, code2)
                if is_prefix:
                    return false
            k = k + 1

        j = j + 1

    true

fn huffman_verify_code_uniqueness(code_table):
    """Verify all codes are unique"""
    var seen_codes = []
    var i = 0

    while i < HUFFMAN_MAX_SYMBOLS:
        val code = array_get(code_table, i)
        val code_len = string_length(code)
        if code_len > 0:
            var j = 0
            val seen_len = array_length(seen_codes)
            while j < seen_len:
                val seen = array_get(seen_codes, j)
                if code == seen:
                    return false
                j = j + 1
            seen_codes = array_append(seen_codes, code)
        i = i + 1

    true

fn huffman_invert_code_table(code_table):
    """Create reverse mapping from codes to symbols"""
    var result = []
    var i = 0

    while i < HUFFMAN_MAX_SYMBOLS:
        val code = array_get(code_table, i)
        val code_len = string_length(code)
        if code_len > 0:
            result = array_append(result, (code, i))
        i = i + 1

    result

fn huffman_lookup_symbol_by_code(inverted_table, code):
    """Look up symbol by its code using inverted table"""
    var i = 0
    val table_len = array_length(inverted_table)

    while i < table_len:
        val entry = array_get(inverted_table, i)
        val entry_code = entry[0]
        val entry_symbol = entry[1]
        if entry_code == code:
            return entry_symbol
        i = i + 1

    -1
