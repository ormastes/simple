# JSON Object Operations
#
# Purpose: Operations on JSON objects (key-value maps)
#
# Contains:
# - Basic: get, set, has, remove, keys, values, entries
# - Properties: size, empty, merge
# - Higher-order: map_values, filter, find, without, pick
# - Conversion: from_entries

# Import types for type checking
mod json.types

fn json_object_get(obj: any, key: text) -> any:
    """Get value from JSON object by key.

    Args:
        obj: JSON object
        key: Key to look up

    Returns:
        Value if key exists, nil otherwise

    Example:
        json_object_get(obj, "name")
    """
    val map = json_to_object(obj)
    if map == nil:
        return nil
    if map.has_key(key):
        return map[key]
    nil

fn json_object_set(obj: any, key: text, value: any) -> any:
    """Set value in JSON object.

    Args:
        obj: JSON object
        key: Key to set
        value: JSON value to set

    Returns:
        New JSON object with updated value

    Example:
        json_object_set(obj, "age", json_number(30))
    """
    var map = json_to_object(obj)
    if map == nil:
        map = {}
    map[key] = value
    json_object(map)

fn json_object_has(obj: any, key: text) -> bool:
    """Check if JSON object has a key.

    Args:
        obj: JSON object
        key: Key to check

    Returns:
        true if key exists, false otherwise

    Example:
        json_object_has(obj, "name")
    """
    val map = json_to_object(obj)
    if map == nil:
        return false
    map.has_key(key)

fn json_object_remove(obj: any, key: text) -> any:
    """Remove key from JSON object.

    Args:
        obj: JSON object
        key: Key to remove

    Returns:
        New JSON object without the key

    Example:
        json_object_remove(obj, "old_field")
    """
    val map = json_to_object(obj)
    if map == nil:
        return json_object({})
    var new_map: {text: any} = {}
    for k in map.keys():
        if k != key:
            new_map[k] = map[k]
    json_object(new_map)

fn json_object_keys(obj: any) -> [text]:
    """Get all keys from JSON object.

    Args:
        obj: JSON object

    Returns:
        Array of keys

    Example:
        json_object_keys(obj)  # ["name", "age"]
    """
    val map = json_to_object(obj)
    if map == nil:
        return []
    map.keys()

fn json_object_values(obj: any) -> [any]:
    """Get all values from JSON object.

    Args:
        obj: JSON object

    Returns:
        Array of values

    Example:
        json_object_values(obj)
    """
    val map = json_to_object(obj)
    if map == nil:
        return []
    map.values()

fn json_object_entries(obj: any) -> [(text, any)]:
    """Get all key-value pairs from JSON object.

    Args:
        obj: JSON object

    Returns:
        Array of (key, value) tuples

    Example:
        json_object_entries(obj)  # [("name", json_string("Alice"))]
    """
    val map = json_to_object(obj)
    if map == nil:
        return []
    var result: [(text, any)] = []
    for key in map.keys():
        result = result + [(key, map[key])]
    result

fn json_object_size(obj: any) -> i64:
    """Get number of keys in JSON object.

    Args:
        obj: JSON object

    Returns:
        Number of keys

    Example:
        json_object_size(obj)  # 3
    """
    val map = json_to_object(obj)
    if map == nil:
        return 0
    map.len()

fn json_object_empty(obj: any) -> bool:
    """Check if JSON object is empty.

    Args:
        obj: JSON object

    Returns:
        true if empty, false otherwise

    Example:
        json_object_empty(obj)
    """
    json_object_size(obj) == 0

fn json_object_merge(obj1: any, obj2: any) -> any:
    """Merge two JSON objects. obj2 values override obj1.

    Args:
        obj1: First JSON object
        obj2: Second JSON object

    Returns:
        Merged JSON object

    Example:
        json_object_merge(obj1, obj2)
    """
    val map1 = json_to_object(obj1)
    val map2 = json_to_object(obj2)
    if map1 == nil and map2 == nil:
        return json_object({})
    if map1 == nil:
        return obj2
    if map2 == nil:
        return obj1
    var result: {text: any} = {}
    for key in map1.keys():
        result[key] = map1[key]
    for key in map2.keys():
        result[key] = map2[key]
    json_object(result)

fn json_object_map_values(obj: any, mapper: fn(any) -> any) -> any:
    """Map function over object values.

    Args:
        obj: JSON object
        mapper: Function to transform values

    Returns:
        New JSON object with mapped values

    Example:
        json_object_map_values(obj, \v: json_number(json_to_number(v) * 2))
    """
    val map = json_to_object(obj)
    if map == nil:
        return json_object({})
    var result: {text: any} = {}
    for key in map.keys():
        result[key] = mapper(map[key])
    json_object(result)

fn json_object_filter(obj: any, predicate: fn(text, any) -> bool) -> any:
    """Filter object entries by predicate.

    Args:
        obj: JSON object
        predicate: Function (key, value) -> bool

    Returns:
        New JSON object with filtered entries

    Example:
        json_object_filter(obj, \k, v: json_to_number(v) > 0)
    """
    val map = json_to_object(obj)
    if map == nil:
        return json_object({})
    var result: {text: any} = {}
    for key in map.keys():
        if predicate(key, map[key]):
            result[key] = map[key]
    json_object(result)

fn json_object_find(obj: any, predicate: fn(text, any) -> bool) -> any:
    """Find first entry matching predicate.

    Args:
        obj: JSON object
        predicate: Function (key, value) -> bool

    Returns:
        (key, value) tuple or nil if not found

    Example:
        json_object_find(obj, \k, v: json_to_number(v) > 100)
    """
    val map = json_to_object(obj)
    if map == nil:
        return nil
    for key in map.keys():
        if predicate(key, map[key]):
            return (key, map[key])
    nil

fn json_object_without(obj: any, keys: [text]) -> any:
    """Create object without specified keys.

    Args:
        obj: JSON object
        keys: Keys to exclude

    Returns:
        New JSON object without the keys

    Example:
        json_object_without(obj, ["temp", "internal"])
    """
    val map = json_to_object(obj)
    if map == nil:
        return json_object({})
    var result: {text: any} = {}
    for key in map.keys():
        var exclude = false
        for exclude_key in keys:
            if key == exclude_key:
                exclude = true
                break
        if not exclude:
            result[key] = map[key]
    json_object(result)

fn json_object_pick(obj: any, keys: [text]) -> any:
    """Create object with only specified keys.

    Args:
        obj: JSON object
        keys: Keys to include

    Returns:
        New JSON object with only the specified keys

    Example:
        json_object_pick(obj, ["name", "age"])
    """
    val map = json_to_object(obj)
    if map == nil:
        return json_object({})
    var result: {text: any} = {}
    for key in keys:
        if map.has_key(key):
            result[key] = map[key]
    json_object(result)

fn json_from_entries(entries: [(text, any)]) -> any:
    """Create JSON object from key-value pairs.

    Args:
        entries: Array of (key, value) tuples

    Returns:
        JSON object

    Example:
        json_from_entries([("a", json_number(1)), ("b", json_number(2))])
    """
    var map: {text: any} = {}
    for entry in entries:
        val key = entry.0
        val value = entry.1
        map[key] = value
    json_object(map)

export *
