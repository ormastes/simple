# JSON Array Operations
#
# Purpose: Operations on JSON arrays
#
# Contains:
# - Basic: get, set, append, prepend, insert, remove
# - Properties: length, empty, first, last, slice, concat, reverse
# - Higher-order: map, filter, find, reduce, every, some
# - Utilities: contains, index_of, flatten, unique, sort_by, group_by

# Import types for type checking and deep_equals
mod json.types
mod json.validation

fn json_array_get(arr: any, index: i64) -> any:
    """Get element from JSON array by index.

    Args:
        arr: JSON array
        index: Array index (0-based)

    Returns:
        Value at index if valid, nil otherwise

    Example:
        json_array_get(arr, 0)
    """
    val list = json_to_array(arr)
    if list == nil:
        return nil
    if index < 0 or index >= list.len():
        return nil
    list[index]

fn json_array_set(arr: any, index: i64, value: any) -> any:
    """Set element in JSON array at index.

    Args:
        arr: JSON array
        index: Array index
        value: JSON value to set

    Returns:
        New JSON array with updated value

    Example:
        json_array_set(arr, 0, json_string("new"))
    """
    var list = json_to_array(arr)
    if list == nil:
        list = []
    if index < 0 or index >= list.len():
        return arr
    var new_list: [any] = []
    for i in 0..list.len():
        if i == index:
            new_list = new_list + [value]
        else:
            new_list = new_list + [list[i]]
    json_array(new_list)

fn json_array_append(arr: any, value: any) -> any:
    """Append element to JSON array.

    Args:
        arr: JSON array
        value: JSON value to append

    Returns:
        New JSON array with appended value

    Example:
        json_array_append(arr, json_number(4))
    """
    var list = json_to_array(arr)
    if list == nil:
        list = []
    json_array(list + [value])

fn json_array_prepend(arr: any, value: any) -> any:
    """Prepend element to JSON array.

    Args:
        arr: JSON array
        value: JSON value to prepend

    Returns:
        New JSON array with prepended value

    Example:
        json_array_prepend(arr, json_number(0))
    """
    var list = json_to_array(arr)
    if list == nil:
        list = []
    json_array([value] + list)

fn json_array_insert(arr: any, index: i64, value: any) -> any:
    """Insert element into JSON array at index.

    Args:
        arr: JSON array
        index: Insert position
        value: JSON value to insert

    Returns:
        New JSON array with inserted value

    Example:
        json_array_insert(arr, 1, json_number(5))
    """
    var list = json_to_array(arr)
    if list == nil:
        list = []
    if index < 0 or index > list.len():
        return arr
    var new_list: [any] = []
    for i in 0..list.len():
        if i == index:
            new_list = new_list + [value]
        new_list = new_list + [list[i]]
    if index == list.len():
        new_list = new_list + [value]
    json_array(new_list)

fn json_array_remove(arr: any, index: i64) -> any:
    """Remove element from JSON array at index.

    Args:
        arr: JSON array
        index: Index to remove

    Returns:
        New JSON array without the element

    Example:
        json_array_remove(arr, 1)
    """
    val list = json_to_array(arr)
    if list == nil:
        return json_array([])
    if index < 0 or index >= list.len():
        return arr
    var new_list: [any] = []
    for i in 0..list.len():
        if i != index:
            new_list = new_list + [list[i]]
    json_array(new_list)

fn json_array_length(arr: any) -> i64:
    """Get length of JSON array.

    Args:
        arr: JSON array

    Returns:
        Array length

    Example:
        json_array_length(arr)  # 5
    """
    val list = json_to_array(arr)
    if list == nil:
        return 0
    list.len()

fn json_array_empty(arr: any) -> bool:
    """Check if JSON array is empty.

    Args:
        arr: JSON array

    Returns:
        true if empty, false otherwise

    Example:
        json_array_empty(arr)
    """
    json_array_length(arr) == 0

fn json_array_first(arr: any) -> any:
    """Get first element of JSON array.

    Args:
        arr: JSON array

    Returns:
        First element if array not empty, nil otherwise

    Example:
        json_array_first(arr)
    """
    json_array_get(arr, 0)

fn json_array_last(arr: any) -> any:
    """Get last element of JSON array.

    Args:
        arr: JSON array

    Returns:
        Last element if array not empty, nil otherwise

    Example:
        json_array_last(arr)
    """
    val list = json_to_array(arr)
    if list == nil or list.len() == 0:
        return nil
    json_array_get(arr, list.len() - 1)

fn json_array_slice(arr: any, start: i64, end: i64) -> any:
    """Get slice of JSON array.

    Args:
        arr: JSON array
        start: Start index (inclusive)
        end: End index (exclusive)

    Returns:
        New JSON array with sliced elements

    Example:
        json_array_slice(arr, 1, 3)  # elements at index 1 and 2
    """
    val list = json_to_array(arr)
    if list == nil:
        return json_array([])
    val actual_start = if start < 0: 0 else: start
    val actual_end = if end > list.len(): list.len() else: end
    if actual_start >= actual_end:
        return json_array([])
    var new_list: [any] = []
    for i in actual_start..actual_end:
        new_list = new_list + [list[i]]
    json_array(new_list)

fn json_array_concat(arr1: any, arr2: any) -> any:
    """Concatenate two JSON arrays.

    Args:
        arr1: First JSON array
        arr2: Second JSON array

    Returns:
        New JSON array with concatenated elements

    Example:
        json_array_concat(arr1, arr2)
    """
    val list1 = json_to_array(arr1)
    val list2 = json_to_array(arr2)
    if list1 == nil and list2 == nil:
        return json_array([])
    if list1 == nil:
        return arr2
    if list2 == nil:
        return arr1
    json_array(list1 + list2)

fn json_array_reverse(arr: any) -> any:
    """Reverse JSON array.

    Args:
        arr: JSON array

    Returns:
        New JSON array with reversed elements

    Example:
        json_array_reverse(arr)
    """
    val list = json_to_array(arr)
    if list == nil:
        return json_array([])
    var new_list: [any] = []
    for i in 0..list.len():
        val rev_idx = list.len() - 1 - i
        new_list = new_list + [list[rev_idx]]
    json_array(new_list)

fn json_array_map(arr: any, mapper: fn(any) -> any) -> any:
    """Map function over JSON array elements.

    Args:
        arr: JSON array
        mapper: Function to apply to each element

    Returns:
        New JSON array with mapped elements

    Example:
        json_array_map(arr, \x: json_number(json_to_number(x) * 2))
    """
    val list = json_to_array(arr)
    if list == nil:
        return json_array([])
    var new_list: [any] = []
    for elem in list:
        new_list = new_list + [mapper(elem)]
    json_array(new_list)

fn json_array_filter(arr: any, predicate: fn(any) -> bool) -> any:
    """Filter JSON array elements by predicate.

    Args:
        arr: JSON array
        predicate: Function to test each element

    Returns:
        New JSON array with filtered elements

    Example:
        json_array_filter(arr, \x: json_to_number(x) > 5)
    """
    val list = json_to_array(arr)
    if list == nil:
        return json_array([])
    var new_list: [any] = []
    for elem in list:
        if predicate(elem):
            new_list = new_list + [elem]
    json_array(new_list)

fn json_array_find(arr: any, predicate: fn(any) -> bool) -> any:
    """Find first element matching predicate.

    Args:
        arr: JSON array
        predicate: Function to test each element

    Returns:
        First matching element, or nil if none found

    Example:
        json_array_find(arr, \x: json_to_number(x) > 10)
    """
    val list = json_to_array(arr)
    if list == nil:
        return nil
    for elem in list:
        if predicate(elem):
            return elem
    nil

fn json_array_contains(arr: any, value: any) -> bool:
    """Check if JSON array contains value.

    Args:
        arr: JSON array
        value: Value to search for

    Returns:
        true if value found, false otherwise

    Example:
        json_array_contains(arr, json_string("hello"))
    """
    val list = json_to_array(arr)
    if list == nil:
        return false
    for elem in list:
        if json_deep_equals(elem, value):
            return true
    false

fn json_array_index_of(arr: any, value: any) -> i64:
    """Find index of value in JSON array.

    Args:
        arr: JSON array
        value: Value to search for

    Returns:
        Index of value, or -1 if not found

    Example:
        json_array_index_of(arr, json_number(42))
    """
    val list = json_to_array(arr)
    if list == nil:
        return -1
    for i in 0..list.len():
        if json_deep_equals(list[i], value):
            return i
    -1

fn json_array_every(arr: any, predicate: fn(any) -> bool) -> bool:
    """Check if all elements match predicate.

    Args:
        arr: JSON array
        predicate: Function to test each element

    Returns:
        true if all match, false otherwise

    Example:
        json_array_every(arr, \x: json_to_number(x) > 0)
    """
    val list = json_to_array(arr)
    if list == nil:
        return true
    for elem in list:
        if not predicate(elem):
            return false
    true

fn json_array_some(arr: any, predicate: fn(any) -> bool) -> bool:
    """Check if any element matches predicate.

    Args:
        arr: JSON array
        predicate: Function to test each element

    Returns:
        true if any match, false otherwise

    Example:
        json_array_some(arr, \x: json_to_number(x) < 0)
    """
    val list = json_to_array(arr)
    if list == nil:
        return false
    for elem in list:
        if predicate(elem):
            return true
    false

fn json_array_reduce(arr: any, initial: any, reducer: fn(any, any) -> any) -> any:
    """Reduce array to single value.

    Args:
        arr: JSON array
        initial: Initial accumulator value
        reducer: Function (accumulator, element) -> new_accumulator

    Returns:
        Final accumulator value

    Example:
        json_array_reduce(arr, json_number(0), \acc, x: json_number(json_to_number(acc) + json_to_number(x)))
    """
    val list = json_to_array(arr)
    if list == nil:
        return initial
    var acc = initial
    for elem in list:
        acc = reducer(acc, elem)
    acc

fn json_array_flatten(arr: any) -> any:
    """Flatten nested JSON arrays (one level).

    Args:
        arr: JSON array possibly containing nested arrays

    Returns:
        Flattened JSON array

    Example:
        json_array_flatten(json_array([json_array([json_number(1)]), json_number(2)]))
    """
    val list = json_to_array(arr)
    if list == nil:
        return json_array([])
    var result: [any] = []
    for elem in list:
        if json_is_array(elem):
            val nested = json_to_array(elem)
            for item in nested:
                result = result + [item]
        else:
            result = result + [elem]
    json_array(result)

fn json_array_unique(arr: any) -> any:
    """Remove duplicate values from array.

    Args:
        arr: JSON array

    Returns:
        JSON array with unique values

    Example:
        json_array_unique(arr)
    """
    val list = json_to_array(arr)
    if list == nil:
        return json_array([])
    var result: [any] = []
    for elem in list:
        var found = false
        for existing in result:
            if json_deep_equals(elem, existing):
                found = true
                break
        if not found:
            result = result + [elem]
    json_array(result)

fn json_array_sort_by(arr: any, key_fn: fn(any) -> f64) -> any:
    """Sort array by numeric key function.

    Args:
        arr: JSON array
        key_fn: Function to extract numeric sort key

    Returns:
        Sorted JSON array

    Example:
        json_array_sort_by(arr, \x: json_to_number(json_object_get(x, "age")))
    """
    val list = json_to_array(arr)
    if list == nil:
        return json_array([])
    var sorted_list = list
    for i in 0..sorted_list.len():
        for j in i + 1..sorted_list.len():
            val key_i = key_fn(sorted_list[i])
            val key_j = key_fn(sorted_list[j])
            if key_i > key_j:
                val temp = sorted_list[i]
                sorted_list = json_array_set(json_array(sorted_list), i, sorted_list[j])
                val temp_arr = json_to_array(sorted_list)
                sorted_list = json_array_set(json_array(temp_arr), j, temp)
                sorted_list = json_to_array(sorted_list)
    json_array(sorted_list)

fn json_array_group_by(arr: any, key_fn: fn(any) -> text) -> any:
    """Group array elements by key function.

    Args:
        arr: JSON array
        key_fn: Function to extract grouping key

    Returns:
        JSON object with grouped arrays

    Example:
        json_array_group_by(arr, \x: json_to_string(json_object_get(x, "category")))
    """
    val list = json_to_array(arr)
    if list == nil:
        return json_object({})
    var groups: {text: [any]} = {}
    for elem in list:
        val key = key_fn(elem)
        if not groups.has_key(key):
            groups[key] = []
        groups[key] = groups[key] + [elem]
    var result: {text: any} = {}
    for key in groups.keys():
        result[key] = json_array(groups[key])
    json_object(result)

export *
