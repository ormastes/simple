# AVL Tree Delete Operations

use avl_tree.types.{is_nil, get_value, get_left, get_right, set_left, set_right, set_value}
use avl_tree.create.{get_root, get_size, set_root, set_tree_size}
use avl_tree.search.{find_min_node}
use avl_tree.balance.{rebalance}

# ============================================================================
# Delete Operations
# ============================================================================

# Delete a value from the tree
fn avl_delete(tree, value: i64):
    val root = get_root(tree)
    val new_root = delete_node(root, value)
    var new_tree = set_root(tree, new_root)
    val old_size = get_size(tree)
    var new_size = old_size - 1
    if new_size < 0:
        new_size = 0
    set_tree_size(new_tree, new_size)

# Delete from node subtree
fn delete_node(node, value: i64):
    if is_nil(node):
        return node

    val node_value = get_value(node)
    var modified = node

    # Value in left subtree
    if value < node_value:
        val left = get_left(node)
        val new_left = delete_node(left, value)
        modified = set_left(node, new_left)
    # Value in right subtree
    else:
        var cond = value > node_value
        if cond:
            val right = get_right(node)
            val new_right = delete_node(right, value)
            modified = set_right(node, new_right)
        # Found node to delete
        else:
            val left = get_left(node)
            val right = get_right(node)

            # Case 1: Node with only one child or no child
            if is_nil(left):
                return right
            if is_nil(right):
                return left

            # Case 2: Node with two children
            # Get inorder successor (smallest in right subtree)
            val successor = find_min_node(right)
            val successor_value = get_value(successor)

            # Copy successor value to this node
            modified = set_value(node, successor_value)

            # Delete successor
            val new_right = delete_node(right, successor_value)
            modified = set_right(modified, new_right)

    # Rebalance
    rebalance(modified)
