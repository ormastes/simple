# AVL Tree Balance Operations
#
# Height calculation, balance factors, and rotations

use avl_tree.types.{is_nil, get_left, get_right, get_value, get_node_height, set_left, set_right, set_height}

# ============================================================================
# Height and Balance Operations
# ============================================================================

# Get height of a node
fn get_height(node) -> i64:
    if is_nil(node):
        return 0
    get_node_height(node)

# Calculate and update node height based on children
fn update_height(node):
    if is_nil(node):
        return node
    val left = get_left(node)
    val right = get_right(node)
    val left_height = get_height(left)
    val right_height = get_height(right)
    var max_height = left_height
    if right_height > left_height:
        max_height = right_height
    val new_height = max_height + 1
    set_height(node, new_height)

# Get balance factor of a node
# Balance factor = height(left) - height(right)
fn get_balance_factor(node) -> i64:
    if is_nil(node):
        return 0
    val left = get_left(node)
    val right = get_right(node)
    val left_height = get_height(left)
    val right_height = get_height(right)
    left_height - right_height

# Check if a single node is balanced
fn is_node_balanced(node) -> bool:
    if is_nil(node):
        return true
    val bf = get_balance_factor(node)
    var result = bf >= -1
    if result:
        result = bf <= 1
    result

# ============================================================================
# Rotation Operations
# ============================================================================

# Left rotation (LL case)
#     y              x
#    / \            / \
#   x   C    =>    A   y
#  / \                / \
# A   B              B   C
fn rotate_left(y):
    if is_nil(y):
        return y
    val x = get_right(y)
    if is_nil(x):
        return y
    val B = get_left(x)

    # Perform rotation
    var new_y = set_right(y, B)
    new_y = update_height(new_y)
    var new_x = set_left(x, new_y)
    new_x = update_height(new_x)
    new_x

# Right rotation (RR case)
#     x              y
#    / \            / \
#   A   y    =>    x   C
#      / \        / \
#     B   C      A   B
fn rotate_right(x):
    if is_nil(x):
        return x
    val y = get_left(x)
    if is_nil(y):
        return x
    val B = get_right(y)

    # Perform rotation
    var new_x = set_left(x, B)
    new_x = update_height(new_x)
    var new_y = set_right(y, new_x)
    new_y = update_height(new_y)
    new_y

# Left-Right rotation (LR case)
fn rotate_left_right(node):
    if is_nil(node):
        return node
    val left = get_left(node)
    val rotated_left = rotate_left(left)
    var new_node = set_left(node, rotated_left)
    rotate_right(new_node)

# Right-Left rotation (RL case)
fn rotate_right_left(node):
    if is_nil(node):
        return node
    val right = get_right(node)
    val rotated_right = rotate_right(right)
    var new_node = set_right(node, rotated_right)
    rotate_left(new_node)

# ============================================================================
# Rebalancing
# ============================================================================

# Rebalance a node after modification
fn rebalance(node):
    if is_nil(node):
        return node

    # Update height first
    var balanced = update_height(node)

    # Get balance factor
    val bf = get_balance_factor(balanced)

    # Left-heavy (bf > 1)
    if bf > 1:
        val left = get_left(balanced)
        val left_bf = get_balance_factor(left)
        # Left-Left case
        if left_bf >= 0:
            return rotate_right(balanced)
        # Left-Right case
        return rotate_left_right(balanced)

    # Right-heavy (bf < -1)
    if bf < -1:
        val right = get_right(balanced)
        val right_bf = get_balance_factor(right)
        # Right-Right case
        if right_bf <= 0:
            return rotate_left(balanced)
        # Right-Left case
        return rotate_right_left(balanced)

    balanced

# Rebalance after insert
fn balance_after_insert(node):
    rebalance(node)

# Rebalance after delete
fn balance_after_delete(node):
    rebalance(node)
