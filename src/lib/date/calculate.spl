# Date Calculation Module
# Date arithmetic, comparison, and calendar calculations

# ============================================================================
# Date Conversion to Days
# ============================================================================

# Convert a date to days since epoch (January 1, 0001 = day 1)
fn to_days(date: any) -> i64:
    var year = date[0]
    var month = date[1]
    var day = date[2]

    var days = day

    # Add days for complete years
    var y = 1
    while y < year:
        if is_leap_year(y):
            days = days + 366
        else:
            days = days + 365
        y = y + 1

    # Add days for complete months in current year
    var m = 1
    while m < month:
        days = days + days_in_month(year, m)
        m = m + 1

    return days

# ============================================================================
# Date Arithmetic
# ============================================================================

# Add days to a date
fn add_days(date: any, days: i64) -> any:
    var current_days = to_days(date)
    var new_days = current_days + days

    if new_days < 1:
        return nil

    return from_days(new_days)

# Subtract days from a date
fn subtract_days(date: any, days: i64) -> any:
    return add_days(date, 0 - days)

# Calculate difference in days between two dates (date1 - date2)
fn difference_in_days(date1: any, date2: any) -> i64:
    var days1 = to_days(date1)
    var days2 = to_days(date2)
    return days1 - days2

# Add months to a date (handles month overflow correctly)
fn add_months(date: any, months: i64) -> any:
    var year = date[0]
    var month = date[1]
    var day = date[2]

    # Calculate new month and year
    var total_months = month + months

    # Handle negative months
    while total_months < 1:
        total_months = total_months + 12
        year = year - 1

    # Handle overflow
    while total_months > 12:
        total_months = total_months - 12
        year = year + 1

    # Adjust day if it exceeds the new month's days
    var new_month = total_months
    var max_day = days_in_month(year, new_month)
    var new_day = day
    if new_day > max_day:
        new_day = max_day

    return (year, new_month, new_day)

# Subtract months from a date
fn subtract_months(date: any, months: i64) -> any:
    return add_months(date, 0 - months)

# Add years to a date
fn add_years(date: any, years: i64) -> any:
    var year = date[0]
    var month = date[1]
    var day = date[2]

    var new_year = year + years

    # Handle Feb 29 on non-leap years
    if month == 2:
        if day == 29:
            if not is_leap_year(new_year):
                day = 28

    return (new_year, month, day)

# Subtract years from a date
fn subtract_years(date: any, years: i64) -> any:
    return add_years(date, 0 - years)

# ============================================================================
# Date Comparison
# ============================================================================

# Check if two dates are equal
fn equal(date1: any, date2: any) -> bool:
    var y1 = date1[0]
    var m1 = date1[1]
    var d1 = date1[2]
    var y2 = date2[0]
    var m2 = date2[1]
    var d2 = date2[2]

    if y1 != y2:
        return false
    if m1 != m2:
        return false
    if d1 != d2:
        return false
    return true

# Check if date1 is before date2
fn before(date1: any, date2: any) -> bool:
    var days1 = to_days(date1)
    var days2 = to_days(date2)
    return days1 < days2

# Check if date1 is after date2
fn after(date1: any, date2: any) -> bool:
    var days1 = to_days(date1)
    var days2 = to_days(date2)
    return days1 > days2

# Compare two dates: returns -1 (before), 0 (equal), or 1 (after)
fn compare(date1: any, date2: any) -> i64:
    var days1 = to_days(date1)
    var days2 = to_days(date2)

    if days1 < days2:
        return -1
    if days1 > days2:
        return 1
    return 0

# Check if date1 is before or equal to date2
fn before_or_equal(date1: any, date2: any) -> bool:
    var cmp = compare(date1, date2)
    return cmp <= 0

# Check if date1 is after or equal to date2
fn after_or_equal(date1: any, date2: any) -> bool:
    var cmp = compare(date1, date2)
    return cmp >= 0

# ============================================================================
# Calendar Navigation
# ============================================================================

# Get the first day of the month
fn first_day_of_month(date: any) -> any:
    var year = date[0]
    var month = date[1]
    return (year, month, 1)

# Get the last day of the month
fn last_day_of_month(date: any) -> any:
    var year = date[0]
    var month = date[1]
    var last_day = days_in_month(year, month)
    return (year, month, last_day)

# Get the first day of the year
fn first_day_of_year(date: any) -> any:
    var year = date[0]
    return (year, 1, 1)

# Get the last day of the year
fn last_day_of_year(date: any) -> any:
    var year = date[0]
    return (year, 12, 31)

# Get the first day of the quarter
fn first_day_of_quarter(date: any) -> any:
    var year = date[0]
    var q = quarter(date)

    if q == 1:
        return (year, 1, 1)
    if q == 2:
        return (year, 4, 1)
    if q == 3:
        return (year, 7, 1)
    return (year, 10, 1)

# Get the last day of the quarter
fn last_day_of_quarter(date: any) -> any:
    var year = date[0]
    var q = quarter(date)

    if q == 1:
        return (year, 3, 31)
    if q == 2:
        return (year, 6, 30)
    if q == 3:
        return (year, 9, 30)
    return (year, 12, 31)

# Get the nth day of the month (e.g., nth=2, dow=1 = second Monday)
# Returns nil if that day doesn't exist in the month
fn nth_day_of_month(date: any, nth: i64, dow: i64) -> any:
    var year = date[0]
    var month = date[1]

    # Start with first day of month
    var first = first_day_of_month(date)
    var first_dow = day_of_week(first)

    # Calculate days to add to get to first occurrence of dow
    var days_to_add = dow - first_dow
    if days_to_add < 0:
        days_to_add = days_to_add + 7

    # Add weeks to get to nth occurrence
    days_to_add = days_to_add + ((nth - 1) * 7)

    # Check if result is still in the same month
    var result = add_days(first, days_to_add)
    var result_year = result[0]
    var result_month = result[1]

    if result_year != year:
        return nil
    if result_month != month:
        return nil

    return result

# Get the last occurrence of a day of week in a month
fn last_day_of_week_in_month(date: any, dow: i64) -> any:
    var last = last_day_of_month(date)
    var last_dow = day_of_week(last)

    # Calculate days to subtract to get to last occurrence of dow
    var days_to_sub = last_dow - dow
    if days_to_sub < 0:
        days_to_sub = days_to_sub + 7

    return subtract_days(last, days_to_sub)

# Get the next occurrence of a day of week
fn next_day_of_week(date: any, dow: i64) -> any:
    var current_dow = day_of_week(date)
    var days_to_add = dow - current_dow

    if days_to_add <= 0:
        days_to_add = days_to_add + 7

    return add_days(date, days_to_add)

# Get the previous occurrence of a day of week
fn prev_day_of_week(date: any, dow: i64) -> any:
    var current_dow = day_of_week(date)
    var days_to_sub = current_dow - dow

    if days_to_sub <= 0:
        days_to_sub = days_to_sub + 7

    return subtract_days(date, days_to_sub)

# ============================================================================
# Date Ranges and Sequences
# ============================================================================

# Generate a list of dates between start and end (inclusive)
fn date_range(start: any, end: any) -> any:
    var result = []
    var current = start

    var done = false
    while not done:
        result = array_push(result, current)

        if equal(current, end):
            done = true
        else:
            current = add_days(current, 1)

            # Safety check to prevent infinite loops
            if after(current, end):
                done = true

    return result

# Count the number of days between two dates (inclusive)
fn days_between(start: any, end: any) -> i64:
    var diff = difference_in_days(end, start)
    return diff + 1

# Count weekdays between two dates (inclusive)
fn weekdays_between(start: any, end: any) -> i64:
    var count = 0
    var current = start

    var done = false
    while not done:
        if is_weekday(current):
            count = count + 1

        if equal(current, end):
            done = true
        else:
            current = add_days(current, 1)

            # Safety check
            if after(current, end):
                done = true

    return count

# Count weekends between two dates (inclusive)
fn weekends_between(start: any, end: any) -> i64:
    var total = days_between(start, end)
    var weekdays = weekdays_between(start, end)
    return total - weekdays

# Count occurrences of a specific day of week between two dates
fn count_day_of_week(start: any, end: any, dow: i64) -> i64:
    var count = 0
    var current = start

    var done = false
    while not done:
        if day_of_week(current) == dow:
            count = count + 1

        if equal(current, end):
            done = true
        else:
            current = add_days(current, 1)

            # Safety check
            if after(current, end):
                done = true

    return count

# ============================================================================
# Advanced Calendar Calculations
# ============================================================================

# Calculate Easter Sunday for a given year (using Meeus/Jones/Butcher algorithm)
# Works for Gregorian calendar (years 1583+)
fn easter_date(year: i64) -> any:
    if year < 1583:
        return nil

    var a = year % 19
    var b = year / 100
    var c = year % 100
    var d = b / 4
    var e = b % 4
    var f = (b + 8) / 25
    var g = (b - f + 1) / 3
    var h = (19 * a + b - d - g + 15) % 30
    var i = c / 4
    var k = c % 4
    var l = (32 + 2 * e + 2 * i - h - k) % 7
    var m = (a + 11 * h + 22 * l) / 451
    var month = (h + l - 7 * m + 114) / 31
    var day = ((h + l - 7 * m + 114) % 31) + 1

    return (year, month, day)

# Calculate Good Friday (2 days before Easter)
fn good_friday(year: i64) -> any:
    var easter = easter_date(year)
    if easter == nil:
        return nil
    return subtract_days(easter, 2)

# Calculate Ash Wednesday (46 days before Easter)
fn ash_wednesday(year: i64) -> any:
    var easter = easter_date(year)
    if easter == nil:
        return nil
    return subtract_days(easter, 46)

# Calculate Pentecost (49 days after Easter)
fn pentecost(year: i64) -> any:
    var easter = easter_date(year)
    if easter == nil:
        return nil
    return add_days(easter, 49)

# Calculate Thanksgiving (US: 4th Thursday of November)
fn thanksgiving_us(year: i64) -> any:
    var nov1 = (year, 11, 1)
    return nth_day_of_month(nov1, 4, THURSDAY)

# Calculate Labor Day (US: 1st Monday of September)
fn labor_day_us(year: i64) -> any:
    var sep1 = (year, 9, 1)
    return nth_day_of_month(sep1, 1, MONDAY)

# Calculate Memorial Day (US: last Monday of May)
fn memorial_day_us(year: i64) -> any:
    var may1 = (year, 5, 1)
    return last_day_of_week_in_month(may1, MONDAY)

# ============================================================================
# Date Age and Duration Calculations
# ============================================================================

# Calculate age in years from birthdate to reference date
fn age_in_years(birthdate: any, reference: any) -> i64:
    var birth_year = birthdate[0]
    var birth_month = birthdate[1]
    var birth_day = birthdate[2]

    var ref_year = reference[0]
    var ref_month = reference[1]
    var ref_day = reference[2]

    var age = ref_year - birth_year

    # Adjust if birthday hasn't occurred yet this year
    if ref_month < birth_month:
        age = age - 1
    else:
        if ref_month == birth_month:
            if ref_day < birth_day:
                age = age - 1

    return age

# Calculate difference in months between two dates
fn difference_in_months(date1: any, date2: any) -> i64:
    var y1 = date1[0]
    var m1 = date1[1]
    var d1 = date1[2]

    var y2 = date2[0]
    var m2 = date2[1]
    var d2 = date2[2]

    var months = (y1 - y2) * 12 + (m1 - m2)

    # Adjust for day difference
    if d1 < d2:
        months = months - 1

    return months

# Calculate difference in years between two dates
fn difference_in_years(date1: any, date2: any) -> i64:
    return age_in_years(date2, date1)

# ============================================================================
# Helper Functions
# ============================================================================

# Push to array (helper for building result arrays)
fn array_push(arr: any, item: any) -> any:
    # This is a placeholder - actual implementation would use array operations
    return arr
