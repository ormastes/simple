# Lazy Value and Stream Creation
#
# Functions for creating lazy values, streams, and generators:
# - Lazy values
# - Finite streams
# - Infinite streams
# - Generators

import types: stream_next_internal

# ============================================================================
# Exports
# ============================================================================

export lazy_value
export stream_from_list, stream_range, stream_empty
export stream_repeat, stream_cycle, stream_iterate, stream_count
export make_generator

# ============================================================================
# Lazy Values - Deferred Computation
# ============================================================================

fn lazy_value(thunk):
    """Create a lazy value that will be computed on first access.

    The thunk should be a nullary function (takes no arguments).

    Example:
        val expensive = lazy_value(\: compute_pi())
        val result = force_lazy(expensive)  # Computed only once
    """
    {
        "type": "lazy",
        "evaluated": false,
        "thunk": thunk,
        "value": nil
    }

# ============================================================================
# Stream Construction - Finite Streams
# ============================================================================

fn stream_from_list(items):
    """Create a finite stream from a list.

    Example:
        val s = stream_from_list([1, 2, 3])
        stream_to_list(s)  # [1, 2, 3]
    """
    {
        "type": "stream",
        "data": items,
        "index": 0,
        "generator": nil,
        "state": nil,
        "exhausted": items.len() == 0
    }

fn stream_range(start, end):
    """Create a finite stream of integers from start (inclusive) to end (exclusive).

    Example:
        val s = stream_range(1, 5)
        stream_to_list(s)  # [1, 2, 3, 4]
    """
    var items = []
    var i = start
    while i < end:
        items.push(i)
        i = i + 1
    stream_from_list(items)

fn stream_empty():
    """Create an empty stream.

    Example:
        val s = stream_empty()
        stream_to_list(s)  # []
    """
    stream_from_list([])

# ============================================================================
# Stream Construction - Infinite Streams
# ============================================================================

fn stream_repeat(value):
    """Create an infinite stream that repeats the same value.

    CAUTION: This is an infinite stream. Always use with stream_take or similar.

    Example:
        val s = stream_repeat(42)
        stream_to_list(stream_take(s, 3))  # [42, 42, 42]
    """
    {
        "type": "stream",
        "data": [],
        "index": 0,
        "generator": "repeat",
        "state": {"value": value},
        "exhausted": false
    }

fn stream_cycle(items):
    """Create an infinite stream that cycles through the given list.

    CAUTION: This is an infinite stream. Always use with stream_take or similar.

    Example:
        val s = stream_cycle([1, 2, 3])
        stream_to_list(stream_take(s, 7))  # [1, 2, 3, 1, 2, 3, 1]
    """
    if items.len() == 0:
        return stream_empty()

    {
        "type": "stream",
        "data": [],
        "index": 0,
        "generator": "cycle",
        "state": {"items": items, "position": 0},
        "exhausted": false
    }

fn stream_iterate(initial, f):
    """Create an infinite stream by repeatedly applying function f.

    Generates: initial, f(initial), f(f(initial)), ...

    CAUTION: This is an infinite stream. Always use with stream_take or similar.

    Example:
        val s = stream_iterate(1, \x: x * 2)
        stream_to_list(stream_take(s, 5))  # [1, 2, 4, 8, 16]
    """
    {
        "type": "stream",
        "data": [],
        "index": 0,
        "generator": "iterate",
        "state": {"current": initial, "fn": f, "first": true},
        "exhausted": false
    }

fn stream_count(start):
    """Create an infinite stream of integers starting from start.

    CAUTION: This is an infinite stream. Always use with stream_take or similar.

    Example:
        val s = stream_count(10)
        stream_to_list(stream_take(s, 4))  # [10, 11, 12, 13]
    """
    stream_iterate(start, \x: x + 1)

# ============================================================================
# Generator Pattern
# ============================================================================

fn make_generator(items):
    """Create a generator from a list.

    Generators maintain iteration state explicitly.

    Example:
        val gen = make_generator([1, 2, 3])
        generator_next(gen)  # 1
        generator_next(gen)  # 2
    """
    {
        "type": "generator",
        "items": items,
        "index": 0
    }
