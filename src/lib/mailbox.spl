# Standard Library — Mailbox (Bounded Actor Message Queue)
#
# @tag:api
# @tag:stdlib
#
# Typed, bounded message queue for actor-style concurrency.
# Messages are text-serialized for simplicity (actors pass text blobs).
# All queues are capacity-bounded — no unbounded growth.
#
# Safety profile: capacity is required at construction time.
# mailbox_send returns bool — callers must handle queue-full.
#
# Usage:
#   val mb = mailbox_new(100)
#   mailbox_send(mb, "ping")
#   val msg = mailbox_receive(mb)   # nil if empty

struct Mailbox:
    capacity: i64
    messages: [text]
    count: i64

# Create a new bounded mailbox with the given maximum capacity.
fn mailbox_new(capacity: i64) -> Mailbox:
    Mailbox(capacity: capacity, messages: [], count: 0)

# Send a message to the mailbox.
# Returns true on success, false if the mailbox is full.
fn mailbox_send(mb: Mailbox, msg: text) -> bool:
    if mb.count >= mb.capacity:
        return false
    mb.messages.push(msg)
    mb.count = mb.count + 1
    true

# Receive the next message from the mailbox (FIFO order).
# Returns nil if the mailbox is empty.
fn mailbox_receive(mb: Mailbox) -> text:
    if mb.count <= 0:
        return nil
    val msg = mb.messages[0]
    var new_msgs: [text] = []
    var i = 1
    while i < mb.messages.len():
        new_msgs.push(mb.messages[i])
        i = i + 1
    mb.messages = new_msgs
    mb.count = mb.count - 1
    msg

# Try to receive without blocking — same as mailbox_receive (non-blocking by design).
fn mailbox_try_receive(mb: Mailbox) -> text:
    mailbox_receive(mb)

# Check if the mailbox is empty.
fn mailbox_is_empty(mb: Mailbox) -> bool:
    mb.count <= 0

# Check if the mailbox is full.
fn mailbox_is_full(mb: Mailbox) -> bool:
    mb.count >= mb.capacity

# Return the number of messages currently in the mailbox.
fn mailbox_size(mb: Mailbox) -> i64:
    mb.count

# Drain all messages from the mailbox and return them as an array.
fn mailbox_drain(mb: Mailbox) -> [text]:
    val all = mb.messages
    mb.messages = []
    mb.count = 0
    all

export Mailbox
export mailbox_new, mailbox_send, mailbox_receive, mailbox_try_receive
export mailbox_is_empty, mailbox_is_full, mailbox_size, mailbox_drain
