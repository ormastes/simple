# JWT Claims Module
#
# This module handles JWT payload (claims) operations.

# ============================================================================
# Claim Access Operations
# ============================================================================

# Get claim value from payload
fn get_claim(payload: list, key: text) -> text:
    var i = 0
    var len = payload.length()

    while i < len:
        var tuple = payload.at(i)
        var k = tuple.at(0)
        if k == key:
            return tuple.at(1)
        i = i + 1

    return ""

# Set claim in payload (returns new payload)
fn set_claim(payload: list, key: text, value: text) -> list:
    var result = []
    var found = false
    var i = 0
    var len = payload.length()

    while i < len:
        var tuple = payload.at(i)
        var k = tuple.at(0)

        if k == key:
            var new_tuple = [key, value]
            result = result + [new_tuple]
            found = true
        else:
            result = result + [tuple]

        i = i + 1

    if not found:
        var new_tuple = [key, value]
        result = result + [new_tuple]

    return result

# Remove claim from payload
fn remove_claim(payload: list, key: text) -> list:
    var result = []
    var i = 0
    var len = payload.length()

    while i < len:
        var tuple = payload.at(i)
        var k = tuple.at(0)

        if k != key:
            result = result + [tuple]

        i = i + 1

    return result

# Check if payload has claim
fn has_claim(payload: list, key: text) -> bool:
    var value = get_claim(payload, key)
    return value != ""

# ============================================================================
# Standard Claims Setters
# ============================================================================

# Get current Unix timestamp (seconds since epoch)
fn current_timestamp() -> i64:
    # NOTE: In production, use FFI to get actual system time
    # For demonstration, return a placeholder
    return 1700000000

# Set issued-at claim (iat) to current timestamp
fn set_iat(payload: list) -> list:
    var now = current_timestamp()
    var now_str = text.from_any(now)
    return set_claim(payload, "iat", now_str)

# Set expiration claim (exp) - expires after specified seconds
fn set_exp(payload: list, seconds: i64) -> list:
    var now = current_timestamp()
    var exp_time = now + seconds
    var exp_str = text.from_any(exp_time)
    return set_claim(payload, "exp", exp_str)

# Set not-before claim (nbf) - valid after specified seconds
fn set_nbf(payload: list, seconds: i64) -> list:
    var now = current_timestamp()
    var nbf_time = now + seconds
    var nbf_str = text.from_any(nbf_time)
    return set_claim(payload, "nbf", nbf_str)

# Set issuer claim (iss)
fn set_iss(payload: list, issuer: text) -> list:
    return set_claim(payload, "iss", issuer)

# Set subject claim (sub)
fn set_sub(payload: list, subject: text) -> list:
    return set_claim(payload, "sub", subject)

# Set audience claim (aud)
fn set_aud(payload: list, audience: text) -> list:
    return set_claim(payload, "aud", audience)

# Set JWT ID claim (jti)
fn set_jti(payload: list, jti: text) -> list:
    return set_claim(payload, "jti", jti)

# ============================================================================
# Claim Inspection
# ============================================================================

# Get expiration timestamp from payload
fn get_expiry_time(payload: list) -> i64:
    var exp_str = get_claim(payload, "exp")
    if exp_str == "":
        return 0

    # Parse string to integer
    var result = 0
    var i = 0
    var len = exp_str.length()

    while i < len:
        var c = exp_str.substring(i, i + 1)
        var digit = 0

        if c == "0":
            digit = 0
        if c == "1":
            digit = 1
        if c == "2":
            digit = 2
        if c == "3":
            digit = 3
        if c == "4":
            digit = 4
        if c == "5":
            digit = 5
        if c == "6":
            digit = 6
        if c == "7":
            digit = 7
        if c == "8":
            digit = 8
        if c == "9":
            digit = 9

        result = result * 10 + digit
        i = i + 1

    return result

# Get seconds until token expires (negative if expired)
fn get_time_until_expiry(payload: list) -> i64:
    var exp = get_expiry_time(payload)
    if exp == 0:
        return 0

    var now = current_timestamp()
    return exp - now

# Check if token is expired
fn is_expired(payload: list) -> bool:
    var time_left = get_time_until_expiry(payload)
    return time_left < 0

# Count claims in payload
fn count_claims(payload: list) -> i64:
    return payload.length()

# Get claim keys
fn get_claim_keys(payload: list) -> list:
    var result = []
    var i = 0
    var len = payload.length()

    while i < len:
        var tuple = payload.at(i)
        var key = tuple.at(0)
        result = result + [key]
        i = i + 1

    return result
