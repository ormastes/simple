# JSON Serializer
#
# Purpose: Serialization of JSON values to text format
#
# Contains:
# - Basic: json_serialize, json_stringify
# - Formatting: json_pretty, json_format, json_indent
# - Utilities: json_minify, json_beautify, json_escape_string

# Import types for type checking
mod json.types

fn json_escape_string(s: text) -> text:
    """Escape string for JSON encoding.

    Args:
        s: String to escape

    Returns:
        Escaped string

    Example:
        json_escape_string("hello\nworld")  # "hello\\nworld"
    """
    var parts: [text] = []
    var seg_start = 0
    var i = 0
    while i < s.len():
        val c = s.char_at(i)
        if (c == "\"" or c == "\\" or c == "\n" or c == "\r" or c == "\t"):
            if i > seg_start:
                parts = parts.push(s[seg_start:i])
            if c == "\"":
                parts = parts.push("\\\"")
            elif c == "\\":
                parts = parts.push("\\\\")
            elif c == "\n":
                parts = parts.push("\\n")
            elif c == "\r":
                parts = parts.push("\\r")
            elif c == "\t":
                parts = parts.push("\\t")
            seg_start = i + 1
        i = i + 1
    if seg_start == 0:
        return s
    if i > seg_start:
        parts = parts.push(s[seg_start:i])
    parts.join("")

fn json_serialize(value: any) -> text:
    """Serialize JSON value to text.

    Args:
        value: JSON value

    Returns:
        JSON text

    Example:
        json_serialize(json_object({"key": json_string("value")}))
    """
    if value == nil:
        return "null"
    val value_type = json_get_type(value)
    if value_type == "null":
        return "null"
    if value_type == "boolean":
        val b = json_to_boolean(value)
        if b:
            return "true"
        return "false"
    if value_type == "number":
        val n = json_to_number(value)
        return n.to_string()
    if value_type == "string":
        val s = json_to_string(value)
        val escaped = json_escape_string(s)
        return "\"{escaped}\""
    if value_type == "array":
        val list = json_to_array(value)
        var result = "["
        for i in 0..list.len():
            if i > 0:
                result = result + ","
            result = result + json_serialize(list[i])
        result = result + "]"
        return result
    if value_type == "object":
        val map = json_to_object(value)
        var result = "{"
        val keys = map.keys()
        for i in 0..keys.len():
            if i > 0:
                result = result + ","
            val key = keys[i]
            val escaped_key = json_escape_string(key)
            result = result + "\"{escaped_key}\":"
            result = result + json_serialize(map[key])
        result = result + "}"
        return result
    "null"

fn json_indent(level: i64, size: i64) -> text:
    """Generate indentation string.

    Args:
        level: Indentation level
        size: Spaces per level

    Returns:
        Indentation string
    """
    val total = level * size
    if total <= 0: return ""
    # Build a single-level indent, then repeat via doubling
    var unit = ""
    for i in 0..size:
        unit = unit + " "
    if level <= 0: return ""
    if level == 1: return unit
    var result = unit
    var count = 1
    while count * 2 <= level:
        result = result + result
        count = count * 2
    while count < level:
        result = result + unit
        count = count + 1
    result

fn json_format(value: any, indent_level: i64, indent_size: i64) -> text:
    """Serialize JSON value with custom indentation.

    Args:
        value: JSON value
        indent_level: Current indentation level
        indent_size: Number of spaces per indent level

    Returns:
        Formatted JSON text

    Example:
        json_format(data, 0, 4)
    """
    if value == nil:
        return "null"
    val value_type = json_get_type(value)
    if value_type == "null":
        return "null"
    if value_type == "boolean":
        val b = json_to_boolean(value)
        if b:
            return "true"
        return "false"
    if value_type == "number":
        val n = json_to_number(value)
        return n.to_string()
    if value_type == "string":
        val s = json_to_string(value)
        val escaped = json_escape_string(s)
        return "\"{escaped}\""
    if value_type == "array":
        val list = json_to_array(value)
        if list.len() == 0:
            return "[]"
        var result = "[\n"
        for i in 0..list.len():
            result = result + json_indent(indent_level + 1, indent_size)
            result = result + json_format(list[i], indent_level + 1, indent_size)
            if i < list.len() - 1:
                result = result + ","
            result = result + "\n"
        result = result + json_indent(indent_level, indent_size)
        result = result + "]"
        return result
    if value_type == "object":
        val map = json_to_object(value)
        val keys = map.keys()
        if keys.len() == 0:
            return "{}"
        var result = "{\n"
        for i in 0..keys.len():
            result = result + json_indent(indent_level + 1, indent_size)
            val key = keys[i]
            val escaped_key = json_escape_string(key)
            result = result + "\"{escaped_key}\": "
            result = result + json_format(map[key], indent_level + 1, indent_size)
            if i < keys.len() - 1:
                result = result + ","
            result = result + "\n"
        result = result + json_indent(indent_level, indent_size)
        result = result + "}"
        return result
    "null"

fn json_pretty(value: any) -> text:
    """Serialize JSON value to pretty-printed text.

    Args:
        value: JSON value

    Returns:
        Formatted JSON text with indentation

    Example:
        json_pretty(data)
    """
    json_format(value, 0, 2)

fn json_stringify(value: any) -> text:
    """Alias for json_serialize.

    Args:
        value: JSON value

    Returns:
        JSON string

    Example:
        json_stringify(data)
    """
    json_serialize(value)

fn json_minify(text: text) -> text:
    """Remove whitespace from JSON text.

    Args:
        text: JSON text

    Returns:
        Minified JSON text

    Example:
        json_minify("{ \"key\": 42 }")  # "{\"key\":42}"
    """
    # Import from parser module
    mod json.parser
    val value = json_parse(text)
    if value == nil:
        return text
    json_serialize(value)

fn json_beautify(text: text) -> text:
    """Pretty-print JSON text.

    Args:
        text: JSON text

    Returns:
        Formatted JSON text

    Example:
        json_beautify("{\"key\":42}")
    """
    # Import from parser module
    mod json.parser
    val value = json_parse(text)
    if value == nil:
        return text
    json_pretty(value)

export *
