# JSON Validation
#
# Purpose: Schema validation and deep comparison
#
# Contains:
# - Schema validation: json_validate_schema
# - Deep comparison: json_deep_equals, json_deep_clone
# - Schema format: JSON objects with type requirements

# Import types
mod json.types

fn json_validate_schema(value: any, schema: any) -> (bool, text):
    """Validate JSON value against a schema.

    Args:
        value: JSON value to validate
        schema: Schema definition (JSON object with type requirements)

    Returns:
        (is_valid, error_message)

    Schema format:
        {"type": "object"|"array"|"string"|"number"|"boolean"|"null"}
        {"type": "object", "properties": {...}}
        {"type": "array", "items": {...}}

    Example:
        val schema = json_object({"type": json_string("number")})
        val (valid, error) = json_validate_schema(value, schema)
    """
    if schema == nil:
        return (true, "")

    # Import object_ops for json_object_get
    mod json.object_ops

    val schema_type = json_object_get(schema, "type")
    if schema_type == nil:
        return (true, "")
    val expected_type = json_to_string(schema_type)
    if expected_type == nil:
        return (true, "")
    val actual_type = json_get_type(value)
    if actual_type != expected_type:
        return (false, "Expected type {expected_type}, got {actual_type}")
    if expected_type == "object":
        val properties = json_object_get(schema, "properties")
        if properties != nil:
            val props_map = json_to_object(properties)
            if props_map != nil:
                for key in props_map.keys():
                    val prop_schema = props_map[key]
                    val prop_value = json_object_get(value, key)
                    val result = json_validate_schema(prop_value, prop_schema)
                    if not result.0:
                        return (false, "Property '{key}': {result.1}")
    if expected_type == "array":
        val items_schema = json_object_get(schema, "items")
        if items_schema != nil:
            val list = json_to_array(value)
            if list != nil:
                for i in 0..list.len():
                    val result = json_validate_schema(list[i], items_schema)
                    if not result.0:
                        return (false, "Item {i}: {result.1}")
    (true, "")

fn json_deep_equals(a: any, b: any) -> bool:
    """Deep equality comparison for JSON values.

    Args:
        a: First JSON value
        b: Second JSON value

    Returns:
        true if values are deeply equal, false otherwise

    Example:
        json_deep_equals(val1, val2)
    """
    if a == nil and b == nil:
        return true
    if a == nil or b == nil:
        return false
    val type_a = json_get_type(a)
    val type_b = json_get_type(b)
    if type_a != type_b:
        return false
    if type_a == "null":
        return true
    if type_a == "boolean":
        return json_to_boolean(a) == json_to_boolean(b)
    if type_a == "number":
        return json_to_number(a) == json_to_number(b)
    if type_a == "string":
        return json_to_string(a) == json_to_string(b)
    if type_a == "array":
        val list_a = json_to_array(a)
        val list_b = json_to_array(b)
        if list_a.len() != list_b.len():
            return false
        for i in 0..list_a.len():
            if not json_deep_equals(list_a[i], list_b[i]):
                return false
        return true
    if type_a == "object":
        val map_a = json_to_object(a)
        val map_b = json_to_object(b)
        val keys_a = map_a.keys()
        val keys_b = map_b.keys()
        if keys_a.len() != keys_b.len():
            return false
        for key in keys_a:
            if not map_b.has_key(key):
                return false
            if not json_deep_equals(map_a[key], map_b[key]):
                return false
        return true
    false

fn json_deep_clone(value: any) -> any:
    """Deep clone a JSON value.

    Args:
        value: JSON value to clone

    Returns:
        Deep copy of the value

    Example:
        val copy = json_deep_clone(original)
    """
    if value == nil:
        return nil
    val value_type = json_get_type(value)
    if value_type == "null":
        return json_null()
    if value_type == "boolean":
        return json_boolean(json_to_boolean(value))
    if value_type == "number":
        return json_number(json_to_number(value))
    if value_type == "string":
        return json_string(json_to_string(value))
    if value_type == "array":
        val list = json_to_array(value)
        var new_list: [any] = []
        for elem in list:
            new_list = new_list + [json_deep_clone(elem)]
        return json_array(new_list)
    if value_type == "object":
        val map = json_to_object(value)
        var new_map: {text: any} = {}
        for key in map.keys():
            new_map[key] = json_deep_clone(map[key])
        return json_object(new_map)
    nil

export *
