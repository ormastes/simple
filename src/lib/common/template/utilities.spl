# Template Engine Utilities Module
# Template-specific utilities
# Core string operations delegated to string_core module

use std.text_core.{str_index_of, str_contains, str_starts_with, str_ends_with}
use std.text_core.{str_trim, str_trim_left, str_trim_right}
use std.text_core.{str_split, str_replace_all}
use std.text_core.{str_to_lower, str_to_upper, str_capitalize, str_reverse}
use std.text_core.{str_repeat, str_truncate, str_pad_left, str_pad_right, str_center}
use std.text_core.{is_alpha_char, is_digit_char, is_alnum_char, is_whitespace_char}

# ============================================================================
# CHARACTER AND STRING UTILITIES
# ============================================================================
# Note: Core character classification functions imported from string_core

fn char_at_safe(s: text, idx: i64) -> text:
    """Safe character access with bounds checking."""
    use std.text_core.{str_char_at}
    str_char_at(s, idx)

fn substr_safe(s: text, start: i64, end_val: i64) -> text:
    """Safe substring extraction with bounds checking."""
    use std.text_core.{str_safe_slice}
    str_safe_slice(s, start, end_val)

fn int_to_str(n: i64) -> text:
    """Convert integer to string."""
    use compiler_core.types.{int_to_str as core_int_to_str}
    core_int_to_str(n)

fn str_to_int(s: text) -> i64:
    """Parse string to integer."""
    use std.text.{parse_i64_safe}
    parse_i64_safe(s)

fn int_to_hex_str(n: i64) -> text:
    if n == 0:
        return "00"
    var result = ""
    var num = n
    while num > 0:
        val digit = num % 16
        if digit < 10:
            result = char_from_code(48 + digit) + result
        else:
            result = char_from_code(65 + digit - 10) + result
        num = num / 16
    if result.len() == 1:
        result = "0" + result
    result

fn hex_str_to_int(s: text) -> i64:
    var result = 0
    var i = 0
    while i < s.len():
        val c = s[i:i+1]
        val code = char_code(c)
        var digit = 0
        if code >= 48 and code <= 57:
            digit = code - 48
        else:
            if code >= 65 and code <= 70:
                digit = code - 65 + 10
            else:
                if code >= 97 and code <= 102:
                    digit = code - 97 + 10
        result = result * 16 + digit
        i = i + 1
    result

# ============================================================================
# HTML ESCAPING
# ============================================================================

fn html_escape(s: text) -> text:
    var result = s
    result = str_replace_all(result, "&", "&amp;")
    result = str_replace_all(result, "<", "&lt;")
    result = str_replace_all(result, ">", "&gt;")
    result = str_replace_all(result, "\"", "&quot;")
    result = str_replace_all(result, "'", "&#39;")
    result

fn html_unescape(s: text) -> text:
    var result = s
    result = str_replace_all(result, "&lt;", "<")
    result = str_replace_all(result, "&gt;", ">")
    result = str_replace_all(result, "&quot;", "\"")
    result = str_replace_all(result, "&#39;", "'")
    result = str_replace_all(result, "&amp;", "&")
    result

fn url_encode(s: text) -> text:
    var result = ""
    var i = 0
    while i < s.len():
        val c = s[i:i+1]
        val code = char_code(c)
        val is_safe = is_alnum_char(c) or c == "-" or c == "_" or c == "." or c == "~"
        if is_safe:
            result = result + c
        else:
            result = result + "%" + int_to_hex_str(code)
        i = i + 1
    result

fn url_decode(s: text) -> text:
    var result = ""
    var i = 0
    while i < s.len():
        val c = s[i:i+1]
        if c == "%":
            if i + 2 < s.len():
                val hex = s[i+1:i+3]
                val code = hex_str_to_int(hex)
                result = result + char_from_code(code)
                i = i + 3
            else:
                result = result + c
                i = i + 1
        else:
            result = result + c
            i = i + 1
    result

fn js_escape(s: text) -> text:
    var result = s
    result = str_replace_all(result, "\\", "\\\\")
    result = str_replace_all(result, "\"", "\\\"")
    result = str_replace_all(result, "'", "\\'")
    result = str_replace_all(result, "\n", "\\n")
    result = str_replace_all(result, "\r", "\\r")
    result = str_replace_all(result, "\t", "\\t")
    result

fn css_escape(s: text) -> text:
    var result = s
    result = str_replace_all(result, "\"", "\\\"")
    result = str_replace_all(result, "'", "\\'")
    result

# ============================================================================
# EXPORTS
# ============================================================================

# Template-specific safe wrappers
export char_at_safe, substr_safe

# Integer/hex conversion
export int_to_str, str_to_int, int_to_hex_str, hex_str_to_int

# Template escaping functions (HTML, URL, JS, CSS)
export html_escape, html_unescape, url_encode, url_decode, js_escape, css_escape

# Re-export string_core functions for convenience
export is_whitespace_char, is_alpha_char, is_digit_char, is_alnum_char
export str_index_of, str_contains, str_starts_with, str_ends_with
export str_trim, str_trim_left, str_trim_right
export str_split, str_replace_all
export str_to_lower, str_to_upper, str_capitalize, str_reverse
export str_repeat, str_truncate, str_pad_left, str_pad_right, str_center
