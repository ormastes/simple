# Suffix Tree Build Module

# ============================================================================
# Core Construction
# ============================================================================

fn suffix_tree_new(text: text) -> (text, list, i64):
    """Create a new suffix tree from text using naive O(nÂ²) construction"""
    val root_node = (0, 0, [], nil, 0)
    val nodes = [root_node]
    val tree = (text, nodes, 0)

    val n = text_length(text)
    var i = 0
    while i < n:
        val suffix = text_slice_from(text, i)
        var updated_tree = suffix_tree_insert_suffix(tree, suffix, i)
        tree = updated_tree
        i = i + 1

    tree

fn suffix_tree_insert_suffix(tree: (text, list, i64), suffix: text, suffix_start: i64) -> (text, list, i64):
    """Insert a suffix into the tree (helper for naive construction)"""
    val text_val = tree.0
    val nodes = tree.1
    val root_id = tree.2

    var current_id = root_id
    var pos = 0
    val suffix_len = text_length(suffix)

    while pos < suffix_len:
        val current_char = text_char_at(suffix, pos)
        val current_node = list_get(nodes, current_id)
        val children = current_node.2

        var found = false
        var child_idx = 0
        var matching_child_id = -1

        while child_idx < list_length(children):
            val child_entry = list_get(children, child_idx)
            val edge_char = child_entry.0
            val child_id = child_entry.1

            if edge_char == current_char:
                found = true
                matching_child_id = child_id
                child_idx = list_length(children)

            child_idx = child_idx + 1

        if found:
            current_id = matching_child_id
            pos = pos + 1
        else:
            val new_node_id = list_length(nodes)
            val edge_start = suffix_start + pos
            val edge_end = suffix_start + suffix_len
            val new_node = (edge_start, edge_end, [], nil, new_node_id)

            var updated_nodes = list_append(nodes, new_node)
            nodes = updated_nodes

            val updated_children = list_append(children, (current_char, new_node_id))
            val updated_current = (current_node.0, current_node.1, updated_children, current_node.3, current_node.4)
            updated_nodes = list_set(nodes, current_id, updated_current)
            nodes = updated_nodes

            pos = suffix_len

    (text_val, nodes, root_id)

fn suffix_tree_ukkonen(text: text) -> (text, list, i64):
    """Create suffix tree using Ukkonen's O(n) algorithm (simplified)"""
    # Note: Full Ukkonen's is complex; this is a simplified version
    # For production, use suffix_tree_new which is more reliable
    suffix_tree_new(text)

# ============================================================================
# Suffix Array Operations
# ============================================================================

fn suffix_tree_to_suffix_array(tree: (text, list, i64)) -> list:
    """Convert suffix tree to suffix array"""
    val text_val = tree.0
    val n = text_length(text_val)
    val root_id = tree.2

    var suffixes = []
    var i = 0
    while i < n:
        val suffix = text_slice_from(text_val, i)
        suffixes = list_append(suffixes, (i, suffix))
        i = i + 1

    val sorted = suffix_array_sort(suffixes)

    var result = []
    var idx = 0
    while idx < list_length(sorted):
        val entry = list_get(sorted, idx)
        result = list_append(result, entry.0)
        idx = idx + 1

    result

fn suffix_array_sort(suffixes: list) -> list:
    """Sort suffixes lexicographically (bubble sort)"""
    var arr = suffixes
    val n = list_length(arr)

    var i = 0
    while i < n:
        var j = 0
        while j < n - i - 1:
            val entry1 = list_get(arr, j)
            val entry2 = list_get(arr, j + 1)

            if text_compare(entry1.1, entry2.1) > 0:
                arr = list_set(arr, j, entry2)
                arr = list_set(arr, j + 1, entry1)

            j = j + 1
        i = i + 1

    arr

fn suffix_array_from_text(text: text) -> list:
    """Build suffix array directly from text"""
    val tree = suffix_tree_new(text)
    suffix_tree_to_suffix_array(tree)

fn suffix_array_to_suffix_tree(text: text, sa: list) -> (text, list, i64):
    """Convert suffix array to suffix tree (reconstruct)"""
    suffix_tree_new(text)


# Export all public functions
