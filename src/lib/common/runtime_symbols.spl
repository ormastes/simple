# Runtime Symbols
#
# Runtime symbol resolution for FFI. Provides ABI versioning
# and the complete list of runtime symbol names.
#
# Port of rust/common/src/runtime_symbols.rs

# ============================================================================
# ABI Version
# ============================================================================

struct AbiVersion:
    """Semantic version for runtime ABI compatibility."""
    major: i64
    minor: i64

val CURRENT_ABI = AbiVersion(major: 1, minor: 1)

impl AbiVersion:
    fn is_compatible_with(other: AbiVersion) -> bool:
        """Check if this ABI is compatible with another.
        Compatible if same major version and this minor >= other minor."""
        self.major == other.major and self.minor >= other.minor

    fn to_u32() -> i64:
        """Encode as (major << 16) | minor."""
        (self.major * 65536) + self.minor

    static fn from_u32(encoded: i64) -> AbiVersion:
        """Decode from (major << 16) | minor."""
        AbiVersion(major: encoded / 65536, minor: encoded % 65536)

    fn to_text() -> text:
        "v{self.major}.{self.minor}"

# ============================================================================
# Runtime Symbol Provider
# ============================================================================

trait RuntimeSymbolProvider:
    """Abstract interface for resolving runtime symbols."""
    fn get_symbol(name: text) -> i64?
    fn has_symbol(name: text) -> bool
    fn symbols() -> [text]
    fn abi_version() -> AbiVersion
    fn name() -> text

# ============================================================================
# Runtime Symbol Names
# ============================================================================

val RUNTIME_SYMBOL_NAMES: [text] = [
    # AOP runtime
    "rt_aop_invoke_around", "rt_aop_proceed",
    # Array operations
    "rt_array_new", "rt_array_push", "rt_array_pop", "rt_array_get",
    "rt_array_set", "rt_array_len", "rt_array_slice", "rt_array_concat",
    "rt_array_contains", "rt_array_index_of", "rt_array_remove",
    "rt_array_insert", "rt_array_sort", "rt_array_reverse",
    "rt_array_map", "rt_array_filter", "rt_array_reduce",
    "rt_array_flat_map", "rt_array_zip", "rt_array_enumerate",
    "rt_array_any", "rt_array_all", "rt_array_take", "rt_array_drop",
    # Tuple operations
    "rt_tuple_new", "rt_tuple_get", "rt_tuple_len",
    # Dict operations
    "rt_dict_new", "rt_dict_get", "rt_dict_set", "rt_dict_remove",
    "rt_dict_contains", "rt_dict_keys", "rt_dict_values", "rt_dict_len",
    "rt_dict_entries", "rt_dict_merge",
    # String operations
    "rt_string_new", "rt_string_concat", "rt_string_len",
    "rt_string_slice", "rt_string_contains", "rt_string_replace",
    "rt_string_split", "rt_string_trim", "rt_string_upper", "rt_string_lower",
    "rt_string_starts_with", "rt_string_ends_with", "rt_string_index_of",
    "rt_string_char_at", "rt_string_to_int", "rt_string_to_float",
    # Regex operations
    "rt_regex_new", "rt_regex_is_match", "rt_regex_find",
    "rt_regex_find_all", "rt_regex_replace", "rt_regex_replace_all",
    "rt_regex_captures", "rt_regex_split",
    # Object operations
    "rt_object_new", "rt_object_get_field", "rt_object_set_field",
    "rt_object_has_field", "rt_object_type_name",
    # Closure operations
    "rt_closure_new", "rt_closure_call", "rt_closure_bind",
    # Enum operations
    "rt_enum_new", "rt_enum_variant", "rt_enum_data", "rt_enum_is_variant",
    # Memory allocation
    "rt_alloc", "rt_free", "rt_realloc",
    # Async/Concurrency
    "rt_future_new", "rt_future_await", "rt_future_poll",
    "rt_actor_spawn", "rt_actor_send", "rt_actor_receive",
    "rt_generator_new", "rt_generator_next", "rt_generator_return",
    "rt_channel_new", "rt_channel_send", "rt_channel_receive",
    "rt_mutex_new", "rt_mutex_lock", "rt_mutex_unlock",
    # I/O: Print
    "rt_print", "rt_println", "rt_eprint", "rt_eprintln",
    "rt_format", "rt_debug_print",
    # I/O: Environment
    "rt_env_get", "rt_env_set", "rt_env_vars", "rt_env_args",
    "rt_env_current_dir", "rt_env_home_dir",
    # I/O: Process
    "rt_process_exit", "rt_process_abort", "rt_process_id",
    "rt_process_spawn", "rt_process_wait", "rt_process_kill",
    # I/O: File
    "rt_file_read_text", "rt_file_write_text",
    "rt_file_read_bytes", "rt_file_write_bytes",
    "rt_file_exists", "rt_file_delete", "rt_file_rename",
    "rt_file_copy", "rt_file_size", "rt_file_is_dir",
    "rt_file_is_file", "rt_file_create_dir", "rt_file_list_dir",
    "rt_file_canonical", "rt_file_temp_dir",
    "rt_file_mmap_read_text", "rt_file_mmap_read_bytes",
    # I/O: Network
    "rt_net_http_get", "rt_net_http_post",
    "rt_net_tcp_connect", "rt_net_tcp_listen",
    "rt_net_tcp_accept", "rt_net_tcp_read", "rt_net_tcp_write",
    # I/O: Time
    "rt_time_now", "rt_time_now_millis", "rt_time_sleep",
    # Collections: HashMap
    "rt_hashmap_new", "rt_hashmap_insert", "rt_hashmap_get",
    "rt_hashmap_remove", "rt_hashmap_contains", "rt_hashmap_len",
    "rt_hashmap_keys", "rt_hashmap_values",
    # Collections: BTreeMap
    "rt_btreemap_new", "rt_btreemap_insert", "rt_btreemap_get",
    "rt_btreemap_remove", "rt_btreemap_range",
    # Collections: HashSet
    "rt_hashset_new", "rt_hashset_insert", "rt_hashset_contains",
    "rt_hashset_remove", "rt_hashset_len",
    "rt_hashset_union", "rt_hashset_intersection", "rt_hashset_difference",
    # Collections: BTreeSet
    "rt_btreeset_new", "rt_btreeset_insert", "rt_btreeset_contains",
    "rt_btreeset_remove", "rt_btreeset_range",
    # Sandbox
    "rt_sandbox_set_memory_limit", "rt_sandbox_set_cpu_limit",
    "rt_sandbox_set_file_limit", "rt_sandbox_set_net_policy",
    "rt_sandbox_enable", "rt_sandbox_disable",
    "rt_sandbox_is_enabled", "rt_sandbox_check_memory",
    "rt_sandbox_check_cpu", "rt_sandbox_check_file",
    "rt_sandbox_check_net", "rt_sandbox_get_memory_usage",
    "rt_sandbox_get_cpu_usage", "rt_sandbox_get_file_count",
    "rt_sandbox_reset_limits", "rt_sandbox_get_limits",
    "rt_sandbox_set_process_limit", "rt_sandbox_check_process",
    # Value operations
    "rt_value_to_string", "rt_value_to_debug_string",
    "rt_value_equals", "rt_value_compare",
    "rt_value_hash", "rt_value_type_name",
    "rt_value_clone", "rt_value_is_nil",
    # Math
    "rt_math_abs", "rt_math_sqrt", "rt_math_pow",
    "rt_math_sin", "rt_math_cos", "rt_math_tan",
    "rt_math_log", "rt_math_exp", "rt_math_floor", "rt_math_ceil",
    "rt_math_round", "rt_math_min", "rt_math_max", "rt_math_random"
]

fn has_runtime_symbol(name: text) -> bool:
    """Check if a name is a known runtime symbol."""
    RUNTIME_SYMBOL_NAMES.contains(name)

export AbiVersion, CURRENT_ABI
export RuntimeSymbolProvider
export RUNTIME_SYMBOL_NAMES, has_runtime_symbol
