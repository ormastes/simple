# Map Set Operations

fn map_put(map, key: text, value):
    """Add or update key-value pair. Returns new map.

    If key exists, updates value. Otherwise adds new entry.

    Example:
        val m = map_create()
        val m2 = map_put(m, "x", 10)
        val m3 = map_put(m2, "x", 20)  # Updates x
        map_get(m3, "x")  # 20
    """
    var result = []
    var found = false

    var i = 0
    while i < map.len():
        val entry = map[i]
        if entry[0] == key:
            result.push((key, value))
            found = true
        else:
            result.push(entry)
        i = i + 1

    if not found:
        result.push((key, value))

    result

fn map_update(map, key: text, update_fn):
    """Update value for key using function. Returns new map.

    If key doesn't exist, does nothing.

    Example:
        val m = map_put(map_create(), "x", 10)
        val m2 = map_update(m, "x", \v: v + 5)
        map_get(m2, "x")  # 15
    """
    val existing = map_get(map, key)
    if existing == nil:
        return map

    val new_value = update_fn(existing)
    map_put(map, key, new_value)

fn map_update_or_insert(map, key: text, update_fn, default_value):
    """Update existing value or insert default if key not found.

    Example:
        val m = map_create()
        val m2 = map_update_or_insert(m, "x", \v: v + 1, 0)
        map_get(m2, "x")  # 0
        val m3 = map_update_or_insert(m2, "x", \v: v + 1, 0)
        map_get(m3, "x")  # 1
    """
    val existing = map_get(map, key)
    if existing == nil:
        return map_put(map, key, default_value)

    val new_value = update_fn(existing)
    map_put(map, key, new_value)

fn map_nested_put(map, keys, value):
    """Set value in nested map using array of keys.

    Creates intermediate maps as needed.

    Example:
        val m = map_create()
        val m2 = map_nested_put(m, ["a", "b"], 2)
        map_nested_get(m2, ["a", "b"])  # 2
    """
    if keys.len() == 0:
        return map

    if keys.len() == 1:
        return map_put(map, keys[0], value)

    val first_key = keys[0]
    val rest_keys = keys[1:]

    val existing = map_get(map, first_key)
    val inner_map = if existing == nil: map_create() else: existing

    val updated_inner = map_nested_put(inner_map, rest_keys, value)
    map_put(map, first_key, updated_inner)
