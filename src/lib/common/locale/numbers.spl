# Locale Number Formatting
# Provides number and percentage formatting for different locales.

import locale::types

# ============================================================================
# NUMBER FORMATTING
# ============================================================================

fn get_decimal_separator(locale: (text, text, text, text)) -> text:
    # Gets the decimal separator for a locale.
    # Returns: "." for most locales, "," for European locales

    var lang = locale.0

    # European locales use comma
    if lang == "fr" or lang == "de" or lang == "es" or lang == "it" or lang == "pt" or lang == "ru" or lang == "nl" or lang == "sv" or lang == "pl":
        return ","

    # Most other locales use period
    "."

fn get_thousands_separator(locale: (text, text, text, text)) -> text:
    # Gets the thousands separator for a locale.
    # Returns: "," for English, " " for French, "." for German, etc.

    var lang = locale.0

    # French uses space
    if lang == "fr":
        return " "

    # German and similar use period
    if lang == "de" or lang == "it" or lang == "nl" or lang == "es" or lang == "pt":
        return "."

    # Most others use comma
    ","

fn format_integer_part(num: i64, sep: text) -> text:
    # Internal: Formats integer with thousands separator.
    # Returns: Formatted string (e.g., "1,234,567")

    var str = num.to_text()
    var len = str.length()

    if len <= 3:
        return str

    # Build result from right to left
    var result = ""
    var count = 0
    var i = len - 1

    while i >= 0:
        if count == 3:
            result = sep + result
            count = 0

        var ch = str.substring(i, i + 1)
        result = ch + result
        count = count + 1
        i = i - 1

    result

fn format_number(num: i64, locale: (text, text, text, text)) -> text:
    # Formats an integer with locale-specific thousands separator.
    # Returns: Formatted number string
    #
    # Example:
    #   format_number(1234567, locale_en_us())  # "1,234,567"
    #   format_number(1234567, locale_fr_fr())  # "1 234 567"

    var sep = get_thousands_separator(locale)
    format_integer_part(num, sep)

fn format_decimal(num: i64, decimals: i64, locale: (text, text, text, text)) -> text:
    # Formats a number as decimal with specified decimal places.
    # Note: num is in "cents" (multiply by 100)
    # Returns: Formatted decimal string
    #
    # Example:
    #   format_decimal(123456789, 2, locale_en_us())  # "1,234,567.89"
    #   format_decimal(123456789, 2, locale_fr_fr())  # "1 234 567,89"

    var dec_sep = get_decimal_separator(locale)
    var thou_sep = get_thousands_separator(locale)

    # Calculate integer and fractional parts
    var divisor = 1
    var i = 0
    while i < decimals:
        divisor = divisor * 10
        i = i + 1

    var int_part = num / divisor
    var frac_part = num % divisor

    # Handle negative fractional part
    if frac_part < 0:
        frac_part = 0 - frac_part

    # Format integer part with thousands separator
    var int_str = format_integer_part(int_part, thou_sep)

    # Format fractional part with leading zeros
    var frac_str = frac_part.to_text()
    while frac_str.length() < decimals:
        frac_str = "0" + frac_str

    int_str + dec_sep + frac_str

# ============================================================================
# PERCENTAGE FORMATTING
# ============================================================================

fn format_percent(ratio: i64, locale: (text, text, text, text)) -> text:
    # Formats a ratio as percentage (ratio is per-10000).
    # Returns: Formatted percentage string
    #
    # Example:
    #   format_percent(7550, locale_en_us())  # "75.50%"
    #   format_percent(7550, locale_fr_fr())  # "75,50 %"

    var lang = locale.0

    # Format as decimal with 2 places
    var num_str = format_decimal(ratio, 2, locale)

    # French puts space before %
    if lang == "fr":
        return num_str + " %"

    num_str + "%"

fn parse_percent(text: text, locale: (text, text, text, text)) -> i64:
    # Parses a percentage string to ratio (per-10000).
    # Returns: Ratio or 0 on error
    #
    # Example:
    #   parse_percent("75.50%", locale_en_us())  # 7550

    var dec_sep = get_decimal_separator(locale)

    # Remove % and whitespace
    var cleaned = text.replace("%", "")
    cleaned = cleaned.replace(" ", "")

    # Split by decimal separator
    var parts = cleaned.split(dec_sep)

    if parts.length() == 0:
        return 0

    var int_part = 0
    var int_str = parts.get(0)
    if int_str != "":
        int_part = int_str.to_int()

    var frac_part = 0
    if parts.length() >= 2:
        var frac_str = parts.get(1)
        if frac_str != "":
            frac_part = frac_str.to_int()

    int_part * 100 + frac_part
