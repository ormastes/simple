# Simple Language Formatter for Diagnostic Output
#
# Provides diagnostic output in Simple language syntax for specs and tests.

use std.text.{NL}
use compiler_shared.diagnostics.{Diagnostic, Severity, Span, Label}

# Simple language formatter for spec-compatible output
struct SimpleFormatter:
    simple_syntax: bool

impl SimpleFormatter:
    # Create a new Simple formatter (uses Simple syntax)
    static fn new() -> SimpleFormatter:
        SimpleFormatter(simple_syntax: true)

    # Create a plain text formatter
    static fn plain() -> SimpleFormatter:
        SimpleFormatter(simple_syntax: false)

    # Format a diagnostic
    fn format(diagnostic: Diagnostic) -> text:
        if self.simple_syntax:
            self.format_as_simple_syntax(diagnostic)
        else:
            self.format_as_plain_text(diagnostic)

    # Format as Simple language constructor syntax
    fn format_as_simple_syntax(diagnostic: Diagnostic) -> text:
        var output = "Diagnostic(\n"

        # Severity
        val severity_variant = match diagnostic.severity:
            Severity.Error: "Error"
            Severity.Warning: "Warning"
            Severity.Note: "Note"
            Severity.Help: "Help"
            Severity.Info: "Info"

        output = output + "  severity: Severity.{severity_variant},\n"

        # Code (optional)
        if diagnostic.code.?:
            output = output + "  code: \"{diagnostic.code.unwrap()}\",\n"

        # Message
        val escaped_msg = escape_string(diagnostic.message)
        output = output + "  message: \"{escaped_msg}\",\n"

        # Span (optional)
        if diagnostic.span.?:
            val span = diagnostic.span.unwrap()
            output = output + "  span: Span(start: {span.start}, end: {span.end}, line: {span.line}, column: {span.column}),\n"

        # Labels (optional)
        if not diagnostic.labels.is_empty():
            output = output + "  labels: [\n"
            for label in diagnostic.labels:
                val span = label.span
                val escaped_label_msg = escape_string(label.message)
                output = output + "    Label(span: Span(start: {span.start}, end: {span.end}, line: {span.line}, column: {span.column}), message: \"{escaped_label_msg}\"),\n"
            output = output + "  ],\n"

        # Notes (optional)
        if not diagnostic.notes.is_empty():
            output = output + "  notes: [\n"
            for note in diagnostic.notes:
                val escaped_note = escape_string(note)
                output = output + "    \"{escaped_note}\",\n"
            output = output + "  ],\n"

        # Help (optional)
        if diagnostic.help.?:
            val escaped_help = escape_string(diagnostic.help.unwrap())
            output = output + "  help: \"{escaped_help}\",\n"

        output = output + ")"
        output

    # Format as plain text (human-readable)
    fn format_as_plain_text(diagnostic: Diagnostic) -> text:
        var output = ""

        # Header: severity[code]: message
        val severity_str = diagnostic.severity.to_string()

        if diagnostic.code.?:
            output = "{severity_str}[{diagnostic.code.unwrap()}]: {diagnostic.message}"
        else:
            output = "{severity_str}: {diagnostic.message}"

        # Span info
        if diagnostic.span.?:
            val span = diagnostic.span.unwrap()
            output = output + " (at line {span.line}, column {span.column})"

        # Labels
        for label in diagnostic.labels:
            output = output + "\n  - {label.message} (line {label.span.line}, column {label.span.column})"

        # Notes
        for note in diagnostic.notes:
            output = output + "\n  note: {note}"

        # Help
        if diagnostic.help.?:
            output = output + "\n  help: {diagnostic.help.unwrap()}"

        output

# Escape special characters in strings for Simple syntax
fn escape_string(s: text) -> text:
    var result = s
    result = result.replace("\\", "\\\\")
    result = result.replace("\"", "\\\"")
    result = result.replace(NL, "\\n")
    result = result.replace("\r", "\\r")
    result = result.replace("\t", "\\t")
    result

# Public exports
export SimpleFormatter
export escape_string
