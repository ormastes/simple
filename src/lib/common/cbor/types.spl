# CBOR Types - Byte Helpers and Initial Byte Encoding/Decoding
# Provides byte array manipulation utilities and CBOR initial byte operations.

use std.common.cbor.major_types.{*}

# ============================================================================
# BYTE ARRAY HELPERS
# ============================================================================

fn byte_at(bytes: [i64], index: i64) -> i64:
    """Get byte at index, or 0 if out of bounds."""
    if index < 0:
        return 0
    if index >= bytes.len():
        return 0
    bytes[index]

fn bytes_append(bytes: [i64], byte_val: i64) -> [i64]:
    """Append byte to byte array."""
    bytes.push(byte_val)

fn bytes_concat(a: [i64], b: [i64]) -> [i64]:
    """Concatenate two byte arrays."""
    var result = a
    for byte_val in b:
        result = result.push(byte_val)
    result

fn bytes_slice(bytes: [i64], start: i64, length: i64) -> [i64]:
    """Extract slice of bytes."""
    var result = []
    var i = 0
    while i < length:
        val idx = start + i
        if idx < bytes.len():
            result = result.push(bytes[idx])
        i = i + 1
    result

# ============================================================================
# INITIAL BYTE ENCODING/DECODING
# ============================================================================

fn make_initial_byte(major_type: i64, additional_info: i64) -> i64:
    """Construct CBOR initial byte from major type and additional info.
    Major type: 3 bits (0..7) in bits 5-7
    Additional info: 5 bits (0..31) in bits 0-4"""
    var major_shifted = (major_type % 8) * 32
    var addl = additional_info % 32
    major_shifted + addl

fn get_major_type(initial_byte: i64) -> i64:
    """Extract major type (bits 5-7) from initial byte."""
    (initial_byte / 32) % 8

fn get_additional_info(initial_byte: i64) -> i64:
    """Extract additional info (bits 0-4) from initial byte."""
    initial_byte % 32

# ============================================================================
# TEXT/BYTE CONVERSION HELPERS
# ============================================================================

fn text_to_bytes(text: text) -> [i64]:
    """Convert text to UTF-8 byte array (simplified ASCII for now)."""
    var result = []
    var i = 0
    while i < text.len():
        var char = text.substring(i, i + 1)
        # Simple ASCII conversion (char codes 0..127)
        var code = 0
        if char == " ": code = 32
        if char == "!": code = 33
        if char == "\"": code = 34
        if char == "#": code = 35
        if char == "$": code = 36
        if char == "%": code = 37
        if char == "&": code = 38
        if char == "'": code = 39
        if char == "(": code = 40
        if char == ")": code = 41
        if char == "*": code = 42
        if char == "+": code = 43
        if char == ",": code = 44
        if char == "-": code = 45
        if char == ".": code = 46
        if char == "/": code = 47
        if char == "0": code = 48
        if char == "1": code = 49
        if char == "2": code = 50
        if char == "3": code = 51
        if char == "4": code = 52
        if char == "5": code = 53
        if char == "6": code = 54
        if char == "7": code = 55
        if char == "8": code = 56
        if char == "9": code = 57
        if char == ":": code = 58
        if char == ";": code = 59
        if char == "<": code = 60
        if char == "=": code = 61
        if char == ">": code = 62
        if char == "?": code = 63
        if char == "@": code = 64
        if char == "A": code = 65
        if char == "B": code = 66
        if char == "C": code = 67
        if char == "D": code = 68
        if char == "E": code = 69
        if char == "F": code = 70
        if char == "G": code = 71
        if char == "H": code = 72
        if char == "I": code = 73
        if char == "J": code = 74
        if char == "K": code = 75
        if char == "L": code = 76
        if char == "M": code = 77
        if char == "N": code = 78
        if char == "O": code = 79
        if char == "P": code = 80
        if char == "Q": code = 81
        if char == "R": code = 82
        if char == "S": code = 83
        if char == "T": code = 84
        if char == "U": code = 85
        if char == "V": code = 86
        if char == "W": code = 87
        if char == "X": code = 88
        if char == "Y": code = 89
        if char == "Z": code = 90
        if char == "[": code = 91
        if char == "\\": code = 92
        if char == "]": code = 93
        if char == "^": code = 94
        if char == "_": code = 95
        if char == "`": code = 96
        if char == "a": code = 97
        if char == "b": code = 98
        if char == "c": code = 99
        if char == "d": code = 100
        if char == "e": code = 101
        if char == "f": code = 102
        if char == "g": code = 103
        if char == "h": code = 104
        if char == "i": code = 105
        if char == "j": code = 106
        if char == "k": code = 107
        if char == "l": code = 108
        if char == "m": code = 109
        if char == "n": code = 110
        if char == "o": code = 111
        if char == "p": code = 112
        if char == "q": code = 113
        if char == "r": code = 114
        if char == "s": code = 115
        if char == "t": code = 116
        if char == "u": code = 117
        if char == "v": code = 118
        if char == "w": code = 119
        if char == "x": code = 120
        if char == "y": code = 121
        if char == "z": code = 122
        if char == "{": code = 123
        if char == "|": code = 124
        if char == "}": code = 125
        if char == "~": code = 126
        result = result.push(code)
        i = i + 1
    result

fn bytes_to_text(bytes: [i64]) -> text:
    """Convert byte array to text (simplified ASCII for now)."""
    var result = ""
    for byte_val in bytes:
        var char = ""
        if byte_val == 32: char = " "
        if byte_val == 33: char = "!"
        if byte_val == 34: char = "\""
        if byte_val == 35: char = "#"
        if byte_val == 36: char = "$"
        if byte_val == 37: char = "%"
        if byte_val == 38: char = "&"
        if byte_val == 39: char = "'"
        if byte_val == 40: char = "("
        if byte_val == 41: char = ")"
        if byte_val == 42: char = "*"
        if byte_val == 43: char = "+"
        if byte_val == 44: char = ","
        if byte_val == 45: char = "-"
        if byte_val == 46: char = "."
        if byte_val == 47: char = "/"
        if byte_val == 48: char = "0"
        if byte_val == 49: char = "1"
        if byte_val == 50: char = "2"
        if byte_val == 51: char = "3"
        if byte_val == 52: char = "4"
        if byte_val == 53: char = "5"
        if byte_val == 54: char = "6"
        if byte_val == 55: char = "7"
        if byte_val == 56: char = "8"
        if byte_val == 57: char = "9"
        if byte_val == 58: char = ":"
        if byte_val == 59: char = ";"
        if byte_val == 60: char = "<"
        if byte_val == 61: char = "="
        if byte_val == 62: char = ">"
        if byte_val == 63: char = "?"
        if byte_val == 64: char = "@"
        if byte_val == 65: char = "A"
        if byte_val == 66: char = "B"
        if byte_val == 67: char = "C"
        if byte_val == 68: char = "D"
        if byte_val == 69: char = "E"
        if byte_val == 70: char = "F"
        if byte_val == 71: char = "G"
        if byte_val == 72: char = "H"
        if byte_val == 73: char = "I"
        if byte_val == 74: char = "J"
        if byte_val == 75: char = "K"
        if byte_val == 76: char = "L"
        if byte_val == 77: char = "M"
        if byte_val == 78: char = "N"
        if byte_val == 79: char = "O"
        if byte_val == 80: char = "P"
        if byte_val == 81: char = "Q"
        if byte_val == 82: char = "R"
        if byte_val == 83: char = "S"
        if byte_val == 84: char = "T"
        if byte_val == 85: char = "U"
        if byte_val == 86: char = "V"
        if byte_val == 87: char = "W"
        if byte_val == 88: char = "X"
        if byte_val == 89: char = "Y"
        if byte_val == 90: char = "Z"
        if byte_val == 91: char = "["
        if byte_val == 92: char = "\\"
        if byte_val == 93: char = "]"
        if byte_val == 94: char = "^"
        if byte_val == 95: char = "_"
        if byte_val == 96: char = "`"
        if byte_val == 97: char = "a"
        if byte_val == 98: char = "b"
        if byte_val == 99: char = "c"
        if byte_val == 100: char = "d"
        if byte_val == 101: char = "e"
        if byte_val == 102: char = "f"
        if byte_val == 103: char = "g"
        if byte_val == 104: char = "h"
        if byte_val == 105: char = "i"
        if byte_val == 106: char = "j"
        if byte_val == 107: char = "k"
        if byte_val == 108: char = "l"
        if byte_val == 109: char = "m"
        if byte_val == 110: char = "n"
        if byte_val == 111: char = "o"
        if byte_val == 112: char = "p"
        if byte_val == 113: char = "q"
        if byte_val == 114: char = "r"
        if byte_val == 115: char = "s"
        if byte_val == 116: char = "t"
        if byte_val == 117: char = "u"
        if byte_val == 118: char = "v"
        if byte_val == 119: char = "w"
        if byte_val == 120: char = "x"
        if byte_val == 121: char = "y"
        if byte_val == 122: char = "z"
        if byte_val == 123: char = "{"
        if byte_val == 124: char = "|"
        if byte_val == 125: char = "}"
        if byte_val == 126: char = "~"
        result = result + char
    result
