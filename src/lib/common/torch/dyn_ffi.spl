# Torch Dynamic FFI â€” Shared Infrastructure
#
# DynLoader call helpers and extern declarations shared by all torch variants.
# Lives in std.common.torch so nogc_sync_mut, nogc_async_mut, and gc_async_mut
# can all delegate here instead of carrying identical copies.
#
# Convention: SIMPLE_SFFI_PATH env var sets the .so search directory (default: build)

use std.ffi.dynamic.{DynLib, DynLoader, sffi_lib_path}

extern fn rt_cstring_to_text(ptr: i64) -> text
extern fn spl_f64_to_bits(f: f64) -> i64
extern fn spl_bits_to_f64(bits: i64) -> f64
extern fn spl_str_ptr(s: text) -> i64

val TORCH_LIB_PATH = sffi_lib_path("torch")

fn _dl() -> DynLoader:
    DynLoader.instance()

fn _call0(name: text) -> i64:
    var loader = _dl()
    loader.call0(TORCH_LIB_PATH, name)

fn _call1(name: text, a0: i64) -> i64:
    var loader = _dl()
    loader.call1(TORCH_LIB_PATH, name, a0)

fn _call2(name: text, a0: i64, a1: i64) -> i64:
    var loader = _dl()
    loader.call2(TORCH_LIB_PATH, name, a0, a1)

fn _call3(name: text, a0: i64, a1: i64, a2: i64) -> i64:
    var loader = _dl()
    loader.call3(TORCH_LIB_PATH, name, a0, a1, a2)

fn _call_n(name: text, args: [i64]) -> i64:
    var loader = _dl()
    loader.call(TORCH_LIB_PATH, name, args)

export TORCH_LIB_PATH
export rt_cstring_to_text, spl_f64_to_bits, spl_bits_to_f64, spl_str_ptr
export _dl, _call0, _call1, _call2, _call3, _call_n
