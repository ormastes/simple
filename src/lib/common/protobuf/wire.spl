# Protocol Buffers Wire Format Operations

from "std/protobuf/types" import WIRE_TYPE_VARINT, WIRE_TYPE_FIXED32, WIRE_TYPE_FIXED64, WIRE_TYPE_LENGTH_DELIMITED
from "std/protobuf/decode" import decode_varint, decode_fixed32, decode_fixed64, decode_bytes, decode_tag

# ==============================================================================
# Field Decoding
# ==============================================================================

# Decode field from bytes at offset
# Returns (field_number, wire_type, value, bytes_consumed) or nil
fn decode_field(bytes: list, offset: i64) -> any:
    var tag_result = decode_varint(bytes, offset)
    if tag_result == nil:
        return nil

    var tag = tag_result[0]
    var tag_size = tag_result[1]
    var decoded = decode_tag(tag)
    var field_number = decoded[0]
    var wire_type = decoded[1]

    var value_offset = offset + tag_size
    var value_result = nil

    if wire_type == WIRE_TYPE_VARINT():
        value_result = decode_varint(bytes, value_offset)
    if wire_type == WIRE_TYPE_FIXED64():
        value_result = decode_fixed64(bytes, value_offset)
    if wire_type == WIRE_TYPE_LENGTH_DELIMITED():
        value_result = decode_bytes(bytes, value_offset)
    if wire_type == WIRE_TYPE_FIXED32():
        value_result = decode_fixed32(bytes, value_offset)

    if value_result == nil:
        return nil

    var value = value_result[0]
    var value_size = value_result[1]
    var total_size = tag_size + value_size

    (field_number, wire_type, value, total_size)

# ==============================================================================
# Unknown Field Handling
# ==============================================================================

# Skip unknown field at offset
# Returns bytes consumed or nil
fn skip_field(bytes: list, offset: i64, wire_type: i64) -> any:
    if wire_type == WIRE_TYPE_VARINT():
        return decode_varint(bytes, offset)[1]
    if wire_type == WIRE_TYPE_FIXED64():
        return 8
    if wire_type == WIRE_TYPE_LENGTH_DELIMITED():
        var len_result = decode_varint(bytes, offset)
        if len_result == nil:
            return nil
        var length = len_result[0]
        var len_size = len_result[1]
        return len_size + length
    if wire_type == WIRE_TYPE_FIXED32():
        return 4
    nil

# Preserve unknown fields during decode
fn preserve_unknown_fields(bytes: list, known_field_numbers: list) -> list:
    var unknown = []
    var offset = 0
    var len = bytes.length()

    loop:
        if offset >= len:
            break

        var tag_result = decode_varint(bytes, offset)
        if tag_result == nil:
            break

        var tag = tag_result[0]
        var tag_size = tag_result[1]
        var decoded = decode_tag(tag)
        var field_number = decoded[0]
        var wire_type = decoded[1]

        var is_known = false
        var i = 0
        var known_count = known_field_numbers.length()
        loop:
            if i >= known_count:
                break
            if known_field_numbers[i] == field_number:
                is_known = true
                break
            i = i + 1

        var skip_size = skip_field(bytes, offset + tag_size, wire_type)
        if skip_size == nil:
            break

        if not is_known:
            var field_data = bytes[offset:offset + tag_size + skip_size]
            unknown = unknown + [field_data]

        offset = offset + tag_size + skip_size

    unknown

# ==============================================================================
# Validation
# ==============================================================================

# Validate wire type
fn is_valid_wire_type(wire_type: i64) -> bool:
    wire_type >= 0 and wire_type <= 5

# Validate field number
fn is_valid_field_number(field_number: i64) -> bool:
    field_number > 0 and field_number < 536870912  # 2^29

# Validate message bytes (basic check)
fn is_valid_message(bytes: list) -> bool:
    var offset = 0
    var len = bytes.length()

    loop:
        if offset >= len:
            break

        var tag_result = decode_varint(bytes, offset)
        if tag_result == nil:
            return false

        var tag = tag_result[0]
        var tag_size = tag_result[1]
        var decoded = decode_tag(tag)
        var field_number = decoded[0]
        var wire_type = decoded[1]

        var valid_type = is_valid_wire_type(wire_type)
        if not valid_type:
            return false

        var valid_num = is_valid_field_number(field_number)
        if not valid_num:
            return false

        var skip_size = skip_field(bytes, offset + tag_size, wire_type)
        if skip_size == nil:
            return false

        offset = offset + tag_size + skip_size

    true
