# Format Utilities
#
# Advanced string formatting and presentation utilities.
# Pure Simple implementation - no external dependencies.
#
# Provides formatting functions for numbers, tables, alignment,
# wrapping, and structured output.
#
# Functions:
# - Number formatting: format_int, format_hex, format_binary, format_size
# - Alignment: align_left, align_right, align_center
# - Tables: format_table_row, format_table
# - Lists: format_bullet_list, format_numbered_list
# - Wrapping: wrap_text, wrap_at_width
# - Indentation: indent, dedent, indent_block
# - Boxes: box_text, border_text

use std.string_builder.{StringBuilder}

# ============================================================================
# Number Formatting
# ============================================================================

fn format_int(n: i64, width: i64, pad_char: text) -> text:
    """Format integer with padding.

    Example:
        format_int(42, 5, "0")  # "00042"
        format_int(123, 3, " ")  # "123"
    """
    val s = "{n}"
    if s.len() >= width:
        return s

    val sb = StringBuilder(parts: [])
    var needed = width - s.len()
    var i = 0
    while i < needed:
        sb.push(pad_char)
        i = i + 1
    sb.push(s)
    sb.to_text()

fn format_hex(n: i64, width: i64) -> text:
    """Format integer as hexadecimal with padding.

    Example:
        format_hex(255, 4)  # "00FF"
        format_hex(16, 2)   # "10"
    """
    val hex_digits = "0123456789ABCDEF"
    var digits: [text] = []
    var value = n

    if value == 0:
        digits.push("0")
    else:
        while value > 0:
            val digit = value % 16
            digits.push("{hex_digits[digit]}")
            value = value / 16

    # Pad to width
    while digits.len() < width:
        digits.push("0")

    # Reverse and join (digits were collected LSB-first)
    val sb = StringBuilder(parts: [])
    var i = digits.len() - 1
    while i >= 0:
        sb.push(digits[i])
        i = i - 1
    sb.to_text()

fn format_binary(n: i64, width: i64) -> text:
    """Format integer as binary with padding.

    Example:
        format_binary(5, 8)  # "00000101"
        format_binary(255, 8)  # "11111111"
    """
    var digits: [text] = []
    var value = n

    if value == 0:
        digits.push("0")
    else:
        while value > 0:
            if value % 2 == 1:
                digits.push("1")
            else:
                digits.push("0")
            value = value / 2

    # Pad to width
    while digits.len() < width:
        digits.push("0")

    # Reverse and join (digits were collected LSB-first)
    val sb = StringBuilder(parts: [])
    var i = digits.len() - 1
    while i >= 0:
        sb.push(digits[i])
        i = i - 1
    sb.to_text()

fn format_size_bytes(bytes: i64) -> text:
    """Format byte size in human-readable form.

    Example:
        format_size_bytes(1024)  # "1.0 KB"
        format_size_bytes(1500000)  # "1.4 MB"
    """
    if bytes < 1024:
        return "{bytes} B"

    val kb = bytes / 1024
    if kb < 1024:
        val frac = (bytes % 1024) / 102  # Approximate tenth
        return "{kb}.{frac} KB"

    val mb = kb / 1024
    if mb < 1024:
        val frac = (kb % 1024) / 102
        return "{mb}.{frac} MB"

    val gb = mb / 1024
    val frac = (mb % 1024) / 102
    "{gb}.{frac} GB"

fn format_duration_ms(ms: i64) -> text:
    """Format milliseconds as human-readable duration.

    Example:
        format_duration_ms(500)     # "500ms"
        format_duration_ms(2500)    # "2s"
        format_duration_ms(125000)  # "2m 5s"
    """
    if ms < 1000:
        "{ms}ms"
    else if ms < 60000:
        val secs = ms / 1000
        "{secs}s"
    else:
        val mins = ms / 60000
        val secs = (ms % 60000) / 1000
        "{mins}m {secs}s"

fn format_percentage(numerator: i64, denominator: i64, decimals: i64) -> text:
    """Format as percentage.

    Example:
        format_percentage(75, 100, 1)  # "75.0%"
        format_percentage(1, 3, 1)  # "33.3%"
    """
    if denominator == 0:
        return "0%"

    val percent = (numerator * 100) / denominator
    val fraction = ((numerator * 100) % denominator) * 10 / denominator

    if decimals > 0:
        "{percent}.{fraction}%"
    else:
        "{percent}%"

# ============================================================================
# Text Alignment
# ============================================================================

fn align_left(text: text, width: i64, fill: text) -> text:
    """Align text left within width.

    Example:
        align_left("hello", 10, " ")  # "hello     "
    """
    if text.len() >= width:
        return text

    var result = text
    while result.len() < width:
        result = result + fill

    result

fn align_right(text: text, width: i64, fill: text) -> text:
    """Align text right within width.

    Example:
        align_right("hello", 10, " ")  # "     hello"
    """
    if text.len() >= width:
        return text

    var result = ""
    while result.len() < (width - text.len()):
        result = result + fill

    result + text

fn align_center(text: text, width: i64, fill: text) -> text:
    """Center text within width.

    Example:
        align_center("hello", 11, " ")  # "   hello   "
    """
    if text.len() >= width:
        return text

    val total_padding = width - text.len()
    val left_padding = total_padding / 2
    val right_padding = total_padding - left_padding

    var result = ""
    var i = 0
    while i < left_padding:
        result = result + fill
        i = i + 1

    result = result + text

    i = 0
    while i < right_padding:
        result = result + fill
        i = i + 1

    result

# ============================================================================
# Table Formatting
# ============================================================================

fn format_table_row(cells, widths, separator: text) -> text:
    """Format a table row with aligned cells.

    Example:
        format_table_row(["ID", "Name", "Age"], [5, 10, 5], " | ")
        # "ID    | Name       | Age  "
    """
    if cells.len() != widths.len():
        return ""

    var parts: [text] = []
    var i = 0

    while i < cells.len():
        val cell = align_left("{cells[i]}", widths[i], " ")
        parts.push(cell)
        i = i + 1

    parts.join(separator)

fn format_table_divider(widths, separator: text, fill: text) -> text:
    """Format a table divider line.

    Example:
        format_table_divider([5, 10, 5], "-+-", "-")
        # "-----+----------+-----"
    """
    var parts: [text] = []
    var i = 0

    while i < widths.len():
        var seg_parts: [text] = []
        var j = 0
        while j < widths[i]:
            seg_parts.push(fill)
            j = j + 1

        parts.push(seg_parts.join(""))
        i = i + 1

    parts.join(separator)

# ============================================================================
# List Formatting
# ============================================================================

fn format_bullet_list(items, bullet: text, indent_size: i64) -> text:
    """Format items as bullet list.

    Example:
        format_bullet_list(["Item 1", "Item 2"], "- ", 2)
        # "  - Item 1\n  - Item 2"
    """
    var padding = ""
    var i = 0

    while i < indent_size:
        padding = padding + " "
        i = i + 1

    var parts: [text] = []
    i = 0
    while i < items.len():
        parts.push(padding + bullet + "{items[i]}")
        i = i + 1

    parts.join("\n")

fn format_numbered_list(items, start: i64, suffix: text, indent_size: i64) -> text:
    """Format items as numbered list.

    Example:
        format_numbered_list(["First", "Second"], 1, ". ", 2)
        # "  1. First\n  2. Second"
    """
    var padding = ""
    var i = 0

    while i < indent_size:
        padding = padding + " "
        i = i + 1

    var parts: [text] = []
    i = 0
    while i < items.len():
        val number = start + i
        parts.push(padding + "{number}" + suffix + "{items[i]}")
        i = i + 1

    parts.join("\n")

# ============================================================================
# Text Wrapping
# ============================================================================

fn wrap_text(text: text, width: i64) -> [text]:
    """Wrap text at word boundaries to fit width.

    Returns array of lines.

    Example:
        wrap_text("hello world foo bar", 10)
        # ["hello", "world foo", "bar"]
    """
    if width <= 0:
        return [text]

    val words = text.split(" ")
    var lines = []
    var current_line = ""

    for word in words:
        val test_line = if current_line.?:
            current_line + " " + word
        else:
            word

        if test_line.len() <= width:
            current_line = test_line
        else:
            if current_line.?:
                lines.push(current_line)
            current_line = word

    if current_line.?:
        lines.push(current_line)

    lines

fn wrap_text_hard(text: text, width: i64) -> [text]:
    """Hard wrap text at exact width (no word boundaries).

    Example:
        wrap_text_hard("abcdefghij", 3)
        # ["abc", "def", "ghi", "j"]
    """
    if width <= 0:
        return [text]

    var lines = []
    var i = 0

    while i < text.len():
        val end = if i + width < text.len():
            i + width
        else:
            text.len()

        lines.push(text[i..end])
        i = i + width

    lines

# ============================================================================
# Indentation
# ============================================================================

fn indent(text: text, spaces: i64) -> text:
    """Add indentation to text.

    Example:
        indent("hello", 4)  # "    hello"
    """
    var prefix = ""
    var i = 0
    while i < spaces:
        prefix = prefix + " "
        i = i + 1

    prefix + text

fn indent_block(text: text, spaces: i64) -> text:
    """Add indentation to each line of text.

    Example:
        indent_block("line1\nline2", 2)
        # "  line1\n  line2"
    """
    val lines = text.split("\n")
    var result = []

    for line in lines:
        result.push(indent(line, spaces))

    result.join("\n")

fn dedent(text: text, spaces: i64) -> text:
    """Remove up to spaces leading spaces from text.

    Example:
        dedent("    hello", 2)  # "  hello"
    """
    var i = 0
    while i < spaces and i < text.len():
        if text[i] != ' ':
            break
        i = i + 1

    if i > 0 and i < text.len():
        text[i..]
    else:
        text

# ============================================================================
# Box Drawing
# ============================================================================

fn box_text(text: text, padding: i64) -> text:
    """Draw box around text.

    Example:
        box_text("Hello", 1)
        # "+-------+\n| Hello |\n+-------+"
    """
    val content_width = text.len() + (padding * 2)
    var top = "+"
    var i = 0
    while i < content_width:
        top = top + "-"
        i = i + 1
    top = top + "+"

    var pad = ""
    i = 0
    while i < padding:
        pad = pad + " "
        i = i + 1

    val middle = "|" + pad + text + pad + "|"
    val bottom = top

    top + "\n" + middle + "\n" + bottom

fn border_text(text: text, border_char: text) -> text:
    """Add border around text.

    Example:
        border_text("Hello", "*")
        # "*******\n*Hello*\n*******"
    """
    val width = text.len() + 2
    var border = ""
    var i = 0
    while i < width:
        border = border + border_char
        i = i + 1

    val middle = border_char + text + border_char

    border + "\n" + middle + "\n" + border

# ============================================================================
# Column Layout
# ============================================================================

fn format_columns(items, columns: i64, width: i64) -> text:
    """Format items in columns.

    Example:
        format_columns(["A", "B", "C", "D"], 2, 10)
        # "A         B         \nC         D         "
    """
    var parts: [text] = []
    var i = 0

    while i < items.len():
        val cell = align_left("{items[i]}", width, " ")
        parts.push(cell)

        if (i + 1) % columns == 0 and i < items.len() - 1:
            parts.push("\n")

        i = i + 1

    parts.join("")

# ============================================================================
# Progress Indicators
# ============================================================================

fn format_progress_bar(current: i64, total: i64, width: i64, fill: text, empty: text) -> text:
    """Format progress bar.

    Example:
        format_progress_bar(7, 10, 20, "#", "-")
        # "[##############------]"
    """
    if total <= 0:
        return "[" + empty + "]"

    val filled = (current * width) / total
    val unfilled = width - filled

    var parts: [text] = []
    parts.push("[")
    var i = 0

    while i < filled:
        parts.push(fill)
        i = i + 1

    i = 0
    while i < unfilled:
        parts.push(empty)
        i = i + 1

    parts.push("]")
    parts.join("")

fn format_spinner(step: i64) -> text:
    """Get spinner character for animation.

    Example:
        format_spinner(0)  # "|"
        format_spinner(1)  # "/"
        format_spinner(2)  # "-"
        format_spinner(3)  # "\\"
    """
    val frames = ["|", "/", "-", "\\"]
    val index = step % 4
    frames[index]

# ============================================================================
# Key-Value Formatting
# ============================================================================

fn format_key_value(key: text, value: text, separator: text, key_width: i64) -> text:
    """Format key-value pair.

    Example:
        format_key_value("Name", "Alice", ": ", 10)
        # "Name      : Alice"
    """
    val aligned_key = align_left(key, key_width, " ")
    aligned_key + separator + value

fn format_key_value_list(pairs, separator: text, key_width: i64) -> text:
    """Format list of key-value pairs.

    pairs is array of (key, value) tuples.

    Example:
        format_key_value_list([("ID", "1"), ("Name", "Alice")], ": ", 6)
        # "ID    : 1\nName  : Alice"
    """
    var parts: [text] = []
    var i = 0

    while i < pairs.len():
        val (key, value) = pairs[i]
        parts.push(format_key_value(key, value, separator, key_width))
        i = i + 1

    parts.join("\n")
