# Color Conversion Functions
#
# Purpose: Color space conversions and format transformations
#

use std.common.validation.{clamp}
# Contains:
# - RGB/HSL/HSV conversions
# - Hex string parsing and generation
# - CSS format output
# - Named color parsing

# ============================================================================
# Color Creation from Different Formats
# ============================================================================

fn from_rgb(r: i64, g: i64, b: i64) -> Color:
    """Create a color from RGB values (0-255)."""
    Color(
        r: clamp(r, 0, 255),
        g: clamp(g, 0, 255),
        b: clamp(b, 0, 255),
        a: 255
    )

fn from_rgba(r: i64, g: i64, b: i64, a: i64) -> Color:
    """Create a color from RGBA values (0-255)."""
    Color(
        r: clamp(r, 0, 255),
        g: clamp(g, 0, 255),
        b: clamp(b, 0, 255),
        a: clamp(a, 0, 255)
    )

fn from_hsl(h: i64, s: i64, l: i64) -> Color:
    """Create a color from HSL values (h: 0-360, s: 0-100, l: 0-100)."""
    hsl_to_rgb(h, s, l)

fn from_hsv(h: i64, s: i64, v: i64) -> Color:
    """Create a color from HSV values (h: 0-360, s: 0-100, v: 0-100)."""
    hsv_to_rgb(h, s, v)

fn from_hex(hex_str: text) -> Color:
    """Create a color from hex string (#RGB, #RGBA, #RRGGBB, #RRGGBBAA)."""
    var cleaned = hex_str
    if cleaned.starts_with("#"):
        cleaned = cleaned.substring(1, cleaned.length())

    val len = cleaned.length()

    if len == 3:
        # RGB shorthand (#F0A -> #FF00AA)
        val r_char = cleaned.substring(0, 1)
        val g_char = cleaned.substring(1, 2)
        val b_char = cleaned.substring(2, 3)
        val r = hex_char_to_int(r_char) * 17
        val g = hex_char_to_int(g_char) * 17
        val b = hex_char_to_int(b_char) * 17
        return from_rgb(r, g, b)

    if len == 4:
        # RGBA shorthand
        val r_char = cleaned.substring(0, 1)
        val g_char = cleaned.substring(1, 2)
        val b_char = cleaned.substring(2, 3)
        val a_char = cleaned.substring(3, 4)
        val r = hex_char_to_int(r_char) * 17
        val g = hex_char_to_int(g_char) * 17
        val b = hex_char_to_int(b_char) * 17
        val a = hex_char_to_int(a_char) * 17
        return from_rgba(r, g, b, a)

    if len == 6:
        # RRGGBB
        val r_str = cleaned.substring(0, 2)
        val g_str = cleaned.substring(2, 4)
        val b_str = cleaned.substring(4, 6)
        val r = hex_to_int(r_str)
        val g = hex_to_int(g_str)
        val b = hex_to_int(b_str)
        return from_rgb(r, g, b)

    if len == 8:
        # RRGGBBAA
        val r_str = cleaned.substring(0, 2)
        val g_str = cleaned.substring(2, 4)
        val b_str = cleaned.substring(4, 6)
        val a_str = cleaned.substring(6, 8)
        val r = hex_to_int(r_str)
        val g = hex_to_int(g_str)
        val b = hex_to_int(b_str)
        val a = hex_to_int(a_str)
        return from_rgba(r, g, b, a)

    # Invalid format, return black
    from_rgb(0, 0, 0)

fn from_name(name: text) -> Color:
    """Create a color from CSS color name."""
    val lower_name = name.to_lower()

    # Basic colors
    if lower_name == "black": return from_rgb(0, 0, 0)
    if lower_name == "white": return from_rgb(255, 255, 255)
    if lower_name == "red": return from_rgb(255, 0, 0)
    if lower_name == "green": return from_rgb(0, 128, 0)
    if lower_name == "blue": return from_rgb(0, 0, 255)
    if lower_name == "yellow": return from_rgb(255, 255, 0)
    if lower_name == "cyan": return from_rgb(0, 255, 255)
    if lower_name == "magenta": return from_rgb(255, 0, 255)
    if lower_name == "orange": return from_rgb(255, 165, 0)
    if lower_name == "purple": return from_rgb(128, 0, 128)
    if lower_name == "pink": return from_rgb(255, 192, 203)
    if lower_name == "brown": return from_rgb(165, 42, 42)
    if lower_name == "gray": return from_rgb(128, 128, 128)
    if lower_name == "grey": return from_rgb(128, 128, 128)
    if lower_name == "lime": return from_rgb(0, 255, 0)
    if lower_name == "navy": return from_rgb(0, 0, 128)
    if lower_name == "teal": return from_rgb(0, 128, 128)
    if lower_name == "olive": return from_rgb(128, 128, 0)
    if lower_name == "maroon": return from_rgb(128, 0, 0)
    if lower_name == "silver": return from_rgb(192, 192, 192)
    if lower_name == "gold": return from_rgb(255, 215, 0)
    if lower_name == "indigo": return from_rgb(75, 0, 130)
    if lower_name == "violet": return from_rgb(238, 130, 238)
    if lower_name == "turquoise": return from_rgb(64, 224, 208)
    if lower_name == "coral": return from_rgb(255, 127, 80)
    if lower_name == "salmon": return from_rgb(250, 128, 114)
    if lower_name == "crimson": return from_rgb(220, 20, 60)
    if lower_name == "tan": return from_rgb(210, 180, 140)
    if lower_name == "khaki": return from_rgb(240, 230, 140)
    if lower_name == "lavender": return from_rgb(230, 230, 250)

    # Default to black if unknown
    from_rgb(0, 0, 0)

# ============================================================================
# Color Space Conversions
# ============================================================================

fn rgb_to_hsl(color: Color) -> (i64, i64, i64):
    """Convert RGB to HSL. Returns (h: 0-360, s: 0-100, l: 0-100)."""
    val r_norm = color.r / 255
    val g_norm = color.g / 255
    val b_norm = color.b / 255

    val max_val = max3(r_norm, g_norm, b_norm)
    val min_val = min3(r_norm, g_norm, b_norm)
    val delta = max_val - min_val

    # Lightness
    val l = (max_val + min_val) / 2

    if delta == 0:
        return (0, 0, l * 100)

    # Saturation
    var s = 0
    if l < 50:
        s = delta / (max_val + min_val)
    else:
        s = delta / (200 - max_val - min_val)

    # Hue
    var h = 0
    if max_val == r_norm:
        val hue_component = (g_norm - b_norm) / delta
        h = (hue_component * 60) % 360
    else:
        if max_val == g_norm:
            val hue_component = (b_norm - r_norm) / delta
            h = ((hue_component + 2) * 60) % 360
        else:
            val hue_component = (r_norm - g_norm) / delta
            h = ((hue_component + 4) * 60) % 360

    if h < 0:
        h = h + 360

    (h, s * 100, l * 100)

fn hsl_to_rgb(h: i64, s: i64, l: i64) -> Color:
    """Convert HSL to RGB."""
    val h_norm = h % 360
    val s_norm = clamp(s, 0, 100)
    val l_norm = clamp(l, 0, 100)

    if s_norm == 0:
        val gray = (l_norm * 255) / 100
        return from_rgb(gray, gray, gray)

    var c = 0
    if l_norm < 50:
        c = (2 * l_norm * s_norm) / 100
    else:
        c = (200 - 2 * l_norm) * s_norm / 100

    val x = c * (100 - abs((h_norm % 120) - 60)) / 100
    val m = l_norm - c / 2

    var r_prime = 0
    var g_prime = 0
    var b_prime = 0

    if h_norm < 60:
        r_prime = c
        g_prime = x
        b_prime = 0
    else:
        if h_norm < 120:
            r_prime = x
            g_prime = c
            b_prime = 0
        else:
            if h_norm < 180:
                r_prime = 0
                g_prime = c
                b_prime = x
            else:
                if h_norm < 240:
                    r_prime = 0
                    g_prime = x
                    b_prime = c
                else:
                    if h_norm < 300:
                        r_prime = x
                        g_prime = 0
                        b_prime = c
                    else:
                        r_prime = c
                        g_prime = 0
                        b_prime = x

    val r = ((r_prime + m) * 255) / 100
    val g = ((g_prime + m) * 255) / 100
    val b = ((b_prime + m) * 255) / 100

    from_rgb(r, g, b)

fn rgb_to_hsv(color: Color) -> (i64, i64, i64):
    """Convert RGB to HSV. Returns (h: 0-360, s: 0-100, v: 0-100)."""
    val r_norm = color.r
    val g_norm = color.g
    val b_norm = color.b

    val max_val = max3(r_norm, g_norm, b_norm)
    val min_val = min3(r_norm, g_norm, b_norm)
    val delta = max_val - min_val

    # Value
    val v = (max_val * 100) / 255

    if max_val == 0:
        return (0, 0, 0)

    # Saturation
    val s = (delta * 100) / max_val

    if delta == 0:
        return (0, 0, v)

    # Hue
    var h = 0
    if max_val == r_norm:
        val hue_component = (g_norm - b_norm) * 60 / delta
        h = hue_component % 360
    else:
        if max_val == g_norm:
            val hue_component = (b_norm - r_norm) * 60 / delta
            h = (hue_component + 120) % 360
        else:
            val hue_component = (r_norm - g_norm) * 60 / delta
            h = (hue_component + 240) % 360

    if h < 0:
        h = h + 360

    (h, s, v)

fn hsv_to_rgb(h: i64, s: i64, v: i64) -> Color:
    """Convert HSV to RGB."""
    val h_norm = h % 360
    val s_norm = clamp(s, 0, 100)
    val v_norm = clamp(v, 0, 100)

    if s_norm == 0:
        val gray = (v_norm * 255) / 100
        return from_rgb(gray, gray, gray)

    val c = (v_norm * s_norm) / 100
    val x = c * (100 - abs((h_norm % 120) - 60)) / 100
    val m = v_norm - c

    var r_prime = 0
    var g_prime = 0
    var b_prime = 0

    if h_norm < 60:
        r_prime = c
        g_prime = x
        b_prime = 0
    else:
        if h_norm < 120:
            r_prime = x
            g_prime = c
            b_prime = 0
        else:
            if h_norm < 180:
                r_prime = 0
                g_prime = c
                b_prime = x
            else:
                if h_norm < 240:
                    r_prime = 0
                    g_prime = x
                    b_prime = c
                else:
                    if h_norm < 300:
                        r_prime = x
                        g_prime = 0
                        b_prime = c
                    else:
                        r_prime = c
                        g_prime = 0
                        b_prime = x

    val r = ((r_prime + m) * 255) / 100
    val g = ((g_prime + m) * 255) / 100
    val b = ((b_prime + m) * 255) / 100

    from_rgb(r, g, b)

fn to_hex(color: Color) -> text:
    """Convert color to hex string (#RRGGBB)."""
    val r_hex = int_to_hex(color.r)
    val g_hex = int_to_hex(color.g)
    val b_hex = int_to_hex(color.b)
    "#{r_hex}{g_hex}{b_hex}"

fn to_hex_alpha(color: Color) -> text:
    """Convert color to hex string with alpha (#RRGGBBAA)."""
    val r_hex = int_to_hex(color.r)
    val g_hex = int_to_hex(color.g)
    val b_hex = int_to_hex(color.b)
    val a_hex = int_to_hex(color.a)
    "#{r_hex}{g_hex}{b_hex}{a_hex}"

fn to_css(color: Color) -> text:
    """Convert color to CSS rgb() or rgba() string."""
    if color.a == 255:
        return "rgb({color.r}, {color.g}, {color.b})"
    val alpha_float = color.a * 100 / 255
    val alpha_str = "{alpha_float}"
    "rgba({color.r}, {color.g}, {color.b}, 0.{alpha_str})"

# ============================================================================
# Helper Functions
# ============================================================================


fn max3(a: i64, b: i64, c: i64) -> i64:
    """Get maximum of three values."""
    var result = a
    if b > result:
        result = b
    if c > result:
        result = c
    result

fn min3(a: i64, b: i64, c: i64) -> i64:
    """Get minimum of three values."""
    var result = a
    if b < result:
        result = b
    if c < result:
        result = c
    result

fn abs(value: i64) -> i64:
    """Absolute value."""
    if value < 0:
        return 0 - value
    value

fn hex_to_int(hex_str: text) -> i64:
    """Convert hex string to integer."""
    if hex_str.length() == 0:
        return 0

    var result = 0
    var i = 0
    while i < hex_str.length():
        val char = hex_str.substring(i, i + 1)
        val digit = hex_char_to_int(char)
        result = result * 16 + digit
        i = i + 1

    result

fn hex_char_to_int(char: text) -> i64:
    """Convert single hex character to integer."""
    if char == "0": return 0
    if char == "1": return 1
    if char == "2": return 2
    if char == "3": return 3
    if char == "4": return 4
    if char == "5": return 5
    if char == "6": return 6
    if char == "7": return 7
    if char == "8": return 8
    if char == "9": return 9
    if char == "A" or char == "a": return 10
    if char == "B" or char == "b": return 11
    if char == "C" or char == "c": return 12
    if char == "D" or char == "d": return 13
    if char == "E" or char == "e": return 14
    if char == "F" or char == "f": return 15
    0

fn int_to_hex(value: i64) -> text:
    """Convert integer (0-255) to 2-digit hex string."""
    val high = value / 16
    val low = value % 16
    val high_char = int_to_hex_char(high)
    val low_char = int_to_hex_char(low)
    "{high_char}{low_char}"

fn int_to_hex_char(value: i64) -> text:
    """Convert integer (0-15) to hex character."""
    if value == 0: return "0"
    if value == 1: return "1"
    if value == 2: return "2"
    if value == 3: return "3"
    if value == 4: return "4"
    if value == 5: return "5"
    if value == 6: return "6"
    if value == 7: return "7"
    if value == 8: return "8"
    if value == 9: return "9"
    if value == 10: return "A"
    if value == 11: return "B"
    if value == 12: return "C"
    if value == 13: return "D"
    if value == 14: return "E"
    if value == 15: return "F"
    "0"

export from_rgb, from_rgba, from_hsl, from_hsv, from_hex, from_name
export rgb_to_hsl, hsl_to_rgb, rgb_to_hsv, hsv_to_rgb
export to_hex, to_hex_alpha, to_css
export clamp, max3, min3, abs
export hex_to_int, hex_char_to_int, int_to_hex, int_to_hex_char
