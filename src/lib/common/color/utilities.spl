# Color Utility Functions
#
# Purpose: Color analysis, metrics, and helper operations
#
# Contains:
# - Luminance calculation
# - Contrast ratio and accessibility checks
# - Color distance
# - Web-safe color snapping
# - Light/dark detection

# ============================================================================
# Color Analysis Functions
# ============================================================================

fn luminance(color: Color) -> i64:
    """Calculate relative luminance (0-100) using sRGB formula."""
    # Simplified luminance calculation (without gamma correction)
    val lum = (2126 * color.r + 7152 * color.g + 722 * color.b) / 10000
    (lum * 100) / 255

fn contrast_ratio(color1: Color, color2: Color) -> i64:
    """Calculate WCAG contrast ratio (1-21, scaled to 1-2100 for integers)."""
    val l1 = luminance(color1)
    val l2 = luminance(color2)

    var lighter = l1
    var darker = l2
    if l2 > l1:
        lighter = l2
        darker = l1

    if darker == 0:
        return 2100

    val ratio = ((lighter + 5) * 100) / (darker + 5)
    ratio

fn is_dark(color: Color) -> bool:
    """Check if color is dark (luminance < 50)."""
    luminance(color) < 50

fn is_light(color: Color) -> bool:
    """Check if color is light (luminance >= 50)."""
    luminance(color) >= 50

fn is_accessible(foreground: Color, background: Color, level: text) -> bool:
    """Check WCAG accessibility. Level: 'AA' (450+) or 'AAA' (700+)."""
    val ratio = contrast_ratio(foreground, background)

    if level == "AAA":
        return ratio >= 700

    # Default to AA
    ratio >= 450

fn color_distance(color1: Color, color2: Color) -> i64:
    """Calculate Euclidean distance in RGB space."""
    val dr = color1.r - color2.r
    val dg = color1.g - color2.g
    val db = color1.b - color2.b

    # Simplified distance without square root (for comparison purposes)
    dr * dr + dg * dg + db * db

fn is_similar(color1: Color, color2: Color, threshold: i64) -> bool:
    """Check if two colors are similar within threshold."""
    color_distance(color1, color2) <= threshold

# ============================================================================
# Web-Safe Colors
# ============================================================================

fn web_safe(color: Color) -> Color:
    """Snap color to web-safe palette (216 colors)."""
    val r = snap_to_web_safe(color.r)
    val g = snap_to_web_safe(color.g)
    val b = snap_to_web_safe(color.b)
    from_rgb(r, g, b)

fn snap_to_web_safe(value: i64) -> i64:
    """Snap a color component to web-safe value (0, 51, 102, 153, 204, 255)."""
    val nearest = (value + 25) / 51
    nearest * 51

# ============================================================================
# Example Usage Function
# ============================================================================

fn color_utils_examples():
    """Demonstrate color utilities usage."""
    print "=== Color Creation ==="
    val red_color = from_rgb(255, 0, 0)
    print "Red RGB: {red_color.to_string()}"

    val blue_hex = from_hex("#0000FF")
    print "Blue from hex: {blue_hex.to_string()}"

    val green_name = from_name("green")
    print "Green from name: {green_name.to_string()}"

    print ""
    print "=== Color Conversions ==="
    val purple_color = from_rgb(128, 0, 128)
    val purple_hex = to_hex(purple_color)
    print "Purple to hex: {purple_hex}"

    val purple_css = to_css(purple_color)
    print "Purple to CSS: {purple_css}"

    print ""
    print "=== Color Manipulation ==="
    val base_color = from_rgb(100, 150, 200)
    val lighter_color = lighten(base_color, 20)
    val darker_color = darken(base_color, 20)
    val saturated_color = saturate(base_color, 30)
    print "Base: {to_hex(base_color)}"
    print "Lighter: {to_hex(lighter_color)}"
    print "Darker: {to_hex(darker_color)}"
    print "Saturated: {to_hex(saturated_color)}"

    print ""
    print "=== Color Schemes ==="
    val primary = from_rgb(255, 100, 50)
    val comp = complement(primary)
    print "Primary: {to_hex(primary)}"
    print "Complement: {to_hex(comp)}"

    val triadic_colors = triadic(primary)
    print "Triadic scheme:"
    var i = 0
    while i < triadic_colors.length():
        print "  {to_hex(triadic_colors[i])}"
        i = i + 1

    print ""
    print "=== Color Analysis ==="
    val dark_color = from_rgb(50, 50, 50)
    val light_color = from_rgb(200, 200, 200)
    print "Dark luminance: {luminance(dark_color)}"
    print "Light luminance: {luminance(light_color)}"
    print "Is dark? {is_dark(dark_color)}"
    print "Is light? {is_light(light_color)}"

    val ratio = contrast_ratio(dark_color, light_color)
    print "Contrast ratio: {ratio}"
    print "Accessible (AA)? {is_accessible(dark_color, light_color, \"AA\")}"

# ============================================================================
# Helper Functions
# ============================================================================

fn from_rgb(r: i64, g: i64, b: i64) -> Color:
    """Create a color from RGB values (0-255)."""
    Color(
        r: clamp(r, 0, 255),
        g: clamp(g, 0, 255),
        b: clamp(b, 0, 255),
        a: 255
    )

fn clamp(value: i64, min_val: i64, max_val: i64) -> i64:
    """Clamp value between min and max."""
    if value < min_val:
        return min_val
    if value > max_val:
        return max_val
    value

fn from_hex(hex_str: text) -> Color:
    """Stub - implemented in convert.spl."""
    from_rgb(0, 0, 0)

fn from_name(name: text) -> Color:
    """Stub - implemented in convert.spl."""
    from_rgb(0, 0, 0)

fn to_hex(color: Color) -> text:
    """Stub - implemented in convert.spl."""
    "#000000"

fn to_css(color: Color) -> text:
    """Stub - implemented in convert.spl."""
    "rgb(0, 0, 0)"

fn lighten(color: Color, amount: i64) -> Color:
    """Stub - implemented in manipulate.spl."""
    color

fn darken(color: Color, amount: i64) -> Color:
    """Stub - implemented in manipulate.spl."""
    color

fn saturate(color: Color, amount: i64) -> Color:
    """Stub - implemented in manipulate.spl."""
    color

fn complement(color: Color) -> Color:
    """Stub - implemented in blend.spl."""
    color

fn triadic(color: Color) -> [Color]:
    """Stub - implemented in blend.spl."""
    [color]

export luminance, contrast_ratio, is_dark, is_light, is_accessible
export color_distance, is_similar
export web_safe, snap_to_web_safe
export color_utils_examples
