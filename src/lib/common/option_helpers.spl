# Option Type Helpers
#
# Functions for working with Option types (Some/nil).
# Split from functions.spl for modularity.
#
# Total Functions: 22

fn option_unwrap_or(opt, default_val):
    """Unwrap Option or return default value.

    Example:
        option_unwrap_or(Some(42), 0)  # 42
        option_unwrap_or(nil, 0)       # 0
    """
    if val x = opt:
        x
    else:
        default_val

fn option_unwrap_or_else(opt, f: fn()):
    """Unwrap Option or call function to get default.

    Lazy evaluation - function only called if nil.

    Example:
        option_unwrap_or_else(Some(42), \: expensive_default())
    """
    if val x = opt:
        x
    else:
        f()

fn option_map(opt, f):
    """Map function over Option value.

    Example:
        option_map(Some(5), \x: x * 2)  # Some(10)
        option_map(nil, \x: x * 2)       # nil
    """
    if val x = opt:
        Some(f(x))
    else:
        nil

fn option_flat_map(opt, f):
    """FlatMap function over Option (f returns Option).

    Example:
        option_flat_map(Some(5), \x: Some(x * 2))  # Some(10)
        option_flat_map(Some(5), \x: nil)          # nil
        option_flat_map(nil, \x: Some(x * 2))      # nil
    """
    if val x = opt:
        f(x)
    else:
        nil

fn option_filter(opt, predicate):
    """Filter Option by predicate.

    Returns Some if predicate is true, nil otherwise.

    Example:
        option_filter(Some(5), \x: x > 3)  # Some(5)
        option_filter(Some(2), \x: x > 3)  # nil
    """
    if val x = opt:
        if predicate(x):
            Some(x)
        else:
            nil
    else:
        nil

fn option_or_else(opt, f: fn()):
    """Return Option or call function to get alternative Option.

    Example:
        option_or_else(Some(5), \: Some(0))  # Some(5)
        option_or_else(nil, \: Some(0))      # Some(0)
    """
    if opt.?:
        opt
    else:
        f()

fn option_and_then(opt1, opt2):
    """Return second Option if first is Some, nil otherwise.

    Example:
        option_and_then(Some(5), Some(10))  # Some(10)
        option_and_then(nil, Some(10))      # nil
    """
    if opt1.?:
        opt2
    else:
        nil

fn option_zip(opt1, opt2):
    """Combine two Options into Option of tuple.

    Returns Some((a, b)) if both are Some, nil otherwise.

    Example:
        option_zip(Some(1), Some(2))  # Some((1, 2))
        option_zip(Some(1), nil)      # nil
    """
    if val a = opt1:
        if val b = opt2:
            return Some((a, b))
    nil

fn option_zip_with(opt1, opt2, f):
    """Combine two Options with function.

    Example:
        option_zip_with(Some(2), Some(3), \a, b: a + b)  # Some(5)
    """
    if val a = opt1:
        if val b = opt2:
            return Some(f(a, b))
    nil

fn option_sequence(opts):
    """Convert array of Options to Option of array.

    Returns Some([...]) if all are Some, nil if any is nil.

    Example:
        option_sequence([Some(1), Some(2), Some(3)])  # Some([1,2,3])
        option_sequence([Some(1), nil, Some(3)])      # nil
    """
    var values = []

    for opt in opts:
        if val x = opt:
            values.push(x)
        else:
            return nil

    Some(values)

fn option_all_some(opts):
    """Check if all Options are Some.

    Example:
        option_all_some([Some(1), Some(2)])  # true
        option_all_some([Some(1), nil])      # false
    """
    for opt in opts:
        if not opt.?:
            return false
    true

fn option_any_some(opts):
    """Check if any Option is Some.

    Example:
        option_any_some([nil, Some(2), nil])  # true
        option_any_some([nil, nil])           # false
    """
    for opt in opts:
        if opt.?:
            return true
    false

fn option_first_some(opts):
    """Get first Some value from array of Options.

    Returns first Some found, or nil if all are nil.

    Example:
        option_first_some([nil, Some(2), Some(3)])  # Some(2)
    """
    for opt in opts:
        if opt.?:
            return opt
    nil

fn option_flatten(nested_opt):
    """Flatten Option<Option<T>> to Option<T>.

    Example:
        option_flatten(Some(Some(5)))  # Some(5)
        option_flatten(Some(nil))      # nil
        option_flatten(nil)            # nil
    """
    if val outer = nested_opt:
        outer
    else:
        nil

fn option_is_some(opt):
    """Check if Option is Some.

    Example:
        option_is_some(Some(5))  # true
        option_is_some(nil)      # false
    """
    opt.?

fn option_is_none(opt):
    """Check if Option is None (nil).

    Example:
        option_is_none(nil)      # true
        option_is_none(Some(5))  # false
    """
    not opt.?

fn option_contains(opt, value):
    """Check if Option contains specific value.

    Example:
        option_contains(Some(5), 5)  # true
        option_contains(Some(5), 3)  # false
        option_contains(nil, 5)      # false
    """
    if val x = opt:
        x == value
    else:
        false

fn option_to_array(opt):
    """Convert Option to array.

    Returns [value] if Some, [] if nil.

    Example:
        option_to_array(Some(5))  # [5]
        option_to_array(nil)      # []
    """
    if val x = opt:
        [x]
    else:
        []

fn option_from_array(arr):
    """Convert array to Option.

    Returns Some(first) if non-empty, nil if empty.

    Example:
        option_from_array([1,2,3])  # Some(1)
        option_from_array([])       # nil
    """
    if arr.len() > 0:
        Some(arr[0])
    else:
        nil

fn option_iter(opt, f: fn()):
    """Execute function if Some, do nothing if nil.

    Example:
        option_iter(Some(5), \x: print(x))  # prints 5
        option_iter(nil, \x: print(x))      # does nothing
    """
    if val x = opt:
        f(x)

fn option_for_each(opts, f: fn()):
    """Execute function for each Some value in array of Options.

    Example:
        option_for_each([Some(1), nil, Some(3)], \x: print(x))
        # prints 1, then 3
    """
    for opt in opts:
        if val x = opt:
            f(x)

fn option_from_nullable(value, null_check: fn() -> bool):
    """Create Option from potentially null value.

    null_check function should return true if value is "null".

    Example:
        option_from_nullable(0, \: false)  # Some(0)
        option_from_nullable(0, \: true)   # nil
    """
    if null_check():
        nil
    else:
        Some(value)

fn option_from_predicate(value, predicate):
    """Create Some if predicate is true, nil otherwise.

    Example:
        option_from_predicate(5, \x: x > 3)  # Some(5)
        option_from_predicate(2, \x: x > 3)  # nil
    """
    if predicate(value):
        Some(value)
    else:
        nil

fn option_merge(opt1, opt2, merger):
    """Merge two Options with merger function.

    - If both Some: merger(a, b)
    - If one Some: that value
    - If both nil: nil

    Example:
        option_merge(Some(2), Some(3), \a, b: a + b)  # Some(5)
        option_merge(Some(2), nil, \a, b: a + b)      # Some(2)
    """
    if val a = opt1:
        if val b = opt2:
            return Some(merger(a, b))
        else:
            return Some(a)
    else:
        if val b = opt2:
            return Some(b)
        else:
            return nil

fn option_choose(opt1, opt2):
    """Choose first Some value.

    Returns opt1 if Some, otherwise opt2.

    Example:
        option_choose(Some(1), Some(2))  # Some(1)
        option_choose(nil, Some(2))      # Some(2)
    """
    if opt1.?:
        opt1
    else:
        opt2

fn option_choose_many(opts):
    """Choose first Some value from array.

    Example:
        option_choose_many([nil, nil, Some(3), Some(4)])  # Some(3)
    """
    for opt in opts:
        if opt.?:
            return opt
    nil

export *
