# Rope Concatenation Module
# Functions for concatenating ropes and strings

fn rope_concat(left: any, right: any) -> any:
    # Concatenate two ropes
    if left == nil or rope_is_empty(left):
        return right
    if right == nil or rope_is_empty(right):
        return left

    # Try to merge small leaf nodes
    var can_merge = rope_is_leaf(left) and rope_is_leaf(right)
    if can_merge:
        var total_len = rope_length(left) + rope_length(right)
        if total_len <= ROPE_MAX_LEAF_SIZE:
            var left_val = left.4
            var right_val = right.4
            var merged = "{left_val}{right_val}"
            return rope_create_leaf(merged)

    # Create concat node
    var result = rope_create_concat(left, right)

    # Check if rebalancing is needed
    var needs_rebalance = rope_needs_rebalancing(result)
    if needs_rebalance:
        result = rope_rebalance(result)

    result

fn rope_concat_string(node: any, s: text) -> any:
    # Concatenate a string to a rope
    var right = rope_create_from_string(s)
    rope_concat(node, right)

fn rope_prepend_string(s: text, node: any) -> any:
    # Prepend a string to a rope
    var left = rope_create_from_string(s)
    rope_concat(left, node)

fn rope_merge_chunks(chunks: any) -> any:
    # Merge list of rope chunks into single rope
    if chunks == nil or chunks.length() == 0:
        return rope_create_empty()

    var result = chunks[0]
    var i = 1

    while i < chunks.length():
        result = rope_concat(result, chunks[i])
        i = i + 1

    result
