# Fault Detection
#
# Shared fault detection for stack overflow and timeout detection
# across interpreter and compiled modes.
#
# Port of rust/common/src/fault_detection.rs
# Note: Rust uses atomics; Simple uses module-level mutable state.
# Thread safety is provided by the runtime's GIL or per-actor isolation.

# ============================================================================
# Stack Overflow Detection
# ============================================================================

var recursion_depth: i64 = 0
var max_recursion_depth: i64 = 1000
var stack_overflow_detection_enabled: bool = true

fn set_stack_overflow_detection_enabled(enabled: bool):
    """Enable or disable stack overflow detection."""
    stack_overflow_detection_enabled = enabled

fn is_stack_overflow_detection_enabled() -> bool:
    stack_overflow_detection_enabled

fn set_max_recursion_depth(depth: i64):
    """Set the maximum recursion depth limit."""
    max_recursion_depth = depth

fn get_max_recursion_depth() -> i64:
    max_recursion_depth

fn reset_recursion_depth():
    """Reset the recursion counter to zero."""
    recursion_depth = 0

fn increment_recursion_depth() -> bool:
    """Increment depth counter. Returns false if limit exceeded."""
    if not stack_overflow_detection_enabled:
        return true
    recursion_depth = recursion_depth + 1
    recursion_depth <= max_recursion_depth

fn decrement_recursion_depth():
    """Decrement depth counter (floor at 0)."""
    if recursion_depth > 0:
        recursion_depth = recursion_depth - 1

fn current_recursion_depth() -> i64:
    recursion_depth

# ============================================================================
# Timeout Detection
# ============================================================================

var timeout_exceeded: bool = false

fn is_timeout_exceeded() -> bool:
    """Check if timeout has been exceeded (set by watchdog thread)."""
    timeout_exceeded

fn set_timeout_exceeded():
    """Mark timeout as exceeded."""
    timeout_exceeded = true

fn reset_timeout():
    """Reset timeout flag."""
    timeout_exceeded = false

# ============================================================================
# Combined Check
# ============================================================================

enum FaultKind:
    """Type of fault detected."""
    StackOverflow(depth: i64, limit: i64)
    Timeout

fn check_faults() -> FaultKind?:
    """Check for any active fault condition."""
    if timeout_exceeded:
        return Some(FaultKind.Timeout)
    if stack_overflow_detection_enabled and recursion_depth > max_recursion_depth:
        return Some(FaultKind.StackOverflow(
            depth: recursion_depth,
            limit: max_recursion_depth
        ))
    nil

# ============================================================================
# High-Level API (used by tests and user code)
# ============================================================================

var timeout_secs: i64 = 0
var execution_limit: i64 = 10000000

fn enable_stack_overflow_detection():
    set_stack_overflow_detection_enabled(true)

fn disable_stack_overflow_detection():
    set_stack_overflow_detection_enabled(false)

fn set_recursion_limit(depth: i64):
    set_max_recursion_depth(depth)

fn set_timeout(secs: i64):
    timeout_secs = secs

fn get_timeout() -> i64:
    timeout_secs

fn set_execution_limit(limit: i64):
    execution_limit = limit

fn get_execution_limit() -> i64:
    execution_limit

fn reset_defaults():
    set_stack_overflow_detection_enabled(true)
    set_max_recursion_depth(1000)
    reset_recursion_depth()
    timeout_secs = 0
    reset_timeout()
    execution_limit = 10000000

# ============================================================================
# FaultConfig Struct
# ============================================================================

val DEFAULT_MAX_RECURSION_DEPTH = 1000
val DEFAULT_EXECUTION_LIMIT = 10000000
val DEFAULT_TIMEOUT = 0

class FaultConfig:
    stack_overflow_enabled: bool
    max_recursion_depth: i64
    timeout_secs: i64
    execution_limit: i64

    fn with_timeout(secs: i64) -> FaultConfig:
        FaultConfig(stack_overflow_enabled: self.stack_overflow_enabled, max_recursion_depth: self.max_recursion_depth, timeout_secs: secs, execution_limit: self.execution_limit)

    fn with_max_depth(depth: i64) -> FaultConfig:
        FaultConfig(stack_overflow_enabled: self.stack_overflow_enabled, max_recursion_depth: depth, timeout_secs: self.timeout_secs, execution_limit: self.execution_limit)

    fn with_execution_limit(limit: i64) -> FaultConfig:
        FaultConfig(stack_overflow_enabled: self.stack_overflow_enabled, max_recursion_depth: self.max_recursion_depth, timeout_secs: self.timeout_secs, execution_limit: limit)

    fn apply():
        set_stack_overflow_detection_enabled(self.stack_overflow_enabled)
        set_max_recursion_depth(self.max_recursion_depth)
        timeout_secs = self.timeout_secs
        execution_limit = self.execution_limit

fn FaultConfig__defaults() -> FaultConfig:
    FaultConfig(stack_overflow_enabled: true, max_recursion_depth: 1000, timeout_secs: 0, execution_limit: 10000000)

fn FaultConfig__strict() -> FaultConfig:
    FaultConfig(stack_overflow_enabled: true, max_recursion_depth: 500, timeout_secs: 30, execution_limit: 5000000)

fn FaultConfig__permissive() -> FaultConfig:
    FaultConfig(stack_overflow_enabled: true, max_recursion_depth: 10000, timeout_secs: 0, execution_limit: 100000000)

fn FaultConfig__disabled() -> FaultConfig:
    FaultConfig(stack_overflow_enabled: false, max_recursion_depth: 0, timeout_secs: 0, execution_limit: 0)

export FaultKind, FaultConfig
export set_stack_overflow_detection_enabled, is_stack_overflow_detection_enabled
export set_max_recursion_depth, get_max_recursion_depth, reset_recursion_depth
export increment_recursion_depth, decrement_recursion_depth, current_recursion_depth
export is_timeout_exceeded, set_timeout_exceeded, reset_timeout
export check_faults
export enable_stack_overflow_detection, disable_stack_overflow_detection
export set_recursion_limit, set_timeout, get_timeout, set_execution_limit, get_execution_limit
export reset_defaults
export FaultConfig__defaults, FaultConfig__strict, FaultConfig__permissive, FaultConfig__disabled
export DEFAULT_MAX_RECURSION_DEPTH, DEFAULT_EXECUTION_LIMIT, DEFAULT_TIMEOUT
