# YAML Validation Module
# Multi-document support and anchor/alias handling

import yaml.types
import yaml.parse
import yaml.serialize

# ============================================================================
# Multi-Document Support
# ============================================================================

fn yaml_parse_documents(yaml_text: text) -> list:
    """Parse multiple YAML documents separated by ---."""
    var documents = []
    val parts = yaml_text.split("---")
    var i = 0
    while i < parts.length():
        val part = parts.get(i)
        val trimmed = part.trim()
        if trimmed.length() > 0:
            val doc = yaml_parse(trimmed)
            documents = documents.append(doc)
        i = i + 1
    documents

fn yaml_serialize_documents(documents: list, style: text) -> text:
    """Serialize multiple YAML documents with --- separators."""
    var result = ""
    var i = 0
    while i < documents.length():
        val doc = documents.get(i)
        val serialized = yaml_serialize(doc, style)
        if i > 0:
            result = result + "\n---\n"
        result = result + serialized
        i = i + 1
    result

# ============================================================================
# Anchor and Alias Support (Basic)
# ============================================================================

fn yaml_create_anchor(name: text, value: (text, any)) -> (text, (text, (text, any))):
    """Create an anchor with a name and value."""
    ("anchor", (name, value))

fn yaml_create_alias(name: text) -> (text, text):
    """Create an alias reference to an anchor."""
    ("alias", name)

fn yaml_is_anchor(value: (text, any)) -> bool:
    """Check if value is an anchor."""
    val value_type = value.0
    value_type == "anchor"

fn yaml_is_alias(value: (text, any)) -> bool:
    """Check if value is an alias."""
    val value_type = value.0
    value_type == "alias"

fn yaml_get_anchor_name(anchor: (text, any)) -> text:
    """Get the name from an anchor."""
    val anchor_data = anchor.1
    anchor_data.0

fn yaml_get_anchor_value(anchor: (text, any)) -> (text, any):
    """Get the value from an anchor."""
    val anchor_data = anchor.1
    anchor_data.1

fn yaml_get_alias_name(alias: (text, any)) -> text:
    """Get the reference name from an alias."""
    alias.1

fn yaml_resolve_aliases(value: (text, any), anchors: list) -> (text, any):
    """Resolve aliases in a YAML value using provided anchors."""
    var result = value
    val value_type = value.0
    if value_type == "alias":
        val alias_name = yaml_get_alias_name(value)
        var i = 0
        var found = false
        while i < anchors.length() and not found:
            val anchor = anchors.get(i)
            val anchor_name = yaml_get_anchor_name(anchor)
            if anchor_name == alias_name:
                result = yaml_get_anchor_value(anchor)
                found = true
            i = i + 1
    result

# ============================================================================

# ============================================================================
# EXPORTS
# ============================================================================

export yaml_parse_documents
export yaml_create_anchor, yaml_create_alias, yaml_is_anchor, yaml_is_alias
export yaml_get_anchor_name, yaml_get_anchor_value, yaml_get_alias_name
export yaml_resolve_aliases
