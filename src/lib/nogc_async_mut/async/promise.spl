# Promise - Write Side of Future
#
# A promise allows completing a future with a value.

use std.async.future.{Future}
use std.async.ffi.{
    promise_alloc, promise_get_future, promise_complete,
    promise_is_completed, promise_free
}

class Promise<T>:
    """Write side of a future.

    A promise allows completing a future with a value.
    Each promise has an associated future.

    Example:
        val (future, promise) = Promise<i64>.new()

        # Complete promise
        promise.complete(42)

        # Future now ready
        val value = future.poll().unwrap()  # 42
    """
    state: [u8]  # Opaque promise state

    static fn new() -> (Future<T>, Promise<T>):
        """Create new future-promise pair.

        Returns:
            (future, promise) tuple
        """
        val state = promise_alloc::<T>()
        val future_state = promise_get_future(state)

        (Future(state: future_state), Promise(state: state))

    fn complete(value: T) -> bool:
        """Complete promise with value.

        Args:
            value: Completion value

        Returns:
            true if completed, false if already completed

        Wakes waiting tasks.
        """
        promise_complete(self.state, value)

    fn is_completed() -> bool:
        """Check if promise is completed.

        Returns:
            true if completed, false otherwise
        """
        promise_is_completed(self.state)

    me drop():
        """Drop promise (future becomes cancelled if not completed)."""
        promise_free::<T>(self.state)

export Promise
