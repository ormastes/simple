# Future - Async Computation
#
# Represents an asynchronous computation that may not be available yet.

use std.async.poll.{Poll}
use std.async.ffi.{
    future_alloc_ready, future_alloc_pending, future_poll,
    future_map, future_then, future_free
}

class Future<T>:
    """Represents an asynchronous computation.

    A future is a value that may not be available yet.
    Futures are polled to check if they're ready.

    Example:
        val future = Future<i64>.from_value(42)

        match future.poll():
            case Poll.Ready(value):
                print "Got {value}"
            case Poll.Pending:
                print "Not ready yet"
    """
    state: [u8]  # Opaque future state

    static fn from_value(value: T) -> Future<T>:
        """Create future that's immediately ready.

        Args:
            value: Ready value

        Returns:
            Completed future
        """
        val state = future_alloc_ready(value)
        Future(state: state)

    static fn pending() -> Future<T>:
        """Create future that's pending.

        Returns:
            Pending future
        """
        val state = future_alloc_pending<T>()
        Future(state: state)

    fn poll() -> Poll<T>:
        """Poll future to check if ready.

        Returns:
            Ready(value) if complete, Pending otherwise

        Non-blocking operation.
        """
        future_poll<T>(self.state)

    fn is_ready() -> bool:
        """Check if future is ready (non-blocking).

        Returns:
            true if ready, false otherwise
        """
        self.poll().is_ready()

    fn map<U>(f: fn(T) -> U) -> Future<U>:
        """Transform future value.

        Args:
            f: Transformation function

        Returns:
            New future with transformed value
        """
        val state = future_map(self.state, f)
        Future(state: state)

    fn then<U>(f: fn(T) -> Future<U>) -> Future<U>:
        """Chain futures (flatMap).

        Args:
            f: Function returning future

        Returns:
            Chained future
        """
        val state = future_then(self.state, f)
        Future(state: state)

    me drop():
        """Drop future, freeing resources."""
        future_free<T>(self.state)

export Future
