# MCP Debug Parsing Helpers
#
# Utility functions for parsing debug variable entries,
# stack frames, and step mode conversion.

use std.nogc_async_mut.mcp.helpers.{LB, RB, jp, js}

# Parse "name = value : type" into JSON object
# Returns: {"name":"x","value":"42","type":"Int"}
fn parse_var_entry(raw: String) -> String:
    val parts = raw.split(" = ")
    if parts.len() < 2:
        # No " = " found, return raw as name with unknown type
        var obj = LB()
        obj = obj + jp("name", js(raw))
        obj = obj + ","
        obj = obj + jp("value", js(""))
        obj = obj + ","
        obj = obj + jp("type", js("unknown"))
        obj = obj + RB()
        return obj
    val var_name = parts[0]
    val rest = parts[1]
    val type_parts = rest.split(" : ")
    val var_value = type_parts[0]
    var var_type = "unknown"
    if type_parts.len() >= 2:
        var_type = type_parts[1]
    var obj = LB()
    obj = obj + jp("name", js(var_name))
    obj = obj + ","
    obj = obj + jp("value", js(var_value))
    obj = obj + ","
    obj = obj + jp("type", js(var_type))
    obj = obj + RB()
    obj

# Parse stack frame string into JSON object
# Returns: {"id":N,"name":"raw","source":"unknown","line":0}
fn parse_stack_frame(idx: Int, raw: String) -> String:
    var obj = LB()
    obj = obj + jp("id", idx.to_string())
    obj = obj + ","
    obj = obj + jp("name", js(raw))
    obj = obj + ","
    obj = obj + jp("source", js("unknown"))
    obj = obj + ","
    obj = obj + jp("line", "0")
    obj = obj + RB()
    obj

# Map step mode string to integer: over=1, in=2, out=3
fn step_mode_to_int(mode: String) -> Int:
    if mode == "over":
        return 1
    if mode == "in":
        return 2
    if mode == "out":
        return 3
    return 0

# --- Exports ---

export parse_var_entry, parse_stack_frame, step_mode_to_int
