# MCP Lazy Server - CLI tool handlers (Tier 1)
# Handles: simple_test, simple_build, simple_format, simple_lint, simple_fix, simple_doc_coverage

# ============================================================================
# simple_test — Run tests
# ============================================================================

fn handle_simple_test(id: text, body: text) -> text:
    val path = extract_field(body, "path")
    val filter_str = extract_field(body, "filter")
    val only_slow = extract_field(body, "only_slow")
    val list_flag = extract_field(body, "list")

    val _bin = _mcp_find_simple_binary()
    var cmd = "timeout 120 " + _bin + " test"
    if list_flag == "true":
        cmd = cmd + " --list"
    elif path != "":
        cmd = cmd + " " + path
    if filter_str != "":
        cmd = cmd + " --filter " + filter_str
    if only_slow == "true":
        cmd = cmd + " --only-slow"
    cmd = cmd + " 2>&1"

    val (out, exit_code) = shell_cmd(cmd)
    make_tool_result(id, "-- simple_test (exit: " + str(exit_code) + ") --\n" + out)

# ============================================================================
# simple_build — Build project
# ============================================================================

fn handle_simple_build(id: text, body: text) -> text:
    val release = extract_field(body, "release")
    val target = extract_field(body, "target")
    val warn_docs = extract_field(body, "warn_docs")

    val _bin = _mcp_find_simple_binary()
    var cmd = "timeout 300 " + _bin + " build"
    if release == "true":
        cmd = cmd + " --release"
    if target != "":
        cmd = cmd + " --target " + target
    if warn_docs == "true":
        cmd = cmd + " --warn-docs"
    cmd = cmd + " 2>&1"

    val (out, exit_code) = shell_cmd(cmd)
    make_tool_result(id, "-- simple_build (exit: " + str(exit_code) + ") --\n" + out)

# ============================================================================
# simple_format — Format file or project
# ============================================================================

fn handle_simple_format(id: text, body: text) -> text:
    val path = extract_field(body, "path")
    val check = extract_field(body, "check")

    val _bin = _mcp_find_simple_binary()
    var cmd = "timeout 60 " + _bin + " fmt"
    if check == "true":
        cmd = cmd + " --check"
    if path != "":
        cmd = cmd + " " + path
    cmd = cmd + " 2>&1"

    val (out, exit_code) = shell_cmd(cmd)
    make_tool_result(id, "-- simple_format (exit: " + str(exit_code) + ") --\n" + out)

# ============================================================================
# simple_lint — Lint with output
# ============================================================================

fn handle_simple_lint(id: text, body: text) -> text:
    val path = extract_field(body, "path")

    val _bin = _mcp_find_simple_binary()
    var cmd = "timeout 60 " + _bin + " lint"
    if path != "":
        cmd = cmd + " " + path
    cmd = cmd + " 2>&1"

    val (out, exit_code) = shell_cmd(cmd)
    make_tool_result(id, "-- simple_lint (exit: " + str(exit_code) + ") --\n" + out)

# ============================================================================
# simple_fix — Auto-fix issues
# ============================================================================

fn handle_simple_fix(id: text, body: text) -> text:
    val path = extract_field(body, "path")
    val dry_run = extract_field(body, "dry_run")

    if path == "":
        return make_tool_error(id, -32602, "Missing required parameter: path")

    val _bin = _mcp_find_simple_binary()
    var cmd = "timeout 60 " + _bin + " fix " + path
    if dry_run == "true":
        cmd = cmd + " --dry-run"
    cmd = cmd + " 2>&1"

    val (out, exit_code) = shell_cmd(cmd)
    make_tool_result(id, "-- simple_fix (exit: " + str(exit_code) + ") --\n" + out)

# ============================================================================
# simple_doc_coverage — Documentation coverage report
# ============================================================================

fn handle_simple_doc_coverage(id: text, body: text) -> text:
    val format_str = extract_field(body, "format")
    val missing = extract_field(body, "missing")

    val _bin = _mcp_find_simple_binary()
    var cmd = "timeout 60 " + _bin + " doc-coverage"
    if format_str != "":
        cmd = cmd + " --format=" + format_str
    if missing == "true":
        cmd = cmd + " --missing"
    cmd = cmd + " 2>&1"

    val (out, exit_code) = shell_cmd(cmd)
    make_tool_result(id, "-- simple_doc_coverage (exit: " + str(exit_code) + ") --\n" + out)
