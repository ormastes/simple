# Async Data Pipeline Utilities
#
# Batch pre-computation and index shuffling for
# efficient data loading in training pipelines.

use std.pure.data.dataset.{ArrayDataset}

# ============================================================================
# Batch Prefetching
# ============================================================================

fn prefetch_batches(dataset: ArrayDataset, batch_size: i64, num_batches: i64) -> [[f64]]:
    """Pre-compute multiple batches from a dataset.

    Prepares batches ahead of time for efficient training iteration.
    Each batch is a flat array of concatenated sample data.

    Args:
        dataset: Source dataset
        batch_size: Number of samples per batch
        num_batches: Number of batches to prefetch

    Returns:
        Array of batches, each batch being a flat [f64] array
    """
    var batches: [[f64]] = []
    val dataset_len = dataset.len()
    var batch_idx = 0

    while batch_idx < num_batches:
        var batch: [f64] = []
        val start = batch_idx * batch_size
        var end = start + batch_size
        if end > dataset_len:
            end = dataset_len

        if start >= dataset_len:
            # No more data
            batch_idx = num_batches
        else:
            var i = start
            while i < end:
                val sample = dataset.get_item(i)
                for v in sample:
                    batch.push(v)
                i = i + 1
            batches.push(batch)
            batch_idx = batch_idx + 1

    batches

# ============================================================================
# Index Shuffling
# ============================================================================

fn shuffle_indices(length: i64, seed: i64) -> [i64]:
    """Generate a shuffled array of indices [0, length).

    Uses Fisher-Yates shuffle with a linear congruential generator
    for deterministic, reproducible shuffling.

    Args:
        length: Number of indices to generate
        seed: Random seed for reproducibility

    Returns:
        Shuffled array of indices
    """
    # Initialize sequential indices
    var indices: [i64] = []
    var i = 0
    while i < length:
        indices.push(i)
        i = i + 1

    # Fisher-Yates shuffle with LCG
    val a = 1103515245
    val c = 12345
    val m = 2147483648
    var current_seed = seed

    i = length - 1
    while i > 0:
        current_seed = (a * current_seed + c) % m
        val j = current_seed % (i + 1)

        # Swap indices[i] and indices[j]
        val temp = indices[i]
        indices[i] = indices[j]
        indices[j] = temp

        i = i - 1

    indices

# ============================================================================
# Exports
# ============================================================================

export prefetch_batches, shuffle_indices
