# Test Database Extended - Query Methods
#
# Methods for querying database (get_file_id, get_suite_id, get_test_id, get_counter, etc.)

use lib.database.test_extended.database.{TestDatabaseExtended}
use lib.database.test_extended.types.{
    CounterRecord, TimingSummary, RunRecord, TestInfo
}

# Extension methods for TestDatabaseExtended
impl TestDatabaseExtended:
    # Get file ID by path
    fn get_file_id(path: text) -> i64?:
        val path_id = self.interner.intern(path)

        # BUG-044: Avoid ALL uses of ? in loop - use ?? default instead
        val files_table_opt = self.db.get_table("files")
        if not files_table_opt.?:
            return nil
        val files_table = files_table_opt?

        for row in files_table.valid_rows():
            # BUG-044: Use ?? to unwrap with default instead of ?
            val path_str = row.get_i32("path_str") ?? -1
            if path_str == -1:
                continue

            if path_str == path_id:
                val file_id = row.get_i64("file_id") ?? -1
                if file_id != -1:
                    return Some(file_id)

        nil

    # Get suite ID by file path and suite name
    fn get_suite_id(file_path: text, suite_name: text) -> i64?:
        # BUG-044: Unwrap get_file_id() result BEFORE using in loop
        val file_id_opt = self.get_file_id(file_path)
        if not file_id_opt.?:
            return nil
        val file_id = file_id_opt?

        val name_id = self.interner.intern(suite_name)

        # BUG-044: Unwrap table Option BEFORE loop
        val suites_table_opt = self.db.get_table("suites")
        if not suites_table_opt.?:
            return nil
        val suites_table = suites_table_opt?

        for row in suites_table.valid_rows():
            # BUG-044: Check .? for each field, continue if None
            val row_file_id_opt = row.get_i64("file_id")
            if not row_file_id_opt.?:
                continue
            val row_file_id = row_file_id_opt?

            val name_str_opt = row.get_i32("name_str")
            if not name_str_opt.?:
                continue
            val name_str = name_str_opt?

            if row_file_id == file_id and name_str == name_id:
                val suite_id_opt = row.get_i64("suite_id")
                if suite_id_opt.?:
                    val suite_id = suite_id_opt?
                    return Some(suite_id)

        nil

    # Get test ID by file path, suite name, and test name
    fn get_test_id(file_path: text, suite_name: text, test_name: text) -> i64?:
        # BUG-044: Unwrap get_suite_id() result BEFORE using in loop
        val suite_id_opt = self.get_suite_id(file_path, suite_name)
        if not suite_id_opt.?:
            return nil
        val suite_id = suite_id_opt?

        val name_id = self.interner.intern(test_name)

        # BUG-044: Unwrap table Option BEFORE loop
        val tests_table_opt = self.db.get_table("tests")
        if not tests_table_opt.?:
            return nil
        val tests_table = tests_table_opt?

        for row in tests_table.valid_rows():
            # BUG-044: Check .? for each field, continue if None
            val row_suite_id_opt = row.get_i64("suite_id")
            if not row_suite_id_opt.?:
                continue
            val row_suite_id = row_suite_id_opt?

            val name_str_opt = row.get_i32("name_str")
            if not name_str_opt.?:
                continue
            val name_str = name_str_opt?

            if row_suite_id == suite_id and name_str == name_id:
                val test_id_opt = row.get_i64("test_id")
                if test_id_opt.?:
                    val test_id = test_id_opt?
                    return Some(test_id)

        nil

    # Get counter by test ID
    fn get_counter(test_id: i64) -> CounterRecord?:
        # BUG-044: Unwrap table Option BEFORE loop
        val counters_table_opt = self.db.get_table("counters")
        if not counters_table_opt.?:
            return nil
        val counters_table = counters_table_opt?

        for row in counters_table.valid_rows():
            # BUG-044: Check .? for each field, continue if None
            val row_test_id_opt = row.get_i64("test_id")
            if not row_test_id_opt.?:
                continue
            val row_test_id = row_test_id_opt?

            if row_test_id == test_id:
                # BUG-044: Unwrap all i64 fields with ?? 0 BEFORE struct construction
                val total_runs = row.get_i64("total_runs") ?? 0
                val passed = row.get_i64("passed") ?? 0
                val failed = row.get_i64("failed") ?? 0
                val crashed = row.get_i64("crashed") ?? 0
                val timed_out = row.get_i64("timed_out") ?? 0
                val flaky_count = row.get_i64("flaky_count") ?? 0
                val consecutive_passes = row.get_i64("consecutive_passes") ?? 0

                return Some(CounterRecord(
                    test_id: test_id,
                    total_runs: total_runs,
                    passed: passed,
                    failed: failed,
                    crashed: crashed,
                    timed_out: timed_out,
                    flaky_count: flaky_count,
                    consecutive_passes: consecutive_passes
                ))

        nil

    # Get timing summary by test ID
    fn get_timing_summary(test_id: i64) -> TimingSummary?:
        # BUG-044: Unwrap table Option BEFORE loop
        val timing_table_opt = self.db.get_table("timing")
        if not timing_table_opt.?:
            return nil
        val timing_table = timing_table_opt?

        for row in timing_table.valid_rows():
            # BUG-044: Check .? for test_id field
            val row_test_id_opt = row.get_i64("test_id")
            if not row_test_id_opt.?:
                continue
            val row_test_id = row_test_id_opt?

            if row_test_id == test_id:
                # BUG-045: Unwrap all f64 fields with ?? 0.0 BEFORE struct construction
                # This fixes "cannot convert enum to float" error
                val mean = row.get_f64("mean") ?? 0.0
                val p50 = row.get_f64("p50") ?? 0.0
                val p90 = row.get_f64("p90") ?? 0.0
                val p95 = row.get_f64("p95") ?? 0.0
                val p99 = row.get_f64("p99") ?? 0.0
                val iqr = row.get_f64("iqr") ?? 0.0
                val baseline_p50 = row.get_f64("baseline_p50") ?? 0.0

                # BUG-044: Unwrap text fields with ?? "" BEFORE struct construction
                val has_baseline_str = row.get("has_baseline") ?? "false"
                val baseline_updated_at = row.get("baseline_updated_at") ?? ""
                val last_10_runs = row.get("last_10_runs") ?? ""

                return Some(TimingSummary(
                    test_id: test_id,
                    mean: mean,
                    p50: p50,
                    p90: p90,
                    p95: p95,
                    p99: p99,
                    iqr: iqr,
                    has_baseline: has_baseline_str == "true",
                    baseline_p50: baseline_p50,
                    baseline_updated_at: baseline_updated_at,
                    last_10_runs: last_10_runs
                ))

        nil

    # List test runs
    fn list_runs(status_filter: text) -> [RunRecord]:
        var result: [RunRecord] = []
        val runs_table_opt = self.db.get_table("test_runs")
        if not runs_table_opt.?:
            return result

        val runs_table = runs_table_opt?
        for row in runs_table.valid_rows():
            # BUG-044: Use ?? instead of ? to avoid "try: early return"
            val status = row.get("status") ?? ""
            if status_filter != "" and status != status_filter:
                continue

            # BUG-044: Unwrap all fields with ?? defaults BEFORE struct construction
            val run_id = row.get("run_id") ?? ""
            val start_time = row.get("start_time") ?? ""
            val end_time = row.get("end_time") ?? ""
            val pid = row.get_i64("pid") ?? 0
            val hostname = row.get("hostname") ?? ""
            val test_count = row.get_i64("test_count") ?? 0
            val passed = row.get_i64("passed") ?? 0
            val failed = row.get_i64("failed") ?? 0
            val crashed = row.get_i64("crashed") ?? 0
            val timed_out = row.get_i64("timed_out") ?? 0

            val record = RunRecord(
                run_id: run_id,
                start_time: start_time,
                end_time: end_time,
                pid: pid,
                hostname: hostname,
                status: status,
                test_count: test_count,
                passed: passed,
                failed: failed,
                crashed: crashed,
                timed_out: timed_out
            )
            result.push(record)

        result

    # Get all test information (for doc generation)
    fn all_test_info() -> [TestInfo]:
        var result: [TestInfo] = []
        # BUG-044: Unwrap table Option BEFORE loop
        val tests_table_opt = self.db.get_table("tests")
        if not tests_table_opt.?:
            return result
        val tests_table = tests_table_opt?

        for test_row in tests_table.valid_rows():
            # BUG-044: Use ?? instead of ? to avoid "try: early return"
            val test_id = test_row.get_i64("test_id") ?? -1
            val suite_id = test_row.get_i64("suite_id") ?? -1
            val name_str = test_row.get_i32("name_str") ?? -1
            val category_str = test_row.get_i32("category_str") ?? -1
            val status_str = test_row.get_i32("status_str") ?? -1

            # Skip if any critical field is missing
            if test_id == -1 or suite_id == -1 or name_str == -1:
                continue

            # Get test name
            val test_name = self.interner.get(name_str) ?? ""

            # Get suite name and file path
            val (file_path, suite_name) = self.get_suite_info(suite_id) ?? ("", "")

            # Get category
            val category = self.interner.get(category_str) ?? "uncategorized"

            # Get status
            val status = self.interner.get(status_str) ?? "unknown"

            # Get valid flag
            val valid_str = test_row.get("valid") ?? "false"
            val valid = valid_str == "true"

            # Get timing info
            val (mean, p50) = self.get_test_timing(test_id) ?? (0.0, 0.0)

            # Get counter info
            val (total_runs, passed, failed) = self.get_test_counts(test_id) ?? (0, 0, 0)

            # Check if flaky
            val is_flaky = self.is_flaky_test(test_id)

            result.push(TestInfo(
                test_name: test_name,
                file_path: file_path,
                suite_name: suite_name,
                category: category,
                status: status,
                valid: valid,
                mean_duration: mean,
                p50_duration: p50,
                total_runs: total_runs,
                passed: passed,
                failed: failed,
                is_flaky: is_flaky
            ))

        result

    # Get tests filtered by status
    fn tests_by_status(status_filter: text) -> [TestInfo]:
        val all_tests = self.all_test_info()
        all_tests.filter(\t: t.status == status_filter)

    # Count tests by status
    fn test_count_by_status() -> (i64, i64, i64, i64):
        val all_tests = self.all_test_info()
        var total = all_tests.len()
        var passed = 0
        var failed = 0
        var skipped = 0

        for t in all_tests:
            if t.status == "passed":
                passed = passed + 1
            elif t.status == "failed":
                failed = failed + 1
            elif t.status == "skipped" or t.status == "ignored":
                skipped = skipped + 1

        (total, passed, failed, skipped)

    # Get list of flaky test names
    fn flaky_test_names() -> [text]:
        val all_tests = self.all_test_info()
        var result: [text] = []

        for t in all_tests:
            if t.is_flaky:
                result.push(t.test_name)

        result

    # Helper: Get suite info (file_path, suite_name)
    fn get_suite_info(suite_id: i64) -> (text, text)?:
        # BUG-044: Unwrap table Option BEFORE loop
        val suites_table_opt = self.db.get_table("suites")
        if not suites_table_opt.?:
            return nil
        val suites_table = suites_table_opt?

        for row in suites_table.valid_rows():
            # BUG-044: Use ?? instead of ? to avoid "try: early return"
            val row_suite_id = row.get_i64("suite_id") ?? -1
            if row_suite_id == suite_id:
                val file_id = row.get_i64("file_id") ?? -1
                val name_str = row.get_i32("name_str") ?? -1

                if file_id == -1 or name_str == -1:
                    continue

                # Get file path
                val file_path = self.get_file_path(file_id) ?? ""

                # Get suite name
                val suite_name = self.interner.get(name_str) ?? ""

                return Some((file_path, suite_name))

        nil

    # Helper: Get file path by ID
    fn get_file_path(file_id: i64) -> text?:
        # BUG-044: Unwrap table Option BEFORE loop
        val files_table_opt = self.db.get_table("files")
        if not files_table_opt.?:
            return nil
        val files_table = files_table_opt?

        for row in files_table.valid_rows():
            # BUG-044: Use ?? instead of ? to avoid "try: early return"
            val row_file_id = row.get_i64("file_id") ?? -1
            if row_file_id == file_id:
                val path_str = row.get_i32("path_str") ?? -1
                if path_str != -1:
                    return self.interner.get(path_str)

        nil

    # Helper: Get test timing (mean, p50)
    fn get_test_timing(test_id: i64) -> (f64, f64)?:
        # BUG-044: Unwrap table Option BEFORE loop
        val timing_table_opt = self.db.get_table("timing")
        if not timing_table_opt.?:
            return nil
        val timing_table = timing_table_opt?

        for row in timing_table.valid_rows():
            # BUG-044 & BUG-045: Use ?? instead of ? to avoid errors
            val row_test_id = row.get_i64("test_id") ?? -1
            if row_test_id == test_id:
                val mean = row.get_f64("mean") ?? 0.0
                val p50 = row.get_f64("p50") ?? 0.0
                return Some((mean, p50))

        nil

    # Helper: Get test counts (total_runs, passed, failed)
    fn get_test_counts(test_id: i64) -> (i64, i64, i64)?:
        # BUG-044: Unwrap table Option BEFORE loop
        val counters_table_opt = self.db.get_table("counters")
        if not counters_table_opt.?:
            return nil
        val counters_table = counters_table_opt?

        for row in counters_table.valid_rows():
            # BUG-044: Use ?? instead of ? to avoid "try: early return"
            val row_test_id = row.get_i64("test_id") ?? -1
            if row_test_id == test_id:
                val total_runs = row.get_i64("total_runs") ?? 0
                val passed = row.get_i64("passed") ?? 0
                val failed = row.get_i64("failed") ?? 0
                return Some((total_runs, passed, failed))

        nil
