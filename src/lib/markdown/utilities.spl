# HTML Escaping and Utilities (5 functions)
# =============================================================================

fn escape_html_char(c: text) -> text:
    if c == "&":
        return "&amp;"
    if c == "<":
        return "&lt;"
    if c == ">":
        return "&gt;"
    if c == "\"":
        return "&quot;"
    if c == "'":
        return "&#39;"
    c

fn escape_html(s: text) -> text:
    var result = ""
    var i = 0
    var len = s.length()
    while i < len:
        val c = s.char_at(i)
        val escaped = escape_html_char(c)
        result = result + escaped
        i = i + 1
    result

fn escape_attr(s: text) -> text:
    escape_html(s)

fn unescape_text(s: text) -> text:
    var result = ""
    var i = 0
    var len = s.length()
    while i < len:
        val c = s.char_at(i)
        if c == "\\":
            if i + 1 < len:
                val next = s.char_at(i + 1)
                val escapable = next == "*" or next == "_" or next == "`"
                val more = next == "[" or next == "]" or next == "\\" or next == "!"
                if escapable or more:
                    result = result + next
                    i = i + 2
                else:
                    result = result + c
                    i = i + 1
            else:
                result = result + c
                i = i + 1
        else:
            result = result + c
            i = i + 1
    result

fn is_escaped(s: text, pos: i64) -> bool:
    if pos == 0:
        return false
    val prev = s.char_at(pos - 1)
    prev == "\\"

# =============================================================================
# Slugification for Heading Anchors (1 function)
# =============================================================================

fn slugify(s: text) -> text:
    var result = ""
    var i = 0
    var len = s.length()
    var last_was_dash = false
    while i < len:
        val c = s.char_at(i)
        if is_alphanumeric(c):
            val lower = char_to_lower(c)
            result = result + lower
            last_was_dash = false
        else:
            if not last_was_dash and result.length() > 0:
                result = result + "-"
                last_was_dash = true
        i = i + 1
    if ends_with(result, "-"):
        return result.substring(0, result.length() - 1)
    result

# =============================================================================
# Line Processing (5 functions)
# =============================================================================

fn split_lines(s: text) -> array:
    var lines = []
    var current = ""
    var i = 0
    var len = s.length()
    while i < len:
        val c = s.char_at(i)
        if c == "\n":
            lines = lines.push(current)
            current = ""
        else:
            if c != "\r":
                current = current + c
        i = i + 1
    if current.length() > 0 or len > 0:
        lines = lines.push(current)
    lines

fn join_lines(lines: array, sep: text) -> text:
    var result = ""
    var i = 0
    var len = lines.length()
    while i < len:
        val line = lines.get(i)
        result = result + line
        if i < len - 1:
            result = result + sep
        i = i + 1
    result

fn is_blank_line(line: text) -> bool:
    val trimmed = trim(line)
    trimmed.length() == 0

fn count_leading_spaces(line: text) -> i64:
    count_leading_chars(line, " ")

fn count_line_indent(line: text) -> i64:
    var spaces = 0
    var i = 0
    var len = line.length()
    while i < len and line.char_at(i) == " ":
        spaces = spaces + 1
        i = i + 1
    spaces

