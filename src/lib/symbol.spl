# Symbol Interning
#
# Provides SymbolId and SymbolInterner for string interning.
# Converts strings to integer IDs for fast comparison.

class SymbolId:
    id: i64

    fn is_valid() -> bool:
        self.id >= 0

    fn hash() -> i64:
        self.id

fn SymbolId__invalid() -> SymbolId:
    SymbolId(id: -1)

class SymbolInterner:
    strings: [text]
    map: {}

    me intern(s: text) -> SymbolId:
        if self.map.contains(s):
            val idx = self.map[s]
            return SymbolId(id: idx)
        val idx = self.strings.len()
        self.strings.push(s)
        self.map[s] = idx
        SymbolId(id: idx)

    fn resolve(sym: SymbolId):
        if sym.id < 0:
            return nil
        if sym.id >= self.strings.len():
            return nil
        self.strings[sym.id]

    fn contains(s: text) -> bool:
        self.map.contains(s)

    fn get_or_none(s: text):
        if self.map.contains(s):
            val idx = self.map[s]
            return SymbolId(id: idx)
        nil

    fn len() -> i64:
        self.strings.len()

# Global interner (module-level)
var GLOBAL_INTERNER = SymbolInterner(strings: [], map: {})

fn intern(s: text) -> SymbolId:
    GLOBAL_INTERNER.intern(s)

fn resolve_sym(sym: SymbolId):
    GLOBAL_INTERNER.resolve(sym)

fn init_common_symbols():
    GLOBAL_INTERNER.intern("self")
    GLOBAL_INTERNER.intern("true")
    GLOBAL_INTERNER.intern("false")
    GLOBAL_INTERNER.intern("nil")
    GLOBAL_INTERNER.intern("new")
    GLOBAL_INTERNER.intern("len")

fn reset_global_interner():
    GLOBAL_INTERNER = SymbolInterner(strings: [], map: {})

export SymbolId, SymbolId__invalid, SymbolInterner
export intern, resolve_sym, init_common_symbols, reset_global_interner
