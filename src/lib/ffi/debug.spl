# FFI - Debug Operations
# Centralized debugging, ptrace, and DWARF FFI wrappers for DAP integration

# ============================================================================
# Debug Operations
# ============================================================================

# --- Basic State ---

extern fn rt_debug_is_active() -> i64
extern fn rt_debug_set_active(active: i64)
extern fn rt_debug_set_step_mode(mode: i64)
extern fn rt_debug_get_step_mode() -> i64
extern fn rt_debug_set_step_start_depth(depth: i64)
extern fn rt_debug_get_step_start_depth() -> i64

fn debug_is_active() -> bool:
    rt_debug_is_active() != 0

fn debug_set_active(active: bool):
    rt_debug_set_active(if active: 1 else: 0)

fn debug_set_step_mode(mode: i64):
    rt_debug_set_step_mode(mode)

fn debug_get_step_mode() -> i64:
    rt_debug_get_step_mode()

fn debug_set_step_start_depth(depth: i64):
    rt_debug_set_step_start_depth(depth)

fn debug_get_step_start_depth() -> i64:
    rt_debug_get_step_start_depth()

# --- Pause/Continue ---

extern fn rt_debug_pause()
extern fn rt_debug_continue()
extern fn rt_debug_is_paused() -> i64
extern fn rt_debug_wait_for_continue()

fn debug_pause():
    rt_debug_pause()

fn debug_continue():
    rt_debug_continue()

fn debug_is_paused() -> bool:
    rt_debug_is_paused() != 0

fn debug_wait_for_continue():
    rt_debug_wait_for_continue()

# --- Location Tracking ---

extern fn rt_debug_set_current_location(file_ptr: i64, file_len: i64, line: i64, column: i64)
extern fn rt_debug_current_file() -> text
extern fn rt_debug_current_line() -> i64
extern fn rt_debug_current_column() -> i64

fn debug_set_current_location(file: text, line: i64, column: i64):
    rt_debug_set_current_location(file.ptr(), file.len(), line, column)

fn debug_current_file() -> text:
    rt_debug_current_file()

fn debug_current_line() -> i64:
    rt_debug_current_line()

fn debug_current_column() -> i64:
    rt_debug_current_column()

# --- Breakpoints ---

extern fn rt_debug_add_breakpoint(file_ptr: i64, file_len: i64, line: i64, id: i64)
extern fn rt_debug_remove_breakpoint(file_ptr: i64, file_len: i64, line: i64)
extern fn rt_debug_clear_breakpoints()
extern fn rt_debug_has_breakpoint(file_ptr: i64, file_len: i64, line: i64) -> i64

fn debug_add_breakpoint(file: text, line: i64, id: i64):
    rt_debug_add_breakpoint(file.ptr(), file.len(), line, id)

fn debug_remove_breakpoint(file: text, line: i64):
    rt_debug_remove_breakpoint(file.ptr(), file.len(), line)

fn debug_clear_breakpoints():
    rt_debug_clear_breakpoints()

fn debug_has_breakpoint(file: text, line: i64) -> bool:
    rt_debug_has_breakpoint(file.ptr(), file.len(), line) != 0

# --- Break Logic ---

extern fn rt_debug_should_break() -> i64

fn debug_should_break() -> bool:
    rt_debug_should_break() != 0

# --- Stack Frames ---

extern fn rt_debug_push_frame(func_name_ptr: i64, func_name_len: i64, file_ptr: i64, file_len: i64, line: i64, column: i64)
extern fn rt_debug_pop_frame()
extern fn rt_debug_stack_depth() -> i64
extern fn rt_debug_stack_trace() -> text

fn debug_push_frame(func_name: text, file: text, line: i64, column: i64):
    rt_debug_push_frame(func_name.ptr(), func_name.len(), file.ptr(), file.len(), line, column)

fn debug_pop_frame():
    rt_debug_pop_frame()

fn debug_stack_depth() -> i64:
    rt_debug_stack_depth()

fn debug_stack_trace() -> text:
    rt_debug_stack_trace()

# --- Variables ---

extern fn rt_debug_set_local(name_ptr: i64, name_len: i64, value_ptr: i64, value_len: i64)
extern fn rt_debug_set_global(name_ptr: i64, name_len: i64, value_ptr: i64, value_len: i64)
extern fn rt_debug_locals() -> text
extern fn rt_debug_globals() -> text
extern fn rt_debug_clear_locals()
extern fn rt_debug_clear_globals()

fn debug_set_local(name: text, value: text):
    rt_debug_set_local(name.ptr(), name.len(), value.ptr(), value.len())

fn debug_set_global(name: text, value: text):
    rt_debug_set_global(name.ptr(), name.len(), value.ptr(), value.len())

fn debug_locals() -> text:
    rt_debug_locals()

fn debug_globals() -> text:
    rt_debug_globals()

fn debug_clear_locals():
    rt_debug_clear_locals()

fn debug_clear_globals():
    rt_debug_clear_globals()

# ============================================================================
# Ptrace Operations (Linux Process Tracing)
# ============================================================================

extern fn rt_ptrace_attach(pid: i64) -> i64

fn ptrace_attach(pid: i64) -> i64:
    rt_ptrace_attach(pid)

extern fn rt_ptrace_detach(pid: i64) -> i64

fn ptrace_detach(pid: i64) -> i64:
    rt_ptrace_detach(pid)

extern fn rt_ptrace_continue(pid: i64) -> i64

fn ptrace_continue(pid: i64) -> i64:
    rt_ptrace_continue(pid)

extern fn rt_ptrace_single_step(pid: i64) -> i64

fn ptrace_single_step(pid: i64) -> i64:
    rt_ptrace_single_step(pid)

extern fn rt_ptrace_wait_stop(pid: i64) -> i64

fn ptrace_wait_stop(pid: i64) -> i64:
    rt_ptrace_wait_stop(pid)

extern fn rt_ptrace_get_registers(pid: i64) -> Dict<String, i64>

fn ptrace_get_registers(pid: i64) -> Dict<String, i64>:
    rt_ptrace_get_registers(pid)

extern fn rt_ptrace_read_memory(pid: i64, addr: i64, size: i64) -> [i64]

fn ptrace_read_memory(pid: i64, addr: i64, size: i64) -> [i64]:
    rt_ptrace_read_memory(pid, addr, size)

extern fn rt_ptrace_write_memory(pid: i64, addr: i64, data: i64) -> i64

fn ptrace_write_memory(pid: i64, addr: i64, data: i64) -> i64:
    rt_ptrace_write_memory(pid, addr, data)

# ============================================================================
# DWARF Operations (Debug Info Format)
# ============================================================================

extern fn rt_dwarf_load(binary_path: String) -> i64

fn dwarf_load(binary_path: String) -> i64:
    rt_dwarf_load(binary_path)

extern fn rt_dwarf_free(handle: i64)

fn dwarf_free(handle: i64):
    rt_dwarf_free(handle)

extern fn rt_dwarf_addr_to_line(handle: i64, addr: i64) -> String

fn dwarf_addr_to_line(handle: i64, addr: i64) -> String:
    rt_dwarf_addr_to_line(handle, addr)

extern fn rt_dwarf_line_to_addr(handle: i64, file: String, line: i64) -> i64

fn dwarf_line_to_addr(handle: i64, file: String, line: i64) -> i64:
    rt_dwarf_line_to_addr(handle, file, line)

extern fn rt_dwarf_function_at(handle: i64, addr: i64) -> String

fn dwarf_function_at(handle: i64, addr: i64) -> String:
    rt_dwarf_function_at(handle, addr)

extern fn rt_dwarf_locals_at(handle: i64, addr: i64, frame_base: i64) -> [String]

fn dwarf_locals_at(handle: i64, addr: i64, frame_base: i64) -> [String]:
    rt_dwarf_locals_at(handle, addr, frame_base)

# ============================================================================
# Exports
# ============================================================================

export debug_is_active
export debug_set_active
export debug_pause
export debug_continue
export debug_is_paused
export debug_wait_for_continue
export debug_add_breakpoint
export debug_remove_breakpoint
export debug_has_breakpoint
export debug_should_break
export debug_set_current_location
export debug_current_file
export debug_current_line
export debug_push_frame
export debug_pop_frame
export debug_stack_depth
export debug_stack_trace
export debug_locals
export debug_set_local
export debug_set_global
