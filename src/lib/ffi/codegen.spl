# FFI - Code Generation (Cranelift Backend)
# Centralized Cranelift IR generation FFI wrappers for JIT/AOT compilation

# ============================================================================
# Module Management
# ============================================================================

extern fn rt_cranelift_new_module(name_ptr: i64, name_len: i64, target: i64) -> i64
extern fn rt_cranelift_new_aot_module(name_ptr: i64, name_len: i64, target: i64) -> i64
extern fn rt_cranelift_finalize_module(module: i64) -> i64
extern fn cranelift_free_module(module: i64)

fn cranelift_new_module(name: text, target: i64) -> i64:
    rt_cranelift_new_module(name.ptr(), name.len(), target)

fn cranelift_new_aot_module(name: text, target: i64) -> i64:
    rt_cranelift_new_aot_module(name.ptr(), name.len(), target)

fn cranelift_finalize_module(module: i64) -> i64:
    rt_cranelift_finalize_module(module)

fn cranelift_finalize(module: i64) -> i64:
    rt_cranelift_finalize_module(module)

# ============================================================================
# Function Building
# ============================================================================

extern fn cranelift_begin_function(module: i64, name_ptr: i64, name_len: i64, sig: i64) -> i64
extern fn cranelift_end_function(ctx: i64) -> i64
extern fn cranelift_define_function(module: i64, func_id: i64, ctx: i64) -> bool

# ============================================================================
# Signature Building
# ============================================================================

extern fn cranelift_new_signature(call_conv: i64) -> i64
extern fn cranelift_sig_add_param(sig: i64, type_: i64)
extern fn cranelift_sig_set_return(sig: i64, type_: i64)

# ============================================================================
# Block Management
# ============================================================================

extern fn cranelift_create_block(ctx: i64) -> i64
extern fn cranelift_switch_to_block(ctx: i64, block: i64)
extern fn cranelift_seal_block(ctx: i64, block: i64)
extern fn cranelift_seal_all_blocks(ctx: i64)

# ============================================================================
# Block Parameters
# ============================================================================

extern fn rt_cranelift_append_block_param(ctx: i64, block: i64, type_: i64) -> i64
extern fn cranelift_block_param(ctx: i64, block: i64, index: i64) -> i64

fn cranelift_append_block_param(ctx: i64, block: i64, type_: i64) -> i64:
    rt_cranelift_append_block_param(ctx, block, type_)

# ============================================================================
# Value Creation
# ============================================================================

extern fn cranelift_iconst(ctx: i64, type_: i64, value: i64) -> i64
extern fn cranelift_fconst(ctx: i64, type_: i64, value: f64) -> i64
extern fn cranelift_bconst(ctx: i64, value: bool) -> i64
extern fn rt_cranelift_null(ctx: i64, type_: i64) -> i64

fn cranelift_null(ctx: i64, type_: i64) -> i64:
    rt_cranelift_null(ctx, type_)

# ============================================================================
# Integer Arithmetic
# ============================================================================

extern fn cranelift_iadd(ctx: i64, a: i64, b: i64) -> i64
extern fn cranelift_isub(ctx: i64, a: i64, b: i64) -> i64
extern fn cranelift_imul(ctx: i64, a: i64, b: i64) -> i64
extern fn cranelift_sdiv(ctx: i64, a: i64, b: i64) -> i64
extern fn rt_cranelift_udiv(ctx: i64, a: i64, b: i64) -> i64
extern fn cranelift_srem(ctx: i64, a: i64, b: i64) -> i64
extern fn rt_cranelift_urem(ctx: i64, a: i64, b: i64) -> i64

fn cranelift_udiv(ctx: i64, a: i64, b: i64) -> i64:
    rt_cranelift_udiv(ctx, a, b)

fn cranelift_urem(ctx: i64, a: i64, b: i64) -> i64:
    rt_cranelift_urem(ctx, a, b)

# ============================================================================
# Floating Point Arithmetic
# ============================================================================

extern fn rt_cranelift_fadd(ctx: i64, a: i64, b: i64) -> i64
extern fn rt_cranelift_fsub(ctx: i64, a: i64, b: i64) -> i64
extern fn rt_cranelift_fmul(ctx: i64, a: i64, b: i64) -> i64
extern fn rt_cranelift_fdiv(ctx: i64, a: i64, b: i64) -> i64

fn cranelift_fadd(ctx: i64, a: i64, b: i64) -> i64:
    rt_cranelift_fadd(ctx, a, b)

fn cranelift_fsub(ctx: i64, a: i64, b: i64) -> i64:
    rt_cranelift_fsub(ctx, a, b)

fn cranelift_fmul(ctx: i64, a: i64, b: i64) -> i64:
    rt_cranelift_fmul(ctx, a, b)

fn cranelift_fdiv(ctx: i64, a: i64, b: i64) -> i64:
    rt_cranelift_fdiv(ctx, a, b)

# ============================================================================
# Bitwise Operations
# ============================================================================

extern fn cranelift_band(ctx: i64, a: i64, b: i64) -> i64
extern fn cranelift_bor(ctx: i64, a: i64, b: i64) -> i64
extern fn cranelift_bxor(ctx: i64, a: i64, b: i64) -> i64
extern fn cranelift_bnot(ctx: i64, a: i64) -> i64
extern fn cranelift_ishl(ctx: i64, a: i64, b: i64) -> i64
extern fn cranelift_sshr(ctx: i64, a: i64, b: i64) -> i64
extern fn rt_cranelift_ushr(ctx: i64, a: i64, b: i64) -> i64

fn cranelift_ushr(ctx: i64, a: i64, b: i64) -> i64:
    rt_cranelift_ushr(ctx, a, b)

# ============================================================================
# Comparison
# ============================================================================

extern fn cranelift_icmp(ctx: i64, cond: i64, a: i64, b: i64) -> i64
extern fn rt_cranelift_fcmp(ctx: i64, cond: i64, a: i64, b: i64) -> i64

fn cranelift_fcmp(ctx: i64, cond: i64, a: i64, b: i64) -> i64:
    rt_cranelift_fcmp(ctx, cond, a, b)

# ============================================================================
# Memory Operations
# ============================================================================

extern fn cranelift_load(ctx: i64, type_: i64, addr: i64, offset: i64) -> i64
extern fn cranelift_store(ctx: i64, value: i64, addr: i64, offset: i64)
extern fn cranelift_stack_slot(ctx: i64, size: i64, align: i64) -> i64
extern fn cranelift_stack_addr(ctx: i64, slot: i64, offset: i64) -> i64

# ============================================================================
# Control Flow
# ============================================================================

extern fn cranelift_jump(ctx: i64, block: i64)
extern fn rt_cranelift_brif(ctx: i64, cond: i64, then_block: i64, else_block: i64)
extern fn cranelift_return(ctx: i64, value: i64)
extern fn cranelift_return_void(ctx: i64)
extern fn rt_cranelift_trap(ctx: i64, code: i64)

fn cranelift_brif(ctx: i64, cond: i64, then_block: i64, else_block: i64):
    rt_cranelift_brif(ctx, cond, then_block, else_block)

fn cranelift_branch_if(ctx: i64, cond: i64, then_block: i64, else_block: i64):
    rt_cranelift_brif(ctx, cond, then_block, else_block)

fn cranelift_trap(ctx: i64, code: i64):
    rt_cranelift_trap(ctx, code)

# ============================================================================
# Function Calls
# ============================================================================

extern fn cranelift_call(ctx: i64, func: i64, args_ptr: i64, args_len: i64) -> i64
extern fn cranelift_call_indirect(ctx: i64, sig: i64, addr: i64, args_ptr: i64, args_len: i64) -> i64

# ============================================================================
# JIT Execution
# ============================================================================

extern fn rt_cranelift_get_function_ptr(module: i64, name_ptr: i64, name_len: i64) -> i64
extern fn cranelift_call_function_ptr(ptr: i64, args_ptr: i64, args_len: i64) -> i64

fn cranelift_get_function_ptr(module: i64, name: text) -> i64:
    rt_cranelift_get_function_ptr(module, name.ptr(), name.len())

# ============================================================================
# AOT Object File Emission
# ============================================================================

extern fn rt_cranelift_emit_object(module: i64, path: text) -> bool

fn cranelift_emit_object(module: i64, path: text) -> bool:
    rt_cranelift_emit_object(module, path)

# ============================================================================
# Type Conversions
# ============================================================================

extern fn rt_cranelift_sextend(ctx: i64, to_type: i64, value: i64) -> i64
extern fn rt_cranelift_uextend(ctx: i64, to_type: i64, value: i64) -> i64
extern fn rt_cranelift_ireduce(ctx: i64, to_type: i64, value: i64) -> i64
extern fn cranelift_bitcast(ctx: i64, to_type: i64, value: i64) -> i64
extern fn rt_cranelift_fcvt_to_sint(ctx: i64, to_type: i64, value: i64) -> i64
extern fn rt_cranelift_fcvt_to_uint(ctx: i64, to_type: i64, value: i64) -> i64
extern fn rt_cranelift_fcvt_from_sint(ctx: i64, to_type: i64, value: i64) -> i64
extern fn rt_cranelift_fcvt_from_uint(ctx: i64, to_type: i64, value: i64) -> i64

fn cranelift_sextend(ctx: i64, to_type: i64, value: i64) -> i64:
    rt_cranelift_sextend(ctx, to_type, value)

fn cranelift_uextend(ctx: i64, to_type: i64, value: i64) -> i64:
    rt_cranelift_uextend(ctx, to_type, value)

fn cranelift_ireduce(ctx: i64, to_type: i64, value: i64) -> i64:
    rt_cranelift_ireduce(ctx, to_type, value)

fn cranelift_fcvt_to_sint(ctx: i64, to_type: i64, value: i64) -> i64:
    rt_cranelift_fcvt_to_sint(ctx, to_type, value)

fn cranelift_fcvt_to_uint(ctx: i64, to_type: i64, value: i64) -> i64:
    rt_cranelift_fcvt_to_uint(ctx, to_type, value)

fn cranelift_fcvt_from_sint(ctx: i64, to_type: i64, value: i64) -> i64:
    rt_cranelift_fcvt_from_sint(ctx, to_type, value)

fn cranelift_fcvt_from_uint(ctx: i64, to_type: i64, value: i64) -> i64:
    rt_cranelift_fcvt_from_uint(ctx, to_type, value)
