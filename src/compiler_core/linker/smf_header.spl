# SMF Header - Complete 128-byte header structure for SMF format
#
# This module defines the SmfHeader struct which represents the complete
# 128-byte header used in Simple Module Format (SMF) v1.1.
#
# The header is laid out in a C-compatible repr(C) format with exactly
# 128 bytes, designed to be written as a trailer at EOF-128 in v1.1 files.
#
# Layout (128 bytes total):
# - Identification (8 bytes): magic, version, platform, arch
# - Flags (20 bytes): flags, compression, section info
# - Symbols (16 bytes): symbol table metadata
# - Execution (16 bytes): entry point, stub info
# - Hashing (16 bytes): module and source hashes
# - Hints (12 bytes): app type, window hints, prefetch
# - Reserved (40 bytes): padding to 128 bytes
#
# Ported from: rust/runtime/src/loader/smf/header.rs

use .smf_enums (Platform, Arch, CompressionType, SmfAppType)

# ============================================================================
# Constants
# ============================================================================

val SMF_MAGIC: [u8] = [83, 77, 70, 0]  # "SMF\0"
val SMF_HEADER_SIZE: i64 = 128

# Flag constants
val SMF_FLAG_EXECUTABLE: u32 = 0x0001
val SMF_FLAG_RELOADABLE: u32 = 0x0002
val SMF_FLAG_DEBUG_INFO: u32 = 0x0004
val SMF_FLAG_PIC: u32 = 0x0008
val SMF_FLAG_HAS_STUB: u32 = 0x0010  # v1.1: File has executable stub

# ============================================================================
# SmfHeader Struct
# ============================================================================

"""Complete SMF header structure (128 bytes).

The SmfHeader represents the complete header layout for SMF v1.1 files.
In v1.1, the header is written at EOF-128 as a trailer, allowing for
executable stubs to be prepended to SMF files.

Structure (128 bytes total):
- Identification (8): magic[4], version_major, version_minor, platform, arch
- Flags (20): flags, compression, compression_level, reserved_compression[2],
              section_count, section_table_offset
- Symbols (16): symbol_table_offset, symbol_count, exported_count
- Execution (16): entry_point, stub_size, smf_data_offset
- Hashing (16): module_hash, source_hash
- Hints (12): app_type, window_width, window_height, prefetch_hint,
              prefetch_file_count, reserved[5]
- Reserved (40): padding to reach 128 bytes
"""
struct SmfHeader:
    # Identification (8 bytes)
    magic: [u8]              # Magic number "SMF\0" (4 bytes)
    version_major: u8        # Major version (1)
    version_minor: u8        # Minor version (1)
    platform: u8             # Platform identifier
    arch: u8                 # Architecture identifier

    # Flags and counts (20 bytes) - v1.1 adds compression
    flags: u32               # Feature flags
    compression: u8          # v1.1: 0=none, 1=zstd, 2=lz4
    compression_level: u8    # v1.1: 0=default, 1-22=level
    reserved_compression: [u8]  # v1.1: 2 bytes reserved
    section_count: u32       # Number of sections
    section_table_offset: u64  # Offset to section table

    # Symbol table (16 bytes)
    symbol_table_offset: u64  # Offset to symbol table
    symbol_count: u32         # Number of symbols
    exported_count: u32       # Number of exported symbols

    # Execution (16 bytes) - v1.1 adds stub fields
    entry_point: u64          # Entry point address
    stub_size: u32            # v1.1: Size of executable stub (0=pure SMF)
    smf_data_offset: u32      # v1.1: Offset where SMF data begins

    # Hashing (16 bytes)
    module_hash: u64          # Hash of module content
    source_hash: u64          # Hash of source files

    # Startup optimization hints (12 bytes)
    app_type: u8              # Application type (0=cli, 1=tui, 2=gui, 3=service, 4=repl)
    window_width: u16         # Window width hint (GUI apps)
    window_height: u16        # Window height hint (GUI apps)
    prefetch_hint: u8         # Prefetch hint: 0=no, 1=yes
    prefetch_file_count: u8   # Expected number of files to prefetch
    reserved_hints: [u8]      # 5 bytes reserved

    # Reserved (40 bytes) - padding to 128 bytes total
    reserved: [u8]            # 40 bytes reserved for future use


# ============================================================================
# SmfHeader Methods (was: impl SmfHeader:)
# ============================================================================

fn smfheader_new_v1_1(platform: Platform, arch: Arch) -> SmfHeader:
        SmfHeader(
            magic: SMF_MAGIC,
            version_major: 1,
            version_minor: 1,
            platform: platform_to_u8(platform),
            arch: arch_to_u8(arch),
            flags: 0,
            compression: 0,
            compression_level: 0,
            reserved_compression: [0, 0],
            section_count: 0,
            section_table_offset: 0,
            symbol_table_offset: 0,
            symbol_count: 0,
            exported_count: 0,
            entry_point: 0,
            stub_size: 0,
            smf_data_offset: 0,
            module_hash: 0,
            source_hash: 0,
            app_type: 0,
            window_width: 1280,
            window_height: 720,
            prefetch_hint: 0,
            prefetch_file_count: 0,
            reserved_hints: [0, 0, 0, 0, 0],
            reserved: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
        )


# ============================================================================
# Helper Functions
# ============================================================================

"""Convert u16 to bytes (little-endian)."""
fn u16_to_bytes(value: u16) -> [u8]:
    [
        (value & 0xFF) as u8,
        ((value >> 8) & 0xFF) as u8
    ]

"""Convert u32 to bytes (little-endian)."""
fn u32_to_bytes(value: u32) -> [u8]:
    [
        (value & 0xFF) as u8,
        ((value >> 8) & 0xFF) as u8,
        ((value >> 16) & 0xFF) as u8,
        ((value >> 24) & 0xFF) as u8
    ]

"""Convert u64 to bytes (little-endian)."""
fn u64_to_bytes(value: u64) -> [u8]:
    [
        (value & 0xFF) as u8,
        ((value >> 8) & 0xFF) as u8,
        ((value >> 16) & 0xFF) as u8,
        ((value >> 24) & 0xFF) as u8,
        ((value >> 32) & 0xFF) as u8,
        ((value >> 40) & 0xFF) as u8,
        ((value >> 48) & 0xFF) as u8,
        ((value >> 56) & 0xFF) as u8
    ]
