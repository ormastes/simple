# SMF Reader Memory Test Specification
#
# Tests for the in-memory SMF reader that loads SMF data from byte arrays
# instead of files.

use std.sspec.*
use compiler.linker.smf_reader_memory.{SmfReaderMemory, SmfHeader, SmfFlags}
use compiler.linker.smf_enums.{Platform, Arch}

# ============================================================================
# Test Helpers
# ============================================================================

fn create_minimal_smf() -> [u8]:
    """Create a minimal valid SMF file."""
    var data: [u8] = []

    # Magic: "SMF\0"
    data.push(83)  # 'S'
    data.push(77)  # 'M'
    data.push(70)  # 'F'
    data_push(data, 0)   # null

    # Version: 1.1
    data_push(data, 1)   # major
    data_push(data, 1)   # minor

    # Platform: Linux (1)
    data_push(data, 1)

    # Arch: X86_64 (0)
    data_push(data, 0)

    # Flags: 0 (no flags set)
    data_push(data, 0)
    data_push(data, 0)
    data_push(data, 0)
    data_push(data, 0)

    # Compression: 0 (none)
    data_push(data, 0)

    # Reserved compression
    data_push(data, 0)
    data_push(data, 0)
    data_push(data, 0)

    # Section count: 0
    data_push(data, 0)
    data_push(data, 0)
    data_push(data, 0)
    data_push(data, 0)

    # Section table offset: 128 (right after header)
    data_push(data, 128)
    data_push(data, 0)
    data_push(data, 0)
    data_push(data, 0)
    data_push(data, 0)
    data_push(data, 0)
    data_push(data, 0)
    data_push(data, 0)

    # Symbol table offset: 128
    data_push(data, 128)
    data_push(data, 0)
    data_push(data, 0)
    data_push(data, 0)
    data_push(data, 0)
    data_push(data, 0)
    data_push(data, 0)
    data_push(data, 0)

    # Symbol count: 0
    data_push(data, 0)
    data_push(data, 0)
    data_push(data, 0)
    data_push(data, 0)

    # Exported count: 0
    data_push(data, 0)
    data_push(data, 0)
    data_push(data, 0)
    data_push(data, 0)

    # Entry point: 0
    var i = 0
    while i < 8:
        data_push(data, 0)
        i = i + 1

    # Pad to 128 bytes (header size)
    while data_len(data) < 128:
        data_push(data, 0)

    data

# ============================================================================
# SmfReaderMemory Tests
# ============================================================================

describe "SmfReaderMemory":
    it "rejects data that is too small":
        val tiny_data = [1, 2, 3]
        val result = smfreadermemory_from_data(tiny_data)

        expect(result_is_err(result)).to_equal(true)

    it "rejects data with invalid magic":
        var bad_data: [u8] = []

        # Wrong magic: "BAD\0"
        bad_data.push(66)  # 'B'
        bad_data.push(65)  # 'A'
        bad_data.push(68)  # 'D'
        bad_data_push(bad_data, 0)

        # Pad to minimum size
        while bad_data_len(bad_data) < 128:
            bad_data_push(bad_data, 0)

        val result = smfreadermemory_from_data(bad_data)
        expect(result_is_err(result)).to_equal(true)

    it "accepts minimal valid SMF":
        val smf_data = create_minimal_smf()
        val result = smfreadermemory_from_data(smf_data)

        expect(result_is_ok(result)).to_equal(true)

    it "parses header correctly":
        val smf_data = create_minimal_smf()
        val reader = smfreadermemory_from_data(smf_data).unwrap()

        val header = reader_get_header(reader)
        val (major, minor) = header.version

        expect(major).to_equal(1)
        expect(minor).to_equal(1)
        expect(header.section_count).to_equal(0)
        expect(header.symbol_count).to_equal(0)

    it "reports correct data size":
        val smf_data = create_minimal_smf()
        val reader = smfreadermemory_from_data(smf_data).unwrap()

        expect(reader_data_size(reader)).to_equal(128)

    it "returns empty symbol list for minimal SMF":
        val smf_data = create_minimal_smf()
        val reader = smfreadermemory_from_data(smf_data).unwrap()

        val exported = reader_exported_symbols(reader)
        expect(exported_len(exported)).to_equal(0)

# ============================================================================
# Header Parsing Tests
# ============================================================================

describe "SMF Header Parsing":
    it "parses version correctly":
        val smf_data = create_minimal_smf()
        val reader = smfreadermemory_from_data(smf_data).unwrap()
        val header = reader_get_header(reader)

        val (major, minor) = header.version
        expect(major).to_equal(1)
        expect(minor).to_equal(1)

    it "parses flags correctly":
        val smf_data = create_minimal_smf()
        val reader = smfreadermemory_from_data(smf_data).unwrap()
        val header = reader_get_header(reader)

        # No flags should be set in minimal SMF
        expect(header.flags.executable).to_equal(false)
        expect(header.flags.reloadable).to_equal(false)
        expect(header.flags.debug_info).to_equal(false)

    it "validates header":
        val smf_data = create_minimal_smf()
        val reader = smfreadermemory_from_data(smf_data).unwrap()
        val header = reader_get_header(reader)

        expect(header_is_valid(header)).to_equal(true)

# ============================================================================
# Integration Tests
# ============================================================================

describe "In-Memory Reader Integration":
    it "can be created from library-extracted data":
        # This tests the workflow: library -> bytes -> memory reader
        val smf_data = create_minimal_smf()

        # Simulate library extraction
        var extracted_data: [u8] = []
        for b in smf_data:
            extracted_data_push(extracted_data, b)

        # Create reader from extracted data
        val result = smfreadermemory_from_data(extracted_data)
        expect(result_is_ok(result)).to_equal(true)

    it "preserves data integrity":
        val original_data = create_minimal_smf()
        val reader = smfreadermemory_from_data(original_data).unwrap()

        # Size should match
        expect(reader_data_size(reader)).to_equal(original_data_len(original_data))
