# SMF Header Specification
#
# Unit tests for SmfHeader struct:
# - Construction and initialization
# - Version methods
# - Platform and architecture methods
# - Flag methods
# - Compression methods
# - Stub methods
# - App type and hints methods
# - Serialization (128-byte validation)

use ..smf_header.*
use ..smf_enums.*
use testing.{describe, it, expect}

# describe: SmfHeader construction
    fn test_creates_new_v1_1__header_with_defaults_1():
        val header = smfheader_new_v1_1(Platform.Linux, Arch.X86_64)

        expect(header.version_major == 1)
        expect(header.version_minor == 1)
        expect(header_get_platform(header) == Platform.Linux)
        expect(header_get_arch(header) == Arch.X86_64)
        expect(header.flags == 0)
        expect(header.compression == 0)
        expect(header.stub_size == 0)
        expect(header.app_type == 0)
        expect(header.window_width == 1280)
        expect(header.window_height == 720)

    fn test_creates_header_for_different_platforms_and_architectures_2():
        val header1 = smfheader_new_v1_1(Platform.Windows, Arch.Aarch64)
        expect(header1_get_platform(header1) == Platform.Windows)
        expect(header1_get_arch(header1) == Arch.Aarch64)

        val header2 = smfheader_new_v1_1(Platform.MacOS, Arch.Arm)
        expect(header2_get_platform(header2) == Platform.MacOS)
        expect(header2_get_arch(header2) == Arch.Arm)

# describe: Version methods
    fn test_returns_correct_version_tuple_3():
        val header = smfheader_new_v1_1(Platform.Linux, Arch.X86_64)
        val _destruct_0 = header_version(header)
        val major = _destruct_0[0]
        val minor = _destruct_0[1]
        expect(major == 1)
        expect(minor == 1)

    fn test_correctly_identifies_v1_1__headers_4():
        val header = smfheader_new_v1_1(Platform.Linux, Arch.X86_64)
        expect(header_is_v1_1(header))
        expect(not header_is_v1_0(header))

# describe: Platform and architecture methods
    fn test_gets_and_sets_platform_correctly_5():
        var header = smfheader_new_v1_1(Platform.Linux, Arch.X86_64)
        expect(header_get_platform(header) == Platform.Linux)

        header_set_platform(header, Platform.Windows)
        expect(header_get_platform(header) == Platform.Windows)

        header_set_platform(header, Platform.FreeBSD)
        expect(header_get_platform(header) == Platform.FreeBSD)

    fn test_gets_and_sets_architecture_correctly_6():
        var header = smfheader_new_v1_1(Platform.Linux, Arch.X86_64)
        expect(header_get_arch(header) == Arch.X86_64)

        header_set_arch(header, Arch.Aarch64)
        expect(header_get_arch(header) == Arch.Aarch64)

        header_set_arch(header, Arch.Riscv64)
        expect(header_get_arch(header) == Arch.Riscv64)

# describe: Flag methods
    fn test_sets_and_checks_executable_flag_7():
        var header = smfheader_new_v1_1(Platform.Linux, Arch.X86_64)
        expect(not header_is_executable(header))

        header_set_executable(header, true)
        expect(header_is_executable(header))

        header_set_executable(header, false)
        expect(not header_is_executable(header))

    fn test_sets_and_checks_reloadable_flag_8():
        var header = smfheader_new_v1_1(Platform.Linux, Arch.X86_64)
        expect(not header_is_reloadable(header))

        header_set_reloadable(header, true)
        expect(header_is_reloadable(header))

        header_set_reloadable(header, false)
        expect(not header_is_reloadable(header))

    fn test_sets_and_checks_debug_info_flag_9():
        var header = smfheader_new_v1_1(Platform.Linux, Arch.X86_64)
        expect(not header_has_debug_info(header))

        header_set_debug_info(header, true)
        expect(header_has_debug_info(header))

        header_set_debug_info(header, false)
        expect(not header_has_debug_info(header))

    fn test_sets_and_checks_PIC_flag_10():
        var header = smfheader_new_v1_1(Platform.Linux, Arch.X86_64)
        expect(not header_is_pic(header))

        header_set_pic(header, true)
        expect(header_is_pic(header))

        header_set_pic(header, false)
        expect(not header_is_pic(header))

    fn test_sets_multiple_flags_independently_11():
        var header = smfheader_new_v1_1(Platform.Linux, Arch.X86_64)

        header_set_executable(header, true)
        header_set_reloadable(header, true)
        expect(header_is_executable(header))
        expect(header_is_reloadable(header))
        expect(not header_has_debug_info(header))
        expect(not header_is_pic(header))

        header_set_debug_info(header, true)
        expect(header_is_executable(header))
        expect(header_is_reloadable(header))
        expect(header_has_debug_info(header))

# describe: Compression methods
    fn test_checks_compression_status_12():
        var header = smfheader_new_v1_1(Platform.Linux, Arch.X86_64)
        expect(not header_is_compressed(header))

        header_set_compression(header, CompressionType.Zstd, 3)
        expect(header_is_compressed(header))

    fn test_gets_and_sets_compression_type_13():
        var header = smfheader_new_v1_1(Platform.Linux, Arch.X86_64)
        expect(header_get_compression(header) == CompressionType.None_)

        header_set_compression(header, CompressionType.Zstd, 5)
        expect(header_get_compression(header) == CompressionType.Zstd)
        expect(header.compression_level == 5)

        header_set_compression(header, CompressionType.Lz4, 1)
        expect(header_get_compression(header) == CompressionType.Lz4)
        expect(header.compression_level == 1)

# describe: Stub methods
    fn test_gets_stub_size_14():
        val header = smfheader_new_v1_1(Platform.Linux, Arch.X86_64)
        expect(header_get_stub_size(header) == 0)

    fn test_gets_SMF_data_offset_15():
        val header = smfheader_new_v1_1(Platform.Linux, Arch.X86_64)
        expect(header_get_smf_data_offset(header) == 0)

    fn test_sets_stub_info_and_updates_flags_16():
        var header = smfheader_new_v1_1(Platform.Linux, Arch.X86_64)
        expect(not header_has_stub(header))

        header_set_stub_info(header, 1024, 1024)
        expect(header_get_stub_size(header) == 1024)
        expect(header_get_smf_data_offset(header) == 1024)
        expect(header_has_stub(header))

    fn test_does_not_set_stub_flag_when_stub_size_is_0_17():
        var header = smfheader_new_v1_1(Platform.Linux, Arch.X86_64)
        header_set_stub_info(header, 0, 0)
        expect(not header_has_stub(header))

# describe: App type and hints methods
    fn test_gets_and_sets_app_type_18():
        var header = smfheader_new_v1_1(Platform.Linux, Arch.X86_64)
        expect(header_get_app_type(header) == SmfAppType.Cli)

        header_set_app_type(header, SmfAppType.Gui)
        expect(header_get_app_type(header) == SmfAppType.Gui)

        header_set_app_type(header, SmfAppType.Service)
        expect(header_get_app_type(header) == SmfAppType.Service)

    fn test_sets_window_hints_19():
        var header = smfheader_new_v1_1(Platform.Linux, Arch.X86_64)
        expect(header.window_width == 1280)
        expect(header.window_height == 720)

        header_set_window_hints(header, 1920, 1080)
        expect(header.window_width == 1920)
        expect(header.window_height == 1080)

    fn test_checks_and_sets_prefetch_hints_20():
        var header = smfheader_new_v1_1(Platform.Linux, Arch.X86_64)
        expect(not header_should_prefetch(header))
        expect(header_expected_prefetch_count(header) == 0)

        header_set_prefetch_hint(header, true, 10)
        expect(header_should_prefetch(header))
        expect(header_expected_prefetch_count(header) == 10)

        header_set_prefetch_hint(header, false, 0)
        expect(not header_should_prefetch(header))

# describe: Serialization
    fn test_serializes_to_exactly_128_bytes_21():
        val header = smfheader_new_v1_1(Platform.Linux, Arch.X86_64)
        val bytes = header_to_bytes(header)
        expect(bytes_len(bytes) == 128)

    fn test_serializes_header_with_all_fields_set_22():
        var header = smfheader_new_v1_1(Platform.Windows, Arch.Aarch64)
        header_set_executable(header, true)
        header_set_reloadable(header, true)
        header_set_debug_info(header, true)
        header_set_compression(header, CompressionType.Zstd, 5)
        header.section_count = 10
        header.section_table_offset = 512
        header.symbol_table_offset = 1024
        header.symbol_count = 25
        header.exported_count = 5
        header.entry_point = 0x1000
        header_set_stub_info(header, 2048, 2048)
        header.module_hash = 0x123456789ABCDEF0
        header.source_hash = 0x7EDCBA9876543210
        header_set_app_type(header, SmfAppType.Gui)
        header_set_window_hints(header, 1920, 1080)
        header_set_prefetch_hint(header, true, 15)

        val bytes = header_to_bytes(header)
        expect(bytes_len(bytes) == 128)

    fn test_serializes_magic_number_correctly_23():
        val header = smfheader_new_v1_1(Platform.Linux, Arch.X86_64)
        val bytes = header_to_bytes(header)

        # Magic "SMF\0"
        expect(bytes[0] == 83)   # 'S'
        expect(bytes[1] == 77)   # 'M'
        expect(bytes[2] == 70)   # 'F'
        expect(bytes[3] == 0)    # '\0'

    fn test_serializes_version_correctly_24():
        val header = smfheader_new_v1_1(Platform.Linux, Arch.X86_64)
        val bytes = header_to_bytes(header)

        expect(bytes[4] == 1)    # version_major
        expect(bytes[5] == 1)    # version_minor

    fn test_serializes_platform_and_arch_correctly_25():
        val header = smfheader_new_v1_1(Platform.Windows, Arch.Aarch64)
        val bytes = header_to_bytes(header)

        expect(bytes[6] == 2)    # platform: Windows
        expect(bytes[7] == 1)    # arch: Aarch64
