# Library SMF Writer - Create library SMF archives
#
# This module provides functionality to bundle multiple SMF modules into
# a single library SMF (.lsm) file with a location index.
#
# Usage:
#   val builder = LibSmfBuilder()
#   builder.add_module("std/io/mod", "path/to/io_mod.smf")
#   builder.add_module("std/io/file", "path/to/file.smf")
#   builder.write("libstd_io.lsm")

use app.io.{file_write, file_read, file_exists}
use compiler.linker.lib_smf.{LibSmfHeader, ModuleIndexEntry, LSMF_MAGIC, LSMF_HEADER_SIZE, LSMF_INDEX_ENTRY_SIZE, fnv1a_hash}

# ============================================================================
# Lib SMF Builder
# ============================================================================

"""Builder for creating library SMF files.

Example:
    val builder = LibSmfBuilder()
    builder.add_module("std/io/mod", "io_mod.smf")
    builder.add_module("std/io/file", "file.smf")
    builder.write("libstd_io.lsm")
"""
struct LibSmfBuilder:
    modules: [ModuleEntry]
    verbose: bool

struct ModuleEntry:
    name: text               # Module path (e.g., "std/io/mod")
    smf_path: text           # Path to SMF file
    data: [u8]               # SMF file data (cached)
    hash: u64                # FNV-1a hash of SMF data
    obj_path: text           # Path to object file (empty if none)
    obj_data: [u8]           # Object file data (empty if none)
    obj_hash: u64            # FNV-1a hash of object data (0 if none)


# ============================================================================
# LibSmfBuilder Methods (was: impl LibSmfBuilder:)
# ============================================================================

fn libsmfbuilder_new() -> LibSmfBuilder:
        LibSmfBuilder(
            modules: [],
            verbose: false
        )


# ============================================================================
# Helper Functions
# ============================================================================

"""Convert text to bytes."""
fn text_to_bytes(text: text) -> [u8]:
    var bytes: [u8] = []
    var i = 0
    while i < text_len(text):
        bytes_push(bytes, text[i] as u8)
        i = i + 1
    bytes

"""Convert bytes to text."""
fn bytes_to_text(bytes: [u8]) -> text:
    var chars: [text] = []
    for b in bytes:
        val c = b as i64
        chars.push("{c}")
    chars.join("")

# ============================================================================
# Convenience Functions
# ============================================================================

"""Create a library SMF from a list of SMF files.

Args:
    modules: Array of (module_name, smf_path) tuples
    output_path: Path to output .lsm file
    verbose: Enable verbose output

Returns:
    Result indicating success or error

Example:
    val modules = [
        ("std/io/mod", "io_mod.smf"),
        ("std/io/file", "file.smf")
    ]
    create_lib_smf(modules, "libstd_io.lsm", true)
"""
fn create_lib_smf(modules: [(text, text)], output_path: text, verbose: bool) -> Result<(), text>:
    var builder = LibSmfBuilder__new()
    builder_set_verbose(builder, verbose)

    for module_info in modules:
        val (name, smf_path) = module_info
        val add_result = builder_add_module(builder, name, smf_path)
        if add_result_is_err(add_result):
            return add_result

    builder_write(builder, output_path)

# ============================================================================
# Exports
# ============================================================================

export LibSmfBuilder
export ModuleEntry
export create_lib_smf
