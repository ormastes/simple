"""
Trait System - Phase 2A: Trait Definitions

Defines traits and stores them in a registry.

Status: Phase 2A In Progress
"""

type Symbol = text
type Span = text

# ============================================================================
# Method Signature
# ============================================================================

class MethodSig:
    """Method signature in a trait"""
    name: text
    params: text       # Placeholder for param types (will be [HirType])
    return_type: text  # Placeholder (will be HirType)
    has_self: bool     # Does method take self parameter


# ============================================================================
# MethodSig Methods (was: impl MethodSig:)
# ============================================================================

fn methodsig_new(name: text, has_self: bool) -> MethodSig:
        MethodSig(
            name: name,
            params: "[]",  # Placeholder
            return_type: "Unit",
            has_self: has_self
        )


# ============================================================================
# Trait Definition
# ============================================================================

class TraitDef:
    """
    Trait definition

    Example:
        trait Display:
            fn to_string() -> text:
                pass

        trait Iterator:
            type Item
            fn next() -> Item:
    """
    name: text
    methods: text      # Placeholder for [MethodSig]
    supertraits: text  # Placeholder for [Symbol]


# ============================================================================
# TraitDef Methods (was: impl TraitDef:)
# ============================================================================

fn traitdef_new(name: text) -> TraitDef:
        TraitDef(
            name: name,
            methods: "[]",
            supertraits: "[]"
        )


# ============================================================================
# Trait Registry
# ============================================================================

class TraitRegistry:
    """
    Stores all trait definitions

    Operations:
    - register_trait(trait_def)
    - get_trait(name) -> TraitDef
    - has_trait(name) -> bool
    """
    traits: text  # Will be Dict<Symbol, TraitDef>


# ============================================================================
# TraitRegistry Methods (was: impl TraitRegistry:)
# ============================================================================

fn traitregistry_new() -> TraitRegistry:
        val registry_data = {
            "traits": {}
        }
        TraitRegistry(traits: registry_data)


fn traitregistry_register_trait(self: TraitRegistry, trait_def: TraitDef) -> bool:
        """
        Register a trait definition

        Returns: true if registered, false if already exists
        """
        val traits = self.traits["traits"]

        if traits.contains(trait_def.name):
            return false  # Already registered

        traits[trait_def.name] = trait_def
        true


# ============================================================================
# Built-in Traits Module
# ============================================================================

fn create_standard_traits() -> TraitRegistry:
    """Create registry with standard traits"""
    val registry = traitregistry_new()
    registry_define_builtin_traits(registry)
    registry

# ============================================================================
# Tests
# ============================================================================

fn test_method_sig():
    """Test method signature creation"""
    val method = MethodSig.new("to_string", true)

    assert method.name == "to_string"  # Method name
    assert method.has_self  # Has self param

    print "âœ… Method signature"

fn test_trait_def():
    """Test trait definition"""
    val trait_def = TraitDef.new("Display")

    assert trait_def.name == "Display"  # Trait name
    # TODO: assert trait_def.to_string() == "trait Display", "Trait string")

    print "âœ… Trait definition"

fn test_registry_basic():
    """Test basic registry operations"""
    val registry = traitregistry_new()

    # TODO: assert registry.count_traits() == 0, "Empty registry")

    # Register trait
    val display = TraitDef.new("Display")
    val registered = registry_register_trait(registry, display)

    assert registered  # Trait registered
    # TODO: assert registry.count_traits() == 1, "One trait")
    # TODO: assert registry.has_trait("Display"), "Has Display")
    # TODO: assert not registry.has_trait("Unknown"), "No Unknown")

    print "âœ… Registry basics"

fn test_duplicate_registration():
    """Test duplicate trait registration is prevented"""
    val registry = traitregistry_new()

    val display1 = TraitDef.new("Display")
    val display2 = TraitDef.new("Display")

    val first = registry_register_trait(registry, display1)
    val second = registry_register_trait(registry, display2)

    assert first  # First registration succeeds
    assert not second  # Second registration fails
    # TODO: assert registry.count_traits() == 1, "Only one trait")

    print "âœ… Duplicate prevention"

fn test_trait_lookup():
    """Test looking up traits"""
    val registry = traitregistry_new()

    val display = TraitDef.new("Display")
    registry_register_trait(registry, display)

    val found = registry.get_trait("Display")
    assert found.name == "Display"  # Found correct trait

    val not_found = registry.get_trait("Unknown")
    assert not_found.name == "NotFound"  # Returns dummy for unknown

    print "âœ… Trait lookup"

fn test_builtin_traits():
    """Test built-in trait definitions"""
    val registry = create_standard_traits()

    # Check all standard traits are registered
    # TODO: assert registry.has_trait("Display"), "Has Display")
    # TODO: assert registry.has_trait("Eq"), "Has Eq")
    # TODO: assert registry.has_trait("Ord"), "Has Ord")
    # TODO: assert registry.has_trait("Clone"), "Has Clone")
    # TODO: assert registry.has_trait("Debug"), "Has Debug")

    # TODO: assert registry.count_traits() == 5, "5 built-in traits")

    print "âœ… Built-in traits"

fn main():
    print ""
    print "Trait Definitions Tests"
    print "======================="

    test_method_sig()
    test_trait_def()
    test_registry_basic()
    test_duplicate_registration()
    test_trait_lookup()
    test_builtin_traits()

    print ""
    print "ğŸ‰ Phase 2A Part 1 Complete!"
    print ""
    print "Implemented:"
    print "  âœ… MethodSig - method signatures"
    print "  âœ… TraitDef - trait definitions"
    print "  âœ… TraitRegistry - trait storage"
    print "  âœ… Built-in traits (Display, Eq, Ord, Clone, Debug)"
    print "  âœ… Duplicate prevention"
    print ""
    print "Next: Phase 2A Part 2 - Supertrait validation (4h)"
