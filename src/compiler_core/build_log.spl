# Build Logging and Replay
#
# Records compilation sessions for debugging and auditing.
# Captures phases, timing, diagnostics, and artifacts.
#
# Port of rust/compiler/src/build_log.rs (491 lines)

use ffi.system*

export BuildLog, BuildEnvironment, BuildInputs, BuildPhase
export BuildOutput, BuildDiagnostic, BuildLogger

# ============================================================================
# Build Log Types
# ============================================================================

enum PhaseResult:
    Success
    Warning
    Error

enum DiagnosticLevel:
    Error
    Warning
    Info
    Hint

struct BuildEnvironment:
    working_dir: text
    env_vars: {text: text}

struct BuildInputs:
    source_files: [text]
    dependencies: {text: text}

struct BuildPhase:
    name: text
    duration_ms: i64
    result: PhaseResult
    # DESUGARED: error: text?
    has_error: bool
    error_value: text

struct BuildOutput:
    artifacts: [text]
    total_size: i64

struct BuildDiagnostic:
    level: DiagnosticLevel
    message: text
    # DESUGARED: file: text?
    has_file: bool
    file_value: text
    # DESUGARED: line: i64?
    has_line: bool
    line_value: i64
    # DESUGARED: code: text?
    has_code: bool
    code_value: text

struct BuildLog:
    session_id: text
    timestamp: text
    compiler_version: text
    command: text
    environment: BuildEnvironment
    inputs: BuildInputs
    phases: [BuildPhase]
    # DESUGARED: output: BuildOutput?
    has_output: bool
    output_value: BuildOutput
    diagnostics: [BuildDiagnostic]
    success: bool


# ============================================================================
# BuildLog Methods (was: impl BuildLog:)
# ============================================================================

# ============================================================================
# Build Logger
# ============================================================================

class BuildLogger:
    """Records build session details."""
    session_id: text
    start_time: text
    command: text
    phases: [BuildPhase]
    diagnostics: [BuildDiagnostic]
    source_files: [text]


# ============================================================================
# BuildLogger Methods (was: impl BuildLogger:)
# ============================================================================

fn buildlogger_start(command: text) -> BuildLogger:
        BuildLogger(session_id: uuid_v4(), start_time: time_now_iso(),
                    command: command, phases: [], diagnostics: [],
                    source_files: [])


fn buildlogger_start_phase(self: BuildLogger, name: text) -> i64:
        """Returns phase index for later completion."""
        val idx = self.phases_len(phases)
        self.phases = self.phases.push(BuildPhase(
            name: name, duration_ms: 0,
            result: PhaseResult.Success, error: nil))
        time_millis()


fn buildlogger_finish(self: BuildLogger, output: BuildOutput?) -> BuildLog:
        val working_dir = env_var("PWD") ?? "."
        val success = self.diagnostics.filter(\d:
            match d.level: case Error: true; case _: false).len() == 0

        BuildLog(
            session_id: self.session_id,
            timestamp: self.start_time,
            compiler_version: "0.1.0",
            command: self.command,
            environment: BuildEnvironment(working_dir: working_dir, env_vars: {}),
            inputs: BuildInputs(source_files: self.source_files, dependencies: {}),
            phases: self.phases,
            output: output,
            diagnostics: self.diagnostics,
            success: success)

