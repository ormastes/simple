# ARM/AArch64 Inline Assembly Backend
#
# Generates ARM assembly from inline asm blocks.

use compiler.inline_asm.{InlineAsm, AsmOperand, AsmRegister, AsmOption}
use std.common.target.{TargetArch}

# ===========================================================================
# ARM Register Allocation
# ===========================================================================

class ArmRegisterAllocator:
    """Allocates ARM registers for inline assembly."""
    arch: TargetArch
    used_regs: Dict<text, bool>


# ============================================================================
# ArmRegisterAllocator Methods (was: impl ArmRegisterAllocator:)
# ============================================================================

fn armregisterallocator_new(arch: TargetArch) -> ArmRegisterAllocator:
        ArmRegisterAllocator(
            arch: arch,
            used_regs: {}
        )


# ===========================================================================
# ARM Assembly Generator
# ===========================================================================

class ArmAsmGenerator:
    """Generates ARM assembly."""
    arch: TargetArch
    allocator: ArmRegisterAllocator


# ============================================================================
# ArmAsmGenerator Methods (was: impl ArmAsmGenerator:)
# ============================================================================

fn armasmgenerator_new(arch: TargetArch) -> ArmAsmGenerator:
        ArmAsmGenerator(
            arch: arch,
            allocator: armregisterallocator_new(arch)
        )


# ===========================================================================
# ARM-Specific Instructions
# ===========================================================================

fn cpsid() -> InlineAsm:
    """Disable interrupts (Cortex-M)."""
    var asm = InlineAsm.new(["cpsid i"], Span.default())
    asm_add_option(asm, AsmOption.Volatile)
    asm

fn cpsie() -> InlineAsm:
    """Enable interrupts (Cortex-M)."""
    var asm = InlineAsm.new(["cpsie i"], Span.default())
    asm_add_option(asm, AsmOption.Volatile)
    asm

fn wfi() -> InlineAsm:
    """Wait for interrupt."""
    var asm = InlineAsm.new(["wfi"], Span.default())
    asm_add_option(asm, AsmOption.Volatile)
    asm

fn wfe() -> InlineAsm:
    """Wait for event."""
    var asm = InlineAsm.new(["wfe"], Span.default())
    asm_add_option(asm, AsmOption.Volatile)
    asm

fn sev() -> InlineAsm:
    """Send event."""
    var asm = InlineAsm.new(["sev"], Span.default())
    asm_add_option(asm, AsmOption.Volatile)
    asm

fn nop_arm() -> InlineAsm:
    """No operation."""
    InlineAsm.new(["nop"], Span.default())

fn dmb() -> InlineAsm:
    """Data memory barrier."""
    InlineAsm.new(["dmb"], Span.default())

fn dsb() -> InlineAsm:
    """Data synchronization barrier."""
    InlineAsm.new(["dsb"], Span.default())

fn isb() -> InlineAsm:
    """Instruction synchronization barrier."""
    InlineAsm.new(["isb"], Span.empty())

# ===========================================================================
# Exports
# ===========================================================================

export ArmRegisterAllocator, ArmAsmGenerator
export cpsid, cpsie, wfi, wfe, sev, nop_arm
export dmb, dsb, isb
