# Vulkan Type Mapper - Vulkan/SPIR-V-Specific Type Mapping Implementation
#
# Maps MIR types to SPIR-V type strings/opcodes.
# Implements TypeMapper trait for Vulkan backend.

use compiler.mir_data.*
use compiler.backend.common.type_mapper.*
use compiler.hir_types.MemorySpace

# ============================================================================
# Vulkan Type Mapper
# ============================================================================

class VulkanTypeMapper:
    """
    Maps MIR types to SPIR-V type representations.

    SPIR-V uses typed opcodes:
    - OpTypeInt width signed (e.g., OpTypeInt 32 1)
    - OpTypeFloat width (e.g., OpTypeFloat 32)
    - OpTypeBool
    - OpTypeVoid
    - OpTypePointer storage_class type

    Storage classes for memory:
    - StorageBuffer: Device global memory (SSBO)
    - Workgroup: Shared memory
    - Function: Thread-local
    - Uniform: Uniform buffer
    - PushConstant: Push constants

    Example mappings:
        I32 → "OpTypeInt 32 1"
        F32 → "OpTypeFloat 32"
        Bool → "OpTypeBool"
    """

    vulkan_version: (i64, i64)  # e.g., (1, 3) for Vulkan 1.3
    spirv_version: (i64, i64)   # e.g., (1, 6) for SPIR-V 1.6

    static fn create() -> VulkanTypeMapper:
        """Create mapper for Vulkan 1.3 / SPIR-V 1.6 (default)."""
        VulkanTypeMapper(
            vulkan_version: (1, 3),
            spirv_version: (1, 6)
        )

    static fn create_version(vk_major: i64, vk_minor: i64, spv_major: i64, spv_minor: i64) -> VulkanTypeMapper:
        """Create mapper for specific Vulkan/SPIR-V versions."""
        VulkanTypeMapper(
            vulkan_version: (vk_major, vk_minor),
            spirv_version: (spv_major, spv_minor)
        )

# REMOVED: impl TypeMapper for VulkanTypeMapper:
# (Trait implementations not supported in Core Simple)
    # fn map_primitive(ty: PrimitiveType) -> text:
        # """
        # Map primitive types to SPIR-V type opcodes.

        # SPIR-V type opcodes:
        # - OpTypeInt width signed (1=signed, 0=unsigned)
        # - OpTypeFloat width
        # - OpTypeBool
        # - OpTypeVoid
        # """
        # match ty:
            # case I64: "OpTypeInt 64 1"
            # case I32: "OpTypeInt 32 1"
            # case I16: "OpTypeInt 16 1"
            # case I8: "OpTypeInt 8 1"
            # case U64: "OpTypeInt 64 0"
            # case U32: "OpTypeInt 32 0"
            # case U16: "OpTypeInt 16 0"
            # case U8: "OpTypeInt 8 0"
            # case F64: "OpTypeFloat 64"
            # case F32: "OpTypeFloat 32"
            # case F16: "OpTypeFloat 16"
            # case Bool: "OpTypeBool"
            # case Unit: "OpTypeVoid"

    # fn map_pointer(pointee: text, mutability: Mutability) -> text:
        # """
        # Map pointer types to SPIR-V representation.

        # SPIR-V pointers include storage class:
        # OpTypePointer StorageClass Type
        # """
        # # Default to StorageBuffer for global pointers
        # "OpTypePointer StorageBuffer {pointee}"

    # fn backend_name() -> text:
        # "Vulkan/SPIR-V"

    # fn map_memory_space(space: MemorySpace) -> text:
        # """
        # Map GPU memory space to SPIR-V storage class.

        # SPIR-V storage classes:
        # - StorageBuffer: Device global memory (SSBO)
        # - Workgroup: Shared memory
        # - Function: Thread-local
        # - Uniform: Uniform buffer (read-only)
        # - PushConstant: Push constants
        # """
        # match space:
            # case Global: "StorageBuffer"
            # case Shared: "Workgroup"
            # case Local: "Function"
            # case Constant: "Uniform"
            # case Uniform: "Uniform"

    # fn map_vector_type(elem: text, width: i64) -> text:
        # """
        # Map SIMD/vector type to SPIR-V vector type.

        # SPIR-V: OpTypeVector component_type component_count
        # Valid widths: 2, 3, 4 (8, 16 with extensions)
        # """
        # if width >= 2 and width <= 4:
            # "OpTypeVector {elem} {width}"
        # else:
            # # Fallback to array for non-standard widths
            # "OpTypeArray {elem} {width}"

    # fn supports_half_precision() -> bool:
        # """
        # Check if SPIR-V supports half precision.
        # Requires Float16 capability.
        # """
        # true  # Modern Vulkan/SPIR-V supports f16

    # fn supports_gpu() -> bool:
        # true


# ============================================================================
# VulkanTypeMapper Methods (was: impl VulkanTypeMapper:)
# ============================================================================

# ============================================================================
# SPIR-V Support Types
# ============================================================================

"""SPIR-V image dimensions."""
enum SpirvImageDim:
    Dim1D
    Dim2D
    Dim3D
    DimCube
    DimBuffer

"""SPIR-V builtin variables."""
enum SpirvBuiltin:
    GlobalInvocationId
    LocalInvocationId
    WorkgroupId
    WorkgroupSize
    NumWorkgroups
    SubgroupId
    SubgroupSize
    SubgroupLocalInvocationId

"""SPIR-V features requiring capabilities."""
enum SpirvFeature:
    Float16
    Float64
    Int64
    Int16
    Int8
    StorageBuffer8BitAccess
    StorageBuffer16BitAccess
    Subgroup
    AtomicFloat

# ============================================================================
# Export
# ============================================================================

export VulkanTypeMapper
export SpirvImageDim, SpirvBuiltin, SpirvFeature
