# Environment and Scoping Utilities
#
# Shared environment operations for backend implementations.
# This module provides variable scoping and environment management
# used by the interpreter and other backends.

use compiler.hir.*
use backend_types.*

# ============================================================================
# Environment and Scoping
# ============================================================================

struct EvalContext:
    """Context for expression evaluation."""
    env: Environment
    module: HirModule
    backend: Backend

struct Environment:
    """Variable environment for evaluation."""
    scopes: [Dict<SymbolId, Value>]
    globals: Dict<SymbolId, Value>

fn empty_env_scope() -> Dict<SymbolId, Value>:
    """Create an empty scope dict (typed for bootstrap inference)."""
    var result: Dict<SymbolId, Value> = {}
    result


# ============================================================================
# Environment Methods (was: impl Environment:)
# ============================================================================

fn environment_new() -> Environment:
        Environment(scopes: [empty_env_scope()], globals: empty_env_scope())


fn environment_assign(self: Environment, symbol: SymbolId, value: Value) -> bool:
        # Search from innermost scope
        for i in (self.scopes_len(scopes) - 1)..=0:
            val scope = self.scopes[i]
            if scope_contains_key(scope, symbol):
                scope[symbol] = value
                return true

        # Check globals
        if self.globals_contains_key(globals, symbol):
            self.globals[symbol] = value
            return true

        false


# ============================================================================
# HIR Visitor
# ============================================================================

struct HirVisitor:
    """Visitor that walks HIR and calls backend methods."""
    backend: Backend
    ctx: EvalContext


# ============================================================================
# HirVisitor Methods (was: impl HirVisitor:)
# ============================================================================

fn hirvisitor_new(backend: Backend, module: HirModule) -> HirVisitor:
        HirVisitor(
            backend: backend,
            ctx: EvalContext(
                env: environment_new(),
                module: module,
                backend: backend
            )
        )


# ============================================================================
# Exports
# ============================================================================

export EvalContext, Environment, empty_env_scope, HirVisitor
