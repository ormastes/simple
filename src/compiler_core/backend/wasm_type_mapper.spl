# Wasm Type Mapper - WebAssembly-Specific Type Mapping Implementation
#
# Maps MIR types to WebAssembly type strings.
# Implements TypeMapper trait for Wasm backend.

use compiler.mir_data.*
use compiler.backend.common.type_mapper.*

# ============================================================================
# Wasm Type Mapper
# ============================================================================

class WasmTypeMapper:
    """
    Maps MIR types to WebAssembly type representations.

    WebAssembly has 4 value types:
    - i32 (32-bit integer)
    - i64 (64-bit integer)
    - f32 (32-bit float)
    - f64 (64-bit float)

    Plus reference types (GC proposal):
    - externref (reference to external object)
    - funcref (function reference)

    All composite types (struct, array, tuple) are represented
    as linear memory (i32 offset) or externref.

    Example mappings:
        I64 → "i64"
        F64 → "f64"
        I32 → "i32"
        Bool → "i32"  (0 or 1)
        Ptr(_) → "i32"  (memory offset in Wasm32) or "i64" (Wasm64)
    """

    target_bits: i64  # 32 or 64 for pointer size

    static fn create() -> WasmTypeMapper:
        """Create mapper for default Wasm32."""
        WasmTypeMapper(target_bits: 32)

    static fn create_wasm32() -> WasmTypeMapper:
        """Create mapper for Wasm32 (32-bit pointers)."""
        WasmTypeMapper(target_bits: 32)

    static fn create_wasm64() -> WasmTypeMapper:
        """Create mapper for Wasm64 (64-bit pointers)."""
        WasmTypeMapper(target_bits: 64)

    static fn create_for_target(target: CodegenTarget) -> WasmTypeMapper:
        """Create mapper for specific Wasm target."""
        if target == CodegenTarget.Wasm32:
            wasmtypemapper_create_wasm32()
        elif target == CodegenTarget.Wasm64:
            wasmtypemapper_create_wasm64()
        else:
            error("WasmTypeMapper only supports Wasm32 and Wasm64 targets")

# REMOVED: impl TypeMapper for WasmTypeMapper:
# (Trait implementations not supported in Core Simple)
    # fn map_primitive(ty: PrimitiveType) -> text:
        # """
        # Map primitive types to Wasm value types.

        # Wasm only has 4 types:
        # - i32 (all integers ≤32 bits, bool)
        # - i64 (64-bit integers)
        # - f32 (32-bit floats)
        # - f64 (64-bit floats)
        # """
        # match ty:
            # case I64: "i64"
            # case I32: "i32"
            # case I16: "i32"  # Wasm doesn't have i16, use i32
            # case I8: "i32"   # Wasm doesn't have i8, use i32
            # case F64: "f64"
            # case F32: "f32"
            # case Bool: "i32"  # Boolean as i32 (0 or 1)
            # case Unit: "i32"  # Unit as dummy i32 (0)

    # fn map_pointer(pointee: text, mutability: Mutability) -> text:
        # """
        # Map pointer types to Wasm representation.

        # Wasm pointers are offsets into linear memory:
        # - Wasm32: i32 (0 to 4GB)
        # - Wasm64: i64 (0 to 16EB)

        # Mutability is tracked separately.
        # """
        # if self.target_bits == 32:
            # "i32"  # Wasm32 uses i32 for memory offsets
        # else:
            # "i64"  # Wasm64 uses i64 for memory offsets

    # fn backend_name() -> text:
        # "WebAssembly"


# ============================================================================
# WasmTypeMapper Methods (was: impl WasmTypeMapper:)
# ============================================================================

# ============================================================================
# Export
# ============================================================================

# Export desugared static method names
fn WasmTypeMapper__create() -> WasmTypeMapper:
    wasmtypemapper_create()

fn WasmTypeMapper__create_wasm32() -> WasmTypeMapper:
    wasmtypemapper_create_wasm32()

fn WasmTypeMapper__create_wasm64() -> WasmTypeMapper:
    wasmtypemapper_create_wasm64()

fn WasmTypeMapper__create_for_target(target: CodegenTarget) -> WasmTypeMapper:
    wasmtypemapper_create_for_target(target)

export WasmTypeMapper
export WasmTypeMapper__create, WasmTypeMapper__create_wasm32, WasmTypeMapper__create_wasm64, WasmTypeMapper__create_for_target
