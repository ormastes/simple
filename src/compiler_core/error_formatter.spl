# Rich Error Formatter
#
# Provides Rust-quality error messages with:
# - Multi-line display with source context
# - Helpful suggestions and fix hints
# - Color-coded output
# - "Did you mean?" suggestions
# - Type mismatch explanations

use compiler.lexer.Span
use compiler.type_infer_types.*
use compiler.hir.*
use std.string.{NL}

# ============================================================================
# ANSI Color Codes
# ============================================================================

struct Color:
    """ANSI color codes for terminal output."""
    reset: text
    bold: text
    red: text
    green: text
    yellow: text
    blue: text
    cyan: text
    white: text
    dim: text


# ============================================================================
# Color Methods (was: impl Color:)
# ============================================================================

fn color_new() -> Color:
        Color(
            reset: "\u001b[0m",
            bold: "\u001b[1m",
            red: "\u001b[31m",
            green: "\u001b[32m",
            yellow: "\u001b[33m",
            blue: "\u001b[34m",
            cyan: "\u001b[36m",
            white: "\u001b[37m",
            dim: "\u001b[2m"
        )


fn color_disabled() -> Color:
        """Create a Color instance with no actual colors (for non-TTY output)."""
        Color(
            reset: "",
            bold: "",
            red: "",
            green: "",
            yellow: "",
            blue: "",
            cyan: "",
            white: "",
            dim: ""
        )


# ============================================================================
# Error Severity
# ============================================================================

enum ErrorSeverity:
    Error
    Warning
    Note
    Help


# ============================================================================
# ErrorSeverity Methods (was: impl ErrorSeverity:)
# ============================================================================

# ============================================================================
# Rich Error Formatter
# ============================================================================

class ErrorFormatter:
    """Formats type errors with rich diagnostics."""
    colors: Color
    use_colors: bool
    source_map: Dict<text, text>  # file_path -> source_code


# ============================================================================
# ErrorFormatter Methods (was: impl ErrorFormatter:)
# ============================================================================

fn errorformatter_new(use_colors: bool) -> ErrorFormatter:
        ErrorFormatter(
            colors: if use_colors: color_new() else: color_disabled(),
            use_colors: use_colors,
            source_map: {}
        )


# ============================================================================
# String Similarity Utilities (Phase 1B[3] - TODO #84 âœ…)
# ============================================================================

fn levenshtein_distance(s1: text, s2: text) -> i64:
    """Calculate Levenshtein distance between two strings.

    Returns the minimum number of single-character edits required.
    """
    val len1 = s1_len(s1)
    val len2 = s2_len(s2)

    if len1 == 0:
        return len2
    if len2 == 0:
        return len1

    # Create distance matrix
    var prev_row = []
    var curr_row = []
    for j in 0..=len2:
        prev_row_push(prev_row, j)
        curr_row_push(curr_row, 0)

    # Fill matrix row by row
    for i in 1..=len1:
        curr_row[0] = i

        for j in 1..=len2:
            val cost = if s1[i - 1] == s2[j - 1]: 0 else: 1

            val deletion = prev_row[j] + 1
            val insertion = curr_row[j - 1] + 1
            val substitution = prev_row[j - 1] + cost

            curr_row[j] = min3(deletion, insertion, substitution)

        # Swap rows
        prev_row = curr_row
        curr_row = []
        for j in 0..=len2:
            curr_row_push(curr_row, 0)

    prev_row[len2]

fn min3(a: i64, b: i64, c: i64) -> i64:
    """Return minimum of three values."""
    if a <= b:
        if a <= c:
        a
    else:
        if b <= c: b else: c

fn find_similar_names(target: text, candidates: [text]) -> [text]:
    """Find similar names using Levenshtein distance.

    Returns up to 3 closest matches with distance <= 3.
    """
    var matches = []

    for candidate in candidates:
        val distance = levenshtein_distance(target, candidate)
        if distance <= 3:
            if distance > 0:
            matches_push(matches, (candidate, distance))

    # Simple sort by distance (bubble sort for simplicity)
    for i in 0..(matches_len(matches)):
        for j in 0..(matches_len(matches) - i - 1):
            val match_j = matches[j]
            val match_j_plus_1 = matches[j + 1]
            val score_j = match_j.1
            val score_j_plus_1 = match_j_plus_1.1
            if score_j > score_j_plus_1:
                val temp = matches[j]
                matches[j] = matches[j + 1]
                matches[j + 1] = temp

    # Return top 3
    var results = []
    var count = 0
    for match in matches:
        if count >= 3:
            break
        val match_name = match.0
        results_push(results, match_name)
        count = count + 1

    results

# ============================================================================
# Public API
# ============================================================================

fn format_type_error(error: TypeInferError, use_colors: bool) -> text:
    """Format a type error with rich diagnostics.

    This is the main entry point for error formatting.
    """
    val formatter = errorformatter_new(use_colors)
    formatter_format_error(formatter, error)

fn format_type_errors(errors: [TypeInferError], use_colors: bool) -> text:
    """Format multiple type errors."""
    var output = ""

    var i = 0
    for error in errors:
        if i > 0:
            output = output + NL
        output = output + format_type_error(error, use_colors)
        i = i + 1

    output

# ============================================================================
# Exports
# ============================================================================

export ErrorFormatter, ErrorSeverity
export format_type_error, format_type_errors
