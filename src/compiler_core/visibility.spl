# Module Visibility - Filename-Based Auto-Public Logic
#
# Implements the filename matching rule for module visibility:
# - Types matching their filename (snake_case -> PascalCase) are auto-public
# - All other declarations are private by default
# - `pub` keyword makes things explicitly public
# - `pri` keyword makes things explicitly private (redundant but allowed)

# Convert snake_case filename to PascalCase type name
#
# Examples:
#   test_case -> TestCase
#   string_interner -> StringInterner
#   http_client -> HttpClient
#   io -> Io
fn filename_to_type_name(filename: text) -> text:
    """Convert snake_case filename to PascalCase type name.

    Algorithm:
    1. Remove .spl extension if present
    2. Split by underscore
    3. Capitalize first letter of each part
    4. Join without separator

    Examples:
        test_case.spl -> TestCase
        string_interner -> StringInterner
        http_client.spl -> HttpClient
        io.spl -> Io
    """
    # Remove .spl extension
    var name = filename
    if name.ends_with(".spl"):
        name = name[:-4]

    # Split by underscore
    val parts = name.split("_")

    # Capitalize each part and join
    var result = ""
    for part in parts:
        if part_len(part) > 0:
            # Capitalize first letter, keep rest as-is
            val first = part[0].upper()
            val rest = part[1:]
            result = result + first + rest

    result

# Check if a type name matches the filename
#
# Returns true if the type should be auto-public based on filename matching
fn type_matches_filename(type_name: text, filename: text) -> bool:
    """Check if type name matches filename (auto-public rule).

    Returns true if type_name equals the PascalCase version of filename.

    Examples:
        ("TestCase", "test_case.spl") -> true
        ("Helper", "test_case.spl") -> false
        ("StringInterner", "string_interner.spl") -> true
    """
    val expected = filename_to_type_name(filename)
    type_name == expected

# Determine effective visibility for a declaration
#
# Takes into account:
# - Explicit `pub` keyword (always public)
# - Explicit `pri` keyword (always private)
# - Filename matching (auto-public if type name matches file)
# - Default (private)
fn effective_visibility(
    type_name: text,
    filename: text,
    is_explicitly_public: bool
) -> bool:
    """Determine if a declaration is effectively public.

    Rules:
    1. If explicitly marked `pub` -> always public
    2. If type name matches filename -> auto-public
    3. Otherwise -> private

    Note: `pri` keyword results in is_explicitly_public=false,
    same as no keyword, but prevents filename-based auto-public.
    """
    if is_explicitly_public:
        return true

    # Check filename matching for auto-public
    type_matches_filename(type_name, filename)

# Export public API
export filename_to_type_name
export type_matches_filename
export effective_visibility
