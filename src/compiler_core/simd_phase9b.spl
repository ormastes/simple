"""
SIMD Complete - Phase 9B: SIMD Operations

Implements arithmetic operations and SIMD intrinsics for vector types.

Status: Phase 9B In Progress
"""

# Import Vec4f from Phase 9A
struct Vec4f:
    x: f32
    y: f32
    z: f32
    w: f32


# ============================================================================
# Vec4f Methods (was: impl Vec4f:)
# ============================================================================

fn vec4f_splat(value: f32) -> Vec4f:
        Vec4f(x: value, y: value, z: value, w: value)


fn vec4f_from_array(arr: [f32]) -> Vec4f:
        Vec4f(x: arr[0], y: arr[1], z: arr[2], w: arr[3])


fn vec4f_zero() -> Vec4f:
        Vec4f(x: 0.0, y: 0.0, z: 0.0, w: 0.0)


# ============================================================================
# Tests
# ============================================================================

fn test_vec4f_add():
    """Test vector addition"""
    val v1 = Vec4f(x: 1.0, y: 2.0, z: 3.0, w: 4.0)
    val v2 = Vec4f(x: 5.0, y: 6.0, z: 7.0, w: 8.0)

    val result = v1_add(v1, v2)

    assert result.x == 6.0, "x is 6.0"
    assert result.y == 8.0, "y is 8.0"
    assert result.z == 10.0, "z is 10.0"
    assert result.w == 12.0, "w is 12.0"

    print "âœ… Vector addition"

fn test_vec4f_sub():
    """Test vector subtraction"""
    val v1 = Vec4f(x: 10.0, y: 20.0, z: 30.0, w: 40.0)
    val v2 = Vec4f(x: 1.0, y: 2.0, z: 3.0, w: 4.0)

    val result = v1_sub(v1, v2)

    assert result.x == 9.0, "x is 9.0"
    assert result.y == 18.0, "y is 18.0"
    assert result.z == 27.0, "z is 27.0"
    assert result.w == 36.0, "w is 36.0"

    print "âœ… Vector subtraction"

fn test_vec4f_mul():
    """Test element-wise multiplication"""
    val v1 = Vec4f(x: 2.0, y: 3.0, z: 4.0, w: 5.0)
    val v2 = Vec4f(x: 10.0, y: 10.0, z: 10.0, w: 10.0)

    val result = v1_mul(v1, v2)

    assert result.x == 20.0, "x is 20.0"
    assert result.y == 30.0, "y is 30.0"
    assert result.z == 40.0, "z is 40.0"
    assert result.w == 50.0, "w is 50.0"

    print "âœ… Element-wise multiplication"

fn test_vec4f_div():
    """Test element-wise division"""
    val v1 = Vec4f(x: 20.0, y: 30.0, z: 40.0, w: 50.0)
    val v2 = Vec4f(x: 10.0, y: 10.0, z: 10.0, w: 10.0)

    val result = v1_div(v1, v2)

    assert result.x == 2.0, "x is 2.0"
    assert result.y == 3.0, "y is 3.0"
    assert result.z == 4.0, "z is 4.0"
    assert result.w == 5.0, "w is 5.0"

    print "âœ… Element-wise division"

fn test_vec4f_scale():
    """Test scalar multiplication"""
    val v = Vec4f(x: 1.0, y: 2.0, z: 3.0, w: 4.0)

    val result = v_scale(v, 2.0)

    assert result.x == 2.0, "x is 2.0"
    assert result.y == 4.0, "y is 4.0"
    assert result.z == 6.0, "z is 6.0"
    assert result.w == 8.0, "w is 8.0"

    print "âœ… Scalar multiplication"

fn test_vec4f_sum():
    """Test sum reduction"""
    val v = Vec4f(x: 1.0, y: 2.0, z: 3.0, w: 4.0)

    val result = v_sum(v)

    assert result == 10.0, "Sum is 10.0"

    print "âœ… Sum reduction"

fn test_vec4f_dot():
    """Test dot product"""
    val v1 = Vec4f(x: 1.0, y: 2.0, z: 3.0, w: 4.0)
    val v2 = Vec4f(x: 5.0, y: 6.0, z: 7.0, w: 8.0)

    val result = v1_dot(v1, v2)

    # 1*5 + 2*6 + 3*7 + 4*8 = 5 + 12 + 21 + 32 = 70
    assert result == 70.0, "Dot product is 70.0"

    print "âœ… Dot product"

fn test_vec4f_length():
    """Test length calculation"""
    val v = Vec4f(x: 3.0, y: 4.0, z: 0.0, w: 0.0)

    val len_sq = v_length_squared(v)
    val len = v_length(v)

    assert len_sq == 25.0, "Squared length is 25.0"
    assert len == 5.0, "Length is 5.0"

    print "âœ… Length calculation"

fn test_vec4f_normalize():
    """Test normalization"""
    val v = Vec4f(x: 3.0, y: 4.0, z: 0.0, w: 0.0)

    val norm = v_normalize(v)
    val len = norm_length(norm)

    # Normalized vector should have length 1.0
    val diff = if len > 1.0: len - 1.0 else: 1.0 - len
    assert diff < 0.001, "Normalized length is ~1.0"

    print "âœ… Normalization"

fn test_vec4f_distance():
    """Test distance calculation"""
    val v1 = Vec4f(x: 0.0, y: 0.0, z: 0.0, w: 0.0)
    val v2 = Vec4f(x: 3.0, y: 4.0, z: 0.0, w: 0.0)

    val dist = v1_distance(v1, v2)

    assert dist == 5.0, "Distance is 5.0"

    print "âœ… Distance calculation"

fn test_vec4f_equals():
    """Test exact equality"""
    val v1 = Vec4f(x: 1.0, y: 2.0, z: 3.0, w: 4.0)
    val v2 = Vec4f(x: 1.0, y: 2.0, z: 3.0, w: 4.0)
    val v3 = Vec4f(x: 1.0, y: 2.0, z: 3.0, w: 5.0)

    assert v1.equals(v2), "Equal vectors"
    assert not v1.equals(v3), "Not equal vectors"

    print "âœ… Exact equality"

fn test_vec4f_less_than():
    """Test element-wise less than"""
    val v1 = Vec4f(x: 1.0, y: 2.0, z: 3.0, w: 4.0)
    val v2 = Vec4f(x: 2.0, y: 3.0, z: 2.0, w: 5.0)

    val result = v1_less_than(v1, v2)

    assert result[0], "x: 1 < 2"
    assert result[1], "y: 2 < 3"
    assert not result[2], "z: 3 not < 2"
    assert result[3], "w: 4 < 5"

    print "âœ… Element-wise less than"

fn test_vec4f_min():
    """Test element-wise minimum"""
    val v1 = Vec4f(x: 1.0, y: 5.0, z: 3.0, w: 8.0)
    val v2 = Vec4f(x: 2.0, y: 4.0, z: 6.0, w: 7.0)

    val result = v1_min(v1, v2)

    assert result.x == 1.0, "min(1, 2) = 1"
    assert result.y == 4.0, "min(5, 4) = 4"
    assert result.z == 3.0, "min(3, 6) = 3"
    assert result.w == 7.0, "min(8, 7) = 7"

    print "âœ… Element-wise minimum"

fn test_vec4f_max():
    """Test element-wise maximum"""
    val v1 = Vec4f(x: 1.0, y: 5.0, z: 3.0, w: 8.0)
    val v2 = Vec4f(x: 2.0, y: 4.0, z: 6.0, w: 7.0)

    val result = v1_max(v1, v2)

    assert result.x == 2.0, "max(1, 2) = 2"
    assert result.y == 5.0, "max(5, 4) = 5"
    assert result.z == 6.0, "max(3, 6) = 6"
    assert result.w == 8.0, "max(8, 7) = 8"

    print "âœ… Element-wise maximum"

fn test_vec4f_abs():
    """Test absolute value"""
    val v = Vec4f(x: -1.0, y: 2.0, z: -3.0, w: 4.0)

    val result = v_abs(v)

    assert result.x == 1.0, "abs(-1) = 1"
    assert result.y == 2.0, "abs(2) = 2"
    assert result.z == 3.0, "abs(-3) = 3"
    assert result.w == 4.0, "abs(4) = 4"

    print "âœ… Absolute value"

fn test_vec4f_negate():
    """Test negation"""
    val v = Vec4f(x: 1.0, y: -2.0, z: 3.0, w: -4.0)

    val result = v_negate(v)

    assert result.x == -1.0, "-1 = -1"
    assert result.y == 2.0, "-(-2) = 2"
    assert result.z == -3.0, "-3 = -3"
    assert result.w == 4.0, "-(-4) = 4"

    print "âœ… Negation"

fn test_vec4f_min_element():
    """Test minimum element"""
    val v = Vec4f(x: 5.0, y: 2.0, z: 8.0, w: 3.0)

    val min_val = v_min_element(v)

    assert min_val == 2.0, "Minimum element is 2.0"

    print "âœ… Minimum element"

fn test_vec4f_max_element():
    """Test maximum element"""
    val v = Vec4f(x: 5.0, y: 2.0, z: 8.0, w: 3.0)

    val max_val = v_max_element(v)

    assert max_val == 8.0, "Maximum element is 8.0"

    print "âœ… Maximum element"

fn main():
    print ""
    print "SIMD Phase 9B Tests"
    print "==================="

    test_vec4f_add()
    test_vec4f_sub()
    test_vec4f_mul()
    test_vec4f_div()
    test_vec4f_scale()
    test_vec4f_sum()
    test_vec4f_dot()
    test_vec4f_length()
    test_vec4f_normalize()
    test_vec4f_distance()
    test_vec4f_equals()
    test_vec4f_less_than()
    test_vec4f_min()
    test_vec4f_max()
    test_vec4f_abs()
    test_vec4f_negate()
    test_vec4f_min_element()
    test_vec4f_max_element()

    print ""
    print "ðŸŽ‰ Phase 9B Complete!"
    print ""
    print "Implemented:"
    print "  âœ… Arithmetic - add, sub, mul, div"
    print "  âœ… Scalar ops - scale, scale_add"
    print "  âœ… Reductions - sum, product, min/max element"
    print "  âœ… Dot product and length"
    print "  âœ… Distance and normalize"
    print "  âœ… Comparisons - equals, less_than"
    print "  âœ… Min/Max - element-wise min/max, clamp"
    print "  âœ… Utility - abs, negate, reciprocal"
    print ""
    print "Progress: 2.5/4 hours (63% of Phase 9)"
    print "Next: Phase 9C - Platform Detection (1.5h)"
