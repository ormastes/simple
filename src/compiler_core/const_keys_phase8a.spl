"""
Const Keys - Phase 8A: Key Extraction

Implements key extraction from string templates.

Status: Phase 8A In Progress
"""

type Symbol = text

# ============================================================================
# Key Extractor
# ============================================================================

class KeyExtractor:
    """
    Extracts keys from string template

    Examples:
        "Hello {name}" â†’ ["name"]
        "{x} + {y} = {sum}" â†’ ["x", "y", "sum"]
        "No keys" â†’ []
    """


# ============================================================================
# KeyExtractor Methods (was: impl KeyExtractor:)
# ============================================================================

fn keyextractor_has_keys(tmpl: text) -> bool:
        """Check if template has any keys"""
        val keys = keyextractor_extract_keys(tmpl)
        keys_len(keys) > 0


fn keyextractor_key_count(tmpl: text) -> i64:
        """Count number of keys"""
        val keys = keyextractor_extract_keys(tmpl)
        keys_len(keys)


# ============================================================================
# Const Key Set
# ============================================================================

class ConstKeySet:
    """
    Set of compile-time known keys

    Examples:
        ConstKeySet(["name", "age"])
        ConstKeySet([])  # No keys
    """
    keys: [Symbol]


# ============================================================================
# ConstKeySet Methods (was: impl ConstKeySet:)
# ============================================================================

fn constkeyset_from_template(tmpl: text) -> ConstKeySet:
        """Create ConstKeySet from template string"""
        val keys = keyextractor_extract_keys(tmpl)
        ConstKeySet(keys: keys)


fn constkeyset_from_keys(keys: [Symbol]) -> ConstKeySet:
        """Create ConstKeySet from key list"""
        ConstKeySet(keys: keys)


fn constkeyset_empty() -> ConstKeySet:
        """Create empty ConstKeySet (no keys)"""
        ConstKeySet(keys: [])


# ============================================================================
# Tests
# ============================================================================

fn test_extract_single_key():
    """Test extracting single key"""
    val tmpl = "Hello {name}"
    val keys = keyextractor_extract_keys(tmpl)

    # TODO: assert keys.len() == 1, "One key")
    assert keys[0] == "name"  # Key is 'name'

    print "âœ… Extract single key"

fn test_extract_multiple_keys():
    """Test extracting multiple keys"""
    val tmpl = "User {name} has {points} points"
    val keys = keyextractor_extract_keys(tmpl)

    # TODO: assert keys.len() == 2, "Two keys")
    assert keys[0] == "name"  # First key is 'name'
    assert keys[1] == "points"  # Second key is 'points'

    print "âœ… Extract multiple keys"

fn test_extract_no_keys():
    """Test extracting from plain string (no keys)"""
    val tmpl = "Hello world"
    val keys = keyextractor_extract_keys(tmpl)

    # TODO: assert keys.len() == 0, "No keys")

    print "âœ… Extract no keys"

fn test_extract_duplicate_keys():
    """Test extracting duplicate keys"""
    val tmpl = "{x} + {x} = {sum}"
    val keys = keyextractor_extract_keys(tmpl)

    # TODO: assert keys.len() == 3, "Three keys (including duplicate)")
    assert keys[0] == "x"  # First x
    assert keys[1] == "x"  # Second x (duplicate)
    assert keys[2] == "sum"  # sum

    print "âœ… Extract duplicate keys"

fn test_has_keys():
    """Test has_keys predicate"""
    val tmpl1 = "Hello {name}"
    val tmpl2 = "Hello world"

    # TODO: assert KeyExtractor.has_keys(tmpl1), "Has keys")
    # TODO: assert not KeyExtractor.has_keys(tmpl2), "No keys")

    print "âœ… Has keys predicate"

fn test_unique_keys():
    """Test unique key extraction"""
    val tmpl = "{x} + {x} = {sum}"
    val unique = keyextractor_unique_keys(tmpl)

    # TODO: assert unique.len() == 2, "Two unique keys")
    assert unique[0] == "x"  # x
    assert unique[1] == "sum"  # sum

    print "âœ… Unique keys"

fn test_key_count():
    """Test key counting"""
    val tmpl1 = "Hello {name}"
    val tmpl2 = "{x} + {y} = {sum}"
    val tmpl3 = "No keys"

    # TODO: assert KeyExtractor.key_count(tmpl1) == 1, "One key")
    # TODO: assert KeyExtractor.key_count(tmpl2) == 3, "Three keys")
    # TODO: assert KeyExtractor.key_count(tmpl3) == 0, "No keys")

    print "âœ… Key count"

fn test_const_key_set_from_template():
    """Test creating ConstKeySet from template"""
    val tmpl = "Hello {name}, you are {age} years old"
    val key_set = constkeyset_from_template(tmpl)

    # TODO: assert key_set.key_count() == 2, "Two keys")
    # TODO: assert key_set.has_key("name"), "Has name")
    # TODO: assert key_set.has_key("age"), "Has age")

    print "âœ… ConstKeySet from template"

fn test_const_key_set_empty():
    """Test empty ConstKeySet"""
    val key_set = constkeyset_empty()

    # TODO: assert key_set.is_empty(), "Is empty")
    # TODO: assert key_set.key_count() == 0, "Zero keys")

    print "âœ… Empty ConstKeySet"

fn test_const_key_set_has_key():
    """Test has_key method"""
    val key_set = ConstKeySet.from_keys(["name", "age"])

    # TODO: assert key_set.has_key("name"), "Has name")
    # TODO: assert key_set.has_key("age"), "Has age")
    # TODO: assert not key_set.has_key("unknown"), "Doesn't have unknown")

    print "âœ… ConstKeySet has_key"

fn test_const_key_set_missing_keys():
    """Test finding missing keys"""
    val key_set = ConstKeySet.from_keys(["name", "age", "email"])
    val provided = ["name", "age"]

    val missing = key_set_missing_keys(key_set, provided)

    # TODO: assert missing.len() == 1, "One missing key")
    assert missing[0] == "email"  # Missing email

    print "âœ… ConstKeySet missing keys"

fn test_const_key_set_extra_keys():
    """Test finding extra keys"""
    val key_set = ConstKeySet.from_keys(["name", "age"])
    val provided = ["name", "age", "unknown", "extra"]

    val extra = key_set_extra_keys(key_set, provided)

    # TODO: assert extra.len() == 2, "Two extra keys")
    assert extra[0] == "unknown"  # Extra: unknown
    assert extra[1] == "extra"  # Extra: extra

    print "âœ… ConstKeySet extra keys"

fn test_const_key_set_perfect_match():
    """Test perfect match (no missing, no extra)"""
    val key_set = ConstKeySet.from_keys(["name", "age"])
    val provided = ["name", "age"]

    val missing = key_set_missing_keys(key_set, provided)
    val extra = key_set_extra_keys(key_set, provided)

    # TODO: assert missing.len() == 0, "No missing")
    # TODO: assert extra.len() == 0, "No extra")

    print "âœ… Perfect key match"

fn main():
    print ""
    print "Const Keys Phase 8A Tests"
    print "========================="

    test_extract_single_key()
    test_extract_multiple_keys()
    test_extract_no_keys()
    test_extract_duplicate_keys()
    test_has_keys()
    test_unique_keys()
    test_key_count()
    test_const_key_set_from_template()
    test_const_key_set_empty()
    test_const_key_set_has_key()
    test_const_key_set_missing_keys()
    test_const_key_set_extra_keys()
    test_const_key_set_perfect_match()

    print ""
    print "ðŸŽ‰ Phase 8A Complete!"
    print ""
    print "Implemented:"
    print "  âœ… KeyExtractor - extract keys from templates"
    print "  âœ… extract_keys() - core extraction algorithm"
    print "  âœ… has_keys() - predicate for key presence"
    print "  âœ… unique_keys() - deduplicate keys"
    print "  âœ… key_count() - count keys"
    print "  âœ… ConstKeySet - compile-time key set"
    print "  âœ… missing_keys() - find missing keys"
    print "  âœ… extra_keys() - find extra keys"
    print ""
    print "Progress: 2/6 hours (33% of Phase 8)"
    print "Next: Phase 8B - ConstKeySet Type (2h)"
