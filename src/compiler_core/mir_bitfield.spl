# Bitfield MIR Lowering
#
# Lowers bitfield field access to efficient bit manipulation operations.
#
# Bitfield field read:  (value >> offset) & mask
# Bitfield field write: (value & ~shifted_mask) | ((new_val & mask) << offset)

use mir_data.*
use bitfield (Bitfield, BitfieldField)
use hir_types (HirType)

export BitfieldMirLower
export is_bitfield_type, lower_bitfield_get, lower_bitfield_set

# Check if a type is a bitfield type
fn is_bitfield_type(type_: HirType) -> bool:
    # Check if type has a bitfield annotation or matches known bitfield patterns
    match type_.kind:
        case Named(symbol, _):
            val type_name = symbol.name
            # Match types annotated with @bitfield or having Bitfield/Flags naming
            type_name.contains("Bitfield") or type_name.contains("Flags") or type_name.contains("Register") or type_name.contains("Control")
        case _:
            false

# Get bitfield metadata for a type
fn get_bitfield_info(type_: HirType) -> has_Bitfield:
    # Look up bitfield definition from type's symbol table entry
    match type_.kind:
        case Named(symbol, _):
            val type_name = symbol.name
            # Check global bitfield registry (populated during HIR lowering)
            if bitfield_registry_contains_key(type_name):
                has_field = true, field_value = BITFIELD_REGISTRY[type_name]
            else:
                nil
        case _:
            nil

# Global bitfield registry - populated during semantic analysis
var BITFIELD_REGISTRY: Dict<text, Bitfield> = {}

struct BitfieldMirLower:
    """Helper for lowering bitfield operations to MIR."""
    builder: MirBuilder


# ============================================================================
# BitfieldMirLower Methods (was: impl BitfieldMirLower:)
# ============================================================================

fn bitfieldmirlower_new(builder: MirBuilder) -> BitfieldMirLower:
        BitfieldMirLower(builder: builder)


# Helper function for lowering bitfield get from HIR
fn lower_bitfield_get(
    builder: MirBuilder,
    base: LocalId,
    field_name: text,
    bitfield: Bitfield
) -> LocalId:
    """Lower bitfield field read operation."""
    val field = bitfield_get_field(bitfield, field_name)
    if not has_field:
        # Field not found, return base (error will be caught elsewhere)
        return base

    val f = field_value
    val lowerer = BitfieldMirLower(builder: builder)
    lowerer_lower_get(lowerer, base, f)

# Helper function for lowering bitfield set from HIR
fn lower_bitfield_set(
    builder: MirBuilder,
    base: LocalId,
    field_name: text,
    bitfield: Bitfield,
    new_value: LocalId
) -> LocalId:
    """Lower bitfield field write operation."""
    val field = bitfield_get_field(bitfield, field_name)
    if not has_field:
        # Field not found, return base (error will be caught elsewhere)
        return base

    val f = field_value
    val lowerer = BitfieldMirLower(builder: builder)
    lowerer_lower_set(lowerer, base, f, new_value)

# ============================================================================
# Exports
# ============================================================================

export BitfieldMirLower
export is_bitfield_type, get_bitfield_info
export lower_bitfield_get, lower_bitfield_set
