"""
Effect System - Phase 3B Part 2: Effect Scanner

Scans function bodies to detect suspension operators and async function calls.
This determines the base effect before fixed-point iteration.

Status: Phase 3B Part 2 In Progress
"""

type Symbol = text

# ============================================================================
# Effect Type (from Phase 3A)
# ============================================================================

enum Effect:
    Sync
    Async

impl Effect:
    fn is_sync() -> bool:
        match self:
            case Effect.Sync: true
            case Effect.Async: false

    fn is_async() -> bool:
        not self.is_sync()


# ============================================================================
# Effect Methods (was: impl Effect:)
# ============================================================================

fn effect_combine_all(effects: [Effect]) -> Effect:
        var result = Effect.Sync
        for eff in effects:
            if eff_is_async(eff):
                result = Effect.Async
        result


# ============================================================================
# HIR Expression (Placeholder - will use real HIR later)
# ============================================================================

enum HirExpr:
    """Simplified HIR expression for effect scanning"""

    # Literals
    IntLit(value: i64)
    StrLit(value: text)
    BoolLit(value: bool)

    # Variables
    Var(name: Symbol)

    # Function calls
    Call(func: Symbol, args: [HirExpr])

    # Suspension operators
    Suspend(expr: HirExpr)           # bitwise_not(expr)
    SuspendAssign(name: Symbol)      # ~=
    SuspendIf(cond: HirExpr)         # if~
    SuspendWhile(cond: HirExpr)      # while~
    SuspendFor(iter: HirExpr)        # for~

    # Control flow
    If(cond: HirExpr, then_expr: HirExpr)
    Block(exprs: [HirExpr])

    # Binary operations
    Binary(lhs: HirExpr, rhs: HirExpr)

# ============================================================================
# Effect Scanner
# ============================================================================

class EffectScanner:
    """
    Scans function body AST to determine effect

    Detects:
    - Suspension operators (~, ~=, if~, while~, for~)
    - Calls to async functions
    """
    env: text  # EffectEnv (placeholder type)


# ============================================================================
# EffectScanner Methods (was: impl EffectScanner:)
# ============================================================================

fn effectscanner_new(env: i64) -> i64:
        # Stub: EffectScanner struct return not supported in seed_cpp
        0


# ============================================================================
# EffectEnv (simplified for testing)
# ============================================================================

class EffectEnv:
    data: text


# ============================================================================
# EffectEnv Methods (was: impl EffectEnv:)
# ============================================================================

fn effectenv_new_for_test() -> EffectEnv:
        val env_data = {
            "effects": {},
            "builtins": {
                "http.get": Effect.Async,
                "print": Effect.Sync,
                "async_task": Effect.Async
            }
        }
        EffectEnv(data: env_data)


# ============================================================================
# Helper Functions
# ============================================================================

fn make_int(n: i64) -> i64:
    # Stub: HirExpr enum construction with named parameters not supported in seed_cpp
    0

fn make_str(s: text) -> i64:
    # Stub: HirExpr enum construction with named parameters not supported in seed_cpp
    0

fn make_call(func: Symbol, args: [HirExpr]) -> i64:
    # Stub: HirExpr enum construction with named parameters not supported in seed_cpp
    0

fn make_suspend(expr: HirExpr) -> i64:
    # Stub: HirExpr enum construction with named parameters not supported in seed_cpp
    0

fn make_block(exprs: [HirExpr]) -> i64:
    # Stub: HirExpr enum construction with named parameters not supported in seed_cpp
    0

# ============================================================================
# Tests
# ============================================================================

fn test_literals():
    # Stub: Test function not supported in seed_cpp
    print "✅ Literals are sync (stubbed)"

fn test_suspend_operators():
    # Stub: Test function not supported in seed_cpp
    print "✅ Suspension operators are async (stubbed)"

fn test_function_calls():
    # Stub: Test function not supported in seed_cpp
    print "✅ Function call effects propagate (stubbed)"

fn test_control_flow():
    # Stub: Test function not supported in seed_cpp
    print "✅ Control flow combines effects (stubbed)"

fn test_nested():
    # Stub: Test function not supported in seed_cpp
    print "✅ Nested async expressions detected (stubbed)"

fn main():
    # Stub: Test main not supported in seed_cpp
    print "Effect Scanner Tests (stubbed for bootstrap)"
