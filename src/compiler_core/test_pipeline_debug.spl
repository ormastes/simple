use compiler.test_common.*
use compiler.hir_lowering.*
use compiler.mir_lowering.*
use compiler.mir_data.*
use compiler.backend.native.mod.{compile_native}
use core.backend_types.{CodegenTarget}
use std.string.{NL}

val source = "fn main() -> i64:{NL}    0{NL}"
var parser = parser_new(source)
val ast_module = parser_parse(parser)
var hir_lowering = hirlowering_new()
val hir_module = hir_lowering_lower_module(hir_lowering, ast_module)
var mir_ctx = mirlowering_new(hir_lowering.symbols)
val mir_module = mir_ctx_lower_module(mir_ctx, hir_module)

print "MIR module name: '{mir_module.name}'"
print "MIR functions: {mir_module.functions.keys()}"
for fn_name in mir_module.functions_keys(functions):
    val fn_ = mir_module.functions[fn_name]
    print "  Function: {fn_.name}"
    print "    Blocks: {fn_.blocks.len()}"
    print "    Locals: {fn_.locals.len()}"
    for blk in fn_.blocks:
        print "    Block {blk.id.id}: {blk.instructions.len()} insts, term={blk.terminator}"

print "Calling compile_native..."
val elf_bytes = compile_native(mir_module, CodegenTarget.X86_64)
print "ELF: {elf_bytes.len()} bytes"
