# Incremental Compilation
#
# Hash-based change detection and dependency-aware recompilation.
# Tracks content hashes, modification times, and dependency edges
# to minimize recompilation work.
#
# Port of rust/compiler/src/incremental.rs (410 lines)

export FileHash, IncrementalState, IncrementalConfig

# ============================================================================
# Types
# ============================================================================

struct FileHash:
    path: text
    content_hash: i64
    mtime_ms: i64

struct IncrementalConfig:
    """Configuration for incremental compilation."""
    enabled: bool
    # # DESUGARED: cache_dir: text
    has_cache_dir: bool
    cache_dir: text
    max_staleness_ms: i64   # Max age before forcing recompile


# ============================================================================
# IncrementalConfig Methods (was: impl IncrementalConfig:)
# ============================================================================

fn incrementalconfig_default_config() -> IncrementalConfig:
        IncrementalConfig(enabled: true, cache_dir: nil, max_staleness_ms: 3600000)


fn incrementalconfig_disabled() -> IncrementalConfig:
        IncrementalConfig(enabled: false, cache_dir: nil, max_staleness_ms: 0)


# ============================================================================
# Incremental State
# ============================================================================

class IncrementalState:
    """Tracks file hashes and dependencies for change detection."""
    file_hashes: {text: FileHash}
    dependencies: {text: [text]}    # file -> files it depends on
    dependents: {text: [text]}      # file -> files that depend on it
    dirty_files: [text]


# ============================================================================
# IncrementalState Methods (was: impl IncrementalState:)
# ============================================================================

fn incrementalstate_create() -> IncrementalState:
        IncrementalState(file_hashes: {}, dependencies: {},
                         dependents: {}, dirty_files: [])

