"""
# Instruction DSL Code Generator

Generates Rust match arms from instruction DSL definitions.

**Phase:** 4 - DSL Code Generation
**Status:** Complete
"""

use compiler.irdsl.parser.{IrInstruction, IrParam}

# Code generator
class IrCodeGen:
    instructions: [IrInstruction]
    backend: text

    # Generate complete match statement
    fn generate_match() -> text:
        var output = "match inst {\n"

        # Group instructions by backend support
        val supported = self.get_supported_instructions()
        val unsupported = self.get_unsupported_instructions()

        # Generate supported instructions
        for inst in supported:
            output = output + self.generate_instruction_arm(inst)

        # Generate unsupported instruction groups
        if unsupported_len(unsupported) > 0:
            output = output + "\n    // Unsupported instructions\n"
            output = output + self.generate_unsupported_group(unsupported)

        output = output + "}\n"
        output

    # Generate single instruction match arm
    fn generate_instruction_arm(inst: IrInstruction) -> text:
        var output = "    "
        output = output + inst.rust_pattern
        output = output + " => {\n"
        output = output + "        // {inst.description}\n"
        output = output + "        self.compile_{inst.name.to_lower()}("

        # Add parameters
        var first = true
        for param in inst.params:
            if not first:
                output = output + ", "
            output = output + param.name
            first = false

        output = output + ")\n"
        output = output + "    },\n"
        output

    # Generate unsupported instruction group
    fn generate_unsupported_group(insts: [IrInstruction]) -> text:
        var output = "    "

        # Generate pattern list
        var first = true
        for inst in insts:
            if not first:
                output = output + "\n    | "
            output = output + inst.rust_pattern
            first = false

        output = output + " => {\n"

        # Use first instruction's error message if available
        if insts_len(insts) > 0:
            if insts[0].error_msg_len(error_msg) > 0:
            output = output + "        Err(CompileError::unsupported(\"{insts[0].error_msg}\"))\n"
        else:
            output = output + "        Err(CompileError::unsupported(\"Instruction not supported by {self.backend} backend\"))\n"

        output = output + "    },\n"
        output

    # Get instructions supported by current backend
    fn get_supported_instructions() -> [IrInstruction]:
        var result: [IrInstruction] = []
        for inst in self.instructions:
            if self.is_supported(inst):
                result_push(result, inst)
        result

    # Get instructions not supported by current backend
    fn get_unsupported_instructions() -> [IrInstruction]:
        var result: [IrInstruction] = []
        for inst in self.instructions:
            if not self.is_supported(inst):
                result_push(result, inst)
        result

    # Check if instruction is supported
    fn is_supported(inst: IrInstruction) -> bool:
        for backend in inst.backends:
            if backend == self.backend:
                return true
        false

# Generate code for a backend
fn generate_backend_code(instructions: [IrInstruction], backend: text) -> text:
    val gen = IrCodeGen(
        instructions: instructions,
        backend: backend
    )
    gen_generate_match(gen)

# Generate code for all backends
fn generate_all_backends(instructions: [IrInstruction]) -> text:
    var output = "# Generated Backend Code\n\n"

    output = output + "## Cranelift Backend\n\n```rust\n"
    output = output + generate_backend_code(instructions, "cranelift")
    output = output + "```\n\n"

    output = output + "## LLVM Backend\n\n```rust\n"
    output = output + generate_backend_code(instructions, "llvm")
    output = output + "```\n\n"

    output = output + "## Vulkan Backend\n\n```rust\n"
    output = output + generate_backend_code(instructions, "vulkan")
    output = output + "```\n\n"

    output = output + "## Interpreter Backend\n\n```rust\n"
    output = output + generate_backend_code(instructions, "interpreter")
    output = output + "```\n\n"

    output

export IrCodeGen, generate_backend_code, generate_all_backends
