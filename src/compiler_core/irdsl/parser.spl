"""
# Instruction DSL Parser

Parses .irdsl files defining MIR instructions.

**Phase:** 4 - DSL Code Generation
**Status:** Complete
"""

# Instruction parameter
class IrParam:
    name: text
    param_type: text

# Instruction definition
class IrInstruction:
    name: text
    params: [IrParam]
    backends: [text]
    description: text
    rust_pattern: text
    error_msg: text
    category: text

# Parser state
class IrDslParser:
    lines: [text]
    current_line: i32
    instructions: [IrInstruction]

    # Parse entire file
    me parse():
        while self.current_line < self.lines_len(lines):
            val line = self.lines[self.current_line].trim()

            # Skip empty lines and comments
            if line.len() == 0 or line.starts_with("#"):
                self.current_line = self.current_line + 1
                ()
            # Parse instruction definition
            elif line.starts_with("instruction "):
                self.parse_instruction()
            else:
                self.current_line = self.current_line + 1

    # Parse single instruction
    me parse_instruction():
        val line = self.lines[self.current_line].trim()
        val name = line.split(" ")[1].split(":")[0]

        self.current_line = self.current_line + 1

        var params: [IrParam] = []
        var backends: [text] = []
        var description = ""
        var rust_pattern = ""
        var error_msg = ""
        var category = ""

        # Parse instruction body
        while self.current_line < self.lines_len(lines):
            val body_line = self.lines[self.current_line].trim()

            if body_line_len(body_line) == 0:
                self.current_line = self.current_line + 1
                break

            if body_line.starts_with("instruction ") or body_line.starts_with("# Category:"):
                break

            # Parse fields
            if body_line.starts_with("params:"):
                val param_str = body_line.split(":")[1].trim()
                if param_str_len(param_str) > 0:
                    params = self.parse_params(param_str)
            elif body_line.starts_with("backends:"):
                val backend_str = body_line.split(":")[1].trim()
                val backend_parts = backend_str.split(",")
                backends = []
                for part in backend_parts:
                    backends_push(backends, part.trim())
            elif body_line.starts_with("description:"):
                val desc_parts = body_line.split(":", 2)
                val desc_value = desc_parts[1].trim()
                description = desc_value.replace("\"", "")
            elif body_line.starts_with("rust_pattern:"):
                val pattern_parts = body_line.split(":", 2)
                val pattern_value = pattern_parts[1].trim()
                rust_pattern = pattern_value.replace("\"", "")
            elif body_line.starts_with("error_msg:"):
                val error_parts = body_line.split(":", 2)
                val error_value = error_parts[1].trim()
                error_msg = error_value.replace("\"", "")
            elif body_line.starts_with("category:"):
                category = body_line.split(":")[1].trim()

            self.current_line = self.current_line + 1

        # Create instruction
        val inst = IrInstruction(
            name: name,
            params: params,
            backends: backends,
            description: description,
            rust_pattern: rust_pattern,
            error_msg: error_msg,
            category: category
        )
        self.instructions_push(instructions, inst)

    # Parse parameter list
    fn parse_params(param_str: text) -> [IrParam]:
        if param_str_len(param_str) == 0:
            return []

        val result: [IrParam] = []
        val parts = param_str.split(",")

        for part in parts:
            val trimmed = part_trim(part)
            if trimmed_len(trimmed) > 0:
                val name_type = trimmed.split(":")
                if name_type_len(name_type) >= 2:
                    val param = IrParam(
                        name: name_type[0].trim(),
                        param_type: name_type[1].trim()
                    )
                    result_push(result, param)

        result

    # Get parsed instructions
    fn get_instructions() -> [IrInstruction]:
        self.instructions

# Parse DSL file
fn parse_irdsl_file(content: text) -> [IrInstruction]:
    val lines = content.split("\n")
    val parser = IrDslParser(
        lines: lines,
        current_line: 0,
        instructions: []
    )
    parser_parse(parser)
    parser_get_instructions(parser)

export IrParam, IrInstruction, IrDslParser, parse_irdsl_file
