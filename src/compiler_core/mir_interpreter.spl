# MIR Interpreter
#
# Pure interpreter backend for MIR execution without native compilation.
# Evaluates MIR instructions directly using virtual register mapping.
#
# This enables:
# - Self-hosting (no FFI dependencies)
# - Debugging (compare interpreter vs native results)
# - Portable execution (no Cranelift/LLVM needed)
# - Fast iteration (no compilation overhead)
#
# Architecture:
#   MIR Instructions -> Direct Evaluation -> RuntimeValue
#
# Port of rust/compiler/src/codegen/mir_interpreter.rs (1,058 lines)

use mir_data.*

export MirInterpreter, InterpError

# ============================================================================
# Interpreter Errors
# ============================================================================

enum InterpError:
    """Interpreter runtime errors."""
    DivisionByZero(message: text)
    InvalidCast(from_ty: text, to_ty: text)
    UnsupportedOperation(op: text)
    InvalidRegister(vreg: i64)
    OutOfBounds(index: i64, size: i64)
    RuntimeError(message: text)


# ============================================================================
# InterpError Methods (was: impl InterpError:)
# ============================================================================

# ============================================================================
# MIR Interpreter
# ============================================================================

class MirInterpreter:
    """
    MIR instruction interpreter.

    Maintains runtime state:
    - locals: Local variable values (LocalId -> i64)
    - globals: Global variable storage (name -> i64)
    - blocks: Basic block map (BlockId -> MirBlock)
    - current_block: Currently executing block
    - return_value: Return value from function
    """
    locals: {i64: i64}       # LocalId.id -> value
    globals: {text: i64}     # Global name -> value
    blocks: {i64: MirBlock}  # BlockId.id -> block
    current_block: i64      # Current block ID
    return: i64       # Return value
    has_returned: bool       # Whether function has returned


# ============================================================================
# MirInterpreter Methods (was: impl MirInterpreter:)
# ============================================================================

fn mirinterpreter_create() -> MirInterpreter:
        """Create a new interpreter instance."""
        MirInterpreter(
            locals: {},
            globals: {},
            blocks: {}
            #  # DESUGARED: current_block: nil
            #  # DESUGARED: return_value: nil
        )


# ============================================================================
# Helper Functions
# ============================================================================

fn f64_to_bits(v: f64) -> i64:
    """Convert f64 to IEEE 754 bit representation.
    Approximation: proper bit reinterpretation requires SFFI (rt_f64_to_bits).
    Current fallback truncates to integer which loses fractional data."""
    v as i64

fn f64_from_bits(bits: i64) -> f64:
    """Convert IEEE 754 bit representation to f64.
    Approximation: proper bit reinterpretation requires SFFI (rt_f64_from_bits).
    Current fallback casts integer to float which is not a bitwise reinterpret."""
    bits as f64
