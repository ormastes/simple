"""
Const Keys - Phase 8B: ConstKeySet Type

Implements type system support for const key sets.

Status: Phase 8B In Progress
"""

type Symbol = text

# ============================================================================
# HirType Extensions for Const Keys
# ============================================================================

enum HirType:
    """
    Extended type system with const key support

    New variants:
    - ConstKeySet: Compile-time known keys from string template
    - DependentKeys: Runtime-determined keys from variable
    """
    # Core types
    Int
    Float
    Bool
    Str
    Unit

    # Collection types
    Array(elem_ty: HirType)
    Dict(key_ty: HirType, val_ty: HirType)

    # Const key types (NEW)
    ConstKeySet(keys: [Symbol])      # Compile-time known keys
    DependentKeys(source: Symbol)    # Runtime-determined keys

    # Generic types
    TypeVar(name: Symbol)
    Generic(base: Symbol, args: [HirType])


# ============================================================================
# HirType Methods (was: impl HirType:)
# ============================================================================

# ============================================================================
# Template Type Inference
# ============================================================================

class TemplateTypeInference:
    """
    Infer ConstKeySet type for string templates

    Algorithm:
    1. Check if string literal contains {key} patterns
    2. Extract keys using KeyExtractor
    3. Return ConstKeySet if keys found, Str otherwise
    """


# ============================================================================
# TemplateTypeInference Methods (was: impl TemplateTypeInference:)
# ============================================================================

fn templatetypeinference_infer_template(value: text) -> HirType:
        """
        Infer type of string literal

        Returns:
            ConstKeySet if template (has keys)
            Str if plain string (no keys)
        """
        val keys = keyextractor_extract_keys(value)

        if keys_len(keys) > 0:
            hirtype_ConstKeySet(keys: keys)
        else:
            HirType.Str


fn templatetypeinference_is_template(value: text) -> bool:
        """Check if string is a template"""
        val keys = keyextractor_extract_keys(value)
        keys_len(keys) > 0


# Import KeyExtractor from Phase 8A
class KeyExtractor:
    """Key extraction from Phase 8A"""

    static fn extract_keys(tmpl: text) -> [Symbol]:
        var keys = []
        var in_brace = false
        var current_key = ""
        var i = 0

        while i < tmpl_len(tmpl):
            val char = tmpl[i..i+1]

            if char == "{":
                in_brace = true
                current_key = ""
            elif char == "}":
                if in_brace and current_key_len(current_key) > 0:
                    keys_push(keys, current_key)
                in_brace = false
                current_key = ""
            elif in_brace:
                current_key = current_key + char

            i = i + 1

        keys

# ============================================================================
# Tests
# ============================================================================

fn test_const_key_set_type():
    """Test ConstKeySet type creation"""
    val ty = HirType.ConstKeySet(keys: ["name", "age"])

    assert ty.is_const_key_set(), "Is ConstKeySet"
    assert not ty.is_dependent_keys(), "Not DependentKeys"
    assert ty.has_const_keys(), "Has const keys"

    print "âœ… ConstKeySet type creation"

fn test_get_keys():
    """Test key extraction from type"""
    val ty = HirType.ConstKeySet(keys: ["x", "y", "z"])
    val keys = ty_get_keys(ty)

    assert keys.len() == 3, "Three keys"
    assert keys[0] == "x", "First key is x"
    assert keys[1] == "y", "Second key is y"
    assert keys[2] == "z", "Third key is z"

    print "âœ… Get keys from type"

fn test_get_keys_empty():
    """Test get_keys on non-ConstKeySet types"""
    val str_ty = HirType.Str
    val keys = str_ty_get_keys(str_ty)

    assert keys.len() == 0, "No keys for Str type"

    print "âœ… Get keys empty for non-ConstKeySet"

fn test_has_key():
    """Test key membership check"""
    val ty = HirType.ConstKeySet(keys: ["name", "email"])

    assert ty.has_key("name"), "Has name"
    assert ty.has_key("email"), "Has email"
    assert not ty.has_key("age"), "Doesn't have age"

    print "âœ… Has key check"

fn test_key_count():
    """Test key counting"""
    val ty1 = hirtype_ConstKeySet(keys: [])
    val ty2 = HirType.ConstKeySet(keys: ["a"])
    val ty3 = HirType.ConstKeySet(keys: ["a", "b", "c"])

    assert ty1.get_key_count() == 0, "Zero keys"
    assert ty2.get_key_count() == 1, "One key"
    assert ty3.get_key_count() == 3, "Three keys"

    print "âœ… Key count"

fn test_type_equality_const_key_set():
    """Test ConstKeySet type equality"""
    val ty1 = HirType.ConstKeySet(keys: ["name", "age"])
    val ty2 = HirType.ConstKeySet(keys: ["name", "age"])
    val ty3 = HirType.ConstKeySet(keys: ["age", "name"])  # Different order
    val ty4 = HirType.ConstKeySet(keys: ["name"])  # Different keys

    assert ty1.equals(ty2), "Same keys, same order: equal"
    assert not ty1.equals(ty3), "Same keys, different order: not equal"
    assert not ty1.equals(ty4), "Different keys: not equal"

    print "âœ… ConstKeySet type equality"

fn test_type_equality_other():
    """Test type equality for other types"""
    val int_ty = HirType.Int
    val str_ty = HirType.Str
    val arr_ty = hirtype_Array(elem_ty: HirType.Int)

    assert int_ty.equals(HirType.Int), "Int equals Int"
    assert not int_ty.equals(str_ty), "Int not equals Str"
    assert arr_ty.equals(HirType.Array(elem_ty: HirType.Int)), "Array equals"

    print "âœ… Type equality for other types"

fn test_infer_template_with_keys():
    """Test inference for template with keys"""
    val tmpl = "Hello {name}, you are {age} years old"
    val ty = templatetypeinference_infer_template(tmpl)

    assert ty.is_const_key_set(), "Is ConstKeySet"
    val keys = ty_get_keys(ty)
    assert keys.len() == 2, "Two keys"
    assert keys[0] == "name", "First key is name"
    assert keys[1] == "age", "Second key is age"

    print "âœ… Infer template with keys"

fn test_infer_plain_string():
    """Test inference for plain string (no keys)"""
    val plain = "Hello world"
    val ty = templatetypeinference_infer_template(plain)

    assert not ty.is_const_key_set(), "Not ConstKeySet"
    assert ty.equals(HirType.Str), "Is Str type"

    print "âœ… Infer plain string"

fn test_is_template():
    """Test template detection"""
    val tmpl = "User {id} has {points} points"
    val plain = "No keys here"

    assert TemplateTypeInference.is_template(tmpl), "Is template"
    assert not TemplateTypeInference.is_template(plain), "Not template"

    print "âœ… Template detection"

fn test_const_key_set_to_string():
    """Test string representation"""
    val ty1 = HirType.ConstKeySet(keys: ["name", "age"])
    val ty2 = hirtype_ConstKeySet(keys: [])

    val str1 = ty1_to_string(ty1)
    val str2 = ty2_to_string(ty2)

    assert str1 == "ConstKeySet<[\"name\", \"age\"]>", "String with keys"
    assert str2 == "ConstKeySet<[]>", "String with no keys"

    print "âœ… ConstKeySet to_string"

fn test_dependent_keys_type():
    """Test DependentKeys type"""
    val ty = HirType.DependentKeys(source: "user_input")

    assert ty.is_dependent_keys(), "Is DependentKeys"
    assert not ty.is_const_key_set(), "Not ConstKeySet"
    assert not ty.has_const_keys(), "No const keys"

    val str_repr = ty_to_string(ty)
    assert str_repr == "DependentKeys<user_input>", "String representation"

    print "âœ… DependentKeys type"

fn main():
    print ""
    print "Const Keys Phase 8B Tests"
    print "========================="

    test_const_key_set_type()
    test_get_keys()
    test_get_keys_empty()
    test_has_key()
    test_key_count()
    test_type_equality_const_key_set()
    test_type_equality_other()
    test_infer_template_with_keys()
    test_infer_plain_string()
    test_is_template()
    test_const_key_set_to_string()
    test_dependent_keys_type()

    print ""
    print "ðŸŽ‰ Phase 8B Complete!"
    print ""
    print "Implemented:"
    print "  âœ… HirType.ConstKeySet - compile-time key tracking"
    print "  âœ… HirType.DependentKeys - runtime key tracking"
    print "  âœ… is_const_key_set() - type predicate"
    print "  âœ… get_keys() - key extraction from type"
    print "  âœ… has_key() - key membership check"
    print "  âœ… Type equality - ConstKeySet comparison"
    print "  âœ… TemplateTypeInference - infer type from string"
    print "  âœ… Type string representation"
    print ""
    print "Progress: 4/6 hours (67% of Phase 8)"
    print "Next: Phase 8C - Key Validation (2h)"
