# Cast Rules
#
# Unified cast rules for interpreter and codegen.
# This module provides a single source of truth for type casting semantics
# that must be consistent between the interpreter and compiled code.
#
# Port of rust/compiler/src/semantics/cast_rules.rs (264 lines)

export NumericType, CastNumericResult
export cast_int_to_numeric, cast_float_to_numeric, cast_bool_to_numeric
export BoolCast, StringCast

# ============================================================================
# Numeric Type Categories
# ============================================================================

enum NumericType:
    I8
    I16
    I32
    I64
    U8
    U16
    U32
    U64
    F32
    F64


# ============================================================================
# NumericType Methods (was: impl NumericType:)
# ============================================================================

# ============================================================================
# Cast Result
# ============================================================================

enum CastNumericResult:
    Int(i64)
    Float(f64)

# ============================================================================
# Cast Functions
# ============================================================================

fn cast_int_to_numeric(value: i64, target: NumericType) -> CastNumericResult:
    """Cast an i64 to a target numeric type, returning the result as i64 or f64.

    This handles truncation and sign extension according to Simple's semantics.

    CRITICAL: Truncation semantics must be preserved exactly.
    Example: 300 as i8 as i64 = 44 (wraps around)
    Example: -1 as u8 as i64 = 255 (wraps around)
    """
    match target:
        # Signed integers (truncation + sign extension)
        case I8: castnumericresult_Int(value as i8 as i64)
        case I16: castnumericresult_Int(value as i16 as i64)
        case I32: castnumericresult_Int(value as i32 as i64)
        case I64: castnumericresult_Int(value)
        # Unsigned integers (truncation + zero extension)
        case U8: castnumericresult_Int(value as u8 as i64)
        case U16: castnumericresult_Int(value as u16 as i64)
        case U32: castnumericresult_Int(value as u32 as i64)
        case U64: castnumericresult_Int(value as u64 as i64)
        # Floats (int to float conversion)
        case F32: castnumericresult_Float(value as f32 as f64)
        case F64: castnumericresult_Float(value as f64)

fn cast_float_to_numeric(value: f64, target: NumericType) -> CastNumericResult:
    """Cast an f64 to a target numeric type.

    CRITICAL: Float to int truncates (rounds toward zero).
    CRITICAL: Float to smaller float may lose precision.
    """
    match target:
        # Signed integers (truncation)
        case I8: castnumericresult_Int(value as i8 as i64)
        case I16: castnumericresult_Int(value as i16 as i64)
        case I32: castnumericresult_Int(value as i32 as i64)
        case I64: castnumericresult_Int(value as i64)
        # Unsigned integers (truncation)
        case U8: castnumericresult_Int(value as u8 as i64)
        case U16: castnumericresult_Int(value as u16 as i64)
        case U32: castnumericresult_Int(value as u32 as i64)
        case U64: castnumericresult_Int(value as u64 as i64)
        # Floats (precision loss possible)
        case F32: castnumericresult_Float(value as f32 as f64)
        case F64: castnumericresult_Float(value)

fn cast_bool_to_numeric(value: bool, target: NumericType) -> CastNumericResult:
    """Cast a bool to a target numeric type.

    true → 1 or 1.0
    false → 0 or 0.0
    """
    if target_is_float(target):
        castnumericresult_Float(if value: 1.0 else: 0.0)
    else:
        castnumericresult_Int(if value: 1 else: 0)

# ============================================================================
# Bool Cast Rules
# ============================================================================

struct BoolCast


# ============================================================================
# BoolCast Methods (was: impl BoolCast:)
# ============================================================================

fn boolcast_from_int(i: i64) -> bool:
        """Convert an integer to bool: non-zero is true."""
        i != 0


fn boolcast_from_float(f: f64) -> bool:
        """Convert a float to bool: non-zero is true."""
        f != 0.0


fn boolcast_from_str(s: text) -> bool:
        """Convert a string to bool: non-empty is true."""
        not s_is_empty(s)


# ============================================================================
# String Cast Rules
# ============================================================================

struct StringCast


# ============================================================================
# StringCast Methods (was: impl StringCast:)
# ============================================================================

fn stringcast_from_int(i: i64) -> text:
        """Convert an integer to string."""
        i_to_string(i)


fn stringcast_from_float(f: f64) -> text:
        """Convert a float to string."""
        f_to_string(f)


fn stringcast_from_bool(b: bool) -> text:
        """Convert a bool to string."""
        b_to_string(b)

