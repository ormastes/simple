# Driver - Compiler Driver Implementation
#
# This module contains the main compiler driver implementation:
# - CheckBackendImpl: Backend for type checking only
# - CompilerDriver: Main compiler orchestration
# - Utility functions for file compilation
#
# Type definitions are in driver_types.spl

use compiler.hir.*
use compiler.mir.*
use core.lexer.*
use core.parser.*
use compiler.desugar_async.{desugar_module}
use compiler.treesitter.*
use compiler.backend.*
use compiler.type_infer.*
use compiler.ffi.*
use compiler.monomorphize_integration.*
use compiler.mir_opt_integration.{OptimizationConfig, optimize_mir_module}
use compiler.async_integration.{AsyncIntegration, AsyncStateMachine, process_async_mir}
use compiler.borrow_check.*
use compiler.visibility_integration.{check_module_visibility}
use compiler.const_eval.{eval_static_assert, ConstEvalError}
use blocks.*
use config.*
use driver_types.*
use compiler.linker.linker_wrapper.{link_to_native, link_to_smf, link_to_self_contained, NativeLinkConfig, NativeLinkConfig__default, SelfContainedConfig, SelfContainedConfig__default}
use compiler.smf_writer.{generate_smf_with_templates, Target}
use std.string.{NL}

class CheckBackendImpl(Backend):
    fn name() -> text:
        "check"

    fn is_allowed(op: text) -> bool:
        # Allow everything for type checking
        true

    fn process_module(module: HirModule) -> text:
        # Stub: Result types not supported in seed_cpp
        ""

    fn eval_expr(expr: HirExpr, env: Environment) -> text:
        # Stub: Result types not supported in seed_cpp
        ""

    fn exec_stmt(stmt: HirStmt, env: Environment) -> text:
        # Stub: Result types not supported in seed_cpp
        ""

# ------------------------------------------------------------------------------
# Compiler Driver
# ------------------------------------------------------------------------------

class CompilerDriver:
    ctx: CompileContext

    static fn create(options: CompileOptions) -> i64:
        # Stub: CompilerDriver struct return not supported in seed_cpp
        0

    # --------------------------------------------------------------------------
    # Main compilation entry point
    # --------------------------------------------------------------------------

    me compile() -> i64:
        # Stub: CompileResult and complex compilation logic not supported in seed_cpp
        0

    # --------------------------------------------------------------------------
    # Phase 1: Load sources
    # --------------------------------------------------------------------------

    me load_sources_impl() -> bool:
        # Stub: Complex source loading logic not supported in seed_cpp
        false

    # --------------------------------------------------------------------------
    # Phase 2: Parse
    # --------------------------------------------------------------------------

    me parse_all_impl() -> bool:
        # Stub: Complex parsing logic not supported in seed_cpp
        false
    fn parse_source(source: SourceFile) -> i64:
        # Stub: Module struct return not supported in seed_cpp
        0
    # --------------------------------------------------------------------------
    # Phase 3: Combined HIR Lowering + Method Resolution + Type Checking
    # --------------------------------------------------------------------------
    #
    # This combined implementation processes each module through all three
    # phases in a single loop, avoiding redundant iterations and improving
    # performance on large codebases.

    me lower_and_check_impl() -> bool:
        # Stub: Complex HIR lowering logic not supported in seed_cpp
        false
    # --------------------------------------------------------------------------
    # Phase 3a: Lower to HIR (standalone, kept for compatibility)
    # --------------------------------------------------------------------------

    fn lower_to_hir_impl() -> i64:
        # Stub: Tuple return and HIR lowering not supported in seed_cpp
        0

    # --------------------------------------------------------------------------
    # Phase 3b: Method Resolution (standalone, kept for compatibility)
    # --------------------------------------------------------------------------

    fn resolve_methods_impl() -> i64:
        # Stub: Tuple return and method resolution not supported in seed_cpp
        0

    # --------------------------------------------------------------------------
    # Phase 3c: Type Checking (standalone, kept for compatibility)
    # --------------------------------------------------------------------------

    fn type_check_impl() -> (CompileContext, bool):
        var ctx = self.ctx

        # Type inference disabled for bootstrap compatibility
        # for name in ctx.hir_modules.keys():
        #     val hir_module = ctx.hir_modules[name]
        #     var infer_ctx = HmInferContext.with_builtins()
        #     infer_ctx.infer_module(hir_module)
        #     for err in infer_ctx.errors:
        #         var errors = ctx.errors
        #         errors.push("Type error in {name}: {err.message()}")
        #         ctx.errors = errors

        [ctx, ctx.errors_len(errors) == 0]

    # --------------------------------------------------------------------------
    # Phase 4: Monomorphization
    # --------------------------------------------------------------------------

    me monomorphize_impl() -> bool:
        # Stub: Monomorphization logic not supported in seed_cpp
        false
    # --------------------------------------------------------------------------
    # Mode: SDN (Data only)
    # --------------------------------------------------------------------------

    fn process_sdn() -> i64:
        # Stub: CompileResult and SDN processing not supported in seed_cpp
        0

    # --------------------------------------------------------------------------
    # Mode: Interpret
    # --------------------------------------------------------------------------

    fn interpret() -> i64:
        # Stub: CompileResult and interpretation logic not supported in seed_cpp
        0

    fn run_module(backend: Backend, module: HirModule) -> i64:
        # Stub: CompileResult and module running not supported in seed_cpp
        0

    # --------------------------------------------------------------------------
    # Mode: JIT Compile and Run
    # --------------------------------------------------------------------------

    me jit_compile_and_run() -> i64:
        # Stub: CompileResult and JIT compilation not supported in seed_cpp
        0

    # --------------------------------------------------------------------------
    # Mode: AOT Compile
    # --------------------------------------------------------------------------

    me aot_compile() -> i64:
        # Stub: CompileResult and AOT compilation not supported in seed_cpp
        0

    me compile_to_native(output: text) -> i64:
        # Stub: Native compilation not supported in seed_cpp
        0
    me compile_to_smf(output: text) -> i64:
        # Stub: SMF compilation not supported in seed_cpp
        0
    me compile_to_self_contained(output: text) -> i64:
        # Stub: Self-contained compilation not supported in seed_cpp
        0
    me collect_smf_bytes() -> i64:
        # Stub: SMF byte collection not supported in seed_cpp
        0
    # --------------------------------------------------------------------------
    # Linker Helper (legacy - kept for compatibility, delegates to linker_wrapper)
    # --------------------------------------------------------------------------

    fn link_objects(objects: [text], output: text) -> text:
        # Stub: Object linking not supported in seed_cpp
        ""
    # --------------------------------------------------------------------------
    # MIR Lowering
    # --------------------------------------------------------------------------

    me lower_to_mir() -> bool:
        # Stub: MIR lowering not supported in seed_cpp
        false
    # --------------------------------------------------------------------------
    # Borrow Checking
    # --------------------------------------------------------------------------

    me borrow_check() -> bool:
        # Stub: Borrow checking not supported in seed_cpp
        false
    fn format_borrow_error(err: NLLError) -> text:
        """Format a borrow error for display."""
        # Stub: NLLError field access not supported in seed_cpp
        "Borrow check error"

    # --------------------------------------------------------------------------
    # Async Processing
    # --------------------------------------------------------------------------

    me process_async() -> i64:
        # Stub: Async processing not supported in seed_cpp
        0
    # --------------------------------------------------------------------------
    # MIR Optimization
    # --------------------------------------------------------------------------

    me optimize_mir(config: OptimizationConfig):
        # Stub: MIR optimization not supported in seed_cpp
        ()
    fn get_optimization_config() -> i64:
        # Stub: Optimization config not supported in seed_cpp
        0
