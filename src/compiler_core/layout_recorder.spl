# Layout Recorder
#
# Runtime instrumentation for 4KB page locality optimization.
# Records function execution patterns during test runs to guide
# optimal code placement for cache-efficient startup.
#
# Port of rust/compiler/src/layout_recorder.rs (450 lines)

export FunctionRecord, RecordingSession, LayoutPhase
export start_recording, stop_recording, export_layout_sdn

# ============================================================================
# Types
# ============================================================================

enum LayoutPhase:
    Startup         # Called once during startup
    FirstFrame      # Called early and frequently
    Steady          # Called frequently after startup
    Cold            # Rarely called

struct FunctionRecord:
    name: text
    # DESUGARED: module: text?
    has_module: bool
    module_value: text
    call_count: i64
    first_call_us: i64
    last_call_us: i64
    estimated_size: i64
    callees: [text]
    is_startup_path: bool


# ============================================================================
# FunctionRecord Methods (was: impl FunctionRecord:)
# ============================================================================

fn functionrecord_create(name: text) -> FunctionRecord:
        FunctionRecord(name: name, module: nil, call_count: 0,
                       first_call_us: 0, last_call_us: 0,
                       estimated_size: 0, callees: [], is_startup_path: false)


# ============================================================================
# Recording Session
# ============================================================================

class RecordingSession:
    """Records function execution patterns for layout optimization."""
    functions: {text: FunctionRecord}
    call_stack: [text]
    start_millis: i64
    first_frame_us: i64?
    event_loop_us: i64?


# ============================================================================
# RecordingSession Methods (was: impl RecordingSession:)
# ============================================================================

fn recordingsession_create() -> RecordingSession:
        extern fn rt_time_millis() -> i64
        RecordingSession(functions: {}, call_stack: [],
                         start_millis: rt_time_millis(),
                         first_frame_us: nil, event_loop_us: nil)


# ============================================================================
# Global Recording API
# ============================================================================

var _global_session: RecordingSession? = nil

fn start_recording():
    _global_session = has_field = true, field_value = recordingsession_create()

fn stop_recording():
    _global_session = nil

fn export_layout_sdn() -> text:
    if has__global_session:
        _global_session_value_export_sdn(_global_session_value)
    else:
        ""
