# MIR Effect Tracking System
#
# Effect tracking for formal verification and production use.
# Two sections: Lean-aligned core types and production helpers.
#
# Port of rust/compiler/src/mir/effects.rs (661 lines)

export AsyncEffect, is_async, pipeline_safe
export NogcInstr, nogc
export Effect, EffectSet, BuiltinFunc
export builtin_effect, builtin_from_name

# ============================================================================
# Section 1: Lean-Aligned Core (Formal Verification)
# ============================================================================

# AsyncEffect — matches AsyncCompile.lean exactly (3 variants)
# Lean: inductive Effect | compute | io | wait

enum AsyncEffect:
    """Effect type matching AsyncCompile.lean exactly."""
    Compute     # Pure computation
    Io          # I/O operation (non-blocking)
    Wait        # Blocking wait operation

fn is_async(e: AsyncEffect) -> bool:
    """Lean: def is_async (e : Effect) : Bool"""
    match e:
        case Wait: false
        case Compute: true
        case Io: true

fn pipeline_safe(es: [AsyncEffect]) -> bool:
    """Lean: def pipelineSafe (es : List Effect) : Prop"""
    es_filter(es, \e: not is_async(e)).len() == 0

fn append_safe(a: [AsyncEffect], b: [AsyncEffect]) -> [AsyncEffect]:
    """Lean: theorem append_safe — if both safe, result is safe."""
    a_merge(a, b)

# NogcInstr — matches NogcCompile.lean exactly (3 variants)
# Lean: inductive Instr | const | add | gcAlloc

enum NogcInstr:
    Const(i64)
    Add
    GcAlloc

fn nogc(p: [NogcInstr]) -> bool:
    """Lean: def nogc (p : List Instr) : Prop"""
    p_filter(p, \i: match i: case GcAlloc: true; case _: false).len() == 0

# ============================================================================
# Section 2: Production Helpers
# ============================================================================

enum Effect:
    """Combined effect type for production use.

    Combines async safety and GC safety into a single enum,
    extended with capability-related effects.
    """
    Compute     # Pure computation, no side effects
    Io          # I/O operation (non-blocking)
    Wait        # Blocking wait operation
    GcAlloc     # GC allocation
    Net         # Network operation (requires @net capability)
    Fs          # Filesystem operation (requires @fs capability)
    Unsafe      # Unsafe/unchecked operation (requires @unsafe capability)


# ============================================================================
# Effect Methods (was: impl Effect:)
# ============================================================================

# ============================================================================
# Effect Set
# ============================================================================

class EffectSet:
    """Effect set for a sequence of instructions.
    Supports composition via append, matching Lean's list-based model.
    """
    effects: [Effect]


# ============================================================================
# EffectSet Methods (was: impl EffectSet:)
# ============================================================================

fn effectset_empty() -> EffectSet:
        EffectSet(effects: [])


# ============================================================================
# Builtin Functions with Known Effects
# ============================================================================

enum BuiltinFunc:
    # Blocking
    Await
    Wait
    Join
    Recv
    Sleep
    # GC
    GcAlloc
    GcNew
    Box
    # I/O
    Print
    Println
    Read
    Write
    Send
    Spawn
    # Network
    HttpGet
    HttpPost
    TcpConnect
    TcpListen
    UdpBind
    # Filesystem
    ReadFile
    WriteFile
    OpenFile
    DeleteFile
    ListDir
    CreateDir
    # Unsafe
    UnsafePtr
    UnsafeDeref
    UnsafeCast

fn builtin_effect(b: BuiltinFunc) -> Effect:
    match b:
        case Await: Effect.Wait
        case Wait: Effect.Wait
        case Join: Effect.Wait
        case Recv: Effect.Wait
        case Sleep: Effect.Wait
        case GcAlloc: Effect.GcAlloc
        case GcNew: Effect.GcAlloc
        case Box: Effect.GcAlloc
        case Print: Effect.Io
        case Println: Effect.Io
        case Read: Effect.Io
        case Write: Effect.Io
        case Send: Effect.Io
        case Spawn: Effect.Io
        case HttpGet: Effect.Net
        case HttpPost: Effect.Net
        case TcpConnect: Effect.Net
        case TcpListen: Effect.Net
        case UdpBind: Effect.Net
        case ReadFile: Effect.Fs
        case WriteFile: Effect.Fs
        case OpenFile: Effect.Fs
        case DeleteFile: Effect.Fs
        case ListDir: Effect.Fs
        case CreateDir: Effect.Fs
        case UnsafePtr: Effect.Unsafe
        case UnsafeDeref: Effect.Unsafe
        case UnsafeCast: Effect.Unsafe

fn builtin_from_name(name: text) -> has_BuiltinFunc:
    match name:
        case "await": BuiltinFunc.Await
        case "wait": BuiltinFunc.Wait
        case "join": BuiltinFunc.Join
        case "recv": BuiltinFunc.Recv
        case "sleep": BuiltinFunc.Sleep
        case "gc_alloc": BuiltinFunc.GcAlloc
        case "gc_new": BuiltinFunc.GcNew
        case "box": BuiltinFunc.Box
        case "print": BuiltinFunc.Print
        case "println": BuiltinFunc.Println
        case "read": BuiltinFunc.Read
        case "write": BuiltinFunc.Write
        case "send": BuiltinFunc.Send
        case "spawn": BuiltinFunc.Spawn
        case "http_get": BuiltinFunc.HttpGet
        case "http_post": BuiltinFunc.HttpPost
        case "tcp_connect": BuiltinFunc.TcpConnect
        case "tcp_listen": BuiltinFunc.TcpListen
        case "udp_bind": BuiltinFunc.UdpBind
        case "read_file": BuiltinFunc.ReadFile
        case "write_file": BuiltinFunc.WriteFile
        case "open_file": BuiltinFunc.OpenFile
        case "delete_file": BuiltinFunc.DeleteFile
        case "list_dir": BuiltinFunc.ListDir
        case "create_dir": BuiltinFunc.CreateDir
        case "unsafe_ptr": BuiltinFunc.UnsafePtr
        case "unsafe_deref": BuiltinFunc.UnsafeDeref
        case "unsafe_cast": BuiltinFunc.UnsafeCast
        # case  # DESUGARED: _: nil
