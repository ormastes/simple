# MIR Effect Tracking System
#
# Effect tracking for formal verification and production use.
# Two sections: Lean-aligned core types and production helpers.
#
# Port of rust/compiler/src/mir/effects.rs (661 lines)

export AsyncEffect, is_async, pipeline_safe
export NogcInstr, nogc
export Effect, EffectSet, BuiltinFunc
export builtin_effect, builtin_from_name

# ============================================================================
# Section 1: Lean-Aligned Core (Formal Verification)
# ============================================================================

# AsyncEffect — matches AsyncCompile.lean exactly (3 variants)
# Lean: inductive Effect | compute | io | wait

enum AsyncEffect:
    """Effect type matching AsyncCompile.lean exactly."""
    Compute     # Pure computation
    Io          # I/O operation (non-blocking)
    Wait        # Blocking wait operation

fn is_async(e: AsyncEffect) -> bool:
    """Lean: def is_async (e : Effect) : Bool"""
    match e:
        case Wait: false
        case Compute | Io: true

fn pipeline_safe(es: [AsyncEffect]) -> bool:
    """Lean: def pipelineSafe (es : List Effect) : Prop"""
    es_filter(es, \e: not is_async(e)).len() == 0

fn append_safe(a: [AsyncEffect], b: [AsyncEffect]) -> [AsyncEffect]:
    """Lean: theorem append_safe — if both safe, result is safe."""
    a_merge(a, b)

# NogcInstr — matches NogcCompile.lean exactly (3 variants)
# Lean: inductive Instr | const | add | gcAlloc

enum NogcInstr:
    Const(i64)
    Add
    GcAlloc

fn nogc(p: [NogcInstr]) -> bool:
    """Lean: def nogc (p : List Instr) : Prop"""
    p_filter(p, \i: match i: case GcAlloc: true; case _: false).len() == 0

# ============================================================================
# Section 2: Production Helpers
# ============================================================================

enum Effect:
    """Combined effect type for production use.

    Combines async safety and GC safety into a single enum,
    extended with capability-related effects.
    """
    Compute     # Pure computation, no side effects
    Io          # I/O operation (non-blocking)
    Wait        # Blocking wait operation
    GcAlloc     # GC allocation
    Net         # Network operation (requires @net capability)
    Fs          # Filesystem operation (requires @fs capability)
    Unsafe      # Unsafe/unchecked operation (requires @unsafe capability)


# ============================================================================
# Effect Methods (was: impl Effect:)
# ============================================================================

# ============================================================================
# Effect Set
# ============================================================================

class EffectSet:
    """Effect set for a sequence of instructions.
    Supports composition via append, matching Lean's list-based model.
    """
    effects: [Effect]


# ============================================================================
# EffectSet Methods (was: impl EffectSet:)
# ============================================================================

fn effectset_empty() -> EffectSet:
        EffectSet(effects: [])


# ============================================================================
# Builtin Functions with Known Effects
# ============================================================================

enum BuiltinFunc:
    # Blocking
    Await
    Wait
    Join
    Recv
    Sleep
    # GC
    GcAlloc
    GcNew
    Box
    # I/O
    Print
    Println
    Read
    Write
    Send
    Spawn
    # Network
    HttpGet
    HttpPost
    TcpConnect
    TcpListen
    UdpBind
    # Filesystem
    ReadFile
    WriteFile
    OpenFile
    DeleteFile
    ListDir
    CreateDir
    # Unsafe
    UnsafePtr
    UnsafeDeref
    UnsafeCast

fn builtin_effect(b: BuiltinFunc) -> Effect:
    match b:
        case Await | Wait | Join | Recv | Sleep: Effect.Wait
        case GcAlloc | GcNew | Box: Effect.GcAlloc
        case Print | Println | Read | Write | Send | Spawn: Effect.Io
        case HttpGet | HttpPost | TcpConnect | TcpListen | UdpBind: Effect.Net
        case ReadFile | WriteFile | OpenFile | DeleteFile | ListDir | CreateDir: Effect.Fs
        case UnsafePtr | UnsafeDeref | UnsafeCast: Effect.Unsafe

fn builtin_from_name(name: text) -> has_BuiltinFunc:
    match name:
        case "await": has_field = true, field_value = BuiltinFunc.Await
        case "wait": has_field = true, field_value = BuiltinFunc.Wait
        case "join": has_field = true, field_value = BuiltinFunc.Join
        case "recv": has_field = true, field_value = BuiltinFunc.Recv
        case "sleep": has_field = true, field_value = BuiltinFunc.Sleep
        case "gc_alloc": has_field = true, field_value = BuiltinFunc.GcAlloc
        case "gc_new": has_field = true, field_value = BuiltinFunc.GcNew
        case "box": has_field = true, field_value = BuiltinFunc.Box
        case "print": has_field = true, field_value = BuiltinFunc.Print
        case "println": has_field = true, field_value = BuiltinFunc.Println
        case "read": has_field = true, field_value = BuiltinFunc.Read
        case "write": has_field = true, field_value = BuiltinFunc.Write
        case "send": has_field = true, field_value = BuiltinFunc.Send
        case "spawn": has_field = true, field_value = BuiltinFunc.Spawn
        case "http_get": has_field = true, field_value = BuiltinFunc.HttpGet
        case "http_post": has_field = true, field_value = BuiltinFunc.HttpPost
        case "tcp_connect": has_field = true, field_value = BuiltinFunc.TcpConnect
        case "tcp_listen": has_field = true, field_value = BuiltinFunc.TcpListen
        case "udp_bind": has_field = true, field_value = BuiltinFunc.UdpBind
        case "read_file": has_field = true, field_value = BuiltinFunc.ReadFile
        case "write_file": has_field = true, field_value = BuiltinFunc.WriteFile
        case "open_file": has_field = true, field_value = BuiltinFunc.OpenFile
        case "delete_file": has_field = true, field_value = BuiltinFunc.DeleteFile
        case "list_dir": has_field = true, field_value = BuiltinFunc.ListDir
        case "create_dir": has_field = true, field_value = BuiltinFunc.CreateDir
        case "unsafe_ptr": has_field = true, field_value = BuiltinFunc.UnsafePtr
        case "unsafe_deref": has_field = true, field_value = BuiltinFunc.UnsafeDeref
        case "unsafe_cast": has_field = true, field_value = BuiltinFunc.UnsafeCast
        case has__: false,  # DESUGARED: _: nil
