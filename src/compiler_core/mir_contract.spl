# MIR Contract Lowering and State Machine
#
# Contract mode, lowerer state machine, contract context, and loop context
# for MIR lowering. Explicit state to simplify formal verification.
#
# ContractMode imported from shared module (src/shared/contracts.spl).
# Port of rust/compiler/src/mir/lower_contract.rs (248 lines)

from shared.contracts import {ContractMode, ContractKind, ContractViolation}

export ContractMode, LoopContext, ContractContext
export LowererState, BlockState, MirLowerError

# ============================================================================
# Loop Context (for break/continue)
# ============================================================================

struct LoopContext:
    continue_target: i64    # Block ID for continue
    break_target: i64       # Block ID for break

# ============================================================================
# Contract Context
# ============================================================================

struct ContractContext:
    """Context for contract lowering within a function."""
    old_captures: {i64: i64}    # index -> vreg holding captured value
    # # DESUGARED: return_value: i64
    has_return: bool
    return_value: i64
    func_name: text
    is_public: bool


# ============================================================================
# ContractContext Methods (was: impl ContractContext:)
# ============================================================================

fn contractcontext_empty(func_name: text, is_public: bool) -> ContractContext:
        # ContractContext(old_captures: {}  # DESUGARED: return_value: nil
                        func_name: func_name, is_public: is_public)


# ============================================================================
# Lowerer State Machine
# ============================================================================

enum LowererState:
    """Explicit lowerer state for formal verification.

    Lean model:
      inductive LowererState
        | idle
        | lowering (func_name : text) (current_block : i64)
                   (loop_stack : List LoopContext)
    """
    Idle
    Lowering(func_name: text, current_block: i64,
             loop_stack: [LoopContext], contract_ctx: ContractContext)


# ============================================================================
# LowererState Methods (was: impl LowererState:)
# ============================================================================

# ============================================================================
# Block State
# ============================================================================

enum BlockState:
    """Makes terminator state explicit for verification."""
    Open        # Accepting instructions
    Sealed      # Has a terminator


# ============================================================================
# BlockState Methods (was: impl BlockState:)
# ============================================================================

# ============================================================================
# MIR Lowering Errors
# ============================================================================

enum MirLowerError:
    Unsupported(text)
    InvalidState(expected: text, found: text)
    BreakOutsideLoop
    ContinueOutsideLoop
    AopWeavingFailed(text)
    CircularDependency(text)


# ============================================================================
# MirLowerError Methods (was: impl MirLowerError:)
# ============================================================================
