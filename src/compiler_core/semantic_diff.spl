# Semantic Diff
#
# Compares two versions of a module's API surface to detect
# breaking changes, additions, removals, and modifications.
# Used for incremental compilation and API compatibility checking.
#
# Port of rust/compiler/src/semantic_diff.rs (770 lines)

export ChangeKind, ImpactLevel, SemanticChange, DiffSummary
export SemanticDiffer, SymbolInfo

# ============================================================================
# Types
# ============================================================================

enum ChangeKind:
    Added
    Removed
    TypeChanged
    SignatureChanged
    VisibilityChanged
    DefaultValueChanged
    ReturnTypeChanged
    ParamAdded
    ParamRemoved
    ParamTypeChanged
    ParamRenamed
    FieldAdded
    FieldRemoved
    FieldTypeChanged
    VariantAdded
    VariantRemoved
    ImplementationChanged
    DocChanged

enum ImpactLevel:
    Breaking     # Requires dependents to recompile and possibly change code
    Major        # Requires dependents to recompile
    Minor        # No action needed for dependents
    Info         # Informational only (doc changes, etc.)


# ============================================================================
# ImpactLevel Methods (was: impl ImpactLevel:)
# ============================================================================

fn change_impact(kind: ChangeKind) -> ImpactLevel:
    match kind:
        case Removed: ImpactLevel.Breaking
        case TypeChanged: ImpactLevel.Breaking
        case SignatureChanged: ImpactLevel.Breaking
        case ReturnTypeChanged: ImpactLevel.Breaking
        case ParamRemoved: ImpactLevel.Breaking
        case ParamTypeChanged: ImpactLevel.Breaking
        case FieldRemoved: ImpactLevel.Breaking
        case FieldTypeChanged: ImpactLevel.Breaking
        case VariantRemoved: ImpactLevel.Breaking
        case VisibilityChanged: ImpactLevel.Major
        case Added: ImpactLevel.Minor
        case DefaultValueChanged: ImpactLevel.Minor
        case ParamAdded: ImpactLevel.Minor
        case ParamRenamed: ImpactLevel.Minor
        case FieldAdded: ImpactLevel.Minor
        case VariantAdded: ImpactLevel.Minor
        case ImplementationChanged: ImpactLevel.Minor
        case DocChanged: ImpactLevel.Info

# ============================================================================
# Symbol Info
# ============================================================================

struct SymbolInfo:
    name: text
    kind: text           # "function", "struct", "class", "enum", "trait"
    visibility: text     # "public", "private", "internal"
    # DESUGARED: signature: text?
    has_signature: bool
    signature_value: text
    fields: [text]       # For structs/classes: field names
    variants: [text]     # For enums: variant names
    # DESUGARED: return_type: text?
    has_return_type: bool
    return_type_value: text
    param_names: [text]
    param_types: [text]

# ============================================================================
# Semantic Change
# ============================================================================

struct SemanticChange:
    symbol: text
    kind: ChangeKind
    impact: ImpactLevel
    # DESUGARED: old_value: text?
    has_old_value: bool
    old_value_value: text
    # DESUGARED: new_value: text?
    has_new_value: bool
    new_value_value: text
    message: text


# ============================================================================
# SemanticChange Methods (was: impl SemanticChange:)
# ============================================================================

# ============================================================================
# Diff Summary
# ============================================================================

struct DiffSummary:
    changes: [SemanticChange]
    breaking_count: i64
    major_count: i64
    minor_count: i64
    info_count: i64


# ============================================================================
# DiffSummary Methods (was: impl DiffSummary:)
# ============================================================================

fn diffsummary_from_changes(changes: [SemanticChange]) -> DiffSummary:
        var breaking = 0
        var major = 0
        var minor = 0
        var info = 0
        for c in changes:
            match c.impact:
                case Breaking: breaking = breaking + 1
                case Major: major = major + 1
                case Minor: minor = minor + 1
                case Info: info = info + 1
        DiffSummary(changes: changes, breaking_count: breaking,
                     major_count: major, minor_count: minor, info_count: info)


# ============================================================================
# Semantic Differ
# ============================================================================

class SemanticDiffer:
    """Compares two versions of symbols to produce semantic diff."""
    changes: [SemanticChange]


# ============================================================================
# SemanticDiffer Methods (was: impl SemanticDiffer:)
# ============================================================================

fn semanticdiffer_create() -> SemanticDiffer:
        SemanticDiffer(changes: [])

