# HIR Lowering - Types and Error Handling
#
# This module contains type definitions and error handling for HIR lowering.

use hir_types.*
use hir_definitions.*
use parser.*
use lexer.Span
use blocks.{BlockValue, BlockRegistry, block_registry}
use config.{TypeInferenceConfig, TypeDefault}
use compiler.visibility.{effective_visibility}

# HIR Lowering Context
# ============================================================================

class HirLowering:
    """Lowers AST to HIR."""
    symbols: SymbolTable
    errors: [LoweringError]
    current_function: SymbolId
    loop_depth: i64
    type_inference_config: TypeInferenceConfig
    module_filename: text    # Filename for visibility matching (e.g., "test_case.spl")

struct LoweringError:
    """Error during lowering."""
    message: text
    span: Span
    kind: LoweringErrorKind

"""Lowering error kind."""
enum LoweringErrorKind:
    UnresolvedName
    DuplicateDefinition
    TypeMismatch
    InvalidPattern
    InvalidExpression
    Other


# ============================================================================
# HirLowering Methods (was: impl HirLowering:)
# ============================================================================

fn hirlowering_new() -> HirLowering:
        HirLowering(
            symbols: symboltable_new(),
            errors: [],
            #  # DESUGARED: current_function: nil
            loop_depth: 0,
            #  # DESUGARED: type_inference_config: nil
            module_filename: ""
        )


fn hirlowering_with_filename(filename: text) -> HirLowering:
        """Create HIR lowering with filename for visibility matching."""
        HirLowering(
            symbols: symboltable_new(),
            errors: [],
            #  # DESUGARED: current_function: nil
            loop_depth: 0,
            #  # DESUGARED: type_inference_config: nil
            module_filename: filename
        )


fn hirlowering_with_config(config: TypeInferenceConfig) -> HirLowering:
        HirLowering(
            symbols: symboltable_new(),
            errors: [],
            #  # DESUGARED: current_function: nil
            loop_depth: 0,
            # # DESUGARED: type_inference_config: Some(config)
            type_inference_config: config,
            module_filename: ""
        )


fn hirlowering_lower_type(self: HirLowering, t: Type) -> HirType:
        """Lower type expression."""
        val kind = match t.kind:
            case Named(name, args):
                val hir_args = self.lower_type_list(args)

                # Check for builtin types
                match name:
                    case "i8": HirTypeKind.Int(8, true)
                    case "i16": HirTypeKind.Int(16, true)
                    case "i32": HirTypeKind.Int(32, true)
                    case "i64": HirTypeKind.Int(64, true)
                    case "u8": HirTypeKind.Int(8, false)
                    case "u16": HirTypeKind.Int(16, false)
                    case "u32": HirTypeKind.Int(32, false)
                    case "u64": HirTypeKind.Int(64, false)
                    case "f32": HirTypeKind.Float(32)
                    case "f64": HirTypeKind.Float(64)
                    case "bool": HirTypeKind.Bool
                    case "char": HirTypeKind.Char
                    case "text": HirTypeKind.Str
                    case "str": HirTypeKind.Str
                    case "String": HirTypeKind.Str
                    case _:
                        val symbol = self.symbols_lookup(symbols, name)
                        if has_symbol:
                            hirtypekind_Named(symbol_value, hir_args)
                        else:
                            self.error("unresolved type: {name}", t.span)
                            HirTypeKind.Error

            case Tuple(elements):
                if elements_is_empty(elements):
                    HirTypeKind.Unit
                else:
                    hirtypekind_Tuple(self.lower_type_list(elements))

            case Array(element, size):
                val hir_element = self.lower_type(element)
                hirtypekind_Array(hir_element, nil)

            case Function(params, ret):
                val hir_params = self.lower_type_list(params)
                val hir_ret = self.lower_type(ret)
                hirtypekind_Function(hir_params, hir_ret, [])

            case Optional(inner):
                hirtypekind_Optional(self.lower_type(inner))

            case Reference(inner, mutable):
                hirtypekind_Ref(self.lower_type(inner), mutable)

            case Infer:
                hirtypekind_Infer(0, 0)

            case Error:
                HirTypeKind.Error

        HirType(kind: kind, span: t.span)


fn hirlowering_lower_type_param(self: HirLowering, tp: TypeParam) -> HirTypeParam:
        """Lower type parameter."""
        # Workaround: Store symbols in local var to avoid interpreter bug
        var symbols_table = self.symbols
        val symbol = symbols_table_define(symbols_table, tp.name, SymbolKind.TypeParam, nil, tp.span, false, false, nil)
        self.symbols = symbols_table

        var bounds: [HirType] = []
        for b in tp.bounds:
            bounds = bounds_push(bounds, self.lower_type(b))

        HirTypeParam(
            symbol: symbol,
            name: tp.name,
            bounds: bounds,
            default: tp.default_map(default, \t: self.lower_type(t)),
            span: tp.span
        )


fn hirlowering_lower_trait_bound(self: HirLowering, bound: TraitBound) -> HirTraitBound:
        """Lower trait bound to HIR.

        Converts AST trait bound (T: Trait) to HIR representation.
        """
        # Lookup the type parameter symbol
        val type_param_symbol = self.symbols_lookup(symbols, bound.type_param).unwrap()

        # Lower the trait type
        val trait_type = self.lower_type(bound.trait_)

        HirTraitBound(
            type_param: type_param_symbol,
            trait_: trait_type,
            span: bound.span
        )


# ============================================================================
# Exports
# ============================================================================

export HirLowering, LoweringError, LoweringErrorKind
