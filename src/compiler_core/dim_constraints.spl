# Dimension Constraints - Compile-time Dimension Checking
#
# This module implements the dimension constraint solver for tensor shape checking.
# Features:
# - Compile-time dimension validation
# - Dimension unification and inference
# - Error diagnostics with suggestions
# - Runtime dimension check generation
#
# Constraint type definitions are in dim_constraints_types.spl

use compiler.hir.{DimExpr, DimExprKind, HirType, DeviceType}
use compiler.lexer.Span
use dim_constraints_types.*

struct DimSolver:
    """Constraint solver for dimension checking."""
    constraints: [DimConstraint]
    substitution: Dict<i64, DimExpr>  # Var id -> resolved dimension
    next_var_id: i64
    errors: [DimError]


# ============================================================================
# DimSolver Methods (was: impl DimSolver:)
# ============================================================================

fn dimsolver_new() -> DimSolver:
        DimSolver(
            constraints: [],
            substitution: {},
            next_var_id: 0,
            errors: []
        )


fn dimsolver_fresh_var(self: DimSolver, span: Span) -> DimExpr:
        """Create a fresh dimension variable."""
        val id = self.next_var_id
        self.next_var_id = self.next_var_id + 1
        dimexpr_var(id, span)


# ============================================================================
# Dimension Expression Formatting
# ============================================================================


# ============================================================================
# DimExpr Methods (was: impl DimExpr:)
# ============================================================================

fn format_shape(dims: [DimExpr]) -> text:
    """Format a shape as [d1, d2, ...]."""
    # Stub: Complex dimension formatting not supported in seed_cpp
    "[]"

# ============================================================================
# Where Clause Types (for dimension contracts)
# ============================================================================

struct WhereClause:
    """Where clause containing dimension constraints."""
    constraints: [DimClause]
    span: Span

"""Dimension constraint in where clause."""
enum DimClause:
    DimEqual(left: DimExpr, right: DimExpr)
    DimRange(dim: text, lo: i64, hi: i64)
    DimMin(dim: text, min: i64)
    DimMax(dim: text, max: i64)


# ============================================================================
# WhereClause Methods (was: impl WhereClause:)
# ============================================================================

# ============================================================================
# Runtime Dimension Checking
# ============================================================================

"""Configuration for when dimension checks are performed.

Used to control the balance between safety and performance.
"""
enum DimCheckMode:
    # No runtime checks (production mode, fastest)
    None_

    # Debug assertions - panic on mismatch (development mode)
    Assert

    # Log warning but continue (monitoring mode)
    Log

    # Strict mode - return error on mismatch (safest)
    Strict

struct RuntimeDimCheck:
    """Generated runtime dimension check.

    These are inserted into the code after static analysis to verify
    dynamic dimensions at runtime before training/inference.
    """
    kind: RuntimeDimCheckKind
    span: Span
    error_message: text

"""Kind of runtime dimension check."""
enum RuntimeDimCheckKind:
    # Check that two shapes are equal
    ShapeEqual(left_expr: text, right_expr: text)

    # Check that a dimension has a specific value
    DimEqual(dim_expr: text, expected: i64)

    # Check that a dimension is in range
    DimRange(dim_expr: text, lo: i64, hi: i64)

    # Check that layer output matches next layer input
    LayerCompat(output_shape_expr: text, input_shape_expr: text)


# ============================================================================
# RuntimeDimCheck Methods (was: impl RuntimeDimCheck:)
# ============================================================================

struct DimCheckGenerator:
    """Generates runtime dimension checks for dynamic dimensions.

    Used during code generation to insert runtime checks where
    compile-time verification is not possible.
    """
    mode: DimCheckMode
    checks: [RuntimeDimCheck]


# ============================================================================
# DimCheckGenerator Methods (was: impl DimCheckGenerator:)
# ============================================================================

fn dimcheckgenerator_new(mode: DimCheckMode) -> DimCheckGenerator:
        DimCheckGenerator(mode: mode, checks: [])


# ============================================================================
# Compile-time vs Runtime Decision
# ============================================================================


# ============================================================================
# DimSolver Methods (was: impl DimSolver:)
# ============================================================================

"""When a dimension check can be performed."""
enum DimCheckTiming:
    CompileTime     # Fully static, check at compile time
    Runtime         # Dynamic, must check at runtime
    Both            # Partially static, check what we can at compile time

# ============================================================================
# Exports
# ============================================================================

export DimConstraint, DimError, DimErrorKind, DimNote, DimNoteKind
export DimSolver, DimCheckTiming
export WhereClause, DimClause
export DimCheckMode, RuntimeDimCheck, RuntimeDimCheckKind, DimCheckGenerator
export format_shape

# ============================================================================
# Exports
# ============================================================================

export DimSolver, WhereClause, DimClause
export DimCheckMode, RuntimeDimCheck, RuntimeDimCheckKind
export DimCheckGenerator, DimCheckTiming
