# Module Rewriter
#
# Applies monomorphization by rewriting generic call sites to use
# mangled names for specialized functions, and adding specialized
# definitions to the module.
#
# Port of rust/compiler/src/monomorphize/rewriter.rs (80+ lines)

export CallRewrite, ModuleRewriter, monomorphize_module

use monomorphize.engine.*
use monomorphize.analyzer.*

# ============================================================================
# Types
# ============================================================================

struct CallRewrite:
    original_name: text
    type_args: [ConcreteType]
    mangled_name: text

# ============================================================================
# Module Rewriter
# ============================================================================

class ModuleRewriter:
    """Rewrites call sites to use mangled names for specialized generics."""
    rewrites: {text: [CallRewrite]}


# ============================================================================
# ModuleRewriter Methods (was: impl ModuleRewriter:)
# ============================================================================

fn modulerewriter_create() -> ModuleRewriter:
        ModuleRewriter(rewrites: {})


# ============================================================================
# Pipeline
# ============================================================================

fn monomorphize_module(generic_names: [text], call_sites: [CallSite]) -> (Monomorphizer, ModuleRewriter):
    """Run the full monomorphization pipeline.

    1. Collect call sites
    2. Request specializations
    3. Process pending
    4. Build rewrite table
    """
    var mono = monomorphizer_create()
    var rewriter = modulerewriter_create()

    for site in call_sites:
        val mangled = mono_specialize_function_call(mono, site.function_name, site.type_args)
        if has_mangled:
            rewriter_add_rewrite(rewriter, site.function_name, site.type_args, mangled_value)

    mono_process_pending(mono)
    (mono, rewriter)
