# Monomorphization Cache
#
# Caches specialized function/struct/class definitions by specialization key.
# Content-based keys derived from definition hash + type arguments + mtime.
# Supports LRU eviction and optional disk persistence.
#
# Port of rust/compiler/src/monomorphize/cache.rs (100+ lines)

export MonoCacheConfig, MonoCacheStats, MonoCache

# ============================================================================
# Configuration
# ============================================================================

struct MonoCacheConfig:
    max_entries: i64
    validate_timestamps: bool
    persist_to_disk: bool
    # DESUGARED: cache_dir: text?
    has_cache_dir: bool
    cache_dir_value: text


# ============================================================================
# MonoCacheConfig Methods (was: impl MonoCacheConfig:)
# ============================================================================

fn monocacheconfig_default_config() -> MonoCacheConfig:
        MonoCacheConfig(max_entries: 10000, validate_timestamps: true,
                        persist_to_disk: false, cache_dir: nil)


fn monocacheconfig_memory_only() -> MonoCacheConfig:
        MonoCacheConfig(max_entries: 10000, validate_timestamps: true,
                        persist_to_disk: false, cache_dir: nil)


fn monocacheconfig_persistent(cache_dir: text) -> MonoCacheConfig:
        MonoCacheConfig(max_entries: 50000, validate_timestamps: true,
                        persist_to_disk: true, # DESUGARED: cache_dir: Some(cache_dir))
            has_cache_dir: true,
            cache_dir_value: cache_dir)


# ============================================================================
# Statistics
# ============================================================================

struct MonoCacheStats:
    hits: i64
    misses: i64
    evictions: i64
    invalidations: i64
    function_entries: i64
    struct_entries: i64
    class_entries: i64


# ============================================================================
# MonoCacheStats Methods (was: impl MonoCacheStats:)
# ============================================================================

fn monocachestats_empty() -> MonoCacheStats:
        MonoCacheStats(hits: 0, misses: 0, evictions: 0, invalidations: 0,
                       function_entries: 0, struct_entries: 0, class_entries: 0)


# ============================================================================
# Cache Entry
# ============================================================================

struct CacheEntry:
    key: text
    value: Any
    last_access: i64
    content_hash: i64

# ============================================================================
# Mono Cache
# ============================================================================

class MonoCache:
    """Cache for monomorphization results."""
    config: MonoCacheConfig
    entries: {text: CacheEntry}
    stats: MonoCacheStats


# ============================================================================
# MonoCache Methods (was: impl MonoCache:)
# ============================================================================

fn monocache_create(config: MonoCacheConfig) -> MonoCache:
        MonoCache(config: config, entries: {}, stats: monocachestats_empty())

