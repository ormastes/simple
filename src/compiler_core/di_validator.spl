# DI Constructor Injection Validator
#
# Validates dependency injection rules for constructors:
# - All-or-nothing rule: All params injectable or none
# - No mixing @sys.inject with @inject annotations
# - Parameter-level diagnostics

export DiValidationError, DiErrorKind, DiValidator
export validate_constructor, validate_class_injection

# ============================================================================
# Error Types
# ============================================================================

enum DiErrorKind:
    """Types of DI validation errors."""
    MixedInjection          # Some params have @inject, others don't
    MixedAnnotations        # Both @sys.inject and @inject used
    InvalidInjectionPoint   # @inject in wrong location
    CircularDependency      # Circular dependency detected
    AmbiguousBinding        # Multiple bindings match
    NoBinding               # No binding found

struct DiValidationError:
    """Detailed DI validation error."""
    kind: DiErrorKind
    message: text
    constructor_name: text
    params: [text]          # Parameter names involved
    # # DESUGARED: suggestion: text
    has_suggestion: bool
    suggestion: text


# ============================================================================
# DiValidationError Methods (was: impl DiValidationError:)
# ============================================================================

# ============================================================================
# Constructor Parameter Info
# ============================================================================

struct ParamInfo:
    """Information about a constructor parameter."""
    name: text
    type_name: text
    has_inject: bool        # Has @inject annotation
    is_injectable: bool     # Type is Injectable


# ============================================================================
# ParamInfo Methods (was: impl ParamInfo:)
# ============================================================================

fn paraminfo_create(name: text, type_name: text, has_inject: bool) -> ParamInfo:
        ParamInfo(name: name, type_name: type_name,
                  has_inject: has_inject, is_injectable: false)


struct ConstructorInfo:
    """Information about a constructor."""
    class_name: text
    has_sys_inject: bool    # Class has @sys.inject
    params: [ParamInfo]


# ============================================================================
# ConstructorInfo Methods (was: impl ConstructorInfo:)
# ============================================================================

# ============================================================================
# DI Validator
# ============================================================================

class DiValidator:
    """Validates DI injection rules for constructors."""


# ============================================================================
# DiValidator Methods (was: impl DiValidator:)
# ============================================================================

fn divalidator_create() -> DiValidator:
        DiValidator()


# ============================================================================
# Validation Functions
# ============================================================================

fn validate_constructor(ctor: ConstructorInfo) -> text:
    """Validate a constructor's DI rules."""
    # Stub: DiValidator methods not supported in seed_cpp
    ""

fn validate_class_injection(class_name: text, has_sys_inject: bool,
                            field_types: [text]) -> text:
    """Validate @sys.inject on a class."""
    # Stub: DiValidator validation methods not supported in seed_cpp
    ""

# ============================================================================
# Diagnostic Formatting
# ============================================================================

fn format_di_error(error: DiValidationError) -> text:
    """Format DI validation error for compiler output."""
    error_format(error)

fn get_error_code(kind: DiErrorKind) -> text:
    """Get error code for diagnostic."""
    match kind:
        case MixedInjection: "E:DI001"
        case MixedAnnotations: "E:DI002"
        case InvalidInjectionPoint: "E:DI003"
        case CircularDependency: "E:DI004"
        case AmbiguousBinding: "E:DI005"
        case NoBinding: "E:DI006"

# ============================================================================
# Integration with Compiler
# ============================================================================

# NOTE: This module should be called during HIR -> MIR lowering
# when processing constructor definitions:
#
# Example integration:
#   val ctor_info = extract_constructor_info(hir_class)
#   val result = validate_constructor(ctor_info)
#   match result:
#       case Err(error):
#           emit_diagnostic(get_error_code(error.kind), error.format())
#       case Ok(()):
#           # Continue with lowering
