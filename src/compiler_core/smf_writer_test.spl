# Extended SMF writer with template section support (v1[1])
#
# This module extends the basic SMF builder to include:
# - TemplateCode sections (serialized generic definitions)
# - TemplateMeta sections (monomorphization metadata)
# - ⭐ Trailer-based header design (like ZIP format)
# - Compression support (default: 0 = no compression)
# - Executable SMF support (stub fields)
#
# v1[1] Design: Header written at EOF-128 (trailer), not at offset 0.
# This enables directly executable SMF files (prepend shebang/stub).
#
# Enables .smf files to store both native code AND templates for deferred instantiation.

use monomorphize.partition (GenericTemplates)
use monomorphize.metadata (MonomorphizationMetadata)
use monomorphize.note_sdn (NoteSdnMetadata)
use compiler.ast (FunctionDef, StructDef, ClassDef, EnumDef, TraitDef)
use linker.smf_header (SmfHeader, SMF_FLAG_EXECUTABLE)
use linker.smf_enums (Platform, Arch)
use std.platform.{get_host_os, get_host_arch}

# Target platform information
struct Target:
    os: text        # "linux", "windows", "macos"
    arch: text      # "x86_64", "aarch64", "riscv64"


# ============================================================================
# Target Methods (was: impl Target:)
# ============================================================================

fn target_host() -> Target:
        # Platform detection using std.platform (Phase 2[1] - TODO #162 ✅)
        Target(os: get_host_os(), arch: get_host_arch())


fn target_x86_64_unknown_linux_gnu() -> Target:
        Target(os: "linux", arch: "x86_64")


fn target_aarch64_unknown_linux_gnu() -> Target:
        Target(os: "linux", arch: "aarch64")


# SMF build options - groups common parameters
struct SmfBuildOptions:
    # # DESUGARED: templates: GenericTemplates
    has_templates: bool
    templates: GenericTemplates
    # # DESUGARED: metadata: MonomorphizationMetadata
    has_metadata: bool
    metadata: MonomorphizationMetadata
    # # DESUGARED: note_sdn: NoteSdnMetadata
    has_note_sdn: bool
    note_sdn: NoteSdnMetadata
    target: Target


# ============================================================================
# SmfBuildOptions Methods (was: impl SmfBuildOptions:)
# ============================================================================

fn smfbuildoptions_create(target: Target) -> SmfBuildOptions:
        SmfBuildOptions(
            #  # DESUGARED: templates: nil
            #  # DESUGARED: metadata: nil
            #  # DESUGARED: note_sdn: nil
            target: target
        )


export Target
