# HIR Lowering - Async/Await Error Diagnostics
#
# This module provides detailed error messages for async/await issues:
# - Type mismatch errors
# - Missing Future wrapper
# - Invalid state machine structure
# - Poll function signature errors
# - Helpful suggestions and examples

use hir_types.*
use lexer.Span

# ================================================================
# Error Types
# ================================================================

"""Async/await specific error codes."""
enum AsyncErrorCode:
    E0701  # Async function must return Future<T>
    E0702  # Type mismatch in state machine
    E0703  # Invalid state transition
    E0704  # Poll function signature wrong
    E0705  # Future type parameter mismatch
    E0706  # Missing await in async function
    E0707  # Await used outside async function
    E0708  # Invalid state enum structure
    E0709  # Future not found in scope
    E0710  # Poll type not found in scope

impl AsyncErrorCode:
    fn code() -> text:
        """Get error code as string.

        Returns:
            Error code like "E0701"
        """
        match self:
            case E0701: "E0701"
            case E0702: "E0702"
            case E0703: "E0703"
            case E0704: "E0704"
            case E0705: "E0705"
            case E0706: "E0706"
            case E0707: "E0707"
            case E0708: "E0708"
            case E0709: "E0709"
            case E0710: "E0710"

struct AsyncError:
    """Detailed async/await error with helpful messages.

    Contains:
    - Error code (E0701-E0710)
    - Main error message
    - Source span
    - Helpful suggestion
    - Example code (optional)
    """
    code: AsyncErrorCode
    message: text
    span: Span
    help: text?
    note: text?
    suggestion: text?

impl AsyncError:
    fn format() -> text:
        """Format error for display.

        Returns:
            Formatted error message with code, message, help, etc.

        Example output:
            error[E0701]: async function must return Future<T>
              --> example.spl:5:20
               |
            5  | async fn fetch() -> text:
               |                     ^^^^ expected Future<text>, found text
               |
               = help: change return type to Future<text>
               = note: async functions automatically wrap return values
        """
        var lines = []

        # Error header with code
        lines = lines.push("error[{self.code.code()}]: {self.message}")

        # Source location
        lines = lines.push("  --> {self.span.format()}")

        # Help message
        if self.help.?:
            lines = lines.push("   |")
            lines = lines.push("   = help: {self.help}")

        # Note
        if self.note.?:
            lines = lines.push("   = note: {self.note}")

        # Suggestion
        if self.suggestion.?:
            lines = lines.push("   = suggestion:")
            lines = lines.push("   |")
            lines = lines.push("   | {self.suggestion}")

        lines.join("\n")

# ================================================================
# Error Constructors
# ================================================================

fn async_fn_must_return_future(
    func_name: text,
    found_type: text,
    expected_type: text,
    span: Span
) -> AsyncError:
    """Error: async function doesn't return Future<T>.

    Args:
        func_name: Name of the async function
        found_type: What the function actually returns
        expected_type: What it should return (Future<...>)
        span: Source location

    Returns:
        Formatted error with helpful suggestions

    Example:
        async fn fetch() -> text:
                            ^^^^ error here

        Error message:
        error[E0701]: async function must return Future<T>
          --> example.spl:5:20
           |
           = help: change return type to Future<text>
           = note: async functions automatically wrap return values
    """
    AsyncError(
        code: AsyncErrorCode.E0701,
        message: "async function '{func_name}' must return Future<T>",
        span: span,
        help: "change return type to {expected_type}",
        note: "async functions automatically wrap return values in Future",
        suggestion: "async fn {func_name}() -> {expected_type}:"
    )

fn type_mismatch_in_state(
    state_name: text,
    field_name: text,
    expected_type: text,
    found_type: text,
    span: Span
) -> AsyncError:
    """Error: type mismatch in state field.

    Args:
        state_name: Name of the state variant
        field_name: Name of the field
        expected_type: Expected type
        found_type: Actual type
        span: Source location

    Returns:
        Error with type details

    Example:
        State1(x: "text")  // x should be i64
               ^^^^^^ error here

        error[E0702]: type mismatch in state field
          --> generated.spl:12:15
           |
           = help: field 'x' in State1 expects type i64
           = note: this field preserves the value of variable 'x' across suspension
    """
    AsyncError(
        code: AsyncErrorCode.E0702,
        message: "type mismatch in state field '{field_name}'",
        span: span,
        help: "field '{field_name}' in {state_name} expects type {expected_type}",
        note: "state fields preserve variable values across await suspension points",
        suggestion: "{state_name}({field_name}: <{expected_type} value>)"
    )

fn poll_function_wrong_signature(
    func_name: text,
    issue: text,
    span: Span
) -> AsyncError:
    """Error: poll function has wrong signature.

    Args:
        func_name: Name of the poll function
        issue: Description of what's wrong
        span: Source location

    Returns:
        Error explaining correct signature

    Example:
        fn poll_fetch(state) -> Poll<text>:
                      ^^^^^ error: missing waker parameter

        error[E0704]: poll function has invalid signature
          --> generated.spl:8:19
           |
           = help: poll function must have signature: (State, Waker) -> (State, Poll<T>)
           = note: waker parameter is required to wake the task when ready
    """
    AsyncError(
        code: AsyncErrorCode.E0704,
        message: "poll function '{func_name}' has invalid signature: {issue}",
        span: span,
        help: "poll function must have signature: (StateEnum, Waker) -> (StateEnum, Poll<T>)",
        note: "the poll function drives the async state machine",
        suggestion: "fn {func_name}(state: StateEnum, waker: Waker) -> (StateEnum, Poll<T>):"
    )

fn future_type_param_mismatch(
    func_name: text,
    future_inner: text,
    poll_inner: text,
    span: Span
) -> AsyncError:
    """Error: Future<T> and Poll<T> inner types don't match.

    Args:
        func_name: Name of the async function
        future_inner: T in Future<T>
        poll_inner: T in Poll<T>
        span: Source location

    Returns:
        Error explaining type mismatch

    Example:
        fn fetch() -> Future<text>
        fn poll_fetch(...) -> (..., Poll<i64>)
                                    ^^^^^^^^ error: type mismatch

        error[E0705]: type parameter mismatch between Future and Poll
          --> generated.spl:15:37
           |
           = help: poll function returns Poll<i64>, but async function expects Future<text>
           = note: the inner types must match
    """
    AsyncError(
        code: AsyncErrorCode.E0705,
        message: "type parameter mismatch in '{func_name}'",
        span: span,
        help: "async function returns Future<{future_inner}>, \
               but poll function returns Poll<{poll_inner}>",
        note: "the inner type T must be the same in both Future<T> and Poll<T>",
        suggestion: nil
    )

fn await_outside_async(
    span: Span
) -> AsyncError:
    """Error: await used outside async function.

    Args:
        span: Source location of the await

    Returns:
        Error with suggestion to add async

    Example:
        fn fetch():
            val data = await get_data()
                       ^^^^^ error here

        error[E0707]: await can only be used in async functions
          --> example.spl:12:16
           |
           = help: mark the containing function as 'async fn'
           = note: await suspends execution until a Future is ready
    """
    AsyncError(
        code: AsyncErrorCode.E0707,
        message: "await can only be used in async functions",
        span: span,
        help: "mark the containing function as 'async fn'",
        note: "await suspends execution until a Future completes",
        suggestion: "async fn function_name() -> Future<T>:"
    )

fn invalid_state_enum_structure(
    enum_name: text,
    issue: text,
    span: Span
) -> AsyncError:
    """Error: state enum has invalid structure.

    Args:
        enum_name: Name of the state enum
        issue: What's wrong with it
        span: Source location

    Returns:
        Error explaining valid structure

    Example:
        enum FetchState:
            # no variants!

        error[E0708]: invalid state enum structure
          --> generated.spl:5:1
           |
           = help: state enum must have at least State0 variant
           = note: state machines require an initial state
    """
    AsyncError(
        code: AsyncErrorCode.E0708,
        message: "invalid state enum structure for '{enum_name}': {issue}",
        span: span,
        help: "state enum must have at least State0 (initial state)",
        note: "each suspension point creates an additional state variant",
        suggestion: "enum {enum_name}:\n    State0  # Initial state"
    )

fn future_type_not_found(
    span: Span
) -> AsyncError:
    """Error: Future type not found in scope.

    Args:
        span: Source location

    Returns:
        Error suggesting to import std.async

    Example:
        async fn fetch() -> text:
        # Future type not in scope!

        error[E0709]: Future type not found
          --> example.spl:5:1
           |
           = help: import Future from std.async.future
           = note: add 'use std.async.future.Future' at the top of your file
    """
    AsyncError(
        code: AsyncErrorCode.E0709,
        message: "Future type not found in scope",
        span: span,
        help: "import Future from std.async.future",
        note: "async functions require the Future type to be in scope",
        suggestion: "use std.async.future.Future"
    )

fn poll_type_not_found(
    span: Span
) -> AsyncError:
    """Error: Poll type not found in scope.

    Args:
        span: Source location

    Returns:
        Error suggesting to import std.async

    Example:
        fn poll_fetch(...) -> (..., Poll<T>):
                                    ^^^^ not found

        error[E0710]: Poll type not found
          --> example.spl:8:37
           |
           = help: import Poll from std.async.poll
           = note: poll functions require the Poll enum
    """
    AsyncError(
        code: AsyncErrorCode.E0710,
        message: "Poll type not found in scope",
        span: span,
        help: "import Poll from std.async.poll",
        note: "poll functions use Poll<T> to represent Ready/Pending states",
        suggestion: "use std.async.poll.Poll"
    )

# ================================================================
# Error Collection
# ================================================================

struct AsyncErrorCollector:
    """Collects async/await errors during validation.

    Provides methods to add errors and format them for display.
    """
    errors: [AsyncError]

impl AsyncErrorCollector:
    static fn new() -> AsyncErrorCollector:
        AsyncErrorCollector(errors: [])

    me add(error: AsyncError):
        """Add an error to the collection."""
        self.errors = self.errors.push(error)

    fn has_errors() -> bool:
        """Check if any errors were collected."""
        self.errors.len() > 0

    fn count() -> i64:
        """Get number of errors."""
        self.errors.len()

    fn format_all() -> text:
        """Format all errors for display.

        Returns:
            All errors formatted and joined with blank lines
        """
        self.errors.map(\e: e.format()).join("\n\n")

    fn get_codes() -> [text]:
        """Get list of error codes.

        Returns:
            List of error codes like ["E0701", "E0702"]
        """
        self.errors.map(\e: e.code.code())

# ================================================================
# Exports
# ================================================================

export AsyncErrorCode
export AsyncError
export AsyncErrorCollector
export async_fn_must_return_future
export type_mismatch_in_state
export poll_function_wrong_signature
export future_type_param_mismatch
export await_outside_async
export invalid_state_enum_structure
export future_type_not_found
export poll_type_not_found
