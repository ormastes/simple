# Block Utilities - Text Transformations
#
# Common text transformation functions:
# - Variable interpolation
# - Indent stripping
# - Newline normalization

use std.string.{NL}

# ============================================================================
# Common Text Transformations
# ============================================================================

fn interpolate_variables(text: text, vars: Dict<text, text>) -> text:
    """Interpolate variables in template text.

    Replaces {varname} with values from dict.

    Args:
        text: Template text with {varname} placeholders
        vars: Dictionary of variable values

    Returns:
        Interpolated text

    Example:
    ```simple
    val template = "Hello {name}, you are {age} years old"
    val result = interpolate_variables(template, {
        "name": "Alice",
        "age": "30"
    })
    # Result: "Hello Alice, you are 30 years old"
    ```
    """
    var result = text

    for (key, value) in vars.items():
        val placeholder = "{{{key}}}"
        result = result.replace(placeholder, value)

    result

fn strip_indent(text: text) -> text:
    """Strip common leading indentation from text.

    Args:
        text: Text with indentation

    Returns:
        Text with common indent removed

    Example:
    ```simple
    val code = '''
            fn main():
                print "hello"
        '''
    val stripped = strip_indent(code)
    # Result: "fn main():\n    print \"hello\""
    ```
    """
    val lines = text.split(NL)

    # Find minimum indentation (ignoring empty lines)
    var min_indent = 999999
    for line in lines:
        if line.trim().?:
            val indent = line.len() - line.trim_start().len()
            if indent < min_indent:
                min_indent = indent

    # Strip that amount from each line
    lines.map(\line:
        if line.len() >= min_indent:
            line[min_indent:]
        else:
            line
    ).join(NL)

fn normalize_newlines(text: text) -> text:
    """Normalize line endings to \n.

    Converts \r\n (Windows) and \r (old Mac) to \n.

    Args:
        text: Text with mixed line endings

    Returns:
        Text with normalized \n line endings
    """
    text.replace("\r\n", NL).replace("\r", NL)

# ============================================================================
# Exports
# ============================================================================

export interpolate_variables, strip_indent, normalize_newlines
