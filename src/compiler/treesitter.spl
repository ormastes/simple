# TreeSitter - Tree-sitter Integration for Simple
#
# Provides fast outline parsing using tree-sitter.
# Used for:
# - Quick module structure extraction (no full parsing)
# - IDE features (outline view, quick navigation)
# - Multi-phase compilation (outline -> detailed parse)
#
# Outline type definitions are in treesitter_types.spl
#
# ============================================================================
# FACADE MODULE
# ============================================================================
#
# This module has been refactored into focused submodules:
#
# - treesitter/outline.spl   - Tree-sitter outline generation (semantic parsing)
# - treesitter/heuristic.spl - Fallback heuristic parsing (error-tolerant)
#
# This file now serves as a facade that re-exports all functionality.
# The refactoring maintains clean separation between:
#   1. Token-based tree-sitter parsing (outline.spl)
#   2. Line-based heuristic fallback (heuristic.spl)
#
# ============================================================================

use compiler.lexer.*
use treesitter_types.*
use blocks.modes.{PreLexInfo, BlockSkipPolicy, BlockOutlineInfo}
use blocks.registry.{BlockRegistry, block_registry}

# Import submodules from treesitter/ directory
use compiler.treesitter.outline.{TreeSitter, TopLevelItem}
use compiler.treesitter.heuristic.{HeuristicOutlineKind, HeuristicOutlineItem, HeuristicParseResult}

# ============================================================================
# Main Entry Point (TreeSitter extension)
# ============================================================================

impl TreeSitter:
    me parse_outline() -> OutlineModule:
        """Parse source into an outline module.

        This is the main entry point that dispatches to either:
        - Heuristic mode (line-based, error-tolerant)
        - Token-based mode (tree-sitter, accurate)
        """

        # Branch based on mode
        if self.heuristic_mode:
            return self.parse_outline_heuristic()

        # Token-based parsing (default)
        var module = OutlineModule(
            name: "",
            imports: [],
            exports: [],
            functions: [],
            classes: [],
            structs: [],
            enums: [],
            bitfields: [],
            traits: [],
            impls: [],
            type_aliases: [],
            constants: [],
            static_asserts: [],
            inline_blocks: [],
            errors: []
        )

        while not self.is_at_end():
            self.skip_newlines()
            if self.is_at_end():
                break

            val item = self.parse_top_level_item()
            match item:
                case TopLevelItem.Import(i):
                    module.imports = module.imports.push(i)
                case TopLevelItem.Export(e):
                    module.exports = module.exports.push(e)
                case TopLevelItem.Function(f):
                    module.functions = module.functions.push(f)
                case TopLevelItem.Class(c):
                    module.classes = module.classes.push(c)
                case TopLevelItem.Struct(s):
                    module.structs = module.structs.push(s)
                case TopLevelItem.Enum(e):
                    module.enums = module.enums.push(e)
                case TopLevelItem.Bitfield(b):
                    module.bitfields = module.bitfields.push(b)
                case TopLevelItem.Trait(t):
                    module.traits = module.traits.push(t)
                case TopLevelItem.Impl(i):
                    module.impls = module.impls.push(i)
                case TopLevelItem.TypeAlias(t):
                    module.type_aliases = module.type_aliases.push(t)
                case TopLevelItem.Const(c):
                    module.constants = module.constants.push(c)
                case TopLevelItem.StaticAssert(a):
                    module.static_asserts = module.static_asserts.push(a)
                case TopLevelItem.Error(e):
                    module.errors = module.errors.push(e)
                case _:
                    pass
        module.inline_blocks = self.inline_blocks
        module.errors = self.errors
        module

# ============================================================================
# Exports
# ============================================================================

export OutlineModule, ImportOutline, ExportOutline, BlockOutline
export FunctionOutline, ParamOutline, ClassOutline, StructOutline, FieldOutline
export EnumOutline, VariantOutline, VariantPayload
export BitfieldOutline, BitfieldFieldOutline
export TraitOutline, ImplOutline, TypeAliasOutline, ConstOutline, StaticAssertOutline
export TypeParamOutline, TypeOutline, TypeOutlineKind
export ParseError, ErrorSeverity
export TreeSitter
export HeuristicOutlineKind, HeuristicOutlineItem, HeuristicParseResult
