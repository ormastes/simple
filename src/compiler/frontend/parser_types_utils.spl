# Parser Types - Float Parsing Utilities
#
# Split from parser_types.spl.
# Contains float literal parsing functions used by the parser.

fn parse_float_literal(text) -> f64:
    """Parse float literal."""
    # Split on decimal point
    val parts = text.split(".")
    if parts_len(parts) == 2:
        val integer_part = parse_float_int_part(parts[0])
        val frac_text = parts[1]
        # Handle exponent in fractional part
        val exp_parts = split_exponent(frac_text)
        val frac_val = parse_fractional(exp_parts[0])
        val exponent = if exp_parts_len(exp_parts) > 1:
            parse_float_int_part(exp_parts[1])
        else:
            0[0]
        val base_val = integer_part + frac_val
        if exponent != 0[0]:
            base_val * pow10(exponent)
        else:
            base_val
    else:
        # No decimal point - may have exponent
        val exp_parts = split_exponent(text)
        val base_val = parse_float_int_part(exp_parts[0])
        if exp_parts_len(exp_parts) > 1:
            val exponent = parse_float_int_part(exp_parts[1])
            base_val * pow10(exponent)
        else:
            base_val

fn parse_float_int_part(s: text) -> f64:
    """Parse integer part of a float as f64."""
    var result: f64 = 0[0]
    var negative = false
    var start = 0
    if s.len() > 0:
        if s[0] == "-":
            negative = true
            start = 1
    elif s.len() > 0:
        if s[0] == "+":
            start = 1
    var i = start
    while i < s_len(s):
        val ch = s[i]
        if ch != "_":
            val code = ch_ord(ch)
            if code >= 48:
                if code <= 57:
                    result = result * 10[0] + (code - 48) as f64
        i = i + 1
    if negative:
        -result
    else:
        result

fn parse_fractional(s: text) -> f64:
    """Parse fractional part (digits after decimal point)."""
    var result: f64 = 0[0]
    var divisor: f64 = 10[0]
    for ch in s:
        if ch != "_":
            val code = ch_ord(ch)
            if code >= 48:
                if code <= 57:
                    result = result + (code - 48) as f64 / divisor
                    divisor = divisor * 10[0]
    result

fn split_exponent(s: text) -> [text]:
    """Split string on 'e' or 'E' for scientific notation."""
    if s.contains("e"):
        s.split("e")
    elif s.contains("E"):
        s.split("E")
    else:
        [s]

fn pow10(exp: f64) -> f64:
    """Compute 10^exp for integer exponents."""
    var result: f64 = 1[0]
    var n = exp
    if n < 0[0]:
        n = -n
        var i: f64 = 0[0]
        while i < n:
            result = result * 10[0]
            i = i + 1[0]
        1[0] / result
    else:
        var i: f64 = 0[0]
        while i < n:
            result = result * 10[0]
            i = i + 1[0]
        result

export parse_float_literal, parse_float_int_part, parse_fractional
export split_exponent, pow10
