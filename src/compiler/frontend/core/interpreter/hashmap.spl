# Core Interpreter — Hash Map Utilities
#
# Seed-compilable hash function and bucket initialization.
# Used by eval.spl, env.spl, and jit.spl for O(1) average lookups.
#
# Hash maps use chained hashing with parallel arrays:
#   keys: [text]     — entry keys
#   vals: [i64]      — entry values (or parallel text array for text values)
#   buckets: [i64]   — bucket heads (size HM_SIZE, -1 = empty)
#   nexts: [i64]     — next pointers for chaining (parallel with keys)
#
# Lookup: hash(key) -> bucket -> walk chain -> O(1) average
# Insert: hash(key) -> bucket -> check chain -> append or update

# ===== Constants =====
val HM_SIZE: i64 = 64         # Bucket count for global maps
val SCOPE_HM_SIZE: i64 = 16   # Bucket count for scope-level maps (smaller, faster init)

# ===== Hash Function =====
# Maps text to bucket index using first character group + string length.
# 16 character groups * 8 length classes = 128 possible values.
# Caller applies % bucket_count.

fn hm_hash_text(s: text) -> i64:
    val slen = s.len()
    if slen == 0: return 0
    val c = s[0]
    var char_idx: i64 = 15
    if c >= "a":
        if c <= "d": char_idx = 0
        elif c <= "h": char_idx = 1
        elif c <= "l": char_idx = 2
        elif c <= "p": char_idx = 3
        elif c <= "t": char_idx = 4
        elif c <= "z": char_idx = 5
    elif c >= "A":
        if c <= "F": char_idx = 6
        elif c <= "L": char_idx = 7
        elif c <= "R": char_idx = 8
        elif c <= "Z": char_idx = 9
    elif c >= "0":
        if c <= "4": char_idx = 10
        elif c <= "9": char_idx = 11
    elif c == "_": char_idx = 12
    char_idx * 8 + (slen % 8)

# ===== Bucket Initialization =====

fn hm_make_buckets(size: i64) -> [i64]:
    var buckets: [i64] = []
    var i: i64 = 0
    while i < size:
        buckets.push(-1)
        i = i + 1
    buckets

fn hm_make_global_buckets() -> [i64]:
    hm_make_buckets(HM_SIZE)

fn hm_make_scope_buckets() -> [i64]:
    hm_make_buckets(SCOPE_HM_SIZE)

export HM_SIZE, SCOPE_HM_SIZE
export hm_hash_text, hm_make_buckets, hm_make_global_buckets, hm_make_scope_buckets
