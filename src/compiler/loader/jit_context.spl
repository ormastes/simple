# JIT Compilation Context (FFI-based)
#
# Simplified JIT context that uses compiler FFI instead of deep integration.
# Templates come from SMF TemplateCode sections and are passed to compiler via FFI.

use ./compiler_ffi.*

# ============================================================================
# JitCompilationContext
# ============================================================================

struct JitCompilationContext:
    """JIT context that holds templates and uses compiler FFI."""
    compiler_ctx: CompilerContext  # FFI handle
    smf_templates: Dict<text, TemplateBytes>  # Templates from SMF
    recorded: [InstantiationRecord]  # Recorded instantiations

struct InstantiationRecord:
    """Record of a JIT instantiation."""
    template_name: text
    type_args: [TypeInfo]
    mangled_name: text
    success: bool
    error: text?

impl JitCompilationContext:
    static fn from_smf(tmpls: Dict<text, TemplateBytes>) -> JitCompilationContext:
        """Create JIT context from SMF templates.

        Args:
            tmpls: Map of template name to template bytes

        Returns:
            New JIT context with FFI compiler handle
        """
        JitCompilationContext(
            compiler_ctx: CompilerContext.create(),
            smf_templates: tmpls,
            recorded: []
        )

    fn load_template(name: text) -> Result<TemplateBytes, text>:
        """Load a template by name."""
        if self.smf_templates.contains_key(name):
            Ok(self.smf_templates[name])
        else:
            Err("Template not in SMF: {name}")

    fn has_template(name: text) -> bool:
        """Check if template exists."""
        self.smf_templates.contains_key(name)

    fn compile_template(tmpl: TemplateBytes, type_args: [TypeInfo]) -> Result<[u8], text>:
        """Compile template with type arguments via FFI.

        Args:
            tmpl: Template bytes from SMF
            type_args: Concrete type arguments

        Returns:
            Ok(code) - Compiled machine code
            Err(message) - Compilation error
        """
        self.compiler_ctx.instantiate(tmpl, type_args)

    me record_instantiation(template_name: text, type_args: [TypeInfo], mangled_name: text, success: bool, error: text?):
        """Record an instantiation attempt."""
        val record = InstantiationRecord(
            template_name: template_name,
            type_args: type_args,
            mangled_name: mangled_name,
            success: success,
            error: error
        )
        self.recorded = self.recorded.push(record)

    fn get_recorded() -> [InstantiationRecord]:
        """Get all recorded instantiations."""
        self.recorded

# ============================================================================
# Exports
# ============================================================================

export JitCompilationContext
export InstantiationRecord
