# Construct Capsule: async
#
# Groups all compiler files that handle the 'async' language construct.
# Tier: advanced (depends on func, expr, control)
# Dimension: construct (vertical second axis)
# Participation: shared_bind

use compiler.mdsoc.types.*

export async_capsule_def

fn async_capsule_def() -> ConstructCapsule:
    """Define the async construct capsule.

    Async handling spans multiple frontend and HIR files:
    - Frontend desugar: async/await desugaring (exclusive)
    - HIR async lowering (exclusive)
    - MIR async state machines (exclusive to async)
    - Shared with func (async fn is a func variant)
    """
    var cap = ConstructCapsule.new("async", ConstructKind.Async, ConstructTier.Advanced)

    # Exclusive files â€” async-specific transformations
    cap.exclusive_files = [
        "10.frontend/core/lexer.spl",
        "50.mir/mir_bitfield.spl"
    ]

    # Shared files
    val sb_parser_await = SharedBinding.new("10.frontend/core/parser_expr.spl", "expr", 10)
    val sb_ast = SharedBinding.new("10.frontend/core/ast.spl", "func", 10)
    val sb_hir = SharedBinding.new("20.hir/hir_definitions.spl", "func", 20)
    val sb_mir = SharedBinding.new("50.mir/mir_instructions.spl", "expr", 50)
    val sb_mir_data = SharedBinding.new("50.mir/mir_data.spl", "async", 50)
    val sb_parser_decls = SharedBinding.new("10.frontend/core/parser_decls.spl", "func", 10)

    cap.shared_bindings = [sb_parser_await, sb_ast, sb_hir, sb_mir, sb_mir_data, sb_parser_decls]

    # Depends on func (async fn), expr (await expr), control (async state machines)
    cap.depends_on = ["func", "expr", "control"]

    cap
