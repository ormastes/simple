# MirTextCodegen Trait - MIR-to-Text Backend Interface
#
# Shared by LLVM, C, Cranelift, and WASM backends.
# Provides default instruction dispatch that decomposes
# translate_instruction into per-category methods.
#
# Backends implement the required category methods; the default
# translate_instruction match handles routing.

use compiler.mir.mir_data.*

# ============================================================================
# MirTextCodegen Trait
# ============================================================================

trait MirTextCodegen:
    """Interface for backends that translate MIR to text-based output."""

    # === Required (each backend implements) ===
    me translate_module(module: MirModule) -> text
    me translate_function(name: text, body: MirBody)
    me translate_block(block: MirBlock)
    me translate_terminator(term: MirTerminator)

    # Per-category instruction methods (required)
    me translate_const(dest: LocalId, value: MirConstValue, ty: MirType)
    me translate_copy_move(dest: LocalId, src: LocalId, is_move: bool)
    me translate_binop(dest: LocalId, op: MirBinOp, left: MirOperand, right: MirOperand)
    me translate_unaryop(dest: LocalId, op: MirUnaryOp, operand: MirOperand)
    me translate_call(dest: LocalId, func: MirOperand, args: [MirOperand])

    # Helpers (required)
    me translate_operand(operand: MirOperand) -> text
    me translate_const_value(value: MirConstValue) -> text
    fn get_local(id: i64) -> text
    fn get_local_type(id: i64) -> text
    fn get_operand_type(operand: MirOperand) -> text

    # === Default: instruction dispatch ===
    me translate_instruction(inst: MirInst):
        match inst.kind:
            case Const(dest, value, ty): self.translate_const(dest, value, ty)
            case Copy(dest, src): self.translate_copy_move(dest, src, false)
            case Move(dest, src): self.translate_copy_move(dest, src, true)
            case BinOp(dest, op, l, r): self.translate_binop(dest, op, l, r)
            case CheckedBinOp(dest, op, l, r): self.translate_binop(dest, op, l, r)
            case UnaryOp(dest, op, operand): self.translate_unaryop(dest, op, operand)
            case Alloc(dest, ty): self.translate_alloc(dest, ty)
            case Load(dest, ptr): self.translate_load(dest, ptr)
            case Store(ptr, value): self.translate_store(ptr, value)
            case GetElementPtr(dest, base, idx): self.translate_gep(dest, base, idx)
            case Aggregate(dest, kind, ops): self.translate_aggregate(dest, kind, ops)
            case GetField(dest, base, field): self.translate_get_field(dest, base, field)
            case SetField(base, field, value): self.translate_set_field(base, field, value)
            case Cast(dest, op, target): self.translate_cast(dest, op, target)
            case Bitcast(dest, op, target): self.translate_bitcast(dest, op, target)
            case Call(dest, func, args): self.translate_call(dest, func, args)
            case CallIndirect(dest, ptr, args, sig): self.translate_call_indirect(dest, ptr, args, sig)
            case Intrinsic(dest, name, args): self.translate_intrinsic(dest, name, args)
            case InlineAsm(template, outputs, inputs, clobbers, volatile): self.translate_inline_asm(template, outputs, inputs, clobbers, volatile)
            case PipeForward(dest, v, f): self.translate_pipe_forward(dest, v, f)
            case Compose(dest, f, g, fwd): self.translate_compose(dest, f, g, fwd)
            case Parallel(dest, funcs): self.translate_parallel(dest, funcs)
            case LayerConnect(dest, l1, l2): self.translate_layer_connect(dest, l1, l2)
            case Ref(dest, kind, place): self.translate_ref(dest, kind, place)
            case DebugValue(_, _): pass_dn
            case Nop: pass_dn
            case _: self.translate_unsupported(inst)

    # === Default stubs (overridable per-backend) ===
    me translate_alloc(dest: LocalId, ty: MirType): pass_dn
    me translate_load(dest: LocalId, ptr: MirOperand): pass_dn
    me translate_store(ptr: MirOperand, value: MirOperand): pass_dn
    me translate_gep(dest: LocalId, base: MirOperand, indices: [MirOperand]): pass_dn
    me translate_aggregate(dest: LocalId, kind: AggregateKind, ops: [MirOperand]): pass_dn
    me translate_get_field(dest: LocalId, base: MirOperand, field: i64): pass_dn
    me translate_set_field(base: MirOperand, field: i64, value: MirOperand): pass_dn
    me translate_cast(dest: LocalId, op: MirOperand, target: MirType): pass_dn
    me translate_bitcast(dest: LocalId, op: MirOperand, target: MirType): pass_dn
    me translate_call_indirect(dest: LocalId, ptr: MirOperand, args: [MirOperand], sig: MirSignature): pass_dn
    me translate_intrinsic(dest: LocalId, name: text, args: [MirOperand]): pass_dn
    me translate_inline_asm(template: text, outputs: [MirOperand], inputs: [MirOperand], clobbers: [text], volatile: bool): pass_dn
    me translate_pipe_forward(dest: LocalId, value: MirOperand, func: MirOperand): pass_dn
    me translate_compose(dest: LocalId, f: MirOperand, g: MirOperand, forward: bool): pass_dn
    me translate_parallel(dest: LocalId, funcs: [MirOperand]): pass_dn
    me translate_layer_connect(dest: LocalId, l1: MirOperand, l2: MirOperand): pass_dn
    me translate_ref(dest: LocalId, kind: MirBorrowKind, place: MirPlace): pass_dn
    me translate_stub(dest: LocalId, name: text): pass_dn
    me translate_unsupported(inst: MirInst): pass_dn

# ============================================================================
# Exports
# ============================================================================

export MirTextCodegen
