# Parallel file processing for duplicate detection
#
# Processes multiple files concurrently while respecting shared state (cache, interner).
# Simplified from BuildGraph pattern since files have no inter-dependencies.

use app.duplicate_check.config.{DuplicationConfig}
use app.duplicate_check.tokenizer.{SimpleToken}
use app.duplicate_check.cache.{TokenCacheManager}
use app.duplicate_check.detector.{DuplicateBlock, find_duplicates_in_file}
use app.io.mod.{shell}

# Parallel processing configuration
struct ParallelConfig:
    num_workers: i64        # Number of parallel workers (0 = auto-detect)
    batch_size: i64         # Files per batch
    enabled: bool           # Enable parallel processing

fn default_parallel_config() -> ParallelConfig:
    ParallelConfig(
        num_workers: 0,      # Auto-detect CPU count
        batch_size: 10,       # Process 10 files per batch
        enabled: true
    )

fn single_threaded_config() -> ParallelConfig:
    ParallelConfig(
        num_workers: 1,
        batch_size: 1,
        enabled: false
    )

# Detect CPU count
fn detect_cpu_count() -> i64:
    val result = shell("nproc 2>/dev/null || echo 4")
    val output = result.stdout.trim()
    val count = int(output)
    if count > 0:
        count
    else:
        4  # Default to 4 if detection fails

# Parallel processing is not yet available due to lack of async process spawning.
# This module provides a sequential fallback that processes files one at a time.
fn process_files_parallel(files: [text], config: ParallelConfig, cache_manager: TokenCacheManager, dup_config: DuplicationConfig) -> [DuplicateBlock]:
    eprint("[WARNING] Parallel processing not available; running sequentially (detected {detect_cpu_count()} CPUs)")
    var all_blocks: [DuplicateBlock] = []
    val batch_size = if config.batch_size > 0: config.batch_size else: 10
    var i = 0
    while i < files.len():
        val file = files[i]
        val blocks = find_duplicates_in_file(file, dup_config, cache_manager)
        all_blocks.merge(blocks)
        i = i + 1
    all_blocks

export ParallelConfig, default_parallel_config, single_threaded_config
export detect_cpu_count, process_files_parallel
