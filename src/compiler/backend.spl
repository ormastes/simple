# Backend - Compiler Backend Implementations (FACADE)
#
# COMPILED-ONLY: This module and its sub-modules use generics, traits,
# and Result<> types. They require the compiled pipeline to load.
# For runtime (interpreter mode), use compiler.core.interpreter instead.
#
# This is a facade module that re-exports all backend implementations.
# The actual implementation is split into focused modules:
#
# - backend/env.spl: Environment and scoping utilities (shared)
# - backend/interpreter.spl: Tree-walking interpreter backend (LEGACY)
# - backend/jit_interpreter.spl: JIT hybrid interpreter (DEFAULT)
# - backend/compiler.spl: Native code generation (Cranelift JIT/AOT)
# - backend/sdn.spl: SDN export backend (data-only, blocks execution)

use compiler.hir.*
use compiler.mir.*
use compiler.core.lexer.Span
use backend_types.*

# Re-export environment types and utilities
use backend.env.{EvalContext, Environment, empty_env_scope, HirVisitor}

# Re-export backend implementations (compiled-only — generics required)
# use backend.interpreter.InterpreterBackendImpl  # DISABLED: Parse error in Cranelift mode
use backend.jit_interpreter.{JitInterpreterBackend, JitInterpreterConfig, JitMode}
# use backend.compiler.CompilerBackendImpl     # Native compilation backend
# use backend.sdn.SdnBackendImpl               # SDN export backend

# ============================================================================
# Backend Factory
# ============================================================================

pub fn create_backend(kind: BackendKind) -> Backend:
    match kind:
        case Interpreter:
            # JIT interpreter is the default — tree-walk with JIT compilation
            JitInterpreterBackend.default()
        case CraneliftJit:
            JitInterpreterBackend.new(JitInterpreterConfig.always_jit())
        case _:
            # Fall back to JIT interpreter for all other kinds
            JitInterpreterBackend.default()

pub fn create_jit_backend(config: JitInterpreterConfig) -> JitInterpreterBackend:
    JitInterpreterBackend.new(config)

pub fn get_backend() -> Backend:
    # Default: JIT interpreter
    create_backend(BackendKind.Interpreter)

# ============================================================================
# Exports
# ============================================================================

export Backend, BackendKind, BackendResult, BackendError, BackendErrorKind
export CompiledUnit, CompiledSymbol, CompiledSymbolKind, Relocation, RelocKind
export SdnValue, SdnValueKind
export Value, EnumPayloadValue, FunctionValue, ClosureValue, ObjectValue
export EvalContext, Environment
export HirVisitor
export create_backend, create_jit_backend, get_backend
# export InterpreterBackendImpl  # DISABLED: Parse error in Cranelift mode
export JitInterpreterBackend, JitInterpreterConfig, JitMode
