# Library SMF Writer Tests
#
# Tests for LibSmfBuilder - creating library archives with SMF and object files.

use std.spec
use compiler.linker.lib_smf_writer.{LibSmfBuilder}
use app.io.{file_exists, file_write, shell}

describe "LibSmfBuilder - Basic Operations":
    it "should create new builder":
        val builder = LibSmfBuilder.new()
        expect(builder.module_count()).to_equal(0)

    it "should track module count":
        var builder = LibSmfBuilder.new()

        # Create test SMF file
        val test_path = "/tmp/test_module.smf"
        val write_result = file_write(test_path, "SMF_DATA_TEST")
        expect(write_result.is_ok()).to_equal(true)

        val add_result = builder.add_module("test/module", test_path)
        expect(add_result.is_ok()).to_equal(true)
        expect(builder.module_count()).to_equal(1)

    it "should list module names":
        var builder = LibSmfBuilder.new()

        # Create test files
        val smf1 = "/tmp/mod1.smf"
        val smf2 = "/tmp/mod2.smf"
        file_write(smf1, "DATA1")
        file_write(smf2, "DATA2")

        builder.add_module("mod1", smf1)
        builder.add_module("mod2", smf2)

        val names = builder.module_names()
        expect(names.len()).to_equal(2)
        expect(names.contains("mod1")).to_equal(true)
        expect(names.contains("mod2")).to_equal(true)

describe "LibSmfBuilder - Adding Modules":
    it "should add module from file":
        var builder = LibSmfBuilder.new()

        val test_path = "/tmp/add_test.smf"
        file_write(test_path, "TEST_SMF_CONTENT")

        val result = builder.add_module("test/add", test_path)
        expect(result.is_ok()).to_equal(true)
        expect(builder.module_count()).to_equal(1)

    it "should return error for missing SMF file":
        var builder = LibSmfBuilder.new()

        val result = builder.add_module("missing", "/nonexistent/file.smf")
        expect(result.is_err()).to_equal(true)

    it "should add module from memory":
        var builder = LibSmfBuilder.new()

        val data: [u8] = [83, 77, 70, 95, 68, 65, 84, 65]  # "SMF_DATA"
        val result = builder.add_module_data("memory/module", data)

        expect(result.is_ok()).to_equal(true)
        expect(builder.module_count()).to_equal(1)

describe "LibSmfBuilder - Object File Support":
    it "should add module with object file":
        var builder = LibSmfBuilder.new()

        # Create test files
        val smf_path = "/tmp/with_obj.smf"
        val obj_path = "/tmp/with_obj.o"
        file_write(smf_path, "SMF_CONTENT")
        file_write(obj_path, "OBJ_CONTENT")

        val result = builder.add_module_with_object(
            "test/with_obj",
            smf_path,
            obj_path
        )

        expect(result.is_ok()).to_equal(true)
        expect(builder.module_count()).to_equal(1)

    it "should return error for missing object file":
        var builder = LibSmfBuilder.new()

        val smf_path = "/tmp/test.smf"
        file_write(smf_path, "SMF_DATA")

        val result = builder.add_module_with_object(
            "test/module",
            smf_path,
            "/nonexistent/file.o"
        )

        expect(result.is_err()).to_equal(true)

    it "should add module with object from memory":
        var builder = LibSmfBuilder.new()

        val smf_data: [u8] = [83, 77, 70]  # "SMF"
        val obj_data: [u8] = [79, 66, 74]  # "OBJ"

        val result = builder.add_module_data_with_object(
            "memory/with_obj",
            smf_data,
            obj_data
        )

        expect(result.is_ok()).to_equal(true)

    it "should count modules with objects":
        var builder = LibSmfBuilder.new()

        # Create test files
        val smf1 = "/tmp/m1.smf"
        val smf2 = "/tmp/m2.smf"
        val obj2 = "/tmp/m2.o"
        file_write(smf1, "S1")
        file_write(smf2, "S2")
        file_write(obj2, "O2")

        builder.add_module("mod1", smf1)
        builder.add_module_with_object("mod2", smf2, obj2)

        expect(builder.count_objects()).to_equal(1)

describe "LibSmfBuilder - Writing Library":
    it "should write library to file":
        var builder = LibSmfBuilder.new()

        val smf_path = "/tmp/write_test.smf"
        file_write(smf_path, "TEST_DATA")
        builder.add_module("test/module", smf_path)

        val lib_path = "/tmp/test_lib.lsm"
        val result = builder.write(lib_path)

        expect(result.is_ok()).to_equal(true)
        expect(file_exists(lib_path)).to_equal(true)

        # Clean up
        shell("rm -f '{lib_path}'")

    it "should return error when writing empty library":
        var builder = LibSmfBuilder.new()

        val result = builder.write("/tmp/empty.lsm")
        expect(result.is_err()).to_equal(true)

    it "should write library with multiple modules":
        var builder = LibSmfBuilder.new()

        # Create test modules
        val smf1 = "/tmp/multi1.smf"
        val smf2 = "/tmp/multi2.smf"
        val smf3 = "/tmp/multi3.smf"
        file_write(smf1, "MODULE1")
        file_write(smf2, "MODULE2")
        file_write(smf3, "MODULE3")

        builder.add_module("mod1", smf1)
        builder.add_module("mod2", smf2)
        builder.add_module("mod3", smf3)

        val lib_path = "/tmp/multi_lib.lsm"
        val result = builder.write(lib_path)

        expect(result.is_ok()).to_equal(true)
        expect(file_exists(lib_path)).to_equal(true)

        # Verify file is not empty
        val stat_result = shell("stat -c%s '{lib_path}' 2>/dev/null || stat -f%z '{lib_path}' 2>/dev/null")
        expect(stat_result.exit_code).to_equal(0)
        val size = int(stat_result.stdout.trim())
        expect(size > 128).to_equal(true)  # At least header size

        # Clean up
        shell("rm -f '{lib_path}'")

    it "should write library with objects":
        var builder = LibSmfBuilder.new()

        val smf = "/tmp/obj_test.smf"
        val obj = "/tmp/obj_test.o"
        file_write(smf, "SMF_WITH_OBJ")
        file_write(obj, "OBJECT_CODE")

        builder.add_module_with_object("test/obj", smf, obj)

        val lib_path = "/tmp/obj_lib.lsm"
        val result = builder.write(lib_path)

        expect(result.is_ok()).to_equal(true)
        expect(file_exists(lib_path)).to_equal(true)

        # Clean up
        shell("rm -f '{lib_path}'")
