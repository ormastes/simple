"""
Const Keys - Tests and Main (Phase 8A-8C)

Implementation split into:
- key_extractor.spl: KeyExtractor, ConstKeySet (Phase 8A)
- const_key_type.spl: HirType extensions, TemplateTypeInference (Phase 8B)
- const_key_validator.spl: KeyError, ConstKeyValidator, Result, helpers (Phase 8C)
"""

# ============================================================================
# Tests - Phase 8A (13 tests)
# ============================================================================

fn test_extract_single_key():
    """Test extracting single key"""
    val tmpl = "Hello {name}"
    val keys = KeyExtractor.extract_keys(tmpl)

    assert keys.len() == 1, "One key"
    assert keys[0] == "name", "Key is 'name'"

    print "  Extract single key"

fn test_extract_multiple_keys():
    """Test extracting multiple keys"""
    val tmpl = "User {name} has {points} points"
    val keys = KeyExtractor.extract_keys(tmpl)

    assert keys.len() == 2, "Two keys"
    assert keys[0] == "name", "First key is 'name'"
    assert keys[1] == "points", "Second key is 'points'"

    print "  Extract multiple keys"

fn test_extract_no_keys():
    """Test extracting from plain string (no keys)"""
    val tmpl = "Hello world"
    val keys = KeyExtractor.extract_keys(tmpl)

    assert keys.len() == 0, "No keys"

    print "  Extract no keys"

fn test_extract_duplicate_keys():
    """Test extracting duplicate keys"""
    val tmpl = "{x} + {x} = {sum}"
    val keys = KeyExtractor.extract_keys(tmpl)

    assert keys.len() == 3, "Three keys (including duplicate)"
    assert keys[0] == "x", "First x"
    assert keys[1] == "x", "Second x (duplicate)"
    assert keys[2] == "sum", "sum"

    print "  Extract duplicate keys"

fn test_has_keys():
    """Test has_keys predicate"""
    val tmpl1 = "Hello {name}"
    val tmpl2 = "Hello world"

    assert KeyExtractor.has_keys(tmpl1), "Has keys"
    assert not KeyExtractor.has_keys(tmpl2), "No keys"

    print "  Has keys predicate"

fn test_unique_keys():
    """Test unique key extraction"""
    val tmpl = "{x} + {x} = {sum}"
    val unique = KeyExtractor.unique_keys(tmpl)

    assert unique.len() == 2, "Two unique keys"
    assert unique[0] == "x", "x"
    assert unique[1] == "sum", "sum"

    print "  Unique keys"

fn test_key_count():
    """Test key counting"""
    val tmpl1 = "Hello {name}"
    val tmpl2 = "{x} + {y} = {sum}"
    val tmpl3 = "No keys"

    assert KeyExtractor.key_count(tmpl1) == 1, "One key"
    assert KeyExtractor.key_count(tmpl2) == 3, "Three keys"
    assert KeyExtractor.key_count(tmpl3) == 0, "No keys"

    print "  Key count"

fn test_const_key_set_from_template():
    """Test creating ConstKeySet from template"""
    val tmpl = "Hello {name}, you are {age} years old"
    val key_set = ConstKeySet.from_template(tmpl)

    assert key_set.key_count() == 2, "Two keys"
    assert key_set.has_key("name"), "Has name"
    assert key_set.has_key("age"), "Has age"

    print "  ConstKeySet from template"

fn test_const_key_set_empty():
    """Test empty ConstKeySet"""
    val key_set = ConstKeySet.empty()

    assert key_set.is_empty(), "Is empty"
    assert key_set.key_count() == 0, "Zero keys"

    print "  Empty ConstKeySet"

fn test_const_key_set_has_key():
    """Test has_key method"""
    val key_set = ConstKeySet.from_keys(["name", "age"])

    assert key_set.has_key("name"), "Has name"
    assert key_set.has_key("age"), "Has age"
    assert not key_set.has_key("unknown"), "Doesn't have unknown"

    print "  ConstKeySet has_key"

fn test_const_key_set_missing_keys():
    """Test finding missing keys"""
    val key_set = ConstKeySet.from_keys(["name", "age", "email"])
    val provided = ["name", "age"]

    val missing = key_set.missing_keys(provided)

    assert missing.len() == 1, "One missing key"
    assert missing[0] == "email", "Missing email"

    print "  ConstKeySet missing keys"

fn test_const_key_set_extra_keys():
    """Test finding extra keys"""
    val key_set = ConstKeySet.from_keys(["name", "age"])
    val provided = ["name", "age", "unknown", "extra"]

    val extra = key_set.extra_keys(provided)

    assert extra.len() == 2, "Two extra keys"
    assert extra[0] == "unknown", "Extra: unknown"
    assert extra[1] == "extra", "Extra: extra"

    print "  ConstKeySet extra keys"

fn test_const_key_set_perfect_match():
    """Test perfect match (no missing, no extra)"""
    val key_set = ConstKeySet.from_keys(["name", "age"])
    val provided = ["name", "age"]

    val missing = key_set.missing_keys(provided)
    val extra = key_set.extra_keys(provided)

    assert missing.len() == 0, "No missing"
    assert extra.len() == 0, "No extra"

    print "  Perfect key match"

# ============================================================================
# Tests - Phase 8B (12 tests)
# ============================================================================

fn test_const_key_set_type():
    """Test ConstKeySet type creation"""
    val ty = HirType.ConstKeySet(keys: ["name", "age"])

    assert ty.is_const_key_set(), "Is ConstKeySet"
    assert not ty.is_dependent_keys(), "Not DependentKeys"
    assert ty.has_const_keys(), "Has const keys"

    print "  ConstKeySet type creation"

fn test_get_keys():
    """Test key extraction from type"""
    val ty = HirType.ConstKeySet(keys: ["x", "y", "z"])
    val keys = ty.get_keys()

    assert keys.len() == 3, "Three keys"
    assert keys[0] == "x", "First key is x"
    assert keys[1] == "y", "Second key is y"
    assert keys[2] == "z", "Third key is z"

    print "  Get keys from type"

fn test_get_keys_empty():
    """Test get_keys on non-ConstKeySet types"""
    val str_ty = HirType.Str
    val keys = str_ty.get_keys()

    assert keys.len() == 0, "No keys for Str type"

    print "  Get keys empty for non-ConstKeySet"

fn test_has_key():
    """Test key membership check"""
    val ty = HirType.ConstKeySet(keys: ["name", "email"])

    assert ty.has_key("name"), "Has name"
    assert ty.has_key("email"), "Has email"
    assert not ty.has_key("age"), "Doesn't have age"

    print "  Has key check"

fn test_hir_key_count():
    """Test key counting on HirType"""
    val ty1 = HirType.ConstKeySet(keys: [])
    val ty2 = HirType.ConstKeySet(keys: ["a"])
    val ty3 = HirType.ConstKeySet(keys: ["a", "b", "c"])

    assert ty1.get_key_count() == 0, "Zero keys"
    assert ty2.get_key_count() == 1, "One key"
    assert ty3.get_key_count() == 3, "Three keys"

    print "  HirType key count"

fn test_type_equality_const_key_set():
    """Test ConstKeySet type equality"""
    val ty1 = HirType.ConstKeySet(keys: ["name", "age"])
    val ty2 = HirType.ConstKeySet(keys: ["name", "age"])
    val ty3 = HirType.ConstKeySet(keys: ["age", "name"])  # Different order
    val ty4 = HirType.ConstKeySet(keys: ["name"])  # Different keys

    assert ty1.equals(ty2), "Same keys, same order: equal"
    assert not ty1.equals(ty3), "Same keys, different order: not equal"
    assert not ty1.equals(ty4), "Different keys: not equal"

    print "  ConstKeySet type equality"

fn test_type_equality_other():
    """Test type equality for other types"""
    val int_ty = HirType.Int
    val str_ty = HirType.Str
    val arr_ty = HirType.Array(elem_ty: HirType.Int)

    assert int_ty.equals(HirType.Int), "Int equals Int"
    assert not int_ty.equals(str_ty), "Int not equals Str"
    assert arr_ty.equals(HirType.Array(elem_ty: HirType.Int)), "Array equals"

    print "  Type equality for other types"

fn test_infer_template_with_keys():
    """Test inference for template with keys"""
    val tmpl = "Hello {name}, you are {age} years old"
    val ty = TemplateTypeInference.infer_template(tmpl)

    assert ty.is_const_key_set(), "Is ConstKeySet"
    val keys = ty.get_keys()
    assert keys.len() == 2, "Two keys"
    assert keys[0] == "name", "First key is name"
    assert keys[1] == "age", "Second key is age"

    print "  Infer template with keys"

fn test_infer_plain_string():
    """Test inference for plain string (no keys)"""
    val plain = "Hello world"
    val ty = TemplateTypeInference.infer_template(plain)

    assert not ty.is_const_key_set(), "Not ConstKeySet"
    assert ty.equals(HirType.Str), "Is Str type"

    print "  Infer plain string"

fn test_is_template():
    """Test template detection"""
    val tmpl = "User {id} has {points} points"
    val plain = "No keys here"

    assert TemplateTypeInference.is_template(tmpl), "Is template"
    assert not TemplateTypeInference.is_template(plain), "Not template"

    print "  Template detection"

fn test_const_key_set_to_string():
    """Test string representation"""
    val ty1 = HirType.ConstKeySet(keys: ["name", "age"])
    val ty2 = HirType.ConstKeySet(keys: [])

    val str1 = ty1.to_string()
    val str2 = ty2.to_string()

    assert str1 == "ConstKeySet<[\"name\", \"age\"]>", "String with keys"
    assert str2 == "ConstKeySet<[]>", "String with no keys"

    print "  ConstKeySet to_string"

fn test_dependent_keys_type():
    """Test DependentKeys type"""
    val ty = HirType.DependentKeys(source: "user_input")

    assert ty.is_dependent_keys(), "Is DependentKeys"
    assert not ty.is_const_key_set(), "Not ConstKeySet"
    assert not ty.has_const_keys(), "No const keys"

    val str_repr = ty.to_string()
    assert str_repr == "DependentKeys<user_input>", "String representation"

    print "  DependentKeys type"

# ============================================================================
# Tests - Phase 8C (12 tests)
# ============================================================================

fn test_validate_with_call_success():
    """Test successful validation (all keys provided)"""
    val tmpl_ty = HirType.ConstKeySet(keys: ["name", "age"])
    val provided = ["name", "age"]

    val result = ConstKeyValidator.validate_with_call(tmpl_ty, provided)

    assert result.is_ok(), "Validation should succeed"

    print "  Valid with call"

fn test_validate_with_call_missing_keys():
    """Test validation with missing keys"""
    val tmpl_ty = HirType.ConstKeySet(keys: ["name", "age", "email"])
    val provided = ["name", "age"]

    val result = ConstKeyValidator.validate_with_call(tmpl_ty, provided)

    assert result.is_err(), "Should fail: missing email"
    val err = result.unwrap_err()
    assert err.is_missing_keys(), "Error is MissingKeys"

    print "  Missing keys detected"

fn test_validate_with_call_extra_keys():
    """Test validation with extra keys"""
    val tmpl_ty = HirType.ConstKeySet(keys: ["name"])
    val provided = ["name", "age", "unknown"]

    val result = ConstKeyValidator.validate_with_call(tmpl_ty, provided)

    assert result.is_err(), "Should fail: extra keys"
    val err = result.unwrap_err()
    assert err.is_extra_keys(), "Error is ExtraKeys"

    print "  Extra keys detected"

fn test_validate_with_call_both_errors():
    """Test validation with both missing and extra keys"""
    val tmpl_ty = HirType.ConstKeySet(keys: ["name", "email"])
    val provided = ["name", "age"]  # Missing: email, Extra: age

    val result = ConstKeyValidator.validate_with_call(tmpl_ty, provided)

    assert result.is_err(), "Should fail: both errors"
    val err = result.unwrap_err()
    assert err.is_missing_keys(), "Has missing keys"
    assert err.is_extra_keys(), "Has extra keys"

    print "  Both errors detected"

fn test_validate_with_call_not_const_key_set():
    """Test validation with non-ConstKeySet type"""
    val str_ty = HirType.Str
    val provided = ["name"]

    val result = ConstKeyValidator.validate_with_call(str_ty, provided)

    assert result.is_err(), "Should fail: not ConstKeySet"
    val err = result.unwrap_err()

    match err:
        case NotConstKeySet(_): pass
        case _: assert false, "Expected NotConstKeySet error"

    print "  Not ConstKeySet detected"

fn test_validate_keys_match():
    """Test exact key matching"""
    val required = ["name", "age"]
    val provided1 = ["name", "age"]
    val provided2 = ["name"]
    val provided3 = ["name", "age", "email"]

    assert ConstKeyValidator.validate_keys_match(required, provided1), "Exact match"
    assert not ConstKeyValidator.validate_keys_match(required, provided2), "Missing key"
    assert not ConstKeyValidator.validate_keys_match(required, provided3), "Extra key"

    print "  Keys match validation"

fn test_has_missing_keys():
    """Test missing key detection"""
    val required = ["name", "age", "email"]
    val provided1 = ["name", "age", "email"]
    val provided2 = ["name", "age"]

    assert not ConstKeyValidator.has_missing_keys(required, provided1), "No missing"
    assert ConstKeyValidator.has_missing_keys(required, provided2), "Has missing"

    print "  Has missing keys"

fn test_has_extra_keys():
    """Test extra key detection"""
    val required = ["name"]
    val provided1 = ["name"]
    val provided2 = ["name", "age"]

    assert not ConstKeyValidator.has_extra_keys(required, provided1), "No extra"
    assert ConstKeyValidator.has_extra_keys(required, provided2), "Has extra"

    print "  Has extra keys"

fn test_find_missing_keys():
    """Test missing key finding"""
    val required = ["name", "age", "email"]
    val provided = ["name", "age"]

    val missing = find_missing_keys(required, provided)

    assert missing.len() == 1, "One missing key"
    assert missing[0] == "email", "Missing: email"

    print "  Find missing keys"

fn test_find_extra_keys():
    """Test extra key finding"""
    val required = ["name", "age"]
    val provided = ["name", "age", "unknown", "extra"]

    val extra = find_extra_keys(required, provided)

    assert extra.len() == 2, "Two extra keys"
    assert extra[0] == "unknown", "Extra: unknown"
    assert extra[1] == "extra", "Extra: extra"

    print "  Find extra keys"

fn test_key_error_to_string():
    """Test error message formatting"""
    val err1 = KeyError.MissingKeys(keys: ["age", "email"])
    val err2 = KeyError.ExtraKeys(keys: ["unknown"])
    val err3 = KeyError.BothErrors(missing: ["age"], extra: ["unknown"])

    val msg1 = err1.to_string()
    val msg2 = err2.to_string()
    val msg3 = err3.to_string()

    assert msg1 == "Missing keys: [\"age\", \"email\"]", "Missing keys message"
    assert msg2 == "Unknown keys: [\"unknown\"]", "Extra keys message"

    # msg3 should contain both missing and unknown
    assert "Missing" in msg3, "Contains Missing"
    assert "Unknown" in msg3, "Contains Unknown"

    print "  Error message formatting"

fn test_typo_detection():
    """Test typo detection (missing + extra with similar names)"""
    val tmpl_ty = HirType.ConstKeySet(keys: ["name", "age"])
    val provided = ["name", "ag"]  # Typo: "ag" instead of "age"

    val result = ConstKeyValidator.validate_with_call(tmpl_ty, provided)

    assert result.is_err(), "Should detect typo"
    val err = result.unwrap_err()
    assert err.is_missing_keys(), "Has missing: age"
    assert err.is_extra_keys(), "Has extra: ag"

    print "  Typo detection"

# ============================================================================
# Main - Combined test runner
# ============================================================================

fn main():
    print ""
    print "Const Keys - Consolidated Tests (Phase 8A-8C)"
    print "=============================================="

    print ""
    print "Phase 8A: Key Extraction (13 tests)"
    print "------------------------------------"
    test_extract_single_key()
    test_extract_multiple_keys()
    test_extract_no_keys()
    test_extract_duplicate_keys()
    test_has_keys()
    test_unique_keys()
    test_key_count()
    test_const_key_set_from_template()
    test_const_key_set_empty()
    test_const_key_set_has_key()
    test_const_key_set_missing_keys()
    test_const_key_set_extra_keys()
    test_const_key_set_perfect_match()

    print ""
    print "Phase 8B: ConstKeySet Type (12 tests)"
    print "--------------------------------------"
    test_const_key_set_type()
    test_get_keys()
    test_get_keys_empty()
    test_has_key()
    test_hir_key_count()
    test_type_equality_const_key_set()
    test_type_equality_other()
    test_infer_template_with_keys()
    test_infer_plain_string()
    test_is_template()
    test_const_key_set_to_string()
    test_dependent_keys_type()

    print ""
    print "Phase 8C: Key Validation (12 tests)"
    print "------------------------------------"
    test_validate_with_call_success()
    test_validate_with_call_missing_keys()
    test_validate_with_call_extra_keys()
    test_validate_with_call_both_errors()
    test_validate_with_call_not_const_key_set()
    test_validate_keys_match()
    test_has_missing_keys()
    test_has_extra_keys()
    test_find_missing_keys()
    test_find_extra_keys()
    test_key_error_to_string()
    test_typo_detection()

    print ""
    print "All 37 tests passed!"
    print ""
