"""
Key Extractor - Phase 8A

Implements key extraction from string templates and ConstKeySet.
Extracted from const_keys.spl.
"""

type Symbol = text

# ============================================================================
# Key Extractor (Phase 8A)
# ============================================================================

class KeyExtractor:
    """
    Extracts keys from string template

    Examples:
        "Hello {name}" -> ["name"]
        "{x} + {y} = {sum}" -> ["x", "y", "sum"]
        "No keys" -> []
    """

impl KeyExtractor:
    static fn extract_keys(tmpl: text) -> [Symbol]:
        """
        Extract keys from template string

        Algorithm:
        1. Scan through template character by character
        2. Track when inside braces {}
        3. Collect characters between braces as keys
        4. Return list of keys
        """
        var keys = []
        var in_brace = false
        var key_chars: [text] = []
        var i = 0

        while i < tmpl.len():
            val char = tmpl[i..i+1]

            if char == "{":
                in_brace = true
                key_chars = []
            elif char == "}":
                if in_brace:
                    val current_key = key_chars.join("")
                    if current_key.len() > 0:
                        keys.push(current_key)
                in_brace = false
                key_chars = []
            elif in_brace:
                key_chars = key_chars.push(char)

            i = i + 1

        keys

    static fn has_keys(tmpl: text) -> bool:
        """Check if template has any keys"""
        val keys = KeyExtractor.extract_keys(tmpl)
        keys.len() > 0

    static fn unique_keys(tmpl: text) -> [Symbol]:
        """Extract unique keys (deduplicate)"""
        val all_keys = KeyExtractor.extract_keys(tmpl)
        var unique = []

        for key in all_keys:
            if key not in unique:
                unique.push(key)

        unique

    static fn key_count(tmpl: text) -> i64:
        """Count number of keys"""
        val keys = KeyExtractor.extract_keys(tmpl)
        keys.len()

# ============================================================================
# Const Key Set (Phase 8A)
# ============================================================================

class ConstKeySet:
    """
    Set of compile-time known keys

    Examples:
        ConstKeySet(["name", "age"])
        ConstKeySet([])  # No keys
    """
    keys: [Symbol]

impl ConstKeySet:
    static fn from_template(tmpl: text) -> ConstKeySet:
        """Create ConstKeySet from template string"""
        val keys = KeyExtractor.extract_keys(tmpl)
        ConstKeySet(keys: keys)

    static fn from_keys(keys: [Symbol]) -> ConstKeySet:
        """Create ConstKeySet from key list"""
        ConstKeySet(keys: keys)

    static fn empty() -> ConstKeySet:
        """Create empty ConstKeySet (no keys)"""
        ConstKeySet(keys: [])

    fn has_key(key: Symbol) -> bool:
        """Check if key is in set"""
        key in self.keys

    fn key_count() -> i64:
        """Count number of keys"""
        self.keys.len()

    fn is_empty() -> bool:
        """Check if set is empty"""
        self.keys.len() == 0

    fn get_keys() -> [Symbol]:
        """Get list of keys"""
        self.keys

    fn missing_keys(provided: [Symbol]) -> [Symbol]:
        """Find keys in required but not in provided"""
        var missing = []

        for key in self.keys:
            if key not in provided:
                missing.push(key)

        missing

    fn extra_keys(provided: [Symbol]) -> [Symbol]:
        """Find keys in provided but not in required"""
        var extra = []

        for key in provided:
            if key not in self.keys:
                extra.push(key)

        extra

    fn to_string() -> text:
        """String representation"""
        if self.keys.len() == 0:
            return "ConstKeySet([])"

        var key_strs = []
        for key in self.keys:
            key_strs.push(key)

        val keys_str = if key_strs.len() > 0: key_strs[0] else: ""
        "ConstKeySet([{keys_str}, ...])"
