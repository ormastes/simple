"""
Const Keys - Phase 8C: Key Validation

Implements validation of .with() calls against ConstKeySet types.

Status: Phase 8C In Progress
"""

type Symbol = text

# ============================================================================
# Key Validation Errors
# ============================================================================

enum KeyError:
    """
    Key validation errors

    Variants:
    - MissingKeys: Required keys not provided
    - ExtraKeys: Unknown keys provided
    - NotConstKeySet: Template doesn't have const keys
    - BothErrors: Both missing and extra keys
    """
    MissingKeys(keys: [Symbol])
    ExtraKeys(keys: [Symbol])
    NotConstKeySet(message: text)
    BothErrors(missing: [Symbol], extra: [Symbol])

impl KeyError:
    fn to_string() -> text:
        """Error message"""
        match self:
            case MissingKeys(keys):
                val keys_str = format_key_list(keys)
                "Missing keys: [{keys_str}]"

            case ExtraKeys(keys):
                val keys_str = format_key_list(keys)
                "Unknown keys: [{keys_str}]"

            case NotConstKeySet(msg):
                msg

            case BothErrors(missing, extra):
                val missing_str = format_key_list(missing)
                val extra_str = format_key_list(extra)
                "Missing keys: [{missing_str}]; Unknown keys: [{extra_str}]"

    fn is_missing_keys() -> bool:
        match self:
            case MissingKeys(_): true
            case BothErrors(_, _): true
            case _: false

    fn is_extra_keys() -> bool:
        match self:
            case ExtraKeys(_): true
            case BothErrors(_, _): true
            case _: false

fn format_key_list(keys: [Symbol]) -> text:
    """Format key list for error message"""
    if keys.len() == 0:
        return ""

    var result = "\"{keys[0]}\""
    var i = 1
    while i < keys.len():
        result = result + ", \"{keys[i]}\""
        i = i + 1

    result

# ============================================================================
# Const Key Validator
# ============================================================================

class ConstKeyValidator:
    """
    Validates keys in .with() calls

    Algorithm:
    1. Check template type is ConstKeySet
    2. Find missing keys (required but not provided)
    3. Find extra keys (provided but not required)
    4. Return error if any issues found
    """

impl ConstKeyValidator:
    static fn validate_with_call(
        tmpl_ty: HirType,
        provided_keys: [Symbol]
    ) -> Result<(), KeyError>:
        """
        Validate .with() call against template type

        Args:
            tmpl_ty: Template type (must be ConstKeySet)
            provided_keys: Keys provided in .with() dict

        Returns:
            Ok(()) if valid
            Err(KeyError) if validation fails
        """
        # Check template type is ConstKeySet
        if not tmpl_ty.is_const_key_set():
            val msg = "Not a template with const keys"
            return Err(KeyError.NotConstKeySet(message: msg))

        val required_keys = tmpl_ty.get_keys()

        # Find missing and extra keys
        val missing = find_missing_keys(required_keys, provided_keys)
        val extra = find_extra_keys(required_keys, provided_keys)

        # Return appropriate error
        if missing.len() > 0 and extra.len() > 0:
            return Err(KeyError.BothErrors(missing: missing, extra: extra))

        if missing.len() > 0:
            return Err(KeyError.MissingKeys(keys: missing))

        if extra.len() > 0:
            return Err(KeyError.ExtraKeys(keys: extra))

        Ok(())

    static fn validate_keys_match(
        required: [Symbol],
        provided: [Symbol]
    ) -> bool:
        """
        Check if provided keys match required keys exactly

        Returns: true if all required keys provided and no extras
        """
        val missing = find_missing_keys(required, provided)
        val extra = find_extra_keys(required, provided)

        missing.len() == 0 and extra.len() == 0

    static fn has_missing_keys(
        required: [Symbol],
        provided: [Symbol]
    ) -> bool:
        """Check if any required keys are missing"""
        val missing = find_missing_keys(required, provided)
        missing.len() > 0

    static fn has_extra_keys(
        required: [Symbol],
        provided: [Symbol]
    ) -> bool:
        """Check if any extra keys provided"""
        val extra = find_extra_keys(required, provided)
        extra.len() > 0

fn find_missing_keys(required: [Symbol], provided: [Symbol]) -> [Symbol]:
    """
    Find keys in required but not in provided

    Algorithm: For each required key, check if it's in provided list
    """
    var missing = []

    for key in required:
        if key not in provided:
            missing.push(key)

    missing

fn find_extra_keys(required: [Symbol], provided: [Symbol]) -> [Symbol]:
    """
    Find keys in provided but not in required

    Algorithm: For each provided key, check if it's in required list
    """
    var extra = []

    for key in provided:
        if key not in required:
            extra.push(key)

    extra

# Import HirType from Phase 8B
enum HirType:
    Int
    Float
    Bool
    Str
    Unit
    Array(elem_ty: HirType)
    Dict(key_ty: HirType, val_ty: HirType)
    ConstKeySet(keys: [Symbol])
    DependentKeys(source: Symbol)
    TypeVar(name: Symbol)
    Generic(base: Symbol, args: [HirType])

impl HirType:
    fn is_const_key_set() -> bool:
        match self:
            case ConstKeySet(_): true
            case _: false

    fn get_keys() -> [Symbol]:
        match self:
            case ConstKeySet(keys): keys
            case _: []

# ============================================================================
# Result Type
# ============================================================================

enum Result<T, E>:
    Ok(value: T)
    Err(error: E)

impl Result<T, E>:
    fn is_ok() -> bool:
        match self:
            case Ok(_): true
            case _: false

    fn is_err() -> bool:
        match self:
            case Err(_): true
            case _: false

    fn unwrap() -> T:
        match self:
            case Ok(value): value
            case Err(_):
                assert false, "Called unwrap on Err"
                # Unreachable but needed for type checking
                val dummy = 0
                dummy as T

    fn unwrap_err() -> E:
        match self:
            case Err(error): error
            case Ok(_):
                assert false, "Called unwrap_err on Ok"
                val dummy = 0
                dummy as E

# ============================================================================
# Tests
# ============================================================================

fn test_validate_with_call_success():
    """Test successful validation (all keys provided)"""
    val tmpl_ty = HirType.ConstKeySet(keys: ["name", "age"])
    val provided = ["name", "age"]

    val result = ConstKeyValidator.validate_with_call(tmpl_ty, provided)

    assert result.is_ok(), "Validation should succeed"

    print "‚úÖ Valid with call"

fn test_validate_with_call_missing_keys():
    """Test validation with missing keys"""
    val tmpl_ty = HirType.ConstKeySet(keys: ["name", "age", "email"])
    val provided = ["name", "age"]

    val result = ConstKeyValidator.validate_with_call(tmpl_ty, provided)

    assert result.is_err(), "Should fail: missing email"
    val err = result.unwrap_err()
    assert err.is_missing_keys(), "Error is MissingKeys"

    print "‚úÖ Missing keys detected"

fn test_validate_with_call_extra_keys():
    """Test validation with extra keys"""
    val tmpl_ty = HirType.ConstKeySet(keys: ["name"])
    val provided = ["name", "age", "unknown"]

    val result = ConstKeyValidator.validate_with_call(tmpl_ty, provided)

    assert result.is_err(), "Should fail: extra keys"
    val err = result.unwrap_err()
    assert err.is_extra_keys(), "Error is ExtraKeys"

    print "‚úÖ Extra keys detected"

fn test_validate_with_call_both_errors():
    """Test validation with both missing and extra keys"""
    val tmpl_ty = HirType.ConstKeySet(keys: ["name", "email"])
    val provided = ["name", "age"]  # Missing: email, Extra: age

    val result = ConstKeyValidator.validate_with_call(tmpl_ty, provided)

    assert result.is_err(), "Should fail: both errors"
    val err = result.unwrap_err()
    assert err.is_missing_keys(), "Has missing keys"
    assert err.is_extra_keys(), "Has extra keys"

    print "‚úÖ Both errors detected"

fn test_validate_with_call_not_const_key_set():
    """Test validation with non-ConstKeySet type"""
    val str_ty = HirType.Str
    val provided = ["name"]

    val result = ConstKeyValidator.validate_with_call(str_ty, provided)

    assert result.is_err(), "Should fail: not ConstKeySet"
    val err = result.unwrap_err()

    match err:
        case NotConstKeySet(_): pass
        case _: assert false, "Expected NotConstKeySet error"

    print "‚úÖ Not ConstKeySet detected"

fn test_validate_keys_match():
    """Test exact key matching"""
    val required = ["name", "age"]
    val provided1 = ["name", "age"]
    val provided2 = ["name"]
    val provided3 = ["name", "age", "email"]

    assert ConstKeyValidator.validate_keys_match(required, provided1), "Exact match"
    assert not ConstKeyValidator.validate_keys_match(required, provided2), "Missing key"
    assert not ConstKeyValidator.validate_keys_match(required, provided3), "Extra key"

    print "‚úÖ Keys match validation"

fn test_has_missing_keys():
    """Test missing key detection"""
    val required = ["name", "age", "email"]
    val provided1 = ["name", "age", "email"]
    val provided2 = ["name", "age"]

    assert not ConstKeyValidator.has_missing_keys(required, provided1), "No missing"
    assert ConstKeyValidator.has_missing_keys(required, provided2), "Has missing"

    print "‚úÖ Has missing keys"

fn test_has_extra_keys():
    """Test extra key detection"""
    val required = ["name"]
    val provided1 = ["name"]
    val provided2 = ["name", "age"]

    assert not ConstKeyValidator.has_extra_keys(required, provided1), "No extra"
    assert ConstKeyValidator.has_extra_keys(required, provided2), "Has extra"

    print "‚úÖ Has extra keys"

fn test_find_missing_keys():
    """Test missing key finding"""
    val required = ["name", "age", "email"]
    val provided = ["name", "age"]

    val missing = find_missing_keys(required, provided)

    assert missing.len() == 1, "One missing key"
    assert missing[0] == "email", "Missing: email"

    print "‚úÖ Find missing keys"

fn test_find_extra_keys():
    """Test extra key finding"""
    val required = ["name", "age"]
    val provided = ["name", "age", "unknown", "extra"]

    val extra = find_extra_keys(required, provided)

    assert extra.len() == 2, "Two extra keys"
    assert extra[0] == "unknown", "Extra: unknown"
    assert extra[1] == "extra", "Extra: extra"

    print "‚úÖ Find extra keys"

fn test_key_error_to_string():
    """Test error message formatting"""
    val err1 = KeyError.MissingKeys(keys: ["age", "email"])
    val err2 = KeyError.ExtraKeys(keys: ["unknown"])
    val err3 = KeyError.BothErrors(missing: ["age"], extra: ["unknown"])

    val msg1 = err1.to_string()
    val msg2 = err2.to_string()
    val msg3 = err3.to_string()

    assert msg1 == "Missing keys: [\"age\", \"email\"]", "Missing keys message"
    assert msg2 == "Unknown keys: [\"unknown\"]", "Extra keys message"

    # msg3 should contain both missing and unknown
    assert "Missing" in msg3, "Contains Missing"
    assert "Unknown" in msg3, "Contains Unknown"

    print "‚úÖ Error message formatting"

fn test_typo_detection():
    """Test typo detection (missing + extra with similar names)"""
    val tmpl_ty = HirType.ConstKeySet(keys: ["name", "age"])
    val provided = ["name", "ag"]  # Typo: "ag" instead of "age"

    val result = ConstKeyValidator.validate_with_call(tmpl_ty, provided)

    assert result.is_err(), "Should detect typo"
    val err = result.unwrap_err()
    assert err.is_missing_keys(), "Has missing: age"
    assert err.is_extra_keys(), "Has extra: ag"

    print "‚úÖ Typo detection"

fn main():
    print ""
    print "Const Keys Phase 8C Tests"
    print "========================="

    test_validate_with_call_success()
    test_validate_with_call_missing_keys()
    test_validate_with_call_extra_keys()
    test_validate_with_call_both_errors()
    test_validate_with_call_not_const_key_set()
    test_validate_keys_match()
    test_has_missing_keys()
    test_has_extra_keys()
    test_find_missing_keys()
    test_find_extra_keys()
    test_key_error_to_string()
    test_typo_detection()

    print ""
    print "üéâ Phase 8C Complete!"
    print ""
    print "Implemented:"
    print "  ‚úÖ ConstKeyValidator - validate .with() calls"
    print "  ‚úÖ validate_with_call() - full validation"
    print "  ‚úÖ find_missing_keys() - detect missing keys"
    print "  ‚úÖ find_extra_keys() - detect extra keys"
    print "  ‚úÖ KeyError - structured error types"
    print "  ‚úÖ Error messages - clear diagnostics"
    print "  ‚úÖ Typo detection - catch common mistakes"
    print ""
    print "Progress: 6/6 hours (100% of Phase 8)"
    print ""
    print "üèÜ Phase 8: Const Keys COMPLETE!"
    print "97/115 hours total (84% of Rust Feature Parity Roadmap)"
    print ""
    print "Next: Phase 9 - SIMD Complete (4h)"
