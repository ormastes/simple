# MIR Optimization Integration
#
# Integration module for the MIR optimization framework.
# Provides simple interface for pipeline to call optimization passes.

use compiler.mir_opt.mod.{OptLevel, OptimizationPipeline}
use mir.MirModule

# ============================================================================
# Optimization Configuration
# ============================================================================

enum OptimizationConfig:
    """Configuration for MIR optimization."""
    Disabled                    # No optimization (debug builds)
    Enabled(level: OptLevel)    # Optimize with specified level


# ============================================================================
# OptimizationConfig Methods (was: impl OptimizationConfig:)
# ============================================================================

fn optimizationconfig_none() -> OptimizationConfig:
        """No optimization (debug mode)."""
        OptimizationConfig.Disabled


fn optimizationconfig_debug() -> OptimizationConfig:
        """Debug mode (no optimization)."""
        OptimizationConfig.Disabled


fn optimizationconfig_size() -> OptimizationConfig:
        """Optimize for binary size."""
        optimizationconfig_Enabled(level: OptLevel.Size)


fn optimizationconfig_speed() -> OptimizationConfig:
        """Optimize for speed (default release)."""
        optimizationconfig_Enabled(level: OptLevel.Speed)


fn optimizationconfig_aggressive() -> OptimizationConfig:
        """Aggressive optimization (maximum performance)."""
        optimizationconfig_Enabled(level: OptLevel.Aggressive)


# ============================================================================
# Optimization Entry Point
# ============================================================================

fn optimize_mir_module(
    mir: MirModule,
    config: OptimizationConfig
) -> MirModule:
    """
    Optimize MIR module according to configuration.

    This is the main entry point called from the compilation pipeline.

    Args:
        mir: The MIR module to optimize
        config: Optimization configuration

    Returns:
        Optimized MIR module (or original if optimization disabled)
    """
    match config:
        case OptimizationConfig.Disabled:
            # No optimization - return as-is
            mir

        case optimizationconfig_Enabled(level):
            # Create optimization pipeline for this level
            val pipeline = OptimizationPipeline__for_level(level)

            # Run optimization
            val optimized = pipeline_optimize(pipeline, mir)

            optimized

fn optimize_mir_module_with_stats(
    mir: MirModule,
    config: OptimizationConfig,
    show_stats: bool
) -> MirModule:
    """
    Optimize MIR module and optionally display statistics.

    Args:
        mir: The MIR module to optimize
        config: Optimization configuration
        show_stats: Whether to display optimization statistics

    Returns:
        Optimized MIR module
    """
    match config:
        case OptimizationConfig.Disabled:
            if show_stats:
                print "MIR Optimization: Disabled"
            mir

        case optimizationconfig_Enabled(level):
            if show_stats:
                print "MIR Optimization: {level}"

            val pipeline = OptimizationPipeline__for_level(level)
            val optimized = pipeline_optimize(pipeline, mir)

            if show_stats:
                print "  Passes executed: {pipeline.passes.len()}"
                for pass_name in pipeline.passes:
                    print "    - {pass_name}"

            optimized

# ============================================================================
# Convenience Functions
# ============================================================================

fn optimize_mir_debug(mir: MirModule) -> MirModule:
    """Optimize for debug (no optimization)."""
    optimize_mir_module(mir, OptimizationConfig__debug())

fn optimize_mir_size(mir: MirModule) -> MirModule:
    """Optimize for binary size."""
    optimize_mir_module(mir, OptimizationConfig__size())

fn optimize_mir_speed(mir: MirModule) -> MirModule:
    """Optimize for speed (default release)."""
    optimize_mir_module(mir, OptimizationConfig__speed())

fn optimize_mir_aggressive(mir: MirModule) -> MirModule:
    """Optimize aggressively (maximum performance)."""
    optimize_mir_module(mir, OptimizationConfig__aggressive())

# ============================================================================
# Exports
# ============================================================================

export OptimizationConfig
export optimize_mir_module, optimize_mir_module_with_stats
export optimize_mir_debug, optimize_mir_size, optimize_mir_speed, optimize_mir_aggressive
