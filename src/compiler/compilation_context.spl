# Unified Compilation Context
#
# Shared trait for compiler, JIT, and linker so all three paths
# apply AOP, DI, contracts, and codegen through the same interface.

use backend_types.{CompiledUnit, CompiledSymbol, CompiledSymbolKind, Relocation}
use di.DiContainer
use aop.AopWeaver
use monomorphize.note_sdn.{InstantiationEntry, InstantiationStatus}

# ============================================================================
# Enums
# ============================================================================

enum InstantiationMode:
    """When instantiation occurs."""
    CompileTime
    LinkTime
    JitTime

impl InstantiationMode:
    fn to_string() -> text:
        match self:
            case CompileTime: "compile_time"
            case LinkTime: "link_time"
            case JitTime: "jit_time"

enum ContractMode:
    """How much contract checking to apply."""
    Off        # No contracts
    Boundary   # Only at module boundaries
    All        # All contracts

impl ContractMode:
    fn to_string() -> text:
        match self:
            case Off: "off"
            case Boundary: "boundary"
            case All: "all"

# ============================================================================
# GenericTemplate (placeholder for template AST data)
# ============================================================================

struct GenericTemplate:
    """A generic template loaded from AST cache or SMF."""
    name: text
    type_params: [text]
    ast_data: Any

struct ConcreteType:
    """A concrete type used for instantiation."""
    name: text

impl ConcreteType:
    fn to_string() -> text:
        self.name

# ============================================================================
# TypeRegistry (placeholder)
# ============================================================================

struct TypeRegistry:
    """Registry of known types."""
    types: Dict<text, Any>

impl TypeRegistry:
    static fn empty() -> TypeRegistry:
        TypeRegistry(types: {})

# ============================================================================
# CompilationContext Trait
# ============================================================================

trait CompilationContext:
    """Unified compilation interface for compiler, JIT, and linker.
    All three paths use this to ensure AOP/DI/contracts are applied."""

    # Template management (source differs per context)
    fn load_template(name: text) -> Result<GenericTemplate, text>
    fn has_template(name: text) -> bool

    # Type system
    fn type_registry() -> TypeRegistry

    # Pipeline configuration (AOP/DI/contracts)
    fn contract_mode() -> ContractMode
    fn di_container() -> DiContainer?
    fn aop_weaver() -> AopWeaver?
    fn coverage_enabled() -> bool

    # Full pipeline: template -> compiled code
    fn compile_template(template: GenericTemplate, type_args: [ConcreteType]) -> Result<CompiledUnit, text>

    # Metadata tracking
    fn instantiation_mode() -> InstantiationMode
    me record_instantiation(entry: InstantiationEntry)

# ============================================================================
# Exports
# ============================================================================

export CompilationContext
export InstantiationMode, ContractMode
export GenericTemplate, ConcreteType, TypeRegistry
