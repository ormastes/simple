# Shared Compilation Pipeline
#
# Reusable compilation pipeline function that all CompilationContext
# implementations call from their compile_template() methods.
#
# Pipeline: monomorphize -> HIR -> MIR -> AOP weave -> codegen

use compilation_context.{ContractMode, ConcreteType, GenericTemplate}
use backend_types.{CompiledUnit, CompiledSymbol, CompiledSymbolKind}
use di.DiContainer
use aop.AopWeaver
use mir_lowering.MirLowering

# ============================================================================
# Pipeline Function
# ============================================================================

fn compile_specialized_template(
    template: GenericTemplate,
    type_args: [ConcreteType],
    contract_mode: ContractMode,
    di: DiContainer?,
    aop: AopWeaver?,
    coverage: bool
) -> Result<CompiledUnit, text>:
    """Shared compilation pipeline.

    Steps:
    1. Monomorphize (substitute type parameters)
    2. Lower to HIR
    3. Lower to MIR (with contracts, DI injection)
    4. AOP weaving (if configured)
    5. Codegen to native code
    """
    val name = template.name
    val args_str = type_args.map(\t: t.to_string()).join(",")
    val mangled = if args_str.is_empty(): name else: "{name}${args_str}"

    # Step 1: Monomorphize
    # TODO: Apply type substitution to template AST
    # val specialized = monomorphize(template, type_args)

    # Step 2: Lower to HIR
    # TODO: val hir = lower_to_hir(specialized)

    # Step 3: Lower to MIR (with contracts, DI)
    # TODO: var mir = lower_to_mir(hir, contract_mode, di)

    # Step 4: AOP weaving
    # if aop.?:
    #     mir = aop.unwrap().weave(mir)

    # Step 5: Codegen
    # TODO: val code = codegen_to_native(mir)

    # For now, produce a compiled unit with the mangled name
    # Actual pipeline integration will follow as monomorphize/codegen mature
    Ok(CompiledUnit(
        name: mangled,
        code: [],
        symbols: {},
        entry_point: None,
        relocations: []
    ))

# ============================================================================
# Exports
# ============================================================================

export compile_specialized_template
