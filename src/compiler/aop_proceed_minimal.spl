# AOP Proceed Enforcement - Minimal Version
# tier: full
#
# Simplified version that works within Simple's current limitations

export ProceedError, ProceedContext
export create_proceed_context_minimal

# ============================================================================
# Error Types
# ============================================================================

enum ProceedError:
    NeverCalled(advice_name: text)
    CalledMultipleTimes(advice_name: text, count: i64)

impl ProceedError:
    fn format() -> text:
        match self:
            case NeverCalled(name):
                "Around advice '{name}' must call proceed() exactly once (called 0 times)"
            case CalledMultipleTimes(name, count):
                "Around advice '{name}' must call proceed() exactly once (called {count} times)"

# ============================================================================
# Proceed Context - Simplified
# ============================================================================

class ProceedContext:
    advice_name: text
    proceed_count: i64
    has_error: bool

impl ProceedContext:
    me mark_proceed_called():
        self.proceed_count = self.proceed_count + 1

    fn was_called() -> bool:
        self.proceed_count > 0

    fn call_count() -> i64:
        self.proceed_count

    fn verify() -> Result<(), ProceedError>:
        if self.proceed_count == 0:
            return Err(ProceedError.NeverCalled(self.advice_name))

        if self.proceed_count > 1:
            return Err(ProceedError.CalledMultipleTimes(self.advice_name, self.proceed_count))

        Ok(())

# ============================================================================
# Factory Function
# ============================================================================

fn create_proceed_context_minimal(advice_name: text) -> ProceedContext:
    ProceedContext(
        advice_name: advice_name,
        proceed_count: 0,
        has_error: false
    )
