# AOP Proceed Enforcement - Minimal bootstrap-safe version

export ProceedErrorMinimal, ProceedContextMinimal
export create_proceed_context_minimal

struct ProceedErrorMinimal:
    message: text

impl ProceedErrorMinimal:
    fn format() -> text:
        self.message

struct ProceedContextMinimal:
    advice_name: text
    proceed_count: i64
    has_error: bool

impl ProceedContextMinimal:
    me mark_proceed_called():
        self.proceed_count = self.proceed_count + 1

    fn was_called() -> bool:
        self.proceed_count > 0

    fn call_count() -> i64:
        self.proceed_count

    fn verify() -> bool:
        self.proceed_count == 1

    fn error() -> ProceedErrorMinimal:
        if self.proceed_count == 0:
            return ProceedErrorMinimal(
                message: "Around advice '" + self.advice_name + "' must call proceed() exactly once (called 0 times)"
            )
        ProceedErrorMinimal(
            message: "Around advice '" + self.advice_name + "' must call proceed() exactly once (called multiple times)"
        )

fn create_proceed_context_minimal(advice_name: text) -> ProceedContextMinimal:
    ProceedContextMinimal(
        advice_name: advice_name,
        proceed_count: 0,
        has_error: false
    )
