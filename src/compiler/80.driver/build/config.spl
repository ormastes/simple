# Build Configuration
#
# Loads and parses build configuration from simple.sdn

use app.build.types (BuildConfig, BuildProfile, profile_from_string, OptimizationLevel, opt_level_from_string, default_opt_level_for_profile)
use app.io.mod (file_exists, file_read)
use std.config_parser.{parse_sdn_config, find_section, get_config_field}

# Default configuration
fn default_config() -> BuildConfig:
    BuildConfig(
        profile: BuildProfile.Debug,
        features: [],
        # Default to the in-repo Rust workspace (src/compiler_rust)
        workspace_root: "src/compiler_rust",
        target_dir: "src/compiler_rust/target",
        jobs: 4,
        verbose: false,
        opt_level: OptimizationLevel.None_,  # No optimization for debug
        show_opt_stats: false,
        warn_docs: false,
        use_lto: false,
        march_target: "",
        pgo_generate: false,
        pgo_use_path: "",
        release_optimized: false,
        target: "",
        wasm_backend: "auto"
    )

# Load configuration from simple.sdn
fn load_config(profile: BuildProfile, verbose: bool, opt_level: OptimizationLevel?, show_opt_stats: bool, warn_docs: bool) -> BuildConfig:
    var config = default_config()
    config.profile = profile
    config.verbose = verbose
    config.show_opt_stats = show_opt_stats
    config.warn_docs = warn_docs

    # Set optimization level (use provided or default for profile)
    config.opt_level = if opt_level.?:
        opt_level.unwrap()
    else:
        default_opt_level_for_profile(profile)

    # Parse simple.sdn for custom build settings if it exists
    if file_exists("simple.sdn"):
        val sdn_content = file_read("simple.sdn")
        if sdn_content != "":
            val result = parse_sdn_config(sdn_content)
            val section_opt = find_section(result, "build")

            if section_opt.?:
                # Unwrap is safe here since we checked .?
                val fields_tmp = {}
                use std.config_parser.{ConfigSection}
                val section = section_opt ?? ConfigSection(name: "", fields: fields_tmp)

                val level_str = get_config_field(section, "opt-level", "")
                if level_str.len() > 0:
                    config.opt_level = opt_level_from_string(level_str)

                val prof_str = get_config_field(section, "profile", "")
                if prof_str.len() > 0:
                    config.profile = profile_from_string(prof_str)

    config

# Parse command-line arguments
fn parse_build_args(args: [text]) -> BuildConfig:
    var profile = BuildProfile.Debug
    var features: [text] = []
    var verbose = false
    var opt_level: OptimizationLevel? = nil
    var show_opt_stats = false
    var warn_docs = false
    var use_lto = false
    var march_target = ""
    var pgo_generate = false
    var pgo_use_path = ""
    var release_optimized = false
    var target = ""
    var wasm_backend = "auto"

    for arg in args:
        if arg == "--verbose" or arg == "-v":
            verbose = true
        elif arg.starts_with("--profile="):
            val profile_str: text = arg[10:]
            profile = profile_from_string(profile_str)
        elif arg == "--release":
            profile = BuildProfile.Release
        elif arg == "--bootstrap":
            profile = BuildProfile.Bootstrap
        elif arg.starts_with("--features="):
            val features_str: text = arg[11:]
            features = features_str.split(",")
        # MIR Optimization flags (NEW!)
        elif arg.starts_with("--opt-level="):
            val level_str: text = arg[12:]
            opt_level = Some(opt_level_from_string(level_str))
        elif arg == "-O0":
            opt_level = Some(OptimizationLevel.None_)
        elif arg == "-Os":
            opt_level = Some(OptimizationLevel.Size)
        elif arg == "-O2":
            opt_level = Some(OptimizationLevel.Speed)
        elif arg == "-O3":
            opt_level = Some(OptimizationLevel.Aggressive)
        elif arg == "--show-opt-stats":
            show_opt_stats = true
        elif arg == "--warn-docs":
            warn_docs = true
        elif arg == "--lto":
            use_lto = true
        elif arg.starts_with("--march="):
            march_target = arg[8:]
        elif arg == "--pgo-generate":
            pgo_generate = true
        elif arg.starts_with("--pgo-use="):
            pgo_use_path = arg[10:]
        elif arg == "--release-optimized":
            release_optimized = true
            profile = BuildProfile.Release
            opt_level = Some(OptimizationLevel.Speed)
        elif arg.starts_with("--target="):
            target = arg[9:]
        elif arg.starts_with("--wasm-backend="):
            wasm_backend = arg[15:]

    var config = load_config(profile, verbose, opt_level, show_opt_stats, warn_docs)
    config.features = features
    config.use_lto = use_lto
    config.march_target = march_target
    config.pgo_generate = pgo_generate
    config.pgo_use_path = pgo_use_path
    config.release_optimized = release_optimized
    config.target = target
    config.wasm_backend = wasm_backend
    if release_optimized:
        config.use_lto = true
        if config.march_target == "":
            config.march_target = "x86-64-v3"
    config
