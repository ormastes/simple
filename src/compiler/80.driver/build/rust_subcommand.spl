# Rust Subcommand Handler
#
# Handles `simple build rust <subcommand>` routing

use app.build.config (parse_build_args)
use app.build.cargo (Cargo, print_build_result, print_test_result)

# Handle `simple build rust <subcommand>` routing
fn handle_rust_subcommand(args: [text]) -> i64:
    if args.len() == 0:
        # `simple build rust` = build Rust workspace
        val config = parse_build_args([])
        val result = Cargo.build(config)
        print_build_result(result)
        if result.success:
            return 0
        else:
            return result.exit_code

    val cmd = args[0]
    match cmd:
        case "test":
            return handle_rust_test(args[1:])
        case "lint":
            val fix = args.len() > 1 and args[1] == "--fix"
            val result = Cargo.lint(fix)
            print_build_result(result)
            if result.success:
                return 0
            else:
                return result.exit_code
        case "fmt":
            val check_only = args.len() > 1 and args[1] == "--check"
            val result = Cargo.fmt(check_only)
            print_build_result(result)
            if result.success:
                return 0
            else:
                return result.exit_code
        case "check":
            val result = Cargo.check()
            print_build_result(result)
            if result.success:
                return 0
            else:
                return result.exit_code
        case "clean":
            val exit_code = Cargo.clean()
            if exit_code == 0:
                print "Rust build artifacts cleaned."
            else:
                print "Failed to clean Rust build artifacts."
            return exit_code
        case _:
            print "Unknown rust subcommand: {cmd}"
            print "Run 'simple build --help' for usage."
            return 1

# Handle `simple build rust test` with options
fn handle_rust_test(args: [text]) -> i64:
    var doc_only = false
    var package = ""
    var filter = ""
    var i = 0
    while i < args.len():
        val arg = args[i]
        if arg == "--doc":
            doc_only = true
        elif arg == "-p" and i + 1 < args.len():
            i = i + 1
            package = args[i]
        else:
            filter = arg
        i = i + 1

    if doc_only:
        print "=== Running Rust Doc-Tests ==="
        val result = Cargo.test_doc(package)
        print_test_result(result)
        if result.success:
            return 0
        else:
            return result.exit_code
    else:
        print "=== Running Rust Tests ==="
        val result = Cargo.test(package, filter)
        print_test_result(result)
        if result.success:
            return 0
        else:
            return result.exit_code
