# Duplication Check - Build System Integration
#
# Runs code duplication detection as part of quality phase.
# Calls the duplicate_check library API directly (in-process).

use app.io.{file_exists, file_read}
use app.duplicate_check.config.{default_config, DuplicationConfig}
use app.duplicate_check.detector.{find_duplicates, collect_files}
use app.duplicate_check.formatter.{write_sdn_database, print_text_report}
use app.duplicate_check.cache.{new_token_cache_manager}

struct DuplicationCheckConfig:
    enabled: bool
    fail_on_duplicates: bool
    max_allowed: i64
    min_tokens: i64
    min_lines: i64
    min_impact: i64
    report_path: text

struct DuplicationCheckResult:
    success: bool
    duplicate_groups: i64
    total_lines: i64
    exit_code: i64
    message: text

fn default_duplication_config() -> DuplicationCheckConfig:
    """Default configuration for duplication checking."""
    DuplicationCheckConfig(
        enabled: true,
        fail_on_duplicates: false,
        max_allowed: 0,
        min_tokens: 30,
        min_lines: 5,
        min_impact: 100,
        report_path: "doc/analysis/duplicate_db.sdn"
    )

fn run_duplication_check(config: DuplicationCheckConfig) -> DuplicationCheckResult:
    """Run duplication detection and return results.

    Args:
        config: Duplication check configuration

    Returns:
        Result with success status and metrics
    """
    if not config.enabled:
        return DuplicationCheckResult(
            success: true,
            duplicate_groups: 0,
            total_lines: 0,
            exit_code: 0,
            message: "Duplication check disabled"
        )

    print "Running duplication check..."

    # Call duplicate_check library API directly (in-process, no subprocess)
    var det_config = default_config()
    det_config.min_tokens = config.min_tokens
    det_config.min_lines = config.min_lines
    det_config.min_impact = config.min_impact
    det_config.output_format = "sdn"
    det_config.report_path = config.report_path

    val files = collect_files("src/", det_config)
    val cache_manager = new_token_cache_manager()
    val groups = find_duplicates(files, det_config, cache_manager)

    # Write SDN report
    write_sdn_database(groups, config.report_path)

    val duplicate_groups = groups.len()

    # Count total duplicated lines
    var total_lines = 0
    for group in groups:
        total_lines = total_lines + group.total_lines

    # Determine success based on configuration
    var success = true
    var message = "No code duplication detected"

    if duplicate_groups > 0:
        message = "Found {duplicate_groups} duplicate groups ({total_lines} lines)"

        if config.fail_on_duplicates and duplicate_groups > config.max_allowed:
            success = false
            message = "FAILED: {duplicate_groups} duplicate groups exceed limit of {config.max_allowed}"

    DuplicationCheckResult(
        success: success,
        duplicate_groups: duplicate_groups,
        total_lines: total_lines,
        exit_code: if success: 0 else: 1,
        message: message
    )

fn print_duplication_summary(result: DuplicationCheckResult):
    """Print duplication check summary."""
    print ""
    print "Duplication Check Results:"
    print "  Duplicate groups: {result.duplicate_groups}"
    print "  Total duplicated lines: {result.total_lines}"
    print "  Status: {result.message}"

    if not result.success:
        print ""
        print "  Run 'bin/simple duplicate-check src/' to see details"

export DuplicationCheckConfig, DuplicationCheckResult
export default_duplication_config, run_duplication_check, print_duplication_summary
