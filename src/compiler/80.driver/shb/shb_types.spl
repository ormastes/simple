# SHB (Simple Header Binary) â€” Type Definitions
#
# FlatBuffer-style .shb format for caching module public interfaces.
# All offsets are u32 into the string table unless noted.
# All multi-byte integers are little-endian.

# --- Magic & Version ---

val SHB_MAGIC_0: u8 = 0x53  # 'S'
val SHB_MAGIC_1: u8 = 0x48  # 'H'
val SHB_MAGIC_2: u8 = 0x42  # 'B'
val SHB_MAGIC_3: u8 = 0x00  # NUL
val SHB_VERSION_MAJOR: u8 = 1
val SHB_VERSION_MINOR: u8 = 0

# --- Fixed sizes ---

val SHB_HEADER_SIZE: i64 = 64
val SHB_SECTION_TABLE_SIZE: i64 = 64
val SHB_SECTION_COUNT: i64 = 8

# --- Section indices ---

val SHB_SECTION_FUNCTIONS: i64 = 0
val SHB_SECTION_STRUCTS: i64 = 1
val SHB_SECTION_CLASSES: i64 = 2
val SHB_SECTION_TYPE_LAYOUTS: i64 = 3
val SHB_SECTION_ENUMS: i64 = 4
val SHB_SECTION_TRAITS: i64 = 5
val SHB_SECTION_REEXPORTS: i64 = 6
val SHB_SECTION_DEPENDENCIES: i64 = 7

# --- Flags ---

val SHB_FLAG_NONE: i64 = 0
val SHB_FLAG_PUB: i64 = 1
val SHB_FLAG_ASYNC: i64 = 2
val SHB_FLAG_GENERATOR: i64 = 4
val SHB_FLAG_MUTABLE: i64 = 8
val SHB_FLAG_STATIC: i64 = 16
val SHB_FLAG_COMPTIME: i64 = 32
val SHB_FLAG_OPTIONAL: i64 = 64

# --- Platform / Arch ---

val SHB_PLATFORM_LINUX: u8 = 1
val SHB_PLATFORM_MACOS: u8 = 2
val SHB_PLATFORM_WINDOWS: u8 = 3

val SHB_ARCH_X86_64: u8 = 1
val SHB_ARCH_AARCH64: u8 = 2
val SHB_ARCH_RISCV64: u8 = 3

# --- Primitive type layout constants ---

val LAYOUT_I8_SIZE: i64 = 1
val LAYOUT_I8_ALIGN: i64 = 1
val LAYOUT_I16_SIZE: i64 = 2
val LAYOUT_I16_ALIGN: i64 = 2
val LAYOUT_I32_SIZE: i64 = 4
val LAYOUT_I32_ALIGN: i64 = 4
val LAYOUT_I64_SIZE: i64 = 8
val LAYOUT_I64_ALIGN: i64 = 8
val LAYOUT_F32_SIZE: i64 = 4
val LAYOUT_F32_ALIGN: i64 = 4
val LAYOUT_F64_SIZE: i64 = 8
val LAYOUT_F64_ALIGN: i64 = 8
val LAYOUT_BOOL_SIZE: i64 = 1
val LAYOUT_BOOL_ALIGN: i64 = 1
val LAYOUT_TEXT_SIZE: i64 = 16
val LAYOUT_TEXT_ALIGN: i64 = 8
val LAYOUT_USIZE_SIZE: i64 = 8
val LAYOUT_USIZE_ALIGN: i64 = 8

# --- Core structs ---

struct ShbHeader:
    magic: [u8]
    version_major: u8
    version_minor: u8
    platform: u8
    arch: u8
    source_hash: i64
    interface_hash: i64
    write_timestamp: i64
    section_count: i64
    string_table_offset: i64
    string_table_size: i64
    flags: i64
    module_name_offset: i64

struct ShbSectionTable:
    offsets: [i64]

struct ShbParam:
    name: text
    type_name: text

struct ShbFnEntry:
    name: text
    params: [ShbParam]
    return_type: text
    flags: i64

struct ShbFieldEntry:
    name: text
    type_name: text
    flags: i64

struct ShbStructEntry:
    name: text
    fields: [ShbFieldEntry]
    flags: i64

struct ShbMethodRef:
    name: text

struct ShbClassEntry:
    name: text
    fields: [ShbFieldEntry]
    methods: [ShbMethodRef]
    flags: i64

struct ShbEnumEntry:
    name: text
    variants: [text]
    flags: i64

struct ShbTraitEntry:
    name: text
    methods: [text]
    flags: i64

struct ShbReexportEntry:
    symbol_name: text
    source_module: text

struct ShbTypeLayoutEntry:
    type_name: text
    size: i64
    alignment: i64
    flags: i64

struct ShbDependencyEntry:
    module_path: text
    interface_hash: i64

struct ShbModuleInterface:
    header: ShbHeader
    functions: [ShbFnEntry]
    structs: [ShbStructEntry]
    classes: [ShbClassEntry]
    enums: [ShbEnumEntry]
    traits: [ShbTraitEntry]
    reexports: [ShbReexportEntry]
    type_layouts: [ShbTypeLayoutEntry]
    dependencies: [ShbDependencyEntry]

# --- Factory functions ---

fn shb_header_new(source_hash: i64, interface_hash: i64, module_name_offset: i64) -> ShbHeader:
    ShbHeader(
        magic: [SHB_MAGIC_0, SHB_MAGIC_1, SHB_MAGIC_2, SHB_MAGIC_3],
        version_major: SHB_VERSION_MAJOR,
        version_minor: SHB_VERSION_MINOR,
        platform: detect_platform(),
        arch: detect_arch(),
        source_hash: source_hash,
        interface_hash: interface_hash,
        write_timestamp: rt_time_now_unix_micros(),
        section_count: SHB_SECTION_COUNT,
        string_table_offset: 0,
        string_table_size: 0,
        flags: 0,
        module_name_offset: module_name_offset
    )

fn shb_section_table_new() -> ShbSectionTable:
    ShbSectionTable(offsets: [0, 0, 0, 0, 0, 0, 0, 0])

fn shb_module_interface_new(source_hash: i64, interface_hash: i64) -> ShbModuleInterface:
    ShbModuleInterface(
        header: shb_header_new(source_hash, interface_hash, 0),
        functions: [],
        structs: [],
        classes: [],
        enums: [],
        traits: [],
        reexports: [],
        type_layouts: [],
        dependencies: []
    )

# --- Primitive type layouts ---

fn shb_primitive_layouts() -> [ShbTypeLayoutEntry]:
    var layouts: [ShbTypeLayoutEntry] = []
    layouts.push(ShbTypeLayoutEntry(type_name: "i8", size: LAYOUT_I8_SIZE, alignment: LAYOUT_I8_ALIGN, flags: 0))
    layouts.push(ShbTypeLayoutEntry(type_name: "u8", size: LAYOUT_I8_SIZE, alignment: LAYOUT_I8_ALIGN, flags: 0))
    layouts.push(ShbTypeLayoutEntry(type_name: "bool", size: LAYOUT_BOOL_SIZE, alignment: LAYOUT_BOOL_ALIGN, flags: 0))
    layouts.push(ShbTypeLayoutEntry(type_name: "i16", size: LAYOUT_I16_SIZE, alignment: LAYOUT_I16_ALIGN, flags: 0))
    layouts.push(ShbTypeLayoutEntry(type_name: "u16", size: LAYOUT_I16_SIZE, alignment: LAYOUT_I16_ALIGN, flags: 0))
    layouts.push(ShbTypeLayoutEntry(type_name: "i32", size: LAYOUT_I32_SIZE, alignment: LAYOUT_I32_ALIGN, flags: 0))
    layouts.push(ShbTypeLayoutEntry(type_name: "u32", size: LAYOUT_I32_SIZE, alignment: LAYOUT_I32_ALIGN, flags: 0))
    layouts.push(ShbTypeLayoutEntry(type_name: "f32", size: LAYOUT_F32_SIZE, alignment: LAYOUT_F32_ALIGN, flags: 0))
    layouts.push(ShbTypeLayoutEntry(type_name: "i64", size: LAYOUT_I64_SIZE, alignment: LAYOUT_I64_ALIGN, flags: 0))
    layouts.push(ShbTypeLayoutEntry(type_name: "u64", size: LAYOUT_I64_SIZE, alignment: LAYOUT_I64_ALIGN, flags: 0))
    layouts.push(ShbTypeLayoutEntry(type_name: "f64", size: LAYOUT_F64_SIZE, alignment: LAYOUT_F64_ALIGN, flags: 0))
    layouts.push(ShbTypeLayoutEntry(type_name: "isize", size: LAYOUT_USIZE_SIZE, alignment: LAYOUT_USIZE_ALIGN, flags: 0))
    layouts.push(ShbTypeLayoutEntry(type_name: "usize", size: LAYOUT_USIZE_SIZE, alignment: LAYOUT_USIZE_ALIGN, flags: 0))
    layouts.push(ShbTypeLayoutEntry(type_name: "text", size: LAYOUT_TEXT_SIZE, alignment: LAYOUT_TEXT_ALIGN, flags: 0))
    layouts

# --- Platform detection ---

extern fn rt_time_now_unix_micros() -> i64

fn detect_platform() -> u8:
    SHB_PLATFORM_LINUX

fn detect_arch() -> u8:
    SHB_ARCH_X86_64

# --- Validation ---

fn shb_header_valid(header: ShbHeader) -> bool:
    if header.magic.len() != 4:
        return false
    if header.magic[0] != SHB_MAGIC_0:
        return false
    if header.magic[1] != SHB_MAGIC_1:
        return false
    if header.magic[2] != SHB_MAGIC_2:
        return false
    if header.magic[3] != SHB_MAGIC_3:
        return false
    if header.version_major != SHB_VERSION_MAJOR:
        return false
    true
