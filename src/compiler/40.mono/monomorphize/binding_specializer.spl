# Binding Specializer
#
# Interface binding specialization for static polymorphism.
# When `bind Logger = ConsoleLogger` is declared, trait method calls
# on Logger-typed values are rewritten to ConsoleLogger method calls.
#
# Port of rust/compiler/src/monomorphize/binding_specializer.rs (80+ lines)

export InterfaceBinding, BindingSpecializer

# ============================================================================
# Types
# ============================================================================

struct InterfaceBinding:
    interface_name: text
    impl_type_name: text

# ============================================================================
# Binding Specializer
# ============================================================================

class BindingSpecializer:
    """Rewrites method calls based on interface bindings for static dispatch."""
    bindings: {text: text}    # interface_name -> impl_type_name

impl BindingSpecializer:
    static fn create() -> BindingSpecializer:
        BindingSpecializer(bindings: {})

    static fn from_bindings(bindings: [InterfaceBinding]) -> BindingSpecializer:
        var map: {text: text} = {}
        for b in bindings:
            map[b.interface_name] = b.impl_type_name
        BindingSpecializer(bindings: map)

    me add_binding(interface_name: text, impl_type: text):
        self.bindings[interface_name] = impl_type

    fn has_bindings() -> bool:
        self.bindings.?

    fn get_binding(trait_name: text) -> text?:
        if self.bindings.contains_key(trait_name):
            Some(self.bindings[trait_name])
        else:
            nil

    fn resolve_method(receiver_type: text, method: text) -> text?:
        """Resolve a trait method call to its concrete implementation."""
        if self.bindings.contains_key(receiver_type):
            val impl_type = self.bindings[receiver_type]
            Some("{impl_type}.{method}")
        else:
            nil
