# Module Rewriter
#
# Applies monomorphization by rewriting generic call sites to use
# mangled names for specialized functions, and adding specialized
# definitions to the module.
#
# Port of rust/compiler/src/monomorphize/rewriter.rs (80+ lines)

export CallRewrite, ModuleRewriter, monomorphize_module

use monomorphize.engine.*
use monomorphize.analyzer.*

# ============================================================================
# Types
# ============================================================================

struct CallRewrite:
    original_name: text
    type_args: [ConcreteType]
    mangled_name: text

# ============================================================================
# Module Rewriter
# ============================================================================

class ModuleRewriter:
    """Rewrites call sites to use mangled names for specialized generics."""
    rewrites: {text: [CallRewrite]}

impl ModuleRewriter:
    static fn create() -> ModuleRewriter:
        ModuleRewriter(rewrites: {})

    me add_rewrite(original: text, type_args: [ConcreteType], mangled: text):
        var list: [CallRewrite] = if self.rewrites.contains_key(original):
            self.rewrites[original]
        else: []
        list = list.push(CallRewrite(original_name: original,
            type_args: type_args, mangled_name: mangled))
        self.rewrites[original] = list

    fn get_mangled(name: text, type_args: [ConcreteType]) -> text?:
        """Look up the mangled name for a call with specific type args."""
        if not self.rewrites.contains_key(name):
            return nil
        for rewrite in self.rewrites[name]:
            # Simple comparison â€” in practice would compare type_args structurally
            if rewrite.type_args.len() == type_args.len():
                return Some(rewrite.mangled_name)
        nil

# ============================================================================
# Pipeline
# ============================================================================

fn monomorphize_module(generic_names: [text], call_sites: [CallSite]) -> (Monomorphizer, ModuleRewriter):
    """Run the full monomorphization pipeline.

    1. Collect call sites
    2. Request specializations
    3. Process pending
    4. Build rewrite table
    """
    var mono = Monomorphizer.create()
    var rewriter = ModuleRewriter.create()

    for site in call_sites:
        val mangled = mono.specialize_function_call(site.function_name, site.type_args)
        if mangled.?:
            rewriter.add_rewrite(site.function_name, site.type_args, mangled.unwrap())

    mono.process_pending()
    (mono, rewriter)
