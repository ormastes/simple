# Shared Platform Detection Utilities
#
# Common helpers for detecting OS, architecture, and CPU from environment
# variables. Used by both the parser (compile-time @cfg) and the interpreter
# (runtime @when) conditional compilation systems.

extern fn rt_env_get(key: text) -> text

fn cfg_env(key: text) -> text:
    val value = rt_env_get(key)
    if value == nil:
        return ""
    value

fn cfg_strip_quotes(value: text) -> text:
    val trimmed = value.trim()
    if trimmed.len() >= 2:
        val is_double = trimmed.starts_with("\"") and trimmed.ends_with("\"")
        val is_single = trimmed.starts_with("'") and trimmed.ends_with("'")
        if is_double or is_single:
            return trimmed.slice(1, trimmed.len() - 1)
    trimmed

fn cfg_normalize_os(raw: text) -> text:
    val value = cfg_strip_quotes(raw).trim()
    if value == "":
        return ""

    val is_win = value == "win" or value == "WIN"
    val is_win2 = value == "windows" or value == "Windows"
    val is_win3 = value == "Windows_NT" or value.contains("Windows")
    if is_win or is_win2 or is_win3:
        return "windows"

    val is_linux = value == "linux" or value == "Linux"
    val is_linux2 = value.contains("linux") or value.contains("Linux")
    if is_linux or is_linux2:
        return "linux"

    val is_macos = value == "mac" or value == "macos"
    val is_macos2 = value == "MacOS" or value == "darwin" or value == "Darwin"
    val is_macos3 = value.contains("darwin") or value.contains("Darwin")
    val is_macos4 = value.contains("macOS") or value.contains("Mac")
    if is_macos or is_macos2 or is_macos3 or is_macos4:
        return "macos"

    val is_freebsd = value == "freebsd" or value == "FreeBSD"
    val is_freebsd2 = value.contains("freebsd") or value.contains("FreeBSD")
    if is_freebsd or is_freebsd2:
        return "freebsd"

    val is_openbsd = value == "openbsd" or value == "OpenBSD"
    val is_openbsd2 = value.contains("openbsd") or value.contains("OpenBSD")
    if is_openbsd or is_openbsd2:
        return "openbsd"

    val is_netbsd = value == "netbsd" or value == "NetBSD"
    val is_netbsd2 = value.contains("netbsd") or value.contains("NetBSD")
    if is_netbsd or is_netbsd2:
        return "netbsd"

    val is_android = value == "android" or value == "Android"
    val is_android2 = value.contains("android") or value.contains("Android")
    if is_android or is_android2:
        return "android"

    val is_unix = value == "unix" or value == "Unix"
    val is_unix2 = value.contains("unix") or value.contains("Unix")
    if is_unix or is_unix2:
        return "unix"

    ""

fn cfg_normalize_arch(raw: text) -> text:
    val value = cfg_strip_quotes(raw).trim()
    if value == "":
        return ""

    val is_x64 = value == "x86_64" or value == "amd64" or value == "AMD64"
    val is_x64_2 = value == "x64" or value == "X64"
    val is_x64_3 = value.contains("x86_64") or value.contains("amd64") or value.contains("AMD64")
    if is_x64 or is_x64_2 or is_x64_3:
        return "x86_64"

    val is_x86 = value == "x86" or value == "X86"
    val is_x86_2 = value == "i386" or value == "i686"
    val is_x86_3 = value.contains("i386") or value.contains("i686")
    if is_x86 or is_x86_2 or is_x86_3:
        return "x86"

    val is_aarch64 = value == "aarch64" or value == "arm64" or value == "ARM64"
    val is_aarch64_2 = value.contains("aarch64") or value.contains("arm64")
    if is_aarch64 or is_aarch64_2:
        return "aarch64"

    val is_arm = value == "arm" or value == "ARM"
    val is_arm2 = value == "armv7" or value == "armv6"
    val is_arm3 = value.contains("armv7") or value.contains("armv6")
    if is_arm or is_arm2 or is_arm3:
        return "arm"

    val is_riscv64 = value == "riscv64" or value.contains("riscv64")
    if is_riscv64:
        return "riscv64"

    val is_riscv32 = value == "riscv32" or value.contains("riscv32")
    if is_riscv32:
        return "riscv32"

    val is_ppc64le = value == "ppc64le" or value == "ppc64el"
    val is_ppc64le2 = value == "powerpc64le"
    val is_ppc64le3 = value.contains("ppc64le") or value.contains("powerpc64le")
    if is_ppc64le or is_ppc64le2 or is_ppc64le3:
        return "ppc64le"

    ""

fn cfg_detect_os() -> text:
    val forced = cfg_normalize_os(cfg_env("SIMPLE_TARGET_OS"))
    if forced != "":
        return forced

    val from_os = cfg_normalize_os(cfg_env("OS"))
    if from_os != "":
        return from_os

    val from_ostype = cfg_normalize_os(cfg_env("OSTYPE"))
    if from_ostype != "":
        return from_ostype

    val from_platform = cfg_normalize_os(cfg_env("PLATFORM"))
    if from_platform != "":
        return from_platform

    val from_uname = cfg_normalize_os(cfg_env("UNAME"))
    if from_uname != "":
        return from_uname

    "unknown"

fn cfg_detect_arch() -> text:
    val forced = cfg_normalize_arch(cfg_env("SIMPLE_TARGET_ARCH"))
    if forced != "":
        return forced

    val from_arch = cfg_normalize_arch(cfg_env("PROCESSOR_ARCHITECTURE"))
    if from_arch != "":
        return from_arch

    val from_hosttype = cfg_normalize_arch(cfg_env("HOSTTYPE"))
    if from_hosttype != "":
        return from_hosttype

    val from_machtype = cfg_normalize_arch(cfg_env("MACHTYPE"))
    if from_machtype != "":
        return from_machtype

    val from_cpu = cfg_normalize_arch(cfg_env("CPU"))
    if from_cpu != "":
        return from_cpu

    "unknown"

fn cfg_detect_cpu() -> text:
    val forced = cfg_normalize_arch(cfg_env("SIMPLE_TARGET_CPU"))
    if forced != "":
        return forced

    val from_id = cfg_normalize_arch(cfg_env("PROCESSOR_IDENTIFIER"))
    if from_id != "":
        return from_id

    cfg_detect_arch()

fn cfg_eval_key_value(key_raw: text, value_raw: text) -> bool:
    val key = cfg_strip_quotes(key_raw).trim()
    val value = cfg_strip_quotes(value_raw).trim()

    if key == "os":
        val expected = cfg_normalize_os(value)
        if expected == "unix":
            val os = cfg_detect_os()
            val is_unix = os == "linux" or os == "macos"
            val is_unix2 = os == "freebsd" or os == "openbsd"
            val is_unix3 = os == "netbsd" or os == "android"
            return is_unix or is_unix2 or is_unix3 or os == "unix"
        return expected != "" and cfg_detect_os() == expected
    if key == "platform":
        val expected = cfg_normalize_os(value)
        if expected == "unix":
            val os = cfg_detect_os()
            val is_unix = os == "linux" or os == "macos"
            val is_unix2 = os == "freebsd" or os == "openbsd"
            val is_unix3 = os == "netbsd" or os == "android"
            return is_unix or is_unix2 or is_unix3 or os == "unix"
        return expected != "" and cfg_detect_os() == expected
    if key == "arch":
        val expected = cfg_normalize_arch(value)
        return expected != "" and cfg_detect_arch() == expected
    if key == "cpu":
        val expected = cfg_normalize_arch(value)
        return expected != "" and cfg_detect_cpu() == expected
    if key == "feature":
        return false

    false

export cfg_env, cfg_strip_quotes, cfg_normalize_os, cfg_normalize_arch
export cfg_detect_os, cfg_detect_arch, cfg_detect_cpu, cfg_eval_key_value
