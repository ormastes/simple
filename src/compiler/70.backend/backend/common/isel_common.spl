# ISel Common Structs and Utilities
#
# Shared data structures and helper functions used by all native ISel backends
# (x86_64, AArch64, RISC-V 64, RISC-V 32).

use compiler.backend.native.mach_inst.{MachReg, virtual_reg, Operand, op_reg, MachInst, new_mach_inst, MachBlock, MachFunction}
use compiler.backend.common.isel_context.{ISelContext, isel_alloc_vreg, isel_get_vreg}

# ============================================================================
# Shared Result Structs
# ============================================================================

struct LoweredOperand:
    insts: [MachInst]
    result: Operand
    ctx: ISelContext

struct ISelFuncResult:
    func: MachFunction
    ctx: ISelContext

struct ISelBlockResult:
    block: MachBlock
    ctx: ISelContext

struct ISelInstResult:
    insts: [MachInst]
    ctx: ISelContext

# ============================================================================
# Local to Virtual Register Mapping
# ============================================================================

fn local_to_vreg(local_id: i64) -> MachReg:
    virtual_reg(local_id)

fn local_vreg_op(local_id: i64) -> Operand:
    op_reg(virtual_reg(local_id))

# ============================================================================
# Vreg Allocation Helpers
# ============================================================================

fn isel_fresh_dest(ctx: ISelContext) -> LoweredOperand:
    """Allocate a new vreg and return LoweredOperand with empty insts.
    Use when building multi-instruction sequences that need a fresh destination."""
    var new_ctx = isel_alloc_vreg(ctx)
    val vreg = isel_get_vreg(new_ctx)
    val dest = op_reg(virtual_reg(vreg))
    LoweredOperand(insts: [], result: dest, ctx: new_ctx)

fn isel_emit_one(ctx: ISelContext, opcode: i64, extra_ops: [Operand]) -> LoweredOperand:
    """Allocate a new vreg, emit a single instruction with [dest] + extra_ops,
    and return as LoweredOperand. Covers the most common ISel pattern."""
    var new_ctx = isel_alloc_vreg(ctx)
    val vreg = isel_get_vreg(new_ctx)
    val dest = op_reg(virtual_reg(vreg))
    val inst = new_mach_inst(opcode, [dest] + extra_ops)
    LoweredOperand(insts: [inst], result: dest, ctx: new_ctx)

# ============================================================================
# Exports
# ============================================================================

export LoweredOperand, ISelFuncResult, ISelBlockResult, ISelInstResult
export local_to_vreg, local_vreg_op
export isel_fresh_dest, isel_emit_one
