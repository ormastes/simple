# Instruction Selection Context Management
#
# Shared ISel context structure and operations used across all native backends
# (x86_64, AArch64, RISC-V). Manages virtual register allocation, frame slot
# tracking, string constant handling, and extern symbol tracking.
#
# The context is immutable and passed through ISel passes, returning updated
# copies as transformations occur.

use compiler.backend.native.mach_inst.{DataEntry}

struct ISelContext:
    """
    Instruction selection context.

    Tracks virtual register allocation, stack frame layout, string constants,
    and extern symbols during instruction selection.
    """
    next_vreg: i64              # Next available virtual register ID
    frame_slots: Dict<i64, i64> # Map from local ID to frame offset
    next_frame_offset: i64      # Current stack frame size
    extern_symbols: [text]      # List of extern function symbols
    data_entries: [DataEntry]   # Data section entries (string constants)
    string_counter: i64         # String label counter (.LC0, .LC1, ...)

fn new_isel_context() -> ISelContext:
    """Create a new empty ISel context."""
    ISelContext(
        next_vreg: 0,
        frame_slots: {},
        next_frame_offset: 0,
        extern_symbols: [],
        data_entries: [],
        string_counter: 0
    )

fn isel_alloc_vreg(ctx: ISelContext) -> ISelContext:
    """
    Allocate a new virtual register and return updated context.

    The newly allocated vreg ID is ctx.next_vreg (retrieve with isel_get_vreg).
    """
    ISelContext(
        next_vreg: ctx.next_vreg + 1,
        frame_slots: ctx.frame_slots,
        next_frame_offset: ctx.next_frame_offset,
        extern_symbols: ctx.extern_symbols,
        data_entries: ctx.data_entries,
        string_counter: ctx.string_counter
    )

fn isel_get_vreg(ctx: ISelContext) -> i64:
    """Get the most recently allocated virtual register ID."""
    ctx.next_vreg - 1

fn isel_alloc_frame_slot_aligned(ctx: ISelContext, local_id: i64, size: i64, min_align: i64) -> ISelContext:
    """
    Allocate a stack frame slot for a local variable with custom alignment.

    Args:
        local_id: Local variable identifier
        size: Size in bytes
        min_align: Minimum alignment in bytes (e.g. 8 for 64-bit, 4 for 32-bit)

    Returns updated context with frame_slots map and next_frame_offset updated.
    """
    val aligned_size = if size < min_align: min_align else: size
    val offset = ctx.next_frame_offset + aligned_size
    var slots = ctx.frame_slots
    slots[local_id] = offset
    ISelContext(
        next_vreg: ctx.next_vreg,
        frame_slots: slots,
        next_frame_offset: offset,
        extern_symbols: ctx.extern_symbols,
        data_entries: ctx.data_entries,
        string_counter: ctx.string_counter
    )

fn isel_alloc_frame_slot(ctx: ISelContext, local_id: i64, size: i64) -> ISelContext:
    """
    Allocate a stack frame slot for a local variable.

    Args:
        local_id: Local variable identifier
        size: Size in bytes (aligned to 8-byte minimum)

    Returns updated context with frame_slots map and next_frame_offset updated.
    """
    isel_alloc_frame_slot_aligned(ctx, local_id, size, 8)

fn isel_frame_offset(ctx: ISelContext, local_id: i64) -> i64:
    """Get frame offset for a local variable (0 if not allocated)."""
    if ctx.frame_slots.contains(local_id):
        return ctx.frame_slots[local_id]
    0

fn isel_add_extern(ctx: ISelContext, name: text) -> ISelContext:
    """
    Add an extern symbol to the module's symbol table.

    Deduplicates symbols to avoid breaking symbol indexing in object files.
    """
    # Check if already added (avoid duplicates that break symbol indexing)
    var already_added = false
    for existing in ctx.extern_symbols:
        if existing == name:
            already_added = true
    if already_added:
        return ctx
    var new_ext = ctx.extern_symbols
    new_ext.push(name)
    ISelContext(
        next_vreg: ctx.next_vreg,
        frame_slots: ctx.frame_slots,
        next_frame_offset: ctx.next_frame_offset,
        extern_symbols: new_ext,
        data_entries: ctx.data_entries,
        string_counter: ctx.string_counter
    )

fn isel_add_string_data(ctx: ISelContext, s: text, char_to_ascii_fn: fn(text) -> i64) -> ISelContext:
    """
    Add a string constant to the data section.

    Args:
        s: The string literal to add
        char_to_ascii_fn: Backend-specific character conversion function

    Returns updated context with new data entry and incremented string counter.
    The label for this string is ".LC{old_string_counter}".
    """
    val label = ".LC{ctx.string_counter}"
    var str_bytes: [i64] = []
    for i in 0..s.len():
        val ch = s[i]
        var ascii = char_to_ascii_fn(ch)
        str_bytes.push(ascii)
    str_bytes.push(0)  # Null terminator
    val entry = DataEntry(name: label, data: str_bytes, is_readonly: true)
    var new_data = ctx.data_entries
    new_data.push(entry)
    ISelContext(
        next_vreg: ctx.next_vreg,
        frame_slots: ctx.frame_slots,
        next_frame_offset: ctx.next_frame_offset,
        extern_symbols: ctx.extern_symbols,
        data_entries: new_data,
        string_counter: ctx.string_counter + 1
    )

fn isel_last_string_label(ctx: ISelContext) -> text:
    """Get the label of the most recently added string constant."""
    ".LC{ctx.string_counter - 1}"

export ISelContext, new_isel_context
export isel_alloc_vreg, isel_get_vreg
export isel_alloc_frame_slot_aligned, isel_alloc_frame_slot, isel_frame_offset
export isel_add_extern, isel_add_string_data, isel_last_string_label
