# Type Substitution
#
# Minimal, parser-safe substitution API used by monomorphization.

use hir_types.*
use hir_definitions.*
use monomorphize.engine.ConcreteType
use lexer.Span

export TypeSubstitution
export typesubstitution_empty, typesubstitution_from_params, typesubstitution_from_concrete
export substitute_type, substitute_expr, substitute_function


class TypeSubstitution:
    """Maps type parameter names to concrete HirTypes."""
    mapping: Dict<text, HirType>


fn typesubstitution_empty() -> TypeSubstitution:
    TypeSubstitution(mapping: {})


fn typesubstitution_from_params(type_params: [HirTypeParam], type_args: [HirType]) -> TypeSubstitution:
    """Create substitution from type parameters and concrete HIR arguments."""
    var map: Dict<text, HirType> = {}
    var i = 0
    for param in type_params:
        if i < type_args_len(type_args):
            map[param.name] = type_args[i]
        i = i + 1
    TypeSubstitution(mapping: map)


fn concrete_to_hir_type(ct: ConcreteType, span: Span) -> HirType:
    """Best-effort conversion fallback for bootstrap paths."""
    HirType(kind: HirTypeKind.Error, span: span)


fn typesubstitution_from_concrete(type_params: [HirTypeParam], type_args: [ConcreteType]) -> TypeSubstitution:
    """Create substitution from type parameters and concrete monomorphized arguments."""
    var map: Dict<text, HirType> = {}
    var i = 0
    for param in type_params:
        if i < type_args_len(type_args):
            map[param.name] = concrete_to_hir_type(type_args[i], param.span)
        i = i + 1
    TypeSubstitution(mapping: map)


fn substitute_type(ty: HirType, subst: TypeSubstitution) -> HirType:
    """Substitute type parameters inside a type (minimal identity fallback)."""
    ty


fn substitute_expr(expr: HirExpr, subst: TypeSubstitution) -> HirExpr:
    """Substitute type parameters inside an expression (minimal identity fallback)."""
    expr


fn substitute_function(func: HirFunction, subst: TypeSubstitution, mangled_name: text) -> HirFunction:
    """Substitute function-level type parameters for a specialized function."""
    var specialized = func
    specialized.name = mangled_name
    specialized.type_params = []
    specialized.return_type = substitute_type(func.return_type, subst)
    specialized
