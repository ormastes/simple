# Deferred Monomorphization - Binary SMF Deserialization
#
# Binary deserialization helpers for reading generic template definitions
# from compiled .smf (Simple Module Format) files. Reads length-prefixed
# text fields, lists, dictionaries, and full AST node definitions.
#
# Binary format details:
# - All integers are little-endian
# - Text fields are u32-length-prefixed UTF-8 strings
# - Optional fields use 0x01/0x00 tag byte
# - Lists are u32-count-prefixed sequences
# - Dictionaries are u32-count-prefixed key-value sequences
#
# RUNTIME COMPATIBILITY: Uses nil-check error pattern instead of Result<T,E>

export read_u32
export read_text_field
export read_optional_text_field
export read_text_list
export read_text_dict
export read_generic_params
export deserialize_function_def
export deserialize_struct_def
export deserialize_class_def
export deserialize_enum_def
export deserialize_trait_def

use compiler.mono.monomorphize.deferred_subst (deferred_set_error)use compiler.frontend.ast (FunctionDef, StructDef, ClassDef, EnumDef, TraitDef)
# ============================================================================
# Binary Deserialization Helpers
# ============================================================================

fn read_u32(data: [u8], offset: i64) -> (i64, i64)?:
    """Read a u32 from data at offset. Returns (value, new_offset)."""
    if offset + 4 > data.len():
        deferred_set_error("Unexpected end of data reading u32 at offset {offset}")
        return nil
    val value = ((data[offset] as i64) +
                ((data[offset + 1] as i64) << 8) +
                ((data[offset + 2] as i64) << 16) +
                ((data[offset + 3] as i64) << 24))
    (value, offset + 4)

fn read_text_field(data: [u8], offset: i64) -> (text, i64)?:
    """Read a length-prefixed text field. Returns (text, new_offset)."""
    val len_result = read_u32(data, offset)
    if len_result == nil:
        return nil
    val text_len = len_result.0
    val pos = len_result.1
    if pos + text_len > data.len():
        deferred_set_error("Unexpected end of data reading text at offset {pos}")
        return nil
    val text_bytes = data[pos..(pos + text_len)]
    val text_value = String__from_utf8(text_bytes)
    if text_value == nil:
        return nil
    (text_value, pos + text_len)

fn read_optional_text_field(data: [u8], offset: i64) -> (text?, i64)?:
    """Read an optional text field (0x01 + data or 0x00 for nil)."""
    if offset >= data.len():
        deferred_set_error("Unexpected end of data reading optional at offset {offset}")
        return nil
    val tag = data[offset]
    if tag == 0x01:
        val result = read_text_field(data, offset + 1)
        if result == nil:
            return nil
        (result.0, result.1)
    else:
        (nil, offset + 1)

fn read_text_list(data: [u8], offset: i64) -> ([text], i64)?:
    """Read a list of length-prefixed text items. Returns (list, new_offset)."""
    val count_result = read_u32(data, offset)
    if count_result == nil:
        return nil
    val count = count_result.0
    var pos = count_result.1
    var items: [text] = []
    for _ in 0..count:
        val item_result = read_text_field(data, pos)
        if item_result == nil:
            return nil
        items.push(item_result.0)
        pos = item_result.1
    (items, pos)

fn read_text_dict(data: [u8], offset: i64) -> ({text: text}, i64)?:
    """Read a text-to-text dictionary. Returns (dict, new_offset)."""
    val count_result = read_u32(data, offset)
    if count_result == nil:
        return nil
    val count = count_result.0
    var pos = count_result.1
    var dict: {text: text} = {}
    for _ in 0..count:
        val key_result = read_text_field(data, pos)
        if key_result == nil:
            return nil
        pos = key_result.1
        val value_result = read_text_field(data, pos)
        if value_result == nil:
            return nil
        pos = value_result.1
        dict[key_result.0] = value_result.0
    (dict, pos)

fn read_generic_params(data: [u8], offset: i64) -> ([text], i64)?:
    """Read generic params: u8 count + length-prefixed strings."""
    if offset >= data.len():
        deferred_set_error("Unexpected end of data reading param count at offset {offset}")
        return nil
    val param_count = data[offset] as i64
    var pos = offset + 1
    var params: [text] = []
    for _ in 0..param_count:
        val param_result = read_text_field(data, pos)
        if param_result == nil:
            return nil
        params.push(param_result.0)
        pos = param_result.1
    (params, pos)

fn deserialize_function_def(data: [u8], offset: i64) -> (FunctionDef, i64)?:
    """Deserialize a FunctionDef from binary data."""
    # Name
    val name_result = read_text_field(data, offset)
    if name_result == nil:
        return nil
    val name = name_result.0
    var pos = name_result.1

    # Generic params
    val gp_result = read_generic_params(data, pos)
    if gp_result == nil:
        return nil
    val generic_params = gp_result.0
    pos = gp_result.1

    # Params
    val params_result = read_text_list(data, pos)
    if params_result == nil:
        return nil
    val params = params_result.0
    pos = params_result.1

    # Return type
    val ret_result = read_optional_text_field(data, pos)
    if ret_result == nil:
        return nil
    val return_type = ret_result.0
    pos = ret_result.1

    # Body
    val body_result = read_text_list(data, pos)
    if body_result == nil:
        return nil
    val body = body_result.0
    pos = body_result.1

    # Flags
    if pos >= data.len():
        deferred_set_error("Unexpected end of data reading function flags")
        return nil
    val is_generic = data[pos] == 0x01
    pos = pos + 1

    # Specialization of
    val spec_result = read_optional_text_field(data, pos)
    if spec_result == nil:
        return nil
    val specialization_of = spec_result.0
    pos = spec_result.1

    # Type bindings
    val bindings_result = read_text_dict(data, pos)
    if bindings_result == nil:
        return nil
    val type_bindings = bindings_result.0
    pos = bindings_result.1

    val func_def = FunctionDef(
        name: name,
        generic_params: generic_params,
        params: params,
        return_type: return_type,
        body: body,
        is_generic_template: is_generic,
        specialization_of: specialization_of,
        type_bindings: type_bindings
    )
    (func_def, pos)

fn deserialize_struct_def(data: [u8], offset: i64) -> ((StructDef, i64))\n            return nil:
    """Deserialize a StructDef from binary data."""
    # Name
    val name_result = read_text_field(data, offset)?
    val name = name_result.0
    var pos = name_result.1

    # Generic params
    val gp_result = read_generic_params(data, pos)?
    val generic_params = gp_result.0
    pos = gp_result.1

    # Fields
    val fields_result = read_text_list(data, pos)?
    val fields = fields_result.0
    pos = fields_result.1

    # Flags
    if pos >= data.len():
        deferred_set_error("Unexpected end of data reading struct flags"))
    val is_generic = data[pos] == 0x01
    pos = pos + 1

    # Specialization of
    val spec_result = read_optional_text_field(data, pos)?
    val specialization_of = spec_result.0
    pos = spec_result.1

    # Type bindings
    val bindings_result = read_text_dict(data, pos)?
    val type_bindings = bindings_result.0
    pos = bindings_result.1

    val struct_def = StructDef(
        name: name,
        generic_params: generic_params,
        fields: fields,
        is_generic_template: is_generic,
        specialization_of: specialization_of,
        type_bindings: type_bindings
    )
    ((struct_def, pos))

fn deserialize_class_def(data: [u8], offset: i64) -> ((ClassDef, i64))\n            return nil:
    """Deserialize a ClassDef from binary data."""
    # Name
    val name_result = read_text_field(data, offset)?
    val name = name_result.0
    var pos = name_result.1

    # Generic params
    val gp_result = read_generic_params(data, pos)?
    val generic_params = gp_result.0
    pos = gp_result.1

    # Fields
    val fields_result = read_text_list(data, pos)?
    val fields = fields_result.0
    pos = fields_result.1

    # Methods
    val methods_result = read_text_list(data, pos)?
    val methods = methods_result.0
    pos = methods_result.1

    # Flags
    if pos >= data.len():
        deferred_set_error("Unexpected end of data reading class flags"))
    val is_generic = data[pos] == 0x01
    pos = pos + 1

    # Specialization of
    val spec_result = read_optional_text_field(data, pos)?
    val specialization_of = spec_result.0
    pos = spec_result.1

    # Type bindings
    val bindings_result = read_text_dict(data, pos)?
    val type_bindings = bindings_result.0
    pos = bindings_result.1

    val class_def = ClassDef(
        name: name,
        generic_params: generic_params,
        fields: fields,
        methods: methods,
        is_generic_template: is_generic,
        specialization_of: specialization_of,
        type_bindings: type_bindings
    )
    ((class_def, pos))

fn deserialize_enum_def(data: [u8], offset: i64) -> ((EnumDef, i64))\n            return nil:
    """Deserialize an EnumDef from binary data."""
    # Name
    val name_result = read_text_field(data, offset)?
    val name = name_result.0
    var pos = name_result.1

    # Generic params
    val gp_result = read_generic_params(data, pos)?
    val generic_params = gp_result.0
    pos = gp_result.1

    # Variants
    val variants_result = read_text_list(data, pos)?
    val variants = variants_result.0
    pos = variants_result.1

    # Flags
    if pos >= data.len():
        deferred_set_error("Unexpected end of data reading enum flags"))
    val is_generic = data[pos] == 0x01
    pos = pos + 1

    # Specialization of
    val spec_result = read_optional_text_field(data, pos)?
    val specialization_of = spec_result.0
    pos = spec_result.1

    # Type bindings
    val bindings_result = read_text_dict(data, pos)?
    val type_bindings = bindings_result.0
    pos = bindings_result.1

    val enum_def = EnumDef(
        name: name,
        generic_params: generic_params,
        variants: variants,
        is_generic_template: is_generic,
        specialization_of: specialization_of,
        type_bindings: type_bindings
    )
    ((enum_def, pos))

fn deserialize_trait_def(data: [u8], offset: i64) -> ((TraitDef, i64))\n            return nil:
    """Deserialize a TraitDef from binary data."""
    # Name
    val name_result = read_text_field(data, offset)?
    val name = name_result.0
    var pos = name_result.1

    # Generic params
    val gp_result = read_generic_params(data, pos)?
    val generic_params = gp_result.0
    pos = gp_result.1

    # Methods
    val methods_result = read_text_list(data, pos)?
    val methods = methods_result.0
    pos = methods_result.1

    # Flags
    if pos >= data.len():
        deferred_set_error("Unexpected end of data reading trait flags"))
    val is_generic = data[pos] == 0x01
    pos = pos + 1

    val trait_def = TraitDef(
        name: name,
        generic_params: generic_params,
        methods: methods,
        is_generic_template: is_generic
    )
    ((trait_def, pos))
