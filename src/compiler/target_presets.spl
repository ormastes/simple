# Cross-Compilation Target Presets
#
# Provides pre-configured target descriptions for common embedded and
# desktop platforms. Eliminates the need to specify individual -target flags.
#
# Usage:
#   val target = preset_cortex_m4()
#   val target = preset_by_name("cortex-m4")
#
# All presets set:
#   - arch: CPU architecture (e.g., "thumbv7em")
#   - os: OS/environment (e.g., "none" for bare-metal)
#   - abi: ABI (e.g., "eabihf" for ARM hard-float)
#   - no_std: whether standard library is disabled
#   - no_gc: whether garbage collector is disabled
#   - stack_size: default stack size in bytes (0 = platform default)
#   - heap_size: default heap size in bytes (0 = platform default)
#   - pointer_width: pointer size in bits (32 or 64)
#   - float_support: whether hardware floating point is available
#   - description: human-readable preset description

# ============================================================================
# TargetPreset Struct
# ============================================================================

struct TargetPreset:
    name: text              # Canonical preset name (e.g., "cortex-m4")
    arch: text              # CPU architecture triple component
    os: text                # OS/environment triple component
    abi: text               # ABI triple component
    no_std: bool            # Disable standard library (bare-metal)
    no_gc: bool             # Disable garbage collector
    stack_size: i64         # Default stack size in bytes (0 = platform default)
    heap_size: i64          # Default heap size in bytes (0 = platform default)
    pointer_width: i64      # Pointer size in bits (32 or 64)
    float_support: bool     # Hardware float available
    description: text       # Human-readable description

# ============================================================================
# Preset Factory Functions
# ============================================================================

fn preset_cortex_m4() -> TargetPreset:
    # ARM Cortex-M4 bare-metal target (common: STM32, Kinetis, LPC).
    TargetPreset(
        name: "cortex-m4",
        arch: "thumbv7em",
        os: "none",
        abi: "eabihf",
        no_std: true,
        no_gc: true,
        stack_size: 8192,
        heap_size: 0,
        pointer_width: 32,
        float_support: true,
        description: "ARM Cortex-M4 bare-metal (FPU, 32-bit, no OS)"
    )

fn preset_cortex_m0() -> TargetPreset:
    # ARM Cortex-M0/M0+ bare-metal (smallest ARM, no FPU).
    TargetPreset(
        name: "cortex-m0",
        arch: "thumbv6m",
        os: "none",
        abi: "eabi",
        no_std: true,
        no_gc: true,
        stack_size: 2048,
        heap_size: 0,
        pointer_width: 32,
        float_support: false,
        description: "ARM Cortex-M0/M0+ bare-metal (no FPU, 32-bit, no OS)"
    )

fn preset_riscv32_baremetal() -> TargetPreset:
    # RISC-V 32-bit bare-metal (common: ESP32-C3, GD32VF103).
    TargetPreset(
        name: "riscv32-baremetal",
        arch: "riscv32imac",
        os: "none",
        abi: "ilp32",
        no_std: true,
        no_gc: true,
        stack_size: 16384,
        heap_size: 0,
        pointer_width: 32,
        float_support: false,
        description: "RISC-V 32-bit bare-metal (integer only, no OS)"
    )

fn preset_riscv64_linux() -> TargetPreset:
    # RISC-V 64-bit Linux (servers, RISC-V boards with OS).
    TargetPreset(
        name: "riscv64-linux",
        arch: "riscv64gc",
        os: "linux",
        abi: "lp64d",
        no_std: false,
        no_gc: false,
        stack_size: 0,
        heap_size: 0,
        pointer_width: 64,
        float_support: true,
        description: "RISC-V 64-bit Linux (full stdlib, 64-bit)"
    )

fn preset_wasm32() -> TargetPreset:
    # WebAssembly 32-bit (browser/Node.js/WASI).
    TargetPreset(
        name: "wasm32",
        arch: "wasm32",
        os: "wasi",
        abi: "wasm",
        no_std: false,
        no_gc: true,
        stack_size: 65536,
        heap_size: 65536,
        pointer_width: 32,
        float_support: true,
        description: "WebAssembly 32-bit (WASI, browser-compatible)"
    )

fn preset_linux_x86_64() -> TargetPreset:
    # Native Linux x86-64 (development machine, servers).
    TargetPreset(
        name: "linux-x86_64",
        arch: "x86_64",
        os: "linux",
        abi: "gnu",
        no_std: false,
        no_gc: false,
        stack_size: 0,
        heap_size: 0,
        pointer_width: 64,
        float_support: true,
        description: "Linux x86-64 (native, full stdlib)"
    )

fn preset_macos_arm64() -> TargetPreset:
    # macOS Apple Silicon (M1/M2/M3).
    TargetPreset(
        name: "macos-arm64",
        arch: "aarch64",
        os: "macos",
        abi: "macho",
        no_std: false,
        no_gc: false,
        stack_size: 0,
        heap_size: 0,
        pointer_width: 64,
        float_support: true,
        description: "macOS ARM64 (Apple Silicon, full stdlib)"
    )

fn preset_windows_x86_64() -> TargetPreset:
    # Windows x86-64.
    TargetPreset(
        name: "windows-x86_64",
        arch: "x86_64",
        os: "windows",
        abi: "msvc",
        no_std: false,
        no_gc: false,
        stack_size: 0,
        heap_size: 0,
        pointer_width: 64,
        float_support: true,
        description: "Windows x86-64 (MSVC ABI, full stdlib)"
    )

# ============================================================================
# Lookup
# ============================================================================

fn preset_by_name(name: text) -> TargetPreset:
    # Look up a preset by canonical name.
    # Returns a generic embedded default if name not found.
    if name == "cortex-m4":
        return preset_cortex_m4()
    elif name == "cortex-m0":
        return preset_cortex_m0()
    elif name == "riscv32-baremetal":
        return preset_riscv32_baremetal()
    elif name == "riscv64-linux":
        return preset_riscv64_linux()
    elif name == "wasm32":
        return preset_wasm32()
    elif name == "linux-x86_64":
        return preset_linux_x86_64()
    elif name == "macos-arm64":
        return preset_macos_arm64()
    elif name == "windows-x86_64":
        return preset_windows_x86_64()
    else:
        # Unknown preset: return a generic embedded default
        TargetPreset(
            name: name,
            arch: "unknown",
            os: "none",
            abi: "none",
            no_std: true,
            no_gc: true,
            stack_size: 4096,
            heap_size: 0,
            pointer_width: 32,
            float_support: false,
            description: "Unknown preset (defaults to bare-metal)"
        )

fn preset_all_names() -> [text]:
    # Return all known preset names.
    ["cortex-m4", "cortex-m0", "riscv32-baremetal", "riscv64-linux",
     "wasm32", "linux-x86_64", "macos-arm64", "windows-x86_64"]

fn preset_is_baremetal(preset: TargetPreset) -> bool:
    # True if the preset targets a bare-metal environment.
    preset.no_std and preset.no_gc

fn preset_triple(preset: TargetPreset) -> text:
    # Construct the target triple string.
    preset.arch + "-" + preset.os + "-" + preset.abi

# ============================================================================
# Exports
# ============================================================================

export TargetPreset
export preset_cortex_m4, preset_cortex_m0, preset_riscv32_baremetal
export preset_riscv64_linux, preset_wasm32, preset_linux_x86_64
export preset_macos_arm64, preset_windows_x86_64
export preset_by_name, preset_all_names
export preset_is_baremetal, preset_triple
