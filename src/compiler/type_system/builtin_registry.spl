# Builtin Type Registry
#
# FFI wrapper providing access to Rust's builtin type registry.
# The registry maps builtin function/type names to their type signatures.
# Heavy lifting stays in Rust; Simple calls through for lookups.
#
# Port of rust/type/src/checker_builtins.rs (registry portion)

from inference.types import {Type, TypeVarId}

# ============================================================================
# FFI (to Rust type registry when available)
# ============================================================================

extern fn rt_type_registry_lookup(name: text) -> text?
extern fn rt_type_registry_has(name: text) -> bool

# Wrapper functions (two-tier pattern)
fn type_registry_lookup(name: text) -> text?:
    rt_type_registry_lookup(name)

fn type_registry_has(name: text) -> bool:
    rt_type_registry_has(name)

# ============================================================================
# Builtin Category
# ============================================================================

enum BuiltinCategory:
    """Category of builtin function/type."""
    IO            # print, println, input, eprint, eprintln
    Math          # abs, sqrt, pow, min, max, sin, cos, etc.
    Collections   # len, range, collect, enumerate
    Concurrency   # spawn, send, recv, join, Channel, ThreadPool
    TypeConvert   # str, int, float, type
    Generator     # generator, next, yield
    Testing       # describe, context, it, test, expect
    Constructor   # Some, None, Ok, Err

# ============================================================================
# Builtin Entry
# ============================================================================

struct BuiltinEntry:
    """A registered builtin with its category and type signature."""
    name: text
    category: BuiltinCategory
    param_count: i64
    description: text

# ============================================================================
# Builtin Registry
# ============================================================================

class BuiltinRegistry:
    """Registry of all builtin functions and types.

    This is the Simple-side registry. For complex type resolution,
    delegates to Rust via FFI.
    """
    entries: Dict<text, BuiltinEntry>

impl BuiltinRegistry:
    static fn default() -> BuiltinRegistry:
        var reg = BuiltinRegistry(entries: {})
        reg.register_defaults()
        reg

    me register(name: text, category: BuiltinCategory, params: i64, desc: text):
        self.entries[name] = BuiltinEntry(
            name: name, category: category,
            param_count: params, description: desc
        )

    fn has(name: text) -> bool:
        self.entries.contains(name) or type_registry_has(name)

    fn get(name: text) -> BuiltinEntry?:
        val entry = self.entries.get(name)
        if entry.?:
            Some(entry.unwrap())
        else:
            nil

    fn by_category(category: BuiltinCategory) -> [BuiltinEntry]:
        [for (_, e) in self.entries if e.category == category: e]

    fn all_names() -> [text]:
        [for (name, _) in self.entries: name]

    me register_defaults():
        """Register all builtin functions."""
        # I/O
        self.register("print", BuiltinCategory.IO, 1, "Print to stdout")
        self.register("println", BuiltinCategory.IO, 1, "Print with newline")
        self.register("eprint", BuiltinCategory.IO, 1, "Print to stderr")
        self.register("eprintln", BuiltinCategory.IO, 1, "Print to stderr with newline")
        self.register("input", BuiltinCategory.IO, 0, "Read line from stdin")

        # Math
        self.register("abs", BuiltinCategory.Math, 1, "Absolute value")
        self.register("sqrt", BuiltinCategory.Math, 1, "Square root")
        self.register("pow", BuiltinCategory.Math, 2, "Power")
        self.register("min", BuiltinCategory.Math, 2, "Minimum")
        self.register("max", BuiltinCategory.Math, 2, "Maximum")

        # Collections
        self.register("len", BuiltinCategory.Collections, 1, "Collection length")
        self.register("range", BuiltinCategory.Collections, 2, "Integer range")
        self.register("collect", BuiltinCategory.Collections, 1, "Collect iterator to list")
        self.register("enumerate", BuiltinCategory.Collections, 1, "Index + value pairs")

        # Concurrency
        self.register("spawn", BuiltinCategory.Concurrency, 1, "Spawn task")
        self.register("spawn_isolated", BuiltinCategory.Concurrency, 1, "Spawn isolated actor")
        self.register("send", BuiltinCategory.Concurrency, 2, "Send message to actor")
        self.register("recv", BuiltinCategory.Concurrency, 1, "Receive message")
        self.register("reply", BuiltinCategory.Concurrency, 1, "Reply to sender")
        self.register("join", BuiltinCategory.Concurrency, 1, "Await task completion")

        # Type conversions
        self.register("str", BuiltinCategory.TypeConvert, 1, "Convert to string")
        self.register("int", BuiltinCategory.TypeConvert, 1, "Convert to int")
        self.register("float", BuiltinCategory.TypeConvert, 1, "Convert to float")
        self.register("type", BuiltinCategory.TypeConvert, 1, "Get type name")

        # Generators
        self.register("generator", BuiltinCategory.Generator, 1, "Create generator")
        self.register("next", BuiltinCategory.Generator, 1, "Get next from generator")

        # Constructors
        self.register("Some", BuiltinCategory.Constructor, 1, "Optional Some")
        self.register("None", BuiltinCategory.Constructor, 0, "Optional None")
        self.register("Ok", BuiltinCategory.Constructor, 1, "Result Ok")
        self.register("Err", BuiltinCategory.Constructor, 1, "Result Err")
        self.register("Channel", BuiltinCategory.Constructor, 0, "Create channel")
        self.register("ThreadPool", BuiltinCategory.Constructor, 1, "Create thread pool")

        # Testing (BDD/SSpec)
        self.register("describe", BuiltinCategory.Testing, 2, "Test group")
        self.register("context", BuiltinCategory.Testing, 2, "Test context")
        self.register("it", BuiltinCategory.Testing, 2, "Test case")
        self.register("test", BuiltinCategory.Testing, 2, "Test case")
        self.register("example", BuiltinCategory.Testing, 2, "Example")
        self.register("specify", BuiltinCategory.Testing, 2, "Specification")
        self.register("expect", BuiltinCategory.Testing, 1, "Assertion")
        self.register("before_each", BuiltinCategory.Testing, 1, "Setup hook")
        self.register("after_each", BuiltinCategory.Testing, 1, "Teardown hook")

export BuiltinCategory, BuiltinEntry, BuiltinRegistry
