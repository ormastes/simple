# Block Utilities - Error Message Helpers
#
# Error helper functions for custom blocks:
# - Create errors at specific offsets
# - Create errors for spans
# - Convert string messages to BlockErrors

use compiler.blocks.context.{BlockContext, BlockError}
use compiler.blocks.modes.{Span}

# ============================================================================
# Error Message Helpers
# ============================================================================

fn error_at(ctx: BlockContext, message: text, offset: i64, length: i64) -> BlockError:
    """Create error at specific offset in payload.

    Args:
        ctx: Block context
        message: Error message
        offset: Byte offset in payload
        length: Length of error span

    Returns:
        BlockError with precise span

    Example:
    ```simple
    fn parse_custom(payload: text, ctx: BlockContext) -> text:
        if payload[0] != '{':
            return Err(error_at(ctx, "Expected opening brace", 0))
        # ...
    ```
    """
    val span = Span(
        start: ctx.payload_span.start + offset,
        end: ctx.payload_span.start + offset + length,
        line: ctx.payload_span.line,
        col: ctx.payload_span.col + offset
    )

    blockerror_parse_at(message, span)

val _tv_0 = [i64, i64]
fn error_span(ctx: BlockContext, message: text, span: _tv_0) -> BlockError:
    """Create error for a span (start, end).

    Args:
        ctx: Block context
        message: Error message
        val _tv_1 = [start_offset, end_offset]
        span: _tv_1 tuple

    Returns:
        BlockError with span
    """
    val _destruct_0 = span
    val start = _destruct_0[0]
    val end = _destruct_0[1]
    val error_span = Span(
        start: ctx.payload_span.start + start,
        end: ctx.payload_span.start + end,
        line: ctx.payload_span.line,
        col: ctx.payload_span.col + start
    )

    blockerror_parse_at(message, error_span)

fn errors_from_strings(ctx: BlockContext, messages: [text]) -> [BlockError]:
    """Convert string error messages to BlockErrors.

    Args:
        ctx: Block context
        messages: List of error messages

    Returns:
        List of BlockErrors

    Example:
    ```simple
    fn validate_custom(value: BlockValue, ctx: BlockContext) -> [BlockError]:
        val messages = check_custom_rules(value)
        errors_from_strings(ctx, messages)
    ```
    """
    messages_map(messages, \msg: BlockError.validation(msg))

# ============================================================================
# Exports
# ============================================================================

export error_at, error_span, errors_from_strings
