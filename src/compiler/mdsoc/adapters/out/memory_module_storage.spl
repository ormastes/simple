# In-Memory Module Storage Adapter (Tests)
#
# Implements ModuleStoragePort using an in-memory source map.
# Used in unit tests to avoid disk access.
#
# Design: doc/report/compiler_mdsoc_impl_plan.md Phase 5b

use compiler.mdsoc.feature.module_loading.app.ports.{ModuleStoragePort}

# Module-level source registry (workaround for nested closure limitation)
var _mem_sources: [text] = []
var _mem_paths: [text] = []

fn _mem_reset():
    """Reset the in-memory source registry."""
    _mem_sources = []
    _mem_paths = []

fn _mem_register(path: text, source: text):
    """Register a source text for a path."""
    _mem_paths = _mem_paths.push(path)
    _mem_sources = _mem_sources.push(source)

fn _mem_read(path: text) -> text:
    """Read registered source for path. Returns empty string if not found."""
    var i = 0
    while i < _mem_paths.len():
        if _mem_paths[i] == path:
            return _mem_sources[i]
        i = i + 1
    ""

fn create_memory_module_storage() -> ModuleStoragePort:
    """Create an in-memory module storage adapter for testing.

    Call _mem_register(path, source) to populate the registry before use.
    Call _mem_reset() to clear between tests.
    """
    ModuleStoragePort(
        name: "memory-module-storage",
        read_source_fn: _mem_read
    )

export create_memory_module_storage, _mem_register, _mem_reset
