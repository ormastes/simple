# Build Mode
#
# Build mode configuration for the Simple compiler.
# Controls optimizations, validation rules, and deterministic builds.
#
# Port of rust/compiler/src/build_mode.rs (232 lines)

export BuildMode, DeterministicConfig

# ============================================================================
# Build Mode
# ============================================================================

enum BuildMode:
    Debug       # Full diagnostics, minimal optimizations, all runtime checks
    Release     # Optimizations enabled, production-ready output

impl BuildMode:
    static fn from_text(s: text) -> Result<BuildMode, text>:
        match s.lower():
            case "debug": Ok(BuildMode.Debug)
            case "release": Ok(BuildMode.Release)
            case _: Err("unknown build mode '{s}', expected 'debug' or 'release'")

    fn is_debug() -> bool:
        match self:
            case Debug: true
            case _: false

    fn is_release() -> bool:
        match self:
            case Release: true
            case _: false

    fn as_text() -> text:
        match self:
            case Debug: "debug"
            case Release: "release"

# ============================================================================
# Deterministic Configuration
# ============================================================================

struct DeterministicConfig:
    """Configuration for reproducible builds."""
    enabled: bool
    timestamp: text?       # Override build timestamp (ISO 8601)
    seed: i64              # Random seed for deterministic ordering
    normalize_paths: bool  # Normalize to relative paths

impl DeterministicConfig:
    static fn create() -> DeterministicConfig:
        """All deterministic features enabled."""
        DeterministicConfig(enabled: true, timestamp: nil,
                            seed: 0, normalize_paths: true)

    static fn disabled() -> DeterministicConfig:
        DeterministicConfig(enabled: false, timestamp: nil,
                            seed: 0, normalize_paths: false)

    fn get_timestamp() -> text:
        """Get build timestamp, or current time if not specified."""
        if self.timestamp.?:
            self.timestamp.unwrap()
        else:
            extern fn rt_time_now_iso() -> text
            # TODO: Replace direct FFI call with wrapper (time_now_iso) from app.io or compiler.ffi
            rt_time_now_iso()

    fn with_timestamp(ts: text) -> DeterministicConfig:
        DeterministicConfig(enabled: self.enabled, timestamp: Some(ts),
                            seed: self.seed, normalize_paths: self.normalize_paths)

    fn with_seed(s: i64) -> DeterministicConfig:
        DeterministicConfig(enabled: self.enabled, timestamp: self.timestamp,
                            seed: s, normalize_paths: self.normalize_paths)

    fn with_normalize_paths(normalize: bool) -> DeterministicConfig:
        DeterministicConfig(enabled: self.enabled, timestamp: self.timestamp,
                            seed: self.seed, normalize_paths: normalize)
