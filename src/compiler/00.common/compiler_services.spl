# Compiler Services - Typed Pipeline Port Container
#
# Defines port structs for each compiler pipeline stage boundary,
# making the full dependency graph of the compiler visible from one struct.
#
# Instead of implicit imports between stages, each stage boundary has a
# typed port struct describing the exact contract between stages.
#
# Pattern: same as BackendPort in backend_port.spl (Feature 1)
# Design: doc/report/compiler_mdsoc_impl_plan.md Phase 2
# Feature: doc/feature/pending_feature.md Feature 2

use compiler.backend_port.{BackendPort}

# ============================================================================
# LexerPort - Contract for the lexing stage
# ============================================================================

struct LexerPort:
    """Typed contract: what the compiler needs from a lexer.

    The lexer takes source text and produces a stream of tokens.
    Represented as parallel arrays (tag, text, line, col) for
    compatibility with the core lexer's arena-based representation.
    """
    name: text
    tokenize_fn: fn(text) -> [text]

# ============================================================================
# ParserPort - Contract for the parsing stage
# ============================================================================

struct ParserPort:
    """Typed contract: what the compiler needs from a parser.

    The parser takes a token stream and source text and produces
    a parsed module (AST). Returns error messages on failure.
    """
    name: text
    parse_fn: fn([text], text) -> [text]

# ============================================================================
# DesugarPort - Contract for the desugaring stage
# ============================================================================

struct DesugarPort:
    """Typed contract: what the compiler needs from a desugarer.

    The desugarer transforms source text (rewrites syntax sugar).
    Returns transformed source text.
    """
    name: text
    desugar_fn: fn(text) -> text

# ============================================================================
# TypeCheckPort - Contract for the type checking stage
# ============================================================================

struct TypeCheckPort:
    """Typed contract: what the compiler needs from a type checker.

    The type checker validates a parsed module and returns
    a list of error messages (empty list = no errors).
    """
    name: text
    check_fn: fn(text) -> [text]

# ============================================================================
# HirLowerPort - Contract for the HIR lowering stage
# ============================================================================

struct HirLowerPort:
    """Typed contract: what the compiler needs from a HIR lowerer.

    Lowers a parsed module (by name) to HIR representation.
    Returns error messages on failure.
    """
    name: text
    lower_fn: fn(text) -> [text]

# ============================================================================
# MirLowerPort - Contract for the MIR lowering stage
# ============================================================================

struct MirLowerPort:
    """Typed contract: what the compiler needs from a MIR lowerer.

    Lowers a HIR module (by name) to MIR representation.
    Returns error messages on failure.
    """
    name: text
    lower_fn: fn(text) -> [text]

# ============================================================================
# LoggerPort - Contract for the logging service
# ============================================================================

struct LoggerPort:
    """Typed contract: what the compiler needs from a logger.

    Structured logging at different severity levels.
    """
    name: text
    debug_fn: fn(text)
    info_fn: fn(text)
    warn_fn: fn(text)
    error_fn: fn(text)

# ============================================================================
# ModuleLoaderPort - Contract for the module loading service
# ============================================================================

struct ModuleLoaderPort:
    """Typed contract: what the compiler needs from a module loader.

    The module loader resolves import paths and loads source text.
    load_fn returns nil when the module cannot be found.
    resolve_fn maps (current_path, import_name) to absolute path.
    """
    name: text
    load_fn: fn(text) -> text
    resolve_fn: fn(text, text) -> text

# ============================================================================
# CompilerServices - Full pipeline dependency container
# ============================================================================

struct CompilerServices:
    """Typed container for all compiler pipeline dependencies.

    Open this struct to see every service the compiler uses, all typed.
    Each field corresponds to one pipeline stage boundary.

    Replace ad-hoc imports between stages with typed ports wired here.
    This makes the full dependency graph of the compiler visible from
    one struct definition.

    Wired by create_default_services() based on CompileOptions.
    """
    lexer: LexerPort
    parser: ParserPort
    desugarer: DesugarPort
    type_checker: TypeCheckPort
    hir_lowerer: HirLowerPort
    mir_lowerer: MirLowerPort
    backend: BackendPort
    logger: LoggerPort
    module_loader: ModuleLoaderPort

# ============================================================================
# Default no-op implementations (used as stubs / placeholders)
# ============================================================================

fn _noop_tokenize(src) -> [text]: []
fn _noop_parse(tokens, src) -> [text]: []
fn _noop_desugar(src) -> text: src
fn _noop_check(module_name) -> [text]: []
fn _noop_hir_lower(module_name) -> [text]: []
fn _noop_mir_lower(module_name) -> [text]: []
fn _noop_log(msg): ()
fn _noop_load(path) -> text: ""
fn _noop_resolve(current, name) -> text: name
fn _noop_backend_run(m): Ok(nil)
fn _noop_supports_jit() -> bool: false
fn _noop_target_triple() -> text: "noop"

fn _make_noop_lexer() -> LexerPort:
    LexerPort(
        name: "noop-lexer",
        tokenize_fn: _noop_tokenize
    )

fn _make_noop_parser() -> ParserPort:
    ParserPort(
        name: "noop-parser",
        parse_fn: _noop_parse
    )

fn _make_noop_desugarer() -> DesugarPort:
    DesugarPort(
        name: "noop-desugarer",
        desugar_fn: _noop_desugar
    )

fn _make_noop_type_checker() -> TypeCheckPort:
    TypeCheckPort(
        name: "noop-type-checker",
        check_fn: _noop_check
    )

fn _make_noop_hir_lowerer() -> HirLowerPort:
    HirLowerPort(
        name: "noop-hir-lowerer",
        lower_fn: _noop_hir_lower
    )

fn _make_noop_mir_lowerer() -> MirLowerPort:
    MirLowerPort(
        name: "noop-mir-lowerer",
        lower_fn: _noop_mir_lower
    )

fn _make_noop_logger() -> LoggerPort:
    LoggerPort(
        name: "noop-logger",
        debug_fn: _noop_log,
        info_fn: _noop_log,
        warn_fn: _noop_log,
        error_fn: _noop_log
    )

fn _make_noop_module_loader() -> ModuleLoaderPort:
    ModuleLoaderPort(
        name: "noop-module-loader",
        load_fn: _noop_load,
        resolve_fn: _noop_resolve
    )

fn _make_noop_backend() -> BackendPort:
    BackendPort(
        name: "noop-backend",
        run_fn: _noop_backend_run,
        supports_jit_fn: _noop_supports_jit,
        target_triple_fn: _noop_target_triple
    )

# ============================================================================
# Factory: create_default_services
# ============================================================================

fn create_default_services() -> CompilerServices:
    """Create CompilerServices wired to default no-op implementations.

    Creates a CompilerServices container with all ports wired to
    no-op stubs. Useful for testing port struct construction and
    as a starting point for customization.

    Feature 2 defines the port shapes. Wiring to real pipeline
    stages is done incrementally as part of Phase 2 of MDSoC migration.
    """
    val backend_port = _make_noop_backend()

    CompilerServices(
        lexer: _make_noop_lexer(),
        parser: _make_noop_parser(),
        desugarer: _make_noop_desugarer(),
        type_checker: _make_noop_type_checker(),
        hir_lowerer: _make_noop_hir_lowerer(),
        mir_lowerer: _make_noop_mir_lowerer(),
        backend: backend_port,
        logger: _make_noop_logger(),
        module_loader: _make_noop_module_loader()
    )

# ============================================================================
# Exports
# ============================================================================

export LexerPort
export ParserPort
export DesugarPort
export TypeCheckPort
export HirLowerPort
export MirLowerPort
export LoggerPort
export ModuleLoaderPort
export CompilerServices
export create_default_services
