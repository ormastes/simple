# MCP Protocol - Stdin/Stdout Message Handling
#
# Provides protocol-level message reading and writing for MCP servers.
# Supports both Content-Length (LSP-style) and JSON Lines framing.
#
# Usage:
#   use mcp_lib.protocol.{create_protocol_state, protocol_read_message, protocol_write_message}
#
#   var protocol = create_protocol_state()
#   val msg = protocol_read_message(protocol)
#   protocol_write_message(protocol, response)

use std.text.{NL}
use app.io.mod.{input, print_raw}

# Protocol state - tracks which framing mode is in use
class ProtocolState:
    use_json_lines: bool

# Factory: Create protocol state (auto-detects mode on first read)
fn create_protocol_state() -> ProtocolState:
    ProtocolState(use_json_lines: false)

# Read message from stdin using auto-detected protocol
# Returns empty string on EOF
fn protocol_read_message(state: ProtocolState) -> text:
    var line = input()
    if line == "":
        return ""

    # Strip trailing \r if present (Windows line endings)
    if line.ends_with("\r"):
        line = line.substring(0, line.len() - 1)

    # JSON Lines mode: line starts with {
    if line.starts_with("{"):
        state.use_json_lines = true
        return line

    # Content-Length mode (LSP-style framing)
    if line.starts_with("Content-Length:"):
        var len_str = line.replace("Content-Length:", "")
        len_str = len_str.trim()
        val content_length = int(len_str)
        if content_length == 0:
            return ""

        # Read blank line separator
        input()

        # Read message body
        var body = input()
        return body

    # Unknown protocol
    ""

# Write message to stdout using detected protocol
fn protocol_write_message(state: ProtocolState, body: text):
    if state.use_json_lines:
        # JSON Lines: one message per line
        print_raw(body + NL)
    else:
        # Content-Length: LSP-style framing
        var header = "Content-Length: " + str(body.len()) + "\r" + NL + "\r" + NL
        print_raw(header)
        print_raw(body)

# Exports
export create_protocol_state, protocol_read_message, protocol_write_message, ProtocolState
