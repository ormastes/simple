# SDN Error Types
#
# Error types with span information for diagnostics.
# Port of rust/sdn/src/error.rs

from value import {Span}

# ============================================================================
# SDN Errors
# ============================================================================

enum SdnError:
    """SDN parse and document errors."""
    SyntaxError(message: text, line: i64, column: i64, span: Span?)
    UnexpectedToken(expected: text, found: text, span: Span)
    UnexpectedEof(span: Span?)
    InvalidNumber(text)
    UnclosedString(span: Span?)
    InvalidIndentation(line: i64)
    InvalidEscape(text)
    PathNotFound(path: text)
    TypeMismatch(expected: text, found: text)
    InvalidTableRow(expected: i64, found: i64)
    IoError(text)
    SecurityError(message: text, span: Span?)
    ParseError(message: text, span: Span?)

impl SdnError:
    static fn syntax_error(message: text, line: i64, column: i64) -> SdnError:
        SdnError.SyntaxError(
            message: message,
            line: line,
            column: column,
            span: nil
        )

    static fn syntax_error_with_span(message: text, span: Span) -> SdnError:
        SdnError.SyntaxError(
            message: message,
            line: span.line,
            column: span.column,
            span: Some(span)
        )

    static fn unexpected_token(expected: text, found: text, span: Span) -> SdnError:
        SdnError.UnexpectedToken(expected: expected, found: found, span: span)

    static fn security_error(message: text, span: Span) -> SdnError:
        SdnError.SecurityError(message: message, span: Some(span))

    fn is_security_error() -> bool:
        match self:
            case SecurityError(_, _): true
            case _: false

    fn span() -> Span?:
        match self:
            case SyntaxError(_, _, _, span): span
            case UnexpectedToken(_, _, span): Some(span)
            case UnclosedString(span): span
            case UnexpectedEof(span): span
            case SecurityError(_, span): span
            case ParseError(_, span): span
            case _: nil

    fn message() -> text:
        match self:
            case SyntaxError(msg, line, col, _):
                "Syntax error at {line}:{col}: {msg}"
            case UnexpectedToken(expected, found, _):
                "Unexpected token: expected {expected}, found {found}"
            case UnexpectedEof(_):
                "Unexpected end of file"
            case InvalidNumber(s):
                "Invalid number literal: {s}"
            case UnclosedString(_):
                "Unclosed string literal"
            case InvalidIndentation(line):
                "Invalid indentation at line {line}"
            case InvalidEscape(s):
                "Invalid escape sequence: {s}"
            case PathNotFound(path):
                "Path not found: {path}"
            case TypeMismatch(expected, found):
                "Type mismatch: expected {expected}, found {found}"
            case InvalidTableRow(expected, found):
                "Invalid table row: expected {expected} columns, found {found}"
            case IoError(msg):
                "I/O error: {msg}"
            case SecurityError(msg, _):
                "Security error: {msg}"
            case ParseError(msg, _):
                "Parse error: {msg}"

    fn to_text() -> text:
        self.message()

export SdnError
