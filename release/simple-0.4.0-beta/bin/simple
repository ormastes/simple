#!/bin/sh
# Simple Language CLI
#
# Default CLI entry point â€” runs the Simple-language implementation.
# The core runtime is implemented in Rust (simple_runtime or simple).
# The CLI and tools are implemented in Simple (src/app/).

SCRIPT_DIR="$(cd "$(dirname "$0")/.." && pwd)"

# Source cargo environment if available (needed for build commands)
if [ -f "$HOME/.cargo/env" ]; then
    . "$HOME/.cargo/env"
fi

# Find the runtime binary
# Priority: custom path > bin/simple_runtime > bin/simple > bootstrap > target dirs
if [ -n "$SIMPLE_RUNTIME_PATH" ] && [ -x "$SIMPLE_RUNTIME_PATH" ]; then
    RUNTIME="$SIMPLE_RUNTIME_PATH"
elif [ -x "$SCRIPT_DIR/bin/simple_runtime" ]; then
    RUNTIME="$SCRIPT_DIR/bin/simple_runtime"
elif [ -x "$SCRIPT_DIR/bin/simple" ] && [ ! -L "$SCRIPT_DIR/bin/simple" ]; then
    # Use bin/simple if it's an actual binary (not this script)
    RUNTIME="$SCRIPT_DIR/bin/simple"
elif [ -x "$SCRIPT_DIR/bin/bootstrap/simple_runtime" ]; then
    RUNTIME="$SCRIPT_DIR/bin/bootstrap/simple_runtime"
elif [ -x "$SCRIPT_DIR/bin/bootstrap/simple" ]; then
    RUNTIME="$SCRIPT_DIR/bin/bootstrap/simple"
elif [ -x "$SCRIPT_DIR/rust/target/release/simple_runtime" ]; then
    RUNTIME="$SCRIPT_DIR/rust/target/release/simple_runtime"
elif [ -x "$SCRIPT_DIR/rust/target/debug/simple_runtime" ]; then
    RUNTIME="$SCRIPT_DIR/rust/target/debug/simple_runtime"
elif [ -x "$SCRIPT_DIR/rust/target/bootstrap/simple_runtime" ]; then
    RUNTIME="$SCRIPT_DIR/rust/target/bootstrap/simple_runtime"
else
    echo "error: simple runtime not found." >&2
    echo "  Looked in:" >&2
    echo "    - bin/simple_runtime or bin/simple (release/development)" >&2
    echo "    - bin/bootstrap/simple_runtime or bin/bootstrap/simple (minimal bootstrap)" >&2
    echo "    - rust/target/{release,debug,bootstrap}/simple_runtime" >&2
    echo "  Run 'simple build --release' or 'simple build --bootstrap'." >&2
    exit 1
fi

# Run the Simple CLI implementation
exec "$RUNTIME" "$SCRIPT_DIR/src/app/cli/main.spl" "$@"
