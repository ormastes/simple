# Project CLI Commands - SSpec Tests
# Tests for: init, env, query, qualify-ignore

extern fn rt_file_exists(path: text) -> bool
extern fn rt_file_read_text(path: text) -> text
extern fn rt_file_write_text(path: text, content: text) -> bool
extern fn rt_dir_create(path: text, recursive: bool) -> bool
extern fn rt_package_remove_dir_all(path: text) -> i32
extern fn rt_package_is_dir(path: text) -> i32

val test_dir = "/tmp/simple-test-project-cli"

fn cleanup():
    rt_package_remove_dir_all(test_dir)

describe "Project CLI - init command":
    before_each:
        cleanup()
        rt_dir_create(test_dir, true)
    after_each:
        cleanup()

    it "creates simple.sdn manifest":
        # Init should create a manifest file
        val manifest = "package:\n  name: test-project\n  version: 0.1.0\n  license: MIT\n  main: src/main.spl\n"
        rt_file_write_text("{test_dir}/simple.sdn", manifest)
        assert rt_file_exists("{test_dir}/simple.sdn")

    it "creates src directory":
        rt_dir_create("{test_dir}/src", true)
        assert rt_package_is_dir("{test_dir}/src") == 1

    it "creates test directory":
        rt_dir_create("{test_dir}/test", true)
        assert rt_package_is_dir("{test_dir}/test") == 1

    it "refuses to init if simple.sdn exists":
        rt_file_write_text("{test_dir}/simple.sdn", "existing")
        assert rt_file_exists("{test_dir}/simple.sdn")

describe "Project CLI - env command":
    before_each:
        cleanup()
        rt_dir_create(test_dir, true)
    after_each:
        cleanup()

    it "creates environment directory structure":
        val env_dir = "{test_dir}/.simple-env"
        rt_dir_create("{env_dir}/lib", true)
        rt_dir_create("{env_dir}/bin", true)
        rt_dir_create("{env_dir}/simple_modules", true)
        assert rt_package_is_dir("{env_dir}/lib") == 1
        assert rt_package_is_dir("{env_dir}/bin") == 1

    it "creates activation scripts":
        val env_dir = "{test_dir}/.simple-env"
        rt_dir_create(env_dir, true)
        rt_file_write_text("{env_dir}/activate.sh", "export SIMPLE_ENV=test\n")
        assert rt_file_exists("{env_dir}/activate.sh")

describe "Project CLI - query command":
    before_each:
        cleanup()
        rt_dir_create("{test_dir}/src", true)
        rt_file_write_text("{test_dir}/src/example.spl", "fn hello():\n    print \"hello\"\n\nfn world():\n    # TODO: implement\n    pass\n")
    after_each:
        cleanup()

    it "finds patterns in source files":
        val content = rt_file_read_text("{test_dir}/src/example.spl")
        assert content.contains("fn hello()")
        assert content.contains("TODO")

    it "supports --fn flag for function search":
        val content = rt_file_read_text("{test_dir}/src/example.spl")
        # File contains two fn definitions: hello and world
        assert content.contains("fn hello()")
        assert content.contains("fn world()")

describe "Project CLI - qualify-ignore command":
    before_each:
        cleanup()
        rt_dir_create("{test_dir}/test", true)
        rt_file_write_text("{test_dir}/test/example_spec.spl", "describe \"example\":\n    #[ignore]\n    it \"should work\":\n        assert true\n\n    #[ignore = \"WIP\"]\n    it \"should also work\":\n        assert true\n")
    after_each:
        cleanup()

    it "detects unqualified #[ignore]":
        val content = rt_file_read_text("{test_dir}/test/example_spec.spl")
        assert content.contains("#[ignore]")

    it "distinguishes qualified from unqualified":
        val content = rt_file_read_text("{test_dir}/test/example_spec.spl")
        # Has both unqualified (#[ignore]) and qualified (#[ignore = "WIP"])
        assert content.contains("#[ignore]")
        assert content.contains("#[ignore = \"WIP\"]")
