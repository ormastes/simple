# @pending
"""
# Experiment Sweep Specification

**Feature IDs:** #exp-sweep
**Category:** Stdlib
**Status:** In Progress

## Overview

Tests for hyperparameter optimization: Study, Trial,
Sampler, and Pruner components.
"""

use std.spec
use std.exp.sweep

# ============================================================================
# Trial
# ============================================================================

describe "Trial":
    context "parameter suggestion":
        it "suggests float in range":
            var trial = Trial(
                trial_id: 0, params: {}, status: TrialStatus.Running,
                value: nil, intermediate_values: {}, run: nil
            )
            val v = trial.suggest_float("lr", 0.001, 0.1)
            expect v >= 0.001
            expect v <= 0.1

        it "suggests int in range":
            var trial = Trial(
                trial_id: 0, params: {}, status: TrialStatus.Running,
                value: nil, intermediate_values: {}, run: nil
            )
            val v = trial.suggest_int("layers", 1, 10)
            expect v >= 1
            expect v <= 10

        it "suggests from choices":
            var trial = Trial(
                trial_id: 0, params: {}, status: TrialStatus.Running,
                value: nil, intermediate_values: {}, run: nil
            )
            val v = trial.suggest_choice("batch_size", [16.0, 32.0, 64.0])
            expect v == 16.0 or v == 32.0 or v == 64.0

        it "records suggested params":
            var trial = Trial(
                trial_id: 0, params: {}, status: TrialStatus.Running,
                value: nil, intermediate_values: {}, run: nil
            )
            trial.suggest_float("lr", 0.001, 0.1)
            expect trial.params.contains_key("lr")

    context "intermediate reporting":
        it "reports intermediate values":
            var trial = Trial(
                trial_id: 0, params: {}, status: TrialStatus.Running,
                value: nil, intermediate_values: {}, run: nil
            )
            trial.report(0, 0.9)
            trial.report(1, 0.85)
            expect trial.intermediate_values.len() == 2

# ============================================================================
# Sampler
# ============================================================================

describe "Sampler":
    it "creates random sampler":
        val s = Sampler.random(42)
        expect s.kind == SamplerKind.Random

    it "creates grid sampler":
        val s = Sampler.grid()
        expect s.kind == SamplerKind.Grid

    it "creates TPE sampler":
        val s = Sampler.tpe(123)
        expect s.kind == SamplerKind.TPE

# ============================================================================
# Pruner
# ============================================================================

describe "Pruner":
    it "creates no-prune pruner":
        val p = Pruner.none()
        expect p.kind == PrunerKind.NoPrune

    it "creates median pruner":
        val p = Pruner.median(5)
        expect p.n_warmup_steps == 5

    it "creates successive halving pruner":
        val p = Pruner.successive_halving(3.0, 5)
        expect p.reduction_factor == 3.0

    it "no-prune never prunes":
        val p = Pruner.none()
        var trial = Trial(
            trial_id: 0, params: {}, status: TrialStatus.Running,
            value: nil, intermediate_values: {}, run: nil
        )
        expect not p.should_prune(trial, [])

# ============================================================================
# Study
# ============================================================================

describe "Study":
    context "creation":
        it "creates study with name and direction":
            val study = Study.create("test_study", "minimize")
            expect study.config.name == "test_study"
            expect study.config.direction == "minimize"
            expect study.trials.is_empty()

    context "optimization":
        it "runs trials":
            var study = Study.create("opt_test", "minimize")
            study.optimize(\trial:
                val x = trial.suggest_float("x", -10.0, 10.0)
                x * x
            , 5)
            expect study.trials.len() == 5

        it "tracks best trial":
            var study = Study.create("best_test", "minimize")
            study.optimize(\trial:
                val x = trial.suggest_float("x", -10.0, 10.0)
                x * x
            , 10)
            expect study.best_trial.?
            expect study.best_value().?

        it "filters completed trials":
            var study = Study.create("filter_test", "minimize")
            study.optimize(\trial:
                trial.suggest_float("x", 0.0, 1.0)
            , 5)
            expect study.completed_trials().len() == 5

    context "best params":
        it "returns best params":
            var study = Study.create("params_test", "minimize")
            study.optimize(\trial:
                val x = trial.suggest_float("x", -5.0, 5.0)
                x * x
            , 10)
            val params = study.best_params()
            expect params.contains_key("x")
