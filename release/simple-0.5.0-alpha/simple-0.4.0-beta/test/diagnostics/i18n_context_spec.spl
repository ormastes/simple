# @pending
# SSpec Tests for I18n Context Builders
#
# Tests the i18n context creation and diagnostic i18n functions.

use sspec.{describe, it, expect}
use diagnostics.{
    ctx1, ctx2, ctx3, ContextBuilder,
    error_i18n, warning_i18n, note_i18n, help_i18n, info_i18n,
    severity_name, Severity
}

describe "I18n Context Builders":
    it "creates context with ctx1":
        val ctx = ctx1("name", "foo")
        # Context is opaque, but we can use it to create diagnostics
        val diag = error_i18n("compiler", "E1001", ctx)

        expect diag.code == Some("E1001")
        expect diag.severity == Severity.Error
        expect not diag.message.is_empty()

    it "creates context with ctx2":
        val ctx = ctx2("expected", "Int", "found", "Bool")
        val diag = error_i18n("compiler", "E1003", ctx)

        expect diag.code == Some("E1003")
        expect diag.severity == Severity.Error
        expect not diag.message.is_empty()

    it "creates context with ctx3":
        val ctx = ctx3("expected", "Int", "found", "Bool", "line", "42")
        val diag = error_i18n("compiler", "E1003", ctx)

        expect diag.code == Some("E1003")
        expect diag.severity == Severity.Error

    it "builds context fluently with ContextBuilder":
        val ctx = ContextBuilder.new()
            .with("expected", "identifier")
            .with("found", "number")
            .with("line", "5")
            .build()

        val diag = error_i18n("parser", "E0002", ctx)

        expect diag.code == Some("E0002")
        expect diag.severity == Severity.Error

describe "I18n Diagnostic Factories":
    it "creates error diagnostic from i18n":
        val ctx = ctx2("name", "variable", "", "")
        val diag = error_i18n("compiler", "E1001", ctx)

        expect diag.severity == Severity.Error
        expect diag.code == Some("E1001")
        expect not diag.message.is_empty()

    it "creates warning diagnostic from i18n":
        val ctx = ctx1("name", "unused_var")
        val diag = warning_i18n("compiler", "W0001", ctx)

        expect diag.severity == Severity.Warning
        expect diag.code == Some("W0001")

    it "creates note diagnostic from i18n":
        val ctx = ctx1("info", "consider this")
        val diag = note_i18n("compiler", "N0001", ctx)

        expect diag.severity == Severity.Note
        expect diag.code == Some("N0001")

    it "creates help diagnostic from i18n":
        val ctx = ctx1("hint", "try this")
        val diag = help_i18n("compiler", "H0001", ctx)

        expect diag.severity == Severity.Help
        expect diag.code == Some("H0001")

    it "creates info diagnostic from i18n":
        val ctx = ctx1("message", "FYI")
        val diag = info_i18n("compiler", "I0001", ctx)

        expect diag.severity == Severity.Info
        expect diag.code == Some("I0001")

describe "I18n Severity Names":
    it "gets localized severity name for error":
        val name = severity_name("error")
        # Should return "error" (English) or localized version
        expect not name.is_empty()

    it "gets localized severity name for warning":
        val name = severity_name("warning")
        expect not name.is_empty()

    it "gets localized severity name for note":
        val name = severity_name("note")
        expect not name.is_empty()

    it "gets localized severity name for help":
        val name = severity_name("help")
        expect not name.is_empty()

    it "gets localized severity name for info":
        val name = severity_name("info")
        expect not name.is_empty()

describe "I18n Diagnostic Chaining":
    it "chains i18n diagnostic with span and labels":
        val ctx = ctx2("expected", "identifier", "found", "number")
        val span = Span.new(10, 15, 2, 5)

        val diag = error_i18n("parser", "E0002", ctx)
            .with_span(span)
            .with_label(span, "unexpected token")
            .with_help("Check your syntax")

        expect diag.code == Some("E0002")
        expect diag.span.?
        expect diag.labels.len() == 1
        expect diag.help.?

    it "chains i18n diagnostic with notes":
        val ctx = ctx2("name", "foo", "", "")
        val diag = error_i18n("compiler", "E1001", ctx)
            .with_note("Variable was not declared")
            .with_note("Scope: main function")

        expect diag.notes.len() == 2
        expect diag.notes[0] == "Variable was not declared"
        expect diag.notes[1] == "Scope: main function"

describe "I18n Fallback Behavior":
    it "falls back to English for unknown locale":
        # Even if locale is set to unsupported language,
        # should fall back to English or bootstrap messages
        val ctx = ctx1("test", "value")
        val diag = error_i18n("parser", "E0001", ctx)

        # Should succeed even if message not found
        expect diag.code == Some("E0001")
        expect not diag.message.is_empty()

    it "handles unknown error codes gracefully":
        val ctx = ctx1("test", "value")
        val diag = error_i18n("compiler", "E9999", ctx)

        # Should generate fallback message
        expect diag.code == Some("E9999")
        expect not diag.message.is_empty()
