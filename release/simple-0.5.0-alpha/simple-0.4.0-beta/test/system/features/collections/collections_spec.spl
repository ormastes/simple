# @pending
"""
# Collections Specification

**Feature ID:** #COLLECTIONS-001
**Category:** Language | Collections
**Status:** Implemented

## Overview

Tests for collection types including arrays, tuples, dictionaries, and strings.
Covers basic operations, functional methods, comprehensions, slicing, and spread operators.

## Syntax

```simple
val arr = [1, 2, 3]                    # Array literal
val t = (10, 20, 30)                   # Tuple literal
val d = {"a": 1, "b": 2}               # Dictionary literal
val doubled = arr.map(\x: x * 2)       # Functional method
val squares = [x * x for x in arr]    # List comprehension
val sub = arr[1:4]                     # Slicing
val last = arr[-1]                     # Negative indexing
```
"""



# ============================================================================
# Test Group 1: Array Basics
# ============================================================================

describe "Array Basics":
    """
    ## Array Literal and Basic Operations

    Tests for array creation and basic access methods.
    """

    it "creates array literal and accesses by index":
        val arr = [1, 2, 3, 4, 5]
        expect arr[2] == 3

    it "gets array length":
        val arr = [10, 20, 30]
        expect arr.len() == 3

    it "gets first and last elements":
        val arr = [5, 10, 15, 20]
        expect arr.first() + arr.last() == 25

    it "checks if array contains element":
        val arr = [1, 2, 3]
        var result = 0
        if arr.contains(2):
            result = 1
        expect result == 1

    it "checks if array is empty":
        val arr = []
        var result = 0
        if arr.is_empty():
            result = 1
        expect result == 1


# ============================================================================
# Test Group 2: Tuple Basics
# ============================================================================

describe "Tuple Basics":
    """
    ## Tuple Literal and Operations

    Tests for tuple creation and access.
    """

    it "creates tuple literal and accesses by index":
        val t = (10, 20, 30)
        expect t[1] == 20

    it "gets tuple length":
        val t = (1, 2, 3, 4)
        expect t.len() == 4

    it "destructures tuple":
        val (a, b, c) = (10, 20, 30)
        expect a + b + c == 60


# ============================================================================
# Test Group 3: Dictionary Basics
# ============================================================================

describe "Dictionary Basics":
    """
    ## Dictionary Literal and Operations

    Tests for dictionary creation and access.
    """

    it "creates dict literal and accesses by key":
        val d = {"a": 10, "b": 20}
        expect d["a"] + d["b"] == 30

    it "gets dict length":
        val d = {"x": 1, "y": 2, "z": 3}
        expect d.len() == 3

    it "checks if dict contains key":
        val d = {"name": 42}
        var result = 0
        if d.contains_key("name"):
            result = 1
        expect result == 1

    it "gets value from dict":
        val d = {"value": 99}
        expect d.get("value") == 99


# ============================================================================
# Test Group 4: String Operations
# ============================================================================

describe "String Operations":
    """
    ## String Methods

    Tests for string operations.
    """

    it "gets string length":
        val s = "hello"
        expect s.len() == 5

    it "checks if string contains substring":
        val s = "hello world"
        var result = 0
        if s.contains("world"):
            result = 1
        expect result == 1

    it "indexes string to get character":
        val s = "abc"
        var result = 0
        if s[1] == "b":
            result = 1
        expect result == 1


# ============================================================================
# Test Group 5: Array Mutation Methods
# ============================================================================

describe "Array Mutation Methods":
    """
    ## Array Push, Concat, and Slice

    Tests for array modification operations.
    """

    it "pushes element to array":
        var arr = [1, 2, 3]
        arr = arr.push(4)
        expect arr[3] == 4

    it "concatenates two arrays":
        val a = [1, 2]
        val b = [3, 4]
        val c = a.concat(b)
        expect c.len() == 4

    it "slices array":
        val arr = [0, 1, 2, 3, 4, 5]
        val sliced = arr[2:5]
        expect sliced.len() == 3


# ============================================================================
# Test Group 6: Array Functional Methods
# ============================================================================

describe "Array Functional Methods":
    """
    ## Map, Filter, Reduce, and Other Functional Operations

    Tests for functional array methods.
    """

    it "maps array elements":
        val arr = [1, 2, 3]
        val doubled = arr.map(\x: x * 2)
        expect doubled[1] == 4

    it "filters array elements":
        val arr = [1, 2, 3, 4, 5]
        val evens = arr.filter(\x: x % 2 == 0)
        expect evens.len() == 2

    it "reduces array to single value":
        val arr = [1, 2, 3, 4, 5]
        val sum = arr.reduce(0, \acc, x: acc + x)
        expect sum == 15

    it "checks all elements match predicate":
        val arr = [2, 4, 6]
        val all_even = arr.all(\x: x % 2 == 0)
        var result = 0
        if all_even:
            result = 1
        expect result == 1

    it "joins array elements to string":
        val arr = [1, 2, 3]
        val s = arr.join("-")
        var result = 0
        if s == "1-2-3":
            result = 1
        expect result == 1

    it "sums array elements":
        val arr = [1, 2, 3, 4, 5]
        expect arr.sum() == 15

    it "reverses array":
        var arr = [1, 2, 3]
        val rev = arr.reverse()
        expect rev[0] == 3


# ============================================================================
# Test Group 7: Dictionary Methods
# ============================================================================

describe "Dictionary Methods":
    """
    ## Dict Set, Remove, Merge, and Get Operations

    Tests for dictionary modification and access.
    """

    it "sets new key in dict":
        var d = {"a": 1}
        d = d.set("b", 2)
        expect d["b"] == 2

    it "removes key from dict":
        var d = {"a": 1, "b": 2}
        d = d.remove("a")
        expect d.len() == 1

    it "merges two dicts":
        var d1 = {"a": 1}
        val d2 = {"b": 2}
        val d = d1.merge(d2)
        expect d.len() == 2

    it "gets with default value":
        val d = {"a": 10}
        expect d.get_or("b", 99) == 99


# ============================================================================
# Test Group 8: List Comprehension
# ============================================================================

describe "List Comprehension":
    """
    ## List Comprehension Syntax

    Tests for [expr for x in iterable] syntax.
    """

    it "creates list with basic comprehension":
        val arr = [1, 2, 3, 4, 5]
        val doubled = [x * 2 for x in arr]
        expect doubled[2] == 6

    it "creates list with condition":
        val arr = [1, 2, 3, 4, 5, 6]
        val evens = [x for x in arr if x % 2 == 0]
        expect evens.len() == 3

    it "creates squares list":
        val squares = [x * x for x in [1, 2, 3, 4]]
        expect squares[3] == 16


# ============================================================================
# Test Group 9: Dict Comprehension
# ============================================================================

describe "Dict Comprehension":
    """
    ## Dict Comprehension Syntax

    Tests for {key: value for x in iterable} syntax.
    """

    it "creates dict with comprehension":
        val arr = [1, 2, 3]
        val d = {x: x * x for x in arr}
        expect d[2] == 4


# ============================================================================
# Test Group 10: Slicing
# ============================================================================

describe "Slicing":
    """
    ## Array and String Slicing

    Tests for [start:end:step] slice syntax.
    """

    it "slices with start and end":
        val arr = [0, 1, 2, 3, 4, 5]
        val sub = arr[1:4]
        expect sub.len() == 3

    it "slices from start index to end":
        val arr = [0, 1, 2, 3, 4]
        val sub = arr[2:]
        expect sub[0] == 2

    it "slices from beginning to end index":
        val arr = [0, 1, 2, 3, 4]
        val sub = arr[:3]
        expect sub.len() == 3

    it "slices with step":
        val arr = [0, 1, 2, 3, 4, 5, 6, 7]
        val evens = arr[::2]
        expect evens.len() == 4


# ============================================================================
# Test Group 11: Negative Indexing
# ============================================================================

describe "Negative Indexing":
    """
    ## Negative Index Access

    Tests for arr[-1] style negative indexing.
    """

    it "accesses last element with -1":
        val arr = [10, 20, 30, 40, 50]
        expect arr[-1] == 50

    it "accesses second from end with -2":
        val arr = [1, 2, 3, 4, 5]
        expect arr[-2] == 4

    it "accesses string with negative index":
        val s = "hello"
        val c = s[-1]
        var result = 0
        if c == "o":
            result = 1
        expect result == 1


# ============================================================================
# Test Group 12: Spread Operators
# ============================================================================

describe "Spread Operators":
    """
    ## Array Spread Syntax

    Tests for [*a, *b] spread operator.
    """

    it "spreads two arrays":
        val a = [1, 2, 3]
        val b = [4, 5]
        val c = [*a, *b]
        expect c.len() == 5

    it "spreads with mixed elements":
        val a = [2, 3]
        val arr = [1, *a, 4]
        expect arr[2] == 3


# ============================================================================
# Test Group 13: Tuple Unpacking
# ============================================================================

describe "Tuple Unpacking":
    """
    ## Tuple Destructuring Assignment

    Tests for let (a, b) = tuple syntax.
    """

    it "unpacks basic tuple":
        val (x, y) = (1, 2)
        expect x + y == 3

    it "unpacks with swap pattern":
        val a = 10
        val b = 20
        val (x, y) = (b, a)
        expect x == 20

    it "unpacks array to tuple":
        val arr = [5, 10, 15]
        val (first, second, third) = arr
        expect second == 10


# ============================================================================
# Test Group 14: Chained Comparisons
# ============================================================================

describe "Chained Comparisons":
    """
    ## Python-style Chained Comparisons

    Tests for a < x < b style comparisons.
    """

    it "evaluates basic chained comparison":
        val x = 5
        var result = 0
        if 0 < x < 10:
            result = 1
        expect result == 1

    it "evaluates false chained comparison":
        val x = 15
        var result = 0
        if 0 < x < 10:
            result = 1
        expect result == 0

    it "evaluates three-way comparison":
        val a = 1
        val b = 5
        val c = 10
        var result = 0
        if a < b < c:
            result = 1
        expect result == 1

    it "evaluates mixed comparison operators":
        val x = 5
        var result = 0
        if 0 <= x <= 10:
            result = 1
        expect result == 1


# ============================================================================
# Test Group 15: Context Managers
# ============================================================================

describe "Context Managers":
    """
    ## With Statement

    Tests for with statement context managers.
    """

    it "executes basic with block":
        var counter = 0
        with 42:
            counter = 1
        expect counter == 1

    it "binds resource with as":
        with 42 as x:
            val value = x + 1
        expect value == 43

    it "calls __enter__ and __exit__ on class":
        class Resource:
            value: i64 = 0

            fn __enter__(self):
                return self.value + 10

            fn __exit__(self):
                return 0

        val r = Resource(value: 5)
        with r as v:
            val ret_value = v
        expect ret_value == 15


# ============================================================================
# Test Group 16: Decorators
# ============================================================================

describe "Decorators":
    """
    ## Function Decorators

    Tests for @decorator syntax.
    """

    it "applies basic decorator":
        fn double_result(f):
            fn wrapper(x):
                return f(x) * 2
            return wrapper

        @double_result
        fn add_one(x):
            return x + 1

        expect add_one(5) == 12

    it "applies decorator with arguments":
        fn multiply_by(factor):
            fn decorator(f):
                fn wrapper(x):
                    return f(x) * factor
                return wrapper
            return decorator

        @multiply_by(3)
        fn increment(x):
            return x + 1

        expect increment(10) == 33

