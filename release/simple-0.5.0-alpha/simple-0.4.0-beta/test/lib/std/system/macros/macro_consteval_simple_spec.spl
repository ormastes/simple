# @pending
"""
Simplified const-eval engine specification.

Tests basic compile-time evaluation scenarios including arithmetic operations,
conditional expressions, loop evaluation, and string template processing.
"""


# ============================================================================
# Module-level macro definitions
# ============================================================================

# Arithmetic macros
macro simple_add(a: Int, b: Int) -> (returns result: Int):
    emit result:
        a + b

macro simple_mul(a: Int, b: Int) -> (returns result: Int):
    emit result:
        a * b

# Conditional macros
macro simple_max(a: Int, b: Int) -> (returns result: Int):
    emit result:
        if a > b:
            return a
        else:
            return b

macro simple_min(a: Int, b: Int) -> (returns result: Int):
    emit result:
        if a < b:
            return a
        else:
            return b

# Loop macros
macro simple_sum_range(n: Int const) -> (returns result: Int):
    emit result:
        var sum = 0
        for i in 0..n:
            sum = sum + i
        sum

macro simple_gen_indexed(N: Int const) -> (
    intro funcs:
        for i in 0..N:
            enclosing.module.fn "simple_idx_{i}"() -> Int
):
    emit funcs:
        for i in 0..N:
            fn "simple_idx_{i}"() -> Int:
                return i

# String template macros
macro simple_make_getter(name: Str const) -> (
    intro getter: enclosing.module.fn "simple_get_{name}"() -> Int
):
    emit getter:
        fn "simple_get_{name}"() -> Int:
            return 42

# ============================================================================
# Invoke macros that generate functions at module level
# ============================================================================
simple_gen_indexed!(2)
simple_make_getter!("test")

# ============================================================================
# Tests
# ============================================================================

describe "Const-Eval Engine":
    """
    Tests the simplified const-eval engine covering arithmetic operations,
    conditional evaluation, loop iteration, and string concatenation.
    """

    describe "Arithmetic":
        it "evaluates expressions":
            expect(simple_add!(20, 22)).to(eq(42))

        it "evaluates multiplication":
            expect(simple_mul!(6, 7)).to(eq(42))

    describe "Conditionals":
        it "evaluates max":
            expect(simple_max!(10, 50)).to(eq(50))
            expect(simple_max!(100, 5)).to(eq(100))

        it "evaluates min":
            expect(simple_min!(10, 50)).to(eq(10))

    describe "Loops":
        it "sums ranges":
            # 0 + 1 + 2 + 3 = 6
            expect(simple_sum_range!(4)).to(eq(6))

        it "generates indexed functions":
            expect(simple_idx_0() + simple_idx_1()).to(eq(1))

    describe "Strings":
        it "concatenates in template":
            expect(simple_get_test()).to(eq(42))
