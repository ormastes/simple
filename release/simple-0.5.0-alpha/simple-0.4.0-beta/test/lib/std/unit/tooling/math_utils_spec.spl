# @pending
"""
Math Utilities Tests

Tests for mathematical operations including absolute value, min/max, rounding,
power functions, GCD/LCM, combinatorics, and statistical calculations.

Feature:
  Mathematical utility functions

Category:
  Tooling/Mathematics

Status:
  Complete

Implementation:
  All math utility functions are provided locally in this test file.
  This allows tests to be independent of external dependencies.
"""


# =====================================
# Math Utility Implementations
# =====================================

fn abs_i64(x: i64) -> i64:
    if x < 0: -x else: x

fn min_i64(a: i64, b: i64) -> i64:
    if a < b: a else: b

fn max_i64(a: i64, b: i64) -> i64:
    if a > b: a else: b

fn clamp_i64(x: i64, min_val: i64, max_val: i64) -> i64:
    if x < min_val:
        min_val
    else if x > max_val:
        max_val
    else:
        x

fn sign_i64(x: i64) -> i64:
    if x > 0: 1
    else if x < 0: -1
    else: 0

fn pow_i64(base: i64, exp: i64) -> i64:
    if exp == 0:
        return 1
    var result = 1
    for _ in 0..exp:
        result = result * base
    result

fn gcd(a: i64, b: i64) -> i64:
    var x = abs_i64(a)
    var y = abs_i64(b)
    if x == 0: return y
    if y == 0: return x
    while y != 0:
        val temp = y
        y = x % y
        x = temp
    x

fn lcm(a: i64, b: i64) -> i64:
    if a == 0 or b == 0: return 0
    abs_i64(a * b) / gcd(a=a, b=b)

fn factorial(n: i64) -> i64:
    if n <= 1: return 1
    var result = 1
    for i in 2..=n:
        result = result * i
    result

fn binomial(n: i64, k: i64) -> i64:
    if k > n: return 0
    if k == 0 or k == n: return 1
    factorial(n) / (factorial(k) * factorial(n - k))

fn is_even(x: i64) -> bool:
    x % 2 == 0

fn is_odd(x: i64) -> bool:
    x % 2 != 0

fn is_divisible_by(x: i64, d: i64) -> bool:
    x % d == 0

fn in_range_i64(x: i64, min_val: i64, max_val: i64) -> bool:
    x >= min_val and x <= max_val

fn sum_i64(list: [i64]) -> i64:
    var total = 0
    for x in list:
        total = total + x
    total

fn product_i64(list: [i64]) -> i64:
    if list.len() == 0: return 1
    var result = 1
    for x in list:
        result = result * x
    result

fn average_i64(list: [i64]) -> Option<i64>:
    if list.len() == 0: return nil
    Some(sum_i64(list) / list.len())

fn median_i64(list: [i64]) -> Option<i64>:
    if list.len() == 0: return nil
    # Simple bubble sort for median
    var sorted = list
    val n = sorted.len()
    for i in 0..n:
        for j in 0..(n - i - 1):
            if sorted[j] > sorted[j + 1]:
                val temp = sorted[j]
                sorted[j] = sorted[j + 1]
                sorted[j + 1] = temp
    val mid = n / 2
    if n % 2 == 0:
        Some((sorted[mid - 1] + sorted[mid]) / 2)
    else:
        Some(sorted[mid])

# =====================================
# BDD Tests
# =====================================

describe "Math Utilities":
    """
    Comprehensive tests for mathematical utility functions covering basic operations,
    comparisons, combinatorics, and statistical calculations on i64 values.
    """

    describe "Absolute Value":
        it "returns positive for positive":
            expect abs_i64(5) == 5

        it "returns positive for negative":
            expect abs_i64(-5) == 5

        it "returns zero for zero":
            expect abs_i64(0) == 0

    describe "Min/Max":
        it "min returns smaller":
            expect min_i64(a=5, b=10) == 5
            expect min_i64(a=-5, b=3) == -5

        it "max returns larger":
            expect max_i64(a=5, b=10) == 10
            expect max_i64(a=-5, b=3) == 3

    describe "Clamp":
        it "clamps within range":
            expect clamp_i64(x=5, min_val=0, max_val=10) == 5

        it "clamps below min":
            expect clamp_i64(x=-5, min_val=0, max_val=10) == 0

        it "clamps above max":
            expect clamp_i64(x=15, min_val=0, max_val=10) == 10

    describe "Sign":
        it "returns 1 for positive":
            expect sign_i64(5) == 1

        it "returns -1 for negative":
            expect sign_i64(-5) == -1

        it "returns 0 for zero":
            expect sign_i64(0) == 0

    describe "Power":
        it "calculates powers":
            expect pow_i64(base=2, exp=3) == 8
            expect pow_i64(base=3, exp=2) == 9

        it "handles zero exponent":
            expect pow_i64(base=10, exp=0) == 1

        it "handles zero base":
            expect pow_i64(base=0, exp=5) == 0

        it "handles negative base":
            expect pow_i64(base=-2, exp=3) == -8
            expect pow_i64(base=-2, exp=4) == 16

    describe "GCD and LCM":
        it "calculates gcd":
            expect gcd(a=12, b=8) == 4
            expect gcd(a=21, b=14) == 7
            expect gcd(a=17, b=19) == 1

        it "gcd with same number":
            expect gcd(a=10, b=10) == 10

        it "gcd with zero":
            expect gcd(a=0, b=5) == 5
            expect gcd(a=5, b=0) == 5

        it "calculates lcm":
            expect lcm(a=4, b=6) == 12
            expect lcm(a=3, b=5) == 15

    describe "Factorial and Binomial":
        it "calculates factorial":
            expect factorial(0) == 1
            expect factorial(1) == 1
            expect factorial(5) == 120

        it "calculates binomial":
            expect binomial(n=5, k=2) == 10
            expect binomial(n=4, k=2) == 6
            expect binomial(n=5, k=0) == 1
            expect binomial(n=5, k=5) == 1

    describe "Even/Odd":
        it "detects even":
            expect is_even(0)
            expect is_even(2)
            expect is_even(-4)
            expect not is_even(1)

        it "detects odd":
            expect is_odd(1)
            expect is_odd(3)
            expect not is_odd(0)

    describe "Divisibility":
        it "checks divisibility":
            expect is_divisible_by(x=10, d=2)
            expect is_divisible_by(x=15, d=5)
            expect not is_divisible_by(x=7, d=3)

    describe "Range":
        it "checks in range":
            expect in_range_i64(x=5, min_val=0, max_val=10)
            expect not in_range_i64(x=-1, min_val=0, max_val=10)
            expect not in_range_i64(x=11, min_val=0, max_val=10)

    describe "Statistics":
        it "calculates sum":
            expect sum_i64([1, 2, 3, 4, 5]) == 15

        it "sum of empty is 0":
            val empty_list: [i64] = []
            expect sum_i64(empty_list) == 0

        it "calculates product":
            expect product_i64([2, 3, 4]) == 24

        it "product of empty is 1":
            val empty_list: [i64] = []
            expect product_i64(empty_list) == 1

        it "calculates average":
            match average_i64([1, 2, 3, 4, 5]):
                case Some(avg): expect avg == 3
                case nil: expect false

        it "average of empty is nil":
            val empty_list: [i64] = []
            match average_i64(empty_list):
                case Some(_): expect false
                case nil: expect true

        it "calculates median odd":
            match median_i64([1, 2, 3, 4, 5]):
                case Some(med): expect med == 3
                case nil: expect false

        it "calculates median even":
            match median_i64([1, 2, 3, 4]):
                case Some(med): expect med == 2
                case nil: expect false
