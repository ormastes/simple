"""
Effect System - Phase 3A: Core Infrastructure Only

This is a simplified version containing just the Effect enum and basic operations.
Full EffectEnv with Dict/Set will be added in Phase 3B after collection types are available.
"""

# ============================================================================
# Effect Type
# ============================================================================

enum Effect:
    """
    Function effect: Sync or Async

    - Sync: Returns T directly, no suspension points
    - Async: Returns Promise<T>, contains suspension operators or async calls
    """
    Sync
    Async

    fn to_string() -> text:
        match self:
            case Effect.Sync: "sync"
            case Effect.Async: "async"

    fn is_async() -> bool:
        """Check if effect is Async"""
        match self:
            case Effect.Async: true
            case Effect.Sync: false

    fn is_sync() -> bool:
        """Check if effect is Sync"""
        match self:
            case Effect.Sync: true
            case Effect.Async: false

    fn combine(other: Effect) -> Effect:
        """
        Combine two effects: if either is Async, result is Async

        Examples:
            Sync.combine(Sync) == Sync
            Sync.combine(Async) == Async
            Async.combine(Sync) == Async
            Async.combine(Async) == Async
        """
        # If either is Async, result is Async
        if self.is_async() or other.is_async():
            Effect.Async
        else:
            Effect.Sync

impl Effect:
    static fn combine_all(effects: [Effect]) -> Effect:
        """
        Combine multiple effects: if any is Async, result is Async

        Example:
            Effect.combine_all([Sync, Sync, Async, Sync]) == Async
        """
        var result = Effect.Sync
        for eff in effects:
            result = result.combine(eff)
        result

# ============================================================================
# Module Functions
# ============================================================================

fn effect_to_string(eff: Effect) -> text:
    """Convert effect to string (convenience function)"""
    eff.to_string()

fn is_async(eff: Effect) -> bool:
    """Check if effect is async (convenience function)"""
    eff.is_async()

fn is_sync(eff: Effect) -> bool:
    """Check if effect is sync (convenience function)"""
    eff.is_sync()

# ============================================================================
# Tests (Inline Unit Tests)
# ============================================================================

fn test_effect_basic():
    """Test basic effect operations"""
    val sync = Effect.Sync
    val async = Effect.Async

    # to_string
    assert sync.to_string() == "sync", "Sync.to_string should return 'sync'"
    assert async.to_string() == "async", "Async.to_string should return 'async'"

    # is_async / is_sync
    assert sync.is_sync(), "Sync should be sync"
    assert not sync.is_async(), "Sync should not be async"
    assert async.is_async(), "Async should be async"
    assert not async.is_sync(), "Async should not be sync"

    print "âœ… test_effect_basic passed"

fn test_effect_combine():
    """Test effect combination"""
    val sync = Effect.Sync
    val async = Effect.Async

    assert sync.combine(sync) == Effect.Sync, "Sync + Sync = Sync"
    assert sync.combine(async) == Effect.Async, "Sync + Async = Async"
    assert async.combine(sync) == Effect.Async, "Async + Sync = Async"
    assert async.combine(async) == Effect.Async, "Async + Async = Async"

    print "âœ… test_effect_combine passed"

fn test_effect_combine_all():
    """Test combining multiple effects"""
    assert Effect.combine_all([]) == Effect.Sync, "Empty array = Sync"
    assert Effect.combine_all([Effect.Sync, Effect.Sync]) == Effect.Sync, "All Sync = Sync"
    assert Effect.combine_all([Effect.Sync, Effect.Async]) == Effect.Async, "Any Async = Async"
    assert Effect.combine_all([Effect.Async, Effect.Sync, Effect.Sync]) == Effect.Async, "Any Async = Async (2)"

    print "âœ… test_effect_combine_all passed"

fn test_convenience_functions():
    """Test convenience functions"""
    val sync = Effect.Sync
    val async = Effect.Async

    assert effect_to_string(sync) == "sync", "effect_to_string(Sync)"
    assert effect_to_string(async) == "async", "effect_to_string(Async)"

    assert is_sync(sync), "is_sync(Sync)"
    assert not is_sync(async), "not is_sync(Async)"

    assert is_async(async), "is_async(Async)"
    assert not is_async(sync), "not is_async(Sync)"

    print "âœ… test_convenience_functions passed"

# Run all tests
fn main():
    print "Running Effect System Phase 3A Tests..."
    print ""

    test_effect_basic()
    test_effect_combine()
    test_effect_combine_all()
    test_convenience_functions()

    print ""
    print "ðŸŽ‰ All Phase 3A tests passed!"
    print ""
    print "Phase 3A Complete:"
    print "- âœ… Effect enum (Sync/Async)"
    print "- âœ… Basic operations (is_async, is_sync, to_string)"
    print "- âœ… Effect combination (combine, combine_all)"
    print "- âœ… Convenience functions"
    print ""
    print "Next: Phase 3B - Effect Environment & Body Scanning"
