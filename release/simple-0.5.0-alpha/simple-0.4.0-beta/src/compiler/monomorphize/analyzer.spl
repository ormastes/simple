# Call Site Analyzer
#
# Finds calls to generic functions in a module and collects the
# concrete type arguments needed for monomorphization.
# Handles both explicit generic calls (identity<Int>(42))
# and inferred generic calls (identity(42)).
#
# Port of rust/compiler/src/monomorphize/analyzer.rs (80+ lines)

export CallSite, CallSiteAnalyzer

use monomorphize.engine.ConcreteType

# ============================================================================
# Types
# ============================================================================

struct CallSite:
    function_name: text
    type_args: [ConcreteType]

# ============================================================================
# Call Site Analyzer
# ============================================================================

class CallSiteAnalyzer:
    """Analyzes AST to find calls to generic functions."""
    generic_functions: [text]
    call_sites: [CallSite]
    type_context: {text: ConcreteType}

impl CallSiteAnalyzer:
    static fn create(generic_function_names: [text]) -> CallSiteAnalyzer:
        CallSiteAnalyzer(generic_functions: generic_function_names,
                         call_sites: [], type_context: {})

    me add_call(name: text, type_args: [ConcreteType]):
        if self.generic_functions.contains(name):
            self.call_sites = self.call_sites.push(
                CallSite(function_name: name, type_args: type_args))

    me set_variable_type(name: text, ty: ConcreteType):
        self.type_context[name] = ty

    fn infer_type_from_name(name: text) -> ConcreteType?:
        if self.type_context.contains_key(name):
            Some(self.type_context[name])
        else:
            nil

    fn get_call_sites() -> [CallSite]:
        self.call_sites
