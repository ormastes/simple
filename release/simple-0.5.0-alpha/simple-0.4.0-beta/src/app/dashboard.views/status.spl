# Dashboard Status View
#
# Displays summary overview of all dashboard metrics.

use tooling.dashboard.types.{DashboardData}
use dashboard.render.colors.{BOLD, GREEN, YELLOW, RED, CYAN, RESET, colorize_status}
use dashboard.render.progress.{render_progress_bar, render_percentage, render_fraction}
use dashboard.render.table.{TableBuilder}

# =========================================================================
# Status View Renderer
# =========================================================================

# Render complete status view
fn render_status(data: DashboardData) -> text:
    var output = ""

    # Header
    output = "{output}{render_header()}\n\n"

    # Summary cards
    output = "{output}{render_summary_cards(data)}\n"

    # VCS state
    output = "{output}{render_vcs_state(data.vcs_state)}\n"

    # Critical alerts
    output = "{output}{render_critical_alerts(data)}\n"

    return output

# Render header
fn render_header() -> text:
    return "{BOLD}{CYAN}Simple Compiler Dashboard{RESET}"

# Render summary cards
fn render_summary_cards(data: DashboardData) -> text:
    var output = ""

    # Features card
    val feature_percent = if data.total_features() == 0:
        0.0
    else:
        ((data.completed_features() as f64) / (data.total_features() as f64)) * 100.0

    output = "{output}{BOLD}Features:{RESET}\n"
    output = "{output}  {render_progress_bar(feature_percent, 30)}\n"
    output = "{output}  {data.completed_features()}/{data.total_features()} complete\n\n"

    # TODOs card
    val total_todos = data.total_todos()
    val critical_todos = data.critical_todos()

    output = "{output}{BOLD}TODOs:{RESET}\n"
    output = "{output}  Total: {total_todos}\n"
    if critical_todos > 0:
        output = "{output}  {RED}Critical (P0): {critical_todos}{RESET}\n"
    else:
        output = "{output}  {GREEN}Critical (P0): 0{RESET}\n"
    output = "{output}\n"

    # Coverage card
    val coverage_percent = data.overall_coverage()

    output = "{output}{BOLD}Coverage:{RESET}\n"
    output = "{output}  {render_progress_bar(coverage_percent, 30)}\n\n"

    # SSpec tests card
    val total_tests = data.sspec_tests.len()
    var passing_tests = 0
    for test in data.sspec_tests:
        if test.success_rate() == 100.0:
            passing_tests = passing_tests + 1

    output = "{output}{BOLD}SSpec Tests:{RESET}\n"
    output = "{output}  Files: {total_tests}\n"
    output = "{output}  Passing: {render_fraction(passing_tests, total_tests)}\n\n"

    # Plans card
    val total_plans = data.plans.len()
    var completed_plans = 0
    for plan in data.plans:
        if plan.status == "completed":
            completed_plans = completed_plans + 1

    output = "{output}{BOLD}Plans:{RESET}\n"
    output = "{output}  Total: {total_plans}\n"
    output = "{output}  Completed: {render_fraction(completed_plans, total_plans)}\n\n"

    return output

# Render VCS state
fn render_vcs_state(vcs: VcsState) -> text:
    var output = "{BOLD}VCS State:{RESET}\n"

    if vcs.bookmark != "":
        output = "{output}  Bookmark: {CYAN}{vcs.bookmark}{RESET}\n"

    if vcs.commit_id != "":
        output = "{output}  Commit: {vcs.commit_id}\n"

    if vcs.commit_message != "":
        output = "{output}  Message: {vcs.commit_message}\n"

    if vcs.is_clean():
        output = "{output}  Status: {GREEN}Clean{RESET}\n"
    else:
        output = "{output}  Status: {YELLOW}Modified{RESET}\n"
        if vcs.uncommitted_files > 0:
            output = "{output}    Uncommitted: {vcs.uncommitted_files}\n"
        if vcs.untracked_files > 0:
            output = "{output}    Untracked: {vcs.untracked_files}\n"

    output = "{output}\n"
    return output

# Render critical alerts
fn render_critical_alerts(data: DashboardData) -> text:
    var has_alerts = false
    var output = ""

    # Check for P0 TODOs
    if data.critical_todos() > 0:
        if not has_alerts:
            output = "{output}{BOLD}{RED}Critical Alerts:{RESET}\n"
            has_alerts = true
        output = "{output}  {RED}[P0]{RESET} {data.critical_todos()} critical TODOs need attention\n"

    # Check for low coverage
    if data.overall_coverage() < 60.0:
        if not has_alerts:
            output = "{output}{BOLD}{RED}Critical Alerts:{RESET}\n"
            has_alerts = true
        output = "{output}  {YELLOW}[WARN]{RESET} Code coverage below 60%\n"

    if not has_alerts:
        output = "{output}{GREEN}No critical alerts{RESET}\n"

    output = "{output}\n"
    return output

# =========================================================================
# Exports
# =========================================================================

export render_status
export render_header, render_summary_cards, render_vcs_state, render_critical_alerts
