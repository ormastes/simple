# Quick GOT/PLT Test (no spec framework)
use compiler.backend.native.got_plt_builder.{GotPltBuilder, encode_i32_le, generate_plt_stub_x86_64}

var passed = 0
var failed = 0

# Test 1: Create builder
val builder = GotPltBuilder(got_entries: [], plt_entries: [], got_size: 0, plt_size: 0, next_got_offset: 0, next_plt_index: 0)
if builder.next_got_offset == 0 and builder.next_plt_index == 0:
    passed = passed + 1
    print "✓ Test 1: Builder initialization"
else:
    failed = failed + 1
    print "✗ Test 1: Builder initialization"

# Test 2: PLT stub generation
val stub = generate_plt_stub_x86_64(0, 0)
if stub.len() == 16 and stub[0] == 0xFF and stub[1] == 0x25:
    passed = passed + 1
    print "✓ Test 2: PLT stub generation"
else:
    failed = failed + 1
    print "✗ Test 2: PLT stub generation"

# Test 3: Add symbol
var b2 = GotPltBuilder(got_entries: [], plt_entries: [], got_size: 0, plt_size: 0, next_got_offset: 0, next_plt_index: 0)
val idx = b2.add_symbol("printf")
if idx == 0 and b2.plt_entries.len() == 1 and b2.got_entries.len() == 1:
    passed = passed + 1
    print "✓ Test 3: Add symbol"
else:
    failed = failed + 1
    print "✗ Test 3: Add symbol"

# Test 4: GOT offset increments
if b2.next_got_offset == 8:
    passed = passed + 1
    print "✓ Test 4: GOT offset increment"
else:
    failed = failed + 1
    print "✗ Test 4: GOT offset increment"

# Test 5: Multiple symbols
b2.add_symbol("malloc")
b2.add_symbol("free")
if b2.plt_entries.len() == 3 and b2.get_got_size() == 24 and b2.get_plt_size() == 48:
    passed = passed + 1
    print "✓ Test 5: Multiple symbols"
else:
    failed = failed + 1
    print "✗ Test 5: Multiple symbols (got {b2.plt_entries.len()} entries, GOT={b2.get_got_size()}, PLT={b2.get_plt_size()})"

# Test 6: Symbol deduplication
val idx2 = b2.add_symbol("printf")
if idx2 == 0 and b2.plt_entries.len() == 3:
    passed = passed + 1
    print "✓ Test 6: Symbol deduplication"
else:
    failed = failed + 1
    print "✗ Test 6: Symbol deduplication"

# Test 7: Encode i32
val bytes = encode_i32_le(0x12345678)
if bytes.len() == 4 and bytes[0] == 120 and bytes[1] == 86 and bytes[2] == 52 and bytes[3] == 18:
    passed = passed + 1
    print "✓ Test 7: i32 little-endian encoding"
else:
    failed = failed + 1
    print "✗ Test 7: i32 little-endian encoding"

# Test 8: PLT stub with index
val stub2 = generate_plt_stub_x86_64(42, 0)
if stub2[6] == 0x68 and stub2[7] == 42:
    passed = passed + 1
    print "✓ Test 8: PLT stub with index"
else:
    failed = failed + 1
    print "✗ Test 8: PLT stub with index"

# Test 9: PLT stub with GOT offset
val stub3 = generate_plt_stub_x86_64(0, 256)
if stub3[2] == 0 and stub3[3] == 1:
    passed = passed + 1
    print "✓ Test 9: PLT stub with GOT offset"
else:
    failed = failed + 1
    print "✗ Test 9: PLT stub with GOT offset"

# Summary
print "\n" + "=" * 50
print "GOT/PLT Builder Tests"
print "=" * 50
print "Passed: {passed}/9"
print "Failed: {failed}/9"
if failed == 0:
    print "\n✓ All tests passed!"
else:
    print "\n✗ Some tests failed"
