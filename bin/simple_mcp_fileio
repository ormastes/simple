#!/bin/bash
# File I/O Protection MCP Server Wrapper
# Starts the Simple-based MCP server for protected file operations

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Runtime selection:
#   1) SIMPLE_RUNTIME override
#   2) platform-specific release binary
#   3) downloaded release wrapper
#   4) bootstrap fallback
find_runtime() {
    if [ -n "${SIMPLE_RUNTIME:-}" ] && [ -x "$SIMPLE_RUNTIME" ]; then
        echo "$SIMPLE_RUNTIME"; return
    fi
    local arch=$(uname -m) os=$(uname -s | tr '[:upper:]' '[:lower:]')
    case "$arch" in x86_64|amd64) arch="x86_64" ;; aarch64|arm64) arch="arm64" ;; riscv64) arch="riscv64" ;; esac
    case "$os" in linux) os="linux" ;; darwin) os="macos" ;; freebsd) os="freebsd" ;; mingw*|msys*|cygwin*) os="windows" ;; esac
    local platform="${os}-${arch}"
    local platform_bin="${SCRIPT_DIR}/release/${platform}/simple"
    case "$platform" in *windows*) platform_bin="${platform_bin}.exe" ;; esac
    if [ -x "$platform_bin" ]; then echo "$platform_bin"; return; fi
    if [ "$platform" = "freebsd-x86_64" ] && [ -x "${SCRIPT_DIR}/release/linux-x86_64/simple" ]; then
        echo "${SCRIPT_DIR}/release/linux-x86_64/simple"; return
    fi
    if [ -f "${SCRIPT_DIR}/release/downloaded/current_tag" ]; then
        echo "${SCRIPT_DIR}/release/simple"; return
    fi
    echo "${SCRIPT_DIR}/bootstrap/cpp/simple"
}
RUNTIME="$(find_runtime)"
PROXY="${SCRIPT_DIR}/mcp_stdio_proxy.py"

# MCP server main script
MCP_MAIN="${SCRIPT_DIR}/../src/app/mcp/fileio_main.spl"

# Point runtime at project stdlib for module imports
export SIMPLE_LIB="${SCRIPT_DIR}/../src"
export SIMPLE_VERSION=$(cat "${SCRIPT_DIR}/../VERSION" 2>/dev/null || echo "unknown")
export SIMPLE_LOG=error
export MCP_PROXY_EOF_GRACE=15

if [ ! -f "$MCP_MAIN" ]; then
    echo "Error: fileio_main.spl not found" >&2
    exit 1
fi

# Run server with error logging suppressed
RUST_LOG=error exec "$PROXY" "$RUNTIME" "$MCP_MAIN" server "$@" 2>/dev/null
