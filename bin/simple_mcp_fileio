#!/bin/bash
# File I/O Protection MCP Server Wrapper
# Starts the Simple-based MCP server for protected file operations

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Runtime selection:
#   1) SIMPLE_RUNTIME override
#   2) bootstrap runtime (often more stable for MCP)
#   3) release runtime fallback
RUNTIME="${SIMPLE_RUNTIME:-${SCRIPT_DIR}/bootstrap/cpp/simple}"
if [ ! -x "$RUNTIME" ]; then
    RUNTIME="${SCRIPT_DIR}/release/simple"
fi

# MCP server main script
MCP_MAIN="${SCRIPT_DIR}/../src/app/mcp/fileio_main.spl"

# Point runtime at project stdlib for module imports
export SIMPLE_LIB="${SCRIPT_DIR}/../src"
export SIMPLE_VERSION=$(cat "${SCRIPT_DIR}/../VERSION" 2>/dev/null || echo "unknown")

if [ ! -f "$MCP_MAIN" ]; then
    echo "Error: fileio_main.spl not found" >&2
    exit 1
fi

# Run server with error logging suppressed
RUST_LOG=error exec "$RUNTIME" "$MCP_MAIN" server 2>/dev/null
