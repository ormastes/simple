# MCP Server Startup Performance Comparison
# Measures baseline vs optimized server startup time

use app.io.mod.{shell, shell_output, print, exit}
use std.string.{trim, contains}

fn get_time_ms() -> i64:
    val result = shell_output("date +%s%N")
    val ns = int(trim(result))
    ns / 1000000

fn main():
    print "MCP Server Startup Performance Benchmark"
    print "========================================="
    print ""

    val init_msg = "Content-Length: 123\\r\\n\\r\\n{\"jsonrpc\":\"2.0\",\"id\":\"1\",\"method\":\"initialize\",\"params\":{\"protocolVersion\":\"2024-11-05\",\"capabilities\":{}}}"
    val tools_msg = "Content-Length: 50\\r\\n\\r\\n{\"jsonrpc\":\"2.0\",\"id\":\"2\",\"method\":\"tools/list\"}"

    # Benchmark legacy server
    print "Baseline (Legacy) Server:"
    print "-------------------------"
    val legacy_start = get_time_ms()
    shell("printf '{init_msg}\\n{tools_msg}\\n' | timeout 5 bin/simple_mcp_server_legacy >/dev/null 2>&1 || true")
    val legacy_end = get_time_ms()
    val legacy_time = legacy_end - legacy_start
    print "Startup time: {legacy_time}ms"
    print ""

    # Benchmark optimized server
    print "Optimized Server:"
    print "----------------"
    val opt_start = get_time_ms()
    shell("printf '{init_msg}\\n{tools_msg}\\n' | timeout 5 bin/simple_mcp_server >/dev/null 2>&1 || true")
    val opt_end = get_time_ms()
    val optimized_time = opt_end - opt_start
    print "Startup time: {optimized_time}ms"
    print ""

    # Results
    print "Results:"
    print "--------"
    print "Legacy:    {legacy_time}ms"
    print "Optimized: {optimized_time}ms"

    if legacy_time > 0:
        val speedup_raw = legacy_time * 100 / optimized_time
        val speedup_whole = speedup_raw / 100
        val speedup_frac = speedup_raw % 100
        print "Speedup:   {speedup_whole}.{speedup_frac}x"

        val improvement = (legacy_time - optimized_time) * 100 / legacy_time
        print "Improvement: {improvement}%"

        if optimized_time < 1000:
            print ""
            print "SUCCESS: Optimized server achieves <1 second startup!"

main()
