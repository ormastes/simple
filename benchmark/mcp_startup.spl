# MCP Server Startup Benchmark
# Measures total time from initialize to first tool call

use app.io.mod.{shell, shell_output, file_write, print, exit, cwd}
use std.string.{trim, contains}
use std.path.{join}

fn get_time_ms() -> i64:
    val result = shell_output("date +%s%3N")
    int(trim(result))

fn main():
    val project_root = cwd()
    val server = join(project_root, "bin/simple_mcp_server")

    print "=== MCP Server Startup Benchmark ==="
    print "Testing: Initialize + Tools/List + First Tool Call"
    print ""

    # Create test input lines
    val line1 = "{\"jsonrpc\":\"2.0\",\"id\":1,\"method\":\"initialize\",\"params\":{\"protocolVersion\":\"2025-06-18\",\"capabilities\":{},\"clientInfo\":{\"name\":\"benchmark\",\"version\":\"1.0\"}}}"
    val line2 = "{\"jsonrpc\":\"2.0\",\"id\":2,\"method\":\"tools/list\",\"params\":{}}"
    val line3 = "{\"jsonrpc\":\"2.0\",\"id\":3,\"method\":\"tools/call\",\"params\":{\"name\":\"read_code\",\"arguments\":{\"path\":\"README.md\"}}}"

    # Write test input to temp file
    val test_input = "{line1}\n{line2}\n{line3}"
    file_write("/tmp/mcp_bench_input.txt", test_input)

    # Create wrapper script to inject proper MCP framing
    val wrapper = "#!/bin/bash\ncat /tmp/mcp_bench_input.txt | while IFS= read -r line; do\n    echo \"Content-Length: $\\{#line\\}\"\n    echo \"\"\n    echo \"$line\"\ndone | {server} 2>/dev/null"
    file_write("/tmp/mcp_bench_wrapper.sh", wrapper)
    shell("chmod +x /tmp/mcp_bench_wrapper.sh")

    # Measure total time
    print "Starting benchmark..."
    val start = get_time_ms()

    val result = shell("timeout 10 /tmp/mcp_bench_wrapper.sh > /tmp/mcp_bench_output.log 2>&1 || true")

    val end_time = get_time_ms()
    val total = end_time - start

    print ""
    print "=== Results ==="
    print "Total time: {total}ms"
    print ""
    print "Expected breakdown:"
    print "  - Initialize: ~1150ms"
    print "  - Tools/list: ~50ms"
    print "  - First tool: ~1500ms"
    print "  - TOTAL:      ~2700ms"
    print ""

    if total < 1000:
        print "Target achieved: <1 second"
    if total >= 1000:
        if total < 2000:
            print "Good progress: <2 seconds"
    if total >= 2000:
        print "Needs optimization: >{total}ms"

    # Show response count
    val count_result = shell_output("grep -c '\"jsonrpc\":\"2.0\"' /tmp/mcp_bench_output.log 2>/dev/null || echo 0")
    val response_count = trim(count_result)
    print ""
    print "Responses received: {response_count}/3"

    # Cleanup
    shell("rm -f /tmp/mcp_bench_input.txt /tmp/mcp_bench_wrapper.sh /tmp/mcp_bench_output.log")

main()
