# Example Group Registry
# Stores and manages test example groups and their hierarchies

# Hook types (RSpec-aligned)
export enum Hook:
    BeforeEach(Fn() -> Void)
    AfterEach(Fn() -> Void)
    BeforeAll(Fn() -> Void)
    AfterAll(Fn() -> Void)

# Single test example
export class Example:
    description: String
    block: Fn() -> Void
    tags: List<Symbol>
    pending: Bool
    
    fn new(description: String, block: Fn() -> Void) -> Example:
        return Example {
            description: description,
            block: block,
            tags: [],
            pending: false
        }
    
    fn tag(tag: Symbol) -> Example:
        self.tags.push(tag)
        return self
    
    fn skip() -> Example:
        self.pending = true
        return self

# Example group (describe/context)
export class ExampleGroup:
    description: String
    parent: Option<ExampleGroup>
    children: List<ExampleGroup>
    examples: List<Example>
    hooks: List<Hook>
    tags: List<Symbol>
    
    fn new(description: String, parent: Option<ExampleGroup>) -> ExampleGroup:
        return ExampleGroup {
            description: description,
            parent: parent,
            children: [],
            examples: [],
            hooks: [],
            tags: []
        }
    
    fn add_child(child: ExampleGroup) -> Void:
        self.children.push(child)
    
    fn add_example(example: Example) -> Void:
        self.examples.push(example)
    
    fn add_hook(hook: Hook) -> Void:
        self.hooks.push(hook)
    
    fn tag(tag: Symbol) -> ExampleGroup:
        self.tags.push(tag)
        return self
    
    # Get full description path (e.g., "Stack when empty")
    fn full_description() -> String:
        match self.parent:
            case Some(parent):
                return "${parent.full_description()} ${self.description}"
            case None:
                return self.description
    
    # Collect all hooks from ancestors (for execution)
    fn collect_hooks(hook_type: Type<Hook>) -> List<Hook>:
        val hooks = []
        
        # Traverse up to collect outer hooks first
        match self.parent:
            case Some(parent):
                hooks.extend(parent.collect_hooks(hook_type))
            case None:
                pass
        
        # Add own hooks
        for hook in self.hooks:
            match hook:
                case h if h is hook_type:
                    hooks.push(h)
                case _:
                    pass
        
        return hooks

# Global registry of all example groups
val all_groups: List<ExampleGroup> = []

export fn register_group(group: ExampleGroup) -> Void:
    all_groups.push(group)

export fn get_all_groups() -> List<ExampleGroup>:
    return all_groups

export fn clear_registry() -> Void:
    all_groups.clear()
