# Simple Language Interpreter
#
# Self-hosted interpreter for Simple language.
# This is the CLI entry point for running Simple programs.
#
# Usage:
#   simple_interpret script.spl [args...]
#   simple_interpret --repl
#   simple_interpret --eval "expression"
#
# This interpreter can interpret itself (self-hosting).

import std.args
import std.io

from core import {Interpreter}

fn main() -> i32:
    val args = args.get_args()

    if args.len() < 2:
        print_usage()
        return 1

    val cmd = args[1]

    match cmd:
        case "--help" | "-h":
            print_usage()
            return 0

        case "--version" | "-v":
            print("Simple Interpreter v0.1.0")
            return 0

        case "--repl":
            return run_repl()

        case "--eval" | "-e":
            if args.len() < 3:
                io.eprintln("Error: --eval requires an expression")
                return 1
            return eval_expr(args[2])

        case _:
            # Treat as script file
            val script_path = cmd
            val script_args = args.slice(2, args.len())
            return run_script(script_path, script_args)

fn print_usage():
    print("Simple Interpreter - Self-hosted interpreter for Simple language")
    print("")
    print("Usage:")
    print("  simple_interpret <script.spl> [args...]  Run a Simple script")
    print("  simple_interpret --repl                  Start interactive REPL")
    print("  simple_interpret --eval <expr>           Evaluate expression")
    print("  simple_interpret --help                  Show this help")
    print("  simple_interpret --version               Show version")

fn run_script(path: String, args: Array[String]) -> i32:
    val interp = Interpreter::new()

    # TODO: [stdlib][P2] Load and parse script
    # TODO: [stdlib][P3] Set script arguments
    # TODO: [stdlib][P3] Execute script
    # TODO: [stdlib][P3] Return exit code

    io.eprintln("Script execution not yet implemented")
    return 1

fn run_repl() -> i32:
    val interp = Interpreter::new()

    print("Simple REPL v0.1.0")
    print("Type 'exit' to quit, 'help' for commands")
    print("")

    loop:
        io.print(">>> ")
        io.flush()

        val line = io.read_line()
        if line is None:
            break

        val input = line.unwrap().trim()

        match input:
            case "exit" | "quit":
                break
            case "help":
                print_repl_help()
            case "":
                pass  # Empty line
            case _:
                # TODO: [stdlib][P3] Evaluate input
                io.eprintln("Evaluation not yet implemented")

    return 0

fn print_repl_help():
    print("REPL Commands:")
    print("  exit, quit  Exit the REPL")
    print("  help        Show this help")
    print("")
    print("Enter Simple expressions to evaluate them.")

fn eval_expr(expr: String) -> i32:
    val interp = Interpreter::new()

    # TODO: [stdlib][P2] Parse and evaluate expression
    # TODO: [stdlib][P3] Print result

    io.eprintln("Expression evaluation not yet implemented")
    return 1
