# Regeneration Module Tests
#
# Tests for the Lean code regeneration functions.
# Verifies that all 11 verification projects can be generated
# with valid Lean syntax and complete proofs.

import spec
import verification.regenerate as regen

describe "Lean Regeneration":

    describe "Simple Projects (Complete Proofs)":

        it "regenerates nogc_compile without sorry":
            code = regen.regenerate_nogc_compile()
            expect(code).to_contain("inductive Instruction")
            expect(code).to_contain("theorem valid_instructions_compile")
            # This project should have complete proofs
            expect(code).not_to_contain("sorry")

        it "regenerates async_compile without sorry":
            code = regen.regenerate_async_compile()
            expect(code).to_contain("inductive Effect")
            expect(code).to_contain("theorem effect_soundness")
            expect(code).not_to_contain("sorry")

        it "regenerates gc_manual_borrow without sorry":
            code = regen.regenerate_gc_manual_borrow()
            expect(code).to_contain("inductive BorrowState")
            expect(code).to_contain("theorem borrow_safety")
            expect(code).not_to_contain("sorry")

        it "regenerates manual_pointer_borrow without sorry":
            code = regen.regenerate_manual_pointer_borrow()
            expect(code).to_contain("inductive ValidBorrowState")
            expect(code).to_contain("theorem valid_borrow_preserved")
            expect(code).not_to_contain("sorry")

    describe "Medium Complexity Projects":

        it "regenerates module_resolution without sorry":
            code = regen.regenerate_module_resolution()
            expect(code).to_contain("structure ModuleId")
            expect(code).to_contain("theorem resolution_deterministic")
            expect(code).not_to_contain("sorry")

        it "regenerates visibility_export without sorry":
            code = regen.regenerate_visibility_export()
            expect(code).to_contain("inductive Visibility")
            expect(code).to_contain("theorem visibility_lattice")
            expect(code).not_to_contain("sorry")

        it "regenerates macro_auto_import without sorry":
            code = regen.regenerate_macro_auto_import()
            expect(code).to_contain("structure MacroDef")
            expect(code).to_contain("theorem auto_import_soundness")
            expect(code).not_to_contain("sorry")

    describe "Type Inference Projects":

        it "regenerates type_inference_compile":
            code = regen.regenerate_type_inference_compile()
            expect(code).to_contain("inductive Ty")
            expect(code).to_contain("inductive Expr")
            expect(code).to_contain("def infer")
            expect(code).to_contain("theorem infer_deterministic")

        it "regenerates generics with type system":
            code = regen.regenerate_generics()
            expect(code).to_contain("abbrev TyVar")
            expect(code).to_contain("structure Scheme")
            expect(code).to_contain("abbrev Subst")
            expect(code).to_contain("def applySubst")
            expect(code).to_contain("def unify")
            expect(code).to_contain("def instantiate")
            expect(code).to_contain("def generalize")

        it "regenerates contracts":
            code = regen.regenerate_contracts()
            expect(code).to_contain("ContractClause")
            expect(code).to_contain("FunctionContract")

    describe "Memory Verification Projects":

        it "regenerates memory_capabilities with reference types":
            code = regen.regenerate_memory_capabilities()
            expect(code).to_contain("inductive RefCapability")
            expect(code).to_contain("| Shared")
            expect(code).to_contain("| Exclusive")
            expect(code).to_contain("| Isolated")
            expect(code).to_contain("structure Reference")
            expect(code).to_contain("theorem exclusive_is_unique")
            expect(code).to_contain("theorem conversion_is_safe")
            expect(code).to_contain("theorem actor_mode_safety")

        it "regenerates memory_model_drf with SC-DRF theorem":
            code = regen.regenerate_memory_model_drf()
            expect(code).to_contain("abbrev ThreadId")
            expect(code).to_contain("inductive MemoryOrdering")
            expect(code).to_contain("structure MemoryOperation")
            expect(code).to_contain("structure Execution")
            expect(code).to_contain("def happensBefore")
            expect(code).to_contain("def dataRaceFree")
            expect(code).to_contain("structure SequentiallyConsistent")
            expect(code).to_contain("theorem scDRF")
            expect(code).to_contain("theorem happensBefore_transitive")

    describe "regenerate_all()":

        it "generates all 12 Lean files":
            all_files = regen.regenerate_all()
            expect(len(all_files)).to_equal(12)

        it "includes all project paths":
            all_files = regen.regenerate_all()

            # Simple projects
            expect(all_files).to_have_key("verification/nogc_compile/src/NogcCompile.lean")
            expect(all_files).to_have_key("verification/async_compile/src/AsyncCompile.lean")
            expect(all_files).to_have_key("verification/gc_manual_borrow/src/GcManualBorrow.lean")
            expect(all_files).to_have_key("verification/manual_pointer_borrow/src/ManualPointerBorrow.lean")

            # Medium complexity
            expect(all_files).to_have_key("verification/module_resolution/src/ModuleResolution.lean")
            expect(all_files).to_have_key("verification/visibility_export/src/VisibilityExport.lean")
            expect(all_files).to_have_key("verification/macro_auto_import/src/MacroAutoImport.lean")

            # Type inference (3 files)
            expect(all_files).to_have_key("verification/type_inference_compile/src/TypeInferenceCompile.lean")
            expect(all_files).to_have_key("verification/type_inference_compile/src/Generics.lean")
            expect(all_files).to_have_key("verification/type_inference_compile/src/Contracts.lean")

            # Memory verification
            expect(all_files).to_have_key("verification/memory_capabilities/src/MemoryCapabilities.lean")
            expect(all_files).to_have_key("verification/memory_model_drf/src/MemoryModelDRF.lean")

        it "all generated files have valid Lean header":
            all_files = regen.regenerate_all()
            for (path, content) in all_files.items():
                expect(content).to_contain("/-")
                expect(content).to_contain("-/")
                expect(content).to_contain("Auto-generated from Simple verification models")

    describe "Lean Syntax Validation":

        it "structure definitions have 'where' keyword":
            code = regen.regenerate_memory_capabilities()
            expect(code).to_contain("structure Reference where")
            expect(code).to_contain("structure RefEnv where")

        it "inductive definitions have constructors":
            code = regen.regenerate_memory_capabilities()
            # Inductive should have | constructors
            expect(code).to_contain("| Shared")
            expect(code).to_contain("| Exclusive")
            expect(code).to_contain("| Isolated")

        it "theorems have proof structure":
            code = regen.regenerate_memory_capabilities()
            expect(code).to_contain("theorem")
            expect(code).to_contain(":=")
            expect(code).to_contain("by")

        it "namespaces are properly opened and closed":
            code = regen.regenerate_memory_model_drf()
            expect(code).to_contain("namespace MemoryModel")
            expect(code).to_contain("end MemoryModel")

    describe "Proof Completeness":

        it "happensBefore_transitive has complete proof":
            code = regen.regenerate_memory_model_drf()
            expect(code).to_contain("theorem happensBefore_transitive")
            # Should have actual tactic proof
            expect(code).to_contain("intro a b c hab hbc")

        it "conversion_is_safe has complete proof":
            code = regen.regenerate_memory_capabilities()
            expect(code).to_contain("theorem conversion_is_safe")
            expect(code).to_contain("cases cap <;> simp")

        it "actor_mode_safety has complete proof":
            code = regen.regenerate_memory_capabilities()
            expect(code).to_contain("theorem actor_mode_safety")
            expect(code).to_contain("intro op h")
