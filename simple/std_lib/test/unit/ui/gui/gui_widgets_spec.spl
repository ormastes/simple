# GUI Widgets Tests
#
# Tests for graphical UI widgets: Card, Chip, Avatar, Badge, Tooltip, Divider

use spec.*
use ui.element.*
use ui.gui.widgets.*
use ui.gui.theme.*

# Helper struct for allocating node IDs
struct IdAllocator:
    counter: u64

impl IdAllocator:
    pub fn new() -> IdAllocator:
        return IdAllocator { counter: 0 }

    pub fn alloc(self) -> NodeId:
        self.counter = self.counter + 1
        return NodeId::new(self.counter)

    pub fn count(self) -> u64:
        return self.counter

describe "Card":
    describe "new()":
        it "creates card with default settings":
            let card = Card::new(NodeId::new(1))
            expect(card.elevation).to(equal(1))
            expect(card.padding).to(equal(16))
            expect(card.title).to_be_none()

    describe "with_title()":
        it "sets card title":
            let card = Card::new(NodeId::new(1))
                .with_title("Settings")
            expect(card.title).to_be_some()

    describe "with_elevation()":
        it "sets elevation level capped at 5":
            let card = Card::new(NodeId::new(1))
                .with_elevation(3)
            expect(card.elevation).to(equal(3))

        it "caps elevation at maximum":
            let card = Card::new(NodeId::new(1))
                .with_elevation(10)
            expect(card.elevation).to(equal(5))

    describe "with_padding()":
        it "sets custom padding":
            let card = Card::new(NodeId::new(1))
                .with_padding(24)
            expect(card.padding).to(equal(24))

    describe "to_element()":
        it "converts to Element with proper structure":
            let alloc = IdAllocator::new()
            let theme = Theme::light()
            let card = Card::new(NodeId::new(1))
                .with_title("Test Card")

            let elem = card.to_element(|| alloc.alloc(), &theme)
            expect(elem.classes).to_contain("card")

describe "Chip":
    describe "new()":
        it "creates chip with label":
            let chip = Chip::new(NodeId::new(1), "Tag")
            expect(chip.label).to(equal("Tag"))
            expect(chip.deletable).to_be_false()
            expect(chip.selected).to_be_false()

    describe "with_icon()":
        it "adds icon to chip":
            let chip = Chip::new(NodeId::new(1), "Tag")
                .with_icon("star")
            expect(chip.icon).to_be_some()

    describe "deletable()":
        it "makes chip deletable":
            let chip = Chip::new(NodeId::new(1), "Tag")
                .deletable()
            expect(chip.deletable).to_be_true()

    describe "selected()":
        it "marks chip as selected":
            let chip = Chip::new(NodeId::new(1), "Tag")
                .selected()
            expect(chip.selected).to_be_true()

    describe "outlined()":
        it "changes chip variant to outlined":
            let chip = Chip::new(NodeId::new(1), "Tag")
                .outlined()
            expect(chip.variant).to(equal(ChipVariant::Outlined))

    describe "to_element()":
        it "renders with proper classes":
            let alloc = IdAllocator::new()
            let theme = Theme::light()
            let chip = Chip::new(NodeId::new(1), "Tag")

            let elem = chip.to_element(|| alloc.alloc(), &theme)
            expect(elem.classes).to_contain("chip")

describe "Avatar":
    describe "new()":
        it "creates avatar with alt text":
            let avatar = Avatar::new(NodeId::new(1), "John Doe")
            expect(avatar.alt).to(equal("John Doe"))
            expect(avatar.size).to(equal(AvatarSize::Medium))

    describe "with_src()":
        it "sets image source":
            let avatar = Avatar::new(NodeId::new(1), "User")
                .with_src("https://example.com/avatar.png")
            expect(avatar.src).to_be_some()

    describe "with_initials()":
        it "sets initials fallback":
            let avatar = Avatar::new(NodeId::new(1), "John Doe")
                .with_initials("JD")
            expect(avatar.initials).to_be_some()

    describe "size modifiers":
        it "small() sets 32px size":
            let avatar = Avatar::new(NodeId::new(1), "User")
                .small()
            expect(avatar.size).to(equal(AvatarSize::Small))

        it "large() sets 56px size":
            let avatar = Avatar::new(NodeId::new(1), "User")
                .large()
            expect(avatar.size).to(equal(AvatarSize::Large))

    describe "to_element()":
        it "renders circular avatar":
            let alloc = IdAllocator::new()
            let theme = Theme::light()
            let avatar = Avatar::new(NodeId::new(1), "User")

            let elem = avatar.to_element(|| alloc.alloc(), &theme)
            expect(elem.classes).to_contain("avatar")

describe "Badge":
    describe "new()":
        it "creates badge with content":
            let badge = Badge::new(NodeId::new(1), "New")
            expect(badge.content).to(equal("New"))

    describe "count()":
        it "creates numeric badge":
            let badge = Badge::count(NodeId::new(1), 42)
            expect(badge.content).to(equal("42"))

    describe "with_max()":
        it "caps displayed count":
            let badge = Badge::count(NodeId::new(1), 150)
                .with_max(99)
            expect(badge.content).to(equal("99+"))

        it "shows actual count if under max":
            let badge = Badge::count(NodeId::new(1), 50)
                .with_max(99)
            expect(badge.content).to(equal("50"))

    describe "variant modifiers":
        it "primary() sets primary variant":
            let badge = Badge::new(NodeId::new(1), "!").primary()
            expect(badge.variant).to(equal(BadgeVariant::Primary))

        it "error() sets error variant":
            let badge = Badge::new(NodeId::new(1), "!").error()
            expect(badge.variant).to(equal(BadgeVariant::Error))

        it "success() sets success variant":
            let badge = Badge::new(NodeId::new(1), "!").success()
            expect(badge.variant).to(equal(BadgeVariant::Success))

    describe "to_element()":
        it "renders badge with styles":
            let alloc = IdAllocator::new()
            let theme = Theme::light()
            let badge = Badge::count(NodeId::new(1), 5)

            let elem = badge.to_element(|| alloc.alloc(), &theme)
            expect(elem.classes).to_contain("badge")

describe "Tooltip":
    describe "new()":
        it "creates tooltip with content":
            let tooltip = Tooltip::new(NodeId::new(1), "Help text")
            expect(tooltip.content).to(equal("Help text"))
            expect(tooltip.position).to(equal(TooltipPosition::Top))

    describe "position modifiers":
        it "bottom() sets position":
            let tooltip = Tooltip::new(NodeId::new(1), "Help")
                .bottom()
            expect(tooltip.position).to(equal(TooltipPosition::Bottom))

        it "left() sets position":
            let tooltip = Tooltip::new(NodeId::new(1), "Help")
                .left()
            expect(tooltip.position).to(equal(TooltipPosition::Left))

        it "right() sets position":
            let tooltip = Tooltip::new(NodeId::new(1), "Help")
                .right()
            expect(tooltip.position).to(equal(TooltipPosition::Right))

    describe "to_element()":
        it "renders tooltip with data attributes":
            let alloc = IdAllocator::new()
            let theme = Theme::light()
            let tooltip = Tooltip::new(NodeId::new(1), "Help")

            let elem = tooltip.to_element(|| alloc.alloc(), &theme)
            expect(elem.classes).to_contain("tooltip")

describe "Divider":
    describe "horizontal()":
        it "creates horizontal divider":
            let divider = Divider::horizontal(NodeId::new(1))
            expect(divider.orientation).to(equal(DividerOrientation::Horizontal))

    describe "vertical()":
        it "creates vertical divider":
            let divider = Divider::vertical(NodeId::new(1))
            expect(divider.orientation).to(equal(DividerOrientation::Vertical))

    describe "variant modifiers":
        it "inset() creates inset divider":
            let divider = Divider::horizontal(NodeId::new(1))
                .inset()
            expect(divider.variant).to(equal(DividerVariant::Inset))

        it "middle() creates middle divider":
            let divider = Divider::horizontal(NodeId::new(1))
                .middle()
            expect(divider.variant).to(equal(DividerVariant::Middle))

    describe "to_element()":
        it "renders divider with correct dimensions":
            let theme = Theme::light()
            let divider = Divider::horizontal(NodeId::new(1))

            let elem = divider.to_element(&theme)
            expect(elem.classes).to_contain("divider")
