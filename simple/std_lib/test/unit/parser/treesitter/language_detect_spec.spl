# Unit tests for language detection

import spec.{describe, it, expect}
import parser.treesitter.language_detect as detect

describe "DetectionResult":
    it "creates detection result":
        let result = detect.DetectionResult.new("python", 0.9)

        expect result.language == "python"
        expect result.confidence == 0.9

describe "LanguageDetector":
    it "creates detector":
        let detector = detect.LanguageDetector.new()

        expect detector.extension_map.len() > 0
        expect detector.shebang_patterns.len() > 0

    it "has Simple language extension":
        let detector = detect.LanguageDetector.new()

        expect(detector.extension_map.contains_key(".spl")).to_be(true)
        expect detector.extension_map[".spl"] == "simple"

describe "Extension-based detection":
    it "detects Simple from .spl extension":
        let detector = detect.LanguageDetector.new()

        let result = detector.detect_from_path("main.spl").unwrap()

        expect result.language == "simple"
        expect result.confidence == 1.0

    it "detects Rust from .rs extension":
        let detector = detect.LanguageDetector.new()

        let result = detector.detect_from_path("lib.rs").unwrap()

        expect result.language == "rust"
        expect result.confidence == 1.0

    it "detects Python from .py extension":
        let detector = detect.LanguageDetector.new()

        let result = detector.detect_from_path("script.py").unwrap()

        expect result.language == "python"
        expect result.confidence == 1.0

    it "detects JavaScript from .js extension":
        let detector = detect.LanguageDetector.new()

        let result = detector.detect_from_path("app.js").unwrap()

        expect result.language == "javascript"
        expect result.confidence == 1.0

    it "detects TypeScript from .ts extension":
        let detector = detect.LanguageDetector.new()

        let result = detector.detect_from_path("app.ts").unwrap()

        expect result.language == "typescript"
        expect result.confidence == 1.0

    it "detects Go from .go extension":
        let detector = detect.LanguageDetector.new()

        let result = detector.detect_from_path("main.go").unwrap()

        expect result.language == "go"
        expect result.confidence == 1.0

    it "detects C from .c extension":
        let detector = detect.LanguageDetector.new()

        let result = detector.detect_from_path("main.c").unwrap()

        expect result.language == "c"
        expect result.confidence == 1.0

    it "detects C++ from .cpp extension":
        let detector = detect.LanguageDetector.new()

        let result = detector.detect_from_path("main.cpp").unwrap()

        expect result.language == "cpp"
        expect result.confidence == 1.0

    it "detects Ruby from .rb extension":
        let detector = detect.LanguageDetector.new()

        let result = detector.detect_from_path("app.rb").unwrap()

        expect result.language == "ruby"
        expect result.confidence == 1.0

    it "detects Erlang from .erl extension":
        let detector = detect.LanguageDetector.new()

        let result = detector.detect_from_path("server.erl").unwrap()

        expect result.language == "erlang"
        expect result.confidence == 1.0

    it "handles files with path":
        let detector = detect.LanguageDetector.new()

        let result = detector.detect_from_path("/path/to/file.spl").unwrap()

        expect result.language == "simple"

    it "returns None for unknown extension":
        let detector = detect.LanguageDetector.new()

        let result = detector.detect_from_path("file.xyz")

        expect(result.is_none()).to_be(true)

    it "returns None for no extension":
        let detector = detect.LanguageDetector.new()

        let result = detector.detect_from_path("README")

        expect(result.is_none()).to_be(true)

describe "Shebang-based detection":
    it "detects Python from python shebang":
        let detector = detect.LanguageDetector.new()

        let result = detector.detect_from_shebang("#!/usr/bin/env python3").unwrap()

        expect result.language == "python"
        expect result.confidence == 0.9

    it "detects Ruby from ruby shebang":
        let detector = detect.LanguageDetector.new()

        let result = detector.detect_from_shebang("#!/usr/bin/ruby").unwrap()

        expect result.language == "ruby"

    it "detects Bash from bash shebang":
        let detector = detect.LanguageDetector.new()

        let result = detector.detect_from_shebang("#!/bin/bash").unwrap()

        expect result.language == "bash"

    it "detects Node.js from node shebang":
        let detector = detect.LanguageDetector.new()

        let result = detector.detect_from_shebang("#!/usr/bin/env node").unwrap()

        expect result.language == "javascript"

    it "returns None for non-shebang line":
        let detector = detect.LanguageDetector.new()

        let result = detector.detect_from_shebang("# This is a comment")

        expect(result.is_none()).to_be(true)

describe "Content-based detection":
    it "detects Simple from content":
        let detector = detect.LanguageDetector.new()

        let content = """
fn main():
    import core.io
    print("Hello")
"""

        let result = detector.detect_from_content(content).unwrap()

        expect result.language == "simple"
        expect result.confidence > 0.0

    it "detects Rust from content":
        let detector = detect.LanguageDetector.new()

        let content = """
fn main() {
    println!("Hello");
}

impl MyStruct {
    pub fn new() -> Self {
        MyStruct {}
    }
}
"""

        let result = detector.detect_from_content(content).unwrap()

        expect result.language == "rust"

    it "detects Python from content":
        let detector = detect.LanguageDetector.new()

        let content = """
import os

def main():
    print("Hello")
    return 0
"""

        let result = detector.detect_from_content(content).unwrap()

        expect result.language == "python"

    it "detects Go from content":
        let detector = detect.LanguageDetector.new()

        let content = """
package main

func main() {
    fmt.Println("Hello")
}
"""

        let result = detector.detect_from_content(content).unwrap()

        expect result.language == "go"

    it "detects JavaScript from content":
        let detector = detect.LanguageDetector.new()

        let content = """
const greet = () => {
    console.log("Hello");
};

function main() {
    greet();
}
"""

        let result = detector.detect_from_content(content).unwrap()

        expect result.language == "javascript"

    it "detects C++ from content":
        let detector = detect.LanguageDetector.new()

        let content = """
#include <iostream>

namespace myapp {
    int main() {
        std::cout << "Hello" << std::endl;
    }
}
"""

        let result = detector.detect_from_content(content).unwrap()

        expect result.language == "cpp"

    it "detects C from content":
        let detector = detect.LanguageDetector.new()

        let content = """
#include <stdio.h>

int main() {
    printf("Hello\\n");
    return 0;
}
"""

        let result = detector.detect_from_content(content).unwrap()

        expect result.language == "c"

    it "detects from shebang in content":
        let detector = detect.LanguageDetector.new()

        let content = """#!/usr/bin/env python3
import sys

def main():
    print("Hello")
"""

        let result = detector.detect_from_content(content).unwrap()

        expect result.language == "python"
        expect result.confidence == 0.9

describe "Multi-strategy detection":
    it "uses path when available":
        let detector = detect.LanguageDetector.new()

        let result = detector.detect(Some("test.spl"), None).unwrap()

        expect result.language == "simple"
        expect result.confidence == 1.0

    it "uses content when path unavailable":
        let detector = detect.LanguageDetector.new()

        let content = "fn main():\n    import core.io"
        let result = detector.detect(None, Some(content)).unwrap()

        expect result.language == "simple"

    it "prefers path over content":
        let detector = detect.LanguageDetector.new()

        # Path says .py, content looks like Simple
        let content = "fn main():\n    import core.io"
        let result = detector.detect(Some("test.py"), Some(content)).unwrap()

        # Should use path (higher confidence)
        expect result.language == "python"
        expect result.confidence == 1.0

    it "returns None when no detection possible":
        let detector = detect.LanguageDetector.new()

        let result = detector.detect(None, None)

        expect(result.is_none()).to_be(true)

describe "Custom mappings":
    it "adds custom extension":
        let mut detector = detect.LanguageDetector.new()

        detector.add_extension(".custom", "mylang")

        let result = detector.detect_from_path("test.custom").unwrap()

        expect result.language == "mylang"

    it "adds custom shebang pattern":
        let mut detector = detect.LanguageDetector.new()

        detector.add_shebang_pattern("mylang", "mylang")

        let result = detector.detect_from_shebang("#!/usr/bin/mylang").unwrap()

        expect result.language == "mylang"

describe "Supported languages":
    it "gets list of supported languages":
        let detector = detect.LanguageDetector.new()

        let languages = detector.get_supported_languages()

        expect languages.len() > 0
        expect(languages.contains("simple")).to_be(true)
        expect(languages.contains("rust")).to_be(true)
        expect(languages.contains("python")).to_be(true)

    it "checks if language is supported":
        let detector = detect.LanguageDetector.new()

        expect(detector.is_supported("simple")).to_be(true)
        expect(detector.is_supported("rust")).to_be(true)
        expect(detector.is_supported("unknown")).to_be(false)

describe "Convenience functions":
    it "detects from path":
        let language = detect.detect_language_from_path("test.spl").unwrap()

        expect language == "simple"

    it "detects from content":
        let content = "fn main():\n    import core.io"
        let language = detect.detect_language_from_content(content).unwrap()

        expect language == "simple"

    it "detects with all info":
        let language = detect.detect_language(Some("test.spl"), None).unwrap()

        expect language == "simple"

    it "gets supported languages":
        let languages = detect.get_supported_languages()

        expect languages.len() > 0
        expect(languages.contains("simple")).to_be(true)

describe "Edge cases":
    it "handles empty content":
        let detector = detect.LanguageDetector.new()

        let result = detector.detect_from_content("")

        expect(result.is_none()).to_be(true)

    it "handles single-line content":
        let detector = detect.LanguageDetector.new()

        let result = detector.detect_from_content("fn main(): pass")

        # May or may not detect, but shouldn't crash
        # Just verify it returns a valid Option
        match result:
            case Some(r):
                expect r.confidence > 0.0
            case None:
                pass

    it "handles file with multiple extensions":
        let detector = detect.LanguageDetector.new()

        let result = detector.detect_from_path("test.min.js").unwrap()

        expect result.language == "javascript"

describe "Integration":
    it "detects language for complete workflow":
        let detector = detect.LanguageDetector.new()

        # Scenario: User opens a file
        let file_path = "examples/hello.spl"
        let file_content = """
# Simple program
import core.io

fn main():
    io.println("Hello, World!")
"""

        # Detect language
        let result = detector.detect(Some(file_path), Some(file_content)).unwrap()

        expect result.language == "simple"
        expect result.confidence == 1.0  # High confidence from extension

        # Verify language is supported
        expect(detector.is_supported(result.language)).to_be(true)
