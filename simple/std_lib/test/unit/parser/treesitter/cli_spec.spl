# Unit tests for Tree-sitter CLI tools

import spec.{describe, it, expect}
import parser.treesitter.cli as cli
import parser.treesitter.grammar_simple as simple_grammar

describe "CliResult":
    it "creates Success result":
        let result = cli.CliResult.Success("test message")

        match result:
            case Success(msg):
                expect msg == "test message"
            case _:
                expect(false).to_be(true)  # Should not reach here

    it "creates Error result":
        let result = cli.CliResult.Error("error message")

        match result:
            case Error(msg):
                expect msg == "error message"
            case _:
                expect(false).to_be(true)

    it "creates Help result":
        let result = cli.CliResult.Help

        match result:
            case Help:
                expect(true).to_be(true)
            case _:
                expect(false).to_be(true)

describe "Command parsing":
    it "parses parse command":
        let cli_tool = cli.TreeSitterCli.new()
        let args = ["ts-cli", "parse", "test.spl"]

        let cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Parse(path, lang, show_tree)):
                expect path == "test.spl"
                expect lang == None
                expect(show_tree).to_be(false)
            case _:
                expect(false).to_be(true)

    it "parses parse command with language option":
        let cli_tool = cli.TreeSitterCli.new()
        let args = ["ts-cli", "parse", "test.rs", "--language", "rust"]

        let cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Parse(path, lang, show_tree)):
                expect path == "test.rs"
                expect lang == Some("rust")
                expect(show_tree).to_be(false)
            case _:
                expect(false).to_be(true)

    it "parses parse command with tree flag":
        let cli_tool = cli.TreeSitterCli.new()
        let args = ["ts-cli", "parse", "test.spl", "--tree"]

        let cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Parse(path, lang, show_tree)):
                expect path == "test.spl"
                expect(show_tree).to_be(true)
            case _:
                expect(false).to_be(true)

    it "parses parse command with all options":
        let cli_tool = cli.TreeSitterCli.new()
        let args = ["ts-cli", "parse", "test.py", "-l", "python", "-t"]

        let cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Parse(path, lang, show_tree)):
                expect path == "test.py"
                expect lang == Some("python")
                expect(show_tree).to_be(true)
            case _:
                expect(false).to_be(true)

    it "parses query command":
        let cli_tool = cli.TreeSitterCli.new()
        let args = ["ts-cli", "query", "test.spl", "(function_def)"]

        let cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Query(path, query, lang)):
                expect path == "test.spl"
                expect query == "(function_def)"
                expect lang == None
            case _:
                expect(false).to_be(true)

    it "parses query command with language":
        let cli_tool = cli.TreeSitterCli.new()
        let args = ["ts-cli", "query", "test.rs", "(function_item)", "--language", "rust"]

        let cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Query(path, query, lang)):
                expect path == "test.rs"
                expect query == "(function_item)"
                expect lang == Some("rust")
            case _:
                expect(false).to_be(true)

    it "parses test command":
        let cli_tool = cli.TreeSitterCli.new()
        let args = ["ts-cli", "test", "grammar_tests.spl"]

        let cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Test(path)):
                expect path == "grammar_tests.spl"
            case _:
                expect(false).to_be(true)

    it "parses highlight command":
        let cli_tool = cli.TreeSitterCli.new()
        let args = ["ts-cli", "highlight", "example.spl"]

        let cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Highlight(path, lang)):
                expect path == "example.spl"
                expect lang == None
            case _:
                expect(false).to_be(true)

    it "parses highlight command with language":
        let cli_tool = cli.TreeSitterCli.new()
        let args = ["ts-cli", "highlight", "example.rs", "-l", "rust"]

        let cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Highlight(path, lang)):
                expect path == "example.rs"
                expect lang == Some("rust")
            case _:
                expect(false).to_be(true)

    it "parses validate command":
        let cli_tool = cli.TreeSitterCli.new()
        let args = ["ts-cli", "validate", "grammar.spl"]

        let cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Validate(path)):
                expect path == "grammar.spl"
            case _:
                expect(false).to_be(true)

    it "parses languages command":
        let cli_tool = cli.TreeSitterCli.new()
        let args = ["ts-cli", "languages"]

        let cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Languages):
                expect(true).to_be(true)
            case _:
                expect(false).to_be(true)

    it "parses help command":
        let cli_tool = cli.TreeSitterCli.new()
        let args = ["ts-cli", "help"]

        let cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Help):
                expect(true).to_be(true)
            case _:
                expect(false).to_be(true)

    it "parses --help flag":
        let cli_tool = cli.TreeSitterCli.new()
        let args = ["ts-cli", "--help"]

        let cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Help):
                expect(true).to_be(true)
            case _:
                expect(false).to_be(true)

    it "parses version command":
        let cli_tool = cli.TreeSitterCli.new()
        let args = ["ts-cli", "version"]

        let cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Version):
                expect(true).to_be(true)
            case _:
                expect(false).to_be(true)

    it "parses --version flag":
        let cli_tool = cli.TreeSitterCli.new()
        let args = ["ts-cli", "--version"]

        let cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Version):
                expect(true).to_be(true)
            case _:
                expect(false).to_be(true)

describe "Command parsing errors":
    it "errors on unknown command":
        let cli_tool = cli.TreeSitterCli.new()
        let args = ["ts-cli", "unknown"]

        let cmd = cli_tool.parse_command(args)

        match cmd:
            case Err(msg):
                expect "Unknown command" in msg
            case _:
                expect(false).to_be(true)

    it "errors on parse without file":
        let cli_tool = cli.TreeSitterCli.new()
        let args = ["ts-cli", "parse"]

        let cmd = cli_tool.parse_command(args)

        match cmd:
            case Err(msg):
                expect "Usage" in msg
            case _:
                expect(false).to_be(true)

    it "errors on query without file":
        let cli_tool = cli.TreeSitterCli.new()
        let args = ["ts-cli", "query"]

        let cmd = cli_tool.parse_command(args)

        match cmd:
            case Err(msg):
                expect "Usage" in msg
            case _:
                expect(false).to_be(true)

    it "errors on query without query string":
        let cli_tool = cli.TreeSitterCli.new()
        let args = ["ts-cli", "query", "test.spl"]

        let cmd = cli_tool.parse_command(args)

        match cmd:
            case Err(msg):
                expect "Usage" in msg
            case _:
                expect(false).to_be(true)

    it "errors on test without file":
        let cli_tool = cli.TreeSitterCli.new()
        let args = ["ts-cli", "test"]

        let cmd = cli_tool.parse_command(args)

        match cmd:
            case Err(msg):
                expect "Usage" in msg
            case _:
                expect(false).to_be(true)

    it "errors on unknown option":
        let cli_tool = cli.TreeSitterCli.new()
        let args = ["ts-cli", "parse", "test.spl", "--unknown"]

        let cmd = cli_tool.parse_command(args)

        match cmd:
            case Err(msg):
                expect "Unknown option" in msg
            case _:
                expect(false).to_be(true)

    it "errors on --language without argument":
        let cli_tool = cli.TreeSitterCli.new()
        let args = ["ts-cli", "parse", "test.spl", "--language"]

        let cmd = cli_tool.parse_command(args)

        match cmd:
            case Err(msg):
                expect "--language requires an argument" in msg
            case _:
                expect(false).to_be(true)

describe "TreeSitterCli":
    it "creates new CLI instance":
        let cli_tool = cli.TreeSitterCli.new()

        expect(cli_tool).to_not_be(None)

    it "shows help when no args":
        let cli_tool = cli.TreeSitterCli.new()
        let args = ["ts-cli"]

        let result = cli_tool.run(args)

        match result:
            case Help:
                expect(true).to_be(true)
            case _:
                expect(false).to_be(true)

    it "returns help result":
        let cli_tool = cli.TreeSitterCli.new()
        let result = cli_tool.print_help()

        match result:
            case Help:
                expect(true).to_be(true)
            case _:
                expect(false).to_be(true)

    it "returns version result":
        let cli_tool = cli.TreeSitterCli.new()
        let result = cli_tool.print_version()

        match result:
            case Success(msg):
                expect msg == "Version info displayed"
            case _:
                expect(false).to_be(true)

describe "Languages command":
    it "lists supported languages":
        let cli_tool = cli.TreeSitterCli.new()
        let result = cli_tool.cmd_languages()

        match result:
            case Success(msg):
                expect msg == "Language list complete"
            case _:
                expect(false).to_be(true)

describe "Convenience functions":
    it "parse_file returns tree on success":
        # This test would require a real file - skipped for unit tests
        expect(true).to_be(true)

    it "query_file returns cursor on success":
        # This test would require a real file - skipped for unit tests
        expect(true).to_be(true)
