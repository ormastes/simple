# File Find and Glob FFI Specification
# Tests for file searching and glob pattern matching

import spec.{describe, context, it, expect}
import shell.{file, dir}

describe("File Find and Glob FFI Functions"):
    context("file.find with patterns"):
        it("should find all files with wildcard"):
            # Create test directory
            dir.create("/tmp/simple_find_test", recursive: true)

            # Create test files
            file.write_text("/tmp/simple_find_test/file1.txt", "content1")
            file.write_text("/tmp/simple_find_test/file2.txt", "content2")
            file.write_text("/tmp/simple_find_test/file3.log", "content3")

            # Find all files
            val results = file.find("/tmp/simple_find_test", "*", recursive: false)
            expect(results.len()).to_equal(3)

            # Cleanup
            file.remove("/tmp/simple_find_test/file1.txt")
            file.remove("/tmp/simple_find_test/file2.txt")
            file.remove("/tmp/simple_find_test/file3.log")
            dir.remove("/tmp/simple_find_test", recursive: false)

        it("should find files by extension"):
            # Create test directory
            dir.create("/tmp/simple_ext_test", recursive: true)

            # Create test files
            file.write_text("/tmp/simple_ext_test/doc1.txt", "text")
            file.write_text("/tmp/simple_ext_test/doc2.txt", "text")
            file.write_text("/tmp/simple_ext_test/data.log", "log")

            # Find only .txt files
            val results = file.find("/tmp/simple_ext_test", "*.txt", recursive: false)
            expect(results.len()).to_equal(2)

            # Cleanup
            file.remove("/tmp/simple_ext_test/doc1.txt")
            file.remove("/tmp/simple_ext_test/doc2.txt")
            file.remove("/tmp/simple_ext_test/data.log")
            dir.remove("/tmp/simple_ext_test", recursive: false)

        it("should find files by prefix"):
            # Create test directory
            dir.create("/tmp/simple_prefix_test", recursive: true)

            # Create test files
            file.write_text("/tmp/simple_prefix_test/test_1.txt", "1")
            file.write_text("/tmp/simple_prefix_test/test_2.txt", "2")
            file.write_text("/tmp/simple_prefix_test/data.txt", "data")

            # Find files starting with "test"
            val results = file.find("/tmp/simple_prefix_test", "test*", recursive: false)
            expect(results.len()).to_equal(2)

            # Cleanup
            file.remove("/tmp/simple_prefix_test/test_1.txt")
            file.remove("/tmp/simple_prefix_test/test_2.txt")
            file.remove("/tmp/simple_prefix_test/data.txt")
            dir.remove("/tmp/simple_prefix_test", recursive: false)

        it("should find files recursively"):
            # Create nested directory structure
            dir.create("/tmp/simple_rec_test/sub1", recursive: true)
            dir.create("/tmp/simple_rec_test/sub2", recursive: true)

            # Create files at different levels
            file.write_text("/tmp/simple_rec_test/root.txt", "root")
            file.write_text("/tmp/simple_rec_test/sub1/file1.txt", "sub1")
            file.write_text("/tmp/simple_rec_test/sub2/file2.txt", "sub2")

            # Find all .txt files recursively
            val results = file.find("/tmp/simple_rec_test", "*.txt", recursive: true)
            expect(results.len()).to_equal(3)

            # Cleanup
            file.remove("/tmp/simple_rec_test/root.txt")
            file.remove("/tmp/simple_rec_test/sub1/file1.txt")
            file.remove("/tmp/simple_rec_test/sub2/file2.txt")
            dir.remove("/tmp/simple_rec_test/sub1", recursive: false)
            dir.remove("/tmp/simple_rec_test/sub2", recursive: false)
            dir.remove("/tmp/simple_rec_test", recursive: false)

    context("dir.glob"):
        it("should glob files in directory"):
            # Create test directory
            dir.create("/tmp/simple_glob_test", recursive: true)

            # Create test files
            file.write_text("/tmp/simple_glob_test/data1.csv", "csv1")
            file.write_text("/tmp/simple_glob_test/data2.csv", "csv2")
            file.write_text("/tmp/simple_glob_test/readme.txt", "txt")

            # Glob for CSV files
            val results = dir.glob("/tmp/simple_glob_test", "*.csv")
            expect(results.len()).to_equal(2)

            # Cleanup
            file.remove("/tmp/simple_glob_test/data1.csv")
            file.remove("/tmp/simple_glob_test/data2.csv")
            file.remove("/tmp/simple_glob_test/readme.txt")
            dir.remove("/tmp/simple_glob_test", recursive: false)

        it("should return empty list for no matches"):
            # Create test directory
            dir.create("/tmp/simple_nomatch_test", recursive: true)

            # Create test file
            file.write_text("/tmp/simple_nomatch_test/file.txt", "content")

            # Search for non-existent pattern
            val results = dir.glob("/tmp/simple_nomatch_test", "*.pdf")
            expect(results.len()).to_equal(0)

            # Cleanup
            file.remove("/tmp/simple_nomatch_test/file.txt")
            dir.remove("/tmp/simple_nomatch_test", recursive: false)

    context("edge cases"):
        it("should handle non-existent directory"):
            val results = file.find("/nonexistent/directory", "*", recursive: false)
            expect(results.len()).to_equal(0)

        it("should handle empty directory"):
            # Create empty directory
            dir.create("/tmp/simple_empty_test", recursive: true)

            val results = file.find("/tmp/simple_empty_test", "*", recursive: false)
            expect(results.len()).to_equal(0)

            # Cleanup
            dir.remove("/tmp/simple_empty_test", recursive: false)
