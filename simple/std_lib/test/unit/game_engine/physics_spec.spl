/// Physics Abstraction Tests
/// Tests for the cross-engine physics system

import std.spec
import game_engine.physics
import sys.ffi

describe "RigidBodyType":
    it "creates Dynamic rigid body":
        let body_type = RigidBodyType::Dynamic
        expect body_type is RigidBodyType::Dynamic

    it "creates Static rigid body":
        let body_type = RigidBodyType::Static
        expect body_type is RigidBodyType::Static

    it "creates Kinematic rigid body":
        let body_type = RigidBodyType::Kinematic
        expect body_type is RigidBodyType::Kinematic

describe "CollisionShape":
    it "creates Sphere shape":
        let shape = CollisionShape::Sphere(1.0)
        match shape:
            CollisionShape::Sphere(radius) =>
                expect radius == 1.0

    it "creates Box shape":
        let shape = CollisionShape::Box(2.0, 1.0, 3.0)
        match shape:
            CollisionShape::Box(x, y, z) =>
                expect x == 2.0
                expect y == 1.0
                expect z == 3.0

    it "creates Capsule shape":
        let shape = CollisionShape::Capsule(0.5, 2.0)
        match shape:
            CollisionShape::Capsule(radius, height) =>
                expect radius == 0.5
                expect height == 2.0

    it "creates Cylinder shape":
        let shape = CollisionShape::Cylinder(0.5, 2.0)
        match shape:
            CollisionShape::Cylinder(radius, height) =>
                expect radius == 0.5
                expect height == 2.0

    it "creates ConvexHull shape":
        let null_ptr: ffi.VoidPtr = 0 as ffi.VoidPtr
        let shape = CollisionShape::ConvexHull(null_ptr)
        expect shape is CollisionShape::ConvexHull

    it "creates TriangleMesh shape":
        let null_ptr: ffi.VoidPtr = 0 as ffi.VoidPtr
        let shape = CollisionShape::TriangleMesh(null_ptr)
        expect shape is CollisionShape::TriangleMesh

describe "RaycastHit":
    it "creates raycast hit with position":
        let null_ptr: ffi.VoidPtr = 0 as ffi.VoidPtr
        let hit = RaycastHit(
            collider_ptr: null_ptr,
            position: (10.0, 5.0, 20.0),
            normal: (0.0, 1.0, 0.0),
            distance: 15.5
        )
        let (x, y, z) = hit.position
        expect x == 10.0
        expect y == 5.0
        expect z == 20.0

    it "creates raycast hit with normal":
        let null_ptr: ffi.VoidPtr = 0 as ffi.VoidPtr
        let hit = RaycastHit(
            collider_ptr: null_ptr,
            position: (0.0, 0.0, 0.0),
            normal: (0.0, 1.0, 0.0),
            distance: 10.0
        )
        let (nx, ny, nz) = hit.normal
        expect nx == 0.0
        expect ny == 1.0
        expect nz == 0.0

    it "creates raycast hit with distance":
        let null_ptr: ffi.VoidPtr = 0 as ffi.VoidPtr
        let hit = RaycastHit(
            collider_ptr: null_ptr,
            position: (0.0, 0.0, 0.0),
            normal: (0.0, 1.0, 0.0),
            distance: 25.5
        )
        expect hit.distance == 25.5

describe "Physics Properties":
    it "sets mass":
        let mass = 10.0
        expect mass > 0.0

    it "sets friction":
        let friction = 0.5
        expect friction >= 0.0

    it "sets restitution (bounciness)":
        let restitution = 0.8
        expect restitution >= 0.0
        expect restitution <= 1.0

    it "sets linear damping":
        let damping = 0.1
        expect damping >= 0.0

    it "sets angular damping":
        let damping = 0.05
        expect damping >= 0.0

describe "Velocity and Forces":
    it "sets linear velocity":
        let vel = (5.0, 0.0, 10.0)
        let (vx, vy, vz) = vel
        expect vx == 5.0
        expect vz == 10.0

    it "sets angular velocity":
        let ang_vel = (0.0, 1.0, 0.0)
        let (wx, wy, wz) = ang_vel
        expect wy == 1.0

    it "applies central force":
        let force = (100.0, 0.0, 0.0)
        let (fx, fy, fz) = force
        expect fx == 100.0

    it "applies torque":
        let torque = (0.0, 50.0, 0.0)
        let (tx, ty, tz) = torque
        expect ty == 50.0

    it "applies impulse":
        let impulse = (20.0, 0.0, 0.0)
        let (ix, iy, iz) = impulse
        expect ix == 20.0

describe "Raycasting":
    it "raycasts with valid parameters":
        let origin = (0.0, 10.0, 0.0)
        let direction = (0.0, -1.0, 0.0)
        let max_distance = 100.0
        expect max_distance > 0.0

describe "Overlap Testing":
    it "tests sphere overlap":
        let center = (0.0, 0.0, 0.0)
        let radius = 5.0
        expect radius > 0.0

    it "tests box overlap":
        let center = (0.0, 0.0, 0.0)
        let half_extents = (2.0, 1.0, 3.0)
        let (x, y, z) = half_extents
        expect x == 2.0

describe "Collision Layers and Masks":
    it "sets collision layer":
        let layer = 1
        expect layer > 0

    it "sets collision mask":
        let mask = 3
        expect mask > 0

describe "Physics Simulation":
    it "steps simulation with delta time":
        let delta_time = 0.016
        expect delta_time > 0.0

    it "uses fixed timestep":
        let fixed_dt = 0.016
        expect fixed_dt == 0.016
