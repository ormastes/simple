/// SceneNode Abstraction Tests
/// Tests for the cross-engine scene graph abstraction

import std.spec
import game_engine.scene_node

describe "Transform3D":
    it "creates transform with default values":
        let transform = Transform3D(
            position: (0.0, 0.0, 0.0),
            rotation: (0.0, 0.0, 0.0),
            scale: (1.0, 1.0, 1.0)
        )

        let (x, y, z) = transform.position
        expect x == 0.0
        expect y == 0.0
        expect z == 0.0

    it "creates transform with custom position":
        let transform = Transform3D(
            position: (10.5, 20.3, 30.7),
            rotation: (0.0, 0.0, 0.0),
            scale: (1.0, 1.0, 1.0)
        )

        let (x, y, z) = transform.position
        expect x == 10.5
        expect y == 20.3
        expect z == 30.7

    it "creates transform with custom rotation":
        let transform = Transform3D(
            position: (0.0, 0.0, 0.0),
            rotation: (45.0, 90.0, 180.0),
            scale: (1.0, 1.0, 1.0)
        )

        let (rx, ry, rz) = transform.rotation
        expect rx == 45.0
        expect ry == 90.0
        expect rz == 180.0

    it "creates transform with custom scale":
        let transform = Transform3D(
            position: (0.0, 0.0, 0.0),
            rotation: (0.0, 0.0, 0.0),
            scale: (2.0, 3.0, 0.5)
        )

        let (sx, sy, sz) = transform.scale
        expect sx == 2.0
        expect sy == 3.0
        expect sz == 0.5

    it "creates identity transform":
        let identity = transform3d_identity()

        let (x, y, z) = identity.position
        expect x == 0.0
        expect y == 0.0
        expect z == 0.0

        let (sx, sy, sz) = identity.scale
        expect sx == 1.0
        expect sy == 1.0
        expect sz == 1.0

    it "creates translation transform":
        let trans = transform3d_translation(5.0, 10.0, 15.0)

        let (x, y, z) = trans.position
        expect x == 5.0
        expect y == 10.0
        expect z == 15.0

        let (sx, sy, sz) = trans.scale
        expect sx == 1.0
        expect sy == 1.0
        expect sz == 1.0

    it "creates rotation transform":
        let rot = transform3d_rotation(90.0, 0.0, 0.0)

        let (rx, ry, rz) = rot.rotation
        expect rx == 90.0
        expect ry == 0.0
        expect rz == 0.0

    it "creates scale transform":
        let scaled = transform3d_scale(2.0, 2.0, 2.0)

        let (sx, sy, sz) = scaled.scale
        expect sx == 2.0
        expect sy == 2.0
        expect sz == 2.0

describe "Transform3D Operations":
    it "composes transforms":
        let t1 = transform3d_translation(10.0, 0.0, 0.0)
        let t2 = transform3d_translation(5.0, 0.0, 0.0)

        let combined = transform3d_compose(t1, t2)
        let (x, y, z) = combined.position

        # Simple addition for translation
        expect x == 15.0

    it "calculates distance between positions":
        let pos1 = (0.0, 0.0, 0.0)
        let pos2 = (3.0, 4.0, 0.0)

        let dist = position_distance(pos1, pos2)

        # 3-4-5 triangle
        expect dist == 5.0

    it "interpolates positions":
        let pos1 = (0.0, 0.0, 0.0)
        let pos2 = (10.0, 20.0, 30.0)

        let mid = position_lerp(pos1, pos2, 0.5)
        let (x, y, z) = mid

        expect x == 5.0
        expect y == 10.0
        expect z == 15.0

describe "Transform3D Validation":
    it "validates non-zero scale":
        let valid = Transform3D(
            position: (0.0, 0.0, 0.0),
            rotation: (0.0, 0.0, 0.0),
            scale: (1.0, 1.0, 1.0)
        )

        expect transform3d_is_valid(valid) == true

    it "detects zero scale as invalid":
        let invalid = Transform3D(
            position: (0.0, 0.0, 0.0),
            rotation: (0.0, 0.0, 0.0),
            scale: (0.0, 1.0, 1.0)
        )

        expect transform3d_is_valid(invalid) == false

    it "validates finite values":
        let valid = Transform3D(
            position: (1.0, 2.0, 3.0),
            rotation: (45.0, 90.0, 180.0),
            scale: (1.0, 1.0, 1.0)
        )

        expect transform3d_is_valid(valid) == true
