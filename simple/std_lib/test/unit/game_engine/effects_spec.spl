/// Effect System Tests
/// Tests for async safety tracking and effect verification

import std.spec
import game_engine.effects

describe "GameEffect":
    it "creates RenderEffect":
        let effect = GameEffect::RenderEffect("draw_sprite")
        expect effect is GameEffect::RenderEffect

    it "creates PhysicsEffect":
        let effect = GameEffect::PhysicsEffect("apply_force")
        expect effect is GameEffect::PhysicsEffect

    it "creates AudioEffect":
        let effect = GameEffect::AudioEffect("play_sound")
        expect effect is GameEffect::AudioEffect

    it "creates IOEffect":
        let effect = GameEffect::IOEffect("load_asset")
        expect effect is GameEffect::IOEffect

    it "creates EngineSyncEffect":
        let effect = GameEffect::EngineSyncEffect("spawn_actor")
        expect effect is GameEffect::EngineSyncEffect

describe "EffectContext":
    it "creates empty context":
        let context = EffectContext::new()
        expect context.is_async_safe() == true
        expect context.get_active_effects().len() == 0

    it "adds effects to context":
        let mut context = EffectContext::new()
        context.add_effect(GameEffect::RenderEffect("draw"))

        expect context.has_effect("draw") == true
        expect context.get_active_effects().len() == 1

    it "marks context as not async-safe with sync effect":
        let mut context = EffectContext::new()
        context.add_effect(GameEffect::EngineSyncEffect("spawn"))

        expect context.is_async_safe() == false

    it "removes effects from context":
        let mut context = EffectContext::new()
        context.add_effect(GameEffect::RenderEffect("draw"))
        context.add_effect(GameEffect::AudioEffect("play"))

        context.remove_effect("draw")
        expect context.has_effect("draw") == false
        expect context.has_effect("play") == true

    it "tracks multiple effects":
        let mut context = EffectContext::new()
        context.add_effect(GameEffect::RenderEffect("draw1"))
        context.add_effect(GameEffect::RenderEffect("draw2"))
        context.add_effect(GameEffect::AudioEffect("play"))

        expect context.get_active_effects().len() == 3
        expect context.is_async_safe() == true

describe "EffectfulOperation":
    it "creates operation with effect":
        let op = EffectfulOperation::new("draw", GameEffect::RenderEffect("draw"))
        expect op.is_async_safe() == true

    it "creates non-async-safe operation":
        let op = EffectfulOperation::new("spawn", GameEffect::EngineSyncEffect("spawn"))
        expect op.is_async_safe() == false

    it "executes operation":
        let mut executed = false
        let op = EffectfulOperation::new("test", GameEffect::RenderEffect("test"))

        op.execute(fn():
            executed = true
        )

        expect executed == true

describe "AsyncSafeGuard":
    it "creates guard with no allowed effects":
        let guard = AsyncSafeGuard::new()
        expect guard.is_effect_allowed("anything") == false

    it "allows specific effects":
        let mut guard = AsyncSafeGuard::new()
        guard.allow_effect("draw")
        guard.allow_effect("play")

        expect guard.is_effect_allowed("draw") == true
        expect guard.is_effect_allowed("play") == true
        expect guard.is_effect_allowed("spawn") == false

    it "verifies context with allowed effects":
        let mut guard = AsyncSafeGuard::new()
        guard.allow_effect("draw")
        guard.allow_effect("play")

        let mut context = EffectContext::new()
        context.add_effect(GameEffect::RenderEffect("draw"))
        context.add_effect(GameEffect::AudioEffect("play"))

        expect guard.verify_context(context) == true

    it "rejects context with disallowed effects":
        let mut guard = AsyncSafeGuard::new()
        guard.allow_effect("draw")

        let mut context = EffectContext::new()
        context.add_effect(GameEffect::RenderEffect("draw"))
        context.add_effect(GameEffect::EngineSyncEffect("spawn"))

        expect guard.verify_context(context) == false

describe "Effect Combinators":
    it "runs operation with render effect":
        let mut executed = false

        with_render_effect("draw", fn():
            executed = true
        )

        expect executed == true

    it "runs operation with physics effect":
        let mut executed = false

        with_physics_effect("force", fn():
            executed = true
        )

        expect executed == true

    it "runs operation with audio effect":
        let mut executed = false

        with_audio_effect("play", fn():
            executed = true
        )

        expect executed == true

    it "runs operation with IO effect":
        let mut executed = false

        with_io_effect("load", fn():
            executed = true
        )

        expect executed == true

    it "runs operation with engine sync effect":
        let mut executed = false

        with_engine_sync_effect("spawn", fn():
            executed = true
        )

        expect executed == true

describe "Effect Composition":
    it "composes multiple render effects":
        let mut count = 0

        with_render_effect("draw1", fn():
            count = count + 1
        )

        with_render_effect("draw2", fn():
            count = count + 1
        )

        expect count == 2

    it "composes different effect types":
        let mut count = 0

        with_render_effect("draw", fn():
            count = count + 1
        )

        with_audio_effect("play", fn():
            count = count + 1
        )

        with_physics_effect("force", fn():
            count = count + 1
        )

        expect count == 3
