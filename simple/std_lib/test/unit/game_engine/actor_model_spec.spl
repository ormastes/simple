/// Actor Model Game Logic Tests
/// Tests for the actor model system for concurrent game entities

import std.spec
import game_engine.actor_model

describe "GameMessage":
    it "creates Update message with delta time":
        let msg = GameMessage::Update(0.016)
        expect msg.is_update() == true
        expect msg.get_delta() == 0.016

    it "creates Spawn message with position":
        let msg = GameMessage::Spawn((10.0, 20.0, 30.0))
        expect msg is GameMessage::Spawn

    it "creates SetPosition message":
        let msg = GameMessage::SetPosition((5.0, 10.0, 15.0))
        expect msg is GameMessage::SetPosition

    it "creates Damage message":
        let msg = GameMessage::Damage(25)
        expect msg is GameMessage::Damage

    it "creates Heal message":
        let msg = GameMessage::Heal(50)
        expect msg is GameMessage::Heal

describe "EntityActor":
    it "creates entity with default values":
        let null_ptr = 0
        let entity = EntityActor::new(1, null_ptr)
        expect entity.get_entity_id() == 1
        expect entity.is_alive() == true

    it "handles damage correctly":
        let null_ptr = 0
        let mut entity = EntityActor::new(1, null_ptr)

        # Apply damage
        entity.handle_message(GameMessage::Damage(30))
        expect entity.is_alive() == true

        # Apply fatal damage
        entity.handle_message(GameMessage::Damage(80))
        expect entity.is_alive() == false

    it "handles healing correctly":
        let null_ptr = 0
        let mut entity = EntityActor::new(1, null_ptr)

        # Damage first
        entity.handle_message(GameMessage::Damage(50))

        # Heal
        entity.handle_message(GameMessage::Heal(30))
        expect entity.is_alive() == true

    it "caps health at max_health":
        let null_ptr = 0
        let mut entity = EntityActor::new(1, null_ptr)

        # Try to heal beyond max
        entity.handle_message(GameMessage::Heal(200))
        expect entity.is_alive() == true

    it "responds to GetPosition message":
        let null_ptr = 0
        let mut entity = EntityActor::new(1, null_ptr)

        # Set position first
        entity.handle_message(GameMessage::SetPosition((5.0, 10.0, 15.0)))

        # Get position
        let response = entity.handle_message(GameMessage::GetPosition)
        expect response.is_some() == true

describe "EntityManager":
    it "creates manager with no entities":
        let manager = EntityManager::new()
        expect manager.get_entity_count() == 0

    it "spawns entities with unique IDs":
        let null_ptr = 0
        let mut manager = EntityManager::new()

        let id1 = manager.spawn_entity(null_ptr)
        let id2 = manager.spawn_entity(null_ptr)
        let id3 = manager.spawn_entity(null_ptr)

        expect id1 == 1
        expect id2 == 2
        expect id3 == 3
        expect manager.get_entity_count() == 3

    it "despawns entities":
        let null_ptr = 0
        let mut manager = EntityManager::new()

        let id1 = manager.spawn_entity(null_ptr)
        let id2 = manager.spawn_entity(null_ptr)

        manager.despawn_entity(id1)
        expect manager.get_entity_count() == 1

    it "sends messages to specific entities":
        let null_ptr = 0
        let mut manager = EntityManager::new()

        let id = manager.spawn_entity(null_ptr)

        # Send damage message
        let result = manager.send_message(id, GameMessage::Damage(25))
        expect result.is_none() == true

    it "broadcasts messages to all entities":
        let null_ptr = 0
        let mut manager = EntityManager::new()

        manager.spawn_entity(null_ptr)
        manager.spawn_entity(null_ptr)
        manager.spawn_entity(null_ptr)

        # Broadcast update
        manager.broadcast_message(GameMessage::Update(0.016))
        expect manager.get_entity_count() == 3

    it "updates all entities with delta time":
        let null_ptr = 0
        let mut manager = EntityManager::new()

        manager.spawn_entity(null_ptr)
        manager.spawn_entity(null_ptr)

        # Update all
        manager.update_all(0.016)
        expect manager.get_entity_count() == 2

describe "Global EntityManager":
    it "provides singleton instance":
        let manager1 = get_entity_manager()
        let manager2 = get_entity_manager()
        # Both should reference the same manager

    it "spawns entities through global functions":
        let null_ptr = 0
        let id = spawn_game_entity(null_ptr)
        expect id > 0

    it "sends messages through global functions":
        let null_ptr = 0
        let id = spawn_game_entity(null_ptr)

        let result = send_entity_message(id, GameMessage::Damage(10))
        # Should execute without error

    it "updates entities through global functions":
        let null_ptr = 0
        spawn_game_entity(null_ptr)
        spawn_game_entity(null_ptr)

        # Update all entities
        update_game_entities(0.016)
        # Should execute without error
