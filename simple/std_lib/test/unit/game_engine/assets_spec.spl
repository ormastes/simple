/// Asset Loading Abstraction Tests
/// Tests for the cross-engine asset system

import std.spec
import game_engine.assets
import sys.ffi

describe "AssetType":
    it "creates Texture asset type":
        let asset_type = AssetType::Texture
        expect asset_type is AssetType::Texture

    it "creates Mesh asset type":
        let asset_type = AssetType::Mesh
        expect asset_type is AssetType::Mesh

    it "creates Material asset type":
        let asset_type = AssetType::Material
        expect asset_type is AssetType::Material

    it "creates Audio asset type":
        let asset_type = AssetType::Audio
        expect asset_type is AssetType::Audio

    it "creates Scene asset type":
        let asset_type = AssetType::Scene
        expect asset_type is AssetType::Scene

    it "creates Script asset type":
        let asset_type = AssetType::Script
        expect asset_type is AssetType::Script

describe "AssetHandle":
    it "creates handle with path":
        let null_ptr: ffi.VoidPtr = 0 as ffi.VoidPtr
        let handle = AssetHandle::new("res://textures/player.png", null_ptr)
        expect handle.get_path() == "res://textures/player.png"

    it "tracks loading state":
        let null_ptr: ffi.VoidPtr = 0 as ffi.VoidPtr
        let handle = AssetHandle::new("res://mesh.obj", null_ptr)
        expect handle.is_loaded() == false

describe "Asset Reference Counting":
    it "increments reference count":
        let null_ptr: ffi.VoidPtr = 0 as ffi.VoidPtr
        let handle = AssetHandle::new("res://test.png", null_ptr)
        handle.add_ref()
        expect handle.get_ref_count() == 2

    it "decrements reference count":
        let null_ptr: ffi.VoidPtr = 0 as ffi.VoidPtr
        let handle = AssetHandle::new("res://test.png", null_ptr)
        handle.add_ref()
        handle.release()
        expect handle.get_ref_count() == 1

describe "Asset Path Resolution":
    it "resolves relative paths":
        let relative = "textures/player.png"
        let base = "res://assets/"
        expect relative.len() > 0
        expect base.len() > 0

    it "resolves absolute paths":
        let absolute = "res://textures/player.png"
        expect absolute.len() > 0

    it "handles file URLs":
        let file_url = "file:///home/user/asset.png"
        expect file_url.len() > 0

describe "Asset Loading Progress":
    it "tracks loading progress":
        let progress = 0.5
        expect progress >= 0.0
        expect progress <= 1.0

describe "Asset Preloading":
    it "preloads multiple assets":
        let paths = ["res://a.png", "res://b.png", "res://c.png"]
        expect paths.len() == 3

describe "Asset Type Detection":
    it "detects texture from extension":
        let path = "sprite.png"
        expect path.len() > 0

    it "detects mesh from extension":
        let path = "model.obj"
        expect path.len() > 0

    it "detects audio from extension":
        let path = "music.ogg"
        expect path.len() > 0

    it "detects scene from extension":
        let path = "level.tscn"
        expect path.len() > 0
