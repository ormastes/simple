# Configuration System Unit Tests

import config.Conf


# ============================================================================
# Test: Config Loading and Access
# ============================================================================

print("=" * 70)
print("CONFIG SYSTEM UNIT TESTS")
print("=" * 70)

let mut passed = 0
let mut failed = 0


# Test 1: Create config from dict
print("\n[Test 1] Create config from dict")
let config_dict = {
    "project": "test-project",
    "train": {
        "epochs": 10,
        "lr": 0.001
    }
}
let cfg = Conf.from_dict(config_dict)

if cfg.get("project") == "test-project":
    print("  ✓ PASS: Get top-level value")
    passed += 1
else:
    print("  ✗ FAIL: Get top-level value")
    failed += 1

if cfg.get("train.epochs") == 10:
    print("  ✓ PASS: Get nested value with dot notation")
    passed += 1
else:
    print("  ✗ FAIL: Get nested value")
    failed += 1


# Test 2: CLI dotlist parsing
print("\n[Test 2] CLI dotlist parsing")
let cli_args = ["train.epochs=20", "train.lr=0.005", "model.hidden=256"]
let cli_cfg = Conf.from_cli_dotlist(cli_args)

if cli_cfg.get("train.epochs") == 20:
    print("  ✓ PASS: Parse int from dotlist")
    passed += 1
else:
    print("  ✗ FAIL: Parse int from dotlist")
    failed += 1

if cli_cfg.get("train.lr") == 0.005:
    print("  ✓ PASS: Parse float from dotlist")
    passed += 1
else:
    print("  ✗ FAIL: Parse float from dotlist")
    failed += 1


# Test 3: Config merging
print("\n[Test 3] Config merging")
let base = Conf.from_dict({"a": 1, "b": {"c": 2, "d": 3}})
let overlay = Conf.from_dict({"b": {"d": 4, "e": 5}})
let merged = Conf.merge(base, overlay)

if merged.get("a") == 1:
    print("  ✓ PASS: Base value preserved")
    passed += 1
else:
    print("  ✗ FAIL: Base value preserved")
    failed += 1

if merged.get("b.c") == 2:
    print("  ✓ PASS: Nested value preserved")
    passed += 1
else:
    print("  ✗ FAIL: Nested value preserved")
    failed += 1

if merged.get("b.d") == 4:
    print("  ✓ PASS: Nested value overridden")
    passed += 1
else:
    print("  ✗ FAIL: Nested value overridden")
    failed += 1

if merged.get("b.e") == 5:
    print("  ✓ PASS: New nested value added")
    passed += 1
else:
    print("  ✗ FAIL: New nested value added")
    failed += 1


# Test 4: Freeze/unfreeze
print("\n[Test 4] Freeze/unfreeze")
let freezable = Conf.from_dict({"x": 1})

if not Conf.is_frozen(freezable):
    print("  ✓ PASS: Config not frozen initially")
    passed += 1
else:
    print("  ✗ FAIL: Config should not be frozen")
    failed += 1

Conf.freeze(freezable)

if Conf.is_frozen(freezable):
    print("  ✓ PASS: Config frozen")
    passed += 1
else:
    print("  ✗ FAIL: Config should be frozen")
    failed += 1

let unfrozen = Conf.unfreeze(freezable)

if not Conf.is_frozen(unfrozen):
    print("  ✓ PASS: Config unfrozen")
    passed += 1
else:
    print("  ✗ FAIL: Config should be unfrozen")
    failed += 1


# Test 5: Type coercion
print("\n[Test 5] Type coercion")
let type_tests = Conf.from_cli_dotlist([
    "bool_true=true",
    "bool_false=false",
    "int_val=42",
    "float_val=3.14",
    "string_val=hello"
])

if type_tests.get("bool_true") == true:
    print("  ✓ PASS: Parse boolean true")
    passed += 1
else:
    print("  ✗ FAIL: Parse boolean true")
    failed += 1

if type_tests.get("bool_false") == false:
    print("  ✓ PASS: Parse boolean false")
    passed += 1
else:
    print("  ✗ FAIL: Parse boolean false")
    failed += 1

if type_tests.get("int_val") == 42:
    print("  ✓ PASS: Parse integer")
    passed += 1
else:
    print("  ✗ FAIL: Parse integer")
    failed += 1

if type_tests.get("float_val") == 3.14:
    print("  ✓ PASS: Parse float")
    passed += 1
else:
    print("  ✗ FAIL: Parse float")
    failed += 1


# Summary
print("\n" + "=" * 70)
print("SUMMARY")
print("=" * 70)
print(f"Passed: {passed}")
print(f"Failed: {failed}")
print(f"Total:  {passed + failed}")

if failed == 0:
    print("\n✓ All tests passed!")
else:
    print(f"\n✗ {failed} test(s) failed")

print("=" * 70)
