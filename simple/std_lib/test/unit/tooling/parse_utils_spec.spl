# Tests for parse utilities

use tooling.parse_utils.*

# =====================================
# Integer Parsing Tests
# =====================================

fn test_parse_int_positive():
    match parse_int("123"):
        Some(n) =>
            assert(n == 123)
        None =>
            assert(false)

fn test_parse_int_negative():
    match parse_int("-456"):
        Some(n) =>
            assert(n == -456)
        None =>
            assert(false)

fn test_parse_int_zero():
    match parse_int("0"):
        Some(n) =>
            assert(n == 0)
        None =>
            assert(false)

fn test_parse_int_invalid():
    match parse_int("abc"):
        Some(_) =>
            assert(false)
        None =>
            assert(true)

    match parse_int("12.34"):
        Some(_) =>
            assert(false)
        None =>
            assert(true)

fn test_parse_int_empty():
    match parse_int(""):
        Some(_) =>
            assert(false)
        None =>
            assert(true)

# =====================================
# Boolean Parsing Tests
# =====================================

fn test_parse_bool_true_variants():
    match parse_bool("true"):
        Some(b) =>
            assert(b)
        None =>
            assert(false)

    match parse_bool("yes"):
        Some(b) =>
            assert(b)
        None =>
            assert(false)

    match parse_bool("1"):
        Some(b) =>
            assert(b)
        None =>
            assert(false)

fn test_parse_bool_false_variants():
    match parse_bool("false"):
        Some(b) =>
            assert(not b)
        None =>
            assert(false)

    match parse_bool("no"):
        Some(b) =>
            assert(not b)
        None =>
            assert(false)

    match parse_bool("0"):
        Some(b) =>
            assert(not b)
        None =>
            assert(false)

fn test_parse_bool_case_insensitive():
    match parse_bool("TRUE"):
        Some(b) =>
            assert(b)
        None =>
            assert(false)

    match parse_bool("False"):
        Some(b) =>
            assert(not b)
        None =>
            assert(false)

fn test_parse_bool_invalid():
    match parse_bool("maybe"):
        Some(_) =>
            assert(false)
        None =>
            assert(true)

# =====================================
# Key-Value Parsing Tests
# =====================================

fn test_parse_key_value():
    match parse_key_value("key=value", "="):
        Some((k, v)) =>
            assert(k == "key")
            assert(v == "value")
        None =>
            assert(false)

fn test_parse_key_value_with_spaces():
    match parse_key_value("  key  =  value  ", "="):
        Some((k, v)) =>
            assert(k == "key")
            assert(v == "value")
        None =>
            assert(false)

fn test_parse_key_value_no_separator():
    match parse_key_value("no separator here", "="):
        Some(_) =>
            assert(false)
        None =>
            assert(true)

fn test_parse_key_values():
    val text = "key1=value1\nkey2=value2\n# comment\nkey3=value3"
    val pairs = parse_key_values(text, "=")

    assert(pairs.len() == 3)
    assert(pairs[0] == ("key1", "value1"))
    assert(pairs[1] == ("key2", "value2"))
    assert(pairs[2] == ("key3", "value3"))

# =====================================
# CSV Parsing Tests
# =====================================

fn test_parse_csv_line():
    val items = parse_csv_line("apple,banana,cherry")
    assert(items.len() == 3)
    assert(items[0] == "apple")
    assert(items[1] == "banana")
    assert(items[2] == "cherry")

fn test_parse_csv_with_spaces():
    val items = parse_csv_line("  apple  ,  banana  ,  cherry  ")
    assert(items[0] == "apple")
    assert(items[1] == "banana")

fn test_parse_delimited():
    val items = parse_delimited("a|b|c", "|")
    assert(items.len() == 3)
    assert(items[0] == "a")
    assert(items[1] == "b")
    assert(items[2] == "c")

# =====================================
# Numbered List Parsing Tests
# =====================================

fn test_parse_numbered_list():
    val text = "1. First item\n2. Second item\n3. Third item"
    val items = parse_numbered_list(text)

    assert(items.len() == 3)
    assert(items[0] == "First item")
    assert(items[1] == "Second item")
    assert(items[2] == "Third item")

fn test_parse_numbered_list_with_blanks():
    val text = "1. First\n\n2. Second\n  \n3. Third"
    val items = parse_numbered_list(text)

    assert(items.len() == 3)

# =====================================
# Bulleted List Parsing Tests
# =====================================

fn test_parse_bulleted_list_dash():
    val text = "- First item\n- Second item\n- Third item"
    val items = parse_bulleted_list(text)

    assert(items.len() == 3)
    assert(items[0] == "First item")
    assert(items[1] == "Second item")

fn test_parse_bulleted_list_asterisk():
    val text = "* First item\n* Second item"
    val items = parse_bulleted_list(text)

    assert(items.len() == 2)

fn test_parse_bulleted_list_bullet():
    val text = "• First item\n• Second item"
    val items = parse_bulleted_list(text)

    assert(items.len() == 2)

# =====================================
# Query String Parsing Tests
# =====================================

fn test_parse_query_string():
    val params = parse_query_string("?key1=value1&key2=value2")

    assert(params.len() == 2)
    assert(params[0] == ("key1", "value1"))
    assert(params[1] == ("key2", "value2"))

fn test_parse_query_string_no_question_mark():
    val params = parse_query_string("key1=value1&key2=value2")
    assert(params.len() == 2)

# =====================================
# Extension Extraction Tests
# =====================================

fn test_extract_extension():
    match extract_extension("file.txt"):
        Some(ext) =>
            assert(ext == "txt")
        None =>
            assert(false)

fn test_extract_extension_multiple_dots():
    match extract_extension("archive.tar.gz"):
        Some(ext) =>
            assert(ext == "gz")
        None =>
            assert(false)

fn test_extract_extension_no_extension():
    match extract_extension("README"):
        Some(_) =>
            assert(false)
        None =>
            assert(true)

fn test_extract_extension_ends_with_dot():
    match extract_extension("file."):
        Some(_) =>
            assert(false)
        None =>
            assert(true)

# =====================================
# Version Parsing Tests
# =====================================

fn test_parse_version():
    match parse_version("1.2.3"):
        Some(v) =>
            assert(v.major == 1)
            assert(v.minor == 2)
            assert(v.patch == 3)
        None =>
            assert(false)

fn test_parse_version_invalid():
    match parse_version("1.2"):
        Some(_) =>
            assert(false)
        None =>
            assert(true)

    match parse_version("1.2.3.4"):
        Some(_) =>
            assert(false)
        None =>
            assert(true)

    match parse_version("a.b.c"):
        Some(_) =>
            assert(false)
        None =>
            assert(true)

fn test_compare_versions_major():
    match parse_version("2.0.0"):
        Some(v1) =>
            match parse_version("1.9.9"):
                Some(v2) =>
                    assert(compare_versions(v1, v2) > 0)
                None =>
                    assert(false)
        None =>
            assert(false)

fn test_compare_versions_minor():
    match parse_version("1.5.0"):
        Some(v1) =>
            match parse_version("1.3.9"):
                Some(v2) =>
                    assert(compare_versions(v1, v2) > 0)
                None =>
                    assert(false)
        None =>
            assert(false)

fn test_compare_versions_patch():
    match parse_version("1.2.5"):
        Some(v1) =>
            match parse_version("1.2.3"):
                Some(v2) =>
                    assert(compare_versions(v1, v2) > 0)
                None =>
                    assert(false)
        None =>
            assert(false)

fn test_compare_versions_equal():
    match parse_version("1.2.3"):
        Some(v1) =>
            match parse_version("1.2.3"):
                Some(v2) =>
                    assert(compare_versions(v1, v2) == 0)
                None =>
                    assert(false)
        None =>
            assert(false)

# =====================================
# Memory Size Parsing Tests
# =====================================

fn test_parse_memory_size_bytes():
    match parse_memory_size("512B"):
        Some(size) =>
            assert(size == 512)
        None =>
            assert(false)

fn test_parse_memory_size_kb():
    match parse_memory_size("2KB"):
        Some(size) =>
            assert(size == 2 * 1024)
        None =>
            assert(false)

fn test_parse_memory_size_mb():
    match parse_memory_size("16MB"):
        Some(size) =>
            assert(size == 16 * 1024 * 1024)
        None =>
            assert(false)

fn test_parse_memory_size_gb():
    match parse_memory_size("1GB"):
        Some(size) =>
            assert(size == 1 * 1024 * 1024 * 1024)
        None =>
            assert(false)

fn test_parse_memory_size_short_units():
    match parse_memory_size("512K"):
        Some(size) =>
            assert(size == 512 * 1024)
        None =>
            assert(false)

fn test_parse_memory_size_invalid():
    match parse_memory_size("invalid"):
        Some(_) =>
            assert(false)
        None =>
            assert(true)

# =====================================
# Duration Parsing Tests
# =====================================

fn test_parse_duration_seconds():
    match parse_duration_seconds("30s"):
        Some(secs) =>
            assert(secs == 30)
        None =>
            assert(false)

fn test_parse_duration_minutes():
    match parse_duration_seconds("5m"):
        Some(secs) =>
            assert(secs == 5 * 60)
        None =>
            assert(false)

fn test_parse_duration_hours():
    match parse_duration_seconds("2h"):
        Some(secs) =>
            assert(secs == 2 * 3600)
        None =>
            assert(false)

fn test_parse_duration_days():
    match parse_duration_seconds("1d"):
        Some(secs) =>
            assert(secs == 86400)
        None =>
            assert(false)

fn test_parse_duration_long_units():
    match parse_duration_seconds("30sec"):
        Some(secs) =>
            assert(secs == 30)
        None =>
            assert(false)

fn test_parse_duration_invalid():
    match parse_duration_seconds("invalid"):
        Some(_) =>
            assert(false)
        None =>
            assert(true)

# =====================================
# Command Line Flag Tests
# =====================================

fn test_is_flag():
    assert(is_flag("--verbose"))
    assert(is_flag("-v"))
    assert(not is_flag("file.txt"))

fn test_parse_flag_name():
    assert(parse_flag_name("--verbose") == "verbose")
    assert(parse_flag_name("-v") == "v")
    assert(parse_flag_name("---triple") == "triple")

fn test_parse_flag_with_value():
    match parse_flag_with_value("--port=8080"):
        Some((name, value)) =>
            assert(name == "port")
            assert(value == "8080")
        None =>
            assert(false)

fn test_parse_flag_with_value_short():
    match parse_flag_with_value("-p=8080"):
        Some((name, value)) =>
            assert(name == "p")
            assert(value == "8080")
        None =>
            assert(false)

fn test_parse_flag_with_value_not_flag():
    match parse_flag_with_value("notaflag=value"):
        Some(_) =>
            assert(false)
        None =>
            assert(true)

fn test_split_args():
    val args = ["--verbose", "file.txt", "-o", "output.txt", "--debug"]
    val (flags, positional) = split_args(args)

    assert(flags.len() == 3)
    assert(flags[0] == "--verbose")
    assert(flags[1] == "-o")
    assert(flags[2] == "--debug")

    assert(positional.len() == 2)
    assert(positional[0] == "file.txt")
    assert(positional[1] == "output.txt")
