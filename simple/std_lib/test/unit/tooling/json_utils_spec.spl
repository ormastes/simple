# Tests for JSON utilities

use tooling.json_utils.*

# =====================================
# JSON Value Formatting Tests
# =====================================

fn test_json_string_simple():
    assert(json_string("hello") == "\"hello\"")

fn test_json_string_with_quotes():
    val result = json_string("She said \"hi\"")
    assert(result.contains("\\\""))

fn test_json_string_with_newline():
    val result = json_string("line1\nline2")
    assert(result.contains("\\n"))

fn test_json_number():
    assert(json_number(42) == "42")
    assert(json_number(-10) == "-10")

fn test_json_bool():
    assert(json_bool(true) == "true")
    assert(json_bool(false) == "false")

fn test_json_null():
    assert(json_null() == "null")

# =====================================
# JSON Array Tests
# =====================================

fn test_json_array_strings():
    val result = json_array_strings(["apple", "banana", "cherry"])
    assert(result.contains("["))
    assert(result.contains("]"))
    assert(result.contains("\"apple\""))
    assert(result.contains("\"banana\""))

fn test_json_array_numbers():
    val result = json_array_numbers([1, 2, 3])
    assert(result == "[1, 2, 3]")

fn test_json_array_mixed():
    val items = [json_string("text"), json_number(42), json_bool(true)]
    val result = json_array(items)
    assert(result.contains("\"text\""))
    assert(result.contains("42"))
    assert(result.contains("true"))

# =====================================
# JSON Object Tests
# =====================================

fn test_json_pair():
    val result = json_pair("name", json_string("Alice"))
    assert(result.contains("\"name\""))
    assert(result.contains("\"Alice\""))

fn test_json_object():
    val pairs = [
        ("name", json_string("Alice")),
        ("age", json_number(30))
    ]
    val result = json_object(pairs)

    assert(result.contains('{'))
    assert(result.contains('}'))
    assert(result.contains("\"name\""))
    assert(result.contains("\"Alice\""))
    assert(result.contains("\"age\""))
    assert(result.contains("30"))

# =====================================
# JSON Builder Tests
# =====================================

fn test_json_builder_basic():
    var builder = JsonBuilder.new()
    builder.add_string("name", "Bob")
    builder.add_number("age", 25)
    builder.add_bool("active", true)

    val result = builder.build()

    assert(result.contains("\"name\""))
    assert(result.contains("\"Bob\""))
    assert(result.contains("\"age\""))
    assert(result.contains("25"))
    assert(result.contains("\"active\""))
    assert(result.contains("true"))

fn test_json_builder_with_null():
    var builder = JsonBuilder.new()
    builder.add_string("name", "Test")
    builder.add_null("data")

    val result = builder.build()
    assert(result.contains("null"))

fn test_json_builder_with_array():
    var builder = JsonBuilder.new()
    val items = [json_string("a"), json_string("b")]
    builder.add_array("items", items)

    val result = builder.build()
    assert(result.contains("\"items\""))
    assert(result.contains("["))

# =====================================
# JSON Array Builder Tests
# =====================================

fn test_json_array_builder():
    var builder = JsonArrayBuilder.new()
    builder.add_string("apple")
    builder.add_number(42)
    builder.add_bool(true)
    builder.add_null()

    val result = builder.build()

    assert(result.contains("\"apple\""))
    assert(result.contains("42"))
    assert(result.contains("true"))
    assert(result.contains("null"))

# =====================================
# Common Structure Tests
# =====================================

fn test_json_success():
    val result = json_success("Operation completed")
    assert(result.contains("\"status\""))
    assert(result.contains("\"success\""))
    assert(result.contains("\"message\""))

fn test_json_error():
    val result = json_error("Not found", 404)
    assert(result.contains("\"status\""))
    assert(result.contains("\"error\""))
    assert(result.contains("\"code\""))
    assert(result.contains("404"))

fn test_json_data():
    val data = json_object([("id", json_number(1))])
    val result = json_data(data)
    assert(result.contains("\"status\""))
    assert(result.contains("\"data\""))

# =====================================
# Validation Tests
# =====================================

fn test_looks_like_json_object():
    assert(looks_like_json('{"key": "value"}'))
    assert(not looks_like_json("not json"))

fn test_looks_like_json_array():
    assert(looks_like_json("[1, 2, 3]"))
    assert(not looks_like_json("plain text"))

fn test_looks_like_json_empty():
    assert(not looks_like_json(""))

fn test_has_balanced_braces_valid():
    assert(has_balanced_braces('{"a": [1, 2]}'))

fn test_has_balanced_braces_invalid():
    assert(not has_balanced_braces('{"a": [1, 2}'))
    assert(not has_balanced_braces('{"a": 1]]'))

# =====================================
# Common Pattern Tests
# =====================================

fn test_api_response_with_data():
    val data = json_string("result")
    val result = api_response(true, "Success", Some(data))

    assert(result.contains("\"success\""))
    assert(result.contains("true"))
    assert(result.contains("\"data\""))

fn test_api_response_without_data():
    val result = api_response(false, "Failed", None)

    assert(result.contains("\"success\""))
    assert(result.contains("false"))
    assert(result.contains("null"))

fn test_pagination_meta():
    val result = pagination_meta(2, 10, 45)

    assert(result.contains("\"page\""))
    assert(result.contains("2"))
    assert(result.contains("\"total\""))
    assert(result.contains("45"))
    assert(result.contains("\"total_pages\""))
    assert(result.contains("5"))  # 45 / 10 = 5 pages

fn test_timestamp_json():
    val result = timestamp_json(1640000000, "2021-12-20T12:00:00Z")

    assert(result.contains("\"unix\""))
    assert(result.contains("1640000000"))
    assert(result.contains("\"iso\""))
    assert(result.contains("2021-12-20"))

# =====================================
# Edge Case Tests
# =====================================

fn test_json_string_escape_backslash():
    val result = json_string("path\\to\\file")
    assert(result.contains("\\\\"))

fn test_json_object_empty():
    val result = json_object([])
    assert(result == '{}')

fn test_json_array_empty():
    val result = json_array([])
    assert(result == "[]")

fn test_nested_objects():
    var inner = JsonBuilder.new()
    inner.add_string("city", "NYC")

    var outer = JsonBuilder.new()
    outer.add_string("name", "Alice")
    outer.add_raw("address", inner.build())

    val result = outer.build()
    assert(result.contains("\"name\""))
    assert(result.contains("\"address\""))
    assert(result.contains("\"city\""))
