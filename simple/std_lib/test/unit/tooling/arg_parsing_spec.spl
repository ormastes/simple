# Unit tests for argument parsing utilities
# Migrated from: src/driver/src/cli/commands/arg_parsing.rs

import tooling.arg_parsing.{GlobalFlags, filter_internal_flags, parse_lang_flag}

describe "GlobalFlags parsing":
    describe "parses gc_log and debug_mode flags":
        val args = ["simple", "--gc-log", "--debug"]
        val flags = GlobalFlags.parse(args)

        it "sets gc_log to true":
            expect flags.gc_log == true

        it "sets debug_mode to true":
            expect flags.debug_mode == true

        it "sets gc_off to false":
            expect flags.gc_off == false

    describe "parses gc_off flag":
        it "recognizes lowercase --gc=off":
            val args = ["simple", "--gc=off"]
            val flags = GlobalFlags.parse(args)
            expect flags.gc_off == true

        it "recognizes uppercase --gc=OFF":
            val args = ["simple", "--gc=OFF"]
            val flags = GlobalFlags.parse(args)
            expect flags.gc_off == true

    describe "parses other flags":
        val args = ["simple", "--macro-trace", "--notui"]
        val flags = GlobalFlags.parse(args)

        it "sets macro_trace to true":
            expect flags.macro_trace == true

        it "sets use_notui to true":
            expect flags.use_notui == true

describe "filter_internal_flags":
    describe "removes single flags":
        val args = ["test.spl", "--gc-log", "--notui", "arg1"]
        val filtered = filter_internal_flags(args)

        it "keeps only user arguments":
            expect filtered.len() == 2
            expect filtered[0] == "test.spl"
            expect filtered[1] == "arg1"

    describe "removes flags with values":
        val args = ["test.spl", "--gc-log", "--time-limit", "60", "arg1"]
        val filtered = filter_internal_flags(args)

        it "removes both flag and value":
            expect filtered.len() == 2
            expect filtered[0] == "test.spl"
            expect filtered[1] == "arg1"

    describe "handles mixed flags":
        val args = [
            "test.spl",
            "--gc-log",
            "--time-limit",
            "60",
            "--debug",
            "arg1",
            "arg2"
        ]
        val filtered = filter_internal_flags(args)

        it "filters correctly":
            expect filtered.len() == 3
            expect filtered[0] == "test.spl"
            expect filtered[1] == "arg1"
            expect filtered[2] == "arg2"

describe "parse_lang_flag":
    describe "sets environment variable":
        val args = ["test.spl", "--lang", "ko", "arg1"]
        parse_lang_flag(args)

        it "does not crash":
            expect true == true
