# Tests for format utilities

use tooling.format_utils.*

# =====================================
# Table Formatting Tests
# =====================================

fn test_create_table():
    val table = create_table(["Name", "Age", "City"])
    assert(table.headers.len() == 3)
    assert(table.rows.len() == 0)
    assert(table.column_widths.len() == 3)

fn test_add_row():
    var table = create_table(["Name", "Age"])
    table = add_row(table, ["Alice", "30"])
    table = add_row(table, ["Bob", "25"])

    assert(table.rows.len() == 2)
    assert(table.rows[0].cells[0] == "Alice")
    assert(table.rows[1].cells[0] == "Bob")

fn test_add_row_updates_widths():
    var table = create_table(["ID", "Name"])
    table = add_row(table, ["1", "Alice"])
    table = add_row(table, ["2", "VeryLongName"])

    # Width should expand for "VeryLongName"
    assert(table.column_widths[1] >= 12)

fn test_format_table():
    var table = create_table(["Name", "Age"])
    table = add_row(table, ["Alice", "30"])
    table = add_row(table, ["Bob", "25"])

    val output = format_table(table)

    # Should contain borders and data
    assert(output.contains("+"))
    assert(output.contains("|"))
    assert(output.contains("Name"))
    assert(output.contains("Alice"))
    assert(output.contains("Bob"))

# =====================================
# Progress Bar Tests
# =====================================

fn test_progress_bar_empty():
    val bar = progress_bar(0, 100, 20)
    assert(bar.contains("["))
    assert(bar.contains("]"))
    assert(bar.contains("0%"))

fn test_progress_bar_half():
    val bar = progress_bar(50, 100, 20)
    assert(bar.contains("50%"))

fn test_progress_bar_full():
    val bar = progress_bar(100, 100, 20)
    assert(bar.contains("100%"))

fn test_progress_bar_zero_total():
    val bar = progress_bar(0, 0, 20)
    # Should handle division by zero gracefully
    assert(bar.contains("["))

# =====================================
# Spinner Tests
# =====================================

fn test_spinner_frame():
    assert(spinner_frame(0) == "|")
    assert(spinner_frame(1) == "/")
    assert(spinner_frame(2) == "-")
    assert(spinner_frame(3) == "\\")

fn test_spinner_frame_wraps():
    # Frame 4 should wrap back to frame 0
    assert(spinner_frame(4) == "|")
    assert(spinner_frame(5) == "/")

# =====================================
# Indentation Tests
# =====================================

fn test_indent_text_single_line():
    val result = indent_text("Hello", 4)
    assert(result == "    Hello")

fn test_indent_text_multiple_lines():
    val result = indent_text("Line1\nLine2\nLine3", 2)
    assert(result.contains("  Line1"))
    assert(result.contains("  Line2"))
    assert(result.contains("  Line3"))

fn test_indent_text_zero_spaces():
    val result = indent_text("Hello", 0)
    assert(result == "Hello")

# =====================================
# Box Text Tests
# =====================================

fn test_box_text_single():
    val result = box_text("Hello", "single")
    assert(result.contains("┌"))
    assert(result.contains("┐"))
    assert(result.contains("└"))
    assert(result.contains("┘"))
    assert(result.contains("Hello"))

fn test_box_text_double():
    val result = box_text("Test", "double")
    assert(result.contains("╔"))
    assert(result.contains("╗"))
    assert(result.contains("╚"))
    assert(result.contains("╝"))

fn test_box_text_rounded():
    val result = box_text("Test", "rounded")
    assert(result.contains("╭"))
    assert(result.contains("╮"))
    assert(result.contains("╰"))
    assert(result.contains("╯"))

fn test_box_text_ascii():
    val result = box_text("Test", "ascii")
    assert(result.contains("+"))
    assert(result.contains("-"))
    assert(result.contains("|"))

fn test_box_text_multiline():
    val result = box_text("Line1\nLine2", "single")
    assert(result.contains("Line1"))
    assert(result.contains("Line2"))

# =====================================
# Tree Formatting Tests
# =====================================

fn test_format_tree_single_node():
    val node = TreeNode(label: "Root", children: [])
    val result = format_tree(node, "", true)
    assert(result.contains("Root"))
    assert(result.contains("└──"))

fn test_format_tree_with_children():
    val child1 = TreeNode(label: "Child1", children: [])
    val child2 = TreeNode(label: "Child2", children: [])
    val root = TreeNode(label: "Root", children: [child1, child2])

    val result = format_tree(root, "", true)
    assert(result.contains("Root"))
    assert(result.contains("Child1"))
    assert(result.contains("Child2"))
    assert(result.contains("├──"))
    assert(result.contains("└──"))

# =====================================
# ANSI Color Tests
# =====================================

fn test_ansi_color_red():
    val result = ansi_color("Error", "red")
    # Just verify it contains the text and doesn't crash
    assert(result.contains("Error"))

fn test_ansi_color_green():
    val result = ansi_color("Success", "green")
    assert(result.contains("Success"))

fn test_ansi_color_invalid():
    val result = ansi_color("Text", "invalid")
    # Should fallback to default and not crash
    assert(result.contains("Text"))

# =====================================
# ANSI Style Tests
# =====================================

fn test_ansi_style_bold():
    val result = ansi_style("Bold", "bold")
    assert(result.contains("Bold"))

fn test_ansi_style_underline():
    val result = ansi_style("Underlined", "underline")
    assert(result.contains("Underlined"))

fn test_ansi_style_italic():
    val result = ansi_style("Italic", "italic")
    assert(result.contains("Italic"))

# =====================================
# Styled Text Tests
# =====================================

fn test_styled_text():
    val result = styled_text("Important", "red", "bold")
    # Verify the text is included
    assert(result.contains("Important"))

# =====================================
# Number Formatting Tests
# =====================================

fn test_format_number_small():
    assert(format_number(123, ",") == "123")

fn test_format_number_thousands():
    assert(format_number(1234, ",") == "1,234")

fn test_format_number_millions():
    assert(format_number(1234567, ",") == "1,234,567")

fn test_format_number_custom_separator():
    assert(format_number(1234567, ".") == "1.234.567")

fn test_format_number_zero():
    assert(format_number(0, ",") == "0")

# =====================================
# Byte Formatting Tests
# =====================================

fn test_format_bytes_small():
    val result = format_bytes(512)
    assert(result.contains("512"))
    assert(result.contains("B"))

fn test_format_bytes_kb():
    val result = format_bytes(2048)
    assert(result.contains("2"))
    assert(result.contains("KB"))

fn test_format_bytes_mb():
    val result = format_bytes(2 * 1024 * 1024)
    assert(result.contains("2"))
    assert(result.contains("MB"))

fn test_format_bytes_gb():
    val result = format_bytes(2 * 1024 * 1024 * 1024)
    assert(result.contains("2"))
    assert(result.contains("GB"))

# =====================================
# Duration Formatting Tests
# =====================================

fn test_format_duration_ms_milliseconds():
    val result = format_duration_ms(500)
    assert(result == "500ms")

fn test_format_duration_ms_seconds():
    val result = format_duration_ms(5000)
    assert(result.contains("5"))
    assert(result.contains("s"))

fn test_format_duration_ms_minutes():
    val result = format_duration_ms(125000)  # 125 seconds = 2m 5s
    assert(result.contains("m"))
    assert(result.contains("s"))

fn test_format_duration_ms_hours():
    val result = format_duration_ms(7200000)  # 2 hours
    assert(result.contains("h"))
    assert(result.contains("m"))
