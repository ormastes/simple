# Dependency Graph Generator Specification
# Tool for auto-generating .__init__.spl files with dependency analysis

import std.spec

describe "Dependency Graph Generator":
    """
    Tool for auto-generating import statements and analyzing
    external dependencies. Outputs to .__init__.spl files (dot-prefixed).

    Key features:
    - Scans directories for .spl files
    - Extracts imports from each file
    - Identifies external dependencies (outside module tree)
    - Enforces child blocking unless parent re-exports
    - Uses AOP for logging all operations
    """

    context "Directory Scanning":
        it "finds all .spl files in directory":
            # scanner.scan_directory("./test_dir", recursive=false)
            # should return list of .spl files in directory
            let files = ["module1.spl", "module2.spl", "helper.spl"]
            expect files.len() == 3

        it "excludes .__init__.spl from scan":
            # Dot-prefixed files are generated, not source
            let files = ["module1.spl", ".__init__.spl", "module2.spl"]
            let filtered = files.filter(fn(f): not f.starts_with("."))
            expect filtered.len() == 2

        it "excludes __init__.spl from module list":
            # __init__.spl is manifest, not a module
            let files = ["module1.spl", "__init__.spl", "module2.spl"]
            let modules = files.filter(fn(f): f != "__init__.spl")
            expect modules.len() == 2

        it "identifies child directories with __init__.spl":
            # Directories with __init__.spl are child modules
            let has_init = true
            expect has_init == true

        it "skips directories without __init__.spl":
            # Directories without __init__.spl are not modules
            let has_init = false
            expect has_init == false

    context "Import Extraction":
        it "extracts use statements":
            let source = "use std.io\nuse core.json"
            let imports = ["std.io", "core.json"]
            expect imports.len() == 2

        it "extracts export use statements":
            let source = "export use router.Router"
            let exports = ["router.Router"]
            expect exports.len() == 1

        it "extracts common use statements":
            let source = "common use core.prelude.*"
            let common = ["core.prelude.*"]
            expect common.len() == 1

        it "extracts glob imports":
            let source = "use std.collections.*"
            let imports = ["std.collections.*"]
            expect imports[0].ends_with(".*")

        it "extracts grouped imports":
            let source = "use std.{io, fs, net}"
            let imports = ["std.io", "std.fs", "std.net"]
            expect imports.len() == 3

        it "extracts aliased imports":
            let source = "use std.collections as col"
            let imports = [("std.collections", "col")]
            expect imports.len() == 1

    context "External Dependency Detection":
        it "identifies imports outside module tree":
            let module_path = "myapp.server"
            let import_path = "std.io"
            let is_external = not import_path.starts_with("myapp.")
            expect is_external == true

        it "marks stdlib imports as external":
            let import_path = "std.collections"
            let is_stdlib = import_path.starts_with("std.")
            expect is_stdlib == true

        it "marks core imports as external":
            let import_path = "core.json"
            let is_core = import_path.starts_with("core.")
            expect is_core == true

        it "identifies internal imports":
            let module_path = "myapp.server"
            let import_path = "myapp.utils"
            let is_internal = import_path.starts_with("myapp.")
            expect is_internal == true

        it "identifies sibling imports":
            let module_path = "myapp.server.handler"
            let import_path = "myapp.server.router"
            let is_sibling = true  # Same parent
            expect is_sibling == true

    context "Child Blocking Rules":
        it "blocks child exports unless parent has pub mod":
            # Child module cannot export unless parent declares: pub mod child
            let parent_has_pub_mod = false
            let child_can_export = parent_has_pub_mod
            expect child_can_export == false

        it "allows child exports when parent has pub mod":
            let parent_has_pub_mod = true
            let child_can_export = parent_has_pub_mod
            expect child_can_export == true

        it "blocks symbols not in parent export use":
            # Even with pub mod, symbol must be in export use
            let parent_has_pub_mod = true
            let in_export_list = false
            let symbol_visible = parent_has_pub_mod and in_export_list
            expect symbol_visible == false

        it "allows symbols in parent export use":
            let parent_has_pub_mod = true
            let in_export_list = true
            let symbol_visible = parent_has_pub_mod and in_export_list
            expect symbol_visible == true

        it "glob export includes non-macro public items":
            # export use child.* includes all pub non-macro items
            let has_glob_export = true
            let is_macro = false
            let is_public = true
            let visible = has_glob_export and is_public and not is_macro
            expect visible == true

        it "glob export excludes macros unless auto import":
            let has_glob_export = true
            let is_macro = true
            let in_auto_import = false
            let visible = has_glob_export and is_macro and in_auto_import
            expect visible == false

    context ".__init__.spl Generation":
        it "generates dot-prefixed file":
            let output_name = ".__init__.spl"
            expect output_name.starts_with(".")

        it "includes header comment":
            let header = "# Auto-generated dependency analysis"
            expect header.starts_with("#")

        it "includes external dependency list":
            let externals = ["std.io", "core.json"]
            let comments = externals.map(fn(e): "# external: " + e)
            expect comments.len() == 2

        it "includes child module declarations":
            let children = ["scanner", "parser", "analyzer"]
            let mods = children.map(fn(c): "mod " + c)
            expect mods.len() == 3

        it "includes pub mod for public children":
            let public_children = ["api", "types"]
            let pub_mods = public_children.map(fn(c): "pub mod " + c)
            expect pub_mods[0] == "pub mod api"

        it "includes export use statements":
            let exports = ["scanner.scan_directory", "analyzer.analyze"]
            let export_stmts = exports.map(fn(e): "export use " + e)
            expect export_stmts.len() == 2

        it "preserves existing manual exports":
            # If __init__.spl exists with manual exports, preserve them
            let manual_exports = ["special.CustomType"]
            expect manual_exports.len() == 1

    context "Recursive Mode":
        it "processes subdirectories when recursive=true":
            let recursive = true
            let process_children = recursive
            expect process_children == true

        it "skips subdirectories when recursive=false":
            let recursive = false
            let process_children = recursive
            expect process_children == false

        it "generates .__init__.spl for each directory":
            let dirs = ["src/", "src/api/", "src/utils/"]
            let generated = dirs.map(fn(d): d + ".__init__.spl")
            expect generated.len() == 3

    context "AOP Logging":
        it "logs directory scan start":
            let log_msg = "[SCAN] Starting scan: ./src"
            expect log_msg.contains("[SCAN]")

        it "logs each file processed":
            let log_msg = "[FILE] Processing: module.spl"
            expect log_msg.contains("[FILE]")

        it "logs external dependencies found":
            let log_msg = "[DEP] External: std.io"
            expect log_msg.contains("[DEP]")

        it "logs child modules found":
            let log_msg = "[MOD] Child: utils"
            expect log_msg.contains("[MOD]")

        it "logs generation complete":
            let log_msg = "[GEN] Generated: .__init__.spl"
            expect log_msg.contains("[GEN]")

    context "CLI Interface":
        it "accepts directory argument":
            let args = ["simple_depgraph", "./src"]
            expect args.len() >= 2

        it "accepts --recursive flag":
            let args = ["simple_depgraph", "./src", "--recursive"]
            let has_recursive = args.contains("--recursive")
            expect has_recursive == true

        it "accepts --verbose flag for detailed logging":
            let args = ["simple_depgraph", "./src", "--verbose"]
            let has_verbose = args.contains("--verbose")
            expect has_verbose == true

        it "shows usage on no arguments":
            let args = ["simple_depgraph"]
            let show_usage = args.len() < 2
            expect show_usage == true

        it "returns exit code 0 on success":
            let exit_code = 0
            expect exit_code == 0

        it "returns exit code 1 on error":
            let exit_code = 1
            expect exit_code == 1

    context "Error Handling":
        it "reports file read errors":
            let error = "Failed to read: module.spl"
            expect error.contains("Failed to read")

        it "reports directory not found":
            let error = "Directory not found: ./nonexistent"
            expect error.contains("not found")

        it "reports parse errors":
            let error = "Parse error in module.spl:10"
            expect error.contains("Parse error")

        it "continues on non-fatal errors":
            let continue_on_error = true
            expect continue_on_error == true
