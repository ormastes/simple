# Tests for color utilities

use tooling.color_utils.*

# =====================================
# RGB Construction Tests
# =====================================

fn test_rgb_new():
    val color = RGB.new(255, 128, 0)
    assert(color.r == 255)
    assert(color.g == 128)
    assert(color.b == 0)

fn test_rgb_black():
    val black = RGB.black()
    assert(black.r == 0)
    assert(black.g == 0)
    assert(black.b == 0)

fn test_rgb_white():
    val white = RGB.white()
    assert(white.r == 255)
    assert(white.g == 255)
    assert(white.b == 255)

# =====================================
# HSL Construction Tests
# =====================================

fn test_hsl_new():
    val color = HSL.new(180.0, 50.0, 50.0)
    assert(color.h == 180.0)
    assert(color.s == 50.0)
    assert(color.l == 50.0)

# =====================================
# Hex Conversion Tests
# =====================================

fn test_rgb_to_hex():
    val red = RGB.new(255, 0, 0)
    assert(red.to_hex() == "#ff0000")

    val green = RGB.new(0, 255, 0)
    assert(green.to_hex() == "#00ff00")

    val blue = RGB.new(0, 0, 255)
    assert(blue.to_hex() == "#0000ff")

fn test_rgb_from_hex():
    match RGB.from_hex("#ff0000"):
        Some(color) =>
            assert(color.r == 255)
            assert(color.g == 0)
            assert(color.b == 0)
        None =>
            assert(false)  # Should not fail

    match RGB.from_hex("#00ff00"):
        Some(color) =>
            assert(color.r == 0)
            assert(color.g == 255)
            assert(color.b == 0)
        None =>
            assert(false)

fn test_rgb_from_hex_invalid():
    match RGB.from_hex("invalid"):
        Some(_) =>
            assert(false)  # Should fail
        None =>
            assert(true)

    match RGB.from_hex("#gg0000"):
        Some(_) =>
            assert(false)
        None =>
            assert(true)

# =====================================
# RGB/HSL Conversion Tests
# =====================================

fn test_rgb_to_hsl_red():
    val red = RGB.new(255, 0, 0)
    val hsl = rgb_to_hsl(red)
    # Red: H=0, S=100, L=50
    assert(hsl.h < 1.0)  # Close to 0
    assert(hsl.s > 99.0)  # Close to 100
    assert(hsl.l > 49.0 and hsl.l < 51.0)  # Close to 50

fn test_rgb_to_hsl_gray():
    val gray = RGB.new(128, 128, 128)
    val hsl = rgb_to_hsl(gray)
    # Gray: S=0
    assert(hsl.s < 1.0)  # Saturation should be near 0

fn test_hsl_to_rgb_round_trip():
    val original = RGB.new(200, 100, 50)
    val hsl = rgb_to_hsl(original)
    val converted = hsl_to_rgb(hsl)

    # Allow small rounding errors
    assert((original.r - converted.r).abs() <= 1)
    assert((original.g - converted.g).abs() <= 1)
    assert((original.b - converted.b).abs() <= 1)

# =====================================
# Color Manipulation Tests
# =====================================

fn test_lighten():
    val base = RGB.new(100, 100, 100)
    val lighter = lighten(base, 20.0)

    # Should be lighter than original
    assert(lighter.r > base.r)
    assert(lighter.g > base.g)
    assert(lighter.b > base.b)

fn test_darken():
    val base = RGB.new(200, 200, 200)
    val darker = darken(base, 20.0)

    # Should be darker than original
    assert(darker.r < base.r)
    assert(darker.g < base.g)
    assert(darker.b < base.b)

fn test_saturate():
    val base = RGB.new(150, 100, 100)
    val saturated = saturate(base, 20.0)

    # After saturation, color should be more vibrant
    # (Implementation-dependent, just check it doesn't crash)
    assert(saturated.r >= 0 and saturated.r <= 255)

fn test_desaturate():
    val base = RGB.new(200, 100, 100)
    val desaturated = desaturate(base, 20.0)

    # Should move towards gray
    assert(desaturated.r >= 0 and desaturated.r <= 255)

# =====================================
# Color Schemes Tests
# =====================================

fn test_complementary_scheme():
    val base = RGB.new(255, 0, 0)  # Red
    val complement = complementary_scheme(base)

    # Complement of red should be cyan-ish
    assert(complement.r < base.r)
    assert(complement.g > 0)
    assert(complement.b > 0)

fn test_triadic_scheme():
    val base = RGB.new(255, 0, 0)  # Red
    val (c1, c2, c3) = triadic_scheme(base)

    # All colors should be valid
    assert(c1.r >= 0 and c1.r <= 255)
    assert(c2.r >= 0 and c2.r <= 255)
    assert(c3.r >= 0 and c3.r <= 255)

# =====================================
# WCAG Luminance Tests
# =====================================

fn test_relative_luminance_black():
    val black = RGB.black()
    val lum = relative_luminance(black)
    assert(lum < 0.01)  # Should be very close to 0

fn test_relative_luminance_white():
    val white = RGB.white()
    val lum = relative_luminance(white)
    assert(lum > 0.99)  # Should be very close to 1

# =====================================
# WCAG Contrast Tests
# =====================================

fn test_contrast_ratio_black_white():
    val black = RGB.black()
    val white = RGB.white()
    val ratio = contrast_ratio(black, white)

    # Black on white should be 21:1
    assert(ratio > 20.0)

fn test_contrast_ratio_same_color():
    val color = RGB.new(128, 128, 128)
    val ratio = contrast_ratio(color, color)

    # Same color should be 1:1
    assert(ratio < 1.1 and ratio > 0.9)

fn test_meets_wcag_aa():
    val black = RGB.black()
    val white = RGB.white()

    # Black on white should meet AA
    assert(meets_wcag_aa(black, white))

    # Similar colors should fail
    val gray1 = RGB.new(128, 128, 128)
    val gray2 = RGB.new(130, 130, 130)
    assert(not meets_wcag_aa(gray1, gray2))

fn test_meets_wcag_aaa():
    val black = RGB.black()
    val white = RGB.white()

    # Black on white should meet AAA
    assert(meets_wcag_aaa(black, white))

# =====================================
# Named Colors Tests
# =====================================

fn test_named_color_red():
    match named_color("red"):
        Some(color) =>
            assert(color.r == 255)
            assert(color.g == 0)
            assert(color.b == 0)
        None =>
            assert(false)

fn test_named_color_invalid():
    match named_color("notacolor"):
        Some(_) =>
            assert(false)
        None =>
            assert(true)

# =====================================
# Utility Tests
# =====================================

fn test_invert():
    val red = RGB.new(255, 0, 0)
    val inverted = invert(red)

    assert(inverted.r == 0)
    assert(inverted.g == 255)
    assert(inverted.b == 255)

fn test_grayscale():
    val color = RGB.new(200, 100, 50)
    val gray = grayscale(color)

    # Grayscale should have equal RGB values
    assert(gray.r == gray.g)
    assert(gray.g == gray.b)
