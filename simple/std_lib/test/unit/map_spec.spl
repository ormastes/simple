# Map Type Specification
# Tests for Map<K, V> hash map implementation

import std.spec
import map

describe "Map<K, V>":
    context "Construction":
        it "creates empty map with new()":
            val m = Map.new()
            expect m.len() == 0
            expect m.is_empty()

        it "creates map with custom capacity":
            val m = Map.with_capacity(32)
            expect m.len() == 0
            expect m.is_empty()

    context "Basic operations":
        it "inserts and retrieves value":
            val m = Map.new()
            m.insert("name", "Alice")

            match m.get("name"):
                Some(v): expect v == "Alice"
                None: fail "Expected value to exist"

        it "returns None for non-existent key":
            val m = Map.new()
            match m.get("missing"):
                Some(_): fail "Expected None"
                None: pass

        it "updates existing key":
            val m = Map.new()
            m.insert("count", 1)
            m.insert("count", 2)

            match m.get("count"):
                Some(v): expect v == 2
                None: fail "Expected value"

        it "contains_key returns true for existing keys":
            val m = Map.new()
            m.insert("key", "value")
            expect m.contains_key("key")

        it "contains_key returns false for missing keys":
            val m = Map.new()
            expect not m.contains_key("missing")

        it "len increases with insertions":
            val m = Map.new()
            expect m.len() == 0

            m.insert("a", 1)
            expect m.len() == 1

            m.insert("b", 2)
            expect m.len() == 2

        it "len does not increase for updates":
            val m = Map.new()
            m.insert("key", 1)
            expect m.len() == 1

            m.insert("key", 2)
            expect m.len() == 1

    context "Removal":
        it "removes existing key":
            val m = Map.new()
            m.insert("key", "value")

            match m.remove("key"):
                Some(v): expect v == "value"
                None: fail "Expected removed value"

            expect m.len() == 0

        it "returns None when removing non-existent key":
            val m = Map.new()
            match m.remove("missing"):
                Some(_): fail "Expected None"
                None: pass

        it "len decreases after removal":
            val m = Map.new()
            m.insert("a", 1)
            m.insert("b", 2)
            expect m.len() == 2

            m.remove("a")
            expect m.len() == 1

    context "Clear":
        it "removes all entries":
            val m = Map.new()
            m.insert("a", 1)
            m.insert("b", 2)
            m.insert("c", 3)

            m.clear()
            expect m.len() == 0
            expect m.is_empty()
            expect not m.contains_key("a")

    context "Keys, values, entries":
        it "keys returns all keys":
            val m = Map.new()
            m.insert("a", 1)
            m.insert("b", 2)
            m.insert("c", 3)

            val keys = m.keys()
            expect keys.len() == 3
            expect keys.contains("a")
            expect keys.contains("b")
            expect keys.contains("c")

        it "values returns all values":
            val m = Map.new()
            m.insert("a", 1)
            m.insert("b", 2)
            m.insert("c", 3)

            val values = m.values()
            expect values.len() == 3
            expect values.contains(1)
            expect values.contains(2)
            expect values.contains(3)

        it "entries returns all key-value pairs":
            val m = Map.new()
            m.insert("a", 1)
            m.insert("b", 2)

            val entries = m.entries()
            expect entries.len() == 2

            # Check that entries contains expected pairs
            var found_a = false
            var found_b = false
            for (k, v) in entries:
                if k == "a" and v == 1:
                    found_a = true
                if k == "b" and v == 2:
                    found_b = true

            expect found_a
            expect found_b

        it "empty map returns empty lists":
            val m = Map.new()
            expect m.keys().len() == 0
            expect m.values().len() == 0
            expect m.entries().len() == 0

    context "Multiple entries":
        it "handles many insertions":
            val m = Map.new()
            for i in 0..100:
                m.insert("key{i}", i)

            expect m.len() == 100

            match m.get("key50"):
                Some(v): expect v == 50
                None: fail "Expected value"

        it "handles insertions beyond initial capacity":
            val m = Map.with_capacity(4)  # Small capacity

            # Insert more than capacity
            for i in 0..20:
                m.insert("k{i}", i)

            expect m.len() == 20

            # All values should still be retrievable
            match m.get("k10"):
                Some(v): expect v == 10
                None: fail "Expected value after rehash"

    context "Different value types":
        it "stores integer values":
            val m = Map.new()
            m.insert("count", 42)
            match m.get("count"):
                Some(v): expect v == 42
                None: fail "Expected integer value"

        it "stores text values":
            val m = Map.new()
            m.insert("name", "Alice")
            match m.get("name"):
                Some(v): expect v == "Alice"
                None: fail "Expected text value"

        it "stores boolean values":
            val m = Map.new()
            m.insert("active", true)
            match m.get("active"):
                Some(v): expect v == true
                None: fail "Expected boolean value"

    context "Edge cases":
        it "handles empty string key":
            val m = Map.new()
            m.insert("", "empty key")
            match m.get(""):
                Some(v): expect v == "empty key"
                None: fail "Expected empty string key to work"

        it "handles similar keys":
            val m = Map.new()
            m.insert("test", 1)
            m.insert("test1", 2)
            m.insert("test2", 3)

            match m.get("test"):
                Some(v): expect v == 1
                None: fail "Expected value"

            match m.get("test1"):
                Some(v): expect v == 2
                None: fail "Expected value"

        it "is_empty works correctly":
            val m = Map.new()
            expect m.is_empty()

            m.insert("key", "value")
            expect not m.is_empty()

            m.remove("key")
            expect m.is_empty()

    context "Iteration":
        it "can iterate over entries":
            val m = Map.new()
            m.insert("a", 1)
            m.insert("b", 2)
            m.insert("c", 3)

            var sum = 0
            for (key, value) in m.entries():
                sum = sum + value

            expect sum == 6

        it "can iterate over keys":
            val m = Map.new()
            m.insert("a", 1)
            m.insert("b", 2)

            var count = 0
            for key in m.keys():
                count = count + 1

            expect count == 2

        it "can iterate over values":
            val m = Map.new()
            m.insert("a", 10)
            m.insert("b", 20)
            m.insert("c", 30)

            var total = 0
            for value in m.values():
                total = total + value

            expect total == 60

    context "map_from_entries helper":
        it "creates map from list of pairs":
            val entries = [
                ("name", "Alice"),
                ("city", "NYC"),
                ("country", "USA")
            ]

            val m = map_from_entries(entries)
            expect m.len() == 3

            match m.get("name"):
                Some(v): expect v == "Alice"
                None: fail "Expected value"

        it "handles empty list":
            val m = map_from_entries([])
            expect m.len() == 0
            expect m.is_empty()

        it "handles duplicate keys (last wins)":
            val entries = [
                ("key", "first"),
                ("key", "second")
            ]

            val m = map_from_entries(entries)
            expect m.len() == 1

            match m.get("key"):
                Some(v): expect v == "second"
                None: fail "Expected value"
