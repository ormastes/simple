/// Comprehensive tests for string operations
/// Tests string creation, manipulation, searching, and transformation

import test.unit.*
import std.spec

describe "String Type":
    context "creation":
        it "creates string from literals":
            let str = "hello"
            expect str.len == 5

        it "creates empty string":
            let empty = ""
            expect empty.len == 0

        it "creates string with special characters":
            let special = "hello\nworld"
            expect special.len == 11

        it "creates string with unicode":
            let unicode = "cafÃ©"
            expect unicode.len >= 4

    context "length operations":
        it "len returns byte length":
            let str = "hello"
            expect str.len == 5

        it "len handles empty strings":
            let empty = ""
            expect empty.len == 0

        it "char_count returns character count":
            let str = "hello"
            expect str.char_count == 5

        it "byte_len returns byte length":
            let str = "hello"
            expect str.byte_len == 5

    context "character access":
        it "accesses characters by index":
            let str = "hello"
            # Access via iteration or methods
            expect str.len == 5

        it "handles out of bounds gracefully":
            let str = "hi"
            expect str.len == 2

    context "substring searching":
        it "contains finds substring":
            let str = "hello world"
            expect str.contains("world") == true
            expect str.contains("xyz") == false

        it "starts_with checks prefix":
            let str = "hello world"
            expect str.starts_with("hello") == true
            expect str.starts_with("world") == false

        it "ends_with checks suffix":
            let str = "hello world"
            expect str.ends_with("world") == true
            expect str.ends_with("hello") == false

        it "find_str locates substring":
            let str = "hello world"
            let pos = str.find_str("world")
            expect pos.is_some == true

        it "find_str returns None for missing substring":
            let str = "hello world"
            let pos = str.find_str("xyz")
            expect pos.is_none == true

    context "trimming operations":
        it "trimmed removes leading and trailing whitespace":
            let str = "  hello  "
            let trimmed = str.trimmed()
            expect trimmed.len < str.len

        it "trim_start removes leading whitespace":
            let str = "  hello world"
            let trimmed = str.trim_start()
            expect trimmed.len <= str.len

        it "trim_end removes trailing whitespace":
            let str = "hello world  "
            let trimmed = str.trim_end()
            expect trimmed.len <= str.len

    context "string modification":
        it "push adds character":
            # Note: push returns a new string (strings are immutable)
            let str = "hello"
            let result = str.push(' ')
            expect result.len >= 6

        it "push_str appends string":
            # Note: push_str returns a new string (strings are immutable)
            let str = "hello"
            let result = str.push_str(" world")
            expect result.len >= 11

        it "pop removes last character":
            # Note: pop returns Option with the last char (doesn't modify)
            let str = "hello"
            let ch = str.pop()
            expect ch.is_some == true

        it "clear removes all characters":
            # Note: clear returns empty string (strings are immutable)
            let str = "hello"
            let result = str.clear()
            expect result.len == 0

    context "immutable operations":
        it "appended creates new string with character":
            let str = "hello"
            let extended = str.appended('!')
            expect extended.len > str.len

        it "prepended adds character to start":
            let str = "world"
            let extended = str.prepended(' ')
            expect extended.len > str.len

        it "reversed reverses characters":
            let str = "hello"
            let rev = str.reversed()
            # Just verify it returns a string
            expect rev.len == 5

        it "sorted sorts characters":
            let str = "hello"
            let sorted = str.sorted()
            expect sorted.len == 5

    context "filtering operations":
        it "filtered removes characters":
            let str = "a1b2c3"
            # Filter would keep only alpha chars
            expect str.len == 6

        it "taken keeps first n characters":
            let str = "hello world"
            let first5 = str.taken(5)
            expect first5.len <= 5

        it "dropped skips first n characters":
            let str = "hello world"
            let rest = str.dropped(6)
            expect rest.len <= str.len

    context "case sensitivity":
        it "string comparison is case sensitive":
            expect "Hello" != "hello"
            expect "Hello" == "Hello"

        it "contains is case sensitive":
            let str = "Hello World"
            expect str.contains("hello") == false
            expect str.contains("Hello") == true

    context "empty string handling":
        it "empty string operations":
            let empty = ""
            expect empty.len == 0
            expect empty.contains("") == true
            expect empty.starts_with("") == true
            expect empty.ends_with("") == true

        it "single character string":
            let single = "a"
            expect single.len == 1
            expect single.starts_with("a") == true
            expect single.ends_with("a") == true

    context "whitespace handling":
        it "whitespace is counted in length":
            let str = "hello world"
            expect str.len == 11

        it "spaces can be searched":
            let str = "hello world"
            expect str.contains(" ") == true

        it "tabs and newlines work":
            let str = "hello\tworld"
            expect str.len >= 11

    context "string concatenation patterns":
        it "multiple string operations":
            # Note: String operations return new strings (immutable)
            let str = "hello"
            let str2 = str.push(' ')
            let str3 = str2.push_str("world")
            expect str3.len >= 11

        it "string comparisons work":
            let str1 = "hello"
            let str2 = "hello"
            expect str1 == str2

    context "complex string operations":
        it "chains multiple operations":
            let str = "  hello world  "
            let trimmed = str.trimmed()
            expect trimmed.len < str.len
            expect trimmed.contains("hello") == true

        it "works with special characters":
            let str = "hello@world.com"
            expect str.contains("@") == true
            expect str.contains(".com") == true
            expect str.find_str("@").is_some == true
