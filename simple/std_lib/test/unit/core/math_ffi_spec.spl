# Math FFI Specification
# Tests for mathematical FFI functions

import spec.{describe, context, it, expect}

# Extern declarations for testing
extern fn rt_math_pow(base: Float, exp: Float) -> Float
extern fn rt_math_log(x: Float) -> Float
extern fn rt_math_log10(x: Float) -> Float
extern fn rt_math_log2(x: Float) -> Float
extern fn rt_math_exp(x: Float) -> Float
extern fn rt_math_sqrt(x: Float) -> Float
extern fn rt_math_cbrt(x: Float) -> Float
extern fn rt_math_sin(x: Float) -> Float
extern fn rt_math_cos(x: Float) -> Float
extern fn rt_math_tan(x: Float) -> Float
extern fn rt_math_abs(x: Float) -> Float
extern fn rt_math_floor(x: Float) -> Float
extern fn rt_math_ceil(x: Float) -> Float
extern fn rt_math_round(x: Float) -> Float

describe("Math FFI Functions"):
    context("power and exponential"):
        it("should calculate power correctly"):
            let result = rt_math_pow(2.0, 3.0)
            expect(result).to_equal(8.0)

        it("should handle fractional exponents"):
            let result = rt_math_pow(4.0, 0.5)
            expect(result).to_equal(2.0)

        it("should handle negative exponents"):
            let result = rt_math_pow(2.0, -1.0)
            expect(result).to_equal(0.5)

        it("should calculate exponential"):
            let result = rt_math_exp(0.0)
            expect(result).to_equal(1.0)

        it("should calculate e^1 approximately"):
            let result = rt_math_exp(1.0)
            expect(result).to_be_greater_than(2.71)
            expect(result).to_be_less_than(2.72)

    context("logarithms"):
        it("should calculate natural log"):
            let result = rt_math_log(2.718281828459045)  # e
            expect(result).to_be_greater_than(0.99)
            expect(result).to_be_less_than(1.01)

        it("should calculate log base 10"):
            let result = rt_math_log10(100.0)
            expect(result).to_equal(2.0)

        it("should calculate log base 2"):
            let result = rt_math_log2(8.0)
            expect(result).to_equal(3.0)

        it("should handle log(1) = 0"):
            expect(rt_math_log(1.0)).to_equal(0.0)
            expect(rt_math_log10(1.0)).to_equal(0.0)
            expect(rt_math_log2(1.0)).to_equal(0.0)

    context("roots"):
        it("should calculate square root"):
            let result = rt_math_sqrt(16.0)
            expect(result).to_equal(4.0)

        it("should calculate cube root"):
            let result = rt_math_cbrt(27.0)
            expect(result).to_equal(3.0)

        it("should handle sqrt(0)"):
            let result = rt_math_sqrt(0.0)
            expect(result).to_equal(0.0)

        it("should handle sqrt(1)"):
            let result = rt_math_sqrt(1.0)
            expect(result).to_equal(1.0)

    context("trigonometric"):
        it("should calculate sin(0)"):
            let result = rt_math_sin(0.0)
            expect(result).to_be_less_than(0.0001)

        it("should calculate cos(0)"):
            let result = rt_math_cos(0.0)
            expect(result).to_equal(1.0)

        it("should calculate tan(0)"):
            let result = rt_math_tan(0.0)
            expect(result).to_be_less_than(0.0001)

        it("should handle PI/2 for sin"):
            let pi_half = 1.5707963267948966
            let result = rt_math_sin(pi_half)
            expect(result).to_be_greater_than(0.999)
            expect(result).to_be_less_than(1.001)

    context("rounding"):
        it("should calculate absolute value"):
            expect(rt_math_abs(-5.0)).to_equal(5.0)
            expect(rt_math_abs(5.0)).to_equal(5.0)
            expect(rt_math_abs(0.0)).to_equal(0.0)

        it("should floor numbers"):
            expect(rt_math_floor(3.7)).to_equal(3.0)
            expect(rt_math_floor(-3.7)).to_equal(-4.0)
            expect(rt_math_floor(5.0)).to_equal(5.0)

        it("should ceil numbers"):
            expect(rt_math_ceil(3.2)).to_equal(4.0)
            expect(rt_math_ceil(-3.2)).to_equal(-3.0)
            expect(rt_math_ceil(5.0)).to_equal(5.0)

        it("should round numbers"):
            expect(rt_math_round(3.5)).to_equal(4.0)
            expect(rt_math_round(3.4)).to_equal(3.0)
            expect(rt_math_round(-3.5)).to_equal(-4.0)

    context("special values"):
        it("should handle zero correctly"):
            expect(rt_math_pow(0.0, 2.0)).to_equal(0.0)
            expect(rt_math_abs(0.0)).to_equal(0.0)
            expect(rt_math_floor(0.0)).to_equal(0.0)

        it("should handle one correctly"):
            expect(rt_math_pow(1.0, 100.0)).to_equal(1.0)
            expect(rt_math_sqrt(1.0)).to_equal(1.0)
            expect(rt_math_cbrt(1.0)).to_equal(1.0)

    context("mathematical identities"):
        it("should satisfy e^(ln(x)) = x"):
            let x = 5.0
            let result = rt_math_exp(rt_math_log(x))
            expect(result).to_be_greater_than(4.99)
            expect(result).to_be_less_than(5.01)

        it("should satisfy sqrt(x^2) = abs(x)"):
            let x = -7.0
            let result = rt_math_sqrt(rt_math_pow(x, 2.0))
            expect(result).to_equal(rt_math_abs(x))

        it("should satisfy Pythagorean identity"):
            let angle = 0.5
            let sin_val = rt_math_sin(angle)
            let cos_val = rt_math_cos(angle)
            let sum = sin_val * sin_val + cos_val * cos_val
            expect(sum).to_be_greater_than(0.999)
            expect(sum).to_be_less_than(1.001)
