# BDD Tests for JSON Module
# Feature #240: JSON Support
#
# Tests the core.json module for parsing and serializing JSON data.

import std.spec
import core.json

describe "JSON module":
    context "Parsing primitives":
        it "should parse null":
            val result = json.parse("null")
            expect result.is_ok() == true
            match result.unwrap():
                case JsonValue.Null:
                    expect true == true
                case _:
                    expect false == true

        it "should parse true":
            val result = json.parse("true")
            expect result.is_ok() == true
            match result.unwrap():
                case JsonValue.bool(b):
                    expect b == true
                case _:
                    expect false == true

        it "should parse false":
            val result = json.parse("false")
            expect result.is_ok() == true
            match result.unwrap():
                case JsonValue.bool(b):
                    expect b == false
                case _:
                    expect false == true

        it "should parse integer":
            val result = json.parse("42")
            expect result.is_ok() == true
            match result.unwrap():
                case JsonValue.Integer(i):
                    expect i == 42
                case _:
                    expect false == true

        it "should parse negative integer":
            val result = json.parse("-123")
            expect result.is_ok() == true
            match result.unwrap():
                case JsonValue.Integer(i):
                    expect i == -123
                case _:
                    expect false == true

        it "should parse string":
            val result = json.parse("\"hello\"")
            expect result.is_ok() == true
            match result.unwrap():
                case JsonValue.text(s):
                    expect s == "hello"
                case _:
                    expect false == true

        it "should parse empty string":
            val result = json.parse("\"\"")
            expect result.is_ok() == true
            match result.unwrap():
                case JsonValue.text(s):
                    expect s == ""
                case _:
                    expect false == true

    context "Parsing arrays":
        it "should parse empty array":
            val result = json.parse("[]")
            expect result.is_ok() == true
            match result.unwrap():
                case JsonValue.Array(arr):
                    expect arr.len() == 0
                case _:
                    expect false == true

        it "should parse integer array":
            val result = json.parse("[1, 2, 3]")
            expect result.is_ok() == true
            match result.unwrap():
                case JsonValue.Array(arr):
                    expect arr.len() == 3
                case _:
                    expect false == true

        it "should parse mixed array":
            val result = json.parse("[1, \"two\", true, null]")
            expect result.is_ok() == true
            match result.unwrap():
                case JsonValue.Array(arr):
                    expect arr.len() == 4
                case _:
                    expect false == true

    context "Parsing objects":
        it "should parse empty object":
            val result = json.parse('{}')
            expect result.is_ok() == true
            match result.unwrap():
                case JsonValue.Object(obj):
                    expect obj.keys().len() == 0
                case _:
                    expect false == true

        it "should parse simple object":
            val result = json.parse('{"name": "alice", "age": 30}')
            expect result.is_ok() == true
            match result.unwrap():
                case JsonValue.Object(obj):
                    expect obj.keys().len() == 2
                case _:
                    expect false == true

        it "should parse nested object":
            val result = json.parse('{"user": {"id": 1}}')
            expect result.is_ok() == true
            match result.unwrap():
                case JsonValue.Object(obj):
                    expect obj.keys().len() == 1
                case _:
                    expect false == true

    context "Serialization":
        it "should serialize null":
            val value = JsonValue.Null
            val s = json.stringify(value)
            expect s == "null"

        it "should serialize true":
            val value = JsonValue.bool(true)
            val s = json.stringify(value)
            expect s == "true"

        it "should serialize false":
            val value = JsonValue.bool(false)
            val s = json.stringify(value)
            expect s == "false"

        it "should serialize integer":
            val value = JsonValue.Integer(42)
            val s = json.stringify(value)
            expect s == "42"

        it "should serialize string":
            val value = JsonValue.text("hello")
            val s = json.stringify(value)
            expect s == "\"hello\""

        it "should serialize empty array":
            val value = JsonValue.Array([])
            val s = json.stringify(value)
            expect s == "[]"

        it "should serialize empty object":
            val value = JsonValue.Object({})
            val s = json.stringify(value)
            expect s == '{}'

    context "Builder API":
        it "should build simple object":
            val builder = JsonBuilder.new()
            builder.set_string("name", "test")
            builder.set_int("count", 5)
            val obj = builder.build()
            val s = json.stringify(obj)
            expect s.contains("\"name\"") == true
            expect s.contains("\"test\"") == true

        it "should support chained calls":
            val s = JsonBuilder.new().set_string("a", "1").set_int("b", 2).to_string()
            expect s.contains("\"a\"") == true
            expect s.contains("\"b\"") == true

    context "Helper functions":
        it "should extract string from JsonValue":
            val value = JsonValue.text("hello")
            val opt = json.get_string(value)
            expect opt.is_some() == true
            expect opt.unwrap() == "hello"

        it "should extract i32 from JsonValue":
            val value = JsonValue.Integer(42)
            val opt = json.get_int(value)
            expect opt.is_some() == true
            expect opt.unwrap() == 42

        it "should return None for wrong type":
            val value = JsonValue.text("hello")
            val opt = json.get_int(value)
            expect opt.is_none() == true

    context "Error handling":
        it "should error on invalid JSON":
            val result = json.parse("invalid")
            expect result.is_err() == true

        it "should error on unclosed string":
            val result = json.parse("\"unclosed")
            expect result.is_err() == true

        it "should error on unclosed object":
            val result = json.parse('{"key": 1')
            expect result.is_err() == true

    context "Round-trip":
        it "should round-trip simple object":
            original = '{"a": 1, "b": "two"}'
            parsed = json.parse(original)
            expect parsed.is_ok() == true
            # Re-serialize and parse again
            serialized = json.stringify(parsed.unwrap())
            reparsed = json.parse(serialized)
            expect reparsed.is_ok() == true

