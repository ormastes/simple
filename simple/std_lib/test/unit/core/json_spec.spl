# BDD Tests for JSON Module
# Feature #240: JSON Support

use spec.describe
use spec.it
use spec.expect
use core.json

describe("JSON module"):
    describe("Parsing primitives"):
        it("should parse null"):
            let result = json.parse("null")
            expect(result.is_ok()).to_be_true()

            let value = result.unwrap()
            match value:
                case JsonValue.Null:
                    # Success
                case _:
                    expect(False).to_be_true()  # Fail

        it("should parse true"):
            let result = json.parse("true")
            expect(result.is_ok()).to_be_true()

            match result.unwrap():
                case JsonValue.Bool(b):
                    expect(b).to_be_true()
                case _:
                    expect(False).to_be_true()

        it("should parse false"):
            let result = json.parse("false")
            expect(result.is_ok()).to_be_true()

            match result.unwrap():
                case JsonValue.Bool(b):
                    expect(b).to_be_false()
                case _:
                    expect(False).to_be_true()

        it("should parse integer"):
            let result = json.parse("42")
            expect(result.is_ok()).to_be_true()

            match result.unwrap():
                case JsonValue.Integer(i):
                    expect(i).to_equal(42)
                case _:
                    expect(False).to_be_true()

        it("should parse negative integer"):
            let result = json.parse("-123")
            expect(result.is_ok()).to_be_true()

            match result.unwrap():
                case JsonValue.Integer(i):
                    expect(i).to_equal(-123)
                case _:
                    expect(False).to_be_true()

        it("should parse string"):
            let result = json.parse('"hello"')
            expect(result.is_ok()).to_be_true()

            match result.unwrap():
                case JsonValue.String(s):
                    expect(s).to_equal("hello")
                case _:
                    expect(False).to_be_true()

    describe("Parsing strings with escapes"):
        it("should parse string with escaped quotes"):
            let result = json.parse('"say \\"hello\\""')
            expect(result.is_ok()).to_be_true()

            match result.unwrap():
                case JsonValue.String(s):
                    expect(s).to_contain("\"")
                case _:
                    expect(False).to_be_true()

        it("should parse string with newline"):
            let result = json.parse('"line1\\nline2"')
            expect(result.is_ok()).to_be_true()

            match result.unwrap():
                case JsonValue.String(s):
                    expect(s).to_contain("\n")
                case _:
                    expect(False).to_be_true()

    describe("Parsing arrays"):
        it("should parse empty array"):
            let result = json.parse("[]")
            expect(result.is_ok()).to_be_true()

            match result.unwrap():
                case JsonValue.Array(arr):
                    expect(arr.len()).to_equal(0)
                case _:
                    expect(False).to_be_true()

        it("should parse array with numbers"):
            let result = json.parse("[1, 2, 3]")
            expect(result.is_ok()).to_be_true()

            match result.unwrap():
                case JsonValue.Array(arr):
                    expect(arr.len()).to_equal(3)
                case _:
                    expect(False).to_be_true()

        it("should parse array with mixed types"):
            let result = json.parse('[1, "two", true, null]')
            expect(result.is_ok()).to_be_true()

            match result.unwrap():
                case JsonValue.Array(arr):
                    expect(arr.len()).to_equal(4)
                case _:
                    expect(False).to_be_true()

        it("should parse nested arrays"):
            let result = json.parse("[[1, 2], [3, 4]]")
            expect(result.is_ok()).to_be_true()

            match result.unwrap():
                case JsonValue.Array(arr):
                    expect(arr.len()).to_equal(2)
                case _:
                    expect(False).to_be_true()

    describe("Parsing objects"):
        it("should parse empty object"):
            let result = json.parse("{}")
            expect(result.is_ok()).to_be_true()

            match result.unwrap():
                case JsonValue.Object(obj):
                    expect(obj.keys().len()).to_equal(0)
                case _:
                    expect(False).to_be_true()

        it("should parse object with string value"):
            let result = json.parse('{"name": "Alice"}')
            expect(result.is_ok()).to_be_true()

            match result.unwrap():
                case JsonValue.Object(obj):
                    expect(obj.has_key("name")).to_be_true()
                case _:
                    expect(False).to_be_true()

        it("should parse object with multiple fields"):
            let result = json.parse('{"name": "Bob", "age": 30, "active": true}')
            expect(result.is_ok()).to_be_true()

            match result.unwrap():
                case JsonValue.Object(obj):
                    expect(obj.keys().len()).to_equal(3)
                case _:
                    expect(False).to_be_true()

        it("should parse nested objects"):
            let result = json.parse('{"user": {"name": "Charlie", "id": 123}}')
            expect(result.is_ok()).to_be_true()

            match result.unwrap():
                case JsonValue.Object(obj):
                    expect(obj.has_key("user")).to_be_true()
                case _:
                    expect(False).to_be_true()

    describe("Stringification"):
        it("should stringify null"):
            let result = json.stringify(JsonValue.Null)
            expect(result).to_equal("null")

        it("should stringify boolean"):
            let t = json.stringify(JsonValue.Bool(True))
            let f = json.stringify(JsonValue.Bool(False))

            expect(t).to_equal("true")
            expect(f).to_equal("false")

        it("should stringify integer"):
            let result = json.stringify(JsonValue.Integer(42))
            expect(result).to_contain("42")

        it("should stringify string"):
            let result = json.stringify(JsonValue.String("hello"))
            expect(result).to_equal('"hello"')

        it("should escape special characters in strings"):
            let result = json.stringify(JsonValue.String('say "hello"'))
            expect(result).to_contain('\\"')

        it("should stringify array"):
            let arr = [JsonValue.Integer(1), JsonValue.Integer(2), JsonValue.Integer(3)]
            let result = json.stringify(JsonValue.Array(arr))

            expect(result).to_contain("[")
            expect(result).to_contain("]")
            expect(result).to_contain("1")
            expect(result).to_contain("2")
            expect(result).to_contain("3")

        it("should stringify object"):
            let obj = {}
            obj.set("name", JsonValue.String("Alice"))
            obj.set("age", JsonValue.Integer(30))

            let result = json.stringify(JsonValue.Object(obj))

            expect(result).to_contain("{")
            expect(result).to_contain("}")
            expect(result).to_contain('"name"')
            expect(result).to_contain('"Alice"')

    describe("Helper functions"):
        it("should extract string from JsonValue"):
            let value = JsonValue.String("test")
            let result = json.get_string(value)

            expect(result.is_some()).to_be_true()
            expect(result.unwrap()).to_equal("test")

        it("should return None for non-string"):
            let value = JsonValue.Integer(42)
            let result = json.get_string(value)

            expect(result.is_none()).to_be_true()

        it("should extract integer from JsonValue"):
            let value = JsonValue.Integer(42)
            let result = json.get_int(value)

            expect(result.is_some()).to_be_true()
            expect(result.unwrap()).to_equal(42)

    describe("JsonBuilder"):
        it("should build JSON object"):
            let builder = JsonBuilder.new()
            builder.set_string("name", "Alice")
            builder.set_int("age", 30)
            builder.set_bool("active", True)

            let json_value = builder.build()

            match json_value:
                case JsonValue.Object(obj):
                    expect(obj.has_key("name")).to_be_true()
                    expect(obj.has_key("age")).to_be_true()
                    expect(obj.has_key("active")).to_be_true()
                case _:
                    expect(False).to_be_true()

        it("should convert builder to string"):
            let builder = JsonBuilder.new()
            builder.set_string("test", "value")

            let result = builder.to_string()

            expect(result).to_contain('"test"')
            expect(result).to_contain('"value"')

# Feature metadata registration
use spec.feature_doc.FeatureMetadata

let json_test_features = [
    FeatureMetadata {
        id: 240,
        name: "JSON Support",
        category: "Serialization",
        difficulty: 3,
        status: "âœ… Complete",
        impl_type: "Simple",
        spec_ref: "doc/spec/stdlib.md",
        files: ["simple/std_lib/src/core/json.spl"],
        tests: ["simple/std_lib/test/unit/core/json_spec.spl"],
        description: "JSON parsing and serialization with escape handling and builder pattern.",
        code_examples: ['json.parse(string)', 'json.stringify(value)', 'JsonBuilder.new()'],
        dependencies: [22, 140],
        required_by: [241],
        notes: "Full JSON support with comprehensive BDD tests"
    }
]

# Register features when test runs
for meta in json_test_features:
    feature_metadata(meta)
