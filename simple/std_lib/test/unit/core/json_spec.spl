# BDD Tests for JSON Module
# Feature #240: JSON Support

use core.json

describe "JSON module":
    describe "Parsing primitives":
        it "should parse null":
            let result = json.parse("null")
            expect result.is_ok()

            let value = result.unwrap()
            match value:
                JsonValue.Null =>
                    # Success
                _ =>
                    expect False  # Fail

        it "should parse true":
            let result = json.parse("true")
            expect result.is_ok()

            match result.unwrap():
                JsonValue.Bool(b) =>
                    expect b
                _ =>
                    expect False

        it "should parse false":
            let result = json.parse("false")
            expect result.is_ok()

            match result.unwrap():
                JsonValue.Bool(b) =>
                    expect not b
                _ =>
                    expect False

        it "should parse integer":
            let result = json.parse("42")
            expect result.is_ok()

            match result.unwrap():
                JsonValue.Integer(i) =>
                    expect i == 42
                _ =>
                    expect False

        it "should parse negative integer":
            let result = json.parse("-123")
            expect result.is_ok()

            match result.unwrap():
                JsonValue.Integer(i) =>
                    expect i == -123
                _ =>
                    expect False

        it "should parse string":
            let result = json.parse('"hello"')
            expect result.is_ok()

            match result.unwrap():
                JsonValue.String(s) =>
                    expect s == "hello"
                _ =>
                    expect False

    describe "Parsing strings with escapes":
        it "should parse string with escaped quotes":
            let result = json.parse('"say \\"hello\\""')
            expect result.is_ok()

            match result.unwrap():
                JsonValue.String(s) =>
                    expect "\"" in s
                _ =>
                    expect False

        it "should parse string with newline":
            let result = json.parse('"line1\\nline2"')
            expect result.is_ok()

            match result.unwrap():
                JsonValue.String(s) =>
                    expect "\n" in s
                _ =>
                    expect False

    describe "Parsing arrays":
        it "should parse empty array":
            let result = json.parse("[]")
            expect result.is_ok()

            match result.unwrap():
                JsonValue.Array(arr) =>
                    expect arr.len() == 0
                _ =>
                    expect False

        it "should parse array with numbers":
            let result = json.parse("[1, 2, 3]")
            expect result.is_ok()

            match result.unwrap():
                JsonValue.Array(arr) =>
                    expect arr.len() == 3
                _ =>
                    expect False

        it "should parse array with mixed types":
            let result = json.parse('[1, "two", true, null]')
            expect result.is_ok()

            match result.unwrap():
                JsonValue.Array(arr) =>
                    expect arr.len() == 4
                _ =>
                    expect False

        it "should parse nested arrays":
            let result = json.parse("[[1, 2], [3, 4]]")
            expect result.is_ok()

            match result.unwrap():
                JsonValue.Array(arr) =>
                    expect arr.len() == 2
                _ =>
                    expect False

    describe "Parsing objects":
        it "should parse empty object":
            let result = json.parse("{}")
            expect result.is_ok()

            match result.unwrap():
                JsonValue.Object(obj) =>
                    expect obj.keys().len() == 0
                _ =>
                    expect False

        it "should parse object with string value":
            let result = json.parse('{"name": "Alice"}')
            expect result.is_ok()

            match result.unwrap():
                JsonValue.Object(obj) =>
                    expect obj.has_key("name")
                _ =>
                    expect False

        it "should parse object with multiple fields":
            let result = json.parse('{"name": "Bob", "age": 30, "active": true}')
            expect result.is_ok()

            match result.unwrap():
                JsonValue.Object(obj) =>
                    expect obj.keys().len() == 3
                _ =>
                    expect False

        it "should parse nested objects":
            let result = json.parse('{"user": {"name": "Charlie", "id": 123}}')
            expect result.is_ok()

            match result.unwrap():
                JsonValue.Object(obj) =>
                    expect obj.has_key("user")
                _ =>
                    expect False

    describe "Stringification":
        it "should stringify null":
            let result = json.stringify(JsonValue.Null)
            expect result == "null"

        it "should stringify boolean":
            let t = json.stringify(JsonValue.Bool(True))
            let f = json.stringify(JsonValue.Bool(False))

            expect t == "true"
            expect f == "false"

        it "should stringify integer":
            let result = json.stringify(JsonValue.Integer(42))
            expect "42" in result

        it "should stringify string":
            let result = json.stringify(JsonValue.String("hello"))
            expect result == '"hello"'

        it "should escape special characters in strings":
            let result = json.stringify(JsonValue.String('say "hello"'))
            expect '\\"' in result

        it "should stringify array":
            let arr = [JsonValue.Integer(1), JsonValue.Integer(2), JsonValue.Integer(3)]
            let result = json.stringify(JsonValue.Array(arr))

            expect "[" in result
            expect "]" in result
            expect "1" in result
            expect "2" in result
            expect "3" in result

        it "should stringify object":
            let obj = {}
            obj.set("name", JsonValue.String("Alice"))
            obj.set("age", JsonValue.Integer(30))

            let result = json.stringify(JsonValue.Object(obj))

            expect "{" in result
            expect "}" in result
            expect '"name"' in result
            expect '"Alice"' in result

    describe "Helper functions":
        it "should extract string from JsonValue":
            let value = JsonValue.String("test")
            let result = json.get_string(value)

            expect result.is_some()
            expect result.unwrap() == "test"

        it "should return None for non-string":
            let value = JsonValue.Integer(42)
            let result = json.get_string(value)

            expect result.is_none()

        it "should extract integer from JsonValue":
            let value = JsonValue.Integer(42)
            let result = json.get_int(value)

            expect result.is_some()
            expect result.unwrap() == 42

    describe "JsonBuilder":
        it "should build JSON object":
            let builder = JsonBuilder.new()
            builder.set_string("name", "Alice")
            builder.set_int("age", 30)
            builder.set_bool("active", True)

            let json_value = builder.build()

            match json_value:
                JsonValue.Object(obj) =>
                    expect obj.has_key("name")
                    expect obj.has_key("age")
                    expect obj.has_key("active")
                _ =>
                    expect False

        it "should convert builder to string":
            let builder = JsonBuilder.new()
            builder.set_string("test", "value")

            let result = builder.to_string()

            expect '"test"' in result
            expect '"value"' in result

# Feature metadata registration
use spec.feature_doc.FeatureMetadata

let json_test_features = [
    FeatureMetadata {
        id: 240,
        name: "JSON Support",
        category: "Serialization",
        difficulty: 3,
        status: "âœ… Complete",
        impl_type: "Simple",
        spec_ref: "doc/spec/stdlib.md",
        files: ["simple/std_lib/src/core/json.spl"],
        tests: ["simple/std_lib/test/unit/core/json_spec.spl"],
        description: "JSON parsing and serialization with escape handling and builder pattern.",
        code_examples: ['json.parse(string)', 'json.stringify(value)', 'JsonBuilder.new()'],
        dependencies: [22, 140],
        required_by: [241],
        notes: "Full JSON support with comprehensive BDD tests"
    }
]

# Register features when test runs
for meta in json_test_features:
    feature_metadata(meta)
