# Feature Documentation Framework System Tests
# Tests the BDD-driven feature documentation generation system

use spec.{describe, context, it, expect}
use spec.{eq, be, be_true, be_false, include, have_length, gte}
use spec.feature_doc.{
    FeatureMetadata,
    feature_metadata,
    get_feature,
    get_features_by_category,
    get_all_features,
    get_all_categories,
    clear_feature_registry
}
use core.collections.List

describe "Feature Documentation Framework":
    before_each:
        # Clear registry before each test
        clear_feature_registry()

    context "FeatureMetadata":
        it "creates metadata with required fields":
            let metadata = FeatureMetadata.new(
                id: 1,
                name: "Test Feature",
                category: "Testing",
                difficulty: 3,
                status: "âœ… Complete",
                impl_type: "R",
                spec_ref: "doc/spec/test.md",
                files: ["src/test.rs"],
                tests: ["tests/test.rs"],
                description: "Test description",
                examples: [],
                dependencies: [],
                required_by: [],
                notes: ""
            )

            expect metadata.id to eq 1
            expect metadata.name to eq "Test Feature"
            expect metadata.category to eq "Testing"

        it "validates metadata correctness":
            let valid = FeatureMetadata.new(
                id: 1,
                name: "Valid",
                category: "Test",
                difficulty: 3,
                status: "âœ… Complete",
                impl_type: "R",
                spec_ref: "doc/spec/test.md",
                files: [],
                tests: [],
                description: "",
                examples: [],
                dependencies: [],
                required_by: [],
                notes: ""
            )

            let (is_valid, msg) = valid.validate()
            expect is_valid to be_true

        it "rejects invalid difficulty":
            let invalid = FeatureMetadata.new(
                id: 1,
                name: "Invalid",
                category: "Test",
                difficulty: 10,  # Invalid: must be 1-5
                status: "âœ… Complete",
                impl_type: "R",
                spec_ref: "doc/spec/test.md",
                files: [],
                tests: [],
                description: "",
                examples: [],
                dependencies: [],
                required_by: [],
                notes: ""
            )

            let (is_valid, msg) = invalid.validate()
            expect is_valid to be_false
            expect msg to include "Difficulty"

        it "generates correct filename":
            let metadata = FeatureMetadata.new(
                id: 1,
                name: "Lexer",
                category: "Infrastructure",
                difficulty: 3,
                status: "âœ… Complete",
                impl_type: "R",
                spec_ref: "",
                files: [],
                tests: [],
                description: "",
                examples: [],
                dependencies: [],
                required_by: [],
                notes: ""
            )

            expect metadata.filename() to eq "0001_lexer.md"

        it "generates correct full path":
            let metadata = FeatureMetadata.new(
                id: 1,
                name: "Lexer",
                category: "Infrastructure",
                difficulty: 3,
                status: "âœ… Complete",
                impl_type: "R",
                spec_ref: "",
                files: [],
                tests: [],
                description: "",
                examples: [],
                dependencies: [],
                required_by: [],
                notes: ""
            )

            expect metadata.full_path() to eq "doc/features/infrastructure/0001_lexer.md"

    context "Feature Registry":
        it "registers features":
            let metadata = FeatureMetadata.new(
                id: 1,
                name: "Test",
                category: "Testing",
                difficulty: 3,
                status: "âœ… Complete",
                impl_type: "R",
                spec_ref: "",
                files: [],
                tests: [],
                description: "",
                examples: [],
                dependencies: [],
                required_by: [],
                notes: ""
            )

            feature_metadata(
                id: 1,
                name: "Test",
                category: "Testing",
                difficulty: 3,
                status: "âœ… Complete",
                impl_type: "R",
                spec_ref: "",
                files: [],
                tests: []
            )

            let retrieved = get_feature(1)
            expect retrieved.is_some() to be_true
            expect retrieved.unwrap().name to eq "Test"

        it "retrieves features by category":
            # Register multiple features
            feature_metadata(
                id: 1,
                name: "Feature 1",
                category: "CategoryA",
                difficulty: 1,
                status: "âœ…",
                impl_type: "R",
                spec_ref: "",
                files: [],
                tests: []
            )

            feature_metadata(
                id: 2,
                name: "Feature 2",
                category: "CategoryA",
                difficulty: 2,
                status: "âœ…",
                impl_type: "R",
                spec_ref: "",
                files: [],
                tests: []
            )

            feature_metadata(
                id: 3,
                name: "Feature 3",
                category: "CategoryB",
                difficulty: 3,
                status: "âœ…",
                impl_type: "R",
                spec_ref: "",
                files: [],
                tests: []
            )

            let category_a = get_features_by_category("CategoryA")
            expect category_a.len() to eq 2

            let category_b = get_features_by_category("CategoryB")
            expect category_b.len() to eq 1

        it "lists all categories":
            feature_metadata(
                id: 1,
                name: "Test 1",
                category: "Cat1",
                difficulty: 1,
                status: "âœ…",
                impl_type: "R",
                spec_ref: "",
                files: [],
                tests: []
            )

            feature_metadata(
                id: 2,
                name: "Test 2",
                category: "Cat2",
                difficulty: 1,
                status: "âœ…",
                impl_type: "R",
                spec_ref: "",
                files: [],
                tests: []
            )

            let categories = get_all_categories()
            expect categories to include "Cat1"
            expect categories to include "Cat2"

        it "gets all features":
            feature_metadata(
                id: 1,
                name: "Test 1",
                category: "Cat1",
                difficulty: 1,
                status: "âœ…",
                impl_type: "R",
                spec_ref: "",
                files: [],
                tests: []
            )

            feature_metadata(
                id: 2,
                name: "Test 2",
                category: "Cat1",
                difficulty: 1,
                status: "âœ…",
                impl_type: "R",
                spec_ref: "",
                files: [],
                tests: []
            )

            let all = get_all_features()
            expect all.len() to gte 2

    context "Documentation Generation":
        it "generates markdown for a feature":
            use spec.feature_doc.generator.generate_markdown

            let metadata = FeatureMetadata.new(
                id: 1,
                name: "Test Feature",
                category: "Testing",
                difficulty: 3,
                status: "âœ… Complete",
                impl_type: "R",
                spec_ref: "doc/spec/test.md",
                files: ["src/test.rs"],
                tests: ["tests/test.rs"],
                description: "A test feature",
                examples: [],
                dependencies: [],
                required_by: [],
                notes: "Test notes"
            )

            let markdown = generate_markdown(metadata)

            expect markdown to include "# Feature #1: Test Feature"
            expect markdown to include "## Overview"
            expect markdown to include "## Description"
            expect markdown to include "A test feature"

        it "includes metadata table in generated markdown":
            use spec.feature_doc.generator.generate_markdown

            let metadata = FeatureMetadata.new(
                id: 42,
                name: "Example",
                category: "Demo",
                difficulty: 2,
                status: "ðŸ“‹ Planned",
                impl_type: "S+R",
                spec_ref: "",
                files: [],
                tests: [],
                description: "",
                examples: [],
                dependencies: [],
                required_by: [],
                notes: ""
            )

            let markdown = generate_markdown(metadata)

            expect markdown to include "| **Feature ID** | #42 |"
            expect markdown to include "| **Feature Name** | Example |"
            expect markdown to include "| **Category** | Demo |"
            expect markdown to include "| **Status** | ðŸ“‹ Planned |"

    context "Index Generation":
        it "generates category index":
            use spec.feature_doc.index_generator.generate_category_index

            # Register features for a category
            feature_metadata(
                id: 1,
                name: "Feature 1",
                category: "TestCategory",
                difficulty: 1,
                status: "âœ… Complete",
                impl_type: "R",
                spec_ref: "",
                files: [],
                tests: []
            )

            feature_metadata(
                id: 2,
                name: "Feature 2",
                category: "TestCategory",
                difficulty: 2,
                status: "ðŸ”„ In Progress",
                impl_type: "S",
                spec_ref: "",
                files: [],
                tests: []
            )

            let index = generate_category_index("TestCategory")

            expect index to include "# TestCategory Features"
            expect index to include "## Summary"
            expect index to include "**Total Features:** 2"
            expect index to include "**Completed:** 1"
            expect index to include "## Features"

        it "generates master index":
            use spec.feature_doc.index_generator.generate_master_index

            # Register features in different categories
            feature_metadata(
                id: 1,
                name: "Test 1",
                category: "Cat1",
                difficulty: 1,
                status: "âœ… Complete",
                impl_type: "R",
                spec_ref: "",
                files: [],
                tests: []
            )

            feature_metadata(
                id: 2,
                name: "Test 2",
                category: "Cat2",
                difficulty: 1,
                status: "âœ… Complete",
                impl_type: "R",
                spec_ref: "",
                files: [],
                tests: []
            )

            let master = generate_master_index()

            expect master to include "# Simple Language Feature Documentation"
            expect master to include "## Overview"
            expect master to include "## Features by Category"
