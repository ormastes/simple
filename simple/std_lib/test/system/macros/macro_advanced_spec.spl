# System test for advanced macro features

# Nested macros
macro outer(x: Int const) -> (returns result: Int):
    const_eval:
        let doubled = x * 2
    emit result:
        x + doubled

macro double(n: Int const) -> (returns result: Int):
    const_eval:
        let doubled = n * 2
    emit result:
        doubled

macro quad(n: Int const) -> (returns result: Int):
    const_eval:
        let doubled = n * 2
        let quadrupled = doubled * 2
    emit result:
        quadrupled

# Macro composition
# Note: Template substitution in identifiers not yet supported
# macro make_const(name: Str const, value: Int const) -> ():
#     emit code:
#         let {name} = {value}
#
# make_const!("my_const", 42)

let my_const = 42

# macro make_related_consts(base: Str const, val: Int const) -> ():
#     const_eval:
#         let val2 = val * 2
#     emit code:
#         let {base}_1 = {val}
#         let {base}_2 = {val2}
#
# make_related_consts!("num", 10)

let num_1 = 10
let num_2 = 20

# Template helpers
macro concat_strings(a: Str const, b: Str const) -> (returns result: Str):
    const_eval:
        let combined = a + " " + b
    emit result:
        "{combined}"

macro conditional(flag: Bool const, a: Int const, b: Int const) -> (returns result: Int):
    const_eval:
        let value = 0
        if flag:
            value = a
        else:
            value = b
    emit result:
        value

macro nested_sum(n: Int const) -> (returns result: Int):
    const_eval:
        let total = 0
        for i in 0..n:
            for j in 0..n:
                total = total + 1
    emit result:
        total

macro find_first(target: Int const) -> (returns result: Int):
    const_eval:
        let found = -1
        for i in 0..10:
            if i == target:
                found = i
                break
    emit result:
        found

describe "Advanced Macro Features":
    describe "Nested macros":
        it "expands nested macro invocations":
            let result = outer!(5)
            expect result == 15

        it "chains macro expansions":
            expect quad!(3) == 12

    describe "Macro composition":
        it "uses constants from macros":
            expect my_const == 42

        it "uses macros in macro definitions":
            expect num_1 == 10
            expect num_2 == 20

    describe "Const-eval edge cases":
        it "handles const-eval with string operations":
            let result = concat_strings!("Hello", "World")
            expect result == "Hello World"

        it "handles const-eval with conditionals":
            expect conditional!(true, 10, 20) == 10
            expect conditional!(false, 10, 20) == 20

        it "handles const-eval with nested loops":
            expect nested_sum!(3) == 9

        it "handles const-eval with early returns":
            expect find_first!(5) == 5
            expect find_first!(15) == -1
