# Test for template substitution in macros

# Template in strings
macro greet(name: Str const) -> (returns msg: Str):
    emit msg:
        "Hello, {name}!"

macro message(prefix: Str const, suffix: Str const) -> (returns msg: Str):
    const_eval:
        let combined = prefix + " " + suffix
    emit msg:
        "{combined}"

# Template in function names
macro make_constant(name: Str const) -> (
    intro func:
        enclosing.module.fn "get_{name}"() -> Int
):
    emit func:
        fn "get_{name}"() -> Int:
            return 42

make_constant!("pi")
make_constant!("answer")

# Multiple templates in function name
macro make_binary_func(op: Str const) -> (
    intro func:
        enclosing.module.fn "{op}_nums"(a: Int, b: Int) -> Int
):
    emit func:
        fn "{op}_nums"(a: Int, b: Int) -> Int:
            return a + b

make_binary_func!("sum")
make_binary_func!("add")

# Template with index numbers - manually defined
macro make_item_0() -> (
    intro func:
        enclosing.module.fn "item_0"() -> Int
):
    emit func:
        fn "item_0"() -> Int:
            return 0

macro make_item_1() -> (
    intro func:
        enclosing.module.fn "item_1"() -> Int
):
    emit func:
        fn "item_1"() -> Int:
            return 1

macro make_item_2() -> (
    intro func:
        enclosing.module.fn "item_2"() -> Int
):
    emit func:
        fn "item_2"() -> Int:
            return 2

make_item_0!()
make_item_1!()
make_item_2!()

describe "Template Substitution":
    describe "Templates in strings":
        it "substitutes into string literals":
            expect greet!("Alice") == "Hello, Alice!"
            expect greet!("Bob") == "Hello, Bob!"

        it "combines multiple templates":
            expect message!("Good", "morning") == "Good morning"
            expect message!("Hello", "world") == "Hello world"

    describe "Templates in function names":
        it "generates functions with template names":
            expect get_pi() == 42
            expect get_answer() == 42

        it "generates operation functions":
            expect sum_nums(10, 20) == 30
            expect add_nums(5, 15) == 20

    describe "Templates with numbers":
        it "combines strings and numbers in names":
            expect item_0() == 0
            expect item_1() == 1
            expect item_2() == 2
