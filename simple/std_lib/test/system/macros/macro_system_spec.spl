# System test for macro system - Core functionality

# Define all macros at module level
macro answer() -> (returns result: Int):
    emit result:
        42

macro repeat(msg: Str const, times: Int const) -> (returns result: Str):
    emit result:
        "{msg}" * {times}

macro make_adder(n: Int const) -> (
    intro func:
        enclosing.module.fn "add_{n}"(x: Int) -> Int
):
    emit func:
        fn "add_{n}"(x: Int) -> Int:
            return x + {n}

make_adder!(5)
make_adder!(10)

macro use_temp() -> (returns result: Int):
    emit result:
        let temp = 42
        temp

macro make_counter() -> (returns result: Int):
    emit result:
        let count = 0
        count = count + 1
        count

macro make_var(name: Str const, value: Int const) -> ():
    emit code:
        let {name} = {value}

make_var!("my_var", 42)

macro greet(name: Str const) -> (returns msg: Str):
    emit msg:
        "Hello, {name}!"

macro make_getter(field: Str const) -> (
    intro func:
        enclosing.module.fn "get_{field}"() -> Str
):
    emit func:
        fn "get_{field}"() -> Str:
            return "{field} value"

make_getter!("name")

macro compute(a: Int const, b: Int const) -> (returns result: Int):
    const_eval:
        let sum = a + b
        let product = a * b
    emit result:
        {sum} + {product}

macro max_value(a: Int const, b: Int const) -> (returns result: Int):
    const_eval:
        let max_val = 0
        if a > b:
            max_val = a
        else:
            max_val = b
    emit result:
        {max_val}

macro sum_range(n: Int const) -> (returns result: Int):
    const_eval:
        let total = 0
        for i in 0..n:
            total = total + i
    emit result:
        {total}

describe "Macro System":
    describe "Basic macro expansion":
        it "expands simple expression macros":
            let x = answer!()
            expect x == 42

        it "expands macros with const parameters":
            let result = repeat!("hello", 3)
            expect result == "hellohellohello"

        it "handles multiple macro invocations independently":
            expect add_5(3) == 8
            expect add_10(3) == 13

    describe "Hygienic expansion":
        it "prevents variable capture from outer scope":
            let temp = 100
            let result = use_temp!()
            expect result == 42
            expect temp == 100

        it "generates unique names for repeated expansions":
            let a = make_counter!()
            let b = make_counter!()
            expect a == 1
            expect b == 1

    describe "Template substitution":
        it "substitutes templates in identifiers":
            expect my_var == 42

        it "substitutes templates in strings":
            let greeting = greet!("World")
            expect greeting == "Hello, World!"

        it "substitutes templates in function names":
            let result = get_name()
            expect result == "name value"

    describe "Const-eval engine":
        it "evaluates arithmetic in const context":
            let result = compute!(3, 4)
            expect result == 19

        it "evaluates conditionals in const context":
            expect max_value!(10, 5) == 10
            expect max_value!(3, 7) == 7

        it "evaluates loops in const context":
            let result = sum_range!(5)
            expect result == 10
