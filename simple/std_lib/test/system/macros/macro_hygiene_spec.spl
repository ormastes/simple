# Test for macro hygiene - variable capture prevention

# Test hygiene with variable shadowing
let outer_x = 100

macro use_x() -> (returns result: Int):
    emit result:
        let x = 42
        x

macro make_counter() -> (returns result: Int):
    emit result:
        let count = 0
        count + 1

macro shadow_outer(val: Int const) -> (returns result: Int):
    const_eval:
        let value = val
    emit result:
        let outer_x = value
        outer_x

describe "Macro Hygiene":
    it "prevents variable capture from outer scope":
        let result = use_x!()
        expect result == 42
        expect outer_x == 100

    it "generates unique names for repeated expansions":
        let a = make_counter!()
        let b = make_counter!()
        expect a == 1
        expect b == 1

    it "allows explicit shadowing with different values":
        let result = shadow_outer!(999)
        expect result == 999
        expect outer_x == 100

    it "isolates macro-generated variables":
        let x = 100
        let r1 = use_x!()
        let r2 = use_x!()
        expect r1 == 42
        expect r2 == 42
        expect x == 100
