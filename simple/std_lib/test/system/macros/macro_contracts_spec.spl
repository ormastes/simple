# System test for macro contracts - intro/inject/returns

# Module-level macros
macro make_function(name: Str const) -> (
    intro func:
        enclosing.module.fn "{name}"() -> Str
):
    emit func:
        fn "{name}"() -> Str:
            return "Function {name}"

make_function!("test_fn")

macro make_axes(base: Str const, count: Int const) -> (
    intro axes:
        for i in 0..count:
            enclosing.module.fn "{base}{i}"() -> Int
):
    const_eval:
        for i in 0..count:
            emit axes:
                fn "{base}{i}"() -> Int:
                    return {i}

make_axes!("axis", 3)

macro get_pi() -> (returns value: Float):
    emit value:
        3.14159

macro factorial(n: Int const) -> (returns result: Int):
    const_eval:
        let fact = 1
        for i in 1..(n + 1):
            fact = fact * i
    emit result:
        {fact}

macro make_getter_pair(field: Str const) -> (
    intro getter:
        enclosing.module.fn "get_{field}"() -> Str
    intro setter:
        enclosing.module.fn "set_{field}"(value: Str) -> ()
    returns initialized: Bool
):
    emit getter:
        fn "get_{field}"() -> Str:
            return _storage_{field}

    emit setter:
        fn "set_{field}"(value: Str) -> ():
            _storage_{field} = value

    emit initialized:
        let _storage_{field} = "default"
        true

let setup = make_getter_pair!("name")

describe "Macro Contracts":
    describe "intro contracts":
        it "introduces functions to enclosing module":
            let result = test_fn()
            expect result == "Function test_fn"

        it "introduces multiple functions from const-eval loop":
            expect axis0() == 0
            expect axis1() == 1
            expect axis2() == 2

    describe "returns contracts":
        it "returns simple values":
            let pi = get_pi!()
            # Note: Float comparison needs approximate equality
            # For now just check it's close to 3.14
            expect pi > 3.0
            expect pi < 3.2

        it "returns computed values from const-eval":
            expect factorial!(5) == 120
            expect factorial!(0) == 1

    describe "combined contracts":
        it "uses intro and returns together":
            expect setup == true
            set_name("Alice")
            expect get_name() == "Alice"
