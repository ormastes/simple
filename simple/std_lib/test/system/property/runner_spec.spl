# Property Testing Framework - Runner Tests
# Tests for the property test execution engine

module tests.property.runner_spec:
    use std.spec.{describe, context, it, expect}
    use std.spec.property.{run_property_test, check_property, quick_check}
    use std.spec.property.{PropertyConfig, PropertyTestResult}
    use std.spec.property.generators as gen

    describe "Property Test Runner":
        context("Basic Execution"):
            it "runs property test with generator":
                let result = run_property_test(
                    test_fn: |x| x == x,  # Always true
                    generator: gen.i64(),
                    config: PropertyConfig.default()
                )
                expect result.is_success()

            it "detects property violations":
                let result = run_property_test(
                    test_fn: |x| x < 50,  # Will fail for x >= 50
                    generator: gen.i64_range(0, 100),
                    config: PropertyConfig.default()
                )
                expect result.is_failure()

            it "runs specified number of iterations":
                let mut count = 0
                let result = run_property_test(
                    test_fn: |x| {
                        count += 1
                        return true
                    },
                    generator: gen.i64(),
                    config: PropertyConfig.default().with_iterations(50)
                )
                expect count == 50

        context("Shrinking on Failure"):
            it "shrinks to minimal failing case":
                let result = run_property_test(
                    test_fn: |list| list.sum() < 10,  # Fails for large sums
                    generator: gen.list_with_length(gen.i64_range(1, 5), 5, 10),
                    config: PropertyConfig.default()
                )

                match result:
                    PropertyTestResult.Failure(_, orig, minimal, shrinks, _) ->
                        # Minimal should be smaller than original
                        expect(shrinks).to_be_gt(0)
                    _ ->
                        # Test might pass if unlucky with random values
                        pass

            it "respects max_shrinks limit":
                let result = run_property_test(
                    test_fn: |x| x < 10,
                    generator: gen.i64_range(0, 100),
                    config: PropertyConfig.default()
                        .with_max_shrinks(5)
                )

                match result:
                    PropertyTestResult.Failure(_, _, _, shrinks, _) ->
                        expect(shrinks).to_be_lte(5)
                    _ -> pass

        context("Configuration"):
            it "uses custom seed for reproducibility":
                let config = PropertyConfig.default()
                    .with_seed(42)
                    .with_iterations(10)

                let result1 = run_property_test(
                    test_fn: |x| true,
                    generator: gen.i64(),
                    config: config
                )

                let result2 = run_property_test(
                    test_fn: |x| true,
                    generator: gen.i64(),
                    config: config
                )

                # Both should succeed
                expect result1.is_success()
                expect result2.is_success()

            it "supports quick check mode":
                let result = quick_check(
                    property: |x| x + 0 == x,
                    generator: gen.i64()
                )
                expect result

            it "supports thorough check mode":
                # This would run 1000 iterations
                let result = check_property(
                    property: |x| x * 1 == x,
                    generator: gen.i64()
                )
                expect result

        context("Property Examples"):
            it "tests commutativity":
                let result = run_property_test(
                    test_fn: |(a, b)| a + b == b + a,
                    generator: gen.tuple2(gen.i64(), gen.i64()),
                    config: PropertyConfig.quick()
                )
                expect result.is_success()

            it "tests associativity":
                let result = run_property_test(
                    test_fn: |(a, b, c)| (a + b) + c == a + (b + c),
                    generator: gen.tuple3(gen.i64(), gen.i64(), gen.i64()),
                    config: PropertyConfig.quick()
                )
                expect result.is_success()

            it "tests identity property":
                let result = run_property_test(
                    test_fn: |x| x + 0 == x and x * 1 == x,
                    generator: gen.i64(),
                    config: PropertyConfig.quick()
                )
                expect result.is_success()

            it "tests reverse twice is identity":
                let result = run_property_test(
                    test_fn: |list| list.reverse().reverse() == list,
                    generator: gen.list(gen.i64()),
                    config: PropertyConfig.quick()
                )
                expect result.is_success()

            it "tests string concatenation length":
                let result = run_property_test(
                    test_fn: |(s1, s2)| {
                        let concat = s1 + s2
                        return concat.length() == s1.length() + s2.length()
                    },
                    generator: gen.tuple2(gen.string(), gen.string()),
                    config: PropertyConfig.quick()
                )
                expect result.is_success()
