# Snapshot Testing Framework - Format Tests
# Tests for multi-format snapshot support

module tests.snapshot.formats_spec:
    use std.spec.{describe, context, it, expect}
    use std.spec.snapshot.formats.{get_formatter, apply_normalizations}
    use std.spec.snapshot.formats.{TextFormatter, JsonFormatter, YamlFormatter, HtmlFormatter, Base64Formatter}

    describe "Snapshot Formats":
        context("Text Formatter"):
            it "serializes values to string":
                let formatter = TextFormatter()
                let result = formatter.serialize("Hello, World!")

                expect result.is_ok()
                expect result.unwrap() == "Hello, World!"

            it "normalizes line endings":
                let formatter = TextFormatter()
                let content = "line1\r\nline2\r\nline3"
                let normalized = formatter.normalize(content)

                expect normalized == "line1\nline2\nline3"

            it "trims trailing whitespace":
                let formatter = TextFormatter()
                let content = "line1   \nline2  \nline3 "
                let normalized = formatter.normalize(content)

                expect(normalized).to_not_contain("   ")

        context("JSON Formatter"):
            it "serializes to pretty JSON":
                let formatter = JsonFormatter.new()
                let value = {"name": "Alice", "age": 30}
                let result = formatter.serialize(value)

                expect result.is_ok()
                let json = result.unwrap()
                expect "name" in json
                expect "Alice" in json

            it "serializes to compact JSON":
                let formatter = JsonFormatter.compact()
                let value = {"name": "Alice", "age": 30}
                let result = formatter.serialize(value)

                expect result.is_ok()
                let json = result.unwrap()
                expect(json).to_not_contain("\n")

            it "normalizes JSON formatting":
                let formatter = JsonFormatter.new()
                let unnormalized = '{"name":"Alice","age":30}'
                let normalized = formatter.normalize(unnormalized)

                # Should be pretty-printed
                expect "\n" in normalized

        context("YAML Formatter"):
            it "serializes to YAML":
                let formatter = YamlFormatter()
                let value = {"name": "Alice", "age": 30}
                let result = formatter.serialize(value)

                expect result.is_ok()
                let yaml = result.unwrap()
                expect "name: Alice" in yaml

            it "normalizes YAML formatting":
                let formatter = YamlFormatter()
                let unnormalized = "name:Alice\nage:30"
                let normalized = formatter.normalize(unnormalized)

                # Should have proper spacing
                expect "name: Alice" in normalized

        context("HTML Formatter"):
            it "prettifies HTML":
                let formatter = HtmlFormatter.new()
                let html = "<div><span>Hello</span></div>"
                let result = formatter.serialize(html)

                expect result.is_ok()
                let pretty = result.unwrap()
                # Should be indented
                expect "\n" in pretty

            it "normalizes whitespace in HTML":
                let formatter = HtmlFormatter.new()
                let html = "<div>\r\n\t<span>Hello</span>\r\n</div>"
                let normalized = formatter.normalize(html)

                expect(normalized).to_not_contain("\r")
                expect(normalized).to_not_contain("\t")

        context("Base64 Formatter"):
            it "encodes binary data":
                let formatter = Base64Formatter()
                let data = [72, 101, 108, 108, 111]  # "Hello" in ASCII
                let result = formatter.serialize(data)

                expect result.is_ok()
                let encoded = result.unwrap()
                expect(encoded).to_be_instance_of(String)

            it "decodes Base64 strings":
                let formatter = Base64Formatter()
                let encoded = "SGVsbG8="  # "Hello" in Base64
                let result = formatter.deserialize(encoded)

                expect result.is_ok()

        context("Format Selection"):
            it "gets formatter by name - text":
                let formatter = get_formatter("text")
                expect(formatter).to_be_instance_of(TextFormatter)

            it "gets formatter by name - json":
                let formatter = get_formatter("json")
                expect(formatter).to_be_instance_of(JsonFormatter)

            it "gets formatter by name - yaml":
                let formatter = get_formatter("yaml")
                expect(formatter).to_be_instance_of(YamlFormatter)

            it "gets formatter by name - html":
                let formatter = get_formatter("html")
                expect(formatter).to_be_instance_of(HtmlFormatter)

            it "defaults to text for unknown format":
                let formatter = get_formatter("unknown")
                expect(formatter).to_be_instance_of(TextFormatter)

        context("Normalization"):
            it "normalizes ISO timestamps":
                let content = "created_at: 2025-12-24T10:30:00Z"
                let normalized = apply_normalizations(
                    content,
                    normalize_timestamps: true,
                    normalize_ids: false
                )

                expect "<TIMESTAMP>" in normalized
                expect(normalized).to_not_contain("2025-12-24")

            it "normalizes Unix timestamps":
                let content = "timestamp: 1703419800"
                let normalized = apply_normalizations(
                    content,
                    normalize_timestamps: true,
                    normalize_ids: false
                )

                expect "<TIMESTAMP>" in normalized

            it "normalizes UUIDs":
                let content = "id: 550e8400-e29b-41d4-a716-446655440000"
                let normalized = apply_normalizations(
                    content,
                    normalize_timestamps: false,
                    normalize_ids: true
                )

                expect "<UUID>" in normalized
                expect(normalized).to_not_contain("550e8400")

            it "normalizes sequential IDs":
                let content = '"id": 12345'
                let normalized = apply_normalizations(
                    content,
                    normalize_timestamps: false,
                    normalize_ids: true
                )

                expect "<ID-" in normalized

            it "applies multiple normalizations":
                let content = """
                {
                  "id": 42,
                  "uuid": "550e8400-e29b-41d4-a716-446655440000",
                  "created_at": "2025-12-24T10:30:00Z"
                }
                """
                let normalized = apply_normalizations(
                    content,
                    normalize_timestamps: true,
                    normalize_ids: true
                )

                expect "<ID-" in normalized
                expect "<UUID>" in normalized
                expect "<TIMESTAMP>" in normalized
