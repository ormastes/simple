# Snapshot Testing Framework - Basic Tests
# Tests for core snapshot functionality

module tests.snapshot.basic_spec:
    use std.spec.{describe, context, it, expect}
    use std.spec.snapshot.{expect_snapshot, expect_snapshot_named, SnapshotConfig}
    use std.spec.snapshot.{SnapshotTestResult}
    use std.spec.snapshot.storage.{SnapshotFile, load_snapshot, save_snapshot, snapshot_exists}

    describe "Snapshot Testing Framework":
        context("Basic Snapshot Creation"):
            it "creates snapshot file with metadata":
                let snapshot = SnapshotFile.new(
                    test_file: "test/example_spec.spl",
                    test_name: "test_basic",
                    content: "Hello, World!",
                    format: "text"
                )

                expect snapshot.test_name == "test_basic"
                expect snapshot.content == "Hello, World!"
                expect snapshot.format == "text"
                expect(snapshot.created_at).to_not_be_empty()

            it "generates correct snapshot file path":
                let snapshot = SnapshotFile.new(
                    test_file: "test/user_service_spec.spl",
                    test_name: "test_render_user",
                    content: "",
                    format: "json"
                )

                let path = snapshot.get_path(".snapshots")
                expect path == ".snapshots/user_service_spec/test_render_user.snap"

            it "serializes to file format with header":
                let snapshot = SnapshotFile.new(
                    test_file: "test/example.spl",
                    test_name: "test_example",
                    content: "test content",
                    format: "text"
                )

                let file_content = snapshot.to_file_format()

                expect "# Snapshot: test_example" in file_content
                expect "# Format: text" in file_content
                expect "test content" in file_content

            it "parses from file format":
                let file_content = """
# Snapshot: test_example
# Created: 2025-12-24 00:00:00 UTC
# Updated: 2025-12-24 00:00:00 UTC
# Format: json

{"key": "value"}
"""
                let result = SnapshotFile.from_file_format(
                    file_content,
                    "test/example.spl",
                    "test_example"
                )

                expect result.is_ok()
                let snapshot = result.unwrap()
                expect snapshot.content == '{"key": "value"}'
                expect snapshot.format == "json"

        context("Snapshot Storage"):
            it "checks if snapshot exists":
                # Assuming no snapshot exists initially
                let exists = snapshot_exists(
                    "test/nonexistent.spl",
                    "test_missing",
                    ".snapshots"
                )
                expect not exists

            it "saves and loads snapshot":
                let snapshot = SnapshotFile.new(
                    test_file: "test/temp_test.spl",
                    test_name: "test_save_load",
                    content: "test data",
                    format: "text"
                )

                # Save
                let save_result = save_snapshot(snapshot, ".snapshots_test")
                expect save_result.is_ok()

                # Load
                let load_result = load_snapshot(
                    "test/temp_test.spl",
                    "test_save_load",
                    ".snapshots_test"
                )
                expect load_result.is_ok()

                let loaded = load_result.unwrap()
                expect loaded.content == "test data"

        context("Snapshot Configuration"):
            it "creates default configuration":
                let config = SnapshotConfig.default()

                expect config.format == "text"
                expect not config.normalize
                expect not config.update_snapshots
                expect config.snapshot_dir == ".snapshots"

            it "uses builder pattern for configuration":
                let config = SnapshotConfig.default()
                    .with_name("custom_name")
                    .with_format("json")
                    .with_normalization()

                expect config.name == Some("custom_name")
                expect config.format == "json"
                expect config.normalize
                expect config.normalize_ids
                expect config.normalize_timestamps

            it "respects CI environment":
                env.set("CI", "true")
                let config = from_env()
                expect not config.update_snapshots
                env.unset("CI")

            it "respects update environment variable":
                env.set("SIMPLE_UPDATE_SNAPSHOTS", "1")
                let config = from_env()
                expect config.update_snapshots
                env.unset("SIMPLE_UPDATE_SNAPSHOTS")

        context("expect_snapshot Function"):
            it "fails when snapshot doesn't exist (no update mode)":
                let config = SnapshotConfig.default()
                let result = expect_snapshot("test output", config)

                expect result.is_fail()

            it "creates snapshot on first run (update mode)":
                let config = SnapshotConfig.default()
                    .with_name("test_first_run")
                    .with_update()

                let result = expect_snapshot("test output", config)

                match result:
                    SnapshotTestResult.Created(name) ->
                        expect name == "test_first_run"
                    _ ->
                        fail("Expected Created result")

            it "passes when snapshot matches":
                # Assuming snapshot exists and matches
                let config = SnapshotConfig.default()
                    .with_name("test_matching")

                # First create the snapshot
                save_snapshot(
                    SnapshotFile.new(
                        "test/current.spl",
                        "test_matching",
                        "expected output",
                        "text"
                    ),
                    ".snapshots"
                )

                # Now test it matches
                let result = expect_snapshot("expected output", config)
                expect result.is_pass()

            it "fails when snapshot doesn't match":
                # Create snapshot with one value
                save_snapshot(
                    SnapshotFile.new(
                        "test/current.spl",
                        "test_mismatch",
                        "expected output",
                        "text"
                    ),
                    ".snapshots"
                )

                let config = SnapshotConfig.default()
                    .with_name("test_mismatch")

                # Test with different value
                let result = expect_snapshot("different output", config)

                match result:
                    SnapshotTestResult.Fail(name, diff) ->
                        expect name == "test_mismatch"
                        expect "Snapshot mismatch" in diff
                    _ ->
                        fail("Expected Fail result")

            it "updates snapshot in update mode":
                # Create initial snapshot
                save_snapshot(
                    SnapshotFile.new(
                        "test/current.spl",
                        "test_update",
                        "old output",
                        "text"
                    ),
                    ".snapshots"
                )

                let config = SnapshotConfig.default()
                    .with_name("test_update")
                    .with_update()

                # Update with new value
                let result = expect_snapshot("new output", config)

                match result:
                    SnapshotTestResult.Updated(name) ->
                        expect name == "test_update"
                    _ ->
                        fail("Expected Updated result")
