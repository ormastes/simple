# Snapshot Testing Framework - Comparison Tests
# Tests for snapshot comparison and diff generation

module tests.snapshot.comparison_spec:
    use std.spec.{describe, context, it, expect}
    use std.spec.snapshot.comparison.{compare_snapshots, generate_unified_diff, ComparisonResult}

    describe "Snapshot Comparison":
        context("Basic Comparison"):
            it "matches identical snapshots":
                let expected = "Hello, World!"
                let actual = "Hello, World!"

                let result = compare_snapshots(
                    expected,
                    actual,
                    "test_match",
                    "text"
                )

                expect result.is_match()

            it "detects mismatches":
                let expected = "Hello, World!"
                let actual = "Hello, Universe!"

                let result = compare_snapshots(
                    expected,
                    actual,
                    "test_mismatch",
                    "text"
                )

                expect result.is_mismatch()

            it "normalizes whitespace before comparison":
                let expected = "Hello, World!  "
                let actual = "Hello, World!"

                let result = compare_snapshots(
                    expected,
                    actual,
                    "test_whitespace",
                    "text"
                )

                # Should match after normalization
                expect result.is_match()

        context("Multi-line Comparison"):
            it "compares multi-line content":
                let expected = "line1\nline2\nline3"
                let actual = "line1\nline2\nline3"

                let result = compare_snapshots(
                    expected,
                    actual,
                    "test_multiline",
                    "text"
                )

                expect result.is_match()

            it "detects line differences":
                let expected = "line1\nline2\nline3"
                let actual = "line1\nmodified\nline3"

                let result = compare_snapshots(
                    expected,
                    actual,
                    "test_line_diff",
                    "text"
                )

                expect result.is_mismatch()

        context("Unified Diff Generation"):
            it "generates diff for simple change":
                let expected = "Hello, World!"
                let actual = "Hello, Universe!"

                let diff = generate_unified_diff(
                    expected,
                    actual,
                    "test_simple_diff"
                )

                expect "Snapshot mismatch" in diff
                expect "--- Expected" in diff
                expect "+++ Actual" in diff

            it "shows added lines with + prefix":
                let expected = "line1\nline2"
                let actual = "line1\nline2\nline3"

                let diff = generate_unified_diff(
                    expected,
                    actual,
                    "test_added"
                )

                expect "+line3" in diff

            it "shows removed lines with - prefix":
                let expected = "line1\nline2\nline3"
                let actual = "line1\nline3"

                let diff = generate_unified_diff(
                    expected,
                    actual,
                    "test_removed"
                )

                expect "-line2" in diff

            it "shows changed lines":
                let expected = "line1\nold line\nline3"
                let actual = "line1\nnew line\nline3"

                let diff = generate_unified_diff(
                    expected,
                    actual,
                    "test_changed"
                )

                expect "-old line" in diff
                expect "+new line" in diff

            it "includes line numbers in hunks":
                let expected = "line1\nline2\nline3\nline4"
                let actual = "line1\nmodified\nline3\nline4"

                let diff = generate_unified_diff(
                    expected,
                    actual,
                    "test_line_numbers"
                )

                expect "@@" in diff  # Hunk header

        context("Comparison Result Formatting"):
            it "formats match result":
                let result = ComparisonResult.Match
                let formatted = format_comparison_result(result)

                expect "âœ“" in formatted
                expect "matches" in formatted

            it "formats mismatch result with diff":
                let expected = "old"
                let actual = "new"

                let result = compare_snapshots(
                    expected,
                    actual,
                    "test_format",
                    "text"
                )

                let formatted = format_comparison_result(result)

                expect "Snapshot mismatch" in formatted
                expect "Summary" in formatted
                expect "--snapshot-update" in formatted

            it "includes update command in mismatch":
                let result = compare_snapshots(
                    "old",
                    "new",
                    "test_update_cmd",
                    "text"
                )

                let formatted = format_comparison_result(result)

                expect "simple test --snapshot-update=test_update_cmd" in formatted

        context("Diff Statistics"):
            it "counts added lines":
                let result = compare_snapshots(
                    "line1",
                    "line1\nline2",
                    "test_stats_added",
                    "text"
                )

                match result:
                    ComparisonResult.Mismatch(_, context) ->
                        expect(context.added_lines).to_be_gt(0)
                    _ ->
                        fail("Expected mismatch")

            it "counts removed lines":
                let result = compare_snapshots(
                    "line1\nline2",
                    "line1",
                    "test_stats_removed",
                    "text"
                )

                match result:
                    ComparisonResult.Mismatch(_, context) ->
                        expect(context.removed_lines).to_be_gt(0)
                    _ ->
                        fail("Expected mismatch")

            it "counts changed lines":
                let result = compare_snapshots(
                    "old line",
                    "new line",
                    "test_stats_changed",
                    "text"
                )

                match result:
                    ComparisonResult.Mismatch(_, context) ->
                        let summary = context.summary()
                        expect "+" in summary
                        expect "-" in summary
                    _ ->
                        fail("Expected mismatch")
