# Unit tests for doctest matcher
# Tests the MatchResult enum and matching functions

use doctest.matcher.*
use doctest.parser.Expected

describe "MatchResult":
    context "Pass variant":
        it "reports as pass":
            val result = MatchResult::Pass
            expect result.is_pass() to_be true
            expect result.is_fail() to_be false

        it "converts to string":
            val result = MatchResult::Pass
            expect result.to_string() to_be "Pass"

        it "provides description":
            val result = MatchResult::Pass
            expect result.description() to_be "Test output matched expected"

        it "provides summary":
            val result = MatchResult::Pass
            expect result.summary() to_be "MatchResult: Pass"

    context "Fail variant":
        it "reports as fail":
            val result = MatchResult::Fail("mismatch")
            expect result.is_pass() to_be false
            expect result.is_fail() to_be true

        it "provides failure message":
            val result = MatchResult::Fail("output mismatch")
            expect result.get_failure_message() to_be Some("output mismatch")

        it "unwraps failure message":
            val result = MatchResult::Fail("test error")
            expect result.unwrap_failure() to_be "test error"

        it "converts to string":
            val result = MatchResult::Fail("error")
            expect result.to_string() to_be "Fail"

describe "exact_match":
    it "matches identical strings":
        expect exact_match("hello", "hello") to_be true

    it "rejects different strings":
        expect exact_match("hello", "world") to_be false

    it "normalizes whitespace":
        expect exact_match("hello  ", "hello") to_be true
        expect exact_match("  hello", "hello") to_be true

describe "normalize":
    it "trims trailing whitespace":
        expect normalize("hello  ") to_be "hello"

    it "trims leading and trailing whitespace":
        expect normalize("  hello  ") to_be "hello"

    it "preserves internal whitespace":
        expect normalize("hello world") to_be "hello world"

describe "wildcard_match":
    it "matches with dot wildcard":
        expect wildcard_match("hello", "h.llo") to_be true
        expect wildcard_match("hello", "h..lo") to_be true

    it "matches with star wildcard":
        expect wildcard_match("hello", "h*o") to_be true
        expect wildcard_match("hello world", "hello*") to_be true

    it "rejects non-matching patterns":
        expect wildcard_match("hello", "h.x") to_be false
        expect wildcard_match("hello", "world*") to_be false

describe "match_output":
    context "with empty expected":
        it "passes for empty output":
            val result = match_output("", Expected::Empty)
            expect result.is_pass() to_be true

        it "passes for whitespace-only output":
            val result = match_output("   ", Expected::Empty)
            expect result.is_pass() to_be true

        it "fails for non-empty output":
            val result = match_output("hello", Expected::Empty)
            expect result.is_fail() to_be true

    context "with expected output":
        it "passes for exact match":
            val result = match_output("hello", Expected::Output("hello"))
            expect result.is_pass() to_be true

        it "passes for wildcard match":
            val result = match_output("hello", Expected::Output("h*o"))
            expect result.is_pass() to_be true

        it "fails for mismatch":
            val result = match_output("hello", Expected::Output("world"))
            expect result.is_fail() to_be true

describe "match_exception":
    context "with expected exception":
        it "passes for matching exception type":
            val result = match_exception("ValueError", "bad value", Expected::Exception("ValueError", None))
            expect result.is_pass() to_be true

        it "passes for matching type and message":
            val result = match_exception("ValueError", "bad value found", Expected::Exception("ValueError", Some("bad value")))
            expect result.is_pass() to_be true

        it "fails for wrong exception type":
            val result = match_exception("TypeError", "wrong type", Expected::Exception("ValueError", None))
            expect result.is_fail() to_be true

describe "format_mismatch":
    it "formats mismatch message":
        val msg = format_mismatch("actual", "expected")
        expect msg.contains("Expected") to_be true
        expect msg.contains("Got") to_be true
        expect msg.contains("actual") to_be true
        expect msg.contains("expected") to_be true
