/// Unit tests for doctest runner

import test.unit.*
import std.doctest.runner.*
import std.doctest.parser.*

describe "DoctestRunner":
    context "run_example":
        it "runs simple example and passes":
            let runner = DoctestRunner.new()
            example = DoctestExample(
                source: "test",
                location: SourceLocation(file: "test", line: 1),
                setup: [],
                code: ["1 + 1"],
                expected: Expected.Output("2"),
                teardown: [],
                tags: Set.new(),
                mode: "inline",
                timeout_ms: 5000
            )
            
            result = runner.run_example(example)
            expect result.passed() to be True
        
        it "fails on wrong output":
            let runner = DoctestRunner.new()
            example = DoctestExample(
                source: "test",
                location: SourceLocation(file: "test", line: 1),
                setup: [],
                code: ["1 + 1"],
                expected: Expected.Output("3"),  # Wrong
                teardown: [],
                tags: Set.new(),
                mode: "inline",
                timeout_ms: 5000
            )
            
            result = runner.run_example(example)
            expect result.passed() to be False
        
        it "runs setup before main code":
            let runner = DoctestRunner.new()
            example = DoctestExample(
                source: "test",
                location: SourceLocation(file: "test", line: 1),
                setup: ["x = 1"],
                code: ["x + 1"],
                expected: Expected.Output("2"),
                teardown: [],
                tags: Set.new(),
                mode: "inline",
                timeout_ms: 5000
            )
            
            result = runner.run_example(example)
            expect result.passed() to be True
        
        it "runs teardown after main code":
            let runner = DoctestRunner.new()
            example = DoctestExample(
                source: "test",
                location: SourceLocation(file: "test", line: 1),
                setup: ["db = Database.connect()"],
                code: ["db.query('SELECT 1')"],
                expected: Expected.Output("1"),
                teardown: ["db.close()"],
                tags: Set.new(),
                mode: "inline",
                timeout_ms: 5000
            )
            
            result = runner.run_example(example)
            # Verify teardown was called (mocked)
            expect result.passed() to be True
        
        it "captures exceptions":
            let runner = DoctestRunner.new()
            example = DoctestExample(
                source: "test",
                location: SourceLocation(file: "test", line: 1),
                setup: [],
                code: ["1 / 0"],
                expected: Expected.Exception("DivisionByZero", Option.None),
                teardown: [],
                tags: Set.new(),
                mode: "inline",
                timeout_ms: 5000
            )
            
            result = runner.run_example(example)
            expect result.passed() to be True
        
        it "fails if setup throws":
            let runner = DoctestRunner.new()
            example = DoctestExample(
                source: "test",
                location: SourceLocation(file: "test", line: 1),
                setup: ["raise ValueError('setup failed')"],
                code: ["1 + 1"],
                expected: Expected.Output("2"),
                teardown: [],
                tags: Set.new(),
                mode: "inline",
                timeout_ms: 5000
            )
            
            result = runner.run_example(example)
            expect result.passed() to be False
            match result.result:
                case MatchResult.Fail(msg):
                    expect msg to include "Setup failed"
    
    context "run_examples":
        it "runs multiple examples":
            let runner = DoctestRunner.new()
            examples = [
                DoctestExample(
                    source: "test",
                    location: SourceLocation(file: "test", line: 1),
                    setup: [],
                    code: ["1 + 1"],
                    expected: Expected.Output("2"),
                    teardown: [],
                    tags: Set.new(),
                    mode: "inline",
                    timeout_ms: 5000
                ),
                DoctestExample(
                    source: "test",
                    location: SourceLocation(file: "test", line: 3),
                    setup: [],
                    code: ["2 + 2"],
                    expected: Expected.Output("4"),
                    teardown: [],
                    tags: Set.new(),
                    mode: "inline",
                    timeout_ms: 5000
                )
            ]
            
            results = runner.run_examples(examples)
            expect results.len to eq 2
            expect results[0].passed() to be True
            expect results[1].passed() to be True
        
        it "reports individual failures":
            let runner = DoctestRunner.new()
            examples = [
                DoctestExample(
                    source: "test",
                    location: SourceLocation(file: "test", line: 1),
                    setup: [],
                    code: ["1 + 1"],
                    expected: Expected.Output("2"),
                    teardown: [],
                    tags: Set.new(),
                    mode: "inline",
                    timeout_ms: 5000
                ),
                DoctestExample(
                    source: "test",
                    location: SourceLocation(file: "test", line: 3),
                    setup: [],
                    code: ["2 + 2"],
                    expected: Expected.Output("5"),  # Wrong
                    teardown: [],
                    tags: Set.new(),
                    mode: "inline",
                    timeout_ms: 5000
                )
            ]
            
            results = runner.run_examples(examples)
            expect results.len to eq 2
            expect results[0].passed() to be True
            expect results[1].passed() to be False
