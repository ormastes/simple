# Integration test for macros with other language features

# Basic integration macros
macro utils_double(n: Int const) -> (returns result: Int):
    const_eval:
        let doubled = n * 2
    emit result:
        {doubled}

macro make_test_helper(name: Str const) -> (
    intro func:
        enclosing.module.fn "test_{name}"() -> Bool
):
    emit func:
        fn "test_{name}"() -> Bool:
            return true

make_test_helper!("example")

macro unpack_pair(name: Str const) -> (
    intro func:
        enclosing.module.fn "{name}"(pair: (Int, Int)) -> Int
):
    emit func:
        fn "{name}"(pair: (Int, Int)) -> Int:
            let (a, b) = pair
            return a + b

unpack_pair!("sum_pair")

macro make_identity(name: Str const) -> (
    intro func:
        enclosing.module.fn "{name}"(value: Int) -> Int
):
    emit func:
        fn "{name}"(value: Int) -> Int:
            return value

make_identity!("identity")

# Generator macros for data structures
macro make_range_generator(name: Str const, limit: Int const) -> (
    intro func:
        enclosing.module.fn "{name}"() -> List[Int]
):
    const_eval:
        let squares = []
        for i in 0..limit:
            squares.append(i * i)
    emit func:
        fn "{name}"() -> List[Int]:
            return {squares}

make_range_generator!("get_squares", 5)

# Property/builder pattern support
macro add_getter(field: Str const) -> (
    intro func:
        enclosing.module.fn "get_{field}"() -> Int
):
    emit func:
        fn "get_{field}"() -> Int:
            return _{field}

macro add_setter(field: Str const) -> (
    intro func:
        enclosing.module.fn "set_{field}"(value: Int) -> ()
):
    emit func:
        fn "set_{field}"(value: Int) -> ():
            _{field} = value

# Initialize storage
let _value = 0

add_getter!("value")
add_setter!("value")

describe "Macro Integration":
    describe "Basic integration":
        it "uses macros in test helpers":
            expect test_example() == true

        it "uses simple macro results":
            expect utils_double!(5) == 10

    describe "Pattern matching integration":
        it "uses destructuring in macro expansion":
            expect sum_pair((10, 20)) == 30

    describe "Generic-like behavior":
        it "generates identity function":
            expect identity(42) == 42

    describe "List generation":
        it "uses list comprehension-like macros":
            let result = get_squares()
            expect result.len() == 5
            expect result[0] == 0
            expect result[1] == 1
            expect result[2] == 4
            expect result[3] == 9
            expect result[4] == 16

    describe "Property pattern":
        it "implements getter/setter pattern":
            set_value(42)
            expect get_value() == 42
            set_value(100)
            expect get_value() == 100
