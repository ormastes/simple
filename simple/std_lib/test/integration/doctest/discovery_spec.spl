# Integration tests for doctest discovery
# Tests DiscoveryConfig and discovery functions

use doctest.discovery.*
use doctest.parser.DoctestExample

describe "DiscoveryConfig":
    context "default configuration":
        it "has default search paths":
            val config = DiscoveryConfig.default()
            expect config.get_search_paths().len() to_be 3
            expect config.has_search_path("lib/") to_be true
            expect config.has_search_path("src/") to_be true
            expect config.has_search_path("doc/") to_be true

        it "has default include patterns":
            val config = DiscoveryConfig.default()
            val patterns = config.get_include_patterns()
            expect patterns.len() to_be 3

        it "has default exclude patterns":
            val config = DiscoveryConfig.default()
            val patterns = config.get_exclude_patterns()
            expect patterns.len() to_be 2

    context "configuration modification":
        it "adds search path":
            val config = DiscoveryConfig.default()
                .add_search_path("tests/")
            expect config.has_search_path("tests/") to_be true
            expect config.get_search_paths().len() to_be 4

        it "adds include pattern":
            val config = DiscoveryConfig.default()
                .add_include_pattern("**/*.rst")
            val patterns = config.get_include_patterns()
            expect patterns.len() to_be 4

        it "adds exclude pattern":
            val config = DiscoveryConfig.default()
                .add_exclude_pattern("**/cache/**")
            val patterns = config.get_exclude_patterns()
            expect patterns.len() to_be 3

    context "summary":
        it "provides configuration summary":
            val config = DiscoveryConfig.default()
            val summary = config.summary()
            expect summary.contains("search paths") to_be true
            expect summary.contains("include patterns") to_be true
            expect summary.contains("exclude patterns") to_be true

describe "File Discovery":
    context "discover_file function":
        it "returns empty list for unknown extensions":
            val found = discover_file("unknown.xyz")
            expect found.len() to_be 0

        it "recognizes spl files":
            val found = discover_file("test.spl")
            expect found.is_list() to_be true

        it "recognizes md files":
            val found = discover_file("test.md")
            expect found.is_list() to_be true

describe "Pattern Matching":
    context "should_exclude function":
        it "excludes paths matching target pattern":
            val exclude_patterns = ["**/target/**"]
            expect should_exclude("project/target/debug/test.spl", exclude_patterns) to_be true

        it "does not exclude non-matching paths":
            val exclude_patterns = ["**/target/**", "**/build/**"]
            expect should_exclude("src/lib/module.spl", exclude_patterns) to_be false

    context "matches_any_pattern function":
        it "matches spl files":
            val include_patterns = ["**/*.spl"]
            expect matches_any_pattern("src/module.spl", include_patterns) to_be true

        it "does not match non-matching extensions":
            val include_patterns = ["**/*.spl"]
            expect matches_any_pattern("src/module.rs", include_patterns) to_be false

describe "Full Discovery":
    context "discover_all function":
        it "returns a list":
            val config = DiscoveryConfig.default()
            val found = discover_all(config)
            expect found.is_list() to_be true
