# Call Flow Profiling End-to-End Tests
#
# Tests the call flow profiling and mermaid diagram generation
# Run with: simple test --diagram-all simple/std_lib/test/integration/diagram/call_flow_profiling_spec.spl

import std.spec.{describe, context, it, expect, eq, be, include_string}
import std.spec.diagram.{enable_ffi_recording, disable_ffi_recording, clear_ffi_recording, trace_method, trace_call, trace_return, mark_architectural, generate_sequence_ffi, generate_class_ffi, generate_arch_ffi}

describe "Call Flow Profiling":
    it "traces simple function calls and generates diagrams":
        clear_ffi_recording()
        enable_ffi_recording()

        # Manually trace calls
        trace_call("main")
        trace_call("helper")
        trace_return(Some("result"))

        # Trace method calls
        trace_method("Calculator", "add", ["1", "2"])
        trace_return(Some("3"))

        let diagram = generate_sequence_ffi()
        disable_ffi_recording()

        expect(diagram).to(include_string("sequenceDiagram"))
        expect(diagram).to(include_string("main"))
        expect(diagram).to(include_string("helper"))
        expect(diagram).to(include_string("Calculator"))
