# Screenshot FFI Integration Tests
#
# Tests the screenshot capture FFI with terminal buffer capture

import std.spec
import std.spec.screenshot

describe "Screenshot FFI":
    context "Control Functions":
        it "enables and disables screenshot capture":
            disable_ffi_screenshots()
            expect is_ffi_screenshots_enabled() == false

            enable_ffi_screenshots()
            expect is_ffi_screenshots_enabled() == true

            disable_ffi_screenshots()
            expect is_ffi_screenshots_enabled() == false

        it "sets refresh mode":
            set_ffi_refresh(true)
            set_ffi_refresh(false)
            # No assertion needed - just verifies FFI calls work

    context "Output Directory":
        it "sets output directory":
            set_ffi_output_dir("doc/spec/test_images")
            # No assertion needed - just verifies FFI calls work
            # Reset to default
            set_ffi_output_dir("doc/spec/image")

    context "Test Context":
        it "sets and clears test context":
            set_ffi_test_context("test/unit/ui/button_spec.spl", "renders button")
            clear_ffi_test_context()
            # No assertion needed - just verifies FFI calls work

        it "generates correct paths from context":
            enable_ffi_screenshots()
            set_ffi_output_dir("doc/spec/image")
            set_ffi_test_context("test/unit/ui/button_spec.spl", "renders button")

            val before_path = get_screenshot_path_ffi(CAPTURE_TYPE_BEFORE)
            val after_path = get_screenshot_path_ffi(CAPTURE_TYPE_AFTER)

            # Paths should contain the test name
            expect before_path.contains("renders_button") == true
            expect before_path.contains("before") == true
            expect after_path.contains("after") == true

            clear_ffi_test_context()
            disable_ffi_screenshots()

    context "Terminal Buffer Capture":
        it "captures before terminal buffer":
            enable_ffi_screenshots()
            set_ffi_test_context("test/unit/ui/text_spec.spl", "displays text")

            val buffer = "Hello, World!\nThis is a test."
            val result = capture_before_ffi(buffer)

            # May be false if directory doesn't exist, but FFI call should succeed
            clear_ffi_captures()
            clear_ffi_test_context()
            disable_ffi_screenshots()

        it "captures after terminal buffer":
            enable_ffi_screenshots()
            set_ffi_test_context("test/unit/ui/text_spec.spl", "displays text")

            val buffer = "After state\nWith changes."
            val result = capture_after_ffi(buffer)

            clear_ffi_captures()
            clear_ffi_test_context()
            disable_ffi_screenshots()

    context "ANSI Buffer Capture":
        it "captures ANSI formatted terminal output":
            enable_ffi_screenshots()
            set_ffi_test_context("test/unit/ui/ansi_spec.spl", "renders colored text")

            # ANSI escape sequences for colored output (simplified for testing)
            val ansi_buffer = "Red Text\nGreen Text\nBlue Text"
            val result = capture_before_ffi(ansi_buffer)

            clear_ffi_captures()
            clear_ffi_test_context()
            disable_ffi_screenshots()

    context "Query Functions":
        it "checks if screenshot exists":
            enable_ffi_screenshots()
            set_ffi_test_context("test/nonexistent/spec.spl", "nonexistent test")

            # Should return false for non-existent screenshot
            val exists = screenshot_exists_ffi(CAPTURE_TYPE_BEFORE)
            expect exists == false

            clear_ffi_test_context()
            disable_ffi_screenshots()

    context "Real-World Example":
        it "captures TUI widget rendering":
            enable_ffi_screenshots()
            set_ffi_output_dir("doc/spec/image")
            set_ffi_test_context("test/unit/ui/tui/button_spec.spl", "renders button with border")

            # Simulate before state (empty)
            val before_buffer = """
            +------------------+
            |                  |
            |                  |
            |                  |
            +------------------+
            """
            capture_before_ffi(before_buffer)

            # Simulate after state (button rendered)
            val after_buffer = """
            +------------------+
            |   [ Click Me ]   |
            |                  |
            |   Status: OK     |
            +------------------+
            """
            capture_after_ffi(after_buffer)

            clear_ffi_captures()
            clear_ffi_test_context()
            disable_ffi_screenshots()

        it "captures multiple screenshots in sequence":
            enable_ffi_screenshots()
            set_ffi_output_dir("doc/spec/image")

            # First test
            set_ffi_test_context("test/unit/ui/list_spec.spl", "empty list")
            capture_before_ffi("[]")
            capture_after_ffi("[]")
            clear_ffi_captures()
            clear_ffi_test_context()

            # Second test
            set_ffi_test_context("test/unit/ui/list_spec.spl", "list with items")
            capture_before_ffi("[]")
            capture_after_ffi("[1, 2, 3]")
            clear_ffi_captures()
            clear_ffi_test_context()

            disable_ffi_screenshots()

