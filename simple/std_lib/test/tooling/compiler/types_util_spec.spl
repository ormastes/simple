//! SSpec tests for types_util.spl

use std.testing.sspec
use tooling.compiler.types_util

feature "TypeId to Cranelift Type Conversion":
    describe "type_id_to_cranelift function":
        it "converts VOID to I64":
            val result = type_id_to_cranelift(TypeId.VOID())
            match result:
                CraneliftType.I64:
                    assert true
                _:
                    assert false, "Expected I64 for VOID"

        it "converts BOOL to I8":
            val result = type_id_to_cranelift(TypeId.BOOL())
            match result:
                CraneliftType.I8:
                    assert true
                _:
                    assert false, "Expected I8 for BOOL"

        it "converts I8 to I8":
            val result = type_id_to_cranelift(TypeId.I8())
            match result:
                CraneliftType.I8:
                    assert true
                _:
                    assert false, "Expected I8 for I8"

        it "converts U8 to I8":
            val result = type_id_to_cranelift(TypeId.U8())
            match result:
                CraneliftType.I8:
                    assert true
                _:
                    assert false, "Expected I8 for U8"

        it "converts I16 to I16":
            val result = type_id_to_cranelift(TypeId.I16())
            match result:
                CraneliftType.I16:
                    assert true
                _:
                    assert false, "Expected I16 for I16"

        it "converts U16 to I16":
            val result = type_id_to_cranelift(TypeId.U16())
            match result:
                CraneliftType.I16:
                    assert true
                _:
                    assert false, "Expected I16 for U16"

        it "converts I32 to I32":
            val result = type_id_to_cranelift(TypeId.I32())
            match result:
                CraneliftType.I32:
                    assert true
                _:
                    assert false, "Expected I32 for I32"

        it "converts U32 to I32":
            val result = type_id_to_cranelift(TypeId.U32())
            match result:
                CraneliftType.I32:
                    assert true
                _:
                    assert false, "Expected I32 for U32"

        it "converts I64 to I64":
            val result = type_id_to_cranelift(TypeId.I64())
            match result:
                CraneliftType.I64:
                    assert true
                _:
                    assert false, "Expected I64 for I64"

        it "converts U64 to I64":
            val result = type_id_to_cranelift(TypeId.U64())
            match result:
                CraneliftType.I64:
                    assert true
                _:
                    assert false, "Expected I64 for U64"

        it "converts F32 to F32":
            val result = type_id_to_cranelift(TypeId.F32())
            match result:
                CraneliftType.F32:
                    assert true
                _:
                    assert false, "Expected F32 for F32"

        it "converts F64 to F64":
            val result = type_id_to_cranelift(TypeId.F64())
            match result:
                CraneliftType.F64:
                    assert true
                _:
                    assert false, "Expected F64 for F64"

        it "converts STRING to I64 (pointer)":
            val result = type_id_to_cranelift(TypeId.STRING())
            match result:
                CraneliftType.I64:
                    assert true
                _:
                    assert false, "Expected I64 for STRING"

        it "converts NIL to I64 (tagged value)":
            val result = type_id_to_cranelift(TypeId.NIL())
            match result:
                CraneliftType.I64:
                    assert true
                _:
                    assert false, "Expected I64 for NIL"

        it "converts custom types to I64 (default)":
            val custom_type = TypeId(id: 100)  # Custom type beyond built-ins
            val result = type_id_to_cranelift(custom_type)
            match result:
                CraneliftType.I64:
                    assert true
                _:
                    assert false, "Expected I64 for custom types"

    describe "type_id_size function":
        it "returns 0 bytes for VOID":
            val size = type_id_size(TypeId.VOID())
            assert size == 0, "VOID should be 0 bytes"

        it "returns 1 byte for BOOL":
            val size = type_id_size(TypeId.BOOL())
            assert size == 1, "BOOL should be 1 byte"

        it "returns 1 byte for I8":
            val size = type_id_size(TypeId.I8())
            assert size == 1, "I8 should be 1 byte"

        it "returns 1 byte for U8":
            val size = type_id_size(TypeId.U8())
            assert size == 1, "U8 should be 1 byte"

        it "returns 2 bytes for I16":
            val size = type_id_size(TypeId.I16())
            assert size == 2, "I16 should be 2 bytes"

        it "returns 2 bytes for U16":
            val size = type_id_size(TypeId.U16())
            assert size == 2, "U16 should be 2 bytes"

        it "returns 4 bytes for I32":
            val size = type_id_size(TypeId.I32())
            assert size == 4, "I32 should be 4 bytes"

        it "returns 4 bytes for U32":
            val size = type_id_size(TypeId.U32())
            assert size == 4, "U32 should be 4 bytes"

        it "returns 4 bytes for F32":
            val size = type_id_size(TypeId.F32())
            assert size == 4, "F32 should be 4 bytes"

        it "returns 8 bytes for I64":
            val size = type_id_size(TypeId.I64())
            assert size == 8, "I64 should be 8 bytes"

        it "returns 8 bytes for U64":
            val size = type_id_size(TypeId.U64())
            assert size == 8, "U64 should be 8 bytes"

        it "returns 8 bytes for F64":
            val size = type_id_size(TypeId.F64())
            assert size == 8, "F64 should be 8 bytes"

        it "returns 8 bytes for STRING (pointer)":
            val size = type_id_size(TypeId.STRING())
            assert size == 8, "STRING should be 8 bytes (pointer)"

        it "returns 8 bytes for NIL":
            val size = type_id_size(TypeId.NIL())
            assert size == 8, "NIL should be 8 bytes"

        it "returns 8 bytes for custom types (pointer-sized)":
            val custom_type = TypeId(id: 200)
            val size = type_id_size(custom_type)
            assert size == 8, "Custom types should be 8 bytes (pointer-sized)"

    describe "type_to_cranelift function (ABI mapping)":
        it "converts VOID to I64 for ABI compatibility":
            val result = type_to_cranelift(TypeId.VOID())
            match result:
                CraneliftType.I64:
                    assert true
                _:
                    assert false, "Expected I64 for VOID in ABI"

        it "converts BOOL to I8 for native ABI":
            val result = type_to_cranelift(TypeId.BOOL())
            match result:
                CraneliftType.I8:
                    assert true
                _:
                    assert false, "Expected I8 for BOOL in ABI"

        it "converts I64 to I64":
            val result = type_to_cranelift(TypeId.I64())
            match result:
                CraneliftType.I64:
                    assert true
                _:
                    assert false, "Expected I64 for I64 in ABI"

        it "converts F64 to F64":
            val result = type_to_cranelift(TypeId.F64())
            match result:
                CraneliftType.F64:
                    assert true
                _:
                    assert false, "Expected F64 for F64 in ABI"

    describe "CraneliftType":
        it "converts I8 to string":
            val result = CraneliftType.I8.to_string()
            assert result == "i8", "I8 should stringify to 'i8'"

        it "converts I16 to string":
            val result = CraneliftType.I16.to_string()
            assert result == "i16", "I16 should stringify to 'i16'"

        it "converts I32 to string":
            val result = CraneliftType.I32.to_string()
            assert result == "i32", "I32 should stringify to 'i32'"

        it "converts I64 to string":
            val result = CraneliftType.I64.to_string()
            assert result == "i64", "I64 should stringify to 'i64'"

        it "converts F32 to string":
            val result = CraneliftType.F32.to_string()
            assert result == "f32", "F32 should stringify to 'f32'"

        it "converts F64 to string":
            val result = CraneliftType.F64.to_string()
            assert result == "f64", "F64 should stringify to 'f64'"

    describe "TypeId equality":
        it "compares VOID types as equal":
            assert TypeId.VOID().equals(TypeId.VOID()), "VOID should equal VOID"

        it "compares different types as not equal":
            assert not TypeId.BOOL().equals(TypeId.I8()), "BOOL should not equal I8"

        it "compares I32 types as equal":
            assert TypeId.I32().equals(TypeId.I32()), "I32 should equal I32"

        it "compares custom types correctly":
            val type1 = TypeId(id: 42)
            val type2 = TypeId(id: 42)
            val type3 = TypeId(id: 43)
            assert type1.equals(type2), "Same ID should be equal"
            assert not type1.equals(type3), "Different IDs should not be equal"

feature "Type System Coverage":
    describe "Complete type mapping coverage":
        it "covers all 14 built-in types for type_id_to_cranelift":
            # Ensure no type falls through to default without being tested
            val void_result = type_id_to_cranelift(TypeId.VOID())
            val bool_result = type_id_to_cranelift(TypeId.BOOL())
            val i8_result = type_id_to_cranelift(TypeId.I8())
            val i16_result = type_id_to_cranelift(TypeId.I16())
            val i32_result = type_id_to_cranelift(TypeId.I32())
            val i64_result = type_id_to_cranelift(TypeId.I64())
            val u8_result = type_id_to_cranelift(TypeId.U8())
            val u16_result = type_id_to_cranelift(TypeId.U16())
            val u32_result = type_id_to_cranelift(TypeId.U32())
            val u64_result = type_id_to_cranelift(TypeId.U64())
            val f32_result = type_id_to_cranelift(TypeId.F32())
            val f64_result = type_id_to_cranelift(TypeId.F64())
            val string_result = type_id_to_cranelift(TypeId.STRING())
            val nil_result = type_id_to_cranelift(TypeId.NIL())
            # All conversions succeeded without errors
            assert true

        it "covers all 14 built-in types for type_id_size":
            val total_size = (
                type_id_size(TypeId.VOID()) +
                type_id_size(TypeId.BOOL()) +
                type_id_size(TypeId.I8()) +
                type_id_size(TypeId.I16()) +
                type_id_size(TypeId.I32()) +
                type_id_size(TypeId.I64()) +
                type_id_size(TypeId.U8()) +
                type_id_size(TypeId.U16()) +
                type_id_size(TypeId.U32()) +
                type_id_size(TypeId.U64()) +
                type_id_size(TypeId.F32()) +
                type_id_size(TypeId.F64()) +
                type_id_size(TypeId.STRING()) +
                type_id_size(TypeId.NIL())
            )
            # 0 + 1 + 1 + 2 + 4 + 8 + 1 + 2 + 4 + 8 + 4 + 8 + 8 + 8 = 59
            assert total_size == 59, "Total size of all built-in types should be 59 bytes"
