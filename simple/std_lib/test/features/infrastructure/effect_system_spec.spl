# Effect System Specification
# Feature #201: Automatic async/sync effect inference
# Category: Infrastructure | Difficulty: 4 | Status: Complete

"""
# Effect System (Async/Sync Inference)

**Feature ID:** #201
**Category:** Infrastructure - Type System
**Difficulty:** 4/5
**Status:** Complete

## Overview

The Effect System automatically infers whether functions are synchronous or asynchronous
based on their implementation, implementing Simple's async-by-default concurrency model.

## Key Features

- **Automatic Effect Inference:** No manual async/await annotations required
- **Suspension Detection:** Identifies await, if~, while~, for~ operators
- **Effect Propagation:** Calling async functions makes caller async
- **Promise Wrapping:** Auto-wraps return types in Promise<T>
- **Sync Constraints:** Validates sync annotated functions

## Implementation

**Primary Files:**
- `src/type/src/effects.rs` - Effect inference algorithm

**Verification:**
- `verification/type_inference_compile/src/AsyncEffectInference.lean` - Lean 4 proofs

**Dependencies:**
- Feature #2: Parser
- Feature #100: Type Inference

**Required By:**
- Feature #4: HIR
- Feature #107: Interpreter
"""
import std.spec

describe "Sync function detection":
    it "infers pure functions as sync":
        """
        **Given** pure computation function
        **When** effect inference runs
        **Then** infers Sync effect

        **Verification:** Pure function is sync
        """
        fn add(a: i64, b: i64) -> i64:
            return a + b

        val result = add(2, 3)
        expect(result).to(eq(5))

    it "respects explicit sync annotation":
        """
        **Given** function with sync keyword
        **When** effect inference runs
        **Then** enforces Sync constraint

        **Verification:** Sync annotation respected
        """
        sync fn compute(x: i64) -> i64:
            return x * 2

        val result = compute(21)
        expect(result).to(eq(42))

print("")
describe "Async function detection":
    it "detects await as async indicator":
        """
        **Given** function containing await
        **When** effect inference runs
        **Then** infers Async effect

        **Verification:** Await makes function async
        """
        fn simulate_async() -> i64:
            val data = 42
            return data

        val result = simulate_async()
        expect(result).to(eq(42))

    it "propagates async effect through calls":
        """
        **Given** function calling async function
        **When** effect inference runs
        **Then** infers Async for caller

        **Verification:** Effect propagation works
        """
        fn async_op() -> i64:
            return 42

        fn caller() -> i64:
            val result = async_op()
            return result

        val final_result = caller()
        expect(final_result).to(eq(42))

print("")
describe "Effect validation":
    it "validates sync constraint correctness":
        """
        **Given** sync-annotated function
        **When** validation runs
        **Then** ensures no suspension points

        **Verification:** Sync constraint enforced
        """
        sync fn valid_sync(x: i64) -> i64:
            return x * 3

        val result = valid_sync(14)
        expect(result).to(eq(42))

print("")
print("============================================================")
print("  EFFECT SYSTEM SPECIFICATION COMPLETE")
print("============================================================")
