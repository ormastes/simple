# MIR Feature Specification
# Feature #5: Mid-level Intermediate Representation
# Category: Infrastructure | Difficulty: 4 | Status: Complete

"""
# MIR

**Feature ID:** #5
**Category:** Infrastructure
**Difficulty:** 4/5
**Status:** Complete

## Overview

Mid-level IR with 50+ instruction variants. Lowers HIR to basic blocks with explicit control flow. Handles arithmetic, memory, collections, patterns, async, and generators.

## Syntax

MIR provides low-level instructions for:
- **Core (6):** ConstInt, ConstFloat, BinOp, UnaryOp, Call, Return
- **Memory (6):** Load, Store, FieldGet, FieldSet, Alloc, Dealloc
- **Collections (7):** ArrayLit, TupleLit, DictLit, IndexGet, IndexSet, Slice, Len
- **Strings (3):** ConstString, FStringFormat, StringConcat
- **Patterns (6):** PatternTest, PatternBind, EnumDiscriminant, TupleDestruct, ArrayDestruct, WildcardPattern
- **Async (5):** FutureCreate, Await, PromiseResolve, PromiseReject, EffectSuspend
- **Generators (3):** GeneratorCreate, Yield, GeneratorNext

## Implementation

**Files:**
- `src/compiler/src/mir/mod.rs`
- `src/compiler/src/mir/instructions.rs`
- `src/compiler/src/mir/lower.rs`

**Test Files:**
- `src/driver/tests/runner_tests.rs`

**Dependencies:** #4 (HIR)
**Required By:** #100 (Codegen)

## Notes

MIR uses SSA form. Generator lowering creates state machines. Effect tracking for async safety.
"""

# =====================================================
# Feature Metadata
# =====================================================

class FeatureMetadata:
    id: i32
    name: text
    category: text
    difficulty: i32
    status: text
    impl_type: text
    spec_ref: text
    files: List<text>
    tests: List<text>
    description: text
    code_examples: List<text>
    dependencies: List<i32>
    required_by: List<i32>
    notes: text

# Feature Definition
val FEATURE = FeatureMetadata {
    id: 5,
    name: 'MIR',
    category: 'Infrastructure',
    difficulty: 4,
    status: 'Complete',
    impl_type: 'Rust',
    spec_ref: 'doc/codegen/status.md',
    files: [
        'src/compiler/src/mir/mod.rs',
        'src/compiler/src/mir/instructions.rs',
        'src/compiler/src/mir/lower.rs'
    ],
    tests: [
        'src/driver/tests/runner_tests.rs'
    ],
    description: 'Mid-level IR with 50+ instruction variants. Lowers HIR to basic blocks with explicit control flow. Handles arithmetic, memory, collections, patterns, async, and generators.',
    code_examples: [],
    dependencies: [4],
    required_by: [100],
    notes: 'MIR uses SSA form. Generator lowering creates state machines. Effect tracking for async safety.'
}

# =====================================================
# BDD Specification Tests
# =====================================================

print('============================================================')
print('  MIR FEATURE SPECIFICATION (#5)')
print('  Category: Infrastructure | Difficulty: 4 | Status: Complete')
print('============================================================')
print('')

var passed = 0
var failed = 0

# -----------------------------------------------------
# Core Instructions (6)
# -----------------------------------------------------

print('describe Core instructions:')
print('  context ConstInt:')
print('    it creates integer constants:')

val const_int = 42
if const_int == 42:
    print('      [PASS] ConstInt lowering')
    passed = passed + 1
else:
    print('      [FAIL] ConstInt lowering')
    failed = failed + 1

print('')
print('  context BinOp:')
print('    it lowers binary operations:')

val sum = 10 + 20 + 12
val prod = 6 * 7
if sum == 42 and prod == 42:
    print('      [PASS] BinOp lowering')
    passed = passed + 1
else:
    print('      [FAIL] BinOp lowering')
    failed = failed + 1

print('')
print('  context UnaryOp:')
print('    it lowers unary operations:')

val neg = -42
val not_val = not false
if neg == -42 and not_val:
    print('      [PASS] UnaryOp lowering')
    passed = passed + 1
else:
    print('      [FAIL] UnaryOp lowering')
    failed = failed + 1

# -----------------------------------------------------
# Memory Instructions (6)
# -----------------------------------------------------

print('')
print('describe Memory instructions:')
print('  context Load/Store:')
print('    it loads and stores values:')

var mem = 0
mem = 42
if mem == 42:
    print('      [PASS] Load/Store')
    passed = passed + 1
else:
    print('      [FAIL] Load/Store')
    failed = failed + 1

print('')
print('  context FieldGet/FieldSet:')
print('    it accesses struct fields:')

struct Data:
   value: i64

val d = Data {value: 42 }
if d.value == 42:
    print('      [PASS] FieldGet')
    passed = passed + 1
else:
    print('      [FAIL] FieldGet')
    failed = failed + 1

# -----------------------------------------------------
# Collection Instructions (7)
# -----------------------------------------------------

print('')
print('describe Collection instructions:')
print('  context ArrayLit:')
print('    it creates arrays:')

val arr = [1, 2, 3, 4, 5]
if arr.len() == 5:
    print('      [PASS] ArrayLit')
    passed = passed + 1
else:
    print('      [FAIL] ArrayLit')
    failed = failed + 1

print('')
print('  context TupleLit:')
print('    it creates tuples:')

val tup = (10, 20, 30)
if tup[0] + tup[1] + tup[2] == 60:
    print('      [PASS] TupleLit')
    passed = passed + 1
else:
    print('      [FAIL] TupleLit')
    failed = failed + 1

print('')
print('  context DictLit:')
print('    it creates dicts:')

val dict = {"a": 1, "b": 2}
if dict["a"] + dict["b"] == 3:
    print('      [PASS] DictLit')
    passed = passed + 1
else:
    print('      [FAIL] DictLit')
    failed = failed + 1

print('')
print('  context IndexGet:')
print('    it indexes collections:')

val items = [10, 20, 30]
if items[1] == 20:
    print('      [PASS] IndexGet')
    passed = passed + 1
else:
    print('      [FAIL] IndexGet')
    failed = failed + 1

# -----------------------------------------------------
# text Instructions (3)
# -----------------------------------------------------

print('')
print('describe text instructions:')
print('  context ConstString:')
print('    it creates strings:')

val s = "hello world"
if s.len() == 11:
    print('      [PASS] ConstString')
    passed = passed + 1
else:
    print('      [FAIL] ConstString')
    failed = failed + 1

print('')
print('  context FStringFormat:')
print('    it formats interpolated strings:')

val name = "World"
val greeting = "Hello, {name}!"
if greeting == "Hello, World!":
    print('      [PASS] FStringFormat')
    passed = passed + 1
else:
    print('      [FAIL] FStringFormat')
    failed = failed + 1

# -----------------------------------------------------
# Pattern Instructions (6)
# -----------------------------------------------------

print('')
print('describe Pattern instructions:')
print('  context PatternTest:')
print('    it tests literal patterns:')

val value = 42
var matched = false
match value:
    42 =>
        matched = true
    _ =>
        matched = false

if matched:
    print('      [PASS] PatternTest literal')
    passed = passed + 1
else:
    print('      [FAIL] PatternTest literal')
    failed = failed + 1

print('')
print('  context PatternBind:')
print('    it binds pattern variables:')

val opt = Some(100)
var extracted = 0
match opt:
    Some(x) =>
        extracted = x
    nil =>
        extracted = -1

if extracted == 100:
    print('      [PASS] PatternBind')
    passed = passed + 1
else:
    print('      [FAIL] PatternBind')
    failed = failed + 1

print('')
print('  context EnumDiscriminant:')
print('    it tests enum variants:')

enum Color:
    Red
    Green
    Blue

val c = Color::Green
var is_green = false
match c:
    Color::Green =>
        is_green = true
    _ =>
        is_green = false

if is_green:
    print('      [PASS] EnumDiscriminant')
    passed = passed + 1
else:
    print('      [FAIL] EnumDiscriminant')
    failed = failed + 1

# -----------------------------------------------------
# Async Instructions (5)
# -----------------------------------------------------

print('')
print('describe Async instructions:')
print('  context FutureCreate:')
print('    it creates futures:')

val f = future(42)
if await f == 42:
    print('      [PASS] FutureCreate')
    passed = passed + 1
else:
    print('      [FAIL] FutureCreate')
    failed = failed + 1

print('')
print('  context Await:')
print('    it awaits values:')

val f2 = future(10 + 20)
val result = await f2
if result == 30:
    print('      [PASS] Await')
    passed = passed + 1
else:
    print('      [FAIL] Await')
    failed = failed + 1

# -----------------------------------------------------
# Generator Instructions (3)
# -----------------------------------------------------

print('')
print('describe Generator instructions:')
print('  context GeneratorCreate:')
print('    it creates generators:')

val gen = generator(\: yield 42)
if next(gen) == 42:
    print('      [PASS] GeneratorCreate')
    passed = passed + 1
else:
    print('      [FAIL] GeneratorCreate')
    failed = failed + 1

print('')
print('  context Yield/GeneratorNext:')
print('    it yields and advances:')

val gen2 = generator(\: [yield 1, yield 2, yield 3])
val sum_gen = next(gen2) + next(gen2) + next(gen2)
if sum_gen == 6:
    print('      [PASS] Yield/GeneratorNext')
    passed = passed + 1
else:
    print('      [FAIL] Yield/GeneratorNext')
    failed = failed + 1

# =====================================================
# Documentation Output
# =====================================================

print('')
print('============================================================')
print('  GENERATED DOCUMENTATION')
print('============================================================')
print('')
print('# MIR')
print('')
print('**Feature ID:** #5')
print('**Category:** Infrastructure')
print('**Difficulty:** Level 4/5')
print('**Status:** Complete')
print('**Implementation:** Rust')
print('')
print('## Description')
print('')
print(FEATURE.description)
print('')
print('## Instruction Categories')
print('')
print('| Category | Count | Examples |')
print('|----------|-------|----------|')
print('| Core | 6 | ConstInt, BinOp, UnaryOp |')
print('| Memory | 6 | Load, Store, FieldGet |')
print('| Collections | 7 | ArrayLit, TupleLit, IndexGet |')
print('| Strings | 3 | ConstString, FStringFormat |')
print('| Patterns | 6 | PatternTest, PatternBind |')
print('| Async | 5 | FutureCreate, Await |')
print('| Generators | 3 | GeneratorCreate, Yield |')
print('')
print('## Notes')
print('')
print(FEATURE.notes)

# Summary
print('')
print('============================================================')
print('  TEST SUMMARY')
print('============================================================')
val total = passed + failed
print("Passed: {passed}")
print("Failed: {failed}")
print("Total:  {total}")
if failed == 0:
    print('All tests PASSED!')
print('============================================================')
