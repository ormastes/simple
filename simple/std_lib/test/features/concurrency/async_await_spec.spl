# Async/Await Feature Specification
# Feature #41: Asynchronous function execution
# Category: Concurrency | Difficulty: 4 | Status: Complete

# =====================================================
# Feature Metadata
# =====================================================

class FeatureMetadata:
    id: i32
    name: text
    category: text
    difficulty: i32
    status: text
    impl_type: text
    spec_ref: text
    files: List<text>
    tests: List<text>
    description: text
    code_examples: List<text>
    dependencies: List<i32>
    required_by: List<i32>
    notes: text

# Feature Definition
val FEATURE = FeatureMetadata {
    id: 41,
    name: 'Async/Await',
    category: 'Concurrency',
    difficulty: 4,
    status: 'Complete',
    impl_type: 'Rust',
    spec_ref: 'doc/spec/concurrency.md',
    files: [
        'src/compiler/src/effects.rs',
        'src/runtime/src/value/async_gen.rs'
    ],
    tests: [
        'src/driver/tests/interpreter_async_tests.rs',
        'src/driver/tests/runner_async_tests.rs'
    ],
    description: 'Async functions for non-blocking computation. Includes async fn declarations, effect checking for blocking operations, and await for future resolution.',
    code_examples: [],
    dependencies: [12, 43],
    required_by: [],
    notes: 'Async functions cannot use blocking operations like print or await. Effect system enforces async safety at compile time.'
}

# =====================================================
# BDD Specification Tests
# =====================================================

print('============================================================')
print('  ASYNC/AWAIT FEATURE SPECIFICATION (#41)')
print('  Category: Concurrency | Difficulty: 4 | Status: Complete')
print('============================================================')
print('')

var passed = 0
var failed = 0

# -----------------------------------------------------
# Async Functions
# -----------------------------------------------------

print('describe Async functions:')
print('  context basic async fn:')
print('    it defines async function:')

async fn compute(x):
    return x * 2

if compute(21) == 42:
    print('      [PASS] async fn works')
    passed = passed + 1
else:
    print('      [FAIL] async fn works')
    failed = failed + 1

print('    it supports multiple parameters:')

async fn add_async(a, b):
    return a + b

if add_async(15, 27) == 42:
    print('      [PASS] async with multiple params')
    passed = passed + 1
else:
    print('      [FAIL] async with multiple params')
    failed = failed + 1

print('')
print('  context async calling async:')
print('    it chains async functions:')

async fn double_async(x):
    return x * 2

async fn quadruple(x):
    return double_async(double_async(x))

if quadruple(10) == 40:
    print('      [PASS] async calls async')
    passed = passed + 1
else:
    print('      [FAIL] async calls async')
    failed = failed + 1

# -----------------------------------------------------
# Futures and Await
# -----------------------------------------------------

print('')
print('describe Futures:')
print('  context future creation:')
print('    it creates future fromvalue:')

val f = future(42)
val value = await f
if value == 42:
    print('      [PASS] future fromvalue')
    passed = passed + 1
else:
    print('      [FAIL] future fromvalue')
    failed = failed + 1

print('    it creates future from computation:')

fn slow_compute():
    return 10 + 20 + 30

val f2 = future(slow_compute())
val result = await f2
if result == 60:
    print('      [PASS] future from computation')
    passed = passed + 1
else:
    print('      [FAIL] future from computation')
    failed = failed + 1

print('')
print('  context multiple futures:')
print('    it handles multiple futures:')

val f1 = future(10)
val f2 = future(20)
val f3 = future(30)
val r1 = await f1
val r2 = await f2
val r3 = await f3
if r1 + r2 + r3 == 60:
    print('      [PASS] multiple futures')
    passed = passed + 1
else:
    print('      [FAIL] multiple futures')
    failed = failed + 1

print('')
print('  context await behavior:')
print('    it awaits future-wrappedvalue:')

val x = future(42)
val v = await x
if v == 42:
    print('      [PASS] await future-wrappedvalue')
    passed = passed + 1
else:
    print('      [FAIL] await future-wrappedvalue')
    failed = failed + 1

print('    it awaits function call:')

fn add_slow(a, b):
    return a + b

val f4 = future(add_slow(15, 27))
if await f4 == 42:
    print('      [PASS] await function call')
    passed = passed + 1
else:
    print('      [FAIL] await function call')
    failed = failed + 1

# -----------------------------------------------------
# Async Function Await
# -----------------------------------------------------

print('')
print('describe Async fn await:')
print('  context awaiting async fn:')
print('    it awaits async function:')

async fn fetch():
    return 42

# Async functions are auto-awaited when called at top level
if fetch() == 42:
    print('      [PASS] call async fn (auto-await)')
    passed = passed + 1
else:
    print('      [FAIL] call async fn (auto-await)')
    failed = failed + 1

# =====================================================
# Documentation Output
# =====================================================

print('')
print('============================================================')
print('  GENERATED DOCUMENTATION')
print('============================================================')
print('')
print('# Async/Await')
print('')
print('**Feature ID:** #41')
print('**Category:** Concurrency')
print('**Difficulty:** Level 4/5')
print('**Status:** Complete')
print('**Implementation:** Rust')
print('')
print('## Description')
print('')
print(FEATURE.description)
print('')
print('## Syntax')
print('')
print('```simple')
print('# Async function declaration')
print('async fn compute(x):')
print('    return x * 2')
print('')
print('# Create and await future')
print('val f = future(expensive_computation())')
print('val result = await f')
print('')
print('# Await async function directly')
print('val value = await fetch_data()')
print('```')
print('')
print('## Effect Checking')
print('')
print('Async functions cannot use blocking operations:')
print('- No `print()` or I/O in async fn')
print('- No `await` inside async fn body')
print('- Effect system enforces at compile time')
print('')
print('## Notes')
print('')
print(FEATURE.notes)

# Summary
print('')
print('============================================================')
print('  TEST SUMMARY')
print('============================================================')
val total = passed + failed
print("Passed: {passed}")
print("Failed: {failed}")
print("Total:  {total}")
if failed == 0:
    print('All tests PASSED!')
print('============================================================')
