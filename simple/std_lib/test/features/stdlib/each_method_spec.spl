# Each Method Feature Specification
# Feature: Ruby-style each iteration method for collections
# Category: Stdlib | Difficulty: 2 | Status: Complete

# =====================================================
# Feature Metadata
# =====================================================

class FeatureMetadata:
    id: i32
    name: text
    category: text
    difficulty: i32
    status: text
    impl_type: text
    spec_ref: text
    files: List<text>
    tests: List<text>
    description: text
    code_examples: List<text>
    dependencies: List<i32>
    required_by: List<i32>
    notes: text

# Feature Definition
val FEATURE = FeatureMetadata {
    id: 1005,
    name: "Each Method",
    category: "Stdlib",
    difficulty: 2,
    status: "Complete",
    impl_type: "Simple",
    spec_ref: "simple/improve_request.md",
    files: [
        "simple/std_lib/src/core/collections.spl",
        "simple/std_lib/src/core/list.spl",
        "simple/std_lib/src/core/string_ops.spl"
    ],
    tests: [
        "simple/std_lib/test/features/stdlib/each_method_spec.spl"
    ],
    description: "Ruby-style each() method for collections and strings. Provides a convenient way to iterate over elements with a closure, replacing the deprecated iter() method.",
    code_examples: [
        "# List iteration",
        "val list = [1, 2, 3, 4, 5]",
        "list.each(|x| print(x))",
        "",
        "# String iteration",
        "\"hello\".each(|c| print(c))",
        "",
        "# With index",
        "list.each_with_index(|i, x| print(\"{i}: {x}\"))"
    ],
    dependencies: [],
    required_by: [],
    notes: "The each() method is the preferred way to iterate over collections. iter() is deprecated and will be removed in a future version."
}

# =====================================================
# BDD Specification Tests
# =====================================================

print("============================================================")
print("  EACH METHOD SPECIFICATION (#1005)")
print("  Category: Stdlib | Difficulty: 2 | Status: Complete")
print("============================================================")
print("")

var passed = 0
var failed = 0

# describe "List each()"
print("describe List each():")

# it "iterates over all elements"
print("  it iterates over all elements:")
var list_sum: i64 = 0
val list = [1, 2, 3, 4, 5]
list.each(|x| list_sum = list_sum + x)
if list_sum == 15:
    print("    [PASS] each() iterates all elements (sum = 15)")
    passed = passed + 1
else:
    print("    [FAIL] each() iteration")
    failed = failed + 1

# it "maintains element order"
print("  it maintains element order:")
var last_val: i64 = 0
val ordered_list = [1, 2, 3, 4, 5]
ordered_list.each(|x| last_val = x)
if last_val == 5:
    print("    [PASS] each() maintains order (last = 5)")
    passed = passed + 1
else:
    print("    [FAIL] each() order")
    failed = failed + 1

# it "handles empty list"
print("  it handles empty list:")
var empty_count = 0
val empty_list: List<i64> = []
empty_list.each(|_| empty_count = empty_count + 1)
if empty_count == 0:
    print("    [PASS] each() on empty list does nothing")
    passed = passed + 1
else:
    print("    [FAIL] each() empty list")
    failed = failed + 1

# it "handles single element"
print("  it handles single element:")
var single_val: i64 = 0
val single_list = [42]
single_list.each(|x| single_val = x)
if single_val == 42:
    print("    [PASS] each() handles single element")
    passed = passed + 1
else:
    print("    [FAIL] each() single element")
    failed = failed + 1

# describe "List each_with_index()"
print("")
print("describe List each_with_index():")

# it "provides correct indices"
print("  it provides correct indices:")
var first_index: usize = 999
var last_index: usize = 999
val idx_list = [10, 20, 30]
idx_list.each_with_index(|i, _| {
    if first_index == 999: first_index = i
    last_index = i
})
if first_index == 0 and last_index == 2:
    print("    [PASS] indices are 0-based and correct")
    passed = passed + 1
else:
    print("    [FAIL] each_with_index() indices")
    failed = failed + 1

# it "provides matching element values"
print("  it provides matching element values:")
var index_check = true
val check_list = [10, 20, 30]
check_list.each_with_index(|i, x| {
    val expected = check_list.get(i)
    if expected != Some(x):
        index_check = false
})
if index_check:
    print("    [PASS] index matches element")
    passed = passed + 1
else:
    print("    [FAIL] each_with_index() element match")
    failed = failed + 1

# describe "String each()"
print("")
print("describe String each():")

# it "iterates over characters"
print("  it iterates over characters:")
var char_count = 0
val str = "hello"
str.each(|_| char_count = char_count + 1)
if char_count == 5:
    print("    [PASS] string each() iterates all chars (5)")
    passed = passed + 1
else:
    print("    [FAIL] string each() iteration")
    failed = failed + 1

# it "maintains character order"
print("  it maintains character order:")
var first_char: char = ' '
var last_char: char = ' '
val ord_str = "hello"
var first_set = false
ord_str.each(|c| {
    if not first_set:
        first_char = c
        first_set = true
    last_char = c
})
if first_char == 'h' and last_char == 'o':
    print("    [PASS] string each() maintains order")
    passed = passed + 1
else:
    print("    [FAIL] string each() order")
    failed = failed + 1

# it "handles empty string"
print("  it handles empty string:")
var empty_str_count = 0
val empty_str = ""
empty_str.each(|_| empty_str_count = empty_str_count + 1)
if empty_str_count == 0:
    print("    [PASS] each() on empty string does nothing")
    passed = passed + 1
else:
    print("    [FAIL] each() empty string")
    failed = failed + 1

# describe "String each_with_index()"
print("")
print("describe String each_with_index():")

# it "provides correct indices for characters"
print("  it provides correct indices for characters:")
var str_first_idx: usize = 999
var str_last_idx: usize = 999
val idx_str = "abc"
idx_str.each_with_index(|i, _| {
    if str_first_idx == 999: str_first_idx = i
    str_last_idx = i
})
if str_first_idx == 0 and str_last_idx == 2:
    print("    [PASS] string indices are 0-based and correct")
    passed = passed + 1
else:
    print("    [FAIL] string each_with_index() indices")
    failed = failed + 1

# describe "chars() deprecation"
print("")
print("describe chars() deprecation:")

# it "chars() still works but is deprecated"
print("  it chars() still works but is deprecated:")
val chars_str = "abc"
val chars_list = chars_str.chars()
if chars_list.len() == 3:
    print("    [PASS] chars() still works (len = 3)")
    passed = passed + 1
else:
    print("    [FAIL] chars() functionality")
    failed = failed + 1

# describe "Slice each()"
print("")
print("describe Slice each():")

# it "iterates over slice elements"
print("  it iterates over slice elements:")
var slice_sum: i64 = 0
val slice_source = [1, 2, 3, 4, 5]
val slice = slice_source.as_slice()
slice.each(|x| slice_sum = slice_sum + x)
if slice_sum == 15:
    print("    [PASS] slice each() iterates all elements")
    passed = passed + 1
else:
    print("    [FAIL] slice each() iteration")
    failed = failed + 1

# describe "Edge cases"
print("")
print("describe Edge cases:")

# it "each can modify external state"
print("  it each can modify external state:")
var count = 0
val state_list = [1, 2, 3]
state_list.each(|_| count = count + 1)
if count == 3:
    print("    [PASS] each() can modify external state")
    passed = passed + 1
else:
    print("    [FAIL] each() external state")
    failed = failed + 1

# it "each_with_index works on list of strings"
print("  it each_with_index works on list of strings:")
var str_list_check = true
val str_list = ["a", "b", "c"]
str_list.each_with_index(|i, s| {
    if i == 0 and s != "a": str_list_check = false
    if i == 1 and s != "b": str_list_check = false
    if i == 2 and s != "c": str_list_check = false
})
if str_list_check:
    print("    [PASS] each_with_index works on string list")
    passed = passed + 1
else:
    print("    [FAIL] each_with_index string list")
    failed = failed + 1

# =====================================================
# Generated Documentation
# =====================================================

print("")
print("============================================================")
print("  GENERATED DOCUMENTATION")
print("============================================================")
print("")
print("# Each Method")
print("")
print("**Feature ID:** #{FEATURE.id}")
print("**Category:** {FEATURE.category}")
print("**Difficulty:** Level {FEATURE.difficulty}/5")
print("**Status:** {FEATURE.status}")
print("**Implementation:** {FEATURE.impl_type}")
print("")
print("## Description")
print("")
print("{FEATURE.description}")
print("")
print("## Implementation Files")
for file in FEATURE.files:
    print("- `{file}`")
print("")
print("## Test Files")
for test in FEATURE.tests:
    print("- `{test}`")
print("")
print("## Code Examples")
print("")
print("```simple")
for example in FEATURE.code_examples:
    print("{example}")
print("```")
print("")
print("## Notes")
print("")
print("{FEATURE.notes}")

# =====================================================
# Test Summary
# =====================================================

print("")
print("============================================================")
print("  TEST SUMMARY")
print("============================================================")
print("Passed: {passed}")
print("Failed: {failed}")
print("Total:  {passed + failed}")

if failed == 0:
    print("")
    print("All tests PASSED!")

print("============================================================")
