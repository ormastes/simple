# LLVM Backend Feature Specification
# Feature #97: LLVM code generation backend
# Category: Codegen | Difficulty: 4 | Status: Complete

"""
# LLVM Backend

**Feature ID:** #97
**Category:** Codegen
**Difficulty:** Level 4/5
**Status:** Complete
**Implementation:** Rust

## Overview

LLVM-based code generation backend for 32-bit architecture support and broader
platform coverage. Uses same MIR and runtime FFI as Cranelift.

## Syntax

Backend selection via compiler flags:
```bash
simple --backend=llvm script.spl     # Use LLVM backend
simple --backend=cranelift script.spl # Use Cranelift (default for 64-bit)
```

Auto-selected for 32-bit targets (i686, ARMv7, RISC-V 32).

## Implementation

**Files:**
- src/compiler/src/codegen/backend_trait.rs - Backend abstraction trait
- src/compiler/src/codegen/llvm/mod.rs - LLVM backend implementation
- src/compiler/src/codegen/llvm/types.rs - LLVM type mappings

**Tests:**
- src/compiler/src/codegen/llvm_test_utils.rs

**Dependencies:** Features #5, #100
**Required By:** None

## Notes

Feature-gated optional backend. Auto-selected for 32-bit targets. Supports GPU/PTX
generation for CUDA.
"""

# =====================================================
# Feature Metadata
# =====================================================

class FeatureMetadata:
    id: i32
    name: text
    category: text
    difficulty: i32
    status: text
    impl_type: text
    spec_ref: text
    files: List<text>
    tests: List<text>
    description: text
    code_examples: List<text>
    dependencies: List<i32>
    required_by: List<i32>
    notes: text

# Feature Definition
val FEATURE = FeatureMetadata {
    id: 97,
    name: 'LLVM Backend',
    category: 'Codegen',
    difficulty: 4,
    status: 'Complete',
    impl_type: 'Rust',
    spec_ref: 'doc/codegen/llvm_backend.md',
    files: [
        'src/compiler/src/codegen/backend_trait.rs',
        'src/compiler/src/codegen/llvm/mod.rs',
        'src/compiler/src/codegen/llvm/types.rs'
    ],
    tests: [
        'src/compiler/src/codegen/llvm_test_utils.rs'
    ],
    description: 'LLVM-based code generation backend for 32-bit architecture support and broader platform coverage. Uses same MIR and runtime FFI as Cranelift.',
    code_examples: [],
    dependencies: [5, 100],
    required_by: [],
    notes: 'Feature-gated optional backend. Auto-selected for 32-bit targets. Supports GPU/PTX generation for CUDA.'
}

# =====================================================
# BDD Specification Tests
# =====================================================

print('============================================================')
print('  LLVM BACKEND FEATURE SPECIFICATION (#97)')
print('  Category: Codegen | Difficulty: 4 | Status: Complete')
print('============================================================')
print('')

var passed = 0
var failed = 0

# -----------------------------------------------------
# Backend Abstraction (Shared MIR)
# -----------------------------------------------------

print('describe Backend abstraction:')
print('  context shared MIR consumption:')
print('    it compiles arithmetic operations:')

fn add_nums(a, b):
    return a + b

fn sub_nums(a, b):
    return a - b

fn mul_nums(a, b):
    return a * b

if add_nums(10, 5) == 15 and sub_nums(10, 5) == 5 and mul_nums(10, 5) == 50:
    print('      [PASS] arithmetic operations')
    passed = passed + 1
else:
    print('      [FAIL] arithmetic operations')
    failed = failed + 1

print('    it compiles comparison operations:')

fn is_greater(a, b):
    return a > b

fn is_equal(a, b):
    return a == b

if is_greater(10, 5) and is_equal(42, 42):
    print('      [PASS] comparison operations')
    passed = passed + 1
else:
    print('      [FAIL] comparison operations')
    failed = failed + 1

# -----------------------------------------------------
# Type System Support
# -----------------------------------------------------

print('')
print('describe Type system support:')
print('  context primitive types:')
print('    it handles integer types:')

val i_val: i64 = 42
val neg_val: i64 = -100
if i_val == 42 and neg_val == -100:
    print('      [PASS] integer types')
    passed = passed + 1
else:
    print('      [FAIL] integer types')
    failed = failed + 1

print('    it handles f32 types:')

val f_val = 3.14
if f_val > 3.0 and f_val < 4.0:
    print('      [PASS] f32 types')
    passed = passed + 1
else:
    print('      [FAIL] f32 types')
    failed = failed + 1

print('    it handles boolean types:')

val t_val = true
val f_bool = false
if t_val and not f_bool:
    print('      [PASS] boolean types')
    passed = passed + 1
else:
    print('      [FAIL] boolean types')
    failed = failed + 1

print('')
print('  context composite types:')
print('    it handles arrays:')

val arr = [1, 2, 3, 4, 5]
if arr.len() == 5 and arr[0] == 1:
    print('      [PASS] array types')
    passed = passed + 1
else:
    print('      [FAIL] array types')
    failed = failed + 1

print('    it handles tuples:')

val tup = (10, 20, 30)
if tup[0] + tup[2] == 40:
    print('      [PASS] tuple types')
    passed = passed + 1
else:
    print('      [FAIL] tuple types')
    failed = failed + 1

print('    it handles dicts:')

val dict = {"x": 10, "y": 20}
if dict["x"] + dict["y"] == 30:
    print('      [PASS] dict types')
    passed = passed + 1
else:
    print('      [FAIL] dict types')
    failed = failed + 1

# -----------------------------------------------------
# Function Compilation
# -----------------------------------------------------

print('')
print('describe Function compilation:')
print('  context basic functions:')
print('    it compiles simple functions:')

fn identity(x):
    return x

if identity(42) == 42:
    print('      [PASS] simple functions')
    passed = passed + 1
else:
    print('      [FAIL] simple functions')
    failed = failed + 1

print('    it compiles recursive functions:')

fn factorial(n):
    if n <= 1:
        return 1
    return n * factorial(n - 1)

if factorial(5) == 120:
    print('      [PASS] recursive functions')
    passed = passed + 1
else:
    print('      [FAIL] recursive functions')
    failed = failed + 1

print('')
print('  context control flow:')
print('    it compiles if-else:')

fn abs_value(x):
    if x < 0:
        return -x
    return x

if abs_value(-42) == 42 and abs_value(42) == 42:
    print('      [PASS] if-else')
    passed = passed + 1
else:
    print('      [FAIL] if-else')
    failed = failed + 1

print('    it compiles while loops:')

fn sum_to_n(n):
    var sum = 0
    var i = 1
    while i <= n:
        sum = sum + i
        i = i + 1
    return sum

if sum_to_n(10) == 55:
    print('      [PASS] while loops')
    passed = passed + 1
else:
    print('      [FAIL] while loops')
    failed = failed + 1

# -----------------------------------------------------
# Object Emission
# -----------------------------------------------------

print('')
print('describe Object emission:')
print('  context struct compilation:')
print('    it compiles struct definitions:')

struct Vector2D:
    x: i64
    y: i64

val v = Vector2D { x: 3, y: 4 }
if v.x * v.x + v.y * v.y == 25:
    print('      [PASS] struct definitions')
    passed = passed + 1
else:
    print('      [FAIL] struct definitions')
    failed = failed + 1

print('    it compiles struct methods:')

struct Calculator:
   value: i64

impl Calculator:
    fn add(n: i64) -> i64:
        return self.value + n

    fn multiply(n: i64) -> i64:
        return self.value * n

val calc = Calculator {value: 10 }
if calc.add(5) == 15 and calc.multiply(3) == 30:
    print('      [PASS] struct methods')
    passed = passed + 1
else:
    print('      [FAIL] struct methods')
    failed = failed + 1

# -----------------------------------------------------
# Closure Compilation
# -----------------------------------------------------

print('')
print('describe Closure compilation:')
print('  context lambda expressions:')
print('    it compiles simple closures:')

val double = |x| x * 2
val triple = |x| x * 3

if double(5) == 10 and triple(5) == 15:
    print('      [PASS] simple closures')
    passed = passed + 1
else:
    print('      [FAIL] simple closures')
    failed = failed + 1

print('    it compiles capturing closures:')

val factor = 10
val scale = |x| x * factor

if scale(5) == 50:
    print('      [PASS] capturing closures')
    passed = passed + 1
else:
    print('      [FAIL] capturing closures')
    failed = failed + 1

# -----------------------------------------------------
# Pattern Matching
# -----------------------------------------------------

print('')
print('describe Pattern matching:')
print('  context match expressions:')
print('    it compiles literal patterns:')

val num = 42
var result = 0
match num:
    42 =>
        result = 1
    _ =>
        result = 0

if result == 1:
    print('      [PASS] literal patterns')
    passed = passed + 1
else:
    print('      [FAIL] literal patterns')
    failed = failed + 1

print('    it compiles enum patterns:')

val opt = Some(100)
var extracted = 0
match opt:
    Some(v) =>
        extracted = v
    None =>
        extracted = -1

if extracted == 100:
    print('      [PASS] enum patterns')
    passed = passed + 1
else:
    print('      [FAIL] enum patterns')
    failed = failed + 1

# =====================================================
# Documentation Output
# =====================================================

print('')
print('============================================================')
print('  GENERATED DOCUMENTATION')
print('============================================================')
print('')
print('# LLVM Backend')
print('')
print("**Feature ID:** #97")
print("**Category:** Codegen")
print("**Difficulty:** Level 4/5")
print("**Status:** Complete")
print("**Implementation:** Rust")
print('')
print('## Description')
print('')
print(FEATURE.description)
print('')
print('## Architecture Support')
print('')
print('| Architecture | Bits | Cranelift | LLVM |')
print('|--------------|------|-----------|------|')
print('| x86_64       | 64   | Yes       | Yes  |')
print('| AArch64      | 64   | Yes       | Yes  |')
print('| RISC-V 64    | 64   | Yes       | Yes  |')
print('| i686         | 32   | No        | Yes  |')
print('| ARMv7        | 32   | No        | Yes  |')
print('| RISC-V 32    | 32   | No        | Yes  |')
print('')
print('## Backend Selection')
print('')
print('| Target | Default Backend |')
print('|--------|-----------------|')
print('| 64-bit | Cranelift (fast compile) |')
print('| 32-bit | LLVM (auto-selected) |')
print('')
print('## Notes')
print('')
print(FEATURE.notes)

# Summary
print('')
print('============================================================')
print('  TEST SUMMARY')
print('============================================================')
val total = passed + failed
print("Passed: {passed}")
print("Failed: {failed}")
print("Total:  {total}")
if failed == 0:
    print('All tests PASSED!')
print('============================================================')
