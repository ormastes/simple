# Configuration System Feature Specification
# Feature #TBD: SDN-based hierarchical configuration (OmegaConf-like)
# Category: ML Infrastructure | Difficulty: 3 | Status: Planned

# =====================================================
# Feature Metadata
# =====================================================

class FeatureMetadata:
    id: Int
    name: String
    category: String
    difficulty: Int
    status: String
    impl_type: String
    spec_ref: String
    files: List[String]
    tests: List[String]
    description: String
    code_examples: List[String]
    dependencies: List[Int]
    required_by: List[Int]
    notes: String

# Feature Definition
let FEATURE = FeatureMetadata {
    id: 0,  # TBD - assign when implementing
    name: "Configuration System (OmegaConf-like)",
    category: "ML Infrastructure",
    difficulty: 3,
    status: "Planned",
    impl_type: "Simple",
    spec_ref: "doc/spec/generated/config_system.md",
    files: [
        "simple/std_lib/src/config/__init__.spl",
        "simple/std_lib/src/config/core.spl",
        "simple/std_lib/src/config/resolvers.spl",
        "simple/std_lib/src/config/validation.spl"
    ],
    tests: [
        "simple/std_lib/test/unit/config/conf_spec.spl",
        "simple/std_lib/test/features/ml/config_system_spec.spl"
    ],
    description: "Hierarchical configuration system using SDN format. Features: multi-source merging (files + CLI + env), CLI dotlist overrides, interpolation with custom resolvers, type-safe schema validation with conversion, frozen configs for production safety.",
    code_examples: [
        "# Load and merge configurations",
        "let base = Conf.load_sdn('config/base.sdn')",
        "let cli = Conf.from_cli_dotlist(sys.args[1..])",
        "let cfg = Conf.merge(base, cli)",
        "",
        "# CLI override: train.epochs=20 model.dropout=0.2",
        "",
        "# Interpolation",
        "# config.sdn:",
        "# project = mnist",
        "# run_dir = runs/${project}/${time.now:%Y%m%d}",
        "",
        "# Schema validation",
        "schema AppCfg:",
        "    project: Str",
        "    train: {epochs: Int, lr: F64}",
        "",
        "let typed = Conf.validate(AppCfg, cfg, convert=true)"
    ],
    dependencies: [],  # Requires SDN parser (already exists)
    required_by: [0, 0],  # Will be used by tracking and training engine
    notes: "Uses existing SDN infrastructure (src/sdn/). Inspired by OmegaConf but SDN-native."
}

# =====================================================
# BDD Specification Tests
# =====================================================

print("============================================================")
print("  CONFIG SYSTEM FEATURE SPECIFICATION")
print("  Category: ML Infrastructure | Status: Planned")
print("============================================================")
print("")

let mut passed = 0
let mut failed = 0

# describe "SDN config loading"
print("describe SDN config loading:")

# it "loads hierarchical configs from SDN files"
print("  it loads hierarchical configs from SDN files:")
# TODO: Implement
print("    [TODO] Not yet implemented")

# it "merges multiple config sources"
print("  it merges multiple config sources:")
# TODO: Implement
print("    [TODO] Not yet implemented")

# describe "CLI dotlist overrides"
print("")
print("describe CLI dotlist overrides:")

# it "parses dotlist syntax"
print("  it parses dotlist syntax:")
# TODO: Example: "train.epochs=20" -> {train: {epochs: 20}}
print("    [TODO] Not yet implemented")

# it "supports type coercion"
print("  it supports type coercion:")
# TODO: "42" -> 42, "true" -> true, "[1,2,3]" -> [1,2,3]
print("    [TODO] Not yet implemented")

# describe "Interpolation and resolvers"
print("")
print("describe Interpolation and resolvers:")

# it "resolves variable references"
print("  it resolves variable references:")
# TODO: ${base}/data -> "/data/train" if base="/data"
print("    [TODO] Not yet implemented")

# it "supports custom resolvers"
print("  it supports custom resolvers:")
# TODO: ${path.join:a,b,c} -> "a/b/c"
print("    [TODO] Not yet implemented")

# it "provides built-in resolvers"
print("  it provides built-in resolvers:")
# TODO: ${env:HOME}, ${time.now:%Y%m%d}, ${sys.cpu_count}
print("    [TODO] Not yet implemented")

# describe "Schema validation"
print("")
print("describe Schema validation:")

# it "validates against schema"
print("  it validates against schema:")
# TODO: Enforce type constraints
print("    [TODO] Not yet implemented")

# it "converts types automatically"
print("  it converts types automatically:")
# TODO: "100" -> 100 when schema expects Int
print("    [TODO] Not yet implemented")

# it "reports validation errors with paths"
print("  it reports validation errors with paths:")
# TODO: "train.epochs: expected Int, got String"
print("    [TODO] Not yet implemented")

# describe "Frozen configs"
print("")
print("describe Frozen configs:")

# it "prevents modification when frozen"
print("  it prevents modification when frozen:")
# TODO: cfg.train.epochs = 20 throws error if frozen
print("    [TODO] Not yet implemented")

# it "allows cloning for modification"
print("  it allows cloning for modification:")
# TODO: mutable_cfg = Conf.unfreeze(cfg)
print("    [TODO] Not yet implemented")

# Summary
print("")
print("------------------------------------------------------------")
print("  SUMMARY: Config System tests not yet implemented")
print("  This is a planned feature - see spec for full design")
print("------------------------------------------------------------")

# =====================================================
# Implementation Roadmap
# =====================================================

# Phase 1: Core (v0.1)
# - [x] SDN loading (already exists in src/sdn/)
# - [ ] Conf.merge() with deep merge
# - [ ] Dot notation access
# - [ ] CLI dotlist parsing
# - [ ] Basic interpolation (${var})

# Phase 2: Advanced (v0.2)
# - [ ] Custom resolvers
# - [ ] Built-in resolvers (path, env, time, sys)
# - [ ] Schema validation with type coercion
# - [ ] Freeze/unfreeze

# Phase 3: Production (v0.3)
# - [ ] Lazy resolution
# - [ ] Validation decorators
# - [ ] Error messages with source location
# - [ ] YAML compatibility layer
# - [ ] Config diff tool
