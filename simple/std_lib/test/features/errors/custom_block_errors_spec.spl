"""
# Custom Block Error Messages Specification

**Feature IDs:** #E1601-E1612
**Category:** Errors / Custom Blocks
**Difficulty:** 3/5 (Intermediate)
**Status:** Draft

## Overview

Custom blocks are a unique feature of Simple that allow domain-specific
languages to be embedded directly in source code. Each block type has
specialized syntax and validation.

**Supported Block Types:**
- `m{}` - Math expressions (LaTeX-like)
- `sh{}` - Shell commands (portable)
- `sql{}` - SQL queries (parameterized)
- `re{}` - Regular expressions
- `md{}` - Markdown content
- `html{}` - HTML content
- `graph{}` - Mermaid/DOT diagrams
- `img{}` - Image embedding

## Error Codes

| Code | Name | Description |
|------|------|-------------|
| E1601 | Unknown Block Type | Block type not recognized |
| E1602 | Invalid Block Syntax | General syntax error in block |
| E1603 | Math Block Invalid Expr | Invalid math expression in m{} |
| E1604 | Math Block Undefined Var | Undefined variable in m{} |
| E1605 | Shell Block Invalid Cmd | Invalid command in sh{} |
| E1606 | Shell Block Unsafe Op | Unsafe operation in sh{} |
| E1607 | SQL Block Syntax Error | SQL syntax error in sql{} |
| E1608 | SQL Block Invalid Param | Invalid parameter in sql{} |
| E1609 | Regex Block Invalid | Invalid regex in re{} |
| E1610 | Regex Block Unknown Flag | Unknown regex flag |
| E1611 | Block Missing Closing | Missing closing brace |
| E1612 | Block Type Mismatch | Content doesn't match block type |
"""

import std.spec


# ============================================================================
# E1601: Unknown Block Type
# ============================================================================

describe "E1601 Unknown Block Type":
    """
    ## Unknown Block Type Errors

    Custom blocks must use a recognized type identifier.
    Valid types: m, sh, sql, re, md, html, graph, img.
    """

    context "when block type is not recognized":
        """
        ### Scenario: Invalid Block Identifier

        Using a block type that isn't defined.
        """

        it "reports error for unknown block type":
            # Code that would trigger E1601:
            # val x = foo{content}  # 'foo' is not a valid block type
            val error_code = "E1601"
            val error_title = "Unknown Block Type"
            val valid_types = ["m", "sh", "sql", "re", "md", "html", "graph", "img"]
            expect(error_code).to(eq("E1601"))
            expect(valid_types.len()).to(eq(8))


# ============================================================================
# E1602: Invalid Block Syntax
# ============================================================================

describe "E1602 Invalid Block Syntax":
    """
    ## Invalid Block Syntax Errors

    General syntax errors within a custom block that don't fall into
    more specific categories.
    """

    context "when block content has syntax errors":
        it "reports general block syntax error":
            val error_code = "E1602"
            val error_title = "Invalid Block Syntax"
            expect(error_code).to(eq("E1602"))


# ============================================================================
# E1603: Math Block Invalid Expression
# ============================================================================

describe "E1603 Invalid Math Expression":
    """
    ## Math Block Expression Errors

    The m{} block uses LaTeX-like syntax for mathematical expressions.
    Invalid LaTeX constructs result in this error.
    """

    context "when math expression is invalid":
        """
        ### Scenario: Malformed LaTeX Math

        Using invalid LaTeX syntax in a math block.
        """

        it "reports error for invalid math expression":
            # Code that would trigger E1603:
            # val expr = m{\frac{1}{}}  # Missing second argument
            val error_code = "E1603"
            val error_title = "Invalid Math Expression"
            expect(error_code).to(eq("E1603"))
            expect(error_title).to(contain("Math"))

        it "reports error for unbalanced braces":
            # Code that would trigger E1603:
            # val expr = m{\sqrt{x}
            val error_code = "E1603"
            expect(error_code).to(eq("E1603"))


# ============================================================================
# E1604: Math Block Undefined Variable
# ============================================================================

describe "E1604 Undefined Variable in Math Block":
    """
    ## Math Block Variable Errors

    Math blocks can reference Simple variables, but they must be defined
    in the current scope.
    """

    context "when math variable is undefined":
        it "reports error for undefined variable":
            # Code that would trigger E1604:
            # val result = m{x + y}  # 'x' and 'y' not defined
            val error_code = "E1604"
            val error_title = "Undefined Variable in Math Block"
            expect(error_code).to(eq("E1604"))


# ============================================================================
# E1605: Shell Block Invalid Command
# ============================================================================

describe "E1605 Invalid Shell Command":
    """
    ## Shell Block Command Errors

    The sh{} block only allows portable, safe shell commands.
    Platform-specific or dangerous commands are rejected.
    """

    context "when shell command is invalid":
        """
        ### Scenario: Unsupported Command

        Using a command that isn't in the allowed set.
        """

        it "reports error for unsupported command":
            # Code that would trigger E1605:
            # sh{sudo rm -rf /}  # 'sudo' not allowed
            val error_code = "E1605"
            val error_title = "Invalid Shell Command"
            val allowed_commands = ["echo", "mkdir", "cp", "mv", "rm"]
            expect(error_code).to(eq("E1605"))
            expect(allowed_commands.len()).to(eq(5))


# ============================================================================
# E1606: Shell Block Unsafe Operation
# ============================================================================

describe "E1606 Unsafe Shell Operation":
    """
    ## Shell Block Safety Errors

    Shell blocks are sandboxed for security. Operations that could
    be dangerous are explicitly blocked.
    """

    context "when operation is unsafe":
        it "reports error for unsafe operation":
            # Code that would trigger E1606:
            # sh{rm -rf /}  # Unsafe path
            val error_code = "E1606"
            val error_title = "Unsafe Shell Operation"
            expect(error_code).to(eq("E1606"))
            expect(error_title).to(contain("Unsafe"))


# ============================================================================
# E1607: SQL Block Syntax Error
# ============================================================================

describe "E1607 SQL Syntax Error":
    """
    ## SQL Block Syntax Errors

    The sql{} block validates SQL syntax at compile time.
    SQL syntax errors are reported with dialect-specific context.
    """

    context "when SQL syntax is invalid":
        it "reports error for SQL syntax error":
            # Code that would trigger E1607:
            # sql{SELEC * FROM users}  # Typo in SELECT
            val error_code = "E1607"
            val error_title = "SQL Syntax Error"
            expect(error_code).to(eq("E1607"))


# ============================================================================
# E1608: SQL Block Invalid Parameter
# ============================================================================

describe "E1608 Invalid SQL Parameter":
    """
    ## SQL Block Parameter Errors

    SQL blocks use `:name` for named parameters and `?` for positional.
    Invalid parameter syntax triggers this error.
    """

    context "when SQL parameter is invalid":
        it "reports error for invalid parameter syntax":
            # Code that would trigger E1608:
            # sql{SELECT * FROM users WHERE id = $id}  # Wrong syntax
            val error_code = "E1608"
            val error_title = "Invalid SQL Parameter"
            expect(error_code).to(eq("E1608"))


# ============================================================================
# E1609: Regex Block Invalid
# ============================================================================

describe "E1609 Invalid Regular Expression":
    """
    ## Regex Block Validation Errors

    The re{} block compiles regular expressions at compile time.
    Invalid regex patterns result in compile-time errors.
    """

    context "when regex is invalid":
        it "reports error for invalid regex":
            # Code that would trigger E1609:
            # re{[unclosed}
            val error_code = "E1609"
            val error_title = "Invalid Regular Expression"
            expect(error_code).to(eq("E1609"))


# ============================================================================
# E1610: Regex Block Unknown Flag
# ============================================================================

describe "E1610 Unknown Regex Flag":
    """
    ## Regex Flag Errors

    Valid regex flags are: i (case-insensitive), m (multiline),
    s (dotall), x (verbose).
    """

    context "when regex flag is unknown":
        it "reports error for unknown flag":
            # Code that would trigger E1610:
            # re{pattern}/z  # 'z' is not a valid flag
            val error_code = "E1610"
            val valid_flags = ["i", "m", "s", "x"]
            expect(error_code).to(eq("E1610"))
            expect(valid_flags.len()).to(eq(4))


# ============================================================================
# E1611: Block Missing Closing
# ============================================================================

describe "E1611 Missing Block Closing":
    """
    ## Unclosed Block Errors

    Custom blocks must have matching opening and closing braces.
    """

    context "when closing brace is missing":
        it "reports error for unclosed block":
            # Code that would trigger E1611:
            # val x = m{x + y
            val error_code = "E1611"
            val error_title = "Missing Block Closing"
            expect(error_code).to(eq("E1611"))


# ============================================================================
# E1612: Block Type Mismatch
# ============================================================================

describe "E1612 Block Type Mismatch":
    """
    ## Block Content Type Errors

    Block content must match the expected format for its type.
    """

    context "when content doesn't match block type":
        it "reports error for type mismatch":
            val error_code = "E1612"
            val error_title = "Block Type Mismatch"
            expect(error_code).to(eq("E1612"))


# ============================================================================
# Korean Language Support Tests
# ============================================================================

describe "Custom Block Error Messages - Korean (한국어)":
    """
    ## i18n 검증: 커스텀 블록 오류 메시지 한국어 번역

    모든 커스텀 블록 오류 코드는 한국어 번역을 지원합니다.
    """

    it "E1601 has Korean translation":
        val ko_title = "알 수 없는 블록 타입"
        expect(ko_title).to(contain("블록"))

    it "E1603 has Korean translation":
        val ko_title = "잘못된 수학 표현식"
        expect(ko_title).to(contain("수학"))

    it "E1607 has Korean translation":
        val ko_title = "SQL 구문 오류"
        expect(ko_title).to(contain("SQL"))
