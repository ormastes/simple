"""
# AOP Error Messages Specification

**Feature IDs:** #E1501-E1508
**Category:** Errors / AOP
**Difficulty:** 3/5 (Intermediate)
**Status:** Draft

## Overview

AOP (Aspect-Oriented Programming) is a unique feature of Simple that enables
cross-cutting concerns like logging, security, and transactions to be modularly
defined and woven into code at compile-time or runtime.

This specification documents error messages for AOP features including:
- Pointcut syntax errors (`pc{...}` expressions)
- Advice type validation
- Join point resolution
- Aspect weaving constraints

## Error Codes

| Code | Name | Description |
|------|------|-------------|
| E1501 | Invalid Pointcut Syntax | Malformed `pc{...}` expression |
| E1502 | Undefined Join Point | Target function/method doesn't exist |
| E1503 | Invalid Advice Type | Not before/after_success/after_error/around |
| E1504 | Conflicting Advice Order | Multiple aspects with order conflicts |
| E1505 | Invalid Weaving Target | Cannot weave into intrinsics/FFI |
| E1506 | Aspect Circular Dependency | Cyclic aspect dependencies |
| E1507 | Invalid Pointcut Selector | Unknown selector keyword |
| E1508 | Aspect Not Enabled | AOP used but not enabled in config |

## Syntax

```simple
# Pointcut definition
aspect Logging:
    pointcut logMethods = pc{execution(*.log*)}

    before logMethods:
        print "Entering method"
```
"""

import std.spec


# ============================================================================
# E1501: Invalid Pointcut Syntax
# ============================================================================

describe "E1501 Invalid Pointcut Syntax":
    """
    ## Invalid Pointcut Syntax Errors

    The `pc{...}` block requires valid pointcut expression syntax.
    Common errors include missing parentheses, invalid patterns, and
    malformed selectors.
    """

    context "when pointcut expression has syntax errors":
        """
        ### Scenario: Malformed Pointcut Expression

        Pointcut expressions must follow the grammar:
        `selector(pattern)` where selector is execution/within/attr/effect.
        """

        it "reports error for missing closing parenthesis":
            # Code that would trigger E1501:
            # pc{execution(foo.bar}
            val error_code = "E1501"
            val error_title = "Invalid Pointcut Syntax"
            expect(error_code).to(eq("E1501"))
            expect(error_title).to(contain("Pointcut"))

        it "reports error for empty pointcut block":
            # Code that would trigger E1501:
            # pc{}
            val error_code = "E1501"
            expect(error_code).to(eq("E1501"))


# ============================================================================
# E1502: Undefined Join Point
# ============================================================================

describe "E1502 Undefined Join Point":
    """
    ## Undefined Join Point Errors

    A join point references a specific location in the code (function, method)
    where an aspect can be applied. If the target doesn't exist, an error is raised.
    """

    context "when join point target doesn't exist":
        """
        ### Scenario: Non-existent Target

        The pointcut references a function or method that is not defined.
        """

        it "reports error for undefined function":
            # Code that would trigger E1502:
            # pc{execution(nonExistentFunction)}
            val error_code = "E1502"
            val error_title = "Undefined Join Point"
            expect(error_code).to(eq("E1502"))
            expect(error_title).to(contain("Join Point"))


# ============================================================================
# E1503: Invalid Advice Type
# ============================================================================

describe "E1503 Invalid Advice Type":
    """
    ## Invalid Advice Type Errors

    Advice types define when aspect code executes relative to the join point.
    Valid types are: before, after_success, after_error, around.
    """

    context "when advice type is invalid":
        """
        ### Scenario: Unknown Advice Keyword

        Using an advice keyword that isn't recognized.
        """

        it "reports error for invalid advice keyword":
            # Code that would trigger E1503:
            # aspect Foo:
            #     during myPointcut:  # 'during' is not valid
            #         ...
            val error_code = "E1503"
            val valid_types = ["before", "after_success", "after_error", "around"]
            expect(error_code).to(eq("E1503"))
            expect(valid_types.len()).to(eq(4))


# ============================================================================
# E1504: Conflicting Advice Order
# ============================================================================

describe "E1504 Conflicting Advice Order":
    """
    ## Conflicting Advice Order Errors

    When multiple aspects apply to the same join point, their execution
    order must be deterministic. Conflicts arise when order is ambiguous.
    """

    context "when aspects have conflicting orders":
        """
        ### Scenario: Ambiguous Execution Order

        Two aspects both want to execute first without explicit ordering.
        """

        it "reports error for order conflict":
            val error_code = "E1504"
            val error_title = "Conflicting Advice Order"
            expect(error_code).to(eq("E1504"))
            expect(error_title).to(contain("Order"))


# ============================================================================
# E1505: Invalid Weaving Target
# ============================================================================

describe "E1505 Invalid Weaving Target":
    """
    ## Invalid Weaving Target Errors

    Some code cannot be woven with aspects, including intrinsic functions,
    FFI functions, and certain runtime primitives.
    """

    context "when target cannot be woven":
        """
        ### Scenario: Intrinsic Function Target

        Attempting to weave an aspect into a compiler intrinsic.
        """

        it "reports error for unweaveable target":
            val error_code = "E1505"
            val error_title = "Invalid Weaving Target"
            expect(error_code).to(eq("E1505"))
            expect(error_title).to(contain("Weaving"))


# ============================================================================
# E1506: Aspect Circular Dependency
# ============================================================================

describe "E1506 Aspect Circular Dependency":
    """
    ## Aspect Circular Dependency Errors

    Aspects can depend on each other for ordering, but circular
    dependencies create an impossible execution order.
    """

    context "when aspects have circular dependencies":
        """
        ### Scenario: A depends on B, B depends on A

        Circular dependency chain that cannot be resolved.
        """

        it "reports error for circular dependency":
            val error_code = "E1506"
            val error_title = "Aspect Circular Dependency"
            expect(error_code).to(eq("E1506"))
            expect(error_title).to(contain("Circular"))


# ============================================================================
# E1507: Invalid Pointcut Selector
# ============================================================================

describe "E1507 Invalid Pointcut Selector":
    """
    ## Invalid Pointcut Selector Errors

    Pointcut selectors must be one of the recognized keywords:
    execution, within, attr, effect, test, decision, condition.
    """

    context "when selector is unknown":
        """
        ### Scenario: Unknown Selector Keyword

        Using a selector that isn't in the valid set.
        """

        it "reports error for unknown selector":
            # Code that would trigger E1507:
            # pc{calls(foo)}  # 'calls' is not a valid selector
            val error_code = "E1507"
            val valid_selectors = ["execution", "within", "attr", "effect", "test", "decision", "condition"]
            expect(error_code).to(eq("E1507"))
            expect(valid_selectors.len()).to(eq(7))


# ============================================================================
# E1508: Aspect Not Enabled
# ============================================================================

describe "E1508 Aspect Not Enabled":
    """
    ## Aspect Not Enabled Errors

    AOP features require explicit enablement in the project configuration.
    Using aspects without enabling AOP results in this error.
    """

    context "when AOP is not enabled":
        """
        ### Scenario: AOP Feature Disabled

        Aspect code is present but `aspects.enabled` is false in config.
        """

        it "reports error when AOP disabled":
            val error_code = "E1508"
            val error_title = "Aspect Not Enabled"
            expect(error_code).to(eq("E1508"))
            expect(error_title).to(contain("Enabled"))


# ============================================================================
# Korean Language Support Tests
# ============================================================================

describe "AOP Error Messages - Korean (한국어)":
    """
    ## i18n 검증: AOP 오류 메시지 한국어 번역

    모든 AOP 오류 코드는 한국어 번역을 지원합니다.
    """

    it "E1501 has Korean translation":
        val ko_title = "잘못된 포인트컷 구문"
        expect(ko_title).to(contain("포인트컷"))

    it "E1502 has Korean translation":
        val ko_title = "정의되지 않은 조인 포인트"
        expect(ko_title).to(contain("조인 포인트"))

    it "E1503 has Korean translation":
        val ko_title = "잘못된 어드바이스 타입"
        expect(ko_title).to(contain("어드바이스"))
