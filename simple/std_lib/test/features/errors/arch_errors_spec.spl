"""
# Architecture Rules Error Messages Specification

**Feature IDs:** #E1A01-E1A06
**Category:** Errors / Architecture
**Difficulty:** 3/5 (Intermediate)
**Status:** Draft

## Overview

Architecture Rules in Simple enable compile-time enforcement of
architectural boundaries. Using the unified predicate grammar,
developers can define and enforce module dependencies, layer
constraints, and import rules.

## Syntax

```simple
# Architecture rules in simple.sdn
architecture:
    layers:
        - presentation
        - application
        - domain
        - infrastructure

    rules:
        # Forbidden dependencies
        forbid pc{import(domain.* -> infrastructure.*)}
        forbid pc{depend(presentation.* -> infrastructure.*)}

        # Allowed exceptions
        allow pc{import(domain.repository -> infrastructure.db)}
```

## Error Codes

| Code | Name | Description |
|------|------|-------------|
| E1A01 | Forbidden Import | Import violates architecture rule |
| E1A02 | Forbidden Dependency | Dependency violates rule |
| E1A03 | Layer Violation | Cross-layer dependency not allowed |
| E1A04 | Invalid Architecture Rule | Rule syntax error |
| E1A05 | Conflicting Architecture Rules | Conflicting forbid/allow |
| E1A06 | Circular Module Dependency | Circular module imports |
"""

import std.spec


# ============================================================================
# E1A01: Forbidden Import
# ============================================================================

describe "E1A01 Forbidden Import":
    """
    ## Forbidden Import Errors

    An import statement violates an architecture rule defined
    with `forbid pc{import(...)}`.
    """

    context "when import violates rule":
        """
        ### Scenario: Layer Boundary Violation

        Importing from a layer that isn't allowed.
        """

        it "reports error for forbidden import":
            # Code that would trigger E1A01:
            # # In domain/user.spl:
            # import infrastructure.database  # Forbidden by rule!
            val error_code = "E1A01"
            val error_title = "Forbidden Import"
            expect(error_code).to(eq("E1A01"))
            expect(error_title).to(contain("Import"))


# ============================================================================
# E1A02: Forbidden Dependency
# ============================================================================

describe "E1A02 Forbidden Dependency":
    """
    ## Forbidden Dependency Errors

    A module depends on another module that is explicitly forbidden
    by architecture rules.
    """

    context "when dependency is forbidden":
        it "reports error for forbidden dependency":
            # Code that would trigger E1A02:
            # # Rule: forbid pc{depend(api.* -> db.*)}
            # # In api/handler.spl:
            # # Direct use of db module
            val error_code = "E1A02"
            val error_title = "Forbidden Dependency"
            expect(error_code).to(eq("E1A02"))


# ============================================================================
# E1A03: Layer Violation
# ============================================================================

describe "E1A03 Layer Violation":
    """
    ## Layer Violation Errors

    In layered architecture, dependencies should only go "downward"
    (higher layers depend on lower). Upward dependencies are violations.
    """

    context "when cross-layer dependency violates rules":
        """
        ### Scenario: Domain Depends on Presentation

        A domain layer module importing from presentation layer.
        """

        it "reports error for layer violation":
            # Code that would trigger E1A03:
            # # domain/service.spl importing from presentation/view.spl
            val error_code = "E1A03"
            val error_title = "Layer Violation"
            expect(error_code).to(eq("E1A03"))
            expect(error_title).to(contain("Layer"))


# ============================================================================
# E1A04: Invalid Architecture Rule
# ============================================================================

describe "E1A04 Invalid Architecture Rule":
    """
    ## Invalid Rule Errors

    Architecture rules must follow valid syntax using the unified
    predicate grammar.
    """

    context "when rule syntax is invalid":
        it "reports error for invalid rule":
            # Code that would trigger E1A04:
            # architecture:
            #     rules:
            #         forbid import(foo)  # Missing pc{} wrapper
            val error_code = "E1A04"
            val error_title = "Invalid Architecture Rule"
            expect(error_code).to(eq("E1A04"))


# ============================================================================
# E1A05: Conflicting Architecture Rules
# ============================================================================

describe "E1A05 Conflicting Architecture Rules":
    """
    ## Conflicting Rules Errors

    When both `forbid` and `allow` rules match the same import/dependency,
    the rules conflict.
    """

    context "when rules conflict":
        it "reports error for conflicting rules":
            # Code that would trigger E1A05:
            # rules:
            #     forbid pc{import(a -> b)}
            #     allow pc{import(a -> b)}  # Conflicts!
            val error_code = "E1A05"
            val error_title = "Conflicting Architecture Rules"
            expect(error_code).to(eq("E1A05"))


# ============================================================================
# E1A06: Circular Module Dependency
# ============================================================================

describe "E1A06 Circular Module Dependency":
    """
    ## Circular Module Errors

    Modules cannot have circular import dependencies.
    """

    context "when modules have circular imports":
        """
        ### Scenario: A imports B, B imports A

        Direct circular import chain.
        """

        it "reports error for circular dependency":
            # Code that would trigger E1A06:
            # # a.spl: import b
            # # b.spl: import a  # Circular!
            val error_code = "E1A06"
            val error_title = "Circular Module Dependency"
            expect(error_code).to(eq("E1A06"))
            expect(error_title).to(contain("Circular"))


# ============================================================================
# Korean Language Support Tests
# ============================================================================

describe "Architecture Error Messages - Korean (한국어)":
    """
    ## i18n 검증: 아키텍처 규칙 오류 메시지 한국어 번역

    모든 아키텍처 규칙 오류 코드는 한국어 번역을 지원합니다.
    """

    it "E1A01 has Korean translation":
        val ko_title = "금지된 임포트"
        expect(ko_title).to(contain("임포트"))

    it "E1A03 has Korean translation":
        val ko_title = "레이어 위반"
        expect(ko_title).to(contain("레이어"))

    it "E1A06 has Korean translation":
        val ko_title = "순환 모듈 종속성"
        expect(ko_title).to(contain("순환"))
