# Tensor Reshape Examples
#
# Demonstrates reshape operations with element count verification

print("============================================================")
print("  TENSOR RESHAPE EXAMPLES")
print("============================================================")
print("")

enum Dim:
    Literal(value: Int)
    Named(name: String, lo: Int, hi: Int)

enum ShapeError:
    ReshapeMismatch(input_elems: Int, output_elems: Int)

class TensorShape:
    dims: List<Dim>

    fn __init__(dims: List<Dim>):
        self.dims = dims

enum ShapeResult:
    Ok(shape: TensorShape)
    Err(error: ShapeError)

fn dim_to_string(d: Dim) -> String:
    match d:
        case Dim.Literal(v):
            "{v}"
        case Dim.Named(n, lo, hi):
            if lo == hi:
                "{n}={lo}"
            else:
                "{n}:{lo}..{hi}"
        case _:
            "*"

fn shape_to_string(shape: TensorShape) -> String:
    if shape.dims.len() == 0:
        return "[]"
    var result = "["
    var first = true
    for d in shape.dims:
        if not first:
            result = result + ", "
        result = result + dim_to_string(d)
        first = false
    result + "]"

fn count_elements(shape: TensorShape) -> (Int, Int):
    var min_elems = 1
    var max_elems = 1
    for d in shape.dims:
        match d:
            case Dim.Literal(v):
                min_elems = min_elems * v
                max_elems = max_elems * v
            case Dim.Named(_, lo, hi):
                min_elems = min_elems * lo
                max_elems = max_elems * hi
            case _:
                min_elems = min_elems * 1
                max_elems = max_elems * 1000
    (min_elems, max_elems)

fn verify_reshape(input: TensorShape, output: TensorShape) -> ShapeResult:
    val (in_min, in_max) = count_elements(input)
    val (out_min, out_max) = count_elements(output)
    if in_max < out_min or out_max < in_min:
        return ShapeResult.Err(ShapeError.ReshapeMismatch(
            input_elems: in_min,
            output_elems: out_min
        ))
    ShapeResult.Ok(shape: output)

print("Example 1: Matrix to Vector")
print("------------------------------------------------------------")
val matrix = TensorShape(dims: [Dim.Literal(value: 4), Dim.Literal(value: 6)])
val vector = TensorShape(dims: [Dim.Literal(value: 24)])
print("Reshape: {shape_to_string(matrix)} -> {shape_to_string(vector)}")
match verify_reshape(matrix, vector):
    case ShapeResult.Ok(_):
        print("Result: Valid (4x6 = 24 elements)")
    case ShapeResult.Err(e):
        print("Result: Invalid")
print("")

print("Example 2: MNIST Flatten")
print("------------------------------------------------------------")
val mnist_2d = TensorShape(dims: [Dim.Literal(value: 28), Dim.Literal(value: 28)])
val mnist_1d = TensorShape(dims: [Dim.Literal(value: 784)])
print("Reshape: {shape_to_string(mnist_2d)} -> {shape_to_string(mnist_1d)}")
match verify_reshape(mnist_2d, mnist_1d):
    case ShapeResult.Ok(_):
        print("Result: Valid (28x28 = 784 elements)")
    case ShapeResult.Err(e):
        print("Result: Invalid")
print("")

print("Example 3: Invalid Reshape")
print("------------------------------------------------------------")
val input_bad = TensorShape(dims: [Dim.Literal(value: 10), Dim.Literal(value: 5)])
val output_bad = TensorShape(dims: [Dim.Literal(value: 12), Dim.Literal(value: 4)])
print("Reshape: {shape_to_string(input_bad)} -> {shape_to_string(output_bad)}")
match verify_reshape(input_bad, output_bad):
    case ShapeResult.Ok(_):
        print("Result: Should have failed!")
    case ShapeResult.Err(e):
        print("Result: Correctly rejected (50 != 48 elements)")
print("")

print("============================================================")
print("  Summary: All reshape validations working correctly")
print("============================================================")
