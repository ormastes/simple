# Complete Cross-Platform UI Example
#
# Demonstrates that the SAME UI code works across ALL backends:
#   - Browser (DOM-based, WebAssembly)
#   - TUI (Terminal, ANSI escape codes)
#   - Electron (Desktop app with native features)
#   - VS Code (Extension webview with toolkit components)
#
# This proves the RenderBackend abstraction is truly universal!

use core.*
use concurrency.*
use ui.element.*
use ui.attrs.*
use ui.patchset.*
use ui.renderer.*
use ui.diff.*
use ui.gui.browser.*
use ui.gui.electron.*
use ui.gui.vscode.*
use ui.tui.renderer_async.*

# =============================================================================
# Shared UI Code (100% Backend-Agnostic!)
# =============================================================================

# Settings panel UI
fn create_settings_ui(settings: &AppSettings) -> ElementTree:
    let mut tree = ElementTree::new(ElementKind::Div)
    let root = tree.root_mut()

    # Title
    let title = Element::text(tree.alloc_id(), "Application Settings")
        .with_style("color", "cyan")
        .with_style("font-weight", "bold")
        .with_style("font-size", "20px")

    # General Settings Section
    let mut general_section = Element::div(tree.alloc_id())
        .with_class("settings-section")

    let general_title = Element::text(tree.alloc_id(), "General")
        .with_style("font-weight", "bold")

    let theme_label = Element::text(tree.alloc_id(), "Theme:")
    let theme_select = Element::select(tree.alloc_id())
        .with_attr("value", &settings.theme)
        .on_event("change", 10)

    for theme_option in ["Light", "Dark", "Auto"]:
        let option = Element::option(tree.alloc_id())
            .with_attr("value", theme_option)
            .with_text(theme_option)
        theme_select = theme_select.with_child(option)

    let language_label = Element::text(tree.alloc_id(), "Language:")
    let language_select = Element::select(tree.alloc_id())
        .with_attr("value", &settings.language)
        .on_event("change", 11)

    for lang in ["English", "Spanish", "French", "German", "Japanese"]:
        let option = Element::option(tree.alloc_id())
            .with_attr("value", lang)
            .with_text(lang)
        language_select = language_select.with_child(option)

    general_section = general_section
        .with_child(general_title)
        .with_child(theme_label)
        .with_child(theme_select)
        .with_child(language_label)
        .with_child(language_select)

    # Notifications Section
    let mut notifications_section = Element::div(tree.alloc_id())
        .with_class("settings-section")

    let notifications_title = Element::text(tree.alloc_id(), "Notifications")
        .with_style("font-weight", "bold")

    let email_checkbox = Element::checkbox(tree.alloc_id())
        .with_attr("checked", if settings.email_notifications: "true" else: "false")
        .with_attr("label", "Email notifications")
        .on_event("change", 20)

    let push_checkbox = Element::checkbox(tree.alloc_id())
        .with_attr("checked", if settings.push_notifications: "true" else: "false")
        .with_attr("label", "Push notifications")
        .on_event("change", 21)

    let sound_checkbox = Element::checkbox(tree.alloc_id())
        .with_attr("checked", if settings.sound_enabled: "true" else: "false")
        .with_attr("label", "Sound effects")
        .on_event("change", 22)

    notifications_section = notifications_section
        .with_child(notifications_title)
        .with_child(email_checkbox)
        .with_child(push_checkbox)
        .with_child(sound_checkbox)

    # Privacy Section
    let mut privacy_section = Element::div(tree.alloc_id())
        .with_class("settings-section")

    let privacy_title = Element::text(tree.alloc_id(), "Privacy")
        .with_style("font-weight", "bold")

    let analytics_checkbox = Element::checkbox(tree.alloc_id())
        .with_attr("checked", if settings.analytics_enabled: "true" else: "false")
        .with_attr("label", "Share analytics data")
        .on_event("change", 30)

    let crash_reports_checkbox = Element::checkbox(tree.alloc_id())
        .with_attr("checked", if settings.crash_reports: "true" else: "false")
        .with_attr("label", "Send crash reports")
        .on_event("change", 31)

    privacy_section = privacy_section
        .with_child(privacy_title)
        .with_child(analytics_checkbox)
        .with_child(crash_reports_checkbox)

    # Action Buttons
    let mut buttons = Element::div(tree.alloc_id())
        .with_style("display", "flex")
        .with_style("gap", "10px")
        .with_style("margin-top", "20px")

    let save_button = Element::button(tree.alloc_id(), "Save Settings")
        .with_class("primary")
        .on_event("click", 100)

    let reset_button = Element::button(tree.alloc_id(), "Reset to Defaults")
        .with_class("secondary")
        .on_event("click", 101)

    buttons = buttons
        .with_child(save_button)
        .with_child(reset_button)

    # Assemble UI
    root.with_child(title)
        .with_child(general_section)
        .with_child(notifications_section)
        .with_child(privacy_section)
        .with_child(buttons)

    return tree

# File browser UI
fn create_file_browser_ui(current_path: &str, files: &Array[FileEntry]) -> ElementTree:
    let mut tree = ElementTree::new(ElementKind::Div)
    let root = tree.root_mut()

    # Header with current path
    let header = Element::div(tree.alloc_id())
        .with_class("file-browser-header")
        .with_child(Element::text(tree.alloc_id(), "File Browser"))
        .with_child(Element::text(tree.alloc_id(), &"Path: {current_path}"))

    # Toolbar
    let mut toolbar = Element::div(tree.alloc_id())
        .with_class("toolbar")

    let new_folder_btn = Element::button(tree.alloc_id(), "New Folder")
        .with_class("icon")
        .on_event("click", 200)

    let upload_btn = Element::button(tree.alloc_id(), "Upload")
        .with_class("icon")
        .on_event("click", 201)

    let refresh_btn = Element::button(tree.alloc_id(), "Refresh")
        .with_class("icon")
        .on_event("click", 202)

    toolbar = toolbar
        .with_child(new_folder_btn)
        .with_child(upload_btn)
        .with_child(refresh_btn)

    # File list
    let mut file_list = Element::div(tree.alloc_id())
        .with_class("file-list")

    for (i, file) in files.iter().enumerate():
        let file_item = Element::div(tree.alloc_id())
            .with_class("file-item")
            .with_key(&"file-{i}")
            .with_child(
                Element::span(tree.alloc_id())
                    .with_text(&file.icon())
                    .with_class("file-icon")
            )
            .with_child(
                Element::span(tree.alloc_id())
                    .with_text(&file.name)
                    .with_class("file-name")
            )
            .with_child(
                Element::span(tree.alloc_id())
                    .with_text(&file.size_string())
                    .with_class("file-size")
            )
            .with_child(
                Element::span(tree.alloc_id())
                    .with_text(&file.modified_string())
                    .with_class("file-date")
            )
            .on_event("click", 300 + i as u64)

        file_list = file_list.with_child(file_item)

    # Assemble
    root.with_child(header)
        .with_child(toolbar)
        .with_child(file_list)

    return tree

# Data visualization UI (charts/graphs)
fn create_data_viz_ui(data: &ChartData) -> ElementTree:
    let mut tree = ElementTree::new(ElementKind::Div)
    let root = tree.root_mut()

    # Title
    let title = Element::text(tree.alloc_id(), "Sales Dashboard")
        .with_style("font-size", "24px")
        .with_style("font-weight", "bold")

    # Chart controls
    let mut controls = Element::div(tree.alloc_id())
        .with_class("chart-controls")

    let period_label = Element::text(tree.alloc_id(), "Period:")
    let period_select = Element::select(tree.alloc_id())
        .with_attr("value", &data.period)
        .on_event("change", 400)

    for period in ["Daily", "Weekly", "Monthly", "Yearly"]:
        let option = Element::option(tree.alloc_id())
            .with_attr("value", period)
            .with_text(period)
        period_select = period_select.with_child(option)

    controls = controls
        .with_child(period_label)
        .with_child(period_select)

    # Stats grid
    let mut stats_grid = Element::div(tree.alloc_id())
        .with_style("display", "grid")
        .with_style("grid-template-columns", "repeat(4, 1fr)")
        .with_style("gap", "20px")

    # Total Sales
    let sales_stat = Element::div(tree.alloc_id())
        .with_class("stat-card")
        .with_child(Element::text(tree.alloc_id(), "Total Sales"))
        .with_child(Element::text(tree.alloc_id(), &"${data.total_sales}"))

    # Orders
    let orders_stat = Element::div(tree.alloc_id())
        .with_class("stat-card")
        .with_child(Element::text(tree.alloc_id(), "Orders"))
        .with_child(Element::text(tree.alloc_id(), &data.total_orders.to_string()))

    # Customers
    let customers_stat = Element::div(tree.alloc_id())
        .with_class("stat-card")
        .with_child(Element::text(tree.alloc_id(), "Customers"))
        .with_child(Element::text(tree.alloc_id(), &data.total_customers.to_string()))

    # Growth
    let growth_stat = Element::div(tree.alloc_id())
        .with_class("stat-card")
        .with_child(Element::text(tree.alloc_id(), "Growth"))
        .with_child(Element::text(tree.alloc_id(), &"{data.growth_rate}%"))

    stats_grid = stats_grid
        .with_child(sales_stat)
        .with_child(orders_stat)
        .with_child(customers_stat)
        .with_child(growth_stat)

    # Chart placeholder (actual charting would need canvas/SVG)
    let chart_area = Element::div(tree.alloc_id())
        .with_class("chart-area")
        .with_style("height", "400px")
        .with_style("border", "1px solid #ccc")
        .with_child(Element::text(tree.alloc_id(), "[Chart Visualization Here]"))

    # Assemble
    root.with_child(title)
        .with_child(controls)
        .with_child(stats_grid)
        .with_child(chart_area)

    return tree

# =============================================================================
# Data Structures
# =============================================================================

struct AppSettings:
    theme: String
    language: String
    email_notifications: bool
    push_notifications: bool
    sound_enabled: bool
    analytics_enabled: bool
    crash_reports: bool

struct FileEntry:
    name: String
    is_directory: bool
    size_bytes: u64
    modified_timestamp: u64

impl FileEntry:
    fn icon(self) -> String:
        return if self.is_directory: "ðŸ“" else: "ðŸ“„"

    fn size_string(self) -> String:
        if self.is_directory:
            return "--"

        if self.size_bytes < 1024:
            return "{self.size_bytes} B"
        elif self.size_bytes < 1024 * 1024:
            return "{self.size_bytes / 1024} KB"
        else:
            return "{self.size_bytes / (1024 * 1024)} MB"

    fn modified_string(self) -> String:
        # TODO: Format timestamp
        return "2025-12-26"

struct ChartData:
    period: String
    total_sales: f64
    total_orders: u64
    total_customers: u64
    growth_rate: f64

# =============================================================================
# Browser Backend Example
# =============================================================================

async fn run_with_browser_backend():
    let renderer = BrowserRenderer::new("app")?
    await renderer.init()

    let settings = AppSettings {
        theme: "Dark",
        language: "English",
        email_notifications: true,
        push_notifications: false,
        sound_enabled: true,
        analytics_enabled: false,
        crash_reports: true
    }

    let tree = create_settings_ui(&settings)
    await renderer.render(&tree)

    # Event loop would go here...
    await renderer.shutdown()

# =============================================================================
# TUI Backend Example
# =============================================================================

async fn run_with_tui_backend():
    let renderer = TuiAsyncRenderer::new()
        .with_alternate_screen()

    await renderer.init()

    let settings = AppSettings {
        theme: "Dark",
        language: "English",
        email_notifications: true,
        push_notifications: false,
        sound_enabled: true,
        analytics_enabled: false,
        crash_reports: true
    }

    let tree = create_settings_ui(&settings)
    await renderer.render(&tree)

    # Event loop
    loop:
        match await renderer.poll_event(16):
            case Ok(Some(Event::Key(key))):
                if key.code == KeyCode::Escape or key.code == KeyCode::Char('q'):
                    break
            case Ok(None):
                await renderer.render(&tree)
            case Err(e):
                break

    await renderer.shutdown()

# =============================================================================
# Electron Backend Example
# =============================================================================

async fn run_with_electron_backend():
    let renderer = ElectronRenderer::new("app", 1)?
    await renderer.init()

    # Use native features
    await renderer.create_system_tray("icon.png", "My App")

    let files = [
        FileEntry {
            name: "Documents",
            is_directory: true,
            size_bytes: 0,
            modified_timestamp: 0
        },
        FileEntry {
            name: "report.pdf",
            is_directory: false,
            size_bytes: 1024 * 512,
            modified_timestamp: 0
        },
        FileEntry {
            name: "image.png",
            is_directory: false,
            size_bytes: 1024 * 256,
            modified_timestamp: 0
        }
    ]

    let tree = create_file_browser_ui("/home/user", &files)
    await renderer.render(&tree)

    # Show native dialog example
    let dialog_options = OpenDialogOptions {
        title: "Open File",
        default_path: None,
        button_label: Some("Open"),
        filters: [
            FileFilter { name: "Images", extensions: ["png", "jpg", "gif"] },
            FileFilter { name: "All Files", extensions: ["*"] }
        ],
        properties: [OpenDialogProperty::OpenFile, OpenDialogProperty::MultiSelections]
    }

    match await renderer.show_open_dialog(dialog_options):
        case Ok(Some(paths)):
            # User selected files
            for path in paths:
                print("Selected: {path}")
        case Ok(None):
            # User cancelled
            pass
        case Err(e):
            print("Error: {e}")

    await renderer.shutdown()

# =============================================================================
# VS Code Backend Example
# =============================================================================

async fn run_with_vscode_backend():
    let renderer = VscodeRenderer::new("dashboard-webview")?
    await renderer.init()

    let data = ChartData {
        period: "Monthly",
        total_sales: 145250.00,
        total_orders: 342,
        total_customers: 128,
        growth_rate: 12.5
    }

    let tree = create_data_viz_ui(&data)
    await renderer.render(&tree)

    # VS Code webview event loop
    loop:
        match await renderer.poll_event(16):
            case Ok(Some(event)):
                # Handle events
                pass
            case Ok(None):
                await renderer.render(&tree)
            case Err(e):
                break

    await renderer.shutdown()

# =============================================================================
# Generic Backend Runner
# =============================================================================

async fn run_app<R: RenderBackend>(renderer: R, ui_type: UIType):
    await renderer.init()

    match ui_type:
        case UIType::Settings:
            let settings = AppSettings {
                theme: "Dark",
                language: "English",
                email_notifications: true,
                push_notifications: false,
                sound_enabled: true,
                analytics_enabled: false,
                crash_reports: true
            }
            let tree = create_settings_ui(&settings)
            await renderer.render(&tree)

        case UIType::FileBrowser:
            let files = [
                FileEntry {
                    name: "Documents",
                    is_directory: true,
                    size_bytes: 0,
                    modified_timestamp: 0
                }
            ]
            let tree = create_file_browser_ui("/home/user", &files)
            await renderer.render(&tree)

        case UIType::DataViz:
            let data = ChartData {
                period: "Monthly",
                total_sales: 145250.00,
                total_orders: 342,
                total_customers: 128,
                growth_rate: 12.5
            }
            let tree = create_data_viz_ui(&data)
            await renderer.render(&tree)

    # Event loop
    loop:
        match await renderer.poll_event(16):
            case Ok(Some(Event::Key(key))):
                if key.code == KeyCode::Escape:
                    break
            case Ok(None):
                pass
            case Err(e):
                break

    await renderer.shutdown()

enum UIType:
    Settings
    FileBrowser
    DataViz

# =============================================================================
# Main Entry Points
# =============================================================================

async fn main_browser_settings():
    run_app(BrowserRenderer::new("app")?, UIType::Settings)

async fn main_tui_settings():
    run_app(TuiAsyncRenderer::new().with_alternate_screen(), UIType::Settings)

async fn main_electron_files():
    run_app(ElectronRenderer::new("app", 1)?, UIType::FileBrowser)

async fn main_vscode_data():
    run_app(VscodeRenderer::new("dashboard-webview")?, UIType::DataViz)

# =============================================================================
# Key Takeaway
# =============================================================================

# The SAME UI code (create_settings_ui, create_file_browser_ui, create_data_viz_ui)
# works across ALL FOUR backends:
#   - Browser (DOM)
#   - TUI (Terminal)
#   - Electron (Desktop + native features)
#   - VS Code (Extension webview)
#
# Backend differences:
#   Browser:   - Pure web, WASM
#   TUI:       - Terminal grid, ANSI colors
#   Electron:  - Desktop app, native dialogs, system tray
#   VS Code:   - VS Code Toolkit components, webview messaging
#
# But the UI CODE is IDENTICAL! This proves the abstraction is solid.
