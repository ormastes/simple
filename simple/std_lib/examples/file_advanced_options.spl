# Advanced File Options Example
#
# Demonstrates advanced mmap options: access modes and access advice using unified io.fs API.

use io.fs as fs
use std.io

async fn main():
    # Example 1: Sequential access (optimized for reading start-to-end)
    io.println("=== Sequential Access Example ===")

    async with await fs.open_mmap_with("large_log.txt"_filepath, MmapMode::ReadOnly, MmapAdvice::Sequential) as mmap:
        io.println("Reading file sequentially...")
        let content = mmap.as_str()?
        # Process line by line
        for line in content.split("\n"):
            process_log_line(line)

    # Example 2: Random access (optimized for seeking)
    io.println("\n=== Random Access Example ===")

    async with await fs.open_mmap_with("database.db"_filepath, MmapMode::ReadOnly, MmapAdvice::Random) as mmap:
        io.println("Accessing file randomly...")
        # Access different parts of the file
        let header = mmap.slice(0, 512)?
        let record1 = mmap.slice(1024, 2048)?
        let record100 = mmap.slice(102400, 103424)?
        io.println(f"Read {header.len() + record1.len() + record100.len()} bytes")

    # Example 3: Read-write mode with copy-on-write
    io.println("\n=== Copy-on-Write Example ===")

    async with await fs.open_mmap_with("template.txt"_filepath, MmapMode::CopyOnWrite, MmapAdvice::Normal) as mmap:
        io.println("Using copy-on-write mode...")
        # Can modify the mapped data without changing the file
        # (modifications only in memory)
        let data = mmap.as_bytes()
        io.println(f"Template size: {data.len()} bytes")

    # Example 4: Explicit advice changes
    io.println("\n=== Dynamic Advice Example ===")

    async with await fs.open_mmap("large_data.bin"_filepath) as mmap:
        # Tell kernel we'll need this data soon (prefault)
        mmap.advise(MmapAdvice::WillNeed)
        io.println("Prefaulting pages...")

        # Process the data
        let data = mmap.as_bytes()
        process_data(data)

        # Tell kernel we're done (can evict pages)
        mmap.advise(MmapAdvice::DontNeed)
        io.println("Released pages")

fn process_log_line(line: String):
    # Process a log line
    pass

fn process_data(data: &[u8]):
    # Process binary data
    pass
