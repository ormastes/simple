# Async TCP echo server example using monoio
# Demonstrates high-performance async TCP server with io_uring
# Feature: #1753 (Simple Language TCP API)

import net::{init_runtime, shutdown_runtime, block_on}
import net.tcp::{TcpListener, TcpStream}
import core.io

# Handle a single client connection
async fn handle_client(stream: TcpStream):
    println("New connection from: " + stream.peer_addr().unwrap_or("unknown"))

    # Disable Nagle's algorithm for lower latency
    stream.set_nodelay(true)?

    # Enable TCP keepalive (60 second interval)
    stream.set_keepalive(Some(60))?

    # Buffer for reading data
    let mut buffer = Bytes::with_capacity(4096)

    loop:
        # Read data from client
        let n = await stream.read(&mut buffer, 4096)?

        # Check for EOF
        if n == 0:
            println("Client disconnected: " + stream.peer_addr().unwrap_or("unknown"))
            break

        println("Received " + n.to_string() + " bytes")

        # Echo data back to client
        await stream.write_all(buffer.slice(0, n))?

    # Close the connection
    stream.close()?

# Main server function
async fn run_server():
    # Bind to localhost port 8080
    let listener = await TcpListener::bind("127.0.0.1:8080")?
    println("Echo server listening on " + listener.local_addr())

    # Accept connections in a loop
    loop:
        # Accept new connection
        let stream = await listener.accept()?

        # Spawn a task to handle this client
        # (In full implementation, this would spawn on runtime)
        handle_client(stream)

fn main():
    println("Starting async TCP echo server...")

    # Initialize monoio runtime
    let runtime = init_runtime()?
    println("Runtime initialized with " + runtime.num_cores().to_string() + " cores")

    # Run the server (blocks until completion)
    block_on(async {
        await run_server()
    })

    # Shutdown runtime
    shutdown_runtime(runtime)
    println("Server shutdown complete")

# To test this server:
#
# 1. Start the server:
#    $ ./simple async_tcp_echo_server.spl
#
# 2. In another terminal, connect with netcat:
#    $ nc localhost 8080
#    Hello, server!
#    Hello, server!  # Server echoes back
#
# 3. Or use the client example:
#    $ ./simple async_tcp_echo_client.spl
