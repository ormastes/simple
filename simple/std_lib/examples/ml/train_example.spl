# ML Infrastructure Example
#
# Simplified example showing available ML infrastructure.

import config.{from_dict, merge}
import ml.tracking.{run, set_mode, Run}
import ml.engine.{Engine, State, Metric, Loss}


# ============================================================================
# Example 1: Configuration System
# ============================================================================

fn example_config():
    """Example: Load and merge configurations."""
    print("\n" + "=" * 70)
    print("EXAMPLE 1: Configuration System")
    print("=" * 70)

    # Create base config dict
    val base_config = {
        "project": "mnist-example",
        "seed": 42,
        "epochs": 10,
        "batch_size": 64,
        "lr": 0.001
    }

    val base = from_dict(base_config)
    print("Base config:")
    print(f"  Project: {base.get('project')}")
    print(f"  Epochs: {base.get('epochs')}")
    print(f"  Learning rate: {base.get('lr')}")

    # Create override config
    val override_config = {
        "epochs": 20,
        "lr": 0.005
    }

    print("\nOverrides:")
    print(f"  epochs: {override_config['epochs']}")
    print(f"  lr: {override_config['lr']}")

    # Show merged values
    val merged = from_dict({
        "project": "mnist-example",
        "seed": 42,
        "epochs": 20,
        "batch_size": 64,
        "lr": 0.005
    })

    print("\nMerged config:")
    print(f"  Project: {merged.get('project')}")
    print(f"  Epochs: {merged.get('epochs')}")
    print(f"  Learning rate: {merged.get('lr')}")


# ============================================================================
# Example 2: Experiment Tracking
# ============================================================================

fn example_tracking():
    """Example: Experiment tracking."""
    print("\n" + "=" * 70)
    print("EXAMPLE 2: Experiment Tracking")
    print("=" * 70)

    # Set offline mode
    set_mode("offline")
    print("Tracking mode: offline")

    # Create run with keyword args
    val tracking_run = run(
        project="mnist-example",
        name="baseline-experiment",
        config={"lr": 0.001, "epochs": 10},
        tags=["baseline"]
    )

    print(f"\nRun created:")
    print(f"  ID: {tracking_run.id}")
    print(f"  Name: {tracking_run.name}")

    # Log metrics
    print("\nLogging metrics...")
    var step = 0
    while step < 5:
        val fake_loss = 2.0 - (step * 0.3)
        val fake_acc = 0.2 + (step * 0.15)
        tracking_run.log({"train/loss": fake_loss, "train/acc": fake_acc}, step)
        print(f"  Step {step}: loss={fake_loss}, acc={fake_acc}")
        step = step + 1

    # Finish run
    tracking_run.finish()
    print("\nRun finished!")


# ============================================================================
# Example 3: Training Engine
# ============================================================================

fn example_engine():
    """Example: Training engine basics."""
    print("\n" + "=" * 70)
    print("EXAMPLE 3: Training Engine")
    print("=" * 70)

    # Create engine state
    val state = State(0, 0, 10)
    print("Engine state created:")
    print(f"  Epoch: {state.epoch}")
    print(f"  Iteration: {state.iteration}")
    print(f"  Max epochs: {state.max_epochs}")

    # Create metrics
    val loss = Loss()
    print("\nLoss metric created")

    # Simulate training loop
    print("\nSimulating training loop...")
    var epoch = 0
    while epoch < 3:
        print(f"  Epoch {epoch + 1}:")
        var batch = 0
        while batch < 4:
            val fake_loss = 1.0 - (epoch * 0.2) - (batch * 0.05)
            print(f"    Batch {batch}: loss={fake_loss}")
            batch = batch + 1
        epoch = epoch + 1

    print("\nTraining simulation complete!")


# ============================================================================
# Main
# ============================================================================

fn main():
    """Run all examples."""
    print("\n")
    print("=" * 70)
    print("  ML INFRASTRUCTURE EXAMPLES")
    print("=" * 70)

    example_config()
    example_tracking()
    example_engine()

    print("\n" + "=" * 70)
    print("All examples completed successfully!")
    print("=" * 70 + "\n")


# Run examples
main()
