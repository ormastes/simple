# Godot Input System
#
# Input handling for keyboard, mouse, and gamepad.
# Uses Godot's Input singleton for cross-platform input.
#
# Reference: https://docs.godotengine.org/en/stable/classes/class_input.html

import godot.ffi
import godot.variant
import godot.object

# Input singleton wrapper
pub struct Input:
    singleton_ptr: ffi.GDExtensionObjectPtr

impl Input:
    # Get the Input singleton
    pub fn get_singleton() -> Input:
        let ptr = godot_get_singleton("Input")
        return Input(singleton_ptr: ptr)

    # Keyboard input
    pub fn is_key_pressed(self, keycode: KeyCode) -> bool:
        let key_var = variant.Variant::from_int(keycode as i64)
        let obj = object.Object::from_ptr(self.singleton_ptr)
        let result = obj.call1("is_key_pressed", key_var)
        return result.as_bool()

    pub fn is_key_just_pressed(self, keycode: KeyCode) -> bool:
        # Check if key was just pressed this frame
        let key_var = variant.Variant::from_int(keycode as i64)
        let obj = object.Object::from_ptr(self.singleton_ptr)
        let result = obj.call1("is_key_just_pressed", key_var)
        return result.as_bool()

    pub fn is_key_just_released(self, keycode: KeyCode) -> bool:
        let key_var = variant.Variant::from_int(keycode as i64)
        let obj = object.Object::from_ptr(self.singleton_ptr)
        let result = obj.call1("is_key_just_released", key_var)
        return result.as_bool()

    # Action-based input (configured in project settings)
    pub fn is_action_pressed(self, action: String) -> bool:
        let action_var = variant.Variant::from_string(action)
        let obj = object.Object::from_ptr(self.singleton_ptr)
        let result = obj.call1("is_action_pressed", action_var)
        return result.as_bool()

    pub fn is_action_just_pressed(self, action: String) -> bool:
        let action_var = variant.Variant::from_string(action)
        let obj = object.Object::from_ptr(self.singleton_ptr)
        let result = obj.call1("is_action_just_pressed", action_var)
        return result.as_bool()

    pub fn is_action_just_released(self, action: String) -> bool:
        let action_var = variant.Variant::from_string(action)
        let obj = object.Object::from_ptr(self.singleton_ptr)
        let result = obj.call1("is_action_just_released", action_var)
        return result.as_bool()

    pub fn get_action_strength(self, action: String) -> f64:
        let action_var = variant.Variant::from_string(action)
        let obj = object.Object::from_ptr(self.singleton_ptr)
        let result = obj.call1("get_action_strength", action_var)
        return result.as_float()

    # Mouse input
    pub fn get_mouse_position(self) -> (f64, f64):
        let obj = object.Object::from_ptr(self.singleton_ptr)
        let result = obj.call0("get_mouse_position")
        return result.as_vector2()

    pub fn is_mouse_button_pressed(self, button: MouseButton) -> bool:
        let button_var = variant.Variant::from_int(button as i64)
        let obj = object.Object::from_ptr(self.singleton_ptr)
        let result = obj.call1("is_mouse_button_pressed", button_var)
        return result.as_bool()

    # Mouse mode (visible, captured, hidden, etc.)
    pub fn set_mouse_mode(mut self, mode: MouseMode):
        let mode_var = variant.Variant::from_int(mode as i64)
        let obj = object.Object::from_ptr(self.singleton_ptr)
        obj.call1("set_mouse_mode", mode_var)

    pub fn get_mouse_mode(self) -> MouseMode:
        let obj = object.Object::from_ptr(self.singleton_ptr)
        let result = obj.call0("get_mouse_mode")
        return result.as_int() as MouseMode

    # Gamepad/Joypad input
    pub fn is_joy_button_pressed(self, device: i32, button: JoyButton) -> bool:
        let device_var = variant.Variant::from_int(device as i64)
        let button_var = variant.Variant::from_int(button as i64)
        let obj = object.Object::from_ptr(self.singleton_ptr)
        let result = obj.call2("is_joy_button_pressed", device_var, button_var)
        return result.as_bool()

    pub fn get_joy_axis(self, device: i32, axis: JoyAxis) -> f64:
        let device_var = variant.Variant::from_int(device as i64)
        let axis_var = variant.Variant::from_int(axis as i64)
        let obj = object.Object::from_ptr(self.singleton_ptr)
        let result = obj.call2("get_joy_axis", device_var, axis_var)
        return result.as_float()

    pub fn get_connected_joypads(self) -> Array[i32]:
        let obj = object.Object::from_ptr(self.singleton_ptr)
        let result = obj.call0("get_connected_joypads")
        # TODO: [stdlib][P3] Convert array variant to Array[i32]
        return Array[i32]::new()

    # Vibration (gamepad rumble)
    pub fn start_joy_vibration(mut self, device: i32, weak: f64, strong: f64, duration: f64):
        let device_var = variant.Variant::from_int(device as i64)
        let weak_var = variant.Variant::from_float(weak)
        let strong_var = variant.Variant::from_float(strong)
        let duration_var = variant.Variant::from_float(duration)
        
        let obj = object.Object::from_ptr(self.singleton_ptr)
        let mut args = Array[variant.Variant]::new()
        args.push(device_var)
        args.push(weak_var)
        args.push(strong_var)
        args.push(duration_var)
        obj.call("start_joy_vibration", args)

    pub fn stop_joy_vibration(mut self, device: i32):
        let device_var = variant.Variant::from_int(device as i64)
        let obj = object.Object::from_ptr(self.singleton_ptr)
        obj.call1("stop_joy_vibration", device_var)

# Key codes (subset of common keys)
pub enum KeyCode:
    Space = 32
    A = 65
    B = 66
    C = 67
    D = 68
    E = 69
    F = 70
    G = 71
    H = 72
    I = 73
    J = 74
    K = 75
    L = 76
    M = 77
    N = 78
    O = 79
    P = 80
    Q = 81
    R = 82
    S = 83
    T = 84
    U = 85
    V = 86
    W = 87
    X = 88
    Y = 89
    Z = 90
    Escape = 4194305
    Enter = 4194309
    Tab = 4194306
    Backspace = 4194308
    Left = 4194319
    Right = 4194321
    Up = 4194320
    Down = 4194322
    Shift = 4194325
    Ctrl = 4194326
    Alt = 4194328

# Mouse buttons
pub enum MouseButton:
    Left = 1
    Right = 2
    Middle = 3
    WheelUp = 4
    WheelDown = 5
    WheelLeft = 6
    WheelRight = 7
    Extra1 = 8
    Extra2 = 9

# Mouse modes
pub enum MouseMode:
    Visible = 0
    Hidden = 1
    Captured = 2
    Confined = 3

# Joypad buttons (Xbox/PlayStation layout)
pub enum JoyButton:
    A = 0           # Xbox A / PlayStation X
    B = 1           # Xbox B / PlayStation Circle
    X = 2           # Xbox X / PlayStation Square
    Y = 3           # Xbox Y / PlayStation Triangle
    LeftShoulder = 4
    RightShoulder = 5
    LeftTrigger = 6
    RightTrigger = 7
    Select = 8
    Start = 9
    LeftStick = 10
    RightStick = 11
    DPadUp = 12
    DPadDown = 13
    DPadLeft = 14
    DPadRight = 15

# Joypad axes
pub enum JoyAxis:
    LeftX = 0
    LeftY = 1
    RightX = 2
    RightY = 3
    TriggerLeft = 4
    TriggerRight = 5

extern "C" fn godot_get_singleton(name: String) -> ffi.GDExtensionObjectPtr
