# Godot Object Base Class
#
# Object is the base class for all Godot classes.
# Provides reference counting, method calls, and signals.
#
# Reference: https://docs.godotengine.org/en/stable/classes/class_object.html

import godot.ffi
import godot.variant

# Base Object wrapper
pub struct Object:
    ptr: ffi.GDExtensionObjectPtr
    owns_reference: bool

impl Object:
    # Wrap an existing Godot object pointer
    pub fn from_ptr(ptr: ffi.GDExtensionObjectPtr) -> Object:
        return Object(ptr: ptr, owns_reference: false)

    # Call a method on this object
    pub fn call(self, method_name: String, args: Array[variant.Variant]) -> variant.Variant:
        val method_sname = variant.StringName::new(method_name)
        val class_sname = variant.StringName::new(self.get_class())

        # Get method binding
        val method_bind = ffi.godot_classdb_get_method_bind(
            class_sname.ptr(),
            method_sname.ptr(),
            0  # Hash (0 = auto-compute)
        )

        if method_bind == 0:
            return variant.Variant::nil()

        # Prepare argument pointers
        var arg_ptrs = Array[ffi.GDExtensionVariantPtr]::new()
        for arg in args:
            arg_ptrs.push(arg.ptr())

        # Call method
        val ret_ptr = variant.runtime_allocate_variant()
        var error: i32 = 0

        ffi.godot_object_method_bind_call(
            method_bind,
            self.ptr,
            arg_ptrs.data(),
            args.len() as i64,
            ret_ptr,
            &mut error
        )

        # Return result
        return variant.Variant(ptr: ret_ptr, owns_data: true)

    # Call a method with no arguments
    pub fn call0(self, method_name: String) -> variant.Variant:
        return self.call(method_name, Array[variant.Variant]::new())

    # Call a method with one argument
    pub fn call1(self, method_name: String, arg1: variant.Variant) -> variant.Variant:
        var args = Array[variant.Variant]::new()
        args.push(arg1)
        return self.call(method_name, args)

    # Call a method with two arguments
    pub fn call2(self, method_name: String, arg1: variant.Variant, arg2: variant.Variant) -> variant.Variant:
        var args = Array[variant.Variant]::new()
        args.push(arg1)
        args.push(arg2)
        return self.call(method_name, args)

    # Get the class name of this object
    pub fn get_class(self) -> String:
        val result = self.call0("get_class")
        return result.as_string()

    # Get object pointer
    pub fn ptr(self) -> ffi.GDExtensionObjectPtr:
        return self.ptr

    # Check if object is valid
    pub fn is_valid(self) -> bool:
        return self.ptr != 0

    # Destructor
    pub fn drop(mut self):
        if self.owns_reference and self.ptr != 0:
            # Call free() method on Object
            self.call0("free")
            self.ptr = 0
