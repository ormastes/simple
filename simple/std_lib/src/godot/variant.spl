# Godot Variant Type System
#
# Variant is Godot's universal value type that can hold any value.
# This module provides type-safe Simple wrappers for Variant operations.
#
# Reference: https://docs.godotengine.org/en/stable/classes/class_variant.html

import godot.ffi

# Variant type - Godot's universal value container
pub struct Variant:
    ptr: ffi.GDExtensionVariantPtr
    owns_data: bool

impl Variant:
    # Create a nil (null) variant
    pub fn nil() -> Variant:
        val ptr = runtime_allocate_variant()
        ffi.godot_variant_new_nil(ptr)
        return Variant(ptr: ptr, owns_data: true)

    # Create from boolean
    pub fn from_bool(value: bool) -> Variant:
        val ptr = runtime_allocate_variant()
        ffi.godot_variant_new_bool(ptr, value)
        return Variant(ptr: ptr, owns_data: true)

    # Create from integer
    pub fn from_int(value: i64) -> Variant:
        val ptr = runtime_allocate_variant()
        ffi.godot_variant_new_int(ptr, value)
        return Variant(ptr: ptr, owns_data: true)

    # Create from f32
    pub fn from_float(value: f64) -> Variant:
        val ptr = runtime_allocate_variant()
        ffi.godot_variant_new_float(ptr, value)
        return Variant(ptr: ptr, owns_data: true)

    # Create from string
    pub fn from_string(value: text) -> Variant:
        val ptr = runtime_allocate_variant()
        val str_ptr = string_to_godot_string(value)
        ffi.godot_variant_new_string(ptr, str_ptr)
        ffi.godot_string_destroy(str_ptr)
        return Variant(ptr: ptr, owns_data: true)

    # Create from object pointer
    pub fn from_object(obj_ptr: ffi.GDExtensionObjectPtr) -> Variant:
        val ptr = runtime_allocate_variant()
        ffi.godot_variant_new_object(ptr, obj_ptr)
        return Variant(ptr: ptr, owns_data: true)

    # Create from Vector2
    pub fn from_vector2(x: f64, y: f64) -> Variant:
        val ptr = runtime_allocate_variant()
        ffi.godot_variant_new_vector2(ptr, x, y)
        return Variant(ptr: ptr, owns_data: true)

    # Create from Vector3
    pub fn from_vector3(x: f64, y: f64, z: f64) -> Variant:
        val ptr = runtime_allocate_variant()
        ffi.godot_variant_new_vector3(ptr, x, y, z)
        return Variant(ptr: ptr, owns_data: true)

    # Create from Color
    pub fn from_color(r: f32, g: f32, b: f32, a: f32) -> Variant:
        val ptr = runtime_allocate_variant()
        ffi.godot_variant_new_color(ptr, r, g, b, a)
        return Variant(ptr: ptr, owns_data: true)

    # Create array variant
    pub fn new_array() -> Variant:
        val ptr = runtime_allocate_variant()
        ffi.godot_variant_new_array(ptr)
        return Variant(ptr: ptr, owns_data: true)

    # Create dictionary variant
    pub fn new_dictionary() -> Variant:
        val ptr = runtime_allocate_variant()
        ffi.godot_variant_new_dictionary(ptr)
        return Variant(ptr: ptr, owns_data: true)

    # Copy constructor
    pub fn copy(other: &Variant) -> Variant:
        val ptr = runtime_allocate_variant()
        ffi.godot_variant_new_copy(ptr, other.ptr)
        return Variant(ptr: ptr, owns_data: true)

    # Extract as boolean
    pub fn as_bool(self) -> bool:
        return ffi.godot_variant_as_bool(self.ptr)

    # Extract as integer
    pub fn as_int(self) -> i64:
        return ffi.godot_variant_as_int(self.ptr)

    # Extract as f32
    pub fn as_float(self) -> f64:
        return ffi.godot_variant_as_float(self.ptr)

    # Extract as string
    pub fn as_string(self) -> text:
        val str_ptr = ffi.godot_variant_as_string(self.ptr)
        val result = godot_string_to_string(str_ptr)
        ffi.godot_string_destroy(str_ptr)
        return result

    # Extract as object pointer
    pub fn as_object(self) -> ffi.GDExtensionObjectPtr:
        return ffi.godot_variant_as_object(self.ptr)

    # Extract as Vector2
    pub fn as_vector2(self) -> (f64, f64):
        var x: f64 = 0.0
        var y: f64 = 0.0
        ffi.godot_variant_as_vector2(self.ptr, &mut x, &mut y)
        return (x, y)

    # Extract as Vector3
    pub fn as_vector3(self) -> (f64, f64, f64):
        var x: f64 = 0.0
        var y: f64 = 0.0
        var z: f64 = 0.0
        ffi.godot_variant_as_vector3(self.ptr, &mut x, &mut y, &mut z)
        return (x, y, z)

    # Extract as Vector2i (integer vector)
    pub fn as_vector2i(self) -> (i32, i32):
        var x: i32 = 0
        var y: i32 = 0
        ffi.godot_variant_as_vector2i(self.ptr, &mut x, &mut y)
        return (x, y)

    # Extract as RID (Resource ID)
    pub fn as_rid(self) -> u64:
        """Extract RID from variant.

        RID is Godot's opaque resource identifier, internally stored as u64.
        """
        return ffi.godot_variant_as_rid(self.ptr)

    # Extract as PackedInt32Array
    pub fn as_packed_int32_array(self) -> [i32]:
        """Extract PackedInt32Array from variant."""
        var length: i32 = 0
        val data_ptr = ffi.godot_variant_as_packed_int32_array(self.ptr, &mut length)
        var result: [i32] = []
        for i in 0..length:
            result.append(data_ptr[i])
        return result

    # Extract as PackedStringArray
    pub fn as_packed_string_array(self) -> [text]:
        """Extract PackedStringArray from variant."""
        var length: i32 = 0
        val strings_ptr = ffi.godot_variant_as_packed_string_array(self.ptr, &mut length)
        var result: [text] = []
        for i in 0..length:
            val str_ptr = strings_ptr[i]
            val s = godot_string_to_string(str_ptr)
            result.append(s)
        return result

    # Get internal pointer (for FFI calls)
    pub fn ptr(self) -> ffi.GDExtensionVariantPtr:
        return self.ptr

    # Destructor
    pub fn drop(mut self):
        if self.owns_data:
            ffi.godot_variant_destroy(self.ptr)
            runtime_free_variant(self.ptr)
            self.owns_data = false

# StringName - Godot's optimized string type for identifiers
pub struct StringName:
    ptr: ffi.GDExtensionStringNamePtr
    owns_data: bool

impl StringName:
    # Create from string
    pub fn new(name: text) -> StringName:
        val ptr = runtime_allocate_string_name()
        val bytes = name.as_bytes()
        ffi.godot_string_name_new_with_utf8_chars(ptr, bytes.data(), bytes.len() as i64)
        return StringName(ptr: ptr, owns_data: true)

    # Get internal pointer
    pub fn ptr(self) -> ffi.GDExtensionStringNamePtr:
        return self.ptr

    # Destructor
    pub fn drop(mut self):
        if self.owns_data:
            ffi.godot_string_name_destroy(self.ptr)
            runtime_free_string_name(self.ptr)
            self.owns_data = false

# Helper functions (implemented in Rust runtime)
extern "C" fn runtime_allocate_variant() -> ffi.GDExtensionVariantPtr
extern "C" fn runtime_free_variant(ptr: ffi.GDExtensionVariantPtr)
extern "C" fn runtime_allocate_string_name() -> ffi.GDExtensionStringNamePtr
extern "C" fn runtime_free_string_name(ptr: ffi.GDExtensionStringNamePtr)

# text conversion helpers
fn string_to_godot_string(s: text) -> ffi.GDExtensionStringPtr:
    val ptr = runtime_allocate_godot_string()
    val bytes = s.as_bytes()
    ffi.godot_string_new_with_utf8_chars(ptr, bytes.data(), bytes.len() as i64)
    return ptr

fn godot_string_to_string(ptr: ffi.GDExtensionStringPtr) -> text:
    # Get length first
    val len = ffi.godot_string_to_utf8_chars(ptr, null, 0)
    if len <= 0:
        return ""

    # Allocate buffer and copy
    var buffer = Array<u8>::with_capacity(len as usize)
    ffi.godot_string_to_utf8_chars(ptr, buffer.data(), len)

    return text::from_utf8(buffer)

extern "C" fn runtime_allocate_godot_string() -> ffi.GDExtensionStringPtr
extern "C" fn runtime_free_godot_string(ptr: ffi.GDExtensionStringPtr)
