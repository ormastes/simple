# Trait Implementations (GC Mutable Variant)
#
# Standard trait implementations for File type.

use units.file.*
use units.size.*
use host.common.io.*
use core.traits.*
from file import {File}

export impl_file_traits

# Marker for trait implementations
fn impl_file_traits():
    pass  # Traits are implemented below

impl Read for File:
    fn read(buf: &mut [u8]) -> Result<usize, IoError>:
        var bytes = Bytes::from_slice(buf)
        match native_file_read(self.handle, &mut bytes):
            case Ok(count):
                buf.copy_from_slice(&bytes.as_slice())
                Ok(count as usize)
            case Err(e): Err(e)

impl Write for File:
    fn write(buf: &[u8]) -> Result<usize, IoError>:
        val bytes = Bytes::from_slice(buf)
        match native_file_write(self.handle, &bytes):
            case Ok(count): Ok(count as usize)
            case Err(e): Err(e)

    fn flush() -> Result<(), IoError>:
        native_file_flush(self.handle)

impl Seek for File:
    fn seek(pos: core.traits.SeekFrom) -> Result<u64, IoError>:
        val local_pos = match pos:
            case core.traits.SeekFrom::Start(n): SeekFrom::Start(n)
            case core.traits.SeekFrom::End(n): SeekFrom::End(n)
            case core.traits.SeekFrom::Current(n): SeekFrom::Current(n)
        match native_file_seek(self.handle, local_pos):
            case Ok(count): Ok(count as u64)
            case Err(e): Err(e)

impl Drop for File:
    fn drop():
        native_file_close(self.handle)

impl AsyncContextManager<File> for File:
    async fn __aenter__(self) -> File:
        return self

    async fn __aexit__(self, exc: Option<Exception>) -> bool:
        val _ = await self.close()
        return false
