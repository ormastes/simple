# Bare Metal Startup - Entry point and initialization
#
# Provides the startup code for bare metal environments.
# Handles early initialization before main() is called.

# Early initialization callback type
type InitFn = fn() -> ()

# Panic handler type
type PanicHandler = fn(text) -> !

# Default panic handler - halts the system
fn default_panic_handler(msg: text) -> !:
    # In bare metal, we can't do much - just halt
    halt()

# Global panic handler (can be overridden)
static var panic_handler: PanicHandler = default_panic_handler

# Set custom panic handler
fn set_panic_handler(handler: PanicHandler):
    panic_handler = handler

# Called on panic
fn panic(msg: text) -> !:
    panic_handler(msg)

# Halt the processor
@inline
@extern("bare", "halt")
fn halt() -> !:
    pass

# Reset the processor
@inline
@extern("bare", "reset")
fn reset() -> !:
    pass

# Disable interrupts
@inline
@extern("bare", "disable_interrupts")
fn disable_interrupts():
    pass

# Enable interrupts
@inline
@extern("bare", "enable_interrupts")
fn enable_interrupts():
    pass

# Check if interrupts are enabled
@inline
@extern("bare", "interrupts_enabled")
fn interrupts_enabled() -> bool:
    pass

# Execute with interrupts disabled
fn with_interrupts_disabled<T>(f: fn() -> T) -> T:
    val was_enabled = interrupts_enabled()
    disable_interrupts()
    val result = f()
    if was_enabled:
        enable_interrupts()
    return result

# Memory barrier - ensure memory operations complete
@inline
@extern("bare", "memory_barrier")
fn memory_barrier():
    pass

# Data memory barrier
@inline
@extern("bare", "data_memory_barrier")
fn data_memory_barrier():
    pass

# Instruction memory barrier
@inline
@extern("bare", "instruction_memory_barrier")
fn instruction_memory_barrier():
    pass

# No-operation instruction
@inline
@extern("bare", "nop")
fn nop():
    pass

# Wait for interrupt (low-power wait)
@inline
@extern("bare", "wfi")
fn wait_for_interrupt():
    pass

# Wait for event
@inline
@extern("bare", "wfe")
fn wait_for_event():
    pass

# Send event
@inline
@extern("bare", "sev")
fn send_event():
    pass

export panic, set_panic_handler, halt, reset
export disable_interrupts, enable_interrupts, interrupts_enabled
export with_interrupts_disabled
export memory_barrier, data_memory_barrier, instruction_memory_barrier
export nop, wait_for_interrupt, wait_for_event, send_event
