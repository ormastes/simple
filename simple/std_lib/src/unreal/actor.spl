# Unreal AActor Wrapper
#
# Type-safe wrapper for Unreal Engine's AActor base class
#
# Features:
# - Actor lifecycle (BeginPlay, Tick, EndPlay)
# - Transform manipulation (location, rotation, scale)
# - Component management
# - Actor spawning and destruction
# - Replication support
#
# Based on: https://docs.unrealengine.org/5.4/en-US/API/Runtime/Engine/GameFramework/AActor/

import sys.ffi
import unreal.component

mod actor

# ActorPtr
# Opaque pointer to Unreal AActor instance
pub struct ActorPtr:
    ptr: ffi.VoidPtr

impl ActorPtr:
    pub fn from_ptr(ptr: ffi.VoidPtr) -> ActorPtr:
        return ActorPtr(ptr: ptr)

    pub fn as_ptr(self) -> ffi.VoidPtr:
        return self.ptr

    pub fn is_valid(self) -> bool:
        return self.ptr != ffi.null_ptr()


# AActor
# Base class for all actors in Unreal Engine
pub struct AActor:
    actor_ptr: ActorPtr

impl AActor:
    # Create from existing actor pointer
    pub fn from_ptr(ptr: ffi.VoidPtr) -> AActor:
        return AActor(actor_ptr: ActorPtr::from_ptr(ptr))

    # Get raw pointer
    pub fn as_ptr(self) -> ffi.VoidPtr:
        return self.actor_ptr.as_ptr()

    # Check if actor is valid
    pub fn is_valid(self) -> bool:
        return self.actor_ptr.is_valid() && !unreal_actor_is_pending_kill(self.as_ptr())

    # === Transform Methods ===

    # Get actor location (world space)
    pub fn get_actor_location(self) -> (f64, f64, f64):
        val x = ffi.alloc_f64()
        val y = ffi.alloc_f64()
        val z = ffi.alloc_f64()
        unreal_actor_get_location(self.as_ptr(), x, y, z)
        val result = (ffi.read_f64(x), ffi.read_f64(y), ffi.read_f64(z))
        ffi.free(x)
        ffi.free(y)
        ffi.free(z)
        return result

    # Set actor location
    pub fn set_actor_location(mut self, x: f64, y: f64, z: f64, sweep: bool = false):
        unreal_actor_set_location(self.as_ptr(), x, y, z, sweep)

    # Get actor rotation (pitch, yaw, roll in degrees)
    pub fn get_actor_rotation(self) -> (f64, f64, f64):
        val pitch = ffi.alloc_f64()
        val yaw = ffi.alloc_f64()
        val roll = ffi.alloc_f64()
        unreal_actor_get_rotation(self.as_ptr(), pitch, yaw, roll)
        val result = (ffi.read_f64(pitch), ffi.read_f64(yaw), ffi.read_f64(roll))
        ffi.free(pitch)
        ffi.free(yaw)
        ffi.free(roll)
        return result

    # Set actor rotation
    pub fn set_actor_rotation(mut self, pitch: f64, yaw: f64, roll: f64):
        unreal_actor_set_rotation(self.as_ptr(), pitch, yaw, roll)

    # Get actor scale
    pub fn get_actor_scale(self) -> (f64, f64, f64):
        val x = ffi.alloc_f64()
        val y = ffi.alloc_f64()
        val z = ffi.alloc_f64()
        unreal_actor_get_scale(self.as_ptr(), x, y, z)
        val result = (ffi.read_f64(x), ffi.read_f64(y), ffi.read_f64(z))
        ffi.free(x)
        ffi.free(y)
        ffi.free(z)
        return result

    # Set actor scale
    pub fn set_actor_scale(mut self, x: f64, y: f64, z: f64):
        unreal_actor_set_scale(self.as_ptr(), x, y, z)

    # Add offset to location
    pub fn add_actor_local_offset(mut self, x: f64, y: f64, z: f64, sweep: bool = false):
        unreal_actor_add_local_offset(self.as_ptr(), x, y, z, sweep)

    # Add rotation offset
    pub fn add_actor_local_rotation(mut self, pitch: f64, yaw: f64, roll: f64):
        unreal_actor_add_local_rotation(self.as_ptr(), pitch, yaw, roll)

    # === Component Methods ===

    # Get component by name
    pub fn get_component_by_name(self, name: String) -> Option[component.UActorComponent]:
        val comp_ptr = unreal_actor_get_component_by_name(self.as_ptr(), name)
        if comp_ptr == ffi.null_ptr():
            return None
        else:
            return Some(component.UActorComponent::from_ptr(comp_ptr))

    # Get root component
    pub fn get_root_component(self) -> Option[component.UActorComponent]:
        val comp_ptr = unreal_actor_get_root_component(self.as_ptr())
        if comp_ptr == ffi.null_ptr():
            return None
        else:
            return Some(component.UActorComponent::from_ptr(comp_ptr))

    # Set root component
    pub fn set_root_component(mut self, comp: component.UActorComponent):
        unreal_actor_set_root_component(self.as_ptr(), comp.as_ptr())

    # === Lifecycle Methods ===

    # Destroy actor
    pub fn destroy(mut self):
        unreal_actor_destroy(self.as_ptr())

    # Check if actor is being destroyed
    pub fn is_pending_kill(self) -> bool:
        return unreal_actor_is_pending_kill(self.as_ptr())

    # Set lifespan (0 = infinite)
    pub fn set_lifespan(mut self, seconds: f32):
        unreal_actor_set_lifespan(self.as_ptr(), seconds)

    # Get remaining lifespan
    pub fn get_lifespan(self) -> f32:
        return unreal_actor_get_lifespan(self.as_ptr())

    # === Visibility Methods ===

    # Set actor hidden
    pub fn set_actor_hidden(mut self, hidden: bool):
        unreal_actor_set_hidden(self.as_ptr(), hidden)

    # Set actor enable collision
    pub fn set_actor_enable_collision(mut self, enabled: bool):
        unreal_actor_set_enable_collision(self.as_ptr(), enabled)

    # === Networking Methods ===

    # Set replicates
    pub fn set_replicates(mut self, replicates: bool):
        unreal_actor_set_replicates(self.as_ptr(), replicates)

    # Check if actor replicates
    pub fn is_replicated(self) -> bool:
        return unreal_actor_is_replicated(self.as_ptr())

    # Get owner (for replication)
    pub fn get_owner(self) -> Option[AActor]:
        val owner_ptr = unreal_actor_get_owner(self.as_ptr())
        if owner_ptr == ffi.null_ptr():
            return None
        else:
            return Some(AActor::from_ptr(owner_ptr))

    # Set owner
    pub fn set_owner(mut self, owner: AActor):
        unreal_actor_set_owner(self.as_ptr(), owner.as_ptr())

    # === Utility Methods ===

    # Get actor name
    pub fn get_name(self) -> String:
        val name_ptr = unreal_actor_get_name(self.as_ptr())
        val name = ffi.string_from_ptr(name_ptr)
        ffi.free_string(name_ptr)
        return name

    # Get actor label (editor only)
    pub fn get_actor_label(self) -> String:
        val label_ptr = unreal_actor_get_label(self.as_ptr())
        val label = ffi.string_from_ptr(label_ptr)
        ffi.free_string(label_ptr)
        return label

    # Tags management
    pub fn add_tag(mut self, tag: String):
        unreal_actor_add_tag(self.as_ptr(), tag)

    pub fn remove_tag(mut self, tag: String):
        unreal_actor_remove_tag(self.as_ptr(), tag)

    pub fn has_tag(self, tag: String) -> bool:
        return unreal_actor_has_tag(self.as_ptr(), tag)


# World functions for spawning actors

# Spawn actor of class
pub fn spawn_actor(world: ffi.VoidPtr, class_name: String, x: f64, y: f64, z: f64) -> Option[AActor]:
    val actor_ptr = unreal_world_spawn_actor(world, class_name, x, y, z)
    if actor_ptr == ffi.null_ptr():
        return None
    else:
        return Some(AActor::from_ptr(actor_ptr))

# Spawn actor with rotation
pub fn spawn_actor_with_rotation(
    world: ffi.VoidPtr,
    class_name: String,
    x: f64, y: f64, z: f64,
    pitch: f64, yaw: f64, roll: f64
) -> Option[AActor]:
    val actor_ptr = unreal_world_spawn_actor_with_rotation(world, class_name, x, y, z, pitch, yaw, roll)
    if actor_ptr == ffi.null_ptr():
        return None
    else:
        return Some(AActor::from_ptr(actor_ptr))


# FFI function declarations (to be implemented in Rust/C++)

extern "C":
    fn unreal_actor_get_location(actor: ffi.VoidPtr, x: ffi.VoidPtr, y: ffi.VoidPtr, z: ffi.VoidPtr)
    fn unreal_actor_set_location(actor: ffi.VoidPtr, x: f64, y: f64, z: f64, sweep: bool)
    fn unreal_actor_get_rotation(actor: ffi.VoidPtr, pitch: ffi.VoidPtr, yaw: ffi.VoidPtr, roll: ffi.VoidPtr)
    fn unreal_actor_set_rotation(actor: ffi.VoidPtr, pitch: f64, yaw: f64, roll: f64)
    fn unreal_actor_get_scale(actor: ffi.VoidPtr, x: ffi.VoidPtr, y: ffi.VoidPtr, z: ffi.VoidPtr)
    fn unreal_actor_set_scale(actor: ffi.VoidPtr, x: f64, y: f64, z: f64)
    fn unreal_actor_add_local_offset(actor: ffi.VoidPtr, x: f64, y: f64, z: f64, sweep: bool)
    fn unreal_actor_add_local_rotation(actor: ffi.VoidPtr, pitch: f64, yaw: f64, roll: f64)

    fn unreal_actor_get_component_by_name(actor: ffi.VoidPtr, name: String) -> ffi.VoidPtr
    fn unreal_actor_get_root_component(actor: ffi.VoidPtr) -> ffi.VoidPtr
    fn unreal_actor_set_root_component(actor: ffi.VoidPtr, component: ffi.VoidPtr)

    fn unreal_actor_destroy(actor: ffi.VoidPtr)
    fn unreal_actor_is_pending_kill(actor: ffi.VoidPtr) -> bool
    fn unreal_actor_set_lifespan(actor: ffi.VoidPtr, seconds: f32)
    fn unreal_actor_get_lifespan(actor: ffi.VoidPtr) -> f32

    fn unreal_actor_set_hidden(actor: ffi.VoidPtr, hidden: bool)
    fn unreal_actor_set_enable_collision(actor: ffi.VoidPtr, enabled: bool)

    fn unreal_actor_set_replicates(actor: ffi.VoidPtr, replicates: bool)
    fn unreal_actor_is_replicated(actor: ffi.VoidPtr) -> bool
    fn unreal_actor_get_owner(actor: ffi.VoidPtr) -> ffi.VoidPtr
    fn unreal_actor_set_owner(actor: ffi.VoidPtr, owner: ffi.VoidPtr)

    fn unreal_actor_get_name(actor: ffi.VoidPtr) -> ffi.VoidPtr
    fn unreal_actor_get_label(actor: ffi.VoidPtr) -> ffi.VoidPtr
    fn unreal_actor_add_tag(actor: ffi.VoidPtr, tag: String)
    fn unreal_actor_remove_tag(actor: ffi.VoidPtr, tag: String)
    fn unreal_actor_has_tag(actor: ffi.VoidPtr, tag: String) -> bool

    fn unreal_world_spawn_actor(world: ffi.VoidPtr, class_name: String, x: f64, y: f64, z: f64) -> ffi.VoidPtr
    fn unreal_world_spawn_actor_with_rotation(
        world: ffi.VoidPtr,
        class_name: String,
        x: f64, y: f64, z: f64,
        pitch: f64, yaw: f64, roll: f64
    ) -> ffi.VoidPtr
