# Grammar Statements
#
# Statement rules: val, return, if, match, for, while, loop, etc.

import parser.treesitter.{Grammar}
import tokens.{TokenKind, token, ref, seq, choice, optional, field, repeat}

export add_statement_rules

# Add all statement rules to grammar
fn add_statement_rules(grammar: Grammar):
    # Statements
    grammar.add_rule("statement", choice([
        ref("let_stmt"),
        ref("return_stmt"),
        ref("if_stmt"),
        ref("match_stmt"),
        ref("for_stmt"),
        ref("while_stmt"),
        ref("loop_stmt"),
        ref("break_stmt"),
        ref("continue_stmt"),
        ref("expression_stmt")
    ]))

    # Let statement
    grammar.add_rule("let_stmt", seq([
        token(Let),
        optional(token(Mut)),
        field("pattern", ref("pattern")),
        optional(seq([token(Colon), field("type", ref("type"))])),
        token(Eq),
        field("value", ref("expression")),
        token(Newline)
    ]))

    # Return statement
    grammar.add_rule("return_stmt", seq([
        token(Return),
        optional(ref("expression")),
        token(Newline)
    ]))

    # If statement
    grammar.add_rule("if_stmt", seq([
        token(If),
        field("condition", ref("expression")),
        token(Colon),
        ref("block"),
        repeat(ref("elif_clause")),
        optional(ref("else_clause"))
    ]))

    # Elif clause
    grammar.add_rule("elif_clause", seq([
        token(Elif),
        field("condition", ref("expression")),
        token(Colon),
        ref("block")
    ]))

    # Else clause
    grammar.add_rule("else_clause", seq([
        token(Else),
        token(Colon),
        ref("block")
    ]))

    # Match statement
    grammar.add_rule("match_stmt", seq([
        token(Match),
        field("value", ref("expression")),
        token(Colon),
        ref("match_block")
    ]))

    # Match block
    grammar.add_rule("match_block", seq([
        token(Newline),
        token(Indent),
        repeat(ref("match_case")),
        token(Dedent)
    ]))

    # Match case
    grammar.add_rule("match_case", seq([
        token(Case),
        field("pattern", ref("pattern")),
        optional(seq([token(If), field("guard", ref("expression"))])),
        token(Colon),
        choice([
            seq([ref("expression"), token(Newline)]),
            ref("block")
        ])
    ]))

    # For statement
    grammar.add_rule("for_stmt", seq([
        token(For),
        field("pattern", ref("pattern")),
        token(In),
        field("iterable", ref("expression")),
        token(Colon),
        ref("block")
    ]))

    # While statement
    grammar.add_rule("while_stmt", seq([
        token(While),
        field("condition", ref("expression")),
        token(Colon),
        ref("block")
    ]))

    # Loop statement
    grammar.add_rule("loop_stmt", seq([
        token(Loop),
        token(Colon),
        ref("block")
    ]))

    # Break statement
    grammar.add_rule("break_stmt", seq([
        token(Break),
        token(Newline)
    ]))

    # Continue statement
    grammar.add_rule("continue_stmt", seq([
        token(Continue),
        token(Newline)
    ]))

    # Expression statement
    grammar.add_rule("expression_stmt", seq([
        ref("expression"),
        token(Newline)
    ]))

    # Block
    grammar.add_rule("block", seq([
        token(Newline),
        token(Indent),
        repeat(choice([
            ref("statement"),
            token(Newline)
        ])),
        token(Dedent)
    ]))
