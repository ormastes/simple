# GPU Buffer Management - Async buffer allocation, upload, and download

use std.core.result.*

# GPU buffer handle
struct Buffer[T]:
    _handle: u64
    _size: u64

# Error type
enum GpuError:
    OutOfMemory
    InvalidDevice
    TransferFailed
    KernelFailed

    pub fn to_string(self) -> String:
        """Convert error to string.

        Returns:
            Error name
        """
        match self:
            case GpuError::OutOfMemory:
                return "out_of_memory"
            case GpuError::InvalidDevice:
                return "invalid_device"
            case GpuError::TransferFailed:
                return "transfer_failed"
            case GpuError::KernelFailed:
                return "kernel_failed"

    pub fn description(self) -> String:
        """Get error description.

        Returns:
            Human-readable description
        """
        match self:
            case GpuError::OutOfMemory:
                return "GPU out of memory"
            case GpuError::InvalidDevice:
                return "Invalid GPU device"
            case GpuError::TransferFailed:
                return "GPU memory transfer failed"
            case GpuError::KernelFailed:
                return "GPU kernel execution failed"

    pub fn is_memory_error(self) -> bool:
        """Check if error is memory-related.

        Returns:
            True for OutOfMemory or TransferFailed
        """
        match self:
            case GpuError::OutOfMemory:
                return true
            case GpuError::InvalidDevice:
                return false
            case GpuError::TransferFailed:
                return true
            case GpuError::KernelFailed:
                return false

    pub fn is_recoverable(self) -> bool:
        """Check if error might be recoverable.

        Returns:
            True if retry might succeed
        """
        match self:
            case GpuError::OutOfMemory:
                return true  # Might free memory and retry
            case GpuError::InvalidDevice:
                return false  # Device error is permanent
            case GpuError::TransferFailed:
                return true  # Transfer might succeed on retry
            case GpuError::KernelFailed:
                return false  # Kernel logic error

# Buffer operations (async)
impl Buffer[T]:
    async fn upload(self, data: &[T]) -> Result[(), GpuError]
    async fn download(self) -> Result[Array[T], GpuError]
    fn len(self) -> u64
    fn size_bytes(self) -> u64

# Buffer allocation
extern async fn alloc[T](count: u64) -> Result[Buffer[T], GpuError]
extern async fn alloc_upload[T](data: &[T]) -> Result[Buffer[T], GpuError]
extern fn free[T](buf: Buffer[T])
