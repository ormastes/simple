# Common Audio Abstraction
#
# Engine-agnostic audio interface
# Works with both Godot AudioStreamPlayer and Unreal USoundBase
#
# Features:
# - Audio playback control
# - Volume and pitch control
# - 3D spatial audio
# - Audio bus/mixer management
# - Sound effects and music

import sys.ffi

mod audio

# AudioPlayer trait
# Common interface for audio playback
pub trait AudioPlayer:
    # Playback control
    fn play(mut self)
    fn stop(mut self)
    fn pause(mut self)
    fn resume(mut self)
    fn is_playing(self) -> bool

    # Properties
    fn get_volume(self) -> f32
    fn set_volume(mut self, volume: f32)
    fn get_pitch(self) -> f32
    fn set_pitch(mut self, pitch: f32)

    # Looping
    fn is_looping(self) -> bool
    fn set_looping(mut self, looping: bool)

    # Position
    fn get_playback_position(self) -> f32
    fn set_playback_position(mut self, position: f32)
    fn get_duration(self) -> f32


# SpatialAudioPlayer trait
# Extended interface for 3D spatial audio
pub trait SpatialAudioPlayer: AudioPlayer:
    fn get_position(self) -> (f32, f32, f32)
    fn set_position(mut self, x: f32, y: f32, z: f32)
    fn get_max_distance(self) -> f32
    fn set_max_distance(mut self, distance: f32)
    fn get_attenuation(self) -> f32
    fn set_attenuation(mut self, attenuation: f32)


# GodotAudioPlayerAdapter
# Adapts Godot AudioStreamPlayer to AudioPlayer trait
pub struct GodotAudioPlayerAdapter:
    player_ptr: ffi.VoidPtr

impl GodotAudioPlayerAdapter:
    pub fn new(player_ptr: ffi.VoidPtr) -> GodotAudioPlayerAdapter:
        return GodotAudioPlayerAdapter(player_ptr: player_ptr)

impl AudioPlayer for GodotAudioPlayerAdapter:
    fn play(mut self):
        godot_audio_player_play(self.player_ptr)

    fn stop(mut self):
        godot_audio_player_stop(self.player_ptr)

    fn pause(mut self):
        godot_audio_player_set_stream_paused(self.player_ptr, true)

    fn resume(mut self):
        godot_audio_player_set_stream_paused(self.player_ptr, false)

    fn is_playing(self) -> bool:
        return godot_audio_player_is_playing(self.player_ptr)

    fn get_volume(self) -> f32:
        return godot_audio_player_get_volume_db(self.player_ptr)

    fn set_volume(mut self, volume: f32):
        godot_audio_player_set_volume_db(self.player_ptr, volume)

    fn get_pitch(self) -> f32:
        return godot_audio_player_get_pitch_scale(self.player_ptr)

    fn set_pitch(mut self, pitch: f32):
        godot_audio_player_set_pitch_scale(self.player_ptr, pitch)

    fn is_looping(self) -> bool:
        return godot_audio_player_is_autoplay(self.player_ptr)

    fn set_looping(mut self, looping: bool):
        # Godot uses autoplay for looping
        godot_audio_player_set_autoplay(self.player_ptr, looping)

    fn get_playback_position(self) -> f32:
        return godot_audio_player_get_playback_position(self.player_ptr)

    fn set_playback_position(mut self, position: f32):
        godot_audio_player_seek(self.player_ptr, position)

    fn get_duration(self) -> f32:
        return godot_audio_player_get_stream_length(self.player_ptr)


# GodotSpatialAudioAdapter
# Adapts Godot AudioStreamPlayer3D to SpatialAudioPlayer trait
pub struct GodotSpatialAudioAdapter:
    base: GodotAudioPlayerAdapter
    spatial_ptr: ffi.VoidPtr

impl GodotSpatialAudioAdapter:
    pub fn new(spatial_ptr: ffi.VoidPtr) -> GodotSpatialAudioAdapter:
        return GodotSpatialAudioAdapter(
            base: GodotAudioPlayerAdapter::new(spatial_ptr),
            spatial_ptr: spatial_ptr,
        )

impl AudioPlayer for GodotSpatialAudioAdapter:
    fn play(mut self):
        self.base.play()

    fn stop(mut self):
        self.base.stop()

    fn pause(mut self):
        self.base.pause()

    fn resume(mut self):
        self.base.resume()

    fn is_playing(self) -> bool:
        return self.base.is_playing()

    fn get_volume(self) -> f32:
        return self.base.get_volume()

    fn set_volume(mut self, volume: f32):
        self.base.set_volume(volume)

    fn get_pitch(self) -> f32:
        return self.base.get_pitch()

    fn set_pitch(mut self, pitch: f32):
        self.base.set_pitch(pitch)

    fn is_looping(self) -> bool:
        return self.base.is_looping()

    fn set_looping(mut self, looping: bool):
        self.base.set_looping(looping)

    fn get_playback_position(self) -> f32:
        return self.base.get_playback_position()

    fn set_playback_position(mut self, position: f32):
        self.base.set_playback_position(position)

    fn get_duration(self) -> f32:
        return self.base.get_duration()

impl SpatialAudioPlayer for GodotSpatialAudioAdapter:
    fn get_position(self) -> (f32, f32, f32):
        let x = ffi.alloc_f32()
        let y = ffi.alloc_f32()
        let z = ffi.alloc_f32()
        godot_audio_player_3d_get_position(self.spatial_ptr, x, y, z)
        let result = (ffi.read_f32(x), ffi.read_f32(y), ffi.read_f32(z))
        ffi.free(x)
        ffi.free(y)
        ffi.free(z)
        return result

    fn set_position(mut self, x: f32, y: f32, z: f32):
        godot_audio_player_3d_set_position(self.spatial_ptr, x, y, z)

    fn get_max_distance(self) -> f32:
        return godot_audio_player_3d_get_max_distance(self.spatial_ptr)

    fn set_max_distance(mut self, distance: f32):
        godot_audio_player_3d_set_max_distance(self.spatial_ptr, distance)

    fn get_attenuation(self) -> f32:
        return godot_audio_player_3d_get_attenuation_filter_db(self.spatial_ptr)

    fn set_attenuation(mut self, attenuation: f32):
        godot_audio_player_3d_set_attenuation_filter_db(self.spatial_ptr, attenuation)


# UnrealAudioPlayerAdapter
# Adapts Unreal UAudioComponent to AudioPlayer trait
pub struct UnrealAudioPlayerAdapter:
    component_ptr: ffi.VoidPtr

impl UnrealAudioPlayerAdapter:
    pub fn new(component_ptr: ffi.VoidPtr) -> UnrealAudioPlayerAdapter:
        return UnrealAudioPlayerAdapter(component_ptr: component_ptr)

impl AudioPlayer for UnrealAudioPlayerAdapter:
    fn play(mut self):
        unreal_audio_component_play(self.component_ptr)

    fn stop(mut self):
        unreal_audio_component_stop(self.component_ptr)

    fn pause(mut self):
        unreal_audio_component_set_paused(self.component_ptr, true)

    fn resume(mut self):
        unreal_audio_component_set_paused(self.component_ptr, false)

    fn is_playing(self) -> bool:
        return unreal_audio_component_is_playing(self.component_ptr)

    fn get_volume(self) -> f32:
        return unreal_audio_component_get_volume_multiplier(self.component_ptr)

    fn set_volume(mut self, volume: f32):
        unreal_audio_component_set_volume_multiplier(self.component_ptr, volume)

    fn get_pitch(self) -> f32:
        return unreal_audio_component_get_pitch_multiplier(self.component_ptr)

    fn set_pitch(mut self, pitch: f32):
        unreal_audio_component_set_pitch_multiplier(self.component_ptr, pitch)

    fn is_looping(self) -> bool:
        return unreal_audio_component_is_looping(self.component_ptr)

    fn set_looping(mut self, looping: bool):
        unreal_audio_component_set_looping(self.component_ptr, looping)

    fn get_playback_position(self) -> f32:
        return unreal_audio_component_get_playback_percent(self.component_ptr)

    fn set_playback_position(mut self, position: f32):
        # Unreal doesn't support seeking directly, restart at position
        pass

    fn get_duration(self) -> f32:
        return unreal_audio_component_get_duration(self.component_ptr)


# FFI declarations for Godot audio
extern "C":
    fn godot_audio_player_play(player: ffi.VoidPtr)
    fn godot_audio_player_stop(player: ffi.VoidPtr)
    fn godot_audio_player_set_stream_paused(player: ffi.VoidPtr, paused: bool)
    fn godot_audio_player_is_playing(player: ffi.VoidPtr) -> bool
    fn godot_audio_player_get_volume_db(player: ffi.VoidPtr) -> f32
    fn godot_audio_player_set_volume_db(player: ffi.VoidPtr, volume: f32)
    fn godot_audio_player_get_pitch_scale(player: ffi.VoidPtr) -> f32
    fn godot_audio_player_set_pitch_scale(player: ffi.VoidPtr, pitch: f32)
    fn godot_audio_player_is_autoplay(player: ffi.VoidPtr) -> bool
    fn godot_audio_player_set_autoplay(player: ffi.VoidPtr, autoplay: bool)
    fn godot_audio_player_get_playback_position(player: ffi.VoidPtr) -> f32
    fn godot_audio_player_seek(player: ffi.VoidPtr, position: f32)
    fn godot_audio_player_get_stream_length(player: ffi.VoidPtr) -> f32

    fn godot_audio_player_3d_get_position(player: ffi.VoidPtr, x: ffi.VoidPtr, y: ffi.VoidPtr, z: ffi.VoidPtr)
    fn godot_audio_player_3d_set_position(player: ffi.VoidPtr, x: f32, y: f32, z: f32)
    fn godot_audio_player_3d_get_max_distance(player: ffi.VoidPtr) -> f32
    fn godot_audio_player_3d_set_max_distance(player: ffi.VoidPtr, distance: f32)
    fn godot_audio_player_3d_get_attenuation_filter_db(player: ffi.VoidPtr) -> f32
    fn godot_audio_player_3d_set_attenuation_filter_db(player: ffi.VoidPtr, attenuation: f32)

# FFI declarations for Unreal audio
extern "C":
    fn unreal_audio_component_play(component: ffi.VoidPtr)
    fn unreal_audio_component_stop(component: ffi.VoidPtr)
    fn unreal_audio_component_set_paused(component: ffi.VoidPtr, paused: bool)
    fn unreal_audio_component_is_playing(component: ffi.VoidPtr) -> bool
    fn unreal_audio_component_get_volume_multiplier(component: ffi.VoidPtr) -> f32
    fn unreal_audio_component_set_volume_multiplier(component: ffi.VoidPtr, volume: f32)
    fn unreal_audio_component_get_pitch_multiplier(component: ffi.VoidPtr) -> f32
    fn unreal_audio_component_set_pitch_multiplier(component: ffi.VoidPtr, pitch: f32)
    fn unreal_audio_component_is_looping(component: ffi.VoidPtr) -> bool
    fn unreal_audio_component_set_looping(component: ffi.VoidPtr, looping: bool)
    fn unreal_audio_component_get_playback_percent(component: ffi.VoidPtr) -> f32
    fn unreal_audio_component_get_duration(component: ffi.VoidPtr) -> f32


# Example usage:
#
# # Godot 2D audio
# let audio = GodotAudioPlayerAdapter::new(godot_player_ptr)
# audio.set_volume(0.8)
# audio.set_pitch(1.2)
# audio.play()
#
# # Godot 3D spatial audio
# let spatial_audio = GodotSpatialAudioAdapter::new(godot_3d_player_ptr)
# spatial_audio.set_position(10.0, 0.0, 5.0)
# spatial_audio.set_max_distance(50.0)
# spatial_audio.play()
#
# # Unreal audio
# let unreal_audio = UnrealAudioPlayerAdapter::new(unreal_component_ptr)
# unreal_audio.set_looping(true)
# unreal_audio.play()
