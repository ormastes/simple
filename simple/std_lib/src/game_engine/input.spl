# Common Input Abstraction
#
# Engine-agnostic input handling interface
# Works with both Godot Input and Unreal Enhanced Input
#
# Features:
# - Keyboard input
# - Mouse input
# - Gamepad input
# - Touch input
# - Input mapping and actions

import sys.ffi

mod input

# KeyCode
# Common keyboard key codes
pub enum KeyCode:
    Unknown = 0
    Space = 32
    A = 65
    B = 66
    C = 67
    D = 68
    E = 69
    F = 70
    W = 87
    S = 83
    Escape = 256
    Enter = 257
    Tab = 258
    Left = 263
    Right = 262
    Up = 265
    Down = 264
    Shift = 340
    Ctrl = 341
    Alt = 342

impl KeyCode:
    pub fn to_int(self) -> i32:
        if self == KeyCode::Space:
            return 32
        elif self == KeyCode::A:
            return 65
        # ... (other mappings)
        else:
            return 0


# MouseButton
# Mouse button identifiers
pub enum MouseButton:
    Left = 0
    Right = 1
    Middle = 2
    Button4 = 3
    Button5 = 4

impl MouseButton:
    pub fn to_int(self) -> i32:
        if self == MouseButton::Left:
            return 0
        elif self == MouseButton::Right:
            return 1
        elif self == MouseButton::Middle:
            return 2
        elif self == MouseButton::Button4:
            return 3
        else:
            return 4


# GamepadAxis
# Gamepad axis identifiers
pub enum GamepadAxis:
    LeftX = 0
    LeftY = 1
    RightX = 2
    RightY = 3
    TriggerLeft = 4
    TriggerRight = 5

impl GamepadAxis:
    pub fn to_int(self) -> i32:
        if self == GamepadAxis::LeftX:
            return 0
        elif self == GamepadAxis::LeftY:
            return 1
        elif self == GamepadAxis::RightX:
            return 2
        elif self == GamepadAxis::RightY:
            return 3
        elif self == GamepadAxis::TriggerLeft:
            return 4
        else:
            return 5


# InputSystem trait
# Common interface for input handling
pub trait InputSystem:
    # Keyboard
    fn is_key_pressed(self, key: KeyCode) -> bool
    fn is_key_just_pressed(self, key: KeyCode) -> bool
    fn is_key_just_released(self, key: KeyCode) -> bool

    # Mouse
    fn is_mouse_button_pressed(self, button: MouseButton) -> bool
    fn is_mouse_button_just_pressed(self, button: MouseButton) -> bool
    fn is_mouse_button_just_released(self, button: MouseButton) -> bool
    fn get_mouse_position(self) -> (f32, f32)
    fn get_mouse_delta(self) -> (f32, f32)

    # Gamepad
    fn is_gamepad_button_pressed(self, gamepad_id: i32, button: i32) -> bool
    fn get_gamepad_axis(self, gamepad_id: i32, axis: GamepadAxis) -> f32

    # Actions (mapped inputs)
    fn is_action_pressed(self, action_name: String) -> bool
    fn is_action_just_pressed(self, action_name: String) -> bool
    fn get_action_strength(self, action_name: String) -> f32


# GodotInputAdapter
# Adapts Godot Input singleton to InputSystem trait
pub struct GodotInputAdapter:
    input_ptr: ffi.VoidPtr

impl GodotInputAdapter:
    pub fn get_instance() -> GodotInputAdapter:
        let ptr = godot_input_get_singleton()
        return GodotInputAdapter(input_ptr: ptr)

impl InputSystem for GodotInputAdapter:
    fn is_key_pressed(self, key: KeyCode) -> bool:
        return godot_input_is_key_pressed(self.input_ptr, key.to_int())

    fn is_key_just_pressed(self, key: KeyCode) -> bool:
        return godot_input_is_key_just_pressed(self.input_ptr, key.to_int())

    fn is_key_just_released(self, key: KeyCode) -> bool:
        return godot_input_is_key_just_released(self.input_ptr, key.to_int())

    fn is_mouse_button_pressed(self, button: MouseButton) -> bool:
        return godot_input_is_mouse_button_pressed(self.input_ptr, button.to_int())

    fn is_mouse_button_just_pressed(self, button: MouseButton) -> bool:
        return godot_input_is_mouse_button_just_pressed(self.input_ptr, button.to_int())

    fn is_mouse_button_just_released(self, button: MouseButton) -> bool:
        return godot_input_is_mouse_button_just_released(self.input_ptr, button.to_int())

    fn get_mouse_position(self) -> (f32, f32):
        let x = ffi.alloc_f32()
        let y = ffi.alloc_f32()
        godot_input_get_mouse_position(self.input_ptr, x, y)
        let result = (ffi.read_f32(x), ffi.read_f32(y))
        ffi.free(x)
        ffi.free(y)
        return result

    fn get_mouse_delta(self) -> (f32, f32):
        let x = ffi.alloc_f32()
        let y = ffi.alloc_f32()
        godot_input_get_mouse_delta(self.input_ptr, x, y)
        let result = (ffi.read_f32(x), ffi.read_f32(y))
        ffi.free(x)
        ffi.free(y)
        return result

    fn is_gamepad_button_pressed(self, gamepad_id: i32, button: i32) -> bool:
        return godot_input_is_gamepad_button_pressed(self.input_ptr, gamepad_id, button)

    fn get_gamepad_axis(self, gamepad_id: i32, axis: GamepadAxis) -> f32:
        return godot_input_get_gamepad_axis(self.input_ptr, gamepad_id, axis.to_int())

    fn is_action_pressed(self, action_name: String) -> bool:
        return godot_input_is_action_pressed(self.input_ptr, action_name)

    fn is_action_just_pressed(self, action_name: String) -> bool:
        return godot_input_is_action_just_pressed(self.input_ptr, action_name)

    fn get_action_strength(self, action_name: String) -> f32:
        return godot_input_get_action_strength(self.input_ptr, action_name)


# UnrealInputAdapter
# Adapts Unreal Enhanced Input to InputSystem trait
pub struct UnrealInputAdapter:
    player_controller_ptr: ffi.VoidPtr

impl UnrealInputAdapter:
    pub fn new(player_controller_ptr: ffi.VoidPtr) -> UnrealInputAdapter:
        return UnrealInputAdapter(player_controller_ptr: player_controller_ptr)

impl InputSystem for UnrealInputAdapter:
    fn is_key_pressed(self, key: KeyCode) -> bool:
        return unreal_input_is_key_down(self.player_controller_ptr, key.to_int())

    fn is_key_just_pressed(self, key: KeyCode) -> bool:
        return unreal_input_was_key_just_pressed(self.player_controller_ptr, key.to_int())

    fn is_key_just_released(self, key: KeyCode) -> bool:
        return unreal_input_was_key_just_released(self.player_controller_ptr, key.to_int())

    fn is_mouse_button_pressed(self, button: MouseButton) -> bool:
        return unreal_input_is_mouse_button_down(self.player_controller_ptr, button.to_int())

    fn is_mouse_button_just_pressed(self, button: MouseButton) -> bool:
        return unreal_input_was_mouse_button_just_pressed(self.player_controller_ptr, button.to_int())

    fn is_mouse_button_just_released(self, button: MouseButton) -> bool:
        return unreal_input_was_mouse_button_just_released(self.player_controller_ptr, button.to_int())

    fn get_mouse_position(self) -> (f32, f32):
        let x = ffi.alloc_f32()
        let y = ffi.alloc_f32()
        unreal_input_get_mouse_position(self.player_controller_ptr, x, y)
        let result = (ffi.read_f32(x), ffi.read_f32(y))
        ffi.free(x)
        ffi.free(y)
        return result

    fn get_mouse_delta(self) -> (f32, f32):
        let x = ffi.alloc_f32()
        let y = ffi.alloc_f32()
        unreal_input_get_mouse_delta(self.player_controller_ptr, x, y)
        let result = (ffi.read_f32(x), ffi.read_f32(y))
        ffi.free(x)
        ffi.free(y)
        return result

    fn is_gamepad_button_pressed(self, gamepad_id: i32, button: i32) -> bool:
        return unreal_input_is_gamepad_button_pressed(self.player_controller_ptr, gamepad_id, button)

    fn get_gamepad_axis(self, gamepad_id: i32, axis: GamepadAxis) -> f32:
        return unreal_input_get_gamepad_axis(self.player_controller_ptr, gamepad_id, axis.to_int())

    fn is_action_pressed(self, action_name: String) -> bool:
        return unreal_input_is_action_pressed(self.player_controller_ptr, action_name)

    fn is_action_just_pressed(self, action_name: String) -> bool:
        return unreal_input_was_action_just_pressed(self.player_controller_ptr, action_name)

    fn get_action_strength(self, action_name: String) -> f32:
        return unreal_input_get_action_value(self.player_controller_ptr, action_name)


# Utility functions

# Get Godot input system
pub fn get_godot_input() -> GodotInputAdapter:
    return GodotInputAdapter::get_instance()

# Get Unreal input system
pub fn get_unreal_input(player_controller_ptr: ffi.VoidPtr) -> UnrealInputAdapter:
    return UnrealInputAdapter::new(player_controller_ptr)


# FFI declarations for Godot
extern "C":
    fn godot_input_get_singleton() -> ffi.VoidPtr
    fn godot_input_is_key_pressed(input: ffi.VoidPtr, key: i32) -> bool
    fn godot_input_is_key_just_pressed(input: ffi.VoidPtr, key: i32) -> bool
    fn godot_input_is_key_just_released(input: ffi.VoidPtr, key: i32) -> bool
    fn godot_input_is_mouse_button_pressed(input: ffi.VoidPtr, button: i32) -> bool
    fn godot_input_is_mouse_button_just_pressed(input: ffi.VoidPtr, button: i32) -> bool
    fn godot_input_is_mouse_button_just_released(input: ffi.VoidPtr, button: i32) -> bool
    fn godot_input_get_mouse_position(input: ffi.VoidPtr, x: ffi.VoidPtr, y: ffi.VoidPtr)
    fn godot_input_get_mouse_delta(input: ffi.VoidPtr, x: ffi.VoidPtr, y: ffi.VoidPtr)
    fn godot_input_is_gamepad_button_pressed(input: ffi.VoidPtr, gamepad: i32, button: i32) -> bool
    fn godot_input_get_gamepad_axis(input: ffi.VoidPtr, gamepad: i32, axis: i32) -> f32
    fn godot_input_is_action_pressed(input: ffi.VoidPtr, action: String) -> bool
    fn godot_input_is_action_just_pressed(input: ffi.VoidPtr, action: String) -> bool
    fn godot_input_get_action_strength(input: ffi.VoidPtr, action: String) -> f32

# FFI declarations for Unreal
extern "C":
    fn unreal_input_is_key_down(controller: ffi.VoidPtr, key: i32) -> bool
    fn unreal_input_was_key_just_pressed(controller: ffi.VoidPtr, key: i32) -> bool
    fn unreal_input_was_key_just_released(controller: ffi.VoidPtr, key: i32) -> bool
    fn unreal_input_is_mouse_button_down(controller: ffi.VoidPtr, button: i32) -> bool
    fn unreal_input_was_mouse_button_just_pressed(controller: ffi.VoidPtr, button: i32) -> bool
    fn unreal_input_was_mouse_button_just_released(controller: ffi.VoidPtr, button: i32) -> bool
    fn unreal_input_get_mouse_position(controller: ffi.VoidPtr, x: ffi.VoidPtr, y: ffi.VoidPtr)
    fn unreal_input_get_mouse_delta(controller: ffi.VoidPtr, x: ffi.VoidPtr, y: ffi.VoidPtr)
    fn unreal_input_is_gamepad_button_pressed(controller: ffi.VoidPtr, gamepad: i32, button: i32) -> bool
    fn unreal_input_get_gamepad_axis(controller: ffi.VoidPtr, gamepad: i32, axis: i32) -> f32
    fn unreal_input_is_action_pressed(controller: ffi.VoidPtr, action: String) -> bool
    fn unreal_input_was_action_just_pressed(controller: ffi.VoidPtr, action: String) -> bool
    fn unreal_input_get_action_value(controller: ffi.VoidPtr, action: String) -> f32


# Example usage:
#
# # Get input system (Godot)
# let input = get_godot_input()
#
# # Check keyboard
# if input.is_key_pressed(KeyCode::W):
#     print("W is pressed")
#
# # Check mouse
# if input.is_mouse_button_just_pressed(MouseButton::Left):
#     let (x, y) = input.get_mouse_position()
#     print(f"Clicked at {x}, {y}")
#
# # Check action
# if input.is_action_pressed("jump"):
#     player.jump()
