# Common Shader Abstraction
#
# Engine-agnostic shader interface
# Works with both Godot Shaders and Unreal Materials
#
# Features:
# - Shader compilation
# - Uniform/parameter binding
# - Vertex and fragment shaders
# - Compute shaders
# - Cross-engine shader translation

import sys.ffi

mod shader

# ShaderStage
# Shader pipeline stages
pub enum ShaderStage:
    Vertex = 0
    Fragment = 1
    Geometry = 2
    Compute = 3
    TessellationControl = 4
    TessellationEvaluation = 5

impl ShaderStage:
    pub fn to_string(self) -> String:
        if self == ShaderStage::Vertex:
            return "Vertex"
        elif self == ShaderStage::Fragment:
            return "Fragment"
        elif self == ShaderStage::Geometry:
            return "Geometry"
        elif self == ShaderStage::Compute:
            return "Compute"
        elif self == ShaderStage::TessellationControl:
            return "TessellationControl"
        else:
            return "TessellationEvaluation"


# ShaderUniform
# Shader uniform/parameter
pub struct ShaderUniform:
    name: String
    uniform_type: String  # "float", "vec2", "vec3", "vec4", "mat4", "sampler2D", etc.
    default_value: ffi.VoidPtr

impl ShaderUniform:
    pub fn new(name: String, uniform_type: String) -> ShaderUniform:
        return ShaderUniform(
            name: name,
            uniform_type: uniform_type,
            default_value: ffi.null_ptr(),
        )

    pub fn get_name(self) -> String:
        return self.name

    pub fn get_type(self) -> String:
        return self.uniform_type


# Shader trait
# Common interface for all shaders
pub trait Shader:
    # Compilation
    fn compile(mut self) -> bool
    fn is_compiled(self) -> bool
    fn get_compile_errors(self) -> Vec[String]

    # Source code
    fn get_source(self, stage: ShaderStage) -> String
    fn set_source(mut self, stage: ShaderStage, source: String)

    # Uniforms
    fn get_uniforms(self) -> Vec[ShaderUniform]
    fn has_uniform(self, name: String) -> bool
    fn set_uniform_float(mut self, name: String, value: f32)
    fn set_uniform_vec2(mut self, name: String, x: f32, y: f32)
    fn set_uniform_vec3(mut self, name: String, x: f32, y: f32, z: f32)
    fn set_uniform_vec4(mut self, name: String, x: f32, y: f32, z: f32, w: f32)
    fn set_uniform_texture(mut self, name: String, texture_ptr: ffi.VoidPtr)


# GodotShaderAdapter
# Adapts Godot Shader to Shader trait
pub struct GodotShaderAdapter:
    shader_ptr: ffi.VoidPtr
    compiled: bool

impl GodotShaderAdapter:
    pub fn new(shader_ptr: ffi.VoidPtr) -> GodotShaderAdapter:
        return GodotShaderAdapter(
            shader_ptr: shader_ptr,
            compiled: false,
        )

impl Shader for GodotShaderAdapter:
    fn compile(mut self) -> bool:
        let result = godot_shader_compile(self.shader_ptr)
        self.compiled = result
        return result

    fn is_compiled(self) -> bool:
        return self.compiled

    fn get_compile_errors(self) -> Vec[String]:
        let count_ptr = ffi.alloc_i32()
        let errors_ptr = godot_shader_get_errors(self.shader_ptr, count_ptr)
        let count = ffi.read_i32(count_ptr)

        let mut errors = Vec::new()
        for i in 0..count:
            let error_ptr = ffi.read_array_ptr(errors_ptr, i)
            errors.push(ffi.string_from_ptr(error_ptr))

        ffi.free(count_ptr)
        ffi.free(errors_ptr)

        return errors

    fn get_source(self, stage: ShaderStage) -> String:
        let source_ptr = godot_shader_get_source(self.shader_ptr, stage.to_string())
        return ffi.string_from_ptr(source_ptr)

    fn set_source(mut self, stage: ShaderStage, source: String):
        godot_shader_set_source(self.shader_ptr, stage.to_string(), source)

    fn get_uniforms(self) -> Vec[ShaderUniform]:
        # Stub - would enumerate uniforms
        return []

    fn has_uniform(self, name: String) -> bool:
        return godot_shader_has_uniform(self.shader_ptr, name)

    fn set_uniform_float(mut self, name: String, value: f32):
        godot_shader_set_uniform_float(self.shader_ptr, name, value)

    fn set_uniform_vec2(mut self, name: String, x: f32, y: f32):
        godot_shader_set_uniform_vec2(self.shader_ptr, name, x, y)

    fn set_uniform_vec3(mut self, name: String, x: f32, y: f32, z: f32):
        godot_shader_set_uniform_vec3(self.shader_ptr, name, x, y, z)

    fn set_uniform_vec4(mut self, name: String, x: f32, y: f32, z: f32, w: f32):
        godot_shader_set_uniform_vec4(self.shader_ptr, name, x, y, z, w)

    fn set_uniform_texture(mut self, name: String, texture_ptr: ffi.VoidPtr):
        godot_shader_set_uniform_texture(self.shader_ptr, name, texture_ptr)


# UnrealShaderAdapter
# Adapts Unreal Material (shader) to Shader trait
pub struct UnrealShaderAdapter:
    material_ptr: ffi.VoidPtr
    compiled: bool

impl UnrealShaderAdapter:
    pub fn new(material_ptr: ffi.VoidPtr) -> UnrealShaderAdapter:
        return UnrealShaderAdapter(
            material_ptr: material_ptr,
            compiled: true,  # Unreal materials are pre-compiled
        )

impl Shader for UnrealShaderAdapter:
    fn compile(mut self) -> bool:
        # Unreal materials compile at cook time
        return true

    fn is_compiled(self) -> bool:
        return self.compiled

    fn get_compile_errors(self) -> Vec[String]:
        return []

    fn get_source(self, stage: ShaderStage) -> String:
        # Unreal materials don't expose source directly
        return ""

    fn set_source(mut self, stage: ShaderStage, source: String):
        # Cannot set source on Unreal materials
        pass

    fn get_uniforms(self) -> Vec[ShaderUniform]:
        return []

    fn has_uniform(self, name: String) -> bool:
        return unreal_material_has_parameter(self.material_ptr, name)

    fn set_uniform_float(mut self, name: String, value: f32):
        unreal_material_set_scalar_parameter(self.material_ptr, name, value)

    fn set_uniform_vec2(mut self, name: String, x: f32, y: f32):
        # Unreal doesn't have vec2, store as vec3
        unreal_material_set_vector_parameter(self.material_ptr, name, x, y, 0.0, 0.0)

    fn set_uniform_vec3(mut self, name: String, x: f32, y: f32, z: f32):
        unreal_material_set_vector_parameter(self.material_ptr, name, x, y, z, 0.0)

    fn set_uniform_vec4(mut self, name: String, x: f32, y: f32, z: f32, w: f32):
        unreal_material_set_vector_parameter(self.material_ptr, name, x, y, z, w)

    fn set_uniform_texture(mut self, name: String, texture_ptr: ffi.VoidPtr):
        unreal_material_set_texture_parameter(self.material_ptr, name, texture_ptr)


# ShaderBuilder
# Fluent API for building shaders
pub struct ShaderBuilder:
    vertex_source: String
    fragment_source: String
    uniforms: Vec[ShaderUniform]

impl ShaderBuilder:
    pub fn new() -> ShaderBuilder:
        return ShaderBuilder(
            vertex_source: "",
            fragment_source: "",
            uniforms: [],
        )

    pub fn vertex(mut self, source: String) -> ShaderBuilder:
        self.vertex_source = source
        return self

    pub fn fragment(mut self, source: String) -> ShaderBuilder:
        self.fragment_source = source
        return self

    pub fn uniform(mut self, uniform: ShaderUniform) -> ShaderBuilder:
        self.uniforms.push(uniform)
        return self

    # Build for Godot
    pub fn build_godot(self) -> GodotShaderAdapter:
        let shader_ptr = godot_shader_create()
        let shader = GodotShaderAdapter::new(shader_ptr)

        if self.vertex_source != "":
            shader.set_source(ShaderStage::Vertex, self.vertex_source)

        if self.fragment_source != "":
            shader.set_source(ShaderStage::Fragment, self.fragment_source)

        return shader

    # Build for Unreal
    pub fn build_unreal(self) -> UnrealShaderAdapter:
        let material_ptr = unreal_material_create_dynamic()
        let shader = UnrealShaderAdapter::new(material_ptr)

        return shader


# Shader utility functions

# Create simple color shader
pub fn create_color_shader(r: f32, g: f32, b: f32, a: f32, engine: String) -> Shader:
    let vertex_src = """
    #version 330
    in vec3 position;
    uniform mat4 mvp;
    void main() {
        gl_Position = mvp * vec4(position, 1.0);
    }
    """

    let fragment_src = """
    #version 330
    uniform vec4 color;
    out vec4 fragColor;
    void main() {
        fragColor = color;
    }
    """

    let mut shader = ShaderBuilder::new()
        .vertex(vertex_src)
        .fragment(fragment_src)
        .uniform(ShaderUniform::new("mvp", "mat4"))
        .uniform(ShaderUniform::new("color", "vec4"))

    if engine == "godot":
        let godot_shader = shader.build_godot()
        godot_shader.set_uniform_vec4("color", r, g, b, a)
        return godot_shader
    else:
        let unreal_shader = shader.build_unreal()
        unreal_shader.set_uniform_vec4("color", r, g, b, a)
        return unreal_shader


# FFI declarations for Godot shaders
extern "C":
    fn godot_shader_create() -> ffi.VoidPtr
    fn godot_shader_compile(shader: ffi.VoidPtr) -> bool
    fn godot_shader_get_errors(shader: ffi.VoidPtr, count: ffi.VoidPtr) -> ffi.VoidPtr
    fn godot_shader_get_source(shader: ffi.VoidPtr, stage: String) -> ffi.VoidPtr
    fn godot_shader_set_source(shader: ffi.VoidPtr, stage: String, source: String)
    fn godot_shader_has_uniform(shader: ffi.VoidPtr, name: String) -> bool
    fn godot_shader_set_uniform_float(shader: ffi.VoidPtr, name: String, value: f32)
    fn godot_shader_set_uniform_vec2(shader: ffi.VoidPtr, name: String, x: f32, y: f32)
    fn godot_shader_set_uniform_vec3(shader: ffi.VoidPtr, name: String, x: f32, y: f32, z: f32)
    fn godot_shader_set_uniform_vec4(shader: ffi.VoidPtr, name: String, x: f32, y: f32, z: f32, w: f32)
    fn godot_shader_set_uniform_texture(shader: ffi.VoidPtr, name: String, texture: ffi.VoidPtr)

# FFI declarations for Unreal materials (shaders)
extern "C":
    fn unreal_material_create_dynamic() -> ffi.VoidPtr
    fn unreal_material_has_parameter(material: ffi.VoidPtr, name: String) -> bool
    fn unreal_material_set_scalar_parameter(material: ffi.VoidPtr, name: String, value: f32)
    fn unreal_material_set_vector_parameter(material: ffi.VoidPtr, name: String, x: f32, y: f32, z: f32, w: f32)
    fn unreal_material_set_texture_parameter(material: ffi.VoidPtr, name: String, texture: ffi.VoidPtr)


# Example usage:
#
# # Create shader using builder
# let mut shader = ShaderBuilder::new()
#     .vertex(vertex_source)
#     .fragment(fragment_source)
#     .uniform(ShaderUniform::new("time", "float"))
#     .uniform(ShaderUniform::new("color", "vec4"))
#     .build_godot()
#
# # Compile and use
# if shader.compile():
#     shader.set_uniform_float("time", 1.0)
#     shader.set_uniform_vec4("color", 1.0, 0.0, 0.0, 1.0)
# else:
#     let errors = shader.get_compile_errors()
#     for error in errors:
#         print(error)
#
# # Create simple color shader
# let color_shader = create_color_shader(1.0, 0.5, 0.0, 1.0, "godot")
