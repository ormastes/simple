# Distributed Backend and Reduction Operations
#
# Backend types and reduction operations for distributed training.

export Backend, ReduceOp

# ============================================================================
# Backend Enum
# ============================================================================

enum Backend:
    """Distributed backend type.

    - NCCL: NVIDIA Collective Communications Library (GPU-only, recommended)
    - GLOO: CPU and GPU support (cross-platform)
    - MPI: Message Passing Interface (research/HPC)
    """
    NCCL   # GPU-only, fastest for multi-GPU
    GLOO   # CPU and GPU, cross-platform
    MPI    # Research/HPC environments

    fn to_str(self) -> str:
        """Convert backend to string."""
        match self:
            Backend::NCCL -> "nccl"
            Backend::GLOO -> "gloo"
            Backend::MPI -> "mpi"

    # =========================================================================
    # Helper Methods
    # =========================================================================

    fn is_nccl(self) -> bool:
        """Check if this is NCCL backend.

        Returns:
            true for NCCL

        Example:
            Backend::NCCL.is_nccl()  # → true
        """
        match self:
            case NCCL: true
            case _: false

    fn is_gloo(self) -> bool:
        """Check if this is GLOO backend.

        Returns:
            true for GLOO

        Example:
            Backend::GLOO.is_gloo()  # → true
        """
        match self:
            case GLOO: true
            case _: false

    fn is_mpi(self) -> bool:
        """Check if this is MPI backend.

        Returns:
            true for MPI

        Example:
            Backend::MPI.is_mpi()  # → true
        """
        match self:
            case MPI: true
            case _: false

    fn is_gpu_only(self) -> bool:
        """Check if backend is GPU-only.

        Returns:
            true for NCCL

        Example:
            Backend::NCCL.is_gpu_only()  # → true
            Backend::GLOO.is_gpu_only()  # → false
        """
        match self:
            case NCCL: true
            case _: false

    fn supports_cpu(self) -> bool:
        """Check if backend supports CPU.

        Returns:
            true for GLOO and MPI

        Example:
            Backend::GLOO.supports_cpu()  # → true
            Backend::NCCL.supports_cpu()  # → false
        """
        match self:
            case GLOO: true
            case MPI: true
            case NCCL: false

    fn supports_gpu(self) -> bool:
        """Check if backend supports GPU.

        Returns:
            true for all backends

        Example:
            Backend::NCCL.supports_gpu()  # → true
        """
        true

    fn is_recommended(self) -> bool:
        """Check if this is the recommended backend.

        Returns:
            true for NCCL (best for multi-GPU)

        Example:
            Backend::NCCL.is_recommended()  # → true
        """
        match self:
            case NCCL: true
            case _: false

    fn description(self) -> String:
        """Get backend description.

        Returns:
            Human-readable description

        Example:
            Backend::NCCL.description()
            # → "NVIDIA Collective Communications Library (GPU-only)"
        """
        match self:
            case NCCL: "NVIDIA Collective Communications Library (GPU-only)"
            case GLOO: "CPU and GPU support (cross-platform)"
            case MPI: "Message Passing Interface (research/HPC)"

    fn summary(self) -> String:
        """Get summary of backend.

        Returns:
            Human-readable summary

        Example:
            Backend::NCCL.summary()
            # → "Backend: nccl (GPU-only, recommended)"
        """
        let name = self.to_str()
        let platform = if self.is_gpu_only():
                           "GPU-only"
                       else if self.supports_cpu():
                           "CPU/GPU"
                       else:
                           "multi-platform"
        let rec = if self.is_recommended(): ", recommended" else: ""
        return "Backend: {name} ({platform}{rec})"


# ============================================================================
# Reduction Operations
# ============================================================================

enum ReduceOp:
    """Reduction operation for collective communication.

    - SUM: Sum values across processes
    - PRODUCT: Multiply values across processes
    - MIN: Minimum value across processes
    - MAX: Maximum value across processes
    - BAND: Bitwise AND across processes
    - BOR: Bitwise OR across processes
    - BXOR: Bitwise XOR across processes
    """
    SUM
    PRODUCT
    MIN
    MAX
    BAND   # Bitwise AND
    BOR    # Bitwise OR
    BXOR   # Bitwise XOR

    fn code(self) -> i32:
        """Convert to FFI code."""
        match self:
            ReduceOp::SUM -> 0
            ReduceOp::PRODUCT -> 1
            ReduceOp::MIN -> 2
            ReduceOp::MAX -> 3
            ReduceOp::BAND -> 4
            ReduceOp::BOR -> 5
            ReduceOp::BXOR -> 6
