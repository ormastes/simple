# Log Module - Unified logging with levels 0-10
#
# Log levels:
#   0 = Off      - No logging
#   1 = Fatal    - Unrecoverable errors
#   2 = Error    - Recoverable errors
#   3 = Warn     - Potential issues
#   4 = Info     - High-level events
#   5 = Debug    - Detailed events
#   6 = Trace    - Very detailed
#   7 = Verbose  - Every instruction
#   8-9 = Reserved
#   10 = All     - Everything
#
# Uses simple-hir-core LogLevel for shared type definitions.

# FFI declarations (matches log_ffi.rs in simple-runtime)
extern fn rt_log_emit(level: i64, scope_ptr: i64, scope_len: i64, msg_ptr: i64, msg_len: i64)
extern fn rt_log_get_global_level() -> i64
extern fn rt_log_set_global_level(level: i64)
extern fn rt_log_get_scope_level(scope_ptr: i64, scope_len: i64) -> i64
extern fn rt_log_set_scope_level(scope_ptr: i64, scope_len: i64, level: i64)
extern fn rt_log_is_enabled(level: i64, scope_ptr: i64, scope_len: i64) -> i64
extern fn rt_log_clear_scope_levels()

# Log level constants (matches hir-core LogLevel)
val LOG_OFF = 0
val LOG_FATAL = 1
val LOG_ERROR = 2
val LOG_WARN = 3
val LOG_INFO = 4
val LOG_DEBUG = 5
val LOG_TRACE = 6
val LOG_VERBOSE = 7
val LOG_ALL = 10

# ============================================================================
# Configuration
# ============================================================================

pub fn set_level(level: i64):
    """Set global log level (0-10)."""
    rt_log_set_global_level(level)

pub fn set_scope_level(scope: text, level: i64):
    """Set log level for specific scope."""
    rt_log_set_scope_level(scope.ptr(), scope.len(), level)

pub fn get_level(scope: text) -> i64:
    """Get effective log level for scope."""
    rt_log_get_scope_level(scope.ptr(), scope.len())

pub fn get_global_level() -> i64:
    """Get global log level."""
    rt_log_get_global_level()

pub fn is_enabled(level: i64, scope: text) -> bool:
    """Check if logging is enabled at level for scope."""
    rt_log_is_enabled(level, scope.ptr(), scope.len()) != 0

pub fn clear_scopes():
    """Clear all scope-specific log levels."""
    rt_log_clear_scope_levels()

# ============================================================================
# Logging Functions
# ============================================================================

fn emit(level: i64, scope: text, msg: text):
    """Emit a log message via FFI."""
    rt_log_emit(level, scope.ptr(), scope.len(), msg.ptr(), msg.len())

pub fn fatal(scope: text, msg: text):
    """Log fatal error (level 1)."""
    emit(LOG_FATAL, scope, msg)

pub fn error(scope: text, msg: text):
    """Log error (level 2)."""
    emit(LOG_ERROR, scope, msg)

pub fn warn(scope: text, msg: text):
    """Log warning (level 3)."""
    emit(LOG_WARN, scope, msg)

pub fn info(scope: text, msg: text):
    """Log info (level 4)."""
    emit(LOG_INFO, scope, msg)

pub fn debug(scope: text, msg: text):
    """Log debug (level 5)."""
    emit(LOG_DEBUG, scope, msg)

pub fn trace(scope: text, msg: text):
    """Log trace (level 6)."""
    emit(LOG_TRACE, scope, msg)

pub fn verbose(scope: text, msg: text):
    """Log verbose (level 7)."""
    emit(LOG_VERBOSE, scope, msg)

# ============================================================================
# Convenience Functions (default scope)
# ============================================================================

pub fn log_fatal(msg: text):
    """Log fatal with default scope."""
    fatal("app", msg)

pub fn log_error(msg: text):
    """Log error with default scope."""
    error("app", msg)

pub fn log_warn(msg: text):
    """Log warning with default scope."""
    warn("app", msg)

pub fn log_info(msg: text):
    """Log info with default scope."""
    info("app", msg)

pub fn log_debug(msg: text):
    """Log debug with default scope."""
    debug("app", msg)

pub fn log_trace(msg: text):
    """Log trace with default scope."""
    trace("app", msg)

pub fn log_verbose(msg: text):
    """Log verbose with default scope."""
    verbose("app", msg)

# ============================================================================
# Level Names
# ============================================================================

pub fn level_name(level: i64) -> text:
    """Get human-readable name for log level."""
    match level:
        case 0: "off"
        case 1: "fatal"
        case 2: "error"
        case 3: "warn"
        case 4: "info"
        case 5: "debug"
        case 6: "trace"
        case 7: "verbose"
        case 10: "all"
        case _: "unknown"

pub fn parse_level(name: text) -> i64:
    """Parse log level from name."""
    match name.lower():
        case "off": LOG_OFF
        case "fatal": LOG_FATAL
        case "error": LOG_ERROR
        case "warn": LOG_WARN
        case "info": LOG_INFO
        case "debug": LOG_DEBUG
        case "trace": LOG_TRACE
        case "verbose": LOG_VERBOSE
        case "all": LOG_ALL
        case _: LOG_INFO  # Default to INFO

# ============================================================================
# Exports
# ============================================================================

pub use LOG_OFF, LOG_FATAL, LOG_ERROR, LOG_WARN, LOG_INFO
pub use LOG_DEBUG, LOG_TRACE, LOG_VERBOSE, LOG_ALL
pub use set_level, set_scope_level, get_level, get_global_level
pub use is_enabled, clear_scopes
pub use fatal, error, warn, info, debug, trace, verbose
pub use log_fatal, log_error, log_warn, log_info, log_debug, log_trace, log_verbose
pub use level_name, parse_level
