# Log Module - Unified logging with levels 0-10
#
# Log levels:
#   0 = Off      - No logging
#   1 = Fatal    - Unrecoverable errors
#   2 = Error    - Recoverable errors
#   3 = Warn     - Potential issues
#   4 = Info     - High-level events
#   5 = Debug    - Detailed events
#   6 = Trace    - Very detailed
#   7 = Verbose  - Every instruction
#   8-9 = Reserved
#   10 = All     - Everything

# FFI declarations
extern fn rt_log_emit(level: i64, scope_ptr: i64, scope_len: i64, msg_ptr: i64, msg_len: i64)
extern fn rt_log_get_level(scope_ptr: i64, scope_len: i64) -> i64
extern fn rt_log_set_level(scope_ptr: i64, scope_len: i64, level: i64)
extern fn rt_log_set_global_level(level: i64)
extern fn rt_eprintln(msg_ptr: i64, msg_len: i64)

# Log level constants
val LOG_OFF = 0
val LOG_FATAL = 1
val LOG_ERROR = 2
val LOG_WARN = 3
val LOG_INFO = 4
val LOG_DEBUG = 5
val LOG_TRACE = 6
val LOG_VERBOSE = 7
val LOG_ALL = 10

# Global log level (default: INFO)
var global_level = 4

# Scope levels (scope -> level)
var scope_levels: Dict<text, i64> = {}

# ============================================================================
# Configuration
# ============================================================================

pub fn set_level(level: i64):
    """Set global log level (0-10)."""
    global_level = level

pub fn set_scope_level(scope: text, level: i64):
    """Set log level for specific scope."""
    scope_levels[scope] = level

pub fn get_level(scope: text) -> i64:
    """Get effective log level for scope."""
    scope_levels[scope] ?? global_level

# ============================================================================
# Logging Functions
# ============================================================================

fn should_log(level: i64, scope: text) -> bool:
    """Check if message should be logged."""
    get_level(scope) >= level

fn emit(level: i64, scope: text, msg: text):
    """Emit a log message."""
    if should_log(level, scope):
        val prefix = match level:
            case 1: "[FATAL]"
            case 2: "[ERROR]"
            case 3: "[WARN] "
            case 4: "[INFO] "
            case 5: "[DEBUG]"
            case 6: "[TRACE]"
            case 7: "[VERB] "
            case _: "[LOG]  "
        val full_msg = "{prefix} [{scope}] {msg}"
        # Use stderr for logging
        print full_msg

pub fn fatal(scope: text, msg: text):
    """Log fatal error (level 1)."""
    emit(LOG_FATAL, scope, msg)

pub fn error(scope: text, msg: text):
    """Log error (level 2)."""
    emit(LOG_ERROR, scope, msg)

pub fn warn(scope: text, msg: text):
    """Log warning (level 3)."""
    emit(LOG_WARN, scope, msg)

pub fn info(scope: text, msg: text):
    """Log info (level 4)."""
    emit(LOG_INFO, scope, msg)

pub fn debug(scope: text, msg: text):
    """Log debug (level 5)."""
    emit(LOG_DEBUG, scope, msg)

pub fn trace(scope: text, msg: text):
    """Log trace (level 6)."""
    emit(LOG_TRACE, scope, msg)

pub fn verbose(scope: text, msg: text):
    """Log verbose (level 7)."""
    emit(LOG_VERBOSE, scope, msg)

# ============================================================================
# Convenience Functions (default scope)
# ============================================================================

pub fn log_fatal(msg: text):
    """Log fatal with default scope."""
    fatal("app", msg)

pub fn log_error(msg: text):
    """Log error with default scope."""
    error("app", msg)

pub fn log_warn(msg: text):
    """Log warning with default scope."""
    warn("app", msg)

pub fn log_info(msg: text):
    """Log info with default scope."""
    info("app", msg)

pub fn log_debug(msg: text):
    """Log debug with default scope."""
    debug("app", msg)

pub fn log_trace(msg: text):
    """Log trace with default scope."""
    trace("app", msg)

# ============================================================================
# Exports
# ============================================================================

export LOG_OFF, LOG_FATAL, LOG_ERROR, LOG_WARN, LOG_INFO
export LOG_DEBUG, LOG_TRACE, LOG_VERBOSE, LOG_ALL
export set_level, set_scope_level, get_level
export fatal, error, warn, info, debug, trace, verbose
export log_fatal, log_error, log_warn, log_info, log_debug, log_trace
