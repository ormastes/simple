# VSCode Debug Adapter Protocol (DAP) Integration
# Enable debugging Simple code in VSCode

use core.result.{Result, Ok, Err}

# External FFI declarations
extern fn vscode_debug_start_session(config: String): i64
extern fn vscode_debug_set_breakpoint(file: String, line: i32): i64
extern fn vscode_debug_continue(session_id: i64): void
extern fn vscode_debug_step_over(session_id: i64): void
extern fn vscode_debug_step_into(session_id: i64): void
extern fn vscode_debug_step_out(session_id: i64): void
extern fn vscode_debug_pause(session_id: i64): void
extern fn vscode_debug_stop(session_id: i64): void
extern fn vscode_debug_evaluate(session_id: i64, expression: String): String

# Debug session
pub class DebugSession:
    pub session_id: i64
    pub configuration: DebugConfiguration
    pub state: DebugState

    pub fn new(config: DebugConfiguration): DebugSession =
        """Create debug session.

        Args:
            config: Debug configuration

        Returns:
            Debug session

        Example:
            let config = DebugConfiguration.new("simple")
            config.set_program("app.spl")
            let session = DebugSession.new(config)
            session.start()
        """
        DebugSession {
            session_id: 0,
            configuration: config,
            state: DebugState::Stopped
        }

    pub fn start(self):
        """Start debug session."""
        let config_json = self.configuration.to_json()
        self.session_id = vscode_debug_start_session(config_json)
        self.state = DebugState::Running

    pub fn continue_execution(self):
        """Continue execution."""
        vscode_debug_continue(self.session_id)
        self.state = DebugState::Running

    pub fn step_over(self):
        """Step over current line."""
        vscode_debug_step_over(self.session_id)

    pub fn step_into(self):
        """Step into function."""
        vscode_debug_step_into(self.session_id)

    pub fn step_out(self):
        """Step out of function."""
        vscode_debug_step_out(self.session_id)

    pub fn pause(self):
        """Pause execution."""
        vscode_debug_pause(self.session_id)
        self.state = DebugState::Paused

    pub fn stop(self):
        """Stop debug session."""
        vscode_debug_stop(self.session_id)
        self.state = DebugState::Stopped

    pub fn evaluate(self, expression: String): String =
        """Evaluate expression in current context.

        Args:
            expression: Expression to evaluate

        Returns:
            Evaluation result

        Example:
            let result = session.evaluate("x + y")
            print("Result: {result}")
        """
        vscode_debug_evaluate(self.session_id, expression)

# Debug configuration
pub class DebugConfiguration:
    pub debug_type: String
    pub name: String
    pub request: String
    pub program: String
    pub args: List[String]
    pub cwd: String
    pub env: Dict[String, String]
    pub stop_on_entry: bool

    pub fn new(debug_type: String): DebugConfiguration =
        """Create debug configuration.

        Args:
            debug_type: Debug type (e.g., "simple")

        Returns:
            Configuration with defaults
        """
        DebugConfiguration {
            debug_type: debug_type,
            name: "Debug Simple",
            request: "launch",
            program: "",
            args: [],
            cwd: "${workspaceFolder}",
            env: {},
            stop_on_entry: false
        }

    pub fn set_program(self, program: String):
        """Set program to debug.

        Args:
            program: Path to program file
        """
        self.program = program

    pub fn add_arg(self, arg: String):
        """Add program argument.

        Args:
            arg: Argument to add
        """
        self.args.append(arg)

    pub fn set_env(self, key: String, value: String):
        """Set environment variable.

        Args:
            key: Variable name
            value: Variable value
        """
        self.env[key] = value

    pub fn to_json(self): String =
        """Convert to JSON string.

        Returns:
            JSON representation
        """
        # TODO: Implement proper JSON serialization
        "{{\"type\": \"{self.debug_type}\", \"name\": \"{self.name}\", \"request\": \"{self.request}\", \"program\": \"{self.program}\"}}"

# Debug state
pub enum DebugState:
    Stopped
    Running
    Paused
    Terminated

# Breakpoint
pub class Breakpoint:
    pub file: String
    pub line: i32
    pub condition: String
    pub hit_count: i32
    pub enabled: bool
    pub breakpoint_id: i64

    pub fn new(file: String, line: i32): Breakpoint =
        """Create breakpoint.

        Args:
            file: Source file
            line: Line number (1-indexed)

        Returns:
            Breakpoint

        Example:
            let bp = Breakpoint.new("app.spl", 10)
            bp.set_condition("x > 5")
            bp.set()
        """
        Breakpoint {
            file: file,
            line: line,
            condition: "",
            hit_count: 0,
            enabled: true,
            breakpoint_id: 0
        }

    pub fn set_condition(self, condition: String):
        """Set breakpoint condition.

        Args:
            condition: Condition expression

        Example:
            bp.set_condition("x > 10 and y < 20")
        """
        self.condition = condition

    pub fn set(self):
        """Set breakpoint."""
        self.breakpoint_id = vscode_debug_set_breakpoint(self.file, self.line)

    pub fn enable(self):
        """Enable breakpoint."""
        self.enabled = true

    pub fn disable(self):
        """Disable breakpoint."""
        self.enabled = false

    pub fn toggle(self):
        """Toggle breakpoint enabled state."""
        self.enabled = not self.enabled

# Variable
pub class Variable:
    pub name: String
    pub value: String
    pub variable_type: String
    pub children: List[Variable]

    pub fn new(name: String, value: String, var_type: String): Variable =
        """Create variable representation.

        Args:
            name: Variable name
            value: Variable value
            var_type: Variable type

        Returns:
            Variable
        """
        Variable {
            name: name,
            value: value,
            variable_type: var_type,
            children: []
        }

    pub fn add_child(self, child: Variable):
        """Add child variable (for structs/objects).

        Args:
            child: Child variable
        """
        self.children.append(child)

# Stack frame
pub class StackFrame:
    pub name: String
    pub file: String
    pub line: i32
    pub column: i32
    pub variables: List[Variable]

    pub fn new(name: String, file: String, line: i32): StackFrame =
        """Create stack frame.

        Args:
            name: Function name
            file: Source file
            line: Line number

        Returns:
            Stack frame
        """
        StackFrame {
            name: name,
            file: file,
            line: line,
            column: 0,
            variables: []
        }

    pub fn add_variable(self, variable: Variable):
        """Add local variable.

        Args:
            variable: Variable to add
        """
        self.variables.append(variable)

# Debug adapter
pub class DebugAdapter:
    pub sessions: Dict[i64, DebugSession]
    pub breakpoints: List[Breakpoint]

    pub fn new(): DebugAdapter =
        """Create debug adapter."""
        DebugAdapter {
            sessions: {},
            breakpoints: []
        }

    pub fn start_session(self, config: DebugConfiguration): DebugSession =
        """Start new debug session.

        Args:
            config: Debug configuration

        Returns:
            Started session

        Example:
            let adapter = DebugAdapter.new()
            let config = DebugConfiguration.new("simple")
            config.set_program("app.spl")
            let session = adapter.start_session(config)
        """
        let session = DebugSession.new(config)
        session.start()
        self.sessions[session.session_id] = session
        session

    pub fn add_breakpoint(self, file: String, line: i32): Breakpoint =
        """Add breakpoint.

        Args:
            file: Source file
            line: Line number

        Returns:
            Created breakpoint
        """
        let bp = Breakpoint.new(file, line)
        bp.set()
        self.breakpoints.append(bp)
        bp

    pub fn remove_breakpoint(self, breakpoint: Breakpoint):
        """Remove breakpoint.

        Args:
            breakpoint: Breakpoint to remove
        """
        # TODO: Remove from list
        pass

    pub fn get_session(self, session_id: i64): DebugSession? =
        """Get debug session by ID.

        Args:
            session_id: Session ID

        Returns:
            Session if found
        """
        self.sessions.get(session_id)

# Helper: Register debug adapter
pub fn register_debug_adapter(
    debug_type: String,
    adapter_factory: fn(session: DebugSession): DebugAdapter
):
    """Register debug adapter for language.

    Args:
        debug_type: Debug type (e.g., "simple")
        adapter_factory: Factory function to create adapter

    Example:
        register_debug_adapter("simple", fn(session):
            let adapter = DebugAdapter.new()
            # Configure adapter
            adapter
        )
    """
    # TODO: Register with VSCode
    pass

# Helper: Create simple debug configuration
pub fn create_debug_config(program: String): DebugConfiguration =
    """Create simple debug configuration.

    Args:
        program: Program to debug

    Returns:
        Debug configuration

    Example:
        let config = create_debug_config("app.spl")
        config.stop_on_entry = true
        let session = DebugSession.new(config)
        session.start()
    """
    let config = DebugConfiguration.new("simple")
    config.set_program(program)
    config
