# VSCode Document Provider API
# Provide virtual documents and custom file system providers

# External FFI declarations
extern fn vscode_document_provider_register(scheme: String, callback_id: i64): i64
extern fn vscode_document_provider_fire_change(uri: String): void

# Import types
use vscode.languages.TextDocument

# Text document content provider
pub class TextDocumentContentProvider:
    pub scheme: String
    pub provide_fn: fn(uri: String): String

    pub fn new(scheme: String): TextDocumentContentProvider =
        """Create text document content provider.

        Args:
            scheme: URI scheme to handle (e.g., "simple-preview")

        Example:
            provider = TextDocumentContentProvider.new("simple-preview")
            provider.provide_fn = fn(uri):
                # Generate content for URI
                return "# Preview\n\nContent for " + uri
        """
        TextDocumentContentProvider {
            scheme: scheme,
            provide_fn: fn(uri): ""
        }

    pub fn provide_text_document_content(self, uri: String): String =
        """Provide content for URI.

        Args:
            uri: Document URI

        Returns:
            Document content as string
        """
        self.provide_fn(uri)

    pub fn fire_change(self, uri: String):
        """Notify VSCode that document content changed.

        Args:
            uri: Document URI that changed

        Example:
            provider.fire_change("simple-preview://document")
        """
        vscode_document_provider_fire_change(uri)

# Register text document content provider
pub fn register_text_document_content_provider(
    scheme: String,
    provider: TextDocumentContentProvider
): i64 =
    """Register text document content provider.

    Args:
        scheme: URI scheme
        provider: Content provider

    Returns:
        Subscription ID for disposal

    Example:
        provider = TextDocumentContentProvider.new("simple-ast")

        provider.provide_fn = fn(uri):
            # Parse file and show AST
            val source = read_file(uri)
            val ast = parse(source)
            return format_ast(ast)

        document_provider.register_text_document_content_provider("simple-ast", provider)

        # Open virtual document:
        # vscode://simple-ast/path/to/file.spl
    """
    # TODO: [stdlib][P3] Store provider callback
    val callback_id = 0
    vscode_document_provider_register(scheme, callback_id)

# File system provider (for custom file systems)
pub class FileSystemProvider:
    pub scheme: String
    pub stat_fn: fn(uri: String): FileStat?
    pub read_directory_fn: fn(uri: String): List[String]
    pub read_file_fn: fn(uri: String): String
    pub write_file_fn: fn(uri: String, content: String): void
    pub create_directory_fn: fn(uri: String): void
    pub delete_fn: fn(uri: String): void
    pub rename_fn: fn(old_uri: String, new_uri: String): void

    pub fn new(scheme: String): FileSystemProvider =
        """Create file system provider.

        Args:
            scheme: URI scheme (e.g., "memory", "remote")

        Example:
            provider = FileSystemProvider.new("memory")
            provider.read_file_fn = fn(uri):
                return memory_files[uri]
            provider.write_file_fn = fn(uri, content):
                memory_files[uri] = content
        """
        FileSystemProvider {
            scheme: scheme,
            stat_fn: fn(uri): none,
            read_directory_fn: fn(uri): [],
            read_file_fn: fn(uri): "",
            write_file_fn: fn(uri, content): pass,
            create_directory_fn: fn(uri): pass,
            delete_fn: fn(uri): pass,
            rename_fn: fn(old, new): pass
        }

# File stat
pub class FileStat:
    pub type: i32  # File = 1, Directory = 2, SymbolicLink = 64
    pub ctime: i64  # Creation time
    pub mtime: i64  # Modification time
    pub size: i64   # Size in bytes

    pub fn new(file_type: i32, size: i64): FileStat =
        """Create file stat.

        Args:
            file_type: 1 for file, 2 for directory
            size: File size in bytes
        """
        FileStat {
            type: file_type,
            ctime: 0,
            mtime: 0,
            size: size
        }

pub val FileType_File: i32 = 1
pub val FileType_Directory: i32 = 2
pub val FileType_SymbolicLink: i32 = 64

# Helper: Create preview provider
pub fn create_preview_provider(
    scheme: String,
    render_fn: fn(uri: String): String
): TextDocumentContentProvider =
    """Create preview provider.

    Args:
        scheme: URI scheme
        render_fn: Function to render content

    Returns:
        Configured content provider

    Example:
        provider = document_provider.create_preview_provider("simple-preview", fn(uri):
            val source = read_file(uri)
            return render_markdown(source)
        )

        document_provider.register_text_document_content_provider("simple-preview", provider)
    """
    val provider = TextDocumentContentProvider.new(scheme)
    provider.provide_fn = render_fn
    provider

# Helper: Create AST viewer
pub fn create_ast_viewer(parser_fn: fn(source: String): String): TextDocumentContentProvider =
    """Create AST viewer provider.

    Args:
        parser_fn: Function that parses source and returns formatted AST

    Returns:
        AST viewer provider

    Example:
        provider = document_provider.create_ast_viewer(fn(source):
            val ast = parse(source)
            return format_as_tree(ast)
        )

        document_provider.register_text_document_content_provider("simple-ast", provider)
    """
    val provider = TextDocumentContentProvider.new("simple-ast")
    provider.provide_fn = fn(uri):
        # Extract real file path from virtual URI
        val real_path = uri.replace("simple-ast://", "")
        val source = ""  # TODO: [stdlib][P3] Read file from workspace
        parser_fn(source)

    provider

# Helper: Create diagnostics viewer
pub fn create_diagnostics_viewer(checker_fn: fn(source: String): String): TextDocumentContentProvider =
    """Create diagnostics viewer provider.

    Args:
        checker_fn: Function that checks source and returns diagnostics

    Returns:
        Diagnostics viewer provider

    Example:
        provider = document_provider.create_diagnostics_viewer(fn(source):
            val errors = type_check(source)
            return format_errors(errors)
        )

        document_provider.register_text_document_content_provider("simple-diagnostics", provider)
    """
    val provider = TextDocumentContentProvider.new("simple-diagnostics")
    provider.provide_fn = fn(uri):
        val real_path = uri.replace("simple-diagnostics://", "")
        val source = ""  # TODO: [stdlib][P3] Read file
        checker_fn(source)

    provider

# In-memory file system example
val memory_files: Dict[String, String] = {}

pub fn create_memory_file_system(): FileSystemProvider =
    """Create in-memory file system provider.

    Returns:
        File system provider that stores files in memory

    Example:
        provider = document_provider.create_memory_file_system()

        # Files accessed via memory:// URIs
        # memory://file1.spl
        # memory://folder/file2.spl
    """
    val provider = FileSystemProvider.new("memory")

    provider.stat_fn = fn(uri):
        match memory_files.get(uri):
            some(content):
                return some(FileStat.new(FileType_File, content.len()))
            none:
                return none

    provider.read_file_fn = fn(uri):
        match memory_files.get(uri):
            some(content): content
            none: ""

    provider.write_file_fn = fn(uri, content):
        memory_files[uri] = content

    provider.delete_fn = fn(uri):
        memory_files.remove(uri)

    provider
