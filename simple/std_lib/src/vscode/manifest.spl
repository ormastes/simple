# VSCode Extension Manifest Generator
# Auto-generate package.json from Simple extension code

use core.json
use core.result.{Result, Ok, Err}

# Extension manifest
pub class ExtensionManifest:
    pub name: String
    pub display_name: String
    pub description: String
    pub version: String
    pub publisher: String
    pub engines: Dict[String, String]
    pub categories: List[String]
    pub activationEvents: List[String]
    pub main: String
    pub contributes: ManifestContributes
    pub scripts: Dict[String, String]
    pub devDependencies: Dict[String, String]

    pub fn new(name: String, version: String): ExtensionManifest =
        """Create extension manifest.

        Args:
            name: Extension name (lowercase-with-dashes)
            version: SemVer version

        Returns:
            Manifest with defaults

        Example:
            val manifest = ExtensionManifest.new("simple-lang", "1.0.0")
            manifest.set_publisher("simple-lang")
            manifest.add_language("simple")
        """
        ExtensionManifest {
            name: name,
            display_name: name,
            description: "",
            version: version,
            publisher: "",
            engines: {"vscode": "^1.80.0"},
            categories: ["Programming Languages"],
            activationEvents: ["onLanguage:simple"],
            main: "./out/extension.js",
            contributes: ManifestContributes.new(),
            scripts: {
                "compile": "tsc -p ./",
                "watch": "tsc -watch -p ./",
                "package": "vsce package"
            },
            devDependencies: {
                "@types/vscode": "^1.80.0",
                "typescript": "^5.0.0",
                "@vscode/test-electron": "^2.3.0"
            }
        }

    pub fn set_publisher(self, publisher: String):
        """Set extension publisher."""
        self.publisher = publisher

    pub fn set_description(self, description: String):
        """Set extension description."""
        self.description = description

    pub fn set_display_name(self, display_name: String):
        """Set display name."""
        self.display_name = display_name

    pub fn add_activation_event(self, event: String):
        """Add activation event.

        Args:
            event: Event string (e.g., "onCommand:simple.build")
        """
        self.activationEvents.append(event)

    pub fn add_category(self, category: String):
        """Add extension category.

        Args:
            category: Category (e.g., "Linters", "Formatters")
        """
        self.categories.append(category)

    pub fn add_language(self, language_id: String):
        """Add language support.

        Args:
            language_id: Language identifier
        """
        self.contributes.add_language(language_id)
        self.add_activation_event("onLanguage:{language_id}")

    pub fn add_command(self, command: String, title: String):
        """Add command contribution.

        Args:
            command: Command ID
            title: Command title
        """
        self.contributes.add_command(command, title)
        self.add_activation_event("onCommand:{command}")

    pub fn to_json(self): String =
        """Generate package.json content.

        Returns:
            JSON string for package.json
        """
        # TODO: [stdlib][P1] Implement proper JSON serialization when available
        val json = "{\n"
        json = json + "  \"name\": \"{self.name}\",\n"
        json = json + "  \"displayName\": \"{self.display_name}\",\n"
        json = json + "  \"description\": \"{self.description}\",\n"
        json = json + "  \"version\": \"{self.version}\",\n"
        json = json + "  \"publisher\": \"{self.publisher}\",\n"
        json = json + "  \"engines\": {\n"
        json = json + "    \"vscode\": \"^1.80.0\"\n"
        json = json + "  },\n"
        json = json + "  \"categories\": [\n"
        for (i, cat) in self.categories.enumerate():
            json = json + "    \"{cat}\""
            if i < self.categories.len() - 1:
                json = json + ","
            json = json + "\n"
        json = json + "  ],\n"
        json = json + "  \"activationEvents\": [\n"
        for (i, event) in self.activationEvents.enumerate():
            json = json + "    \"{event}\""
            if i < self.activationEvents.len() - 1:
                json = json + ","
            json = json + "\n"
        json = json + "  ],\n"
        json = json + "  \"main\": \"{self.main}\",\n"
        json = json + "  \"contributes\": " + self.contributes.to_json() + "\n"
        json = json + "}\n"
        json

# Manifest contributions section
pub class ManifestContributes:
    pub languages: List[LanguageContribution]
    pub commands: List[CommandContribution]
    pub grammars: List[GrammarContribution]
    pub themes: List[ThemeContribution]
    pub configuration: ConfigurationContribution?

    pub fn new(): ManifestContributes =
        """Create empty contributions."""
        ManifestContributes {
            languages: [],
            commands: [],
            grammars: [],
            themes: [],
            configuration: none
        }

    pub fn add_language(self, language_id: String):
        """Add language contribution.

        Args:
            language_id: Language identifier
        """
        val lang = LanguageContribution {
            id: language_id,
            extensions: [".{language_id}"],
            aliases: [language_id.capitalize()],
            configuration: "./language-configuration.json"
        }
        self.languages.append(lang)

    pub fn add_command(self, command: String, title: String):
        """Add command contribution.

        Args:
            command: Command ID
            title: Command title
        """
        val cmd = CommandContribution {
            command: command,
            title: title,
            category: "Simple"
        }
        self.commands.append(cmd)

    pub fn to_json(self): String =
        """Convert to JSON string.

        Returns:
            JSON representation
        """
        val json = "{\n"

        # Languages
        if self.languages.len() > 0:
            json = json + "    \"languages\": [\n"
            for (i, lang) in self.languages.enumerate():
                json = json + "      " + lang.to_json()
                if i < self.languages.len() - 1:
                    json = json + ","
                json = json + "\n"
            json = json + "    ],\n"

        # Commands
        if self.commands.len() > 0:
            json = json + "    \"commands\": [\n"
            for (i, cmd) in self.commands.enumerate():
                json = json + "      " + cmd.to_json()
                if i < self.commands.len() - 1:
                    json = json + ","
                json = json + "\n"
            json = json + "    ]\n"

        json = json + "  }"
        json

# Language contribution
pub class LanguageContribution:
    pub id: String
    pub extensions: List[String]
    pub aliases: List[String]
    pub configuration: String

    pub fn to_json(self): String =
        "{{\n        \"id\": \"{self.id}\",\n        \"extensions\": [\"{self.extensions[0]}\"],\n        \"aliases\": [\"{self.aliases[0]}\"],\n        \"configuration\": \"{self.configuration}\"\n      }}"

# Command contribution
pub class CommandContribution:
    pub command: String
    pub title: String
    pub category: String

    pub fn to_json(self): String =
        "{{\n        \"command\": \"{self.command}\",\n        \"title\": \"{self.title}\",\n        \"category\": \"{self.category}\"\n      }}"

# Grammar contribution
pub class GrammarContribution:
    pub language: String
    pub scopeName: String
    pub path: String

# Theme contribution
pub class ThemeContribution:
    pub label: String
    pub uiTheme: String
    pub path: String

# Configuration contribution
pub class ConfigurationContribution:
    pub title: String
    pub properties: Dict[String, ConfigProperty]

# Configuration property
pub class ConfigProperty:
    pub property_type: String
    pub default: String
    pub description: String

# Manifest generator - extract info from extension code
pub class ManifestGenerator:
    pub manifest: ExtensionManifest

    pub fn new(name: String, version: String): ManifestGenerator =
        """Create manifest generator.

        Args:
            name: Extension name
            version: Version

        Returns:
            Generator instance

        Example:
            val gen = ManifestGenerator.new("simple-lang", "1.0.0")
            gen.scan_extension_file("extension.spl")
            val package_json = gen.manifest.to_json()
        """
        ManifestGenerator {
            manifest: ExtensionManifest.new(name, version)
        }

    pub fn scan_extension_file(self, path: String):
        """Scan extension code to extract commands, languages, etc.

        Args:
            path: Path to extension.spl

        Scans for:
        - commands.register_command() calls
        - languages.register_*_provider() calls
        - workspace.create_file_system_watcher() patterns
        """
        # TODO: [stdlib][P2] Parse extension file and extract:
        # - Command registrations → add_command()
        # - Language providers → add_language()
        # - Activation events
        pass

    pub fn set_metadata(
        self,
        publisher: String,
        description: String,
        display_name: String
    ):
        """Set extension metadata.

        Args:
            publisher: Publisher ID
            description: Extension description
            display_name: Display name
        """
        self.manifest.set_publisher(publisher)
        self.manifest.set_description(description)
        self.manifest.set_display_name(display_name)

    pub fn generate(self): String =
        """Generate package.json.

        Returns:
            package.json content
        """
        self.manifest.to_json()

    pub fn write_to_file(self, path: String):
        """Write package.json to file.

        Args:
            path: Output path
        """
        val json = self.generate()
        # TODO: [stdlib][P3] Write to file when fs module available
        pass

# Helper: Generate package.json from extension code
pub fn generate_package_json(
    extension_file: String,
    name: String,
    version: String,
    publisher: String
): String =
    """Generate package.json from extension code.

    Args:
        extension_file: Path to extension.spl
        name: Extension name
        version: Version string
        publisher: Publisher ID

    Returns:
        package.json content

    Example:
        val json = generate_package_json(
            "extension.spl",
            "simple-lang",
            "1.0.0",
            "simple-lang-team"
        )
        write_file("package.json", json)
    """
    val gen = ManifestGenerator.new(name, version)
    gen.set_metadata(publisher, "Simple language support", "Simple Language")
    gen.scan_extension_file(extension_file)
    gen.generate()
