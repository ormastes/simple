# Color - RGBA color representation
#
# Provides Color type for graphics rendering with linear RGB color space.
# Supports conversion from sRGB, hexadecimal colors, and common presets.
# All internal calculations use linear RGB; textures are in sRGB.
#
# Based on: doc/spec/graphics_3d.md

use core.*
use graphics.math.vector.*

# =============================================================================
# Color - RGBA color (linear RGB, 0-1 range)
# =============================================================================

pub struct Color:
    r: f32  # Red channel (0.0 - 1.0, linear)
    g: f32  # Green channel (0.0 - 1.0, linear)
    b: f32  # Blue channel (0.0 - 1.0, linear)
    a: f32  # Alpha channel (0.0 - 1.0)

impl Color:
    # Constructors
    pub fn new(r: f32, g: f32, b: f32, a: f32) -> Color:
        return Color {
            r: clamp(r, 0.0, 1.0),
            g: clamp(g, 0.0, 1.0),
            b: clamp(b, 0.0, 1.0),
            a: clamp(a, 0.0, 1.0)
        }

    pub fn rgb(r: f32, g: f32, b: f32) -> Color:
        return Color::new(r, g, b, 1.0)

    # Create from sRGB (gamma-corrected) values (0-255)
    pub fn from_srgb(r: u8, g: u8, b: u8, a: u8) -> Color:
        return Color {
            r: srgb_to_linear(r as f32 / 255.0),
            g: srgb_to_linear(g as f32 / 255.0),
            b: srgb_to_linear(b as f32 / 255.0),
            a: a as f32 / 255.0
        }

    pub fn from_srgb_f32(r: f32, g: f32, b: f32, a: f32) -> Color:
        return Color {
            r: srgb_to_linear(r),
            g: srgb_to_linear(g),
            b: srgb_to_linear(b),
            a: a
        }

    # Create from hexadecimal (0xRRGGBB or 0xRRGGBBAA)
    pub fn from_hex(hex: u32) -> Color:
        # Check if alpha is included (8 hex digits)
        let has_alpha = hex > 0xFFFFFF

        let r = ((hex >> 24) & 0xFF) as u8
        let g = ((hex >> 16) & 0xFF) as u8
        let b = ((hex >> 8) & 0xFF) as u8
        let a = if has_alpha: (hex & 0xFF) as u8 else: 255_u8

        return Color::from_srgb(r, g, b, a)

    # Create from hexadecimal without alpha (0xRRGGBB)
    pub fn from_hex_rgb(hex: u32) -> Color:
        let r = ((hex >> 16) & 0xFF) as u8
        let g = ((hex >> 8) & 0xFF) as u8
        let b = (hex & 0xFF) as u8
        return Color::from_srgb(r, g, b, 255)

    # Component access
    pub fn r(self) -> f32:
        return self.r

    pub fn g(self) -> f32:
        return self.g

    pub fn b(self) -> f32:
        return self.b

    pub fn a(self) -> f32:
        return self.a

    # Conversions
    pub fn to_vec3(self) -> Vec3:
        return Vec3::new(self.r, self.g, self.b)

    pub fn to_vec4(self) -> Vec4:
        return Vec4::new(self.r, self.g, self.b, self.a)

    pub fn to_srgb_u8(self) -> (u8, u8, u8, u8):
        let r = (linear_to_srgb(self.r) * 255.0) as u8
        let g = (linear_to_srgb(self.g) * 255.0) as u8
        let b = (linear_to_srgb(self.b) * 255.0) as u8
        let a = (self.a * 255.0) as u8
        return (r, g, b, a)

    pub fn to_hex(self) -> u32:
        let (r, g, b, a) = self.to_srgb_u8()
        return ((r as u32) << 24) | ((g as u32) << 16) | ((b as u32) << 8) | (a as u32)

    # Color operations
    pub fn lerp(self, other: Color, t: f32) -> Color:
        return Color {
            r: self.r + (other.r - self.r) * t,
            g: self.g + (other.g - self.g) * t,
            b: self.b + (other.b - self.b) * t,
            a: self.a + (other.a - self.a) * t
        }

    pub fn multiply(self, other: Color) -> Color:
        return Color {
            r: self.r * other.r,
            g: self.g * other.g,
            b: self.b * other.b,
            a: self.a * other.a
        }

    pub fn add(self, other: Color) -> Color:
        return Color {
            r: clamp(self.r + other.r, 0.0, 1.0),
            g: clamp(self.g + other.g, 0.0, 1.0),
            b: clamp(self.b + other.b, 0.0, 1.0),
            a: clamp(self.a + other.a, 0.0, 1.0)
        }

    pub fn scale(self, factor: f32) -> Color:
        return Color {
            r: clamp(self.r * factor, 0.0, 1.0),
            g: clamp(self.g * factor, 0.0, 1.0),
            b: clamp(self.b * factor, 0.0, 1.0),
            a: self.a
        }

    pub fn with_alpha(self, alpha: f32) -> Color:
        return Color {
            r: self.r,
            g: self.g,
            b: self.b,
            a: clamp(alpha, 0.0, 1.0)
        }

    # Grayscale conversion
    pub fn grayscale(self) -> Color:
        # Luminance weighting (Rec. 709)
        let luminance = self.r * 0.2126 + self.g * 0.7152 + self.b * 0.0722
        return Color::rgb(luminance, luminance, luminance)

    pub fn luminance(self) -> f32:
        return self.r * 0.2126 + self.g * 0.7152 + self.b * 0.0722

    # Common presets (linear RGB)
    pub fn white() -> Color:
        return Color::rgb(1.0, 1.0, 1.0)

    pub fn black() -> Color:
        return Color::rgb(0.0, 0.0, 0.0)

    pub fn red() -> Color:
        return Color::rgb(1.0, 0.0, 0.0)

    pub fn green() -> Color:
        return Color::rgb(0.0, 1.0, 0.0)

    pub fn blue() -> Color:
        return Color::rgb(0.0, 0.0, 1.0)

    pub fn yellow() -> Color:
        return Color::rgb(1.0, 1.0, 0.0)

    pub fn cyan() -> Color:
        return Color::rgb(0.0, 1.0, 1.0)

    pub fn magenta() -> Color:
        return Color::rgb(1.0, 0.0, 1.0)

    pub fn gray() -> Color:
        return Color::rgb(0.5, 0.5, 0.5)

    pub fn transparent() -> Color:
        return Color::new(0.0, 0.0, 0.0, 0.0)

    # Named web colors (sRGB)
    pub fn alice_blue() -> Color:
        return Color::from_hex_rgb(0xF0F8FF)

    pub fn antique_white() -> Color:
        return Color::from_hex_rgb(0xFAEBD7)

    pub fn aqua() -> Color:
        return Color::from_hex_rgb(0x00FFFF)

    pub fn aquamarine() -> Color:
        return Color::from_hex_rgb(0x7FFFD4)

    pub fn azure() -> Color:
        return Color::from_hex_rgb(0xF0FFFF)

    pub fn beige() -> Color:
        return Color::from_hex_rgb(0xF5F5DC)

    pub fn bisque() -> Color:
        return Color::from_hex_rgb(0xFFE4C4)

    pub fn blanched_almond() -> Color:
        return Color::from_hex_rgb(0xFFEBCD)

    pub fn blue_violet() -> Color:
        return Color::from_hex_rgb(0x8A2BE2)

    pub fn brown() -> Color:
        return Color::from_hex_rgb(0xA52A2A)

    pub fn burly_wood() -> Color:
        return Color::from_hex_rgb(0xDEB887)

    pub fn cadet_blue() -> Color:
        return Color::from_hex_rgb(0x5F9EA0)

    pub fn chartreuse() -> Color:
        return Color::from_hex_rgb(0x7FFF00)

    pub fn chocolate() -> Color:
        return Color::from_hex_rgb(0xD2691E)

    pub fn coral() -> Color:
        return Color::from_hex_rgb(0xFF7F50)

    pub fn cornflower_blue() -> Color:
        return Color::from_hex_rgb(0x6495ED)

    pub fn cornsilk() -> Color:
        return Color::from_hex_rgb(0xFFF8DC)

    pub fn crimson() -> Color:
        return Color::from_hex_rgb(0xDC143C)

    pub fn dark_blue() -> Color:
        return Color::from_hex_rgb(0x00008B)

    pub fn dark_cyan() -> Color:
        return Color::from_hex_rgb(0x008B8B)

    pub fn dark_golden_rod() -> Color:
        return Color::from_hex_rgb(0xB8860B)

    pub fn dark_gray() -> Color:
        return Color::from_hex_rgb(0xA9A9A9)

    pub fn dark_green() -> Color:
        return Color::from_hex_rgb(0x006400)

    pub fn dark_khaki() -> Color:
        return Color::from_hex_rgb(0xBDB76B)

    pub fn dark_magenta() -> Color:
        return Color::from_hex_rgb(0x8B008B)

    pub fn dark_olive_green() -> Color:
        return Color::from_hex_rgb(0x556B2F)

    pub fn dark_orange() -> Color:
        return Color::from_hex_rgb(0xFF8C00)

    pub fn dark_orchid() -> Color:
        return Color::from_hex_rgb(0x9932CC)

    pub fn dark_red() -> Color:
        return Color::from_hex_rgb(0x8B0000)

    pub fn dark_salmon() -> Color:
        return Color::from_hex_rgb(0xE9967A)

    pub fn dark_sea_green() -> Color:
        return Color::from_hex_rgb(0x8FBC8F)

    pub fn dark_slate_blue() -> Color:
        return Color::from_hex_rgb(0x483D8B)

    pub fn dark_slate_gray() -> Color:
        return Color::from_hex_rgb(0x2F4F4F)

    pub fn dark_turquoise() -> Color:
        return Color::from_hex_rgb(0x00CED1)

    pub fn dark_violet() -> Color:
        return Color::from_hex_rgb(0x9400D3)

    pub fn deep_pink() -> Color:
        return Color::from_hex_rgb(0xFF1493)

    pub fn deep_sky_blue() -> Color:
        return Color::from_hex_rgb(0x00BFFF)

    pub fn dim_gray() -> Color:
        return Color::from_hex_rgb(0x696969)

    pub fn dodger_blue() -> Color:
        return Color::from_hex_rgb(0x1E90FF)

    pub fn fire_brick() -> Color:
        return Color::from_hex_rgb(0xB22222)

    pub fn floral_white() -> Color:
        return Color::from_hex_rgb(0xFFFAF0)

    pub fn forest_green() -> Color:
        return Color::from_hex_rgb(0x228B22)

    pub fn fuchsia() -> Color:
        return Color::from_hex_rgb(0xFF00FF)

    pub fn gainsboro() -> Color:
        return Color::from_hex_rgb(0xDCDCDC)

    pub fn ghost_white() -> Color:
        return Color::from_hex_rgb(0xF8F8FF)

    pub fn gold() -> Color:
        return Color::from_hex_rgb(0xFFD700)

    pub fn golden_rod() -> Color:
        return Color::from_hex_rgb(0xDAA520)

    pub fn green_yellow() -> Color:
        return Color::from_hex_rgb(0xADFF2F)

    pub fn honey_dew() -> Color:
        return Color::from_hex_rgb(0xF0FFF0)

    pub fn hot_pink() -> Color:
        return Color::from_hex_rgb(0xFF69B4)

    pub fn indian_red() -> Color:
        return Color::from_hex_rgb(0xCD5C5C)

    pub fn indigo() -> Color:
        return Color::from_hex_rgb(0x4B0082)

    pub fn ivory() -> Color:
        return Color::from_hex_rgb(0xFFFFF0)

    pub fn khaki() -> Color:
        return Color::from_hex_rgb(0xF0E68C)

    pub fn lavender() -> Color:
        return Color::from_hex_rgb(0xE6E6FA)

    pub fn lavender_blush() -> Color:
        return Color::from_hex_rgb(0xFFF0F5)

    pub fn lawn_green() -> Color:
        return Color::from_hex_rgb(0x7CFC00)

    pub fn lemon_chiffon() -> Color:
        return Color::from_hex_rgb(0xFFFACD)

    pub fn light_blue() -> Color:
        return Color::from_hex_rgb(0xADD8E6)

    pub fn light_coral() -> Color:
        return Color::from_hex_rgb(0xF08080)

    pub fn light_cyan() -> Color:
        return Color::from_hex_rgb(0xE0FFFF)

    pub fn light_golden_rod_yellow() -> Color:
        return Color::from_hex_rgb(0xFAFAD2)

    pub fn light_gray() -> Color:
        return Color::from_hex_rgb(0xD3D3D3)

    pub fn light_green() -> Color:
        return Color::from_hex_rgb(0x90EE90)

    pub fn light_pink() -> Color:
        return Color::from_hex_rgb(0xFFB6C1)

    pub fn light_salmon() -> Color:
        return Color::from_hex_rgb(0xFFA07A)

    pub fn light_sea_green() -> Color:
        return Color::from_hex_rgb(0x20B2AA)

    pub fn light_sky_blue() -> Color:
        return Color::from_hex_rgb(0x87CEFA)

    pub fn light_slate_gray() -> Color:
        return Color::from_hex_rgb(0x778899)

    pub fn light_steel_blue() -> Color:
        return Color::from_hex_rgb(0xB0C4DE)

    pub fn light_yellow() -> Color:
        return Color::from_hex_rgb(0xFFFFE0)

    pub fn lime() -> Color:
        return Color::from_hex_rgb(0x00FF00)

    pub fn lime_green() -> Color:
        return Color::from_hex_rgb(0x32CD32)

    pub fn linen() -> Color:
        return Color::from_hex_rgb(0xFAF0E6)

    pub fn maroon() -> Color:
        return Color::from_hex_rgb(0x800000)

    pub fn medium_aqua_marine() -> Color:
        return Color::from_hex_rgb(0x66CDAA)

    pub fn medium_blue() -> Color:
        return Color::from_hex_rgb(0x0000CD)

    pub fn medium_orchid() -> Color:
        return Color::from_hex_rgb(0xBA55D3)

    pub fn medium_purple() -> Color:
        return Color::from_hex_rgb(0x9370DB)

    pub fn medium_sea_green() -> Color:
        return Color::from_hex_rgb(0x3CB371)

    pub fn medium_slate_blue() -> Color:
        return Color::from_hex_rgb(0x7B68EE)

    pub fn medium_spring_green() -> Color:
        return Color::from_hex_rgb(0x00FA9A)

    pub fn medium_turquoise() -> Color:
        return Color::from_hex_rgb(0x48D1CC)

    pub fn medium_violet_red() -> Color:
        return Color::from_hex_rgb(0xC71585)

    pub fn midnight_blue() -> Color:
        return Color::from_hex_rgb(0x191970)

    pub fn mint_cream() -> Color:
        return Color::from_hex_rgb(0xF5FFFA)

    pub fn misty_rose() -> Color:
        return Color::from_hex_rgb(0xFFE4E1)

    pub fn moccasin() -> Color:
        return Color::from_hex_rgb(0xFFE4B5)

    pub fn navajo_white() -> Color:
        return Color::from_hex_rgb(0xFFDEAD)

    pub fn navy() -> Color:
        return Color::from_hex_rgb(0x000080)

    pub fn old_lace() -> Color:
        return Color::from_hex_rgb(0xFDF5E6)

    pub fn olive() -> Color:
        return Color::from_hex_rgb(0x808000)

    pub fn olive_drab() -> Color:
        return Color::from_hex_rgb(0x6B8E23)

    pub fn orange() -> Color:
        return Color::from_hex_rgb(0xFFA500)

    pub fn orange_red() -> Color:
        return Color::from_hex_rgb(0xFF4500)

    pub fn orchid() -> Color:
        return Color::from_hex_rgb(0xDA70D6)

    pub fn pale_golden_rod() -> Color:
        return Color::from_hex_rgb(0xEEE8AA)

    pub fn pale_green() -> Color:
        return Color::from_hex_rgb(0x98FB98)

    pub fn pale_turquoise() -> Color:
        return Color::from_hex_rgb(0xAFEEEE)

    pub fn pale_violet_red() -> Color:
        return Color::from_hex_rgb(0xDB7093)

    pub fn papaya_whip() -> Color:
        return Color::from_hex_rgb(0xFFEFD5)

    pub fn peach_puff() -> Color:
        return Color::from_hex_rgb(0xFFDAB9)

    pub fn peru() -> Color:
        return Color::from_hex_rgb(0xCD853F)

    pub fn pink() -> Color:
        return Color::from_hex_rgb(0xFFC0CB)

    pub fn plum() -> Color:
        return Color::from_hex_rgb(0xDDA0DD)

    pub fn powder_blue() -> Color:
        return Color::from_hex_rgb(0xB0E0E6)

    pub fn purple() -> Color:
        return Color::from_hex_rgb(0x800080)

    pub fn rebecca_purple() -> Color:
        return Color::from_hex_rgb(0x663399)

    pub fn rosy_brown() -> Color:
        return Color::from_hex_rgb(0xBC8F8F)

    pub fn royal_blue() -> Color:
        return Color::from_hex_rgb(0x4169E1)

    pub fn saddle_brown() -> Color:
        return Color::from_hex_rgb(0x8B4513)

    pub fn salmon() -> Color:
        return Color::from_hex_rgb(0xFA8072)

    pub fn sandy_brown() -> Color:
        return Color::from_hex_rgb(0xF4A460)

    pub fn sea_green() -> Color:
        return Color::from_hex_rgb(0x2E8B57)

    pub fn sea_shell() -> Color:
        return Color::from_hex_rgb(0xFFF5EE)

    pub fn sienna() -> Color:
        return Color::from_hex_rgb(0xA0522D)

    pub fn silver() -> Color:
        return Color::from_hex_rgb(0xC0C0C0)

    pub fn sky_blue() -> Color:
        return Color::from_hex_rgb(0x87CEEB)

    pub fn slate_blue() -> Color:
        return Color::from_hex_rgb(0x6A5ACD)

    pub fn slate_gray() -> Color:
        return Color::from_hex_rgb(0x708090)

    pub fn snow() -> Color:
        return Color::from_hex_rgb(0xFFFAFA)

    pub fn spring_green() -> Color:
        return Color::from_hex_rgb(0x00FF7F)

    pub fn steel_blue() -> Color:
        return Color::from_hex_rgb(0x4682B4)

    pub fn tan() -> Color:
        return Color::from_hex_rgb(0xD2B48C)

    pub fn teal() -> Color:
        return Color::from_hex_rgb(0x008080)

    pub fn thistle() -> Color:
        return Color::from_hex_rgb(0xD8BFD8)

    pub fn tomato() -> Color:
        return Color::from_hex_rgb(0xFF6347)

    pub fn turquoise() -> Color:
        return Color::from_hex_rgb(0x40E0D0)

    pub fn violet() -> Color:
        return Color::from_hex_rgb(0xEE82EE)

    pub fn wheat() -> Color:
        return Color::from_hex_rgb(0xF5DEB3)

    pub fn white_smoke() -> Color:
        return Color::from_hex_rgb(0xF5F5F5)

    pub fn yellow_green() -> Color:
        return Color::from_hex_rgb(0x9ACD32)

    # =========================================================================
    # Helper Methods
    # =========================================================================

    pub fn is_transparent(self) -> bool:
        """Check if color is transparent (alpha is 0).

        Returns:
            True if alpha is 0
        """
        return self.a == 0.0

    pub fn is_opaque(self) -> bool:
        """Check if color is opaque (alpha is 1).

        Returns:
            True if alpha is 1
        """
        return self.a == 1.0

    pub fn is_translucent(self) -> bool:
        """Check if color is translucent (alpha between 0 and 1).

        Returns:
            True if alpha is between 0 and 1 (exclusive)
        """
        return self.a > 0.0 and self.a < 1.0

    pub fn is_black(self) -> bool:
        """Check if color is black (RGB all 0).

        Returns:
            True if r, g, b are all 0
        """
        return self.r == 0.0 and self.g == 0.0 and self.b == 0.0

    pub fn is_white(self) -> bool:
        """Check if color is white (RGB all 1).

        Returns:
            True if r, g, b are all 1
        """
        return self.r == 1.0 and self.g == 1.0 and self.b == 1.0

    pub fn is_grayscale(self) -> bool:
        """Check if color is grayscale (R == G == B).

        Returns:
            True if all RGB channels are equal
        """
        return self.r == self.g and self.g == self.b

    pub fn has_red(self) -> bool:
        """Check if color has red component.

        Returns:
            True if red > 0
        """
        return self.r > 0.0

    pub fn has_green(self) -> bool:
        """Check if color has green component.

        Returns:
            True if green > 0
        """
        return self.g > 0.0

    pub fn has_blue(self) -> bool:
        """Check if color has blue component.

        Returns:
            True if blue > 0
        """
        return self.b > 0.0

    pub fn is_dark(self) -> bool:
        """Check if color is dark (luminance < 0.5).

        Returns:
            True if luminance is less than 0.5
        """
        return self.luminance() < 0.5

    pub fn is_light(self) -> bool:
        """Check if color is light (luminance >= 0.5).

        Returns:
            True if luminance is 0.5 or greater
        """
        return self.luminance() >= 0.5

    pub fn brightness(self) -> f32:
        """Get brightness (same as luminance).

        Returns:
            Brightness value 0.0 to 1.0
        """
        return self.luminance()

    pub fn invert(self) -> Color:
        """Invert color (complement).

        Returns:
            Inverted color (1.0 - channel for each RGB)
        """
        return Color {
            r: 1.0 - self.r,
            g: 1.0 - self.g,
            b: 1.0 - self.b,
            a: self.a
        }

    pub fn desaturate(self) -> Color:
        """Desaturate color (convert to grayscale).

        Returns:
            Grayscale version of color
        """
        return self.grayscale()

    pub fn saturate(self, amount: f32) -> Color:
        """Increase saturation.

        Args:
            amount: Amount to increase saturation (0.0 to 1.0)

        Returns:
            More saturated color
        """
        let gray = self.grayscale()
        return self.lerp(gray, 1.0 - clamp(amount, 0.0, 1.0))

    pub fn lighten(self, amount: f32) -> Color:
        """Lighten color.

        Args:
            amount: Amount to lighten (0.0 to 1.0)

        Returns:
            Lighter version of color
        """
        return self.lerp(Color::white(), clamp(amount, 0.0, 1.0))

    pub fn darken(self, amount: f32) -> Color:
        """Darken color.

        Args:
            amount: Amount to darken (0.0 to 1.0)

        Returns:
            Darker version of color
        """
        return self.lerp(Color::black(), clamp(amount, 0.0, 1.0))

    pub fn fade(self, amount: f32) -> Color:
        """Fade color (reduce alpha).

        Args:
            amount: Amount to fade (0.0 to 1.0)

        Returns:
            More transparent version of color
        """
        return self.with_alpha(self.a * (1.0 - clamp(amount, 0.0, 1.0)))

    pub fn summary(self) -> String:
        """Get summary of color.

        Returns:
            Human-readable summary

        Example:
            Color::red().summary()
            # → "Color: rgba(1.000, 0.000, 0.000, 1.000) [opaque, light]"
        """
        let opacity = if self.is_opaque(): "opaque"
                      else if self.is_transparent(): "transparent"
                      else: "translucent"
        let brightness = if self.is_light(): "light" else: "dark"
        let gray = if self.is_grayscale(): ", grayscale" else: ""
        return "Color: rgba({self.r:.3}, {self.g:.3}, {self.b:.3}, {self.a:.3}) [{opacity}, {brightness}{gray}]"

# Color operators
impl Add for Color:
    fn add(self, other: Color) -> Color:
        return self.add(other)

impl Mul[f32] for Color:
    fn mul(self, scalar: f32) -> Color:
        return self.scale(scalar)

impl Mul for Color:
    fn mul(self, other: Color) -> Color:
        return self.multiply(other)

# =============================================================================
# Helper Functions
# =============================================================================

# sRGB ↔ Linear RGB conversion
# See: https://en.wikipedia.org/wiki/SRGB#Transfer_function_(gamma)

fn srgb_to_linear(srgb: f32) -> f32:
    if srgb <= 0.04045:
        return srgb / 12.92
    else:
        return pow((srgb + 0.055) / 1.055, 2.4)

fn linear_to_srgb(linear: f32) -> f32:
    if linear <= 0.0031308:
        return linear * 12.92
    else:
        return 1.055 * pow(linear, 1.0 / 2.4) - 0.055

fn clamp(value: f32, min: f32, max: f32) -> f32:
    if value < min:
        return min
    if value > max:
        return max
    return value
