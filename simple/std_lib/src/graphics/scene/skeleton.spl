# Skeleton - Bone hierarchy for skeletal animation
#
# Hierarchical skeleton system with joint management.

export Skeleton, Joint

use graphics.math.*

# =============================================================================
# Skeleton - Bone hierarchy
# =============================================================================

pub struct Skeleton:
    name: String
    joints: Array[Joint]              # All joints in skeleton
    joint_hierarchy: Array[i32]       # Parent indices (-1 = root)
    inverse_bind_matrices: Array[Mat4]  # Bind pose inverses
    root_joints: Array[i32]           # Root joint indices

pub struct Joint:
    name: String
    index: i32                        # Joint index
    parent_index: i32                 # Parent joint (-1 = root)
    local_transform: Transform        # Local transform (relative to parent)
    inverse_bind_matrix: Mat4         # Inverse bind pose matrix

impl Skeleton:
    pub fn new(name: String) -> Skeleton:
        return Skeleton {
            name: name,
            joints: Array::new(),
            joint_hierarchy: Array::new(),
            inverse_bind_matrices: Array::new(),
            root_joints: Array::new()
        }

    # Add joint to skeleton
    pub fn add_joint(
        mut self,
        name: String,
        parent_index: i32,
        local_transform: Transform,
        inverse_bind_matrix: Mat4
    ) -> i32:
        let index = self.joints.len() as i32

        let joint = Joint {
            name: name,
            index: index,
            parent_index: parent_index,
            local_transform: local_transform,
            inverse_bind_matrix: inverse_bind_matrix
        }

        self.joints.push(joint)
        self.joint_hierarchy.push(parent_index)
        self.inverse_bind_matrices.push(inverse_bind_matrix)

        # Track root joints
        if parent_index < 0:
            self.root_joints.push(index)

        return index

    # Find joint by name
    pub fn find_joint(self, name: String) -> Option[i32]:
        for i in 0..self.joints.len():
            if self.joints[i].name == name:
                return Some(i as i32)
        return None

    # Get joint count
    pub fn joint_count(self) -> i32:
        return self.joints.len() as i32
