# glTF FFI - External FFI functions
use core.*

# =============================================================================
# Helper Parsing Functions
# =============================================================================

impl GltfLoader:
    fn parse_vec3(json_opt: Option[JsonValue], default: Vec3) -> Vec3:
        match json_opt:
            case Some(json):
                let arr = json.as_array().unwrap_or(Array::new())
                if arr.len() >= 3:
                    return Vec3::new(
                        arr[0].as_f32().unwrap_or(default.x),
                        arr[1].as_f32().unwrap_or(default.y),
                        arr[2].as_f32().unwrap_or(default.z)
                    )
            case None:
                pass
        return default

    fn parse_quat(json_opt: Option[JsonValue], default: Quat) -> Quat:
        match json_opt:
            case Some(json):
                let arr = json.as_array().unwrap_or(Array::new())
                if arr.len() >= 4:
                    return Quat::new(
                        arr[0].as_f32().unwrap_or(default.x),
                        arr[1].as_f32().unwrap_or(default.y),
                        arr[2].as_f32().unwrap_or(default.z),
                        arr[3].as_f32().unwrap_or(default.w)
                    )
            case None:
                pass
        return default

    fn parse_mat4(json: JsonValue) -> Option[Mat4]:
        let arr = json.as_array()?
        if arr.len() < 16:
            return None

        # Column-major 4x4 matrix
        let mut values = Array[f32]::new()
        for i in 0..16:
            values.push(arr[i].as_f32().unwrap_or(0.0))

        return Some(Mat4::from_array(values))

# =============================================================================
# External FFI Functions
# =============================================================================

extern fn file_read_bytes(path: String) -> Result[Array[u8], String]
extern fn path_get_directory(path: String) -> String
extern fn path_join(base: String, relative: String) -> String
extern fn json_parse(json_str: String) -> Option[JsonValue]
extern fn decode_data_uri(uri: String) -> Result[Array[u8], String]
extern fn f32_from_bits(bits: u32) -> f32
