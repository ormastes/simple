# Viewport3D - 3D render target management for UI integration
#
# Provides render target management, texture extraction,
# and resolution handling for 3D viewports embedded in 2D UI.
#
# Based on: doc/plans/floating-booping-coral.md (3D Graphics Library)

use core.*
use graphics.math.*
use graphics.scene.*
use graphics.render.*
use ui.*

# =============================================================================
# Viewport3D - Manages 3D rendering for UI embedding
# =============================================================================

pub struct Viewport3D:
    renderer: Renderer3D
    scene: Scene
    camera: Camera
    width: u32
    height: u32
    needs_resize: bool
    enable_controls: bool

impl Viewport3D:
    # Create viewport
    pub fn new(width: u32, height: u32) -> Viewport3D:
        val renderer = Renderer3D::new(width, height)
        val scene = Scene::new("Viewport Scene")
        val camera = Camera::perspective_standard(width as f32 / height as f32)

        return Viewport3D {
            renderer: renderer,
            scene: scene,
            camera: camera,
            width: width,
            height: height,
            needs_resize: false,
            enable_controls: false
        }

    # Create with custom camera
    pub fn with_camera(width: u32, height: u32, camera: Camera) -> Viewport3D:
        val renderer = Renderer3D::new(width, height)
        val scene = Scene::new("Viewport Scene")

        return Viewport3D {
            renderer: renderer,
            scene: scene,
            camera: camera,
            width: width,
            height: height,
            needs_resize: false,
            enable_controls: false
        }

    # Scene access
    pub fn get_scene(self) -> Scene:
        return self.scene

    pub fn get_scene_mut(mut self) -> Scene:
        return self.scene

    pub fn set_scene(mut self, scene: Scene):
        self.scene = scene

    # Camera access
    pub fn get_camera(self) -> Camera:
        return self.camera

    pub fn get_camera_mut(mut self) -> Camera:
        return self.camera

    pub fn set_camera(mut self, camera: Camera):
        self.camera = camera

    # Enable/disable camera controls
    pub fn enable_controls(mut self, enable: bool):
        self.enable_controls = enable

    pub fn are_controls_enabled(self) -> bool:
        return self.enable_controls

    # Resize viewport
    pub fn resize(mut self, width: u32, height: u32):
        if self.width != width or self.height != height:
            self.width = width
            self.height = height
            self.needs_resize = true

            # Update camera aspect ratio
            self.camera.set_aspect_ratio(width as f32 / height as f32)

    # Get viewport dimensions
    pub fn get_width(self) -> u32:
        return self.width

    pub fn get_height(self) -> u32:
        return self.height

    # Render the scene
    pub fn render(mut self):
        # Recreate render target if needed
        if self.needs_resize:
            self.renderer.destroy()
            self.renderer = Renderer3D::new(self.width, self.height)
            self.needs_resize = false

        # Render scene with camera
        self.renderer.render(self.scene, self.camera)

    # Get rendered texture for UI compositing
    pub fn get_texture(self) -> Texture2D:
        val render_target = self.renderer.get_render_target()
        return render_target.get_color_texture()

    # Get texture handle for UI
    pub fn get_texture_handle(self) -> TextureHandle:
        return self.get_texture().get_handle()

    # Set clear color
    pub fn set_clear_color(mut self, color: Color):
        self.renderer.set_clear_color(color)

    # Cleanup
    pub fn destroy(mut self):
        self.renderer.destroy()

# =============================================================================
# ViewportConfig - Configuration for viewport behavior
# =============================================================================

pub struct ViewportConfig:
    clear_color: Color
    enable_controls: bool
    camera_speed: f32
    mouse_sensitivity: f32

impl ViewportConfig:
    pub fn default() -> ViewportConfig:
        return ViewportConfig {
            clear_color: Color::from_hex(0x87CEEB),  # Sky blue
            enable_controls: true,
            camera_speed: 5.0,
            mouse_sensitivity: 0.002
        }

    pub fn no_controls() -> ViewportConfig:
        return ViewportConfig {
            clear_color: Color::from_hex(0x87CEEB),
            enable_controls: false,
            camera_speed: 0.0,
            mouse_sensitivity: 0.0
        }

    pub fn custom(clear_color: Color, controls: bool) -> ViewportConfig:
        return ViewportConfig {
            clear_color: clear_color,
            enable_controls: controls,
            camera_speed: 5.0,
            mouse_sensitivity: 0.002
        }
