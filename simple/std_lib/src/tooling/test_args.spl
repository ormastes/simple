# Test runner argument parsing
# Migrated from: src/driver/src/cli/test_runner/args.rs
# Purpose: Parse command-line arguments into TestOptions

# Test level filter
enum TestLevel:
    All
    Unit
    Integration
    System

# Output format for test results
enum OutputFormat:
    Text     # Default text format with colors
    Json     # JSON format for machine-readable output
    Doc      # Nested documentation format (like RSpec)

# Options for the test runner
struct TestOptions:
    path: Option<text>
    level: TestLevel
    tag: Option<text>
    fail_fast: bool
    seed: Option<u64>
    gc_log: bool
    gc_off: bool
    format: OutputFormat
    watch: bool
    doctest_src: bool
    doctest_doc: bool
    doctest_md: bool
    doctest_src_dir: Option<text>
    doctest_doc_dir: Option<text>
    doctest_md_dir: Option<text>
    seq_diagram: bool
    class_diagram: bool
    arch_diagram: bool
    diagram_all: bool
    seq_include: Option<text>
    seq_exclude: Option<text>
    diagram_output: Option<text>
    capture_screenshots: bool
    refresh_gui_images: bool
    screenshot_output: Option<text>

impl TestOptions:
    # Create default test options
    static fn default() -> TestOptions:
        TestOptions(
            path: None,
            level: TestLevel::All,
            tag: None,
            fail_fast: false,
            seed: None,
            gc_log: false,
            gc_off: false,
            format: OutputFormat::Text,
            watch: false,
            doctest_src: false,
            doctest_doc: false,
            doctest_md: false,
            doctest_src_dir: None,
            doctest_doc_dir: None,
            doctest_md_dir: None,
            seq_diagram: false,
            class_diagram: false,
            arch_diagram: false,
            diagram_all: false,
            seq_include: None,
            seq_exclude: None,
            diagram_output: None,
            capture_screenshots: false,
            refresh_gui_images: false,
            screenshot_output: None
        )

# Parse test command arguments
fn parse_test_args(args: List<text>) -> TestOptions:
    var options = TestOptions.default()
    var i = 0

    while i < args.len():
        val arg = args[i]

        # Test level filters
        if arg == "--unit":
            options.level = TestLevel::Unit
        elif arg == "--integration":
            options.level = TestLevel::Integration
        elif arg == "--system":
            options.level = TestLevel::System

        # Boolean flags
        elif arg == "--fail-fast":
            options.fail_fast = true
        elif arg == "--gc-log":
            options.gc_log = true
        elif arg == "--gc=off" or arg == "--gc=OFF":
            options.gc_off = true
        elif arg == "--watch":
            options.watch = true
        elif arg == "--json":
            options.format = OutputFormat::Json
        elif arg == "--doc":
            options.format = OutputFormat::Doc

        # Doctest flags
        elif arg == "--doctest":
            options.doctest_src = true
            options.doctest_doc = true
            options.doctest_md = true
        elif arg == "--all":
            options.doctest_src = true
            options.doctest_doc = true
            options.doctest_md = true
        elif arg == "--doctest-src":
            options.doctest_src = true
        elif arg == "--doctest-doc":
            options.doctest_doc = true
        elif arg == "--doctest-md":
            options.doctest_md = true

        # Diagram flags
        elif arg == "--seq-diagram":
            options.seq_diagram = true
        elif arg == "--class-diagram":
            options.class_diagram = true
        elif arg == "--arch-diagram":
            options.arch_diagram = true
        elif arg == "--diagram-all":
            options.diagram_all = true
            options.seq_diagram = true
            options.class_diagram = true
            options.arch_diagram = true

        # Screenshot flags
        elif arg == "--capture-screenshots" or arg == "--screenshots":
            options.capture_screenshots = true
        elif arg == "--refresh-gui-image" or arg == "--refresh-screenshots":
            options.refresh_gui_images = true
            options.capture_screenshots = true

        # Value flags (require next argument)
        elif arg == "--tag" and i + 1 < args.len():
            i = i + 1
            options.tag = Some(args[i])
        elif arg == "--seed" and i + 1 < args.len():
            i = i + 1
            val maybe_seed = args[i].parse_u64()
            if maybe_seed.is_ok():
                options.seed = Some(maybe_seed.unwrap())
        elif arg == "--format" and i + 1 < args.len():
            i = i + 1
            if args[i] == "json":
                options.format = OutputFormat::Json
            elif args[i] == "doc":
                options.format = OutputFormat::Doc
            else:
                options.format = OutputFormat::Text

        elif arg == "--doctest-src-dir" and i + 1 < args.len():
            i = i + 1
            options.doctest_src_dir = Some(args[i])
            options.doctest_src = true
        elif arg == "--doctest-doc-dir" and i + 1 < args.len():
            i = i + 1
            options.doctest_doc_dir = Some(args[i])
            options.doctest_doc = true
        elif arg == "--doctest-md-dir" and i + 1 < args.len():
            i = i + 1
            options.doctest_md_dir = Some(args[i])
            options.doctest_md = true

        elif arg == "--seq-include" and i + 1 < args.len():
            i = i + 1
            options.seq_include = Some(args[i])
        elif arg == "--seq-exclude" and i + 1 < args.len():
            i = i + 1
            options.seq_exclude = Some(args[i])

        elif arg == "--diagram-output" and i + 1 < args.len():
            i = i + 1
            options.diagram_output = Some(args[i])
        elif arg == "--screenshot-output" and i + 1 < args.len():
            i = i + 1
            options.screenshot_output = Some(args[i])
            options.capture_screenshots = true

        # Path argument (non-flag)
        elif not arg.starts_with("-"):
            if options.path.is_none():
                options.path = Some(arg)

        i = i + 1

    options
