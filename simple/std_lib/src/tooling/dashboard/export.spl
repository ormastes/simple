# Dashboard Export
#
# Export dashboard data to various formats (HTML, Markdown, JSON, CSV).

use core.io.fs.{write_text_file}
use core.time.{now_iso8601}
use tooling.dashboard.types.{DashboardData}
use tooling.dashboard.trends.{TrendReport, format_trend}
use tooling.dashboard.alerts.{Alert, format_alerts}

# =========================================================================
# Export Formats
# =========================================================================

enum ExportFormat:
    Html
    Markdown
    Json
    Csv

# =========================================================================
# Exporter
# =========================================================================

class DashboardExporter:
    format: ExportFormat

    static fn new(format: ExportFormat) -> DashboardExporter:
        return DashboardExporter { format: format }

    # Export dashboard data
    fn export(data: DashboardData, trends: Option<TrendReport>, alerts: List<Alert>) -> text:
        match self.format:
            ExportFormat::Html => export_html(data, trends, alerts)
            ExportFormat::Markdown => export_markdown(data, trends, alerts)
            ExportFormat::Json => export_json(data, trends, alerts)
            ExportFormat::Csv => export_csv(data)

    # Export to file
    fn export_to_file(data: DashboardData, trends: Option<TrendReport>, alerts: List<Alert>, filename: text) -> Result<(), text>:
        val content = self.export(data, trends, alerts)
        return write_text_file(filename, content)

# =========================================================================
# HTML Export
# =========================================================================

fn export_html(data: DashboardData, trends: Option<TrendReport>, alerts: List<Alert>) -> text:
    var html = "<!DOCTYPE html>\n<html>\n<head>\n"
    html = "{html}  <title>Dashboard Report - {data.timestamp}</title>\n"
    html = "{html}  <meta charset=\"utf-8\">\n"
    html = "{html}  <style>\n"
    html = "{html}    body {{ font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }}\n"
    html = "{html}    .container {{ max-width: 1200px; margin: 0 auto; background: white; padding: 40px; border-radius: 8px; }}\n"
    html = "{html}    h1 {{ color: #333; border-bottom: 3px solid #2196F3; padding-bottom: 10px; }}\n"
    html = "{html}    h2 {{ color: #555; margin-top: 30px; }}\n"
    html = "{html}    .metric-grid {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }}\n"
    html = "{html}    .metric-card {{ background: #f9f9f9; padding: 20px; border-radius: 4px; border-left: 4px solid #2196F3; }}\n"
    html = "{html}    .metric-label {{ color: #666; font-size: 14px; margin-bottom: 5px; }}\n"
    html = "{html}    .metric-value {{ font-size: 36px; font-weight: bold; color: #2196F3; }}\n"
    html = "{html}    .progress {{ background: #e0e0e0; height: 24px; border-radius: 12px; overflow: hidden; margin: 10px 0; }}\n"
    html = "{html}    .progress-bar {{ background: linear-gradient(90deg, #4CAF50, #8BC34A); height: 100%; text-align: center; color: white; line-height: 24px; font-weight: bold; }}\n"
    html = "{html}    .alert {{ padding: 15px; margin: 10px 0; border-radius: 4px; }}\n"
    html = "{html}    .alert-critical {{ background: #ffebee; border-left: 4px solid #f44336; color: #c62828; }}\n"
    html = "{html}    .alert-warning {{ background: #fff3e0; border-left: 4px solid #ff9800; color: #e65100; }}\n"
    html = "{html}    .alert-info {{ background: #e3f2fd; border-left: 4px solid #2196F3; color: #1565c0; }}\n"
    html = "{html}    table {{ width: 100%; border-collapse: collapse; margin: 20px 0; }}\n"
    html = "{html}    th {{ background: #2196F3; color: white; padding: 12px; text-align: left; }}\n"
    html = "{html}    td {{ padding: 10px; border-bottom: 1px solid #ddd; }}\n"
    html = "{html}    tr:hover {{ background: #f5f5f5; }}\n"
    html = "{html}    .trend-up {{ color: #4CAF50; }}\n"
    html = "{html}    .trend-down {{ color: #f44336; }}\n"
    html = "{html}    .trend-stable {{ color: #666; }}\n"
    html = "{html}    .footer {{ margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 12px; }}\n"
    html = "{html}  </style>\n"
    html = "{html}</head>\n<body>\n<div class=\"container\">\n"

    # Header
    html = "{html}  <h1>Dashboard Report</h1>\n"
    html = "{html}  <p>Generated: {data.timestamp}</p>\n"

    # Metrics Grid
    html = "{html}  <h2>Overview</h2>\n"
    html = "{html}  <div class=\"metric-grid\">\n"

    val feature_percent = if data.total_features() == 0: 0.0 else: ((data.completed_features() as f64) / (data.total_features() as f64)) * 100.0
    html = "{html}    <div class=\"metric-card\">\n"
    html = "{html}      <div class=\"metric-label\">Features Complete</div>\n"
    html = "{html}      <div class=\"metric-value\">{data.completed_features()}/{data.total_features()}</div>\n"
    html = "{html}      <div class=\"progress\"><div class=\"progress-bar\" style=\"width: {feature_percent}%\">{feature_percent:.1f}%</div></div>\n"
    html = "{html}    </div>\n"

    html = "{html}    <div class=\"metric-card\">\n"
    html = "{html}      <div class=\"metric-label\">Code Coverage</div>\n"
    html = "{html}      <div class=\"metric-value\">{data.overall_coverage():.1f}%</div>\n"
    html = "{html}      <div class=\"progress\"><div class=\"progress-bar\" style=\"width: {data.overall_coverage()}%\">{data.overall_coverage():.1f}%</div></div>\n"
    html = "{html}    </div>\n"

    html = "{html}    <div class=\"metric-card\">\n"
    html = "{html}      <div class=\"metric-label\">TODOs</div>\n"
    html = "{html}      <div class=\"metric-value\">{data.total_todos()}</div>\n"
    html = "{html}      <div style=\"color: #f44336; font-weight: bold;\">P0: {data.critical_todos()}</div>\n"
    html = "{html}    </div>\n"

    html = "{html}    <div class=\"metric-card\">\n"
    html = "{html}      <div class=\"metric-label\">SSpec Tests</div>\n"
    html = "{html}      <div class=\"metric-value\">{data.sspec_tests.len()}</div>\n"
    html = "{html}    </div>\n"

    html = "{html}  </div>\n"

    # Alerts
    if alerts.len() > 0:
        html = "{html}  <h2>Alerts</h2>\n"
        for alert in alerts:
            val alert_class = match alert.level:
                "critical" => "alert-critical"
                "warning" => "alert-warning"
                _ => "alert-info"
            html = "{html}  <div class=\"alert {alert_class}\">\n"
            html = "{html}    <strong>[{alert.level.to_uppercase()}]</strong> {alert.message}\n"
            html = "{html}  </div>\n"

    # Trends
    match trends:
        Some(report) =>
            html = "{html}  <h2>Trends ({report.days} days)</h2>\n"
            html = "{html}  <table>\n"
            html = "{html}    <tr><th>Metric</th><th>Current</th><th>Change</th><th>Status</th></tr>\n"

            html = "{html}    <tr>\n"
            html = "{html}      <td>Coverage</td>\n"
            html = "{html}      <td>{report.coverage.current:.1f}%</td>\n"
            html = "{html}      <td>{report.coverage.change_percent:+.1f}%</td>\n"
            html = "{html}      <td class=\"trend-{get_trend_class(report.coverage.status)}\">{report.coverage.status}</td>\n"
            html = "{html}    </tr>\n"

            html = "{html}    <tr>\n"
            html = "{html}      <td>Features</td>\n"
            html = "{html}      <td>{report.features.current:.1f}%</td>\n"
            html = "{html}      <td>{report.features.change_percent:+.1f}%</td>\n"
            html = "{html}      <td class=\"trend-{get_trend_class(report.features.status)}\">{report.features.status}</td>\n"
            html = "{html}    </tr>\n"

            html = "{html}  </table>\n"
        None => pass

    # Footer
    html = "{html}  <div class=\"footer\">\n"
    html = "{html}    Generated by Simple Compiler Dashboard<br>\n"
    html = "{html}    Timestamp: {now_iso8601()}\n"
    html = "{html}  </div>\n"

    html = "{html}</div>\n</body>\n</html>"
    return html

# =========================================================================
# Markdown Export
# =========================================================================

fn export_markdown(data: DashboardData, trends: Option<TrendReport>, alerts: List<Alert>) -> text:
    var md = "# Dashboard Report\n\n"
    md = "{md}**Generated:** {data.timestamp}\n\n"

    # Overview
    md = "{md}## Overview\n\n"
    md = "{md}| Metric | Value |\n"
    md = "{md}|--------|-------|\n"
    md = "{md}| Features Complete | {data.completed_features()}/{data.total_features()} |\n"
    md = "{md}| Code Coverage | {data.overall_coverage():.1f}% |\n"
    md = "{md}| TODOs | {data.total_todos()} (P0: {data.critical_todos()}) |\n"
    md = "{md}| SSpec Tests | {data.sspec_tests.len()} |\n"
    md = "{md}\n"

    # Alerts
    if alerts.len() > 0:
        md = "{md}## Alerts\n\n"
        for alert in alerts:
            val emoji = match alert.level:
                "critical" => "ðŸ”´"
                "warning" => "âš ï¸"
                _ => "â„¹ï¸"
            md = "{md}{emoji} **[{alert.level.to_uppercase()}]** {alert.message}\n\n"

    # Trends
    match trends:
        Some(report) =>
            md = "{md}## Trends ({report.days} days)\n\n"
            md = "{md}| Metric | Current | Change | Status |\n"
            md = "{md}|--------|---------|--------|--------|\n"
            md = "{md}| Coverage | {report.coverage.current:.1f}% | {report.coverage.change_percent:+.1f}% | {report.coverage.status} |\n"
            md = "{md}| Features | {report.features.current:.1f}% | {report.features.change_percent:+.1f}% | {report.features.status} |\n"
            md = "{md}\n"
        None => pass

    return md

# =========================================================================
# JSON Export
# =========================================================================

fn export_json(data: DashboardData, trends: Option<TrendReport>, alerts: List<Alert>) -> text:
    var json = "{\n"
    json = "{json}  \"timestamp\": \"{data.timestamp}\",\n"
    json = "{json}  \"metrics\": {\n"
    json = "{json}    \"features_total\": {data.total_features()},\n"
    json = "{json}    \"features_complete\": {data.completed_features()},\n"
    json = "{json}    \"coverage_percent\": {data.overall_coverage()},\n"
    json = "{json}    \"todos_total\": {data.total_todos()},\n"
    json = "{json}    \"todos_critical\": {data.critical_todos()},\n"
    json = "{json}    \"sspec_tests\": {data.sspec_tests.len()}\n"
    json = "{json}  },\n"

    json = "{json}  \"alerts\": [\n"
    for i in 0..alerts.len():
        val a = alerts[i]
        json = "{json}    {\n"
        json = "{json}      \"level\": \"{a.level}\",\n"
        json = "{json}      \"metric\": \"{a.metric}\",\n"
        json = "{json}      \"message\": \"{escape_json(a.message)}\"\n"
        json = "{json}    }"
        if i < alerts.len() - 1:
            json = "{json},"
        json = "{json}\n"
    json = "{json}  ]\n"

    json = "{json}}"
    return json

# =========================================================================
# CSV Export
# =========================================================================

fn export_csv(data: DashboardData) -> text:
    var csv = "metric,value\n"
    csv = "{csv}features_total,{data.total_features()}\n"
    csv = "{csv}features_complete,{data.completed_features()}\n"
    csv = "{csv}coverage_percent,{data.overall_coverage()}\n"
    csv = "{csv}todos_total,{data.total_todos()}\n"
    csv = "{csv}todos_critical,{data.critical_todos()}\n"
    csv = "{csv}sspec_tests,{data.sspec_tests.len()}\n"
    return csv

# =========================================================================
# Helper Functions
# =========================================================================

fn get_trend_class(status: TrendStatus) -> text:
    match status:
        TrendStatus::Improving => "up"
        TrendStatus::Degrading => "down"
        _ => "stable"

fn escape_json(s: text) -> text:
    var result = s
    result = result.replace("\\", "\\\\")
    result = result.replace("\"", "\\\"")
    result = result.replace("\n", "\\n")
    return result

# =========================================================================
# Convenience Functions
# =========================================================================

fn export_html_report(data: DashboardData, trends: Option<TrendReport>, alerts: List<Alert>, filename: text) -> Result<(), text>:
    val exporter = DashboardExporter.new(ExportFormat::Html)
    return exporter.export_to_file(data, trends, alerts, filename)

fn export_markdown_report(data: DashboardData, trends: Option<TrendReport>, alerts: List<Alert>, filename: text) -> Result<(), text>:
    val exporter = DashboardExporter.new(ExportFormat::Markdown)
    return exporter.export_to_file(data, trends, alerts, filename)

fn export_json_report(data: DashboardData, trends: Option<TrendReport>, alerts: List<Alert>, filename: text) -> Result<(), text>:
    val exporter = DashboardExporter.new(ExportFormat::Json)
    return exporter.export_to_file(data, trends, alerts, filename)

# =========================================================================
# Exports
# =========================================================================

export ExportFormat, DashboardExporter
export export_html, export_markdown, export_json, export_csv
export export_html_report, export_markdown_report, export_json_report
export escape_json
