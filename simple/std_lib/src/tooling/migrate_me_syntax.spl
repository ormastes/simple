# Simple Language Syntax Migration Tool - fn/me syntax
# Migrated from: scripts/migrate_to_me_syntax.py
# Purpose: Migrate from old syntax to fn/me syntax

# TODO: [stdlib][P1] Add regex library to Simple
# TODO: [stdlib][P1] Add file I/O library to Simple
# TODO: [stdlib][P1] Add datetime library to Simple

# Migration statistics
struct MigrationStats:
    files_processed: u64
    files_modified: u64
    lines_changed: u64
    backup_dir: text

impl MigrationStats:
    # Create empty stats
    static fn new(backup_dir: text) -> MigrationStats:
        MigrationStats(
            files_processed: 0,
            files_modified: 0,
            lines_changed: 0,
            backup_dir: backup_dir
        )

    # Record processed file
    me add_processed():
        self.files_processed = self.files_processed + 1

    # Record modified file
    me add_modified(lines: u64):
        self.files_modified = self.files_modified + 1
        self.lines_changed = self.lines_changed + lines

    # Generate summary report
    fn summary() -> text:
        var report = ""
        report = report + "=== Migration Complete ===\n"
        report = report + "Files processed: {self.files_processed}\n"
        report = report + "Files modified: {self.files_modified}\n"
        report = report + "Lines changed: {self.lines_changed}\n"
        report = report + "Backups saved to: {self.backup_dir}\n"
        report

# File migration result
struct MigrationResult:
    modified: bool
    lines_changed: u64
    error: text

impl MigrationResult:
    # No changes made
    static fn unchanged() -> MigrationResult:
        MigrationResult(
            modified: false,
            lines_changed: 0,
            error: ""
        )

    # Changes made successfully
    static fn changed(lines: u64) -> MigrationResult:
        MigrationResult(
            modified: true,
            lines_changed: lines,
            error: ""
        )

    # Error occurred
    static fn error(message: text) -> MigrationResult:
        MigrationResult(
            modified: false,
            lines_changed: 0,
            error: message
        )

# TODO: [stdlib][P1] Add regex support
# Apply syntax transformations to content
fn migrate_content(content: text) -> text:
    # Stub: Needs regex for pattern replacements
    # Would apply these transformations:
    # 1. var fn method(self, ...) -> me method(self, ...)
    # 2. fn method(mut self, ...) -> me method(self, ...)
    # 3. Keep fn method(self, ...) as is (immutable methods)
    # 4. Keep static fn method() as is (static methods)

    # Regex patterns needed:
    # - r'^(\s*)var\s+fn\s+(\w+)\s*\(\s*self\s*\)(\s*(?:->)?)'
    # - r'^(\s*)var\s+fn\s+(\w+)\s*\(\s*self\s*,\s*'
    # - r'^(\s*)fn\s+(\w+)\s*\(\s*mut\s+self\s*\)(\s*(?:->)?)'
    # - r'^(\s*)fn\s+(\w+)\s*\(\s*mut\s+self\s*,\s*'

    content  # Return unchanged for now

# TODO: [stdlib][P1] Add file I/O and regex
# Migrate a single file
fn migrate_file(filepath: text, backup_dir: text) -> MigrationResult:
    # Stub: Needs file I/O and regex
    # Would:
    # 1. Read file content
    # 2. Apply migrate_content()
    # 3. If changed:
    #    - Backup original to backup_dir
    #    - Write migrated content
    #    - Count changed lines
    #    - Return MigrationResult.changed(count)
    # 4. Else return MigrationResult.unchanged()
    MigrationResult.error("file I/O not yet implemented")

# TODO: [stdlib][P1] Add directory operations
# Find all .spl files in directory
fn find_spl_files(root_dir: text) -> List<text>:
    # Stub: Needs glob/directory listing
    # Would:
    # 1. Glob for **/*.spl
    # 2. Skip target, .git, .migration_backup directories
    # 3. Return list of file paths
    []

# TODO: [stdlib][P1] Add file I/O and datetime
# Run migration on all .spl files
fn run_migration(root_dir: text) -> MigrationStats:
    # Stub: Needs file I/O, regex, directory ops, datetime
    # Would:
    # 1. Create backup directory with timestamp
    # 2. Find all .spl files
    # 3. Process each file
    # 4. Track statistics
    # 5. Return stats

    val backup_dir = ".migration_backup_me_stub"
    MigrationStats.new(backup_dir)

# Syntax transformation patterns (for documentation)
struct TransformPattern:
    name: text
    description: text
    before: text
    after: text

impl TransformPattern:
    # Create a transformation pattern
    static fn new(name: text, desc: text, before: text, after: text) -> TransformPattern:
        TransformPattern(
            name: name,
            description: desc,
            before: before,
            after: after
        )

# Get all transformation patterns
fn get_transform_patterns() -> List<TransformPattern>:
    [
        TransformPattern.new(
            "var_fn_to_me",
            "Convert var fn to me (mutable methods)",
            "var fn method(self) ->",
            "me method(self) ->"
        ),
        TransformPattern.new(
            "mut_self_to_me",
            "Convert fn with mut self to me",
            "fn method(mut self, x: i64) ->",
            "me method(self, x: i64) ->"
        ),
        TransformPattern.new(
            "keep_immutable",
            "Keep immutable methods as fn",
            "fn method(self) ->",
            "fn method(self) ->"
        ),
        TransformPattern.new(
            "keep_static",
            "Keep static methods unchanged",
            "static fn new() ->",
            "static fn new() ->"
        )
    ]

# Print transformation examples
fn print_examples() -> text:
    var output = ""
    output = output + "=== Syntax Migration Patterns ===\n\n"

    val patterns = get_transform_patterns()
    var i = 0
    while i < patterns.len():
        val pattern = patterns[i]
        output = output + "{i + 1}. {pattern.name}\n"
        output = output + "   {pattern.description}\n"
        output = output + "   Before: {pattern.before}\n"
        output = output + "   After:  {pattern.after}\n\n"
        i = i + 1

    output

# TODO: [stdlib][P1] Add CLI argument parsing
# Main entry point
fn main_migrate_me_syntax(args: List<text>) -> Result<(), text>:
    # Stub: Needs argument parsing and file I/O
    # Would handle:
    # --dry-run         Preview changes without writing
    # --backup-dir      Custom backup directory
    # <root_dir>        Directory to migrate (default: current)
    Err("CLI not yet implemented - use as library instead")
