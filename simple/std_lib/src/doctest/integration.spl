/// Integration with BDD Spec Framework
/// 
/// Hooks doctest discovery and execution into spec.runner

use parser::{DoctestExample}
use runner::{DoctestRunner, ExampleResult}
use discovery::{discover_all, DiscoveryConfig}
use reporter::{format_results, generate_summary, print_summary}

# TODO: Import from std.spec when available
# use std.spec.{Runner, Example, ExampleGroup}

/// Register doctests with spec runner
fn register_doctests(spec_runner: SpecRunner, config: DiscoveryConfig):
    examples = discover_all(config)
    
    # Group by source file
    by_source = group_by_source(examples)
    
    for (source, source_examples) in by_source:
        # Create synthetic describe block
        group = create_example_group(source, source_examples)
        spec_runner.register_group(group)

/// Group examples by source file
fn group_by_source(examples: List[DoctestExample]) -> Dict[String, List[DoctestExample]]:
    groups = Dict.new()
    for ex in examples:
        if ex.source not in groups:
            groups[ex.source] = []
        groups[ex.source].push(ex)
    return groups

/// Create synthetic example group for a source file
fn create_example_group(source: String, examples: List[DoctestExample]) -> ExampleGroup:
    group = ExampleGroup.new("Doctest: ${source}")
    
    for doctest_ex in examples:
        # Wrap doctest example as spec example
        spec_ex = create_spec_example(doctest_ex)
        group.add_example(spec_ex)
    
    return group

/// Convert doctest example to spec example
fn create_spec_example(doctest_ex: DoctestExample) -> Example:
    code_summary = doctest_ex.code.join(" ")
    description = ">>> ${code_summary}"
    
    # Create executable closure
    runner = DoctestRunner.new()
    executable = || {
        result = runner.run_example(doctest_ex)
        if not result.passed():
            match result.result:
                case MatchResult.Fail(msg):
                    raise AssertionError(msg)
    }
    
    return Example.new(description, executable)

# Placeholder types (will be replaced by std.spec)
struct SpecRunner:
    fn register_group(self, group: ExampleGroup): pass

struct ExampleGroup:
    fn new(description: String) -> ExampleGroup: pass
    fn add_example(self, example: Example): pass

struct Example:
    fn new(description: String, executable: fn() -> ()): pass
