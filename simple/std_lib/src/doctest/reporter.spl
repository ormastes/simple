/// Doctest Reporter
/// 
/// Formats and reports doctest results

use runner::{ExampleResult}
use matcher::{MatchResult}

/// Report summary of doctest run
struct DoctestReport:
    total: Int
    passed: Int
    failed: Int
    execution_time_ms: Int

    fn pass_rate() -> Float:
        if self.total == 0:
            return 0.0
        return (self.passed as Float) / (self.total as Float)

    # =========================================================================
    # Helper Methods
    # =========================================================================

    pub fn fail_rate(self) -> Float:
        """Calculate failure rate.

        Returns:
            Failure rate as fraction (0.0 to 1.0)

        Example:
            report.fail_rate()  # → 0.2
        """
        if self.total == 0:
            return 0.0
        return (self.failed as Float) / (self.total as Float)

    pub fn all_passed(self) -> Bool:
        """Check if all tests passed.

        Returns:
            true if no failures

        Example:
            report.all_passed()  # → true
        """
        return self.failed == 0

    pub fn has_failures(self) -> Bool:
        """Check if any tests failed.

        Returns:
            true if failures exist

        Example:
            report.has_failures()  # → false
        """
        return self.failed > 0

    pub fn is_empty(self) -> Bool:
        """Check if no tests were run.

        Returns:
            true if total is 0

        Example:
            report.is_empty()  # → false
        """
        return self.total == 0

    pub fn pass_percentage(self) -> Float:
        """Get pass rate as percentage.

        Returns:
            Pass rate as percentage (0.0 to 100.0)

        Example:
            report.pass_percentage()  # → 85.5
        """
        return self.pass_rate() * 100.0

    pub fn fail_percentage(self) -> Float:
        """Get fail rate as percentage.

        Returns:
            Fail rate as percentage (0.0 to 100.0)

        Example:
            report.fail_percentage()  # → 14.5
        """
        return self.fail_rate() * 100.0

    pub fn execution_time_seconds(self) -> Float:
        """Get execution time in seconds.

        Returns:
            Execution time in seconds

        Example:
            report.execution_time_seconds()  # → 1.523
        """
        return (self.execution_time_ms as Float) / 1000.0

    pub fn average_time_per_test(self) -> Float:
        """Get average time per test in milliseconds.

        Returns:
            Average execution time per test

        Example:
            report.average_time_per_test()  # → 12.5
        """
        if self.total == 0:
            return 0.0
        return (self.execution_time_ms as Float) / (self.total as Float)

    pub fn is_successful(self) -> Bool:
        """Check if test run was successful (all passed).

        Returns:
            true if all tests passed

        Example:
            report.is_successful()  # → true
        """
        return self.all_passed()

    pub fn failure_count(self) -> Int:
        """Get number of failures (alias for .failed).

        Returns:
            Number of failed tests

        Example:
            report.failure_count()  # → 3
        """
        return self.failed

    pub fn success_count(self) -> Int:
        """Get number of successes (alias for .passed).

        Returns:
            Number of passed tests

        Example:
            report.success_count()  # → 47
        """
        return self.passed

    pub fn summary(self) -> String:
        """Get human-readable summary.

        Returns:
            Summary string

        Example:
            report.summary()
            # → "DoctestReport: 50 total, 47 passed, 3 failed (94.0% pass rate, 1523ms)"
        """
        val pass_pct = (self.pass_rate() * 100.0).round()
        return "DoctestReport: {self.total} total, {self.passed} passed, {self.failed} failed ({pass_pct}% pass rate, {self.execution_time_ms}ms)"

/// Format results as human-readable output
fn format_results(results: List[ExampleResult]) -> String:
    output = []
    
    for result in results:
        location = result.example.location.to_string()
        status = if result.passed() then "✓" else "✗"
        code_summary = result.example.code.join("; ")
        
        line = "${location}: ${status} ${code_summary}"
        output.push(line)
        
        # Show failure details
        if not result.passed():
            match result.result:
                case MatchResult.Fail(msg):
                    output.push("  ${msg}")
    
    return output.join("\n")

/// Generate summary report
fn generate_summary(results: List[ExampleResult]) -> DoctestReport:
    total = results.len
    passed = results.filter(|r| r.passed()).len
    failed = total - passed
    total_time = results.map(|r| r.execution_time_ms).sum()
    
    return DoctestReport(
        total: total,
        passed: passed,
        failed: failed,
        execution_time_ms: total_time
    )

/// Print summary to console
fn print_summary(report: DoctestReport):
    print "Finished in ${report.execution_time_ms}ms"
    print "${report.total} examples, ${report.failed} failures"
    if report.failed == 0:
        print "All doctests passed! ✓"
    else:
        print "Pass rate: ${(report.pass_rate() * 100).round()}%"
