# Markdown Documentation Generator for BDD Specs
# Converts describe/context/it blocks into GitHub-compatible Markdown

use core.collections.{List, Dict}
use core.string.String

class MarkdownFormatter:
    output: String

    fn new() -> MarkdownFormatter:
        return MarkdownFormatter(output: String.empty())

    fn format_describe(self, name: String, level: i32) -> String:
        let prefix = "#" * (level + 1)
        return "{prefix} {name}\n\n"

    fn format_context(self, name: String, level: i32) -> String:
        let prefix = "#" * (level + 2)
        return "{prefix} {name}\n\n"

    fn format_example(self, name: String, status: String, error: Option<String>) -> String:
        let icon = match status:
            "pass" => "✅"
            "fail" => "❌"
            "skip" => "⏭️"
            _ => "❓"

        let mut result = "{icon} **{name}**\n\n"

        if let Some(err) = error:
            result = result + "```\nError: {err}\n```\n\n"

        return result

    fn format_code_block(self, code: String, language: String) -> String:
        return "```{language}\n{code}\n```\n\n"

# Convert spec results to Markdown documentation
fn format_spec_to_markdown(spec_results: Dict<String, Any>) -> String:
    let formatter = MarkdownFormatter.new()
    let mut output = String.empty()

    # Extract spec metadata
    let suite_name = spec_results.get("suite_name").unwrap_or("Test Suite")
    output = output + "# {suite_name}\n\n"

    # Add timestamp
    if let Some(timestamp) = spec_results.get("timestamp"):
        output = output + "*Generated: {timestamp}*\n\n"

    # Process describe blocks
    if let Some(describes) = spec_results.get("describe_blocks"):
        for describe in describes:
            output = output + formatter.format_describe(
                describe.get("description").unwrap_or(""),
                1
            )

            # Process contexts
            if let Some(contexts) = describe.get("contexts"):
                for context in contexts:
                    output = output + formatter.format_context(
                        context.get("description").unwrap_or(""),
                        2
                    )

                    # Process examples (it blocks)
                    if let Some(examples) = context.get("examples"):
                        for example in examples:
                            let status = example.get("status").unwrap_or("unknown")
                            let name = example.get("description").unwrap_or("")
                            let error = example.get("error")

                            output = output + formatter.format_example(name, status, error)

                            # Add code if available
                            if let Some(code) = example.get("code"):
                                output = output + formatter.format_code_block(code, "simple")

    # Add summary
    if let Some(summary) = spec_results.get("summary"):
        output = output + "\n---\n\n## Summary\n\n"
        let total = summary.get("total").unwrap_or(0)
        let passed = summary.get("passed").unwrap_or(0)
        let failed = summary.get("failed").unwrap_or(0)
        let skipped = summary.get("skipped").unwrap_or(0)

        output = output + "- **Total:** {total} tests\n"
        output = output + "- **Passed:** {passed} ✅\n"
        output = output + "- **Failed:** {failed} ❌\n"
        output = output + "- **Skipped:** {skipped} ⏭️\n"

    return output
