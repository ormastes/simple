# Expectations - expect/to/not_to DSL
# Provides fluent assertion interface

import matchers.{Matcher, MatchResult}

# Expectation target - wraps actual value
export class Expectation[T]:
    actual: T
    negated: Bool
    
    fn new(actual: T) -> Expectation[T]:
        return Expectation {
            actual: actual,
            negated: false
        }
    
    # Positive assertion: expect x to eq 5
    fn to(self, matcher: Matcher[T]) -> Void:
        result = matcher.match(self.actual)
        
        if self.negated:
            if result.matched:
                fail(result.failure_message)
        else:
            if not result.matched:
                fail(result.failure_message)
    
    # Negative assertion: expect x not_to eq 5
    fn not_to(self, matcher: Matcher[T]) -> Void:
        self.negated = true
        self.to(matcher)

# Main expect function
export fn expect[T](actual: T) -> Expectation[T]:
    return Expectation.new(actual)

# Block expectation for errors
export class BlockExpectation:
    block: Fn() -> Void
    
    fn new(block: Fn() -> Void) -> BlockExpectation:
        return BlockExpectation { block: block }
    
    fn to(self, matcher: Matcher[Any]) -> Void:
        # Execute block and capture result/error
        let error = None
        try:
            self.block()
        catch e:
            error = Some(e)
        
        # Pass error to matcher
        result = matcher.match(error)
        if not result.matched:
            fail(result.failure_message)

# expect_raises: Block form for error expectations
# Usage: expect_raises ValueError: do_something()
export fn expect_raises(error_type: Type, block: Fn() -> Void) -> Void:
    let raised = None
    try:
        block()
    catch e:
        raised = Some(e)
    
    match raised:
        case Some(e):
            if not e is error_type:
                fail("Expected ${error_type} but got ${e.type}")
        case None:
            fail("Expected ${error_type} to be raised but nothing was raised")

# Failure helper
fn fail(message: String) -> Void:
    panic("Expectation failed: ${message}")
