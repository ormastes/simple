# Feature Documentation Registry
# Global registry for feature metadata
# Stores all feature metadata for documentation generation

use core.collections.{List, Dict}
use core.string.String
use spec.feature_doc.metadata.FeatureMetadata

## Global feature registry
## Singleton that stores all registered features
class FeatureRegistry:
    features: Dict[Int, FeatureMetadata]  # Feature ID -> Metadata
    categories: Dict[String, List[Int]]    # Category -> Feature IDs

    fn new() -> FeatureRegistry:
        return FeatureRegistry(
            features: Dict.new(),
            categories: Dict.new()
        )

    ## Register a feature
    fn register(self, feature: FeatureMetadata):
        # Validate before registering
        let (valid, msg) = feature.validate()
        if not valid:
            raise ValueError(f"Invalid feature metadata: {msg}")

        # Check for duplicate ID
        if self.features.has_key(feature.id):
            raise ValueError(f"Feature ID #{feature.id} already registered")

        # Register feature
        self.features.set(feature.id, feature)

        # Add to category index
        if not self.categories.has_key(feature.category):
            self.categories.set(feature.category, List.new())

        self.categories.get(feature.category).unwrap().append(feature.id)

    ## Get feature by ID
    fn get(self, id: Int) -> Option[FeatureMetadata]:
        return self.features.get(id)

    ## Get all features in a category
    fn get_by_category(self, category: String) -> List[FeatureMetadata]:
        let result = List.new()

        if let Some(ids) = self.categories.get(category):
            for id in ids:
                if let Some(feature) = self.features.get(id):
                    result.append(feature)

        return result

    ## Get all features
    fn get_all(self) -> List[FeatureMetadata]:
        return self.features.values().to_list()

    ## Get all categories
    fn get_categories(self) -> List[String]:
        return self.categories.keys().to_list()

    ## Get feature count
    fn count(self) -> Int:
        return self.features.len()

    ## Get feature count by category
    fn count_by_category(self, category: String) -> Int:
        if let Some(ids) = self.categories.get(category):
            return ids.len()
        return 0

    ## Clear all features (for testing)
    fn clear(self):
        self.features.clear()
        self.categories.clear()

## Global singleton instance
let mut _global_registry: Option[FeatureRegistry] = None

## Get the global registry (lazy initialization)
fn get_global_registry() -> FeatureRegistry:
    if _global_registry.is_none():
        _global_registry = Some(FeatureRegistry.new())

    return _global_registry.unwrap()

## Register a feature in the global registry
fn register_feature(feature: FeatureMetadata):
    get_global_registry().register(feature)

## Get a feature from the global registry
fn get_feature(id: Int) -> Option[FeatureMetadata]:
    return get_global_registry().get(id)

## Get all features in a category
fn get_features_by_category(category: String) -> List[FeatureMetadata]:
    return get_global_registry().get_by_category(category)

## Get all features
fn get_all_features() -> List[FeatureMetadata]:
    return get_global_registry().get_all()

## Get all categories
fn get_all_categories() -> List[String]:
    return get_global_registry().get_categories()

## Clear the global registry (for testing)
fn clear_feature_registry():
    get_global_registry().clear()
