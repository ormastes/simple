# Feature Documentation Index Generator
# Generates __index__.md files for categories and master feature.md

use core.collections.{List, Dict}
use core.string.String
use core.time.Timestamp
use core.io.File
use spec.feature_doc.metadata.FeatureMetadata
use spec.feature_doc.registry.{
    get_all_features,
    get_all_categories,
    get_features_by_category
}

## Generate category index file (__index__.md)
fn generate_category_index(category: String) -> String:
    let features = get_features_by_category(category)
    let mut output = String.empty()

    # Header
    output = output + f"# {category} Features\n\n"

    # Summary
    let total = features.len()
    let completed = features.filter(\f: f.status.starts_with("âœ…")).len()
    let in_progress = features.filter(\f: f.status.starts_with("ğŸ”„")).len()
    let planned = features.filter(\f: f.status.starts_with("ğŸ“‹")).len()

    output = output + "## Summary\n\n"
    output = output + f"- **Total Features:** {total}\n"
    output = output + f"- **Completed:** {completed} âœ…\n"
    output = output + f"- **In Progress:** {in_progress} ğŸ”„\n"
    output = output + f"- **Planned:** {planned} ğŸ“‹\n"
    output = output + "\n"

    # Feature list table
    output = output + "## Features\n\n"
    output = output + "| ID | Name | Difficulty | Status |\n"
    output = output + "|----|------|------------|--------|\n"

    # Sort features by ID
    features.sort_by(\a, b: a.id < b.id)

    for feature in features:
        let link = f"[#{feature.id}]({feature.filename()})"
        output = output + f"| {link} | {feature.name} | {feature.difficulty} | {feature.status} |\n"

    output = output + "\n"

    # Footer
    let timestamp = Timestamp.now().format("%Y-%m-%d %H:%M:%S")
    output = output + f"---\n\n**Generated:** {timestamp}\n"

    return output

## Write category index file
fn write_category_index(category: String):
    let index = generate_category_index(category)
    let dir_path = f"doc/features/{category.to_lowercase()}"
    let file_path = f"{dir_path}/__index__.md"

    File.write(file_path, index)

## Write all category index files
fn write_all_category_indexes():
    let categories = get_all_categories()

    for category in categories:
        write_category_index(category)

## Generate master feature.md file
fn generate_master_index() -> String:
    let features = get_all_features()
    let categories = get_all_categories()
    let mut output = String.empty()

    # Header
    output = output + "# Simple Language Feature Documentation\n\n"

    # Overall statistics
    let total = features.len()
    let completed = features.filter(\f: f.status.starts_with("âœ…")).len()
    let in_progress = features.filter(\f: f.status.starts_with("ğŸ”„")).len()
    let planned = features.filter(\f: f.status.starts_with("ğŸ“‹")).len()
    let completion_pct = (completed * 100) / total

    output = output + "## Overview\n\n"
    output = output + f"- **Total Features:** {total}\n"
    output = output + f"- **Completed:** {completed} ({completion_pct}%) âœ…\n"
    output = output + f"- **In Progress:** {in_progress} ğŸ”„\n"
    output = output + f"- **Planned:** {planned} ğŸ“‹\n"
    output = output + "\n"

    # Category breakdown
    output = output + "## Features by Category\n\n"
    output = output + "| Category | Total | Completed | In Progress | Planned |\n"
    output = output + "|----------|-------|-----------|-------------|----------|\n"

    # Sort categories alphabetically
    categories.sort()

    for category in categories:
        let cat_features = get_features_by_category(category)
        let cat_total = cat_features.len()
        let cat_completed = cat_features.filter(\f: f.status.starts_with("âœ…")).len()
        let cat_in_progress = cat_features.filter(\f: f.status.starts_with("ğŸ”„")).len()
        let cat_planned = cat_features.filter(\f: f.status.starts_with("ğŸ“‹")).len()

        let link = f"[{category}]({category.to_lowercase()}/__index__.md)"
        output = output + f"| {link} | {cat_total} | {cat_completed} | {cat_in_progress} | {cat_planned} |\n"

    output = output + "\n"

    # Navigation
    output = output + "## Navigation\n\n"
    output = output + "- [Directory Structure](__index__.md)\n"
    output = output + "- [Feature Status](FEATURE_STATUS.md)\n"
    output = output + "\n"

    for category in categories:
        let link = f"[{category}]({category.to_lowercase()}/__index__.md)"
        output = output + f"- {link}\n"

    output = output + "\n"

    # Footer
    let timestamp = Timestamp.now().format("%Y-%m-%d %H:%M:%S")
    output = output + f"---\n\n**Generated:** {timestamp}\n"

    return output

## Write master feature.md file
fn write_master_index():
    let index = generate_master_index()
    File.write("doc/features/feature.md", index)

## Generate all index files (category + master)
fn generate_all_indexes():
    write_all_category_indexes()
    write_master_index()
