# Bootstrap Test - Minimal Self-Hosting Compiler Test
#
# This tests the Cranelift FFI infrastructure by creating a simple
# function and executing it via JIT.

# FFI declarations for Cranelift (RuntimeValue versions)
extern fn rt_cranelift_module_new(name: text, target: i64) -> i64
extern fn rt_cranelift_finalize_module(module: i64) -> i64
extern fn rt_cranelift_free_module(module: i64)
extern fn rt_cranelift_new_signature(call_conv: i64) -> i64
extern fn rt_cranelift_sig_set_return(sig: i64, type_: i64)

# Bootstrap test FFI
extern fn rt_exec(cmd: text) -> i32
extern fn rt_file_hash(path: text) -> text

fn test_create_module() -> bool:
    # Type constants
    val CL_TYPE_I64 = 4
    val CL_TARGET_X86_64 = 0

    # Test module creation with RuntimeValue name
    val module = rt_cranelift_module_new("test_module", CL_TARGET_X86_64)

    if module == 0:
        print "ERROR: Failed to create module"
        return false

    print "OK: Created module with handle {module}"

    # Test signature creation
    val sig = rt_cranelift_new_signature(0)  # SystemV calling convention
    if sig == 0:
        print "ERROR: Failed to create signature"
        rt_cranelift_free_module(module)
        return false

    print "OK: Created signature with handle {sig}"

    # Set return type to i64
    rt_cranelift_sig_set_return(sig, CL_TYPE_I64)
    print "OK: Set signature return type"

    # Cleanup
    rt_cranelift_free_module(module)
    print "OK: Freed module"

    true

fn test_exec_ffi() -> bool:
    # Test rt_exec FFI
    val result = rt_exec("echo 'Hello from rt_exec'")
    print "rt_exec returned: {result}"
    result == 0

fn test_file_hash_ffi() -> bool:
    # Test rt_file_hash FFI
    val hash = rt_file_hash("/bin/sh")
    print "Hash of /bin/sh: {hash}"
    hash.len() > 0

fn main() -> i32:
    print "=== Bootstrap FFI Test ==="
    print ""

    var passed = 0
    var failed = 0

    print "Test 1: Create module..."
    if test_create_module():
        passed = passed + 1
    else:
        failed = failed + 1

    print ""
    print "Test 2: rt_exec FFI..."
    if test_exec_ffi():
        passed = passed + 1
    else:
        failed = failed + 1

    print ""
    print "Test 3: rt_file_hash FFI..."
    if test_file_hash_ffi():
        passed = passed + 1
    else:
        failed = failed + 1

    print ""
    print "=== Results: {passed} passed, {failed} failed ==="

    if failed > 0:
        return 1
    0
