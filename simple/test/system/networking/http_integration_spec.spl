# HTTP Integration Tests
"""
## System Test: HTTP Request Workflows

**Integration Scope:** HTTP + JSON + Network I/O
**Complexity:** Medium-High
**Coverage Impact:** net_http.rs (0%â†’60%), HTTP client

Tests end-to-end HTTP workflows: GET/POST requests, JSON handling,
error codes, headers, and REST API integration.
"""

import std.spec
import net.http as http
import data.json as json

describe "HTTP request workflows":
    """
    ### GET Requests

    Basic HTTP GET request handling.
    Exercises: http.get, response status, body parsing.
    """

    context "GET requests":
        it "makes simple GET request":
            val response = await http.get("https://httpbin.org/get")

            expect(response.status).to(eq(200))
            expect(response.ok()).to(be_true())

        it "parses JSON response":
            val response = await http.get("https://httpbin.org/json")

            val data = json.parse(response.body)
            expect(data).to(have_key("slideshow"))

        it "handles query parameters":
            val url = "https://httpbin.org/get?name=test&value=123"
            val response = await http.get(url)

            expect(response.status).to(eq(200))

            val data = json.parse(response.body)
            expect(data["args"]["name"]).to(eq("test"))
            expect(data["args"]["value"]).to(eq("123"))

        it "follows redirects":
            val response = await http.get("https://httpbin.org/redirect/2")

            # Should follow redirects and succeed
            expect(response.status).to(eq(200))

        it "gets response headers":
            val response = await http.get("https://httpbin.org/get")

            val content_type = response.headers["Content-Type"]
            expect(content_type).to(include("application/json"))

    """
    ### POST Requests

    HTTP POST with data submission.
    Exercises: http.post, request body, JSON encoding.
    """

    context "POST requests":
        it "posts JSON data":
            val payload = {
                "name": "Alice",
                "age": 30
            }

            val response = await http.post(
                "https://httpbin.org/post",
                body: json.stringify(payload),
                headers: {"Content-Type": "application/json"}
            )

            expect(response.status).to(eq(200))

            val data = json.parse(response.body)
            expect(data["json"]["name"]).to(eq("Alice"))

        it "posts form data":
            val form_data = {
                "username": "bob",
                "password": "secret123"
            }

            val response = await http.post_form("https://httpbin.org/post", form_data)

            expect(response.status).to(eq(200))

        it "posts with custom headers":
            val headers = {
                "Content-Type": "application/json",
                "X-Custom-Header": "test-value"
            }

            val response = await http.post(
                "https://httpbin.org/post",
                body: "{}",
                headers: headers
            )

            val data = json.parse(response.body)
            expect(data["headers"]["X-Custom-Header"]).to(eq("test-value"))

    """
    ### REST API Integration

    Interact with REST APIs.
    Exercises: GET, POST, PUT, DELETE, status codes.
    """

    context "REST API integration":
        it "retrieves resource with GET":
            val response = await http.get("https://jsonplaceholder.typicode.com/posts/1")

            expect(response.status).to(eq(200))

            val post = json.parse(response.body)
            expect(post["id"]).to(eq(1))
            expect(post).to(have_key("title"))
            expect(post).to(have_key("body"))

        it "creates resource with POST":
            val new_post = {
                "title": "Test Post",
                "body": "This is a test",
                "userId": 1
            }

            val response = await http.post(
                "https://jsonplaceholder.typicode.com/posts",
                body: json.stringify(new_post),
                headers: {"Content-Type": "application/json"}
            )

            expect(response.status).to(eq(201))  # Created

            val created = json.parse(response.body)
            expect(created["title"]).to(eq("Test Post"))

        it "updates resource with PUT":
            val updated_post = {
                "id": 1,
                "title": "Updated Title",
                "body": "Updated body",
                "userId": 1
            }

            val response = await http.put(
                "https://jsonplaceholder.typicode.com/posts/1",
                body: json.stringify(updated_post),
                headers: {"Content-Type": "application/json"}
            )

            expect(response.status).to(eq(200))

        it "deletes resource with DELETE":
            val response = await http.delete("https://jsonplaceholder.typicode.com/posts/1")

            expect(response.status).to(eq(200))

        it "lists multiple resources":
            val response = await http.get("https://jsonplaceholder.typicode.com/posts?userId=1")

            expect(response.status).to(eq(200))

            val posts = json.parse(response.body)
            expect(posts).to(be_an(Array))
            expect(posts.len()).to(be_greater_than(0))

    """
    ### Error Handling

    Handle HTTP errors gracefully.
    Exercises: 4xx, 5xx errors, error detection.
    """

    context "Error handling":
        it "handles 404 not found":
            val response = await http.get("https://httpbin.org/status/404")

            expect(response.status).to(eq(404))
            expect(response.ok()).to(be_false())
            expect(response.is_client_error()).to(be_true())

        it "handles 500 server error":
            val response = await http.get("https://httpbin.org/status/500")

            expect(response.status).to(eq(500))
            expect(response.is_server_error()).to(be_true())

        it "handles 401 unauthorized":
            val response = await http.get("https://httpbin.org/status/401")

            expect(response.status).to(eq(401))
            expect(response.is_client_error()).to(be_true())

        it "handles timeout":
            val response = await http.get_with_timeout(
                "https://httpbin.org/delay/10",
                timeout_ms: 100
            )

            expect(response.is_error()).to(be_true())
            expect(response.error_type).to(eq("timeout"))

        it "handles network error":
            val response = await http.try_get("https://invalid.domain.that.does.not.exist")

            expect(response.is_error()).to(be_true())

    """
    ### Authentication

    HTTP authentication methods.
    Exercises: Basic auth, bearer tokens, headers.
    """

    context "Authentication":
        it "sends basic authentication":
            val response = await http.get_with_auth(
                "https://httpbin.org/basic-auth/user/passwd",
                username: "user",
                password: "passwd"
            )

            expect(response.status).to(eq(200))

        it "sends bearer token":
            val headers = {
                "Authorization": "Bearer test-token-123"
            }

            val response = await http.get(
                "https://httpbin.org/bearer",
                headers: headers
            )

            # httpbin requires valid token, but tests header sending
            expect(response).not_to(be_nil())

        it "handles authentication failure":
            val response = await http.get_with_auth(
                "https://httpbin.org/basic-auth/user/passwd",
                username: "wrong",
                password: "wrong"
            )

            expect(response.status).to(eq(401))

    """
    ### Response Processing

    Parse and process HTTP responses.
    Exercises: JSON parsing, text content, binary data.
    """

    context "Response processing":
        it "parses JSON response body":
            val response = await http.get("https://httpbin.org/json")

            val data = response.json()
            expect(data).to(be_a(Object))

        it "gets response as text":
            val response = await http.get("https://httpbin.org/html")

            val text = response.text()
            expect(text).to(include("<html>"))

        it "gets response headers":
            val response = await http.get("https://httpbin.org/response-headers?X-Test=value")

            expect(response.headers).to(have_key("X-Test"))
            expect(response.headers["X-Test"]).to(eq("value"))

        it "checks content type":
            val response = await http.get("https://httpbin.org/json")

            val content_type = response.content_type()
            expect(content_type).to(include("application/json"))

        it "gets response size":
            val response = await http.get("https://httpbin.org/bytes/1024")

            val size = response.content_length()
            expect(size).to(eq(1024))

    """
    ### Advanced Features

    Advanced HTTP features.
    Exercises: cookies, redirects, custom configuration.
    """

    context "Advanced features":
        it "handles cookies":
            val response = await http.get("https://httpbin.org/cookies/set?session=abc123")

            # Should receive Set-Cookie header
            expect(response.headers).to(have_key("Set-Cookie"))

        it "sends cookies with request":
            val cookies = {
                "session": "abc123"
            }

            val response = await http.get_with_cookies(
                "https://httpbin.org/cookies",
                cookies: cookies
            )

            val data = json.parse(response.body)
            expect(data["cookies"]["session"]).to(eq("abc123"))

        it "disables redirect following":
            val response = await http.get_no_redirect("https://httpbin.org/redirect/1")

            expect(response.status).to(eq(302))
            expect(response.headers).to(have_key("Location"))

        it "sets custom user agent":
            val headers = {
                "User-Agent": "SimpleLanguage/1.0"
            }

            val response = await http.get(
                "https://httpbin.org/user-agent",
                headers: headers
            )

            val data = json.parse(response.body)
            expect(data["user-agent"]).to(eq("SimpleLanguage/1.0"))

    """
    ### Performance

    HTTP performance characteristics.
    """

    context "Performance":
        it "makes multiple sequential requests":
            for i in 0..5:
                val response = await http.get("https://httpbin.org/get")
                expect(response.status).to(eq(200))

        it "handles concurrent requests":
            val tasks = []

            for i in 0..3:
                val task = runtime.spawn(async:
                    await http.get("https://httpbin.org/get")
                )
                tasks.append(task)

            for task in tasks:
                val response = await task
                expect(response.status).to(eq(200))

        it "reuses connections efficiently":
            val client = http.Client.new()

            for i in 0..5:
                val response = await client.get("https://httpbin.org/get")
                expect(response.status).to(eq(200))

            client.close()
