# Godot Audio and Scene Management Demo
#
# Demonstrates:
# - Audio playback (background music, sound effects)
# - Spatial audio (2D positional sounds)
# - Scene loading and switching
# - Scene preloading and caching
# - Volume control and audio buses
#
# Usage in Godot:
# 1. Build Simple GDExtension library
# 2. Create a Node scene
# 3. Attach this script
# 4. Add AudioStreamPlayer children
# 5. Prepare scene files (main_menu.tscn, game.tscn, etc.)

import godot.node
import godot.audio
import godot.scene
import godot.input
import godot.signal
import godot.variant

class GameAudioManager extends godot.node.Node:
    # Audio players (set in _ready)
    music_player: Option[godot.audio.AudioStreamPlayer] = None
    sfx_player: Option[godot.audio.AudioStreamPlayer] = None
    spatial_player: Option[godot.audio.AudioStreamPlayer2D] = None

    # Audio server
    audio_server: godot.audio.AudioServer

    # Volume settings (0.0 to 1.0)
    music_volume: f32 = 0.7
    sfx_volume: f32 = 1.0

    # Scene manager
    scene_manager: godot.scene.SceneManager

    # State
    current_music: String = ""
    is_music_fading: bool = false

    pub fn _ready(mut self):
        println("Audio Manager ready!")

        # Get audio server
        self.audio_server = godot.audio.AudioServer::get_singleton()

        # Setup audio players from children
        let base_node = self.base.as_node()
        
        # Get music player (child 0)
        let music_node = base_node.get_child(0)
        if music_node.is_some():
            self.music_player = Some(godot.audio.AudioStreamPlayer::from_ptr(music_node.unwrap().ptr()))
            self.music_player.unwrap().set_bus("Music")
            self.music_player.unwrap().set_volume_db(godot.audio.linear_to_db(self.music_volume))

        # Get SFX player (child 1)
        let sfx_node = base_node.get_child(1)
        if sfx_node.is_some():
            self.sfx_player = Some(godot.audio.AudioStreamPlayer::from_ptr(sfx_node.unwrap().ptr()))
            self.sfx_player.unwrap().set_bus("SFX")
            self.sfx_player.unwrap().set_volume_db(godot.audio.linear_to_db(self.sfx_volume))

        # Get spatial player (child 2)
        let spatial_node = base_node.get_child(2)
        if spatial_node.is_some():
            self.spatial_player = Some(godot.audio.AudioStreamPlayer2D::from_ptr(spatial_node.unwrap().ptr()))
            self.spatial_player.unwrap().set_max_distance(500.0)
            self.spatial_player.unwrap().set_attenuation(1.5)

        # Initialize scene manager
        self.scene_manager = godot.scene.SceneManager::new()

        # Preload common scenes
        self.preload_scenes()

        println(f"Audio setup complete. Music: {self.music_volume}, SFX: {self.sfx_volume}")

    # Preload common scenes in background
    fn preload_scenes(mut self):
        println("Preloading scenes...")

        # Preload main menu
        let menu_result = self.scene_manager.preload_scene("res://scenes/main_menu.tscn")
        if menu_result.is_err():
            println(f"Warning: Could not preload main menu: {menu_result.unwrap_err()}")

        # Preload game scene
        let game_result = self.scene_manager.preload_scene("res://scenes/game.tscn")
        if game_result.is_err():
            println(f"Warning: Could not preload game: {game_result.unwrap_err()}")

        println(f"Preloaded {self.scene_manager.get_cache_size()} scenes")

    # Play background music
    pub fn play_music(mut self, music_path: String, fade_in: bool = true):
        if self.music_player.is_none():
            return

        let player = self.music_player.unwrap()

        # Stop current music
        if player.is_playing():
            if fade_in:
                self.fade_out_music()
            else:
                player.stop()

        # Load new music
        let loader = godot.resource.ResourceLoader::get_singleton()
        let music_result = loader.load(music_path)

        if music_result.is_ok():
            let music_stream = music_result.unwrap()
            player.set_stream(music_stream)
            
            if fade_in:
                # Start at low volume and fade in
                player.set_volume_db(-20.0)
                player.play()
                self.fade_in_music()
            else:
                player.play()

            self.current_music = music_path
            println(f"Playing music: {music_path}")
        else:
            println(f"Error loading music: {music_result.unwrap_err()}")

    # Fade in music (gradual volume increase)
    fn fade_in_music(mut self):
        # TODO: Implement tween/animation for smooth fade
        if self.music_player.is_some():
            let player = self.music_player.unwrap()
            let target_db = godot.audio.linear_to_db(self.music_volume)
            player.set_volume_db(target_db)

    # Fade out music (gradual volume decrease)
    fn fade_out_music(mut self):
        # TODO: Implement tween/animation for smooth fade
        if self.music_player.is_some():
            let player = self.music_player.unwrap()
            player.set_volume_db(-80.0)
            player.stop()

    # Play sound effect
    pub fn play_sfx(mut self, sfx_path: String, pitch: f32 = 1.0):
        if self.sfx_player.is_none():
            return

        let player = self.sfx_player.unwrap()

        # Load sound effect
        let loader = godot.resource.ResourceLoader::get_singleton()
        let sfx_result = loader.load(sfx_path)

        if sfx_result.is_ok():
            let sfx_stream = sfx_result.unwrap()
            player.set_stream(sfx_stream)
            player.set_pitch_scale(pitch)
            player.play()

            println(f"Playing SFX: {sfx_path} (pitch: {pitch})")
        else:
            println(f"Error loading SFX: {sfx_result.unwrap_err()}")

    # Play spatial sound at position
    pub fn play_spatial_sfx(mut self, sfx_path: String, x: f64, y: f64):
        if self.spatial_player.is_none():
            return

        let player = self.spatial_player.unwrap()

        # Set position
        player.base.set_position(x, y)

        # Load and play
        let loader = godot.resource.ResourceLoader::get_singleton()
        let sfx_result = loader.load(sfx_path)

        if sfx_result.is_ok():
            let sfx_stream = sfx_result.unwrap()
            player.set_stream(sfx_stream)
            player.play()

            println(f"Playing spatial SFX at ({x}, {y}): {sfx_path}")
        else:
            println(f"Error loading spatial SFX: {sfx_result.unwrap_err()}")

    # Set master volume
    pub fn set_music_volume(mut self, volume: f32):
        self.music_volume = clamp(volume, 0.0, 1.0)
        
        # Update music bus
        let music_bus_idx = self.audio_server.get_bus_index("Music")
        let db = godot.audio.linear_to_db(self.music_volume)
        self.audio_server.set_bus_volume_db(music_bus_idx, db)

        println(f"Music volume: {self.music_volume} ({db} dB)")

    pub fn set_sfx_volume(mut self, volume: f32):
        self.sfx_volume = clamp(volume, 0.0, 1.0)
        
        # Update SFX bus
        let sfx_bus_idx = self.audio_server.get_bus_index("SFX")
        let db = godot.audio.linear_to_db(self.sfx_volume)
        self.audio_server.set_bus_volume_db(sfx_bus_idx, db)

        println(f"SFX volume: {self.sfx_volume} ({db} dB)")

    # Mute/unmute all audio
    pub fn set_muted(mut self, muted: bool):
        let master_idx = self.audio_server.get_bus_index("Master")
        self.audio_server.set_bus_mute(master_idx, muted)

        if muted:
            println("Audio muted")
        else:
            println("Audio unmuted")

    # Switch to a different scene
    pub fn change_scene(mut self, scene_path: String):
        println(f"Changing to scene: {scene_path}")

        # Fade out music during transition
        self.fade_out_music()

        # Change scene (uses cache if preloaded)
        let result = self.scene_manager.change_to_scene(scene_path)

        if result.is_err():
            println(f"Error changing scene: {result.unwrap_err()}")

    # Called every frame
    pub fn _process(mut self, delta: f64):
        # Check for volume control input (demonstration)
        let input = godot.input.Input::get_singleton()

        # Music volume: Up/Down arrows
        if input.is_key_pressed(godot.input.KeyCode::Up):
            self.set_music_volume(self.music_volume + 0.01)
        
        if input.is_key_pressed(godot.input.KeyCode::Down):
            self.set_music_volume(self.music_volume - 0.01)

        # SFX test: Space key
        if input.is_action_just_pressed("ui_accept"):  # Space
            self.play_sfx("res://sounds/click.wav", 1.0)

        # Mute toggle: M key
        if input.is_key_pressed(godot.input.KeyCode::M):
            let master_idx = self.audio_server.get_bus_index("Master")
            let is_muted = self.audio_server.is_bus_mute(master_idx)
            self.set_muted(not is_muted)


# Helper functions
fn clamp(value: f32, min_val: f32, max_val: f32) -> f32:
    if value < min_val:
        return min_val
    if value > max_val:
        return max_val
    return value


# Main entry point
fn main():
    println("Godot Audio and Scene Management Demo")
    println("")
    println("Features demonstrated:")
    println("- Background music playback")
    println("- Sound effects (2D and spatial)")
    println("- Volume control (linear to dB conversion)")
    println("- Audio buses (Music, SFX, Master)")
    println("- Scene loading and switching")
    println("- Scene preloading and caching")
    println("")
    println("Controls:")
    println("- Up/Down arrows: Adjust music volume")
    println("- Space: Play sound effect")
    println("- M: Toggle mute")
    println("")
    println("Attach to a Node in Godot with AudioStreamPlayer children!")
