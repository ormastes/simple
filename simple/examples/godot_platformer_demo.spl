# Godot Platformer Demo
#
# Complete 2D platformer controller demonstrating:
# - Input handling (keyboard)
# - Physics (CharacterBody2D)
# - Sprites and animation
# - Collision detection
# - Camera following
#
# Usage in Godot:
# 1. Build Simple GDExtension library
# 2. Create a CharacterBody2D node
# 3. Attach this script
# 4. Add CollisionShape2D child
# 5. Add Sprite2D child
# 6. Add Camera2D child

import godot.node2d
import godot.physics
import godot.input
import godot.rendering
import godot.signal
import godot.variant

class PlatformerPlayer extends godot.physics.CharacterBody2D:
    # Movement properties
    speed: f64 = 300.0
    jump_velocity: f64 = -400.0
    gravity: f64 = 980.0

    # State
    health: i32 = 100
    coins: i32 = 0
    is_jumping: bool = false

    # Child nodes (set in _ready)
    sprite: Option[godot.rendering.Sprite2D] = None
    camera: Option[godot.rendering.Camera2D] = None

    # Called when node enters scene
    pub fn _ready(mut self):
        println("Platformer player ready!")

        # Get child nodes
        let sprite_node = self.base.as_node().get_child(0)
        if sprite_node.is_some():
            self.sprite = Some(godot.rendering.Sprite2D::from_ptr(sprite_node.unwrap().ptr()))

        let camera_node = self.base.as_node().get_child(1)
        if camera_node.is_some():
            self.camera = Some(godot.rendering.Camera2D::from_ptr(camera_node.unwrap().ptr()))
            self.camera.unwrap().make_current()
            self.camera.unwrap().set_position_smoothing_enabled(true)
            self.camera.unwrap().set_position_smoothing_speed(5.0)

        # Setup signals
        let health_signal = godot.signal.Signal::new(
            self.base.as_node().as_object(),
            "health_changed"
        )

        println(f"Player initialized with {self.health} health")

    # Called every physics frame (60 FPS)
    pub fn _physics_process(mut self, delta: f64):
        # Get input singleton
        let input = godot.input.Input::get_singleton()

        # Get current velocity
        let (mut vx, mut vy) = self.get_velocity()

        # Apply gravity if not on floor
        if not self.is_on_floor():
            vy += self.gravity * delta
        else:
            self.is_jumping = false

        # Jump
        if input.is_action_just_pressed("jump") and self.is_on_floor():
            vy = self.jump_velocity
            self.is_jumping = true
            println("Jump!")

        # Horizontal movement
        let mut direction: f64 = 0.0
        if input.is_action_pressed("move_right"):
            direction += 1.0
        if input.is_action_pressed("move_left"):
            direction -= 1.0

        # Update horizontal velocity
        if direction != 0.0:
            vx = direction * self.speed
            
            # Flip sprite based on direction
            if self.sprite.is_some():
                self.sprite.unwrap().set_flip_h(direction < 0.0)
        else:
            # Decelerate when no input
            vx = lerp(vx, 0.0, 10.0 * delta)

        # Update velocity
        self.set_velocity(vx, vy)

        # Move and handle collisions
        self.move_and_slide()

        # Check if fell off world
        let (_, y) = self.base.get_position()
        if y > 1000.0:
            self.respawn()

    # Respawn at start position
    fn respawn(mut self):
        self.base.set_position(0.0, 0.0)
        self.set_velocity(0.0, 0.0)
        self.take_damage(10)
        println("Respawned!")

    # Take damage
    pub fn take_damage(mut self, amount: i32):
        self.health -= amount
        println(f"Took {amount} damage! Health: {self.health}")

        # Emit health changed signal
        let health_signal = godot.signal.Signal::new(
            self.base.as_node().as_object(),
            "health_changed"
        )
        let health_var = godot.variant.Variant::from_int(self.health as i64)
        health_signal.emit1(health_var)

        # Flash sprite red
        if self.sprite.is_some():
            self.sprite.unwrap().set_modulate(1.0, 0.3, 0.3, 1.0)
            # TODO: Timer to reset color after 0.2s

        # Check death
        if self.health <= 0:
            self.die()

    # Heal player
    pub fn heal(mut self, amount: i32):
        self.health = min(self.health + amount, 100)
        println(f"Healed {amount}! Health: {self.health}")

        # Emit signal
        let health_signal = godot.signal.Signal::new(
            self.base.as_node().as_object(),
            "health_changed"
        )
        let health_var = godot.variant.Variant::from_int(self.health as i64)
        health_signal.emit1(health_var)

    # Collect coin
    pub fn collect_coin(mut self):
        self.coins += 1
        println(f"Collected coin! Total: {self.coins}")

        # Emit signal
        let coin_signal = godot.signal.Signal::new(
            self.base.as_node().as_object(),
            "coin_collected"
        )
        let count_var = godot.variant.Variant::from_int(self.coins as i64)
        coin_signal.emit1(count_var)

    # Die
    fn die(mut self):
        println("Player died!")
        self.health = 100
        self.coins = 0
        self.respawn()

    # Collision callback (from Area2D or other bodies)
    pub fn _on_body_entered(mut self, body: godot.node.Node):
        let body_name = body.get_name()
        println(f"Collided with: {body_name}")

        # Check object type
        if body_name.starts_with("Enemy"):
            self.take_damage(20)
        elif body_name.starts_with("Coin"):
            self.collect_coin()
            body.queue_free()  # Remove coin
        elif body_name.starts_with("Health"):
            self.heal(25)
            body.queue_free()

# Helper function
fn lerp(a: f64, b: f64, t: f64) -> f64:
    return a + (b - a) * t

fn min(a: i32, b: i32) -> i32:
    if a < b:
        return a
    return b

# Main entry point
fn main():
    println("Godot Platformer Demo")
    println("This demonstrates:")
    println("- Character physics (CharacterBody2D)")
    println("- Input handling (WASD movement, Space jump)")
    println("- Collision detection")
    println("- Signal emission (health_changed, coin_collected)")
    println("- Camera following")
    println("")
    println("Attach to a CharacterBody2D in Godot to use!")
