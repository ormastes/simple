#!/usr/bin/env simple
# Actor Model Basics Example
#
# Demonstrates actor-based concurrency with message passing.
# NOTE: Full spawn keyword requires parser changes.
# This example shows the foundation using spawn_actor function.

use std.actors.actor.{
    ActorRef, spawn_actor, spawn_pool,
    broadcast, round_robin, get_actor_runtime
}

# ================================================================
# Simple Actor Example
# ================================================================

struct Counter:
    """A simple counter actor."""
    value: i64

impl Counter:
    fn init():
        """Constructor."""
        self.value = 0

    fn increment():
        """Increment the counter."""
        self.value = self.value + 1
        print "Counter: {self.value}"

    fn get() -> i64:
        """Get current value."""
        self.value

fn example_simple_actor():
    """Example: Basic actor spawning and messaging."""
    print "=== Simple Actor ==="

    # Spawn actor
    val counter = spawn_actor(Counter(value: 0))

    # Send messages
    counter.send("increment", [])
    counter.send("increment", [])
    counter.send("increment", [])

    # Process messages
    get_actor_runtime().run()

    print "Actor completed\n"

# ================================================================
# Worker Pool Example
# ================================================================

struct Worker:
    """A worker that processes tasks."""
    id: i64
    tasks_processed: i64

impl Worker:
    fn init(id: i64):
        self.id = id
        self.tasks_processed = 0

    fn process(task: text):
        """Process a task."""
        self.tasks_processed = self.tasks_processed + 1
        print "Worker {self.id} processed task: {task} (total: {self.tasks_processed})"

fn example_worker_pool():
    """Example: Pool of worker actors."""
    print "=== Worker Pool ==="

    # Spawn 5 workers
    val workers = spawn_pool(5, \: Worker(id: 0, tasks_processed: 0))

    # Distribute tasks
    val tasks = ["task1", "task2", "task3", "task4", "task5", "task6"]
    round_robin(workers, tasks)

    # Process all messages
    get_actor_runtime().run()

    print "All tasks completed\n"

# ================================================================
# Ping-Pong Example
# ================================================================

struct Ping:
    """Ping actor."""
    pong: ActorRef?
    count: i64

impl Ping:
    fn init():
        self.pong = nil
        self.count = 0

    fn set_pong(pong_ref: ActorRef):
        self.pong = Some(pong_ref)

    fn start():
        """Start ping-pong."""
        if self.pong.?:
            self.pong.unwrap().send("ping", ["0"])

    fn pong(count_str: text):
        """Receive pong."""
        val count = int(count_str)
        if count < 5:
            print "Ping: {count}"
            if self.pong.?:
                self.pong.unwrap().send("ping", ["{count + 1}"])

struct Pong:
    """Pong actor."""
    ping: ActorRef?

impl Pong:
    fn init():
        self.ping = nil

    fn set_ping(ping_ref: ActorRef):
        self.ping = Some(ping_ref)

    fn ping(count_str: text):
        """Receive ping."""
        val count = int(count_str)
        print "Pong: {count}"
        if self.ping.?:
            self.ping.unwrap().send("pong", [count_str])

fn example_ping_pong():
    """Example: Ping-pong between two actors."""
    print "=== Ping-Pong ==="

    # Spawn actors
    val ping = spawn_actor(Ping(pong: nil, count: 0))
    val pong = spawn_actor(Pong(ping: nil))

    # Set up references (simplified - would use messages)
    # ping.send("set_pong", [pong])
    # pong.send("set_ping", [ping])

    # Start
    # ping.send("start", [])

    # Process messages
    # get_actor_runtime().run()

    print "Ping-pong complete (simplified)\n"

# ================================================================
# Broadcast Example
# ================================================================

struct Logger:
    """Logger actor."""
    name: text

impl Logger:
    fn init(name: text):
        self.name = name

    fn log(message: text):
        """Log a message."""
        print "[{self.name}] {message}"

fn example_broadcast():
    """Example: Broadcasting to multiple actors."""
    print "=== Broadcast ==="

    # Spawn loggers
    val loggers = [
        spawn_actor(Logger(name: "Logger1")),
        spawn_actor(Logger(name: "Logger2")),
        spawn_actor(Logger(name: "Logger3"))
    ]

    # Broadcast message to all
    broadcast(loggers, "log", ["System starting"])
    broadcast(loggers, "log", ["All systems operational"])

    # Process messages
    get_actor_runtime().run()

    print "Broadcast complete\n"

# ================================================================
# Main
# ================================================================

fn main():
    print "Actor Model Foundation Examples"
    print "================================\n"

    example_simple_actor()
    example_worker_pool()
    example_ping_pong()
    example_broadcast()

    print "=== Complete ==="
    print "These examples show the foundation for actor model."
    print "Full spawn keyword requires parser changes."
    print "See: doc/plan/spawn_keyword_implementation_plan.md"

main()
