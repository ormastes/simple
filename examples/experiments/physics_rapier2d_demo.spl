#!/usr/bin/env simple
# Rapier2D Physics Demo
#
# Demonstrates 2D physics simulation using the Rapier2D SFFI wrapper.
# Shows rigid bodies, colliders, forces, and collision detection.

use app.io.rapier2d_ffi.{
    Vector2, Transform2, Rotation2,
    PhysicsWorld, physics_create_world, physics_step, physics_destroy_world,
    physics_create_dynamic_body, physics_create_static_body,
    physics_create_circle_collider, physics_create_box_collider,
    physics_body_apply_force, physics_body_get_position,
    physics_collider_set_material, PhysicsMaterial,
    physics_get_contacts, physics_contacts_count, physics_destroy_contacts
}
use app.io.{print}

fn main():
    print "=== Rapier2D Physics Demo ==="
    print ""

    # Create physics world with gravity pointing down
    val gravity = Vector2(x: 0.0, y: -9.81)
    val world = physics_create_world(gravity)

    if not world.is_valid:
        print "ERROR: Failed to create physics world"
        return

    print "✓ Physics world created with gravity (0, -9.81)"
    print ""

    # Create a static ground body at the bottom
    val ground_pos = Vector2(x: 0.0, y: -10.0)
    val ground = physics_create_static_body(world, ground_pos)

    if not ground.is_valid:
        print "ERROR: Failed to create ground body"
        physics_destroy_world(world)
        return

    # Add a box collider to the ground (20 units wide, 1 unit tall)
    val ground_collider = physics_create_box_collider(world, ground, 10.0, 0.5)

    if not ground_collider.is_valid:
        print "ERROR: Failed to create ground collider"
        physics_destroy_world(world)
        return

    # Set ground material (no bounce, high friction)
    val ground_material = PhysicsMaterial(restitution: 0.0, friction: 0.8, density: 1.0)
    physics_collider_set_material(ground_collider, ground_material)

    print "✓ Ground created at y=-10.0 (20x1 box)"
    print ""

    # Create a dynamic ball falling from above
    val ball_pos = Vector2(x: 0.0, y: 5.0)
    val ball = physics_create_dynamic_body(world, ball_pos)

    if not ball.is_valid:
        print "ERROR: Failed to create ball body"
        physics_destroy_world(world)
        return

    # Add a circle collider to the ball (radius 0.5)
    val ball_collider = physics_create_circle_collider(world, ball, 0.5)

    if not ball_collider.is_valid:
        print "ERROR: Failed to create ball collider"
        physics_destroy_world(world)
        return

    # Set ball material (bouncy!)
    val ball_material = PhysicsMaterial(restitution: 0.8, friction: 0.3, density: 1.0)
    physics_collider_set_material(ball_collider, ball_material)

    print "✓ Ball created at y=5.0 (radius 0.5, bouncy)"
    print ""

    # Apply an initial sideways force to make it more interesting
    val sideways_force = Vector2(x: 2.0, y: 0.0)
    physics_body_apply_force(ball, sideways_force)

    print "✓ Applied sideways force (2.0, 0.0) to ball"
    print ""
    print "=== Starting Simulation ==="
    print ""

    # Run simulation for 3 seconds at 60 FPS
    val dt = 0.016666667  # 1/60 second
    val num_steps = 180   # 3 seconds * 60 FPS

    var step_count = 0
    while step_count < num_steps:
        # Step the physics simulation
        physics_step(world, dt)

        # Print ball position every 30 steps (0.5 seconds)
        if step_count % 30 == 0:
            val transform = physics_body_get_position(ball)
            val time = step_count * dt
            print "Time {time:0.2f}s: Ball at ({transform.position.x:0.3f}, {transform.position.y:0.3f})"

            # Check for contacts every half second
            val contacts = physics_get_contacts(world)
            val contact_count = physics_contacts_count(contacts)
            if contact_count > 0:
                print "  → {contact_count} collision(s) detected"
            physics_destroy_contacts(contacts)

        step_count = step_count + 1

    print ""
    print "=== Simulation Complete ==="

    # Final position
    val final_transform = physics_body_get_position(ball)
    print "Final ball position: ({final_transform.position.x:0.3f}, {final_transform.position.y:0.3f})"

    # Cleanup
    physics_destroy_world(world)
    print ""
    print "✓ Physics world cleaned up"
