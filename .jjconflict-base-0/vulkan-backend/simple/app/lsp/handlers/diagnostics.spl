# Diagnostics Handler
# Provides error diagnostics from tree-sitter parse errors

import lsp.protocol as protocol
import lsp.transport as transport
import parser.treesitter.{Tree, Node, NodeId}

# Find all ERROR nodes in the tree
fn find_error_nodes(tree: Tree) -> List<Node>:
    let mut errors: List<Node> = []

    # Helper function to traverse tree recursively
    fn traverse(node_id: NodeId):
        match tree.arena.get(node_id):
            case None:
                return
            case Some(node):
                # Check if this node is an error
                if node.kind == "ERROR" or node.has_error:
                    errors.push(node)

                # Traverse children
                for child_id in node.children:
                    traverse(child_id)

    # Start traversal from root
    traverse(tree.root_node)

    errors

# Convert tree-sitter node to LSP diagnostic
fn node_to_diagnostic(node: Node) -> Dict:
    # Create range
    let range = {
        "start": {
            "line": node.span.start_line,
            "character": node.span.start_column
        },
        "end": {
            "line": node.span.end_line,
            "character": node.span.end_column
        }
    }

    # Determine message based on node context
    let message = if node.text.len() > 0:
        f"Syntax error near '{node.text}'"
    else:
        "Syntax error"

    # Create diagnostic
    {
        "range": range,
        "severity": protocol.DiagnosticSeverity.Error,
        "source": "simple-lsp",
        "message": message
    }

# Generate diagnostics from parse tree
fn generate_diagnostics(tree: Tree) -> List<Dict>:
    let error_nodes = find_error_nodes(tree)
    let mut diagnostics: List<Dict> = []

    for error_node in error_nodes:
        let diagnostic = node_to_diagnostic(error_node)
        diagnostics.push(diagnostic)

    diagnostics

# Handle diagnostics for a document
fn handle_diagnostics(uri: String, tree: Tree) -> Result<Nil, String>:
    # Generate diagnostics from tree
    let diagnostics = generate_diagnostics(tree)

    transport.log_debug(f"Found {diagnostics.len()} diagnostics for {uri}")

    # Send publishDiagnostics notification
    let params = {
        "uri": uri,
        "diagnostics": diagnostics
    }

    transport.write_notification("textDocument/publishDiagnostics", params)?

    Ok(nil)
