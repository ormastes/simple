# VSCode Languages API
# Register language feature providers

# External FFI declarations
extern fn vscode_languages_register_completion(language: String, callback_id: i64): i64
extern fn vscode_languages_register_hover(language: String, callback_id: i64): i64
extern fn vscode_languages_register_definition(language: String, callback_id: i64): i64
extern fn vscode_languages_register_code_actions(language: String, callback_id: i64): i64
extern fn vscode_languages_create_diagnostic_collection(name: String): i64
extern fn vscode_languages_set_diagnostics(collection_id: i64, uri: String, diagnostics_json: String): void

# Document and Position types
pub class TextDocument:
    pub uri: String
    pub language_id: String
    pub version: i32
    pub line_count: i32

    pub fn new(): TextDocument =
        TextDocument {
            uri: "",
            language_id: "",
            version: 0,
            line_count: 0
        }

    pub fn line_at(self, line: i32): TextLine =
        """Get text line at index."""
        # FFI call to get line
        TextLine {
            line_number: line,
            text: "",
            range: Range.new(Position.new(line, 0), Position.new(line, 0))
        }

    pub fn get_text(self): String =
        """Get full document text."""
        # FFI call
        ""

    pub fn get_word_range_at_position(self, position: Position): Range? =
        """Get range of word at position."""
        # FFI call
        none

pub class TextLine:
    pub line_number: i32
    pub text: String
    pub range: Range

pub class Position:
    pub line: i32
    pub character: i32

    pub fn new(line: i32, character: i32): Position =
        Position {line: line, character: character}

pub class Range:
    pub start: Position
    pub end: Position

    pub fn new(start: Position, end: Position): Range =
        Range {start: start, end: end}

# Completion items
pub class CompletionItem:
    pub label: String
    pub kind: i32
    pub detail: String
    pub documentation: String
    pub insert_text: String

    pub fn new(label: String, kind: i32): CompletionItem =
        """Create completion item.

        Kinds:
        - 0: Text
        - 1: Method
        - 2: Function
        - 3: Constructor
        - 4: Field
        - 5: Variable
        - 6: Class
        - 7: Interface
        - 8: Module
        - 9: Property
        - 10: Unit
        - 11: Value
        - 12: Enum
        - 13: Keyword
        - 14: Snippet
        """
        CompletionItem {
            label: label,
            kind: kind,
            detail: "",
            documentation: "",
            insert_text: label
        }

pub let CompletionItemKind_Text: i32 = 0
pub let CompletionItemKind_Method: i32 = 1
pub let CompletionItemKind_Function: i32 = 2
pub let CompletionItemKind_Constructor: i32 = 3
pub let CompletionItemKind_Field: i32 = 4
pub let CompletionItemKind_Variable: i32 = 5
pub let CompletionItemKind_Class: i32 = 6
pub let CompletionItemKind_Interface: i32 = 7
pub let CompletionItemKind_Module: i32 = 8
pub let CompletionItemKind_Property: i32 = 9
pub let CompletionItemKind_Keyword: i32 = 13
pub let CompletionItemKind_Snippet: i32 = 14

# Hover information
pub class Hover:
    pub contents: String  # Markdown string
    pub range: Range?

    pub fn new(contents: String): Hover =
        """Create hover information."""
        Hover {
            contents: contents,
            range: none
        }

# Diagnostic (error/warning)
pub class Diagnostic:
    pub range: Range
    pub message: String
    pub severity: i32
    pub source: String
    pub code: String

    pub fn new(range: Range, message: String, severity: i32): Diagnostic =
        """Create diagnostic.

        Severity:
        - 0: Error
        - 1: Warning
        - 2: Information
        - 3: Hint
        """
        Diagnostic {
            range: range,
            message: message,
            severity: severity,
            source: "",
            code: ""
        }

pub let DiagnosticSeverity_Error: i32 = 0
pub let DiagnosticSeverity_Warning: i32 = 1
pub let DiagnosticSeverity_Information: i32 = 2
pub let DiagnosticSeverity_Hint: i32 = 3

# Diagnostic collection
pub class DiagnosticCollection:
    pub id: i64
    pub name: String

    pub fn new(name: String): DiagnosticCollection =
        """Create diagnostic collection."""
        let id = vscode_languages_create_diagnostic_collection(name)
        DiagnosticCollection {
            id: id,
            name: name
        }

    pub fn set(self, uri: String, diagnostics: List[Diagnostic]):
        """Set diagnostics for a file."""
        # Serialize diagnostics to JSON
        let diagnostics_json = _serialize_diagnostics(diagnostics)
        vscode_languages_set_diagnostics(self.id, uri, diagnostics_json)

    pub fn clear(self):
        """Clear all diagnostics."""
        # FFI call
        pass

    pub fn dispose(self):
        """Dispose collection."""
        # FFI call
        pass

# Completion provider
pub fn register_completion_provider(
    language: String,
    provider: fn(document: TextDocument, position: Position): List[CompletionItem]
): i64 =
    """Register completion provider.

    Example:
        languages.register_completion_provider("simple", fn(doc, pos):
            return [
                CompletionItem.new("fn", CompletionItemKind_Keyword),
                CompletionItem.new("let", CompletionItemKind_Keyword)
            ]
        )
    """
    # TODO: Store provider callback
    let callback_id = 0
    vscode_languages_register_completion(language, callback_id)

# Hover provider
pub fn register_hover_provider(
    language: String,
    provider: fn(document: TextDocument, position: Position): Hover?
): i64 =
    """Register hover provider."""
    let callback_id = 0
    vscode_languages_register_hover(language, callback_id)

# Definition provider
pub fn register_definition_provider(
    language: String,
    provider: fn(document: TextDocument, position: Position): Range?
): i64 =
    """Register definition provider."""
    let callback_id = 0
    vscode_languages_register_definition(language, callback_id)

# Helper: Serialize diagnostics to JSON
fn _serialize_diagnostics(diagnostics: List[Diagnostic]): String =
    """Convert diagnostics to JSON array."""
    let parts: List[String] = []

    for diag in diagnostics:
        let json = '{'
        json = json + '"range":{"start":{"line":' + diag.range.start.line.to_string()
        json = json + ',"character":' + diag.range.start.character.to_string() + '}'
        json = json + ',"end":{"line":' + diag.range.end.line.to_string()
        json = json + ',"character":' + diag.range.end.character.to_string() + '}}'
        json = json + ',"message":"' + diag.message + '"'
        json = json + ',"severity":' + diag.severity.to_string()
        json = json + ',"source":"' + diag.source + '"'
        json = json + ',"code":"' + diag.code + '"'
        json = json + '}'
        parts.append(json)

    "[" + parts.join(",") + "]"
