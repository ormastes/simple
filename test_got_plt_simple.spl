# Simple GOT/PLT Builder Test
use compiler.backend.native.got_plt_builder.{GotPltBuilder, generate_plt_stub_x86_64, encode_i32_le}

# Test 1: Create builder
val builder = GotPltBuilder(
    got_entries: [],
    plt_entries: [],
    got_size: 0,
    plt_size: 0,
    next_got_offset: 0,
    next_plt_index: 0
)
print "Test 1: Builder created - PASS"

# Test 2: Check initial state
if builder.next_got_offset == 0 and builder.next_plt_index == 0:
    print "Test 2: Initial state correct - PASS"
else:
    print "Test 2: Initial state wrong - FAIL"

# Test 3: Generate PLT stub
val stub = generate_plt_stub_x86_64(0, 0)
if stub.len() == 16:
    print "Test 3: PLT stub size correct (16 bytes) - PASS"
else:
    print "Test 3: PLT stub size wrong ({stub.len()} bytes) - FAIL"

# Test 4: Check PLT stub opcodes
if stub[0] == 0xFF and stub[1] == 0x25:
    print "Test 4: PLT stub opcodes correct - PASS"
else:
    print "Test 4: PLT stub opcodes wrong - FAIL"

# Test 5: Add a symbol
var builder2 = GotPltBuilder(
    got_entries: [],
    plt_entries: [],
    got_size: 0,
    plt_size: 0,
    next_got_offset: 0,
    next_plt_index: 0
)
val idx = builder2.add_symbol("printf")
if idx == 0 and builder2.plt_entries.len() == 1:
    print "Test 5: Symbol added correctly - PASS"
else:
    print "Test 5: Symbol addition failed - FAIL"

# Test 6: GOT offset increments
if builder2.next_got_offset == 8:
    print "Test 6: GOT offset incremented (8 bytes) - PASS"
else:
    print "Test 6: GOT offset wrong ({builder2.next_got_offset} bytes) - FAIL"

# Test 7: Add another symbol
val idx2 = builder2.add_symbol("malloc")
if idx2 == 1 and builder2.plt_entries.len() == 2:
    print "Test 7: Second symbol added - PASS"
else:
    print "Test 7: Second symbol failed - FAIL"

# Test 8: Reuse existing symbol
val idx3 = builder2.add_symbol("printf")
if idx3 == 0 and builder2.plt_entries.len() == 2:
    print "Test 8: Symbol reuse works - PASS"
else:
    print "Test 8: Symbol reuse failed - FAIL"

# Test 9: Encode i32 little-endian
val bytes = encode_i32_le(0x12345678)
if bytes.len() == 4 and bytes[0] == 0x78 and bytes[1] == 0x56:
    print "Test 9: i32 encoding correct - PASS"
else:
    print "Test 9: i32 encoding wrong - FAIL"

print "\nAll basic tests completed!"
