#!/usr/bin/env simple
# Test File I/O Protection MCP Features

use app.mcp.fileio_protection (ProtectionEngine, RuleType, RuleAction, ProtectionResult, create_engine)

fn main():
    print "Testing File I/O Protection MCP Features"
    print "=========================================="
    print ""

    # Create engine with config
    val engine = create_engine("fileio_protection.sdn", ".fileio_temp")

    # Test 1: Protected file (read-only)
    print "Test 1: CLAUDE.md (should be protected/read-only)"
    val result1 = engine.check_path("CLAUDE.md", "write")
    match result1:
        ProtectionResult.Denied(reason):
            print "  ✓ Write denied: {reason}"
        _:
            print "  ✗ Expected denied, got other result"

    val result1_read = engine.check_path("CLAUDE.md", "read")
    match result1_read:
        ProtectionResult.Allowed:
            print "  ✓ Read allowed"
        _:
            print "  ✗ Expected allowed for read"

    print ""

    # Test 2: Source directory (read-only)
    print "Test 2: src/ directory (should be protected/read-only)"
    val result2 = engine.check_path("src/", "write")
    match result2:
        ProtectionResult.Denied(reason):
            print "  ✓ Write denied: {reason}"
        _:
            print "  ✗ Expected denied, got other result"

    print ""

    # Test 3: .sdn file (atomic write required)
    print "Test 3: test.sdn (should require atomic write)"
    val result3 = engine.check_path("test.sdn", "write")
    match result3:
        ProtectionResult.RequiresAtomic:
            print "  ✓ Atomic write required"
        _:
            print "  ✗ Expected requires atomic"

    print ""

    # Test 4: Shell script (redirect to temp)
    print "Test 4: script.sh (should redirect to temp)"
    val result4 = engine.check_path("script.sh", "write")
    match result4:
        ProtectionResult.Redirected(path):
            print "  ✓ Redirected to: {path}"
        _:
            print "  ✗ Expected redirected"

    print ""

    # Test 5: Version control (denied)
    print "Test 5: .git/ directory (should be denied)"
    val result5 = engine.check_path(".git/", "read")
    match result5:
        ProtectionResult.Denied(reason):
            print "  ✓ Access denied: {reason}"
        _:
            print "  ✗ Expected denied"

    print ""

    # Test 6: Allowed directory
    print "Test 6: doc/test.md (should be allowed)"
    val result6 = engine.check_path("doc/test.md", "write")
    match result6:
        ProtectionResult.Allowed:
            print "  ✓ Write allowed (no matching rule)"
        _:
            print "  ✗ Expected allowed"

    print ""

    # Test 7: List protected files
    print "Test 7: List protected files"
    val protected = engine.list_protected_files("*")
    print "  Protected files count: {protected.len()}"
    for file in protected:
        print "    - {file}"

    print ""
    print "=========================================="
    print "All tests completed!"

fn print(msg: text):
    # TODO: Implement print
    ()
