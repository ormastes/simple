# Simple (.spl) replacement for test_variable_interpolation.sh
# Test Variable Interpolation in String Interning
# Tests that named parameters like {name} and {age} are extracted and stored correctly

use app.io.mod.{shell, shell_output, file_write, file_read, print, cwd, dir_create_all}
use std.text.{contains, trim}

fn main():
    val script_dir = cwd()
    var project_root = trim(shell_output("cd {script_dir}/../.. && pwd"))
    val test_dir = "{script_dir}/test_var_interp_tmp"

    print "Variable Interpolation Test\n"
    print "\n"

    # Create test directory
    print "Creating test directory...\n"
    shell("rm -rf {test_dir}")
    dir_create_all(test_dir)

    # Create test SMF file with named parameters
    print "Creating test SMF with named parameters...\n"
    val smf_content = "metadata:\n  version: 1\n  format: \"smf_subset\"\n  target: \"riscv32-bare\"\n  source: \"test.spl\"\n\nstrings:\n  - id: 1\n    text: \"Hello, {}!\"\n    params: 1\n    param_names: [\"name\"]\n\n  - id: 2\n    text: \"User: {}, Age: {}\"\n    params: 2\n    param_names: [\"username\", \"age\"]\n\n  - id: 3\n    text: \"RGB({}, {}, {})\"\n    params: 3\n    param_names: [\"r\", \"g\", \"b\"]\n"
    file_write("{test_dir}/test_vars.smf", smf_content)
    print "Created test_vars.smf\n"

    val content = file_read("{test_dir}/test_vars.smf")
    print "{content}\n"
    print "\n"

    # Test SMF parser
    print "Testing SMF parser...\n"
    val parser_code = "use app.io\n\nfn main():\n    val content = file_read(\"test_vars.smf\")\n    print \"SMF file content (\" + content.len().to_text() + \" bytes):\\n\"\n    print content\n    print \"\\n\"\n\n    if content.contains(\"param_names\"):\n        print \"param_names field found in SMF!\\n\"\n    else:\n        print \"param_names field NOT found\\n\"\n\n    if content.contains(\"name\"):\n        print \"Named parameter 'name' found!\\n\"\n    if content.contains(\"username\"):\n        print \"Named parameter 'username' found!\\n\"\n    if content.contains(\"r\"):\n        print \"Named parameter 'r' found!\\n\"\n\nmain()\n"
    file_write("{test_dir}/test_parser.spl", parser_code)

    shell("{project_root}/bin/simple {test_dir}/test_parser.spl 2>&1 | grep -v '^\\[DEBUG\\]' | grep -v '^\\[2026-' || true")

    print "\n"
    print "Test Complete!\n"
    print "\n"
    print "Next steps:\n"
    print "  1. Compile Simple program with variable interpolation\n"
    print "  2. Generate SMF with extracted parameter names\n"
    print "  3. Build table and embed in binary\n"
    print "  4. Run in QEMU with parameter passing\n"

main()
