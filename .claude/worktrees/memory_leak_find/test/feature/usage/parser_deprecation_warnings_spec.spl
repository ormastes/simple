"""
# Parser Deprecation Warnings Specification

**Feature IDs:** #PARSER-DEPREC-001 to #PARSER-DEPREC-031
**Category:** Infrastructure | Parser
**Status:** Implemented

Tests that the parser correctly emits deprecation warnings for
deprecated syntax (e.g., [] for generics instead of <>).

## Key Deprecations

- Generic syntax: `[]` deprecated in favor of `<>`
- Affects: functions, structs, classes, enums, traits, impl blocks
- Array types `[i32]` and literals `[1,2,3]` should NOT warn

## API

```simple
use std.parser.{Parser, ErrorHint, ErrorHintLevel}

var parser = Parser.new(source)
parser.parse()
val hints = parser.error_hints()
```
"""

use std.spec
use std.parser.{Parser, ErrorHintLevel}


# ============================================================================
# Test Group 1: Function Generic Parameters
# ============================================================================

describe "Function Generic Deprecation Warnings":
    """
    ## Generic Function Syntax

    Tests deprecation warnings for function generic parameters.
    """

    it "warns about deprecated [] syntax in function generics":
        var parser = Parser.new("fn test[T](x: T) -> T:\n    x")
        parser.parse()
        val hints = parser.error_hints()
        val has_warning = hints.any(\h: h.level == ErrorHintLevel.Warning and h.message.contains("Deprecated"))
        expect has_warning

    it "warns about deprecated [] syntax with multiple params":
        var parser = Parser.new("fn map[T, U](f: fn(T) -> U) -> U:\n    pass")
        parser.parse()
        val hints = parser.error_hints()
        val has_warning = hints.any(\h: h.level == ErrorHintLevel.Warning and h.message.contains("Deprecated"))
        expect has_warning

    it "does NOT warn about <> syntax in function generics":
        var parser = Parser.new("fn test<T>(x: T) -> T:\n    x")
        parser.parse()
        val hints = parser.error_hints()
        val has_deprecation = hints.any(\h: h.message.contains("Deprecated") and h.message.contains("generic"))
        expect not has_deprecation


# ============================================================================
# Test Group 2: Struct Generic Parameters
# ============================================================================

describe "Struct Generic Deprecation Warnings":
    """
    ## Generic Struct Syntax

    Tests deprecation warnings for struct generic parameters.
    """

    it "warns about deprecated [] syntax in struct":
        var parser = Parser.new("struct Container[T]:\n    value: T")
        parser.parse()
        val hints = parser.error_hints()
        val has_warning = hints.any(\h: h.level == ErrorHintLevel.Warning and h.message.contains("Deprecated"))
        expect has_warning

    it "does NOT warn about <> syntax in struct":
        var parser = Parser.new("struct Container<T>:\n    value: T")
        parser.parse()
        val hints = parser.error_hints()
        val has_deprecation = hints.any(\h: h.message.contains("Deprecated") and h.message.contains("generic"))
        expect not has_deprecation


# ============================================================================
# Test Group 3: Type Annotations
# ============================================================================

describe "Type Annotation Deprecation Warnings":
    """
    ## Generic Type Annotation Syntax

    Tests deprecation warnings for type annotations.
    """

    it "warns about deprecated [] syntax in Option type":
        var parser = Parser.new("val x: Option[Int] = None")
        parser.parse()
        val hints = parser.error_hints()
        val has_warning = hints.any(\h: h.level == ErrorHintLevel.Warning and h.message.contains("Deprecated"))
        expect has_warning

    it "warns about deprecated [] syntax in Result type":
        var parser = Parser.new("val x: Result[Int, String] = Ok(42)")
        parser.parse()
        val hints = parser.error_hints()
        val has_warning = hints.any(\h: h.level == ErrorHintLevel.Warning and h.message.contains("Deprecated"))
        expect has_warning

    it "warns about deprecated [] syntax in List type":
        var parser = Parser.new("val nums: List[Int] = []")
        parser.parse()
        val hints = parser.error_hints()
        val has_warning = hints.any(\h: h.level == ErrorHintLevel.Warning and h.message.contains("Deprecated"))
        expect has_warning

    it "does NOT warn about <> syntax in type annotation":
        var parser = Parser.new("val x: Option<Int> = None")
        parser.parse()
        val hints = parser.error_hints()
        val has_deprecation = hints.any(\h: h.message.contains("Deprecated") and h.message.contains("generic"))
        expect not has_deprecation


# ============================================================================
# Test Group 4: Nested Generics
# ============================================================================

describe "Nested Generic Deprecation Warnings":
    """
    ## Nested Generic Syntax

    Tests deprecation warnings for nested generic types.
    """

    it "warns about both nested [] usages":
        var parser = Parser.new("val x: List[Option[String]] = []")
        parser.parse()
        val hints = parser.error_hints()
        val warning_count = hints.filter(\h: h.level == ErrorHintLevel.Warning and h.message.contains("Deprecated")).len()
        expect warning_count >= 2

    it "does NOT warn about nested <> syntax":
        var parser = Parser.new("val x: List<Option<String>> = []")
        parser.parse()
        val hints = parser.error_hints()
        val has_deprecation = hints.any(\h: h.message.contains("Deprecated") and h.message.contains("generic"))
        expect not has_deprecation


# ============================================================================
# Test Group 5: Array Types (Should NOT Warn)
# ============================================================================

describe "Array Type No Deprecation Warnings":
    """
    ## Array Type Syntax

    Tests that array types do NOT trigger deprecation warnings.
    """

    it "does NOT warn about array type [i32]":
        var parser = Parser.new("val arr: [i32] = [1, 2, 3]")
        parser.parse()
        val hints = parser.error_hints()
        val has_deprecation = hints.any(\h: h.message.contains("Deprecated") and h.message.contains("generic"))
        expect not has_deprecation

    it "does NOT warn about fixed-size array [i32; 10]":
        var parser = Parser.new("val arr: [i32; 10] = []")
        parser.parse()
        val hints = parser.error_hints()
        val has_deprecation = hints.any(\h: h.message.contains("Deprecated") and h.message.contains("generic"))
        expect not has_deprecation


# ============================================================================
# Test Group 6: Array Literals (Should NOT Warn)
# ============================================================================

describe "Array Literal No Deprecation Warnings":
    """
    ## Array Literal Syntax

    Tests that array literals do NOT trigger deprecation warnings.
    """

    it "does NOT warn about array literal":
        var parser = Parser.new("val arr = [1, 2, 3, 4, 5]")
        parser.parse()
        val hints = parser.error_hints()
        val has_deprecation = hints.any(\h: h.message.contains("Deprecated") and h.message.contains("generic"))
        expect not has_deprecation

    it "does NOT warn about empty array literal":
        var parser = Parser.new("val arr = []")
        parser.parse()
        val hints = parser.error_hints()
        val has_deprecation = hints.any(\h: h.message.contains("Deprecated") and h.message.contains("generic"))
        expect not has_deprecation


# ============================================================================
# Test Group 7: String and Comment (Should NOT Warn)
# ============================================================================

describe "String and Comment No Deprecation Warnings":
    """
    ## Bracket Syntax in Strings/Comments

    Tests that [] in strings and comments do NOT trigger warnings.
    """

    it "does NOT warn about [] in string literal":
        var parser = Parser.new(r'val s = "This is List[T] in a string"')
        parser.parse()
        val hints = parser.error_hints()
        val has_deprecation = hints.any(\h: h.message.contains("Deprecated") and h.message.contains("generic"))
        expect not has_deprecation

    it "does NOT warn about [] in comment":
        var parser = Parser.new("# This is Option[T] in a comment\nval x = 42")
        parser.parse()
        val hints = parser.error_hints()
        val has_deprecation = hints.any(\h: h.message.contains("Deprecated") and h.message.contains("generic"))
        expect not has_deprecation


# ============================================================================
# Test Group 8: Multiple Warnings
# ============================================================================

describe "Multiple Deprecation Warnings":
    """
    ## Multiple Deprecated Usages

    Tests that multiple deprecations in same file all warn.
    """

    it "warns about multiple deprecations in same file":
        val source = """
fn map[T, U](list: List[T], f: fn(T) -> U) -> List[U]:
    []

struct Container[T]:
    value: T

val opt: Option[String] = None
"""
        var parser = Parser.new(source)
        parser.parse()
        val hints = parser.error_hints()
        val warning_count = hints.filter(\h: h.level == ErrorHintLevel.Warning and h.message.contains("Deprecated")).len()
        expect warning_count >= 5


# ============================================================================
# Test Group 9: Class Generic Parameters
# ============================================================================

describe "Class Generic Deprecation Warnings":
    """
    ## Generic Class Syntax

    Tests deprecation warnings for class generic parameters.
    """

    it "warns about deprecated [] syntax in class":
        var parser = Parser.new("class MyClass[T]:\n    val data: T")
        parser.parse()
        val hints = parser.error_hints()
        val has_warning = hints.any(\h: h.level == ErrorHintLevel.Warning and h.message.contains("Deprecated"))
        expect has_warning

    it "does NOT warn about <> syntax in class":
        var parser = Parser.new("class MyClass<T>:\n    val data: T")
        parser.parse()
        val hints = parser.error_hints()
        val has_deprecation = hints.any(\h: h.message.contains("Deprecated") and h.message.contains("generic"))
        expect not has_deprecation


# ============================================================================
# Test Group 10: Enum Generic Parameters
# ============================================================================

describe "Enum Generic Deprecation Warnings":
    """
    ## Generic Enum Syntax

    Tests deprecation warnings for enum generic parameters.
    """

    it "warns about deprecated [] syntax in enum":
        var parser = Parser.new("enum Result[T, E]:\n    Ok(T)\n    Err(E)")
        parser.parse()
        val hints = parser.error_hints()
        val has_warning = hints.any(\h: h.level == ErrorHintLevel.Warning and h.message.contains("Deprecated"))
        expect has_warning

    it "does NOT warn about <> syntax in enum":
        var parser = Parser.new("enum Result<T, E>:\n    Ok(T)\n    Err(E)")
        parser.parse()
        val hints = parser.error_hints()
        val has_deprecation = hints.any(\h: h.message.contains("Deprecated") and h.message.contains("generic"))
        expect not has_deprecation


# ============================================================================
# Test Group 11: Trait Generic Parameters
# ============================================================================

describe "Trait Generic Deprecation Warnings":
    """
    ## Generic Trait Syntax

    Tests deprecation warnings for trait generic parameters.
    """

    it "warns about deprecated [] syntax in trait":
        var parser = Parser.new("trait Iterator[T]:\n    fn next() -> Option[T]")
        parser.parse()
        val hints = parser.error_hints()
        val warning_count = hints.filter(\h: h.level == ErrorHintLevel.Warning and h.message.contains("Deprecated")).len()
        expect warning_count >= 1

    it "does NOT warn about <> syntax in trait":
        var parser = Parser.new("trait Iterator<T>:\n    fn next() -> Option<T>")
        parser.parse()
        val hints = parser.error_hints()
        val has_deprecation = hints.any(\h: h.message.contains("Deprecated") and h.message.contains("generic"))
        expect not has_deprecation


# ============================================================================
# Test Group 12: Function Return Types
# ============================================================================

describe "Return Type Deprecation Warnings":
    """
    ## Generic Return Type Syntax

    Tests deprecation warnings for return type annotations.
    """

    it "warns about deprecated [] syntax in return type":
        var parser = Parser.new("fn get() -> Option[Int]:\n    None")
        parser.parse()
        val hints = parser.error_hints()
        val has_warning = hints.any(\h: h.level == ErrorHintLevel.Warning and h.message.contains("Deprecated"))
        expect has_warning

    it "does NOT warn about <> syntax in return type":
        var parser = Parser.new("fn get() -> Option<Int>:\n    None")
        parser.parse()
        val hints = parser.error_hints()
        val has_deprecation = hints.any(\h: h.message.contains("Deprecated") and h.message.contains("generic"))
        expect not has_deprecation


# ============================================================================
# Test Group 13: Const Generic Parameters
# ============================================================================

describe "Const Generic Deprecation Warnings":
    """
    ## Const Generic Syntax

    Tests deprecation warnings for const generic parameters.
    """

    it "warns about deprecated [] syntax with const generics":
        var parser = Parser.new("struct Array[T, const N: usize]:\n    data: [T; N]")
        parser.parse()
        val hints = parser.error_hints()
        val has_warning = hints.any(\h: h.level == ErrorHintLevel.Warning and h.message.contains("Deprecated"))
        expect has_warning

    it "does NOT warn about <> syntax with const generics":
        var parser = Parser.new("struct Array<T, const N: usize>:\n    data: [T; N]")
        parser.parse()
        val hints = parser.error_hints()
        val has_deprecation = hints.any(\h: h.message.contains("Deprecated") and h.message.contains("generic"))
        expect not has_deprecation


# ============================================================================
# Test Group 14: Impl Block Generics
# ============================================================================

describe "Impl Block Deprecation Warnings":
    """
    ## Generic Impl Block Syntax

    Tests deprecation warnings for impl block generics.
    """

    it "warns about [] in impl block":
        var parser = Parser.new("impl[T] Container[T]:\n    fn new(val: T) -> Container[T]:\n        pass")
        parser.parse()
        val hints = parser.error_hints()
        val warning_count = hints.filter(\h: h.level == ErrorHintLevel.Warning and h.message.contains("Deprecated")).len()
        expect warning_count >= 2

    it "does NOT warn about <> in impl block":
        var parser = Parser.new("impl<T> Container<T>:\n    fn new(val: T) -> Container<T>:\n        pass")
        parser.parse()
        val hints = parser.error_hints()
        val has_deprecation = hints.any(\h: h.message.contains("Deprecated") and h.message.contains("generic"))
        expect not has_deprecation


# ============================================================================
# Test Group 15: Edge Cases
# ============================================================================

describe "Deprecation Warning Edge Cases":
    """

    ## Mixed and Edge Case Syntax

    Tests edge cases for deprecation warnings.
    """

    it "old syntax warns, new syntax does not":
        var parser_old = Parser.new("fn legacy[T](x: T) -> T:\n    x")
        parser_old.parse()
        val old_warns = parser_old.error_hints().any(\h: h.message.contains("Deprecated"))

        var parser_new = Parser.new("fn modern<U>(y: U) -> U:\n    y")
        parser_new.parse()
        val new_warns = parser_new.error_hints().any(\h: h.message.contains("Deprecated") and h.message.contains("generic"))

        expect old_warns
        expect not new_warns

