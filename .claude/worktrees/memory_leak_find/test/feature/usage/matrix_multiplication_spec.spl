"""
# Matrix Multiplication Operator (@)

**Feature ID:** OP-MATMUL
**Category:** Operators | Linear Algebra
**Status:** Implemented

The `@` operator performs matrix multiplication following NumPy semantics:
- Scalar @ Scalar: Element-wise multiplication
- 1D @ 1D: Dot product (inner product)
- 2D @ 2D: Matrix multiplication
- 2D @ 1D: Matrix-vector product
- 1D @ 2D: Vector-matrix product

## Implementation Details

Matrix multiplication is implemented in the interpreter with proper dimension checking
and automatic float/int promotion. Codegen mode delegates to the interpreter.

## Examples

```simple
# Scalars
val result = 3 @ 4  # 12

# Dot product
val v1 = [1, 2, 3]
val v2 = [4, 5, 6]
val dot = v1 @ v2  # 32

# Matrix multiplication
val a = [[1, 2], [3, 4]]
val b = [[5, 6], [7, 8]]
val c = a @ b  # [[19, 22], [43, 50]]

# Matrix-vector
val m = [[1, 2, 3], [4, 5, 6]]
val v = [7, 8, 9]
val result = m @ v  # [50, 122]
```
"""

describe "Matrix Multiplication - Scalar Operations":
    """Tests scalar @ scalar operations"""

    it "multiplies two integers":
        val result = 3 @ 4
        expect result == 12

    it "multiplies two floats":
        val result = 2.5 @ 4.0
        expect result == 10.0

    it "handles mixed int/float (int @ float)":
        val result = 3 @ 2.5
        expect result == 7.5

    it "handles mixed int/float (float @ int)":
        val result = 2.5 @ 3
        expect result == 7.5

    it "handles zero multiplication":
        val result = 0 @ 100
        expect result == 0

    it "handles negative numbers":
        val result = (-3) @ 4
        expect result == (-12)

    it "handles negative floats":
        val result = (-2.5) @ (-4.0)
        expect result == 10.0

describe "Matrix Multiplication - Dot Product (1D @ 1D)":
    """Tests 1D array dot products"""

    it "computes dot product of integer vectors":
        val a = [1, 2, 3]
        val b = [4, 5, 6]
        val result = a @ b
        expect result == 32  # 1*4 + 2*5 + 3*6 = 32

    it "computes dot product of float vectors":
        val a = [1.0, 2.0, 3.0]
        val b = [4.0, 5.0, 6.0]
        val result = a @ b
        expect result == 32.0

    it "computes dot product with mixed int/float":
        val a = [1, 2, 3]
        val b = [1.5, 2.5, 3.5]
        val result = a @ b
        expect result == 17.0  # 1*1.5 + 2*2.5 + 3*3.5

    it "handles zero vector":
        val a = [1, 2, 3]
        val b = [0, 0, 0]
        val result = a @ b
        expect result == 0

    it "handles single element vectors":
        val a = [5]
        val b = [3]
        val result = a @ b
        expect result == 15

    it "handles negative vectors":
        val a = [1, -2, 3]
        val b = [-4, 5, -6]
        val result = a @ b
        expect result == (-32)  # 1*(-4) + (-2)*5 + 3*(-6) = -32

    it "handles orthogonal vectors (dot product = 0)":
        val a = [1, 0]
        val b = [0, 1]
        val result = a @ b
        expect result == 0

    it "computes dot product of longer vectors":
        val a = [1, 2, 3, 4, 5]
        val b = [2, 3, 4, 5, 6]
        val result = a @ b
        expect result == 70  # 2 + 6 + 12 + 20 + 30

describe "Matrix Multiplication - 2D @ 2D":
    """Tests matrix @ matrix operations"""

    it "multiplies 2x2 matrices":
        val a = [[1, 2], [3, 4]]
        val b = [[5, 6], [7, 8]]
        val c = a @ b
        expect c == [[19, 22], [43, 50]]

    it "multiplies 2x3 and 3x2 matrices":
        val a = [[1, 2, 3], [4, 5, 6]]
        val b = [[7, 8], [9, 10], [11, 12]]
        val c = a @ b
        expect c.len() == 2
        expect c[0].len() == 2
        expect c[0][0] == 58
        expect c[0][1] == 64
        expect c[1][0] == 139
        expect c[1][1] == 154

    it "multiplies identity matrix":
        val identity = [[1, 0], [0, 1]]
        val a = [[3, 4], [5, 6]]
        val result = identity @ a
        expect result == a

    it "multiplies 3x3 identity":
        val a = [[1, 0, 0], [0, 1, 0], [0, 0, 1]]
        val b = [[2, 3, 4], [5, 6, 7], [8, 9, 10]]
        val c = a @ b
        expect c == b

    it "handles 1x1 matrices":
        val a = [[5]]
        val b = [[3]]
        val c = a @ b
        expect c == [[15]]

    it "handles rectangular matrices (tall @ wide)":
        val a = [[1], [2], [3]]  # 3x1
        val b = [[4, 5, 6]]      # 1x3
        val c = a @ b            # 3x3
        expect c == [[4, 5, 6], [8, 10, 12], [12, 15, 18]]

    it "handles zero matrix":
        val a = [[1, 2], [3, 4]]
        val zero = [[0, 0], [0, 0]]
        val c = a @ zero
        expect c == [[0, 0], [0, 0]]

    it "handles negative matrices":
        val a = [[1, 2], [3, 4]]
        val b = [[-1, 0], [0, -1]]
        val c = a @ b
        expect c == [[-1, -2], [-3, -4]]

describe "Matrix Multiplication - Matrix-Vector":
    """Tests matrix @ vector operations"""

    it "multiplies 2x3 matrix by 3x1 vector":
        val a = [[1, 2, 3], [4, 5, 6]]
        val b = [7, 8, 9]
        val c = a @ b
        expect c == [50, 122]

    it "multiplies 3x2 matrix by 2x1 vector":
        val a = [[1, 2], [3, 4], [5, 6]]
        val b = [10, 20]
        val c = a @ b
        expect c == [50, 110, 170]

    it "multiplies identity matrix by vector":
        val identity = [[1, 0, 0], [0, 1, 0], [0, 0, 1]]
        val v = [5, 10, 15]
        val result = identity @ v
        expect result == v

    it "multiplies vector by matrix (1x2 @ 2x3)":
        val a = [1, 2]
        val b = [[3, 4, 5], [6, 7, 8]]
        val c = a @ b
        expect c == [15, 18, 21]

    it "multiplies vector by identity matrix":
        val v = [5, 10]
        val identity = [[1, 0], [0, 1]]
        val result = v @ identity
        expect result == v

    it "handles single column matrix":
        val m = [[1], [2], [3]]
        val v = [4]
        val result = m @ v
        expect result == [4, 8, 12]

describe "Matrix Multiplication - Float Promotion":
    """Tests automatic int/float promotion"""

    it "promotes int matrix to float when multiplied with float matrix":
        val a = [[1, 2], [3, 4]]
        val b = [[1.5, 2.5], [3.5, 4.5]]
        val c = a @ b
        val expected = [[8.5, 11.5], [18.5, 25.5]]
        expect c == expected

    it "promotes int vector to float when multiplied with float vector":
        val a = [1, 2, 3]
        val b = [1.5, 2.5, 3.5]
        val result = a @ b
        expect result == 17.0

    it "handles mixed int/float matrix-vector":
        val m = [[1, 2], [3, 4]]
        val v = [1.5, 2.5]
        val result = m @ v
        expect result == [6.5, 14.5]

describe "Matrix Multiplication - Special Matrices":
    """Tests special matrix properties"""

    it "multiplies diagonal matrices":
        val a = [[2, 0], [0, 3]]
        val b = [[4, 0], [0, 5]]
        val c = a @ b
        expect c == [[8, 0], [0, 15]]

    it "multiplies upper triangular matrices":
        val a = [[1, 2], [0, 3]]
        val b = [[4, 5], [0, 6]]
        val c = a @ b
        expect c == [[4, 17], [0, 18]]

    it "multiplies symmetric matrix":
        val a = [[1, 2], [2, 1]]
        val b = [[3, 4], [4, 3]]
        val c = a @ b
        expect c == [[11, 10], [10, 11]]

describe "Matrix Multiplication - Mathematical Properties":
    """Tests that @ satisfies expected mathematical properties"""

    it "satisfies associativity: (A @ B) @ C == A @ (B @ C)":
        val a = [[1, 2], [3, 4]]
        val b = [[5, 6], [7, 8]]
        val c = [[9, 10], [11, 12]]
        val left = (a @ b) @ c
        val right = a @ (b @ c)
        expect left == right

    it "is NOT commutative: A @ B != B @ A (in general)":
        val a = [[1, 2], [3, 4]]
        val b = [[5, 6], [7, 8]]
        val ab = a @ b
        val ba = b @ a
        expect ab != ba
