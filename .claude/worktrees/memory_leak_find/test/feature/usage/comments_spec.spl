"""
# Comments Specification

**Feature IDs:** #40-43
**Category:** Syntax
**Difficulty:** 1/5
**Status:** Implemented

## Overview

Simple supports multiple comment styles for different purposes: line comments for
quick notes, block comments for longer explanations (with nesting support), and
documentation comments that can be extracted by documentation generators.

## Syntax

### Line Comments

```simple
# This is a line comment
val x = 42  # Comment at end of line
```

### Block Comments

```simple
/* This is a block comment */
val y = 10

/*
Multi-line
block comment
*/
```

### Documentation Comments

```simple
## Single-line doc comment
fn example():
    pass

/**
 * Multi-line doc comment
 * With formatting
 */
struct Point:
    x: Int
    y: Int
```

## Key Concepts

| Concept | Description |
|---------|-------------|
| Line Comment | Single-line comment starting with `#` |
| Block Comment | Multi-line comment enclosed in `/* */` |
| Nested Comments | Block comments can contain other block comments |
| Doc Comment | Special comments for documentation generation |

## Behavior

- **Line comments** extend from `#` to end of line
- **Block comments** can span multiple lines and nest
- **Doc comments** are preserved and can be extracted
- Comments are ignored by the compiler (except doc comments)
- Comments do not affect code execution

## Related Specifications

- [Documentation Generation](../docgen/docgen_spec.md) - Using doc comments
- [Lexer](../lexer/lexer_spec.md) - Comment tokenization

## Implementation Notes

The lexer (`src/parser/src/lexer/comments.rs`) implements:
- Line comment skipping (skip until newline)
- Block comment nesting with depth tracking
- Doc comment content extraction and cleaning
- Triple-slash multi-line doc blocks

Performance: Comment parsing is O(n) where n is comment length.

## Examples

```simple
# Basic usage
val x = 42  # Initialize x

/* Block comment
   spanning multiple lines */
val y = x * 2

## Documentation for function
fn add(a, b):
    a + b

/**
 * Comprehensive documentation
 * with multiple lines
 */
struct Example:
    field: Int
```
"""



# ============================================================================
# Line Comments
# ============================================================================

describe "Comments - Line Comments":
    """
    ## Line Comment Syntax

    Line comments start with `#` and extend to the end of the line.
    They are completely ignored by the compiler.
    """

    context "with single line":
        """
        ### Scenario: Basic Line Comment

        A hash symbol begins a comment that lasts until newline.

        ```simple
        val x = 42  # This is ignored
        ```
        """

        it "ignores comment after statement":
            val x = 42  # This comment is ignored
            expect(x).to_equal(42)

        it "ignores full line comment":
            # This entire line is a comment
            val y = 10
            expect(y).to_equal(10)

        it "allows comment with special characters":
            val z = 5  # Comment with !@#$%^&*()
            expect(z).to_equal(5)

    context "with multiple consecutive lines":
        """
        ### Scenario: Multiple Line Comments

        Each line needs its own `#` prefix.
        """

        it "handles consecutive line comments":
            # First comment
            # Second comment
            # Third comment
            val result = 100
            expect(result).to_equal(100)

        it "allows comments between statements":
            val a = 1
            # Comment between statements
            val b = 2
            # Another comment
            val c = a + b
            expect(c).to_equal(3)


# ============================================================================
# Block Comments
# ============================================================================

describe "Comments - Block Comments":
    """
    ## Block Comment Syntax

    Block comments are enclosed in `/* */` and can span multiple lines.
    Simple supports nested block comments for added flexibility.
    """

    context "with single line":
        """
        ### Scenario: Inline Block Comment

        Block comments can appear on a single line.

        ```simple
        val x = /* comment */ 42
        ```
        """

        it "ignores inline block comment":
            val x = /* ignored */ 42
            expect(x).to_equal(42)

        it "allows block comment between tokens":
            val y = 10 /* comment */ + /* another */ 5
            expect(y).to_equal(15)

    context "with multiple lines":
        """
        ### Scenario: Multi-line Block Comment

        Block comments can span multiple lines.

        ```simple
        /*
        This is a
        multi-line comment
        */
        val x = 42
        ```
        """

        it "ignores multi-line block comment":
            /*
            This comment
            spans multiple
            lines
            */
            val result = 100
            expect(result).to_equal(100)

        it "allows block comment in expression":
            val value = 5 + /*
                inline comment
                on multiple lines
            */ 10
            expect(value).to_equal(15)

    context "with nesting":
        """
        ### Scenario: Nested Block Comments

        Simple supports nested block comments, unlike C/C++.

        ```simple
        /* outer /* inner */ outer */
        ```
        """

        it "handles nested block comments":
            /* outer comment /* nested comment */ still in outer */
            val x = 42
            expect(x).to_equal(42)

        it "allows multiple nesting levels":
            /* level 1 /* level 2 /* level 3 */ back to 2 */ back to 1 */
            val y = 10
            expect(y).to_equal(10)


# ============================================================================
# Documentation Comments
# ============================================================================

describe "Comments - Documentation Comments":
    """
    ## Documentation Comment Syntax

    Doc comments are special comments that can be extracted for
    documentation generation. They use `##` or `/** */` syntax.
    """

    context "with line doc comments":
        """
        ### Scenario: Single-Line Doc Comment

        The `##` syntax creates a doc comment for the next item.

        ```simple
        ## This documents the function
        fn example():
            pass
        ```
        """

        it "preserves doc comment content":
            # Note: Doc comments are parsed by lexer
            val x = 42
            expect(x).to_equal(42)

        it "allows doc comment before function":
            # Doc comments work with functions
            val result = add_two(3, 4)
            expect(result).to_equal(7)

    context "with block doc comments":
        """
        ### Scenario: Multi-Line Doc Comment

        The `/** */` syntax creates multi-line documentation.

        ```simple
        /**
         * Comprehensive documentation
         * with multiple lines
         */
        fn example():
            pass
        ```
        """

        it "preserves block doc comment":
            # Block doc comments work at module level
            val documented = 100
            expect(documented).to_equal(100)

        it "allows doc comment with formatting":
            # Doc comments can document functions
            val result = multiply(6, 7)
            expect(result).to_equal(42)


# ============================================================================
# Comment Placement
# ============================================================================

describe "Comments - Placement":
    """
    ## Comment Placement Rules

    Comments can appear in various locations within code.
    """

    context "in expressions":
        """
        ### Scenario: Comments Within Expressions

        Comments can appear between operators and operands.
        """

        it "allows comments in arithmetic":
            val result = 10 /* first */ + /* second */ 20
            expect(result).to_equal(30)

        it "allows comments in function calls":
            fn triple(x):
                x * 3

            val value = triple(/* arg */ 5)
            expect(value).to_equal(15)

    context "around definitions":
        """
        ### Scenario: Comments Around Definitions

        Comments can document or explain definitions.
        """

        it "allows comment before variable":
            # Define the answer
            val answer = 42
            expect(answer).to_equal(42)

        it "allows comment before function":
            # Helper function
            fn double(x):
                x * 2

            expect(double(21)).to_equal(42)


# ============================================================================
# Edge Cases
# ============================================================================

describe "Comments - Edge Cases":
    """
    ## Edge Case Handling

    Tests for unusual comment scenarios.
    """

    context "with empty comments":
        """
        ### Scenario: Empty Comment Content

        Comments can have no content after the marker.
        """

        it "handles empty line comment":
            val x = 42  #
            expect(x).to_equal(42)

        it "handles empty block comment":
            val y = /**/ 10
            expect(y).to_equal(10)

    context "with comment-like strings":
        """
        ### Scenario: Comment Syntax in Strings

        Comment markers inside strings are not treated as comments.
        """

        it "preserves hash in string":
            val text = "This # is not a comment"
            expect(text).to_equal("This # is not a comment")

        it "preserves block markers in string":
            val code = "/* not a comment */"
            expect(code).to_equal("/* not a comment */")


# ============================================================================
# Helper Functions
# ============================================================================

fn triple(x):
    x * 3

fn double(x):
    x * 2

fn add_two(a, b):
    a + b

fn multiply(a, b):
    a * b
