"""
# Match Expression Separator Specification

**Feature IDs:** #PARSER-ME-001 to #PARSER-ME-010
**Category:** Infrastructure | Parser
**Status:** In Progress

## Bug: Match arm separators in expression context

The runtime has two match parsers:
1. Statement-level: `case` keyword + `:` (works, but no return value)
2. Expression-level: only `=>` works (returns value, rejects `:` and `case`)

The expression-level parser should also accept `:` and `case` keyword.
Fix: src/app/parser/expr/control.spl lines 78-94

Broken syntax (expression context):
    val y = match x:
        42: "found"           # error: expected FatArrow, found Colon
    val y = match x:
        case 42: "found"     # error: expected pattern, found Case

After rebuild, uncomment skipped tests in Group 3 below.
"""

use std.spec.{check, check_msg}

fn match_side_effect(x: i64) -> text:
    var out = ""
    match x:
        case 0:
            out = "zero"
        case 1:
            out = "one"
        case _:
            out = "other"
    out

fn match_guard_side_effect(x: i64) -> text:
    var out = ""
    match x:
        case n if n < 0:
            out = "negative"
        case n if n == 0:
            out = "zero"
        case _:
            out = "positive"
    out

describe "Match Statement case+colon":

    it "executes matching arm for integer patterns":
        expect match_side_effect(0) == "zero"
        expect match_side_effect(1) == "one"
        expect match_side_effect(99) == "other"

    it "executes arm with guard clauses":
        expect match_guard_side_effect(-5) == "negative"
        expect match_guard_side_effect(0) == "zero"
        expect match_guard_side_effect(42) == "positive"

describe "Match Expression FatArrow":

    it "single-expression arms return values":
        val v1 = match 42:
            42 => "found"
            _ => "other"
        expect v1 == "found"
        val v2 = match 99:
            42 => "found"
            _ => "other"
        expect v2 == "other"

    it "multi-line arm bodies return last expression":
        val output = match 42:
            42 =>
                val x = 42 + 1
                x
            _ =>
                0
        expect output == 43

    it "multiple statements in arm body":
        val output = match 10:
            10 =>
                val a = 10 * 2
                val b = a + 5
                b
            _ =>
                -1
        expect output == 25

    it "guard clauses select correct arm":
        val output = match 42:
            x if x > 100 => "big"
            x if x > 0 => "positive"
            _ => "other"
        expect output == "positive"

    it "nested match expressions return values":
        val a = 1
        val output = match a:
            1 =>
                val inner = match 2:
                    2 => "one-two"
                    _ => "one-other"
                inner
            _ =>
                "other"
        expect output == "one-two"

# ============================================================================
# Bug Fix Tests: Expression-Level Colon Separator (#PARSER-ME-008..010)
# ============================================================================
# After rebuild with src/app/parser/expr/control.spl fix, uncomment these
# and add a new describe block:
#
# describe "Match Expression Colon Separator BugFix":
#
#     it "bare colon single-expression arms":
#         val output = match 42:
#             42: "found"
#             _: "other"
#         expect output == "found"
#
#     it "bare colon multi-line arms":
#         val output = match 42:
#             42:
#                 val x = 43
#                 x
#             _:
#                 0
#         expect output == 43
#
#     it "case keyword in expression context":
#         val output = match 42:
#             case 42: "found"
#             case _: "other"
#         expect output == "found"

describe "Match Statement-Expression Consistency":

    it "expression and statement match get same answers":
        val expr_val = match 42:
            42 => "found_expr"
            _ => "other_expr"
        expect expr_val == "found_expr"
        expect match_side_effect(0) == "zero"

    it "expression match multi-line returns correct value":
        val output = match 2:
            1 =>
                100
            2 =>
                200
            _ =>
                0
        expect output == 200
