# MCP Lazy Loading v2 Tests

use std.mcp.lazy_registry_v2.{
    init_registry,
    register_handler_metadata,
    get_tool_category,
    is_category_loaded,
    mark_category_loaded,
    get_registry_stats
}
use std.mcp.category_loaders_v2.{
    load_category,
    load_fileio_category,
    is_fileio_loaded,
    is_edit_loaded
}

fn main():
    print("Testing MCP Lazy Loading v2...")
    print("")

    # Test 1: Registry initialization
    print("=== Test 1: Registry Init ===")
    init_registry()
    val stats = get_registry_stats()
    if stats.contains("0 handlers"):
        print("✓ Registry initializes empty")
    else:
        print("✗ Failed: {stats}")

    # Test 2: Handler registration
    print("\n=== Test 2: Handler Registration ===")
    register_handler_metadata("test_tool", "test_cat")
    val stats2 = get_registry_stats()
    if stats2.contains("1 handlers"):
        print("✓ Handler registered")
    else:
        print("✗ Failed: {stats2}")

    # Test 3: Category lookup
    print("\n=== Test 3: Category Lookup ===")
    val cat = get_tool_category("test_tool")
    if cat == "test_cat":
        print("✓ Category lookup works")
    else:
        print("✗ Failed: got {cat}")

    # Test 4: Category loading state
    print("\n=== Test 4: Category Loading ===")
    val not_loaded = is_category_loaded("test_cat")
    if not not_loaded:
        print("✓ Category not loaded initially")
    else:
        print("✗ Should not be loaded")

    mark_category_loaded("test_cat")
    val is_loaded = is_category_loaded("test_cat")
    if is_loaded:
        print("✓ Category marked as loaded")
    else:
        print("✗ mark_category_loaded failed")

    # Test 5: Load fileio category
    print("\n=== Test 5: Load Fileio Category ===")
    init_registry()  # Reset
    register_handler_metadata("simple_read", "fileio")

    val fileio_before = is_fileio_loaded()
    if not fileio_before:
        print("✓ Fileio not loaded initially")
    else:
        print("✗ Fileio should not be loaded")

    load_fileio_category()

    val fileio_after = is_fileio_loaded()
    if fileio_after:
        print("✓ Fileio category loaded")
    else:
        print("✗ load_fileio_category failed")

    val cat_loaded = is_category_loaded("fileio")
    if cat_loaded:
        print("✓ Category marked in registry")
    else:
        print("✗ Category not in registry")

    # Test 6: Load by category name
    print("\n=== Test 6: Load by Name ===")
    init_registry()  # Reset

    val edit_before = is_edit_loaded()
    if not edit_before:
        print("✓ Edit not loaded initially")
    else:
        print("✗ Edit should not be loaded")

    load_category("edit")

    val edit_after = is_edit_loaded()
    if edit_after:
        print("✓ Edit loaded by name")
    else:
        print("✗ load_category('edit') failed")

    # Test 7: Unknown tool
    print("\n=== Test 7: Unknown Tool ===")
    val unknown = get_tool_category("nonexistent")
    if unknown == "unknown":
        print("✓ Unknown tool returns 'unknown'")
    else:
        print("✗ Should return 'unknown', got {unknown}")

    # Test 8: Multiple registrations
    print("\n=== Test 8: Multiple Handlers ===")
    init_registry()
    register_handler_metadata("tool1", "cat1")
    register_handler_metadata("tool2", "cat1")
    register_handler_metadata("tool3", "cat2")

    val multi_stats = get_registry_stats()
    if multi_stats.contains("3 handlers"):
        print("✓ Multiple handlers registered")
    else:
        print("✗ Failed: {multi_stats}")

    val cat1_count = 0
    val tool1_cat = get_tool_category("tool1")
    val tool2_cat = get_tool_category("tool2")
    val tool3_cat = get_tool_category("tool3")

    if tool1_cat == "cat1" and tool2_cat == "cat1" and tool3_cat == "cat2":
        print("✓ All categories correct")
    else:
        print("✗ Categories wrong: {tool1_cat}, {tool2_cat}, {tool3_cat}")

    print("\n=== All v2 Tests Complete ===")

main()
