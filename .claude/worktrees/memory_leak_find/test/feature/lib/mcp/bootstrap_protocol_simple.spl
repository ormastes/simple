# Test optimized bootstrap with real JSON-RPC protocol messages
# Using stdin directly

use app.io.mod (shell)

fn main():
    print("Testing optimized bootstrap with JSON-RPC protocol...")

    # Test 1: Initialize request
    print("\n=== Test 1: Initialize ===")
    val init_msg = """Content-Length: 123\r

{"jsonrpc":"2.0","id":"1","method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{}}}"""

    val init_result = shell("echo '{init_msg}' | bin/simple src/app/mcp/bootstrap/main_optimized.spl 2>&1 | head -10")
    val init_output = init_result.stdout ?? ""

    if init_output.contains("protocolVersion"):
        print("✓ Initialize response contains protocolVersion")
    else:
        print("✗ Initialize response missing protocolVersion")
        print("Output: {init_output}")

    # Test 2: Tools/list request
    print("\n=== Test 2: Tools/list ===")
    val tools_msg = """Content-Length: 50\r

{"jsonrpc":"2.0","id":"2","method":"tools/list"}"""

    val tools_result = shell("echo '{tools_msg}' | bin/simple src/app/mcp/bootstrap/main_optimized.spl 2>&1 | head -10")
    val tools_output = tools_result.stdout ?? ""

    if tools_output.contains("tools") and tools_output.contains("["):
        print("✓ Tools/list response contains tools array")
    else:
        print("✗ Tools/list response invalid")
        print("Output: {tools_output}")

    print("\nBasic protocol tests complete!")

main()
