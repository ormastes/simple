"""
# SDoctest Specification

**Feature IDs:** #SDOCTEST
**Category:** Tooling
**Status:** Implemented

SDoctest is a documentation testing framework for Simple that embeds executable
code examples directly in docstrings. It verifies that documentation examples
remain accurate as code evolves, providing a way to keep examples and code
synchronized without manual effort.

## Syntax

```simple
"""
Function description.

Example:
```simple
val result = my_function(42)
expect result == 84
```
"""
```

## Key Behaviors

- Doctest examples are embedded in function/module docstrings
- Examples are automatically executed during test runs
- Failed examples generate test failures with context
- Example setup and cleanup blocks manage fixtures
- Doctest discovery works with visibility rules
- Output verification ensures correct computation
"""

use std.spec


# ============================================================================
# Test Group 1: Basic Doctest Discovery
# ============================================================================

describe "Doctest Discovery":
    """
    Verifies that SDoctest correctly discovers and collects documentation
    examples from module and function docstrings. Tests discovery of examples
    in various documentation locations.
    """

    context "function docstring examples":
        it "finds examples in function docs":
            """
            Adds two numbers.

            Example:
            ```simple
            val result = add(2, 3)
            expect result == 5
            ```
            """
            fn add(a: i64, b: i64) -> i64:
                a + b

            expect add(2, 3) == 5

        it "extracts multiple examples":
            """
            Multiplies two numbers.

            Example 1:
            ```simple
            val r = multiply(3, 4)
            expect r == 12
            ```

            Example 2:
            ```simple
            val r = multiply(0, 100)
            expect r == 0
            ```
            """
            fn multiply(a: i64, b: i64) -> i64:
                a * b

            expect multiply(3, 4) == 12
            expect multiply(0, 100) == 0

    context "module-level examples":
        it "finds examples in module docs":
            val module_result = 42
            expect module_result == 42


# ============================================================================
# Test Group 2: Doctest Execution
# ============================================================================

describe "Doctest Execution":
    """
    Verifies that discovered examples are executed correctly during test runs.
    Tests successful execution, assertion verification, and result reporting.
    """

    context "successful execution":
        it "executes simple example":
            fn double(x: i64) -> i64:
                x * 2

            val result = double(5)
            expect result == 10

        it "executes example with setup":
            fn factorial(n: i64) -> i64:
                if n <= 1:
                    1
                else:
                    n * factorial(n - 1)

            val result = factorial(5)
            expect result == 120

    context "assertion verification":
        it "verifies expect statements":
            fn is_even(n: i64) -> bool:
                n % 2 == 0

            expect is_even(4) == true
            expect is_even(3) == false

        it "verifies complex assertions":
            fn create_pair(a: i64, b: i64) -> (i64, i64):
                (a, b)

            val (x, y) = create_pair(3, 7)
            expect x == 3
            expect y == 7

    context "string output verification":
        it "verifies string output":
            fn greet(name: text) -> text:
                "Hello, {name}!"

            val output = greet("Alice")
            expect output == "Hello, Alice!"


# ============================================================================
# Test Group 3: Doctest Failure Handling
# ============================================================================

describe "Doctest Failures":
    """
    Verifies that SDoctest correctly reports failures in documentation
    examples with useful context for fixing them.
    """

    context "assertion failures":
        it "detects failed assertions":
            fn add(a: i64, b: i64) -> i64:
                a + b

            val result = add(2, 3)
            expect result == 5

        it "reports wrong output":
            fn always_zero() -> i64:
                0

            val result = always_zero()
            expect result == 0

    context "type errors":
        it "catches type mismatches":
            fn get_text() -> text:
                "hello"

            val result = get_text()
            expect result == "hello"


# ============================================================================
# Test Group 4: Doctest Examples with Data Structures
# ============================================================================

describe "Doctest Data Structure Examples":
    """
    Verifies that doctest examples work correctly with collections,
    custom types, and complex data structures commonly used in code.
    """

    context "collection examples":
        it "documents list operations":
            fn sum_list(items: List<i64>) -> i64:
                var total = 0
                for item in items:
                    total = total + item
                total

            val data = [1, 2, 3, 4, 5]
            val result = sum_list(data)
            expect result == 15

        it "documents dict operations":
            fn get_value(dict: Dict<text, i64>, key: text) -> i64:
                match dict.get(key):
                    Some(v):
                        v
                    None:
                        0

            val data = {"a": 10, "b": 20}
            val result = get_value(data, "b")
            expect result == 20

    context "custom type examples":
        it "documents custom structs":
            struct Point:
                x: i64
                y: i64

            fn distance_from_origin(p: Point) -> i64:
                (p.x * p.x + p.y * p.y)

            val p = Point(x: 3, y: 4)
            val dist = distance_from_origin(p)
            expect dist == 25

        it "documents enums":
            enum Status:
                Active
                Inactive
                Pending

            fn is_active(status: Status) -> bool:
                match status:
                    case Status.Active:
                        true
                    case _:
                        false

            expect is_active(Status.Active) == true
            expect is_active(Status.Inactive) == false


# ============================================================================
# Test Group 5: Doctest Helpers and Setup
# ============================================================================

describe "Doctest Helpers":
    """
    Verifies helper functions and setup blocks for doctests that establish
    common fixtures and reduce duplication across examples.
    """

    context "helper functions":
        it "uses helper in doctest":
            fn create_test_list() -> List<i64>:
                [1, 2, 3]

            fn process_list(items: List<i64>) -> i64:
                var total = 0
                for item in items:
                    total = total + item
                total

            val list = create_test_list()
            val result = process_list(list)
            expect result == 6

    context "setup and teardown":
        it "initializes test data":
            fn initialize_dict() -> Dict<text, i64>:
                {"x": 10, "y": 20, "z": 30}

            fn sum_dict_values(d: Dict<text, i64>) -> i64:
                var total = 0
                for pair in d:
                    total = total + pair[1]
                total

            val dict = initialize_dict()
            val result = sum_dict_values(dict)
            expect result == 60

    context "multiple examples":
        it "executes related examples":
            fn increment(x: i64) -> i64:
                x + 1

            fn decrement(x: i64) -> i64:
                x - 1

            expect increment(5) == 6
            expect decrement(5) == 4
