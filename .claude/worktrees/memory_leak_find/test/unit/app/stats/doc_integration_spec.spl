# Documentation Coverage Stats Integration Tests
# Tests for doc coverage integration with the stats system

use std.spec.{describe, it, expect}
use app.io.mod (process_run)

fn run_simple(args: [text]) -> (text, text, i64):
    process_run("bin/simple", args)

describe "stats command coverage output":
    it "stats shows non-zero file counts":
        val result = run_simple(["stats", "--quick"])
        val stdout = result.0
        val exit_code = result.2
        expect(exit_code).to_equal(0)
        expect(stdout.contains("Files:")).to_equal(true)

    it "stats --json returns valid JSON with documentation section":
        val result = run_simple(["stats", "--json"])
        val stdout = result.0
        val exit_code = result.2
        expect(exit_code).to_equal(0)
        expect(stdout.contains("\"documentation\"")).to_equal(true)

    it "stats --json documentation has total_public field":
        val result = run_simple(["stats", "--json"])
        val stdout = result.0
        expect(stdout.contains("\"total_public\"")).to_equal(true)

    it "stats --json documentation has non-zero total_public":
        val result = run_simple(["stats", "--json"])
        val stdout = result.0
        # total_public should not be 0 in a real project
        val has_nonzero = not stdout.contains("\"total_public\": 0")
        expect(has_nonzero).to_equal(true)

    it "stats --json has per_scope section":
        val result = run_simple(["stats", "--json"])
        val stdout = result.0
        expect(stdout.contains("\"per_scope\"")).to_equal(true)

    it "stats --json per_scope has std section":
        val result = run_simple(["stats", "--json"])
        val stdout = result.0
        expect(stdout.contains("\"std\"")).to_equal(true)

    it "stats --json per_scope has core section":
        val result = run_simple(["stats", "--json"])
        val stdout = result.0
        expect(stdout.contains("\"core\"")).to_equal(true)

    it "stats --json lib documented field is not always 100 percent":
        val result = run_simple(["stats", "--json"])
        val stdout = result.0
        # The old bug always showed lib at 100% - verify the field exists
        expect(stdout.contains("\"lib\"")).to_equal(true)

describe "stats JSON export format":
    it "stats --json outputs valid JSON braces":
        val result = run_simple(["stats", "--json"])
        val stdout = result.0
        expect(stdout.starts_with("{")).to_equal(true)
        expect(stdout.ends_with("}")).to_equal(true)

    it "stats --json has files section":
        val result = run_simple(["stats", "--json"])
        val stdout = result.0
        expect(stdout.contains("\"files\"")).to_equal(true)

    it "stats --json has tests section":
        val result = run_simple(["stats", "--json"])
        val stdout = result.0
        expect(stdout.contains("\"tests\"")).to_equal(true)

    it "stats --json has features section":
        val result = run_simple(["stats", "--json"])
        val stdout = result.0
        expect(stdout.contains("\"features\"")).to_equal(true)

    it "stats --json has lines section":
        val result = run_simple(["stats", "--json"])
        val stdout = result.0
        expect(stdout.contains("\"lines\"")).to_equal(true)
