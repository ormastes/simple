"""
Server Method Routing Tests
Tests all JSON-RPC method routing branches in MCP server
"""

use std.spec
use app.mcp.helpers.{LB, RB, jp, js, jo1, jo2, extract_json_string, make_result_response, make_error_response}

describe "Server Method Routing":
    describe "Core Protocol Methods":
        it "routes initialize method":
            val req = jo2(jp("method", js("initialize")), jp("id", "1"))
            val method = extract_json_string(req, "method")
            expect(method).to_equal("initialize")

        it "routes initialized notification":
            val req = jo1(jp("method", js("initialized")))
            val method = extract_json_string(req, "method")
            expect(method).to_equal("initialized")

        it "routes ping method":
            val req = jo2(jp("method", js("ping")), jp("id", "2"))
            val method = extract_json_string(req, "method")
            expect(method).to_equal("ping")

        it "routes shutdown method":
            val req = jo2(jp("method", js("shutdown")), jp("id", "3"))
            val method = extract_json_string(req, "method")
            expect(method).to_equal("shutdown")

    describe "Resource Methods":
        it "routes resources/list":
            val req = jo2(jp("method", js("resources/list")), jp("id", "4"))
            val method = extract_json_string(req, "method")
            expect(method).to_equal("resources/list")

        it "routes resources/read":
            val req = jo2(jp("method", js("resources/read")), jp("id", "5"))
            val method = extract_json_string(req, "method")
            expect(method).to_equal("resources/read")

    describe "Tool Methods":
        it "routes tools/list":
            val req = jo2(jp("method", js("tools/list")), jp("id", "6"))
            val method = extract_json_string(req, "method")
            expect(method).to_equal("tools/list")

        it "routes tools/call":
            val req = jo2(jp("method", js("tools/call")), jp("id", "7"))
            val method = extract_json_string(req, "method")
            expect(method).to_equal("tools/call")

    describe "Prompt Methods":
        it "routes prompts/list":
            val req = jo2(jp("method", js("prompts/list")), jp("id", "8"))
            val method = extract_json_string(req, "method")
            expect(method).to_equal("prompts/list")

        it "routes prompts/get":
            val req = jo2(jp("method", js("prompts/get")), jp("id", "9"))
            val method = extract_json_string(req, "method")
            expect(method).to_equal("prompts/get")

    describe "Unknown Methods":
        it "handles unknown method":
            val method = "unknown/method"
            val is_known = method == "initialize" or method == "ping" or method == "shutdown"
            expect(is_known).to_equal(false)

    describe "Method Category Checks":
        it "identifies resource methods":
            val method = "resources/list"
            val is_resource = method.starts_with("resources/")
            expect(is_resource).to_equal(true)

        it "identifies tool methods":
            val method = "tools/call"
            val is_tool = method.starts_with("tools/")
            expect(is_tool).to_equal(true)

        it "identifies prompt methods":
            val method = "prompts/get"
            val is_prompt = method.starts_with("prompts/")
            expect(is_prompt).to_equal(true)
