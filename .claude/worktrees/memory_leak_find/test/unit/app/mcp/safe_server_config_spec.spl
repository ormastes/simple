"""
SafeMcpServer Configuration Tests
Tests strict validation flag, debug mode, and log file configuration
"""

use std.spec
use app.mcp.helpers.{LB, RB, jp, js, jo1, jo2, jo3, make_result_response, make_error_response, escape_json}
use app.mcp.{default_validation_limits, strict_validation_limits, input_validator}

describe "SafeMcpServer Configuration":
    describe "Strict Validation Flag":
        it "enables strict validation":
            val limits = strict_validation_limits()
            val strict_mode = limits.max_content_length < 1048576
            expect(strict_mode).to_equal(true)

        it "disables strict validation":
            val limits = default_validation_limits()
            val not_strict = limits.max_content_length >= 1048576
            expect(not_strict).to_equal(true)

        it "applies strict rules when enabled":
            val limits = strict_validation_limits()
            val validator = input_validator()
            val result = validator.validate_content_length(100)
            expect(result).to_be_nil()

    describe "Debug Mode":
        it "enables debug mode":
            val response = make_result_response("1", jo1(jp("debug", "true")))
            expect(response.contains("debug")).to_equal(true)

        it "disables debug mode":
            val response = make_result_response("1", jo1(jp("debug", "false")))
            expect(response.contains("false")).to_equal(true)

        it "combines debug and strict flags":
            val limits = strict_validation_limits()
            val response = make_result_response("1", jo2(jp("debug", "true"), jp("strict", "true")))
            expect(response.contains("debug")).to_equal(true)
            expect(response.contains("strict")).to_equal(true)

    describe "Log File Configuration":
        it "uses specified log file":
            val log_path = "/tmp/mcp.log"
            val config = jo1(jp("log_file", js(log_path)))
            expect(config.contains("mcp.log")).to_equal(true)

        it "uses default log file":
            val log_file = ""
            val file_logging = log_file.len() > 0
            expect(file_logging).to_equal(false)

        it "creates log directory if missing":
            val dir_path = "/tmp/logs"
            val config = jo1(jp("log_dir", js(dir_path)))
            expect(config.contains("logs")).to_equal(true)

    describe "run_safe_mcp_server":
        it "initializes with all config":
            val config = jo3(jp("name", js("test-mcp")), jp("version", js("1.0")), jp("debug", "true"))
            expect(config.contains("test-mcp")).to_equal(true)
            expect(config.contains("1.0")).to_equal(true)

        it "initializes with minimal config":
            val config = jo1(jp("name", js("mcp")))
            expect(config.contains("mcp")).to_equal(true)

        it "handles initialization failure":
            val response = make_error_response("1", -32603, "Init failed")
            expect(response.contains("-32603")).to_equal(true)
            expect(response.contains("Init failed")).to_equal(true)

        it "runs server successfully":
            val response = make_result_response("1", jo1(jp("status", js("running"))))
            expect(response.contains("running")).to_equal(true)

    describe "Configuration Validation":
        it "validates required fields":
            val config = jo2(jp("name", js("mcp")), jp("version", js("1.0")))
            val has_name = config.contains("name")
            val has_version = config.contains("version")
            expect(has_name).to_equal(true)
            expect(has_version).to_equal(true)

        it "rejects invalid config":
            val response = make_error_response("1", -32602, "Missing required field")
            expect(response.contains("Missing required field")).to_equal(true)
