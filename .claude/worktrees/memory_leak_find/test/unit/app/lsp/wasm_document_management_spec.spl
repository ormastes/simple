# WASM LSP Document Management Tests
#
# Tests core parser parsing of various document patterns.
# Validates error detection for bracket mismatches.

use app.lsp.parser_adapter.{ParserAdapter, ParserAdapter__create_core, ParseResult, ParseDiagnostic}

describe "WASM Document Management":

    context "Parsing Simple documents":
        it "parses simple variable declaration":
            val adapter = ParserAdapter__create_core()
            val result = adapter.parse("val name = \"Alice\"")
            expect(result.success).to_equal(true)

        it "parses mutable variable":
            val adapter = ParserAdapter__create_core()
            val result = adapter.parse("var count = 0")
            expect(result.success).to_equal(true)

        it "parses function with body":
            val adapter = ParserAdapter__create_core()
            val code = "fn square(x: i64) -> i64:\n    x * x"
            val result = adapter.parse(code)
            expect(result.success).to_equal(true)

        it "parses empty string":
            val adapter = ParserAdapter__create_core()
            val result = adapter.parse("")
            expect(result.success).to_equal(true)

        it "parses whitespace only":
            val adapter = ParserAdapter__create_core()
            val result = adapter.parse("   \n   \n")
            expect(result.success).to_equal(true)

    context "Bracket error detection":
        it "reports error line for unmatched paren":
            val adapter = ParserAdapter__create_core()
            val result = adapter.parse("val x = )")
            expect(result.diagnostics.len()).to_be_greater_than(0)
            expect(result.diagnostics[0].line).to_equal(0)
            expect(result.diagnostics[0].severity).to_equal(1)

        it "reports error for unmatched bracket":
            val adapter = ParserAdapter__create_core()
            val result = adapter.parse("val arr = ]")
            expect(result.diagnostics.len()).to_be_greater_than(0)
            expect(result.diagnostics[0].line).to_equal(0)

        it "handles nested brackets correctly":
            val adapter = ParserAdapter__create_core()
            val result = adapter.parse("val x = [[1, 2], [3, 4]]")
            expect(result.success).to_equal(true)

        it "handles mixed brackets and parens":
            val adapter = ParserAdapter__create_core()
            val result = adapter.parse("val x = foo([1, 2], (3 + 4))")
            expect(result.success).to_equal(true)

    context "Multi-line document parsing":
        it "parses describe/it test blocks":
            val adapter = ParserAdapter__create_core()
            val code = "describe \"test\":\n    it \"works\":\n        expect(1).to_equal(1)"
            val result = adapter.parse(code)
            expect(result.success).to_equal(true)

        it "parses class with methods":
            val adapter = ParserAdapter__create_core()
            val code = "class Counter:\n    count: i64\n    me increment():\n        self.count = self.count + 1"
            val result = adapter.parse(code)
            expect(result.success).to_equal(true)

        it "parses enum definitions":
            val adapter = ParserAdapter__create_core()
            val code = "enum Color:\n    Red\n    Green\n    Blue"
            val result = adapter.parse(code)
            expect(result.success).to_equal(true)

    context "Diagnostic properties":
        it "diagnostic has correct message for paren":
            val adapter = ParserAdapter__create_core()
            val result = adapter.parse(")")
            expect(result.diagnostics[0].message).to_contain("parenthesis")

        it "diagnostic has correct message for bracket":
            val adapter = ParserAdapter__create_core()
            val result = adapter.parse("]")
            expect(result.diagnostics[0].message).to_contain("bracket")

        it "diagnostic has error severity":
            val adapter = ParserAdapter__create_core()
            val result = adapter.parse(")")
            expect(result.diagnostics[0].severity).to_equal(1)
