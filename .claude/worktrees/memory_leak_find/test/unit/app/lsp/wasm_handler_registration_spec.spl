# WASM LSP Handler Registration Tests
#
# Tests ParserAdapter backend selection and mode detection.
# Validates that WASM mode correctly falls back to core parser.

use app.lsp.parser_adapter.{ParserBackend, ParserAdapter, ParserAdapter__create_core, ParserAdapter__create_treesitter}

describe "WASM Handler Registration":

    context "Backend selection":
        it "core parser is WASM mode":
            val adapter = ParserAdapter__create_core()
            expect(adapter.is_wasm_mode()).to_equal(true)

        it "treesitter is not WASM mode":
            val adapter = ParserAdapter__create_treesitter()
            expect(adapter.is_wasm_mode()).to_equal(false)

        it "core parser backend enum value":
            val adapter = ParserAdapter__create_core()
            expect(adapter.backend).to_equal(ParserBackend.CoreParser)

        it "treesitter backend enum value":
            val adapter = ParserAdapter__create_treesitter()
            expect(adapter.backend).to_equal(ParserBackend.TreeSitter)

    context "Parser mode handling":
        it "core parser handles function definitions":
            val adapter = ParserAdapter__create_core()
            val result = adapter.parse("fn hello():\n    print \"hi\"")
            expect(result.success).to_equal(true)

        it "core parser handles class definitions":
            val adapter = ParserAdapter__create_core()
            val result = adapter.parse("class Foo:\n    x: i64")
            expect(result.success).to_equal(true)

        it "core parser handles struct definitions":
            val adapter = ParserAdapter__create_core()
            val result = adapter.parse("struct Point:\n    x: i64\n    y: i64")
            expect(result.success).to_equal(true)

        it "core parser handles import statements":
            val adapter = ParserAdapter__create_core()
            val result = adapter.parse("use std.text.\n")
            expect(result.success).to_equal(true)

    context "Error detection in WASM mode":
        it "detects extra closing paren":
            val adapter = ParserAdapter__create_core()
            val result = adapter.parse("fn foo(x)): pass")
            expect(result.success).to_equal(false)

        it "detects extra closing bracket":
            val adapter = ParserAdapter__create_core()
            val result = adapter.parse("val arr = [1, 2]]")
            expect(result.success).to_equal(false)

        it "does not report errors on valid code":
            val adapter = ParserAdapter__create_core()
            val result = adapter.parse("val x = [1, 2, 3]")
            expect(result.success).to_equal(true)

    context "TreeSitter adapter fallback":
        it "treesitter parse returns success for any input":
            val adapter = ParserAdapter__create_treesitter()
            # TreeSitter path returns default success (actual parsing done elsewhere)
            val result = adapter.parse("val x = 1")
            expect(result.success).to_equal(true)
            expect(result.diagnostics.len()).to_equal(0)
