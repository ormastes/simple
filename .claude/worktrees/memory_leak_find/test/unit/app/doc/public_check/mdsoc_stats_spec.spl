# MDSOC Statistics Integration Tests
# Tests coverage statistics for MDSOC CapsuleVisibility.Public exports

use std.spec.{describe, it, expect}
use app.doc.public_check.statistics.{
    MdsocCoverageStats,
    calculate_mdsoc_coverage,
    format_mdsoc_report,
    mdsoc_stats_to_json
}

describe "MDSOC Coverage Statistics":
    it "calculates coverage for Public exports":
        val public_exports = ["sort", "map", "filter"]
        val documented = ["sort", "map"]
        val violations = ["filter: missing documentation"]

        val stats = calculate_mdsoc_coverage(
            "array_capsule",
            public_exports,
            documented,
            violations
        )

        expect(stats.capsule_name).to_equal("array_capsule")
        expect(stats.total_public_exports).to_equal(3)
        expect(stats.documented_public_exports).to_equal(2)
        expect(stats.undocumented_public_exports).to_equal(1)

        # Coverage should be 66.6% (2/3)
        expect(stats.coverage_percentage).to_be_greater_than(66.0)
        expect(stats.coverage_percentage).to_be_less_than(67.0)

    it "handles 100% coverage":
        val public_exports = ["sort", "map"]
        val documented = ["sort", "map"]
        val violations: [text] = []

        val stats = calculate_mdsoc_coverage(
            "perfect_capsule",
            public_exports,
            documented,
            violations
        )

        expect(stats.coverage_percentage).to_equal(100.0)
        expect(stats.undocumented_public_exports).to_equal(0)
        expect(stats.doc_violations.len()).to_equal(0)

    it "handles 0% coverage":
        val public_exports = ["sort", "map", "filter"]
        val documented: [text] = []
        val violations = [
            "sort: missing documentation",
            "map: missing documentation",
            "filter: missing documentation"
        ]

        val stats = calculate_mdsoc_coverage(
            "bad_capsule",
            public_exports,
            documented,
            violations
        )

        expect(stats.coverage_percentage).to_equal(0.0)
        expect(stats.undocumented_public_exports).to_equal(3)
        expect(stats.doc_violations.len()).to_equal(3)

    it "handles empty capsule":
        val public_exports: [text] = []
        val documented: [text] = []
        val violations: [text] = []

        val stats = calculate_mdsoc_coverage(
            "empty_capsule",
            public_exports,
            documented,
            violations
        )

        expect(stats.total_public_exports).to_equal(0)
        expect(stats.coverage_percentage).to_equal(0.0)

    it "formats MDSOC report":
        val public_exports = ["sort", "map"]
        val documented = ["sort"]
        val violations = ["map: missing documentation at src/array/mod.spl:42"]

        val stats = calculate_mdsoc_coverage(
            "array_capsule",
            public_exports,
            documented,
            violations
        )

        val report = format_mdsoc_report(stats)

        expect(report).to_contain("array_capsule")
        expect(report).to_contain("Public exports:")
        expect(report).to_contain("2")
        expect(report).to_contain("Documented:")
        expect(report).to_contain("1")
        expect(report).to_contain("Undocumented:")
        expect(report).to_contain("1")
        expect(report).to_contain("Documentation Violations:")
        expect(report).to_contain("map: missing documentation")

    it "converts MDSOC stats to JSON":
        val public_exports = ["sort"]
        val documented = ["sort"]
        val violations: [text] = []

        val stats = calculate_mdsoc_coverage(
            "test_capsule",
            public_exports,
            documented,
            violations
        )

        val json = mdsoc_stats_to_json(stats)

        expect(json).to_contain("capsule_name")
        expect(json).to_contain("test_capsule")
        expect(json).to_contain("total_public_exports")
        expect(json).to_contain("1")
        expect(json).to_contain("coverage_percentage")
        expect(json).to_contain("100")
        expect(json).to_contain("violations")

    it "includes violations in JSON":
        val public_exports = ["a", "b"]
        val documented: [text] = []
        val violations = ["a: missing docs", "b: missing docs"]

        val stats = calculate_mdsoc_coverage(
            "test",
            public_exports,
            documented,
            violations
        )

        val json = mdsoc_stats_to_json(stats)

        expect(json).to_contain("a: missing docs")
        expect(json).to_contain("b: missing docs")
