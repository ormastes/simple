# Graceful Shutdown Specification
# Tests for shutdown coordinator

use std.spec.{describe, it, expect}
use app.test_runner_new.shutdown.{EXIT_SUCCESS, EXIT_FAILURE, EXIT_RESOURCE_SHUTDOWN, EXIT_RECOVERY_FAILED}
use app.test_runner_new.shutdown.{shutdown_format_summary}

describe "exit codes":
    it "should have distinct exit codes":
        expect(EXIT_SUCCESS).to_equal(0)
        expect(EXIT_FAILURE).to_equal(1)
        expect(EXIT_RESOURCE_SHUTDOWN).to_equal(42)
        expect(EXIT_RECOVERY_FAILED).to_equal(43)

        # All codes should be different
        val all_different = EXIT_SUCCESS != EXIT_FAILURE
        val diff2 = EXIT_SUCCESS != EXIT_RESOURCE_SHUTDOWN
        val diff3 = EXIT_SUCCESS != EXIT_RECOVERY_FAILED
        val diff4 = EXIT_FAILURE != EXIT_RESOURCE_SHUTDOWN
        val diff5 = EXIT_FAILURE != EXIT_RECOVERY_FAILED
        val diff6 = EXIT_RESOURCE_SHUTDOWN != EXIT_RECOVERY_FAILED

        expect(all_different).to_equal(true)
        expect(diff2).to_equal(true)
        expect(diff3).to_equal(true)
        expect(diff4).to_equal(true)
        expect(diff5).to_equal(true)
        expect(diff6).to_equal(true)

describe "shutdown_format_summary":
    it "should format summary with all fields":
        val summary = shutdown_format_summary("cpu", [], 10, 2, 3)

        expect(summary.contains("cpu")).to_equal(true)
        expect(summary.contains("10")).to_equal(true)
        expect(summary.contains("2")).to_equal(true)
        expect(summary.contains("3")).to_equal(true)

    it "should include reason in summary":
        val summary = shutdown_format_summary("memory", [], 0, 0, 0)

        expect(summary.contains("memory")).to_equal(true)

    it "should format with multiple completed files":
        val completed = ["a.spl", "b.spl", "c.spl"]
        val summary = shutdown_format_summary("cpu", completed, 5, 1, 2)

        expect(summary.contains("3")).to_equal(true)  # 3 completed files

    it "should handle empty completed list":
        val completed: [text] = []
        val summary = shutdown_format_summary("periodic", completed, 0, 0, 0)

        expect(summary.contains("0")).to_equal(true)

    it "should include passed count":
        val summary = shutdown_format_summary("test", [], 42, 0, 0)

        expect(summary.contains("42")).to_equal(true)

    it "should include failed count":
        val summary = shutdown_format_summary("test", [], 0, 7, 0)

        expect(summary.contains("7")).to_equal(true)

    it "should include skipped count":
        val summary = shutdown_format_summary("test", [], 0, 0, 9)

        expect(summary.contains("9")).to_equal(true)

# NOTE: We cannot test shutdown_graceful() directly because it calls exit(42)
# which would terminate the test process. Integration tests should verify
# the full shutdown sequence in a separate process.
