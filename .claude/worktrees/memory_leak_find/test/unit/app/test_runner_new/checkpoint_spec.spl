# Checkpoint Manager Specification
# Tests for checkpoint save/load/resume functionality

use std.spec.{describe, it, expect, after_each}
use app.test_runner_new.checkpoint.{Checkpoint, checkpoint_save, checkpoint_load}
use app.test_runner_new.checkpoint.{checkpoint_exists, checkpoint_delete, checkpoint_skip_completed}
use app.test_runner_new.checkpoint.{make_empty_checkpoint}
use app.io.mod.{file_exists, file_read, file_delete}

describe "Checkpoint struct":
    it "should create checkpoint with all fields":
        val ckpt = Checkpoint(
            timestamp_ms: 1739530800000,
            completed_files: ["test1.spl", "test2.spl"],
            total_passed: 10,
            total_failed: 2,
            total_skipped: 3,
            shutdown_reason: "memory"
        )

        expect(ckpt.timestamp_ms).to_equal(1739530800000)
        expect(ckpt.completed_files.len()).to_equal(2)
        expect(ckpt.total_passed).to_equal(10)
        expect(ckpt.total_failed).to_equal(2)
        expect(ckpt.total_skipped).to_equal(3)
        expect(ckpt.shutdown_reason).to_equal("memory")

describe "make_empty_checkpoint":
    it "should create empty checkpoint":
        val ckpt = make_empty_checkpoint()

        expect(ckpt.timestamp_ms).to_equal(0)
        expect(ckpt.completed_files.len()).to_equal(0)
        expect(ckpt.total_passed).to_equal(0)
        expect(ckpt.total_failed).to_equal(0)
        expect(ckpt.total_skipped).to_equal(0)
        expect(ckpt.shutdown_reason).to_equal("")

describe "checkpoint_save and load":
    after_each:
        # Clean up checkpoint file after each test
        if file_exists(".simple-test-checkpoint.sdn"):
            file_delete(".simple-test-checkpoint.sdn")

    it "should save checkpoint to file":
        val completed = ["test/unit/a.spl", "test/unit/b.spl"]
        checkpoint_save(completed, 5, 1, 2, "cpu")

        val exists = file_exists(".simple-test-checkpoint.sdn")
        expect(exists).to_equal(true)

    it "should save valid SDN format":
        val completed = ["file1.spl"]
        checkpoint_save(completed, 10, 0, 0, "periodic")

        val content = file_read(".simple-test-checkpoint.sdn")

        # Check for expected SDN structure
        expect(content.contains("checkpoint {")).to_equal(true)
        expect(content.contains("timestamp_ms")).to_equal(true)
        expect(content.contains("completed_files")).to_equal(true)
        expect(content.contains("total_passed")).to_equal(true)

    it "should load saved checkpoint":
        val completed = ["test/unit/x.spl", "test/unit/y.spl"]
        checkpoint_save(completed, 15, 3, 5, "memory")

        val loaded = checkpoint_load()

        expect(loaded.completed_files.len()).to_equal(2)
        expect(loaded.completed_files[0]).to_equal("test/unit/x.spl")
        expect(loaded.completed_files[1]).to_equal("test/unit/y.spl")
        expect(loaded.total_passed).to_equal(15)
        expect(loaded.total_failed).to_equal(3)
        expect(loaded.total_skipped).to_equal(5)
        expect(loaded.shutdown_reason).to_equal("memory")

describe "checkpoint_skip_completed":
    it "should return all files when checkpoint empty":
        val all_files = ["a.spl", "b.spl", "c.spl"]
        val ckpt = make_empty_checkpoint()

        val remaining = checkpoint_skip_completed(all_files, ckpt)

        expect(remaining.len()).to_equal(3)

    it "should filter out completed files":
        val all_files = ["test/a.spl", "test/b.spl", "test/c.spl", "test/d.spl"]
        val ckpt = Checkpoint(
            timestamp_ms: 0,
            completed_files: ["test/a.spl", "test/c.spl"],
            total_passed: 0,
            total_failed: 0,
            total_skipped: 0,
            shutdown_reason: ""
        )

        val remaining = checkpoint_skip_completed(all_files, ckpt)

        expect(remaining.len()).to_equal(2)
        expect(remaining[0]).to_equal("test/b.spl")
        expect(remaining[1]).to_equal("test/d.spl")

    it "should return empty when all completed":
        val all_files = ["x.spl", "y.spl"]
        val ckpt = Checkpoint(
            timestamp_ms: 0,
            completed_files: ["x.spl", "y.spl"],
            total_passed: 0,
            total_failed: 0,
            total_skipped: 0,
            shutdown_reason: ""
        )

        val remaining = checkpoint_skip_completed(all_files, ckpt)

        expect(remaining.len()).to_equal(0)
