# System Monitor Specification
# Tests for system-wide resource monitoring

use std.spec.{describe, it, expect}
use app.test_runner_new.system_monitor.{SystemResources, get_system_resources, system_exceeds_threshold}
use app.test_runner_new.system_monitor.{get_system_cpu_percent, get_system_memory_percent}

describe "SystemResources":
    it "should have required fields":
        val res = SystemResources(
            cpu_percent: 25.5,
            memory_percent: 60.0,
            memory_used_mb: 3072,
            memory_total_mb: 8192
        )

        expect(res.cpu_percent).to_equal(25.5)
        expect(res.memory_percent).to_equal(60.0)
        expect(res.memory_used_mb).to_equal(3072)
        expect(res.memory_total_mb).to_equal(8192)

describe "get_system_resources":
    it "should return valid SystemResources":
        val res = get_system_resources()

        # CPU should be 0-100
        expect(res.cpu_percent >= 0.0).to_equal(true)
        expect(res.cpu_percent <= 100.0).to_equal(true)

        # Memory should be 0-100
        expect(res.memory_percent >= 0.0).to_equal(true)
        expect(res.memory_percent <= 100.0).to_equal(true)

        # Memory values should be non-negative
        expect(res.memory_used_mb >= 0).to_equal(true)
        expect(res.memory_total_mb >= 0).to_equal(true)

    it "should return reasonable memory values":
        val res = get_system_resources()

        # Total memory should be at least 100MB (even on minimal systems)
        expect(res.memory_total_mb >= 100).to_equal(true)

        # Used memory should not exceed total
        expect(res.memory_used_mb <= res.memory_total_mb).to_equal(true)

describe "get_system_cpu_percent":
    it "should return value in 0-100 range":
        val cpu = get_system_cpu_percent()

        expect(cpu >= 0.0).to_equal(true)
        expect(cpu <= 100.0).to_equal(true)

describe "get_system_memory_percent":
    it "should return value in 0-100 range":
        val mem = get_system_memory_percent()

        expect(mem >= 0.0).to_equal(true)
        expect(mem <= 100.0).to_equal(true)

describe "system_exceeds_threshold":
    it "should return false when under threshold":
        # Use very high thresholds (999%) that should never be exceeded
        val (violated, reason) = system_exceeds_threshold(999.0, 999.0)

        expect(violated).to_equal(false)
        expect(reason).to_equal("")

    it "should return true when CPU exceeds threshold":
        # Use 0% threshold - should always be exceeded
        val (violated, reason) = system_exceeds_threshold(0.0, 999.0)

        # This might be true or false depending on system state
        # Just verify the return format is correct
        val is_bool = violated == true or violated == false
        expect(is_bool).to_equal(true)

        if violated:
            expect(reason).to_equal("cpu")

    it "should return true when memory exceeds threshold":
        # Use 0% threshold for memory
        val (violated, reason) = system_exceeds_threshold(999.0, 0.0)

        # Verify return format
        val is_bool = violated == true or violated == false
        expect(is_bool).to_equal(true)

        if violated:
            expect(reason).to_equal("memory")

    it "should check CPU before memory":
        # If both thresholds are 0%, CPU should be checked first
        val (violated, reason) = system_exceeds_threshold(0.0, 0.0)

        if violated:
            # Reason should be "cpu" since CPU is checked first
            expect(reason == "cpu" or reason == "memory").to_equal(true)
