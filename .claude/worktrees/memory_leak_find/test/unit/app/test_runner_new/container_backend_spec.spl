# Container Backend Spec
#
# Tests for container-based test execution using Docker/Podman.

use std.spec.{describe, it, expect}
use test_runner_container.{
    container_detect_runtime,
    container_check_image,
    container_get_version,
    container_cleanup_volumes
}
use app.io.mod (shell_bool)

describe "container_detect_runtime":
    it "detects docker when available":
        val runtime = container_detect_runtime()
        val has_docker = shell_bool("docker --version")
        val has_podman = shell_bool("podman --version")

        if has_docker:
            expect(runtime).to_equal("docker")
        elif has_podman:
            expect(runtime).to_equal("podman")
        else:
            expect(runtime).to_equal("none")

    it "returns none when no container runtime installed":
        val runtime = container_detect_runtime()
        if runtime == "none":
            expect(runtime).to_equal("none")
        else:
            # Either docker or podman is installed
            val has_runtime = runtime == "docker" or runtime == "podman"
            expect(has_runtime).to_equal(true)

describe "container_get_version":
    it "gets docker version when available":
        val has_docker = shell_bool("docker --version")
        if has_docker:
            val version = container_get_version("docker")
            expect(version).to_contain("Docker")
        else:
            expect(true).to_equal(true)

    it "gets podman version when available":
        val has_podman = shell_bool("podman --version")
        if has_podman:
            val version = container_get_version("podman")
            expect(version).to_contain("podman")
        else:
            expect(true).to_equal(true)

    it "returns empty string for unknown runtime":
        val version = container_get_version("unknown")
        expect(version).to_equal("")

describe "container_check_image":
    it "returns false for non-existent image with docker":
        val has_docker = shell_bool("docker --version")
        if has_docker:
            val exists = container_check_image("nonexistent-image:999", "docker")
            expect(exists).to_equal(false)
        else:
            expect(true).to_equal(true)

    it "returns false for non-existent image with podman":
        val has_podman = shell_bool("podman --version")
        if has_podman:
            val exists = container_check_image("nonexistent-image:999", "podman")
            expect(exists).to_equal(false)
        else:
            expect(true).to_equal(true)

    it "returns false for unknown runtime":
        val exists = container_check_image("any-image", "unknown")
        expect(exists).to_equal(false)

describe "container_cleanup_volumes":
    it "returns false for unknown runtime":
        val result = container_cleanup_volumes("unknown")
        expect(result).to_equal(false)

    it "attempts cleanup with docker when available":
        val has_docker = shell_bool("docker --version")
        if has_docker:
            val result = container_cleanup_volumes("docker")
            # Should return true or false, not crash
            val is_bool = result == true or result == false
            expect(is_bool).to_equal(true)
        else:
            expect(true).to_equal(true)
