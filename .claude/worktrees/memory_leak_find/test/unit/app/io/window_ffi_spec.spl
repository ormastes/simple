"""
Feature: Winit Windowing System SFFI Wrapper
Category: GUI, Windowing, FFI
Status: Implemented

Tests for the Winit cross-platform windowing SFFI wrapper.
Covers event loop, window creation, events, input handling, and monitor info.
"""

use app.io.window_ffi.{
    EventLoop, window_create_event_loop, window_destroy_event_loop,
    window_poll_events, window_wait_events, EventBatch,
    WindowConfig, window_config_default,
    Window, window_create, window_create_with_config, window_destroy,
    Size, Position,
    window_get_size, window_set_size, window_get_position, window_set_position,
    window_get_inner_size, window_get_outer_size,
    window_set_min_size, window_set_max_size,
    window_set_title, window_set_visible, window_is_visible,
    window_set_resizable, window_set_minimized, window_set_maximized, window_is_maximized,
    window_set_fullscreen, window_is_fullscreen,
    window_set_decorations, window_set_always_on_top,
    window_focus, window_request_redraw,
    window_id, window_scale_factor,
    window_set_cursor_visible, window_set_cursor_grab, window_set_cursor_position,
    EventType, Event, event_get_type_code, event_parse_type, event_destroy,
    event_window_resized, event_window_moved, event_window_focused, event_window_scale_factor,
    KeyState, VirtualKey, KeyboardEvent, event_keyboard_input, event_received_character,
    MouseButton, MouseButtonEvent, event_mouse_button,
    MousePosition, event_mouse_moved, MouseWheel, event_mouse_wheel,
    Monitor, window_get_monitor_count, window_get_monitor_info,
    window_clipboard_get, window_clipboard_set
}

describe "EventLoop":
    """
    Tests for event loop creation and management.
    """
    it "creates event loop":
        val event_loop = window_create_event_loop()
        expect(event_loop.is_valid).to_equal(true)
        window_destroy_event_loop(event_loop)

    it "destroys event loop":
        val event_loop = window_create_event_loop()
        val success = window_destroy_event_loop(event_loop)
        expect(success).to_equal(true)

    it "polls events with max limit":
        val event_loop = window_create_event_loop()
        val events = window_poll_events(event_loop, 50)
        expect(events.count).to_equal(50)
        window_destroy_event_loop(event_loop)

    it "waits for events with timeout":
        val event_loop = window_create_event_loop()
        val events = window_wait_events(event_loop, 100)
        # Should return even with no events after timeout
        expect(events.count).to_be_greater_than(0)
        window_destroy_event_loop(event_loop)

describe "WindowConfig":
    """
    Tests for window configuration structure.
    """
    it "creates default config":
        val config = window_config_default()
        expect(config.width).to_equal(800)
        expect(config.height).to_equal(600)
        expect(config.title).to_equal("Simple Window")
        expect(config.resizable).to_equal(true)
        expect(config.visible).to_equal(true)

    it "allows config customization":
        var config = window_config_default()
        config.width = 1024
        config.height = 768
        config.title = "Custom Window"
        config.fullscreen = true

        expect(config.width).to_equal(1024)
        expect(config.height).to_equal(768)
        expect(config.title).to_equal("Custom Window")
        expect(config.fullscreen).to_equal(true)

describe "Window Creation":
    """
    Tests for window creation and destruction.
    """
    it "creates window with basic parameters":
        val event_loop = window_create_event_loop()
        val window = window_create(event_loop, 800, 600, "Test Window")
        expect(window.is_valid).to_equal(true)
        window_destroy(window)
        window_destroy_event_loop(event_loop)

    it "creates window with config":
        val event_loop = window_create_event_loop()
        var config = window_config_default()
        config.width = 1024
        config.height = 768
        val window = window_create_with_config(event_loop, config)
        expect(window.is_valid).to_equal(true)
        window_destroy(window)
        window_destroy_event_loop(event_loop)

    it "destroys window":
        val event_loop = window_create_event_loop()
        val window = window_create(event_loop, 640, 480, "Test")
        val success = window_destroy(window)
        expect(success).to_equal(true)
        window_destroy_event_loop(event_loop)

    it "has unique window ID":
        val event_loop = window_create_event_loop()
        val window = window_create(event_loop, 800, 600, "Test")
        val id = window_id(window)
        expect(id).to_be_greater_than(0)
        window_destroy(window)
        window_destroy_event_loop(event_loop)

describe "Window Size":
    """
    Tests for window size management.
    """
    it "gets window size":
        val event_loop = window_create_event_loop()
        val window = window_create(event_loop, 800, 600, "Test")
        val size = window_get_size(window)
        expect(size.width).to_equal(800)
        expect(size.height).to_equal(600)
        window_destroy(window)
        window_destroy_event_loop(event_loop)

    it "sets window size":
        val event_loop = window_create_event_loop()
        val window = window_create(event_loop, 800, 600, "Test")
        val new_size = Size(width: 1024, height: 768)
        val success = window_set_size(window, new_size)
        expect(success).to_equal(true)

        val updated_size = window_get_size(window)
        expect(updated_size.width).to_equal(1024)
        expect(updated_size.height).to_equal(768)
        window_destroy(window)
        window_destroy_event_loop(event_loop)

    it "gets inner size":
        val event_loop = window_create_event_loop()
        val window = window_create(event_loop, 800, 600, "Test")
        val inner_size = window_get_inner_size(window)
        # Inner size should be positive
        expect(inner_size.width).to_be_greater_than(0)
        expect(inner_size.height).to_be_greater_than(0)
        window_destroy(window)
        window_destroy_event_loop(event_loop)

    it "gets outer size":
        val event_loop = window_create_event_loop()
        val window = window_create(event_loop, 800, 600, "Test")
        val outer_size = window_get_outer_size(window)
        # Outer size includes decorations
        expect(outer_size.width).to_be_greater_than(0)
        expect(outer_size.height).to_be_greater_than(0)
        window_destroy(window)
        window_destroy_event_loop(event_loop)

    it "sets minimum size":
        val event_loop = window_create_event_loop()
        val window = window_create(event_loop, 800, 600, "Test")
        val min_size = Size(width: 400, height: 300)
        val success = window_set_min_size(window, min_size)
        expect(success).to_equal(true)
        window_destroy(window)
        window_destroy_event_loop(event_loop)

    it "sets maximum size":
        val event_loop = window_create_event_loop()
        val window = window_create(event_loop, 800, 600, "Test")
        val max_size = Size(width: 1920, height: 1080)
        val success = window_set_max_size(window, max_size)
        expect(success).to_equal(true)
        window_destroy(window)
        window_destroy_event_loop(event_loop)

describe "Window Position":
    """
    Tests for window position management.
    """
    it "gets window position":
        val event_loop = window_create_event_loop()
        val window = window_create(event_loop, 800, 600, "Test")
        val pos = window_get_position(window)
        # Position values are platform-dependent
        expect(pos.x).to_be_greater_than(-10000)
        expect(pos.y).to_be_greater_than(-10000)
        window_destroy(window)
        window_destroy_event_loop(event_loop)

    it "sets window position":
        val event_loop = window_create_event_loop()
        val window = window_create(event_loop, 800, 600, "Test")
        val new_pos = Position(x: 100, y: 100)
        val success = window_set_position(window, new_pos)
        expect(success).to_equal(true)
        window_destroy(window)
        window_destroy_event_loop(event_loop)

describe "Window State":
    """
    Tests for window state management.
    """
    it "sets window title":
        val event_loop = window_create_event_loop()
        val window = window_create(event_loop, 800, 600, "Original Title")
        val success = window_set_title(window, "New Title")
        expect(success).to_equal(true)
        window_destroy(window)
        window_destroy_event_loop(event_loop)

    it "sets window visibility":
        val event_loop = window_create_event_loop()
        val window = window_create(event_loop, 800, 600, "Test")
        val success = window_set_visible(window, false)
        expect(success).to_equal(true)

        val is_visible = window_is_visible(window)
        expect(is_visible).to_equal(false)
        window_destroy(window)
        window_destroy_event_loop(event_loop)

    it "sets window resizable":
        val event_loop = window_create_event_loop()
        val window = window_create(event_loop, 800, 600, "Test")
        val success = window_set_resizable(window, false)
        expect(success).to_equal(true)
        window_destroy(window)
        window_destroy_event_loop(event_loop)

    it "sets window minimized":
        val event_loop = window_create_event_loop()
        val window = window_create(event_loop, 800, 600, "Test")
        val success = window_set_minimized(window, true)
        expect(success).to_equal(true)
        window_destroy(window)
        window_destroy_event_loop(event_loop)

    it "sets and checks window maximized":
        val event_loop = window_create_event_loop()
        val window = window_create(event_loop, 800, 600, "Test")
        window_set_maximized(window, true)
        val is_maximized = window_is_maximized(window)
        # May or may not work depending on platform
        expect(is_maximized).to_equal(true)
        window_destroy(window)
        window_destroy_event_loop(event_loop)

    it "sets and checks fullscreen":
        val event_loop = window_create_event_loop()
        val window = window_create(event_loop, 800, 600, "Test")
        window_set_fullscreen(window, true)
        val is_fullscreen = window_is_fullscreen(window)
        expect(is_fullscreen).to_equal(true)
        window_destroy(window)
        window_destroy_event_loop(event_loop)

    it "sets window decorations":
        val event_loop = window_create_event_loop()
        val window = window_create(event_loop, 800, 600, "Test")
        val success = window_set_decorations(window, false)
        expect(success).to_equal(true)
        window_destroy(window)
        window_destroy_event_loop(event_loop)

    it "sets always on top":
        val event_loop = window_create_event_loop()
        val window = window_create(event_loop, 800, 600, "Test")
        val success = window_set_always_on_top(window, true)
        expect(success).to_equal(true)
        window_destroy(window)
        window_destroy_event_loop(event_loop)

    it "focuses window":
        val event_loop = window_create_event_loop()
        val window = window_create(event_loop, 800, 600, "Test")
        val success = window_focus(window)
        expect(success).to_equal(true)
        window_destroy(window)
        window_destroy_event_loop(event_loop)

    it "requests redraw":
        val event_loop = window_create_event_loop()
        val window = window_create(event_loop, 800, 600, "Test")
        val success = window_request_redraw(window)
        expect(success).to_equal(true)
        window_destroy(window)
        window_destroy_event_loop(event_loop)

describe "Window Information":
    """
    Tests for window information queries.
    """
    it "gets scale factor":
        val event_loop = window_create_event_loop()
        val window = window_create(event_loop, 800, 600, "Test")
        val scale = window_scale_factor(window)
        # Scale factor is typically 1.0 or 2.0 (retina)
        expect(scale).to_be_greater_than(0.5)
        expect(scale).to_be_less_than(4.0)
        window_destroy(window)
        window_destroy_event_loop(event_loop)

describe "Cursor":
    """
    Tests for cursor management.
    """
    it "sets cursor visible":
        val event_loop = window_create_event_loop()
        val window = window_create(event_loop, 800, 600, "Test")
        val success = window_set_cursor_visible(window, false)
        expect(success).to_equal(true)
        window_destroy(window)
        window_destroy_event_loop(event_loop)

    it "sets cursor grab":
        val event_loop = window_create_event_loop()
        val window = window_create(event_loop, 800, 600, "Test")
        val success = window_set_cursor_grab(window, true)
        # May fail on some platforms
        expect(success).to_equal(true)
        window_destroy(window)
        window_destroy_event_loop(event_loop)

    it "sets cursor position":
        val event_loop = window_create_event_loop()
        val window = window_create(event_loop, 800, 600, "Test")
        val pos = Position(x: 400, y: 300)
        val success = window_set_cursor_position(window, pos)
        expect(success).to_equal(true)
        window_destroy(window)
        window_destroy_event_loop(event_loop)

describe "EventType":
    """
    Tests for event type parsing.
    """
    it "parses window resized event":
        val event_type = event_parse_type(1)
        expect(event_type).to_equal(EventType.WindowResized)

    it "parses window close event":
        val event_type = event_parse_type(3)
        expect(event_type).to_equal(EventType.WindowCloseRequested)

    it "parses keyboard input event":
        val event_type = event_parse_type(10)
        expect(event_type).to_equal(EventType.KeyboardInput)

    it "parses mouse button event":
        val event_type = event_parse_type(20)
        expect(event_type).to_equal(EventType.MouseButton)

    it "parses mouse moved event":
        val event_type = event_parse_type(21)
        expect(event_type).to_equal(EventType.MouseMoved)

    it "parses unknown event":
        val event_type = event_parse_type(9999)
        expect(event_type).to_equal(EventType.Unknown)

describe "Monitor":
    """
    Tests for monitor information.
    """
    it "gets monitor count":
        val count = window_get_monitor_count()
        # Should have at least one monitor
        expect(count).to_be_greater_than(0)

    it "gets monitor info":
        val count = window_get_monitor_count()
        if count > 0:
            val monitor = window_get_monitor_info(0)
            expect(monitor.id).to_equal(0)
            expect(monitor.size.width).to_be_greater_than(0)
            expect(monitor.size.height).to_be_greater_than(0)
            expect(monitor.scale_factor).to_be_greater_than(0.0)

describe "Clipboard":
    """
    Tests for clipboard operations.
    """
    it "sets and gets clipboard text":
        val success = window_clipboard_set("Hello, clipboard!")
        expect(success).to_equal(true)

        val text = window_clipboard_get()
        expect(text).to_equal("Hello, clipboard!")

    it "handles empty clipboard":
        window_clipboard_set("")
        val text = window_clipboard_get()
        expect(text).to_equal("")
