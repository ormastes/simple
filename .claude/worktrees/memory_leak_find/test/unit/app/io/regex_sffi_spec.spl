# Regex SFFI Integration Tests
# Tests the regex wrapper after linking to app.io

use app.io.regex_ffi.{regex_new, regex_is_match, regex_find, regex_find_all}
use app.io.regex_ffi.{regex_captures, regex_replace, regex_replace_all, regex_split}
use app.io.regex_ffi.{regex_is_match_quick, regex_find_quick, regex_replace_quick, regex_split_quick}
use app.io.regex_ffi.{is_valid_email, is_valid_url, is_valid_ipv4}

describe "Regex SFFI Integration":
    """Tests regex functionality after linking to app.io module"""

    describe "Basic Pattern Matching":
        it "compiles a regex pattern":
            val re = regex_new(r"\d+")
            expect(re.is_valid).to_equal(true)

        it "matches digits in text":
            val re = regex_new(r"\d+")
            expect(regex_is_match(re, "test 123")).to_equal(true)

        it "returns false when no match":
            val re = regex_new(r"\d+")
            expect(regex_is_match(re, "no digits here")).to_equal(false)

    describe "Finding Matches":
        it "finds first match":
            val re = regex_new(r"\d+")
            val result = regex_find(re, "abc 123 def 456")
            expect(result).to_equal("123")

        it "finds all matches":
            val re = regex_new(r"\d+")
            val matches = regex_find_all(re, "12 abc 34 def 56")
            expect(matches.len()).to_equal(3)
            expect(matches[0]).to_equal("12")
            expect(matches[1]).to_equal("34")
            expect(matches[2]).to_equal("56")

        it "returns empty string when no match":
            val re = regex_new(r"\d+")
            val result = regex_find(re, "no digits")
            expect(result).to_equal("")

    describe "Capture Groups":
        it "captures groups from pattern":
            val re = regex_new(r"(\d+)-(\d+)")
            val groups = regex_captures(re, "test 12-34 end")
            expect(groups.len()).to_equal(3)
            expect(groups[0]).to_equal("12-34")
            expect(groups[1]).to_equal("12")
            expect(groups[2]).to_equal("34")

        it "returns empty array when no match":
            val re = regex_new(r"(\d+)-(\d+)")
            val groups = regex_captures(re, "no match here")
            expect(groups.len()).to_equal(0)

    describe "Replace Operations":
        it "replaces first match":
            val re = regex_new(r"\d+")
            val result = regex_replace(re, "abc 123 def 456", "NUM")
            expect(result).to_equal("abc NUM def 456")

        it "replaces all matches":
            val re = regex_new(r"\d+")
            val result = regex_replace_all(re, "abc 123 def 456", "NUM")
            expect(result).to_equal("abc NUM def NUM")

        it "handles no match in replace":
            val re = regex_new(r"\d+")
            val result = regex_replace(re, "no digits", "NUM")
            expect(result).to_equal("no digits")

    describe "Split Operations":
        it "splits by pattern":
            val re = regex_new(r"\s+")
            val parts = regex_split(re, "hello  world   test")
            expect(parts.len()).to_equal(3)
            expect(parts[0]).to_equal("hello")
            expect(parts[1]).to_equal("world")
            expect(parts[2]).to_equal("test")

        it "splits by digits":
            val re = regex_new(r"\d+")
            val parts = regex_split(re, "abc123def456ghi")
            expect(parts.len()).to_equal(3)
            expect(parts[0]).to_equal("abc")
            expect(parts[1]).to_equal("def")
            expect(parts[2]).to_equal("ghi")

    describe "Quick Functions (No Compilation)":
        it "quick match works":
            expect(regex_is_match_quick(r"\d+", "test 123")).to_equal(true)
            expect(regex_is_match_quick(r"\d+", "no digits")).to_equal(false)

        it "quick find works":
            val result = regex_find_quick(r"\d+", "abc 123 def")
            expect(result).to_equal("123")

        it "quick replace works":
            val result = regex_replace_quick(r"\d+", "abc 123 def", "NUM")
            expect(result).to_equal("abc NUM def")

        it "quick split works":
            val parts = regex_split_quick(r"\s+", "hello world test")
            expect(parts.len()).to_equal(3)
            expect(parts[0]).to_equal("hello")

    describe "Validation Helpers":
        it "validates email addresses":
            expect(is_valid_email("test@example.com")).to_equal(true)
            expect(is_valid_email("user.name+tag@domain.co.uk")).to_equal(true)
            expect(is_valid_email("not-an-email")).to_equal(false)
            expect(is_valid_email("missing@domain")).to_equal(false)

        it "validates URLs":
            expect(is_valid_url("https://example.com")).to_equal(true)
            expect(is_valid_url("http://test.org/path")).to_equal(true)
            expect(is_valid_url("not a url")).to_equal(false)
            expect(is_valid_url("ftp://wrong-protocol")).to_equal(false)

        it "validates IPv4 addresses":
            expect(is_valid_ipv4("192.168.1.1")).to_equal(true)
            expect(is_valid_ipv4("10.0.0.1")).to_equal(true)
            expect(is_valid_ipv4("256.1.1.1")).to_equal(true)
            expect(is_valid_ipv4("not.an.ip")).to_equal(false)

    describe "Complex Patterns":
        it "matches word boundaries":
            val re = regex_new(r"\btest\b")
            expect(regex_is_match(re, "test case")).to_equal(true)
            expect(regex_is_match(re, "testing")).to_equal(false)

        it "matches optional groups":
            val re = regex_new(r"\d{3}-?\d{4}")
            expect(regex_is_match(re, "123-4567")).to_equal(true)
            expect(regex_is_match(re, "1234567")).to_equal(true)

        it "handles alternation":
            val re = regex_new(r"cat|dog")
            expect(regex_is_match(re, "I have a cat")).to_equal(true)
            expect(regex_is_match(re, "I have a dog")).to_equal(true)
            expect(regex_is_match(re, "I have a bird")).to_equal(false)

    describe "Error Handling":
        it "handles invalid pattern gracefully":
            val re = regex_new(r"[invalid")
            expect(re.is_valid).to_equal(false)

        it "handles invalid regex in quick match":
            val result = regex_is_match_quick(r"[invalid", "test")
            expect(result).to_equal(false)
