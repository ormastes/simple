# Tests for test_runner_coverage module
# Covers check_coverage_threshold, sort_files_by_coverage
# NOTE: parse_coverage_sdn tests skipped - uses last_index_of/?? which has runtime issues

use app.test_runner_new.test_runner_coverage.{parse_coverage_sdn, check_coverage_threshold, sort_files_by_coverage, CoverageData, FileCoverage}

describe "test_runner_coverage":
    describe "parse_coverage_sdn":
        it "parses empty SDN":
            val data = parse_coverage_sdn("")
            expect(data.total_decisions).to_equal(0)
            expect(data.total_conditions).to_equal(0)
            expect(data.decision_pct).to_equal(0)

    describe "check_coverage_threshold":
        it "passes when coverage meets threshold":
            val data = CoverageData(
                raw_sdn: "",
                files: [],
                total_decisions: 10,
                total_decisions_covered: 8,
                total_conditions: 0,
                total_conditions_covered: 0,
                decision_pct: 80,
                condition_pct: 0
            )
            val result = check_coverage_threshold(data, 80)
            expect(result).to_equal(true)

        it "passes when coverage exceeds threshold":
            val data = CoverageData(
                raw_sdn: "",
                files: [],
                total_decisions: 10,
                total_decisions_covered: 10,
                total_conditions: 0,
                total_conditions_covered: 0,
                decision_pct: 100,
                condition_pct: 0
            )
            val result = check_coverage_threshold(data, 80)
            expect(result).to_equal(true)

        it "fails when coverage below threshold":
            val data = CoverageData(
                raw_sdn: "",
                files: [],
                total_decisions: 10,
                total_decisions_covered: 5,
                total_conditions: 0,
                total_conditions_covered: 0,
                decision_pct: 50,
                condition_pct: 0
            )
            val result = check_coverage_threshold(data, 80)
            expect(result).to_equal(false)

        it "passes with zero threshold":
            val data = CoverageData(
                raw_sdn: "",
                files: [],
                total_decisions: 0,
                total_decisions_covered: 0,
                total_conditions: 0,
                total_conditions_covered: 0,
                decision_pct: 0,
                condition_pct: 0
            )
            val result = check_coverage_threshold(data, 0)
            expect(result).to_equal(true)

    describe "sort_files_by_coverage":
        it "sorts by decision percentage ascending":
            val files = [
                FileCoverage(path: "b.spl", decisions_total: 10, decisions_covered: 8, conditions_total: 0, conditions_covered: 0, decision_pct: 80, condition_pct: 0),
                FileCoverage(path: "a.spl", decisions_total: 10, decisions_covered: 5, conditions_total: 0, conditions_covered: 0, decision_pct: 50, condition_pct: 0),
                FileCoverage(path: "c.spl", decisions_total: 10, decisions_covered: 10, conditions_total: 0, conditions_covered: 0, decision_pct: 100, condition_pct: 0)
            ]
            val sorted = sort_files_by_coverage(files)
            expect(sorted[0].path).to_equal("a.spl")
            expect(sorted[1].path).to_equal("b.spl")
            expect(sorted[2].path).to_equal("c.spl")

        it "handles empty list":
            val sorted = sort_files_by_coverage([])
            expect(sorted.len()).to_equal(0)

        it "handles single file":
            val files = [FileCoverage(path: "x.spl", decisions_total: 5, decisions_covered: 3, conditions_total: 0, conditions_covered: 0, decision_pct: 60, condition_pct: 0)]
            val sorted = sort_files_by_coverage(files)
            expect(sorted.len()).to_equal(1)
            expect(sorted[0].path).to_equal("x.spl")
