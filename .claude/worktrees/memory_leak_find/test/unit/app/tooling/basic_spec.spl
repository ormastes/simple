"""
Module: basic_spec

Feature: Basic CLI Operations
Category: Tooling
Status: In Progress

Unit tests for basic command-line interface operations including GC configuration,
file extension detection, source code wrapping, and module compilation.
"""


describe "basic module compilation":
    """
    Verify that the basic CLI module compiles successfully
    without errors.
    """
    it "compiles successfully":
        expect 1 + 1 == 2

describe "GC configuration":
    """
    Tests for garbage collection configuration options.
    """
    it "GC enabled by default":
        val gc_log = false
        val gc_off = false
        expect gc_off == false

    it "GC disabled with gc_off":
        val gc_off = true
        expect gc_off == true

    it "GC logging enabled":
        val gc_log = true
        val gc_off = false
        expect gc_log == true

describe "GC mode selection":
    """
    Tests for selecting the appropriate garbage collection mode
    based on configuration flags.
    """
    it "selects no_gc when gc_off true":
        val gc_off = true
        val gc_log = false
        val mode = if gc_off: "no_gc" elif gc_log: "gc_logging" else: "default"
        expect mode == "no_gc"

    it "selects gc_logging when gc_log true":
        val gc_off = false
        val gc_log = true
        val mode = if gc_off: "no_gc" elif gc_log: "gc_logging" else: "default"
        expect mode == "gc_logging"

    it "selects default when both false":
        val gc_off = false
        val gc_log = false
        val mode = if gc_off: "no_gc" elif gc_log: "gc_logging" else: "default"
        expect mode == "default"

describe "file extension extraction":
    """
    Tests for extracting file extensions from paths.
    """
    it "extracts .spl extension":
        val path = "test.spl"
        val parts = path.split(".")
        val ext = if parts.len() > 1: parts[parts.len() - 1] else: ""
        expect ext == "spl"

    it "extracts .smf extension":
        val path = "test.smf"
        val parts = path.split(".")
        val ext = if parts.len() > 1: parts[parts.len() - 1] else: ""
        expect ext == "smf"

    it "handles no extension":
        val path = "test"
        val parts = path.split(".")
        val ext = if parts.len() > 1: parts[parts.len() - 1] else: ""
        expect ext == ""

    it "handles path with directory":
        val path = "src/test.spl"
        val parts = path.split(".")
        val ext = if parts.len() > 1: parts[parts.len() - 1] else: ""
        expect ext == "spl"

describe "source extension detection":
    """
    Tests for identifying valid source file extensions.
    """
    it "recognizes .spl as source":
        val ext = "spl"
        val is_source = ext == "spl" or ext == "simple" or ext == "sscript" or ext == ""
        expect is_source == true

    it "recognizes .simple as source":
        val ext = "simple"
        val is_source = ext == "spl" or ext == "simple" or ext == "sscript" or ext == ""
        expect is_source == true

    it "recognizes .sscript as source":
        val ext = "sscript"
        val is_source = ext == "spl" or ext == "simple" or ext == "sscript" or ext == ""
        expect is_source == true

    it "recognizes empty extension as source":
        val ext = ""
        val is_source = ext == "spl" or ext == "simple" or ext == "sscript" or ext == ""
        expect is_source == true

    it "rejects .smf as non-source":
        val ext = "smf"
        val is_source = ext == "spl" or ext == "simple" or ext == "sscript" or ext == ""
        expect is_source == false

describe "main wrapper detection":
    """
    Tests for determining when code needs to be wrapped with a main function.
    """
    it "needs wrapper for simple expression":
        val code = "42"
        val needs = not (code.contains("main") or code.contains("fn ") or code.contains("let "))
        expect needs == true

    it "needs wrapper for arithmetic":
        val code = "2 + 2"
        val needs = not (code.contains("main") or code.contains("fn ") or code.contains("let "))
        expect needs == true

    it "no wrapper for main function":
        val code = "fn main(): print 42"
        val needs = not (code.contains("main") or code.contains("fn ") or code.contains("let "))
        expect needs == false

    it "no wrapper for function def":
        val code = "fn add(a, b): a + b"
        val needs = not (code.contains("main") or code.contains("fn ") or code.contains("let "))
        expect needs == false

    it "no wrapper for let statement":
        val code = "let x = 42"
        val needs = not (code.contains("main") or code.contains("fn ") or code.contains("let "))
        expect needs == false

describe "code wrapping":
    """
    Tests for wrapping code with a main entry point when needed.
    """
    it "wraps simple expression":
        val code = "42"
        val needs = not code.contains("main")
        val wrapped = if needs: "main = {code}" else: code
        expect wrapped.contains("main = 42") == true

    it "does not wrap main":
        val code = "fn main(): print 42"
        val needs = not code.contains("main")
        val wrapped = if needs: "main = {code}" else: code
        expect wrapped == code

describe "Result handling":
    """
    Tests for Result type usage in CLI operations.
    """
    it "Ok returns exit code":
        expect Ok(0).is_ok() == true

    it "Err returns error":
        expect Err("failed").is_err() == true

describe "match on Result":
    """
    Tests for pattern matching on Result types.
    """
    it "matches Ok":
        val result = Ok(0)
        val matched = match result:
            Ok(code) => "success"
            Err(e) => "error"
        expect matched == "success"

    it "matches Err":
        val result = Err("failed")
        val matched = match result:
            Ok(code) => "success"
            Err(e) => "error"
        expect matched == "error"

describe "empty list for args":
    """
    Tests for creating empty and populated argument lists.
    """
    it "creates empty args list":
        val args = []
        expect args.len() == 0

    it "creates args list with items":
        val args = ["--flag", "value"]
        expect args.len() == 2

describe "exit codes":
    """
    Tests for exit code representation and handling.
    """
    it "success returns 0":
        expect 0 == 0

    it "error returns 1":
        expect 1 == 1

describe "string contains check":
    """
    Tests for substring detection in code strings.
    """
    it "detects main keyword":
        val code = "fn main(): print 42"
        expect code.contains("main") == true

    it "detects fn keyword":
        val code = "fn add(a, b): a + b"
        expect code.contains("fn ") == true

    it "detects let keyword":
        val code = "let x = 42"
        expect code.contains("let ") == true

    it "rejects when not present":
        val code = "42"
        expect code.contains("main") == false

describe "string interpolation":
    """
    Tests for string interpolation in CLI messages.
    """
    it "interpolates path in message":
        val path = "test.spl"
        val msg = "Watching {path} for changes..."
        expect msg.contains("test.spl") == true

    it "interpolates exit code":
        val code = 42
        val msg = "{code}"
        expect msg.contains("42") == true
