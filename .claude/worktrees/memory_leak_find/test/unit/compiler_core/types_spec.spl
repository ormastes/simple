# Core Simple â€” Types and Pools Tests
use compiler.core.types.*

fn fresh_pools():
    reset_all_pools()


describe "core.types":
    before_each:
        fresh_pools()

    describe "string helpers":
        it "handles concatenation and length":
            expect(str_concat("ab", "cd")).to_equal("abcd")
            expect(str_len("hello")).to_equal(5)

        it "handles equality and slices":
            expect(str_eq("a", "a")).to_equal(true)
            expect(str_eq("a", "b")).to_equal(false)
            expect(str_slice("hello", 1, 4)).to_equal("ell")
            expect(str_char_at("hello", 0)).to_equal("h")

        it "handles contains/starts/ends":
            expect(str_contains("hello", "ell")).to_equal(true)
            expect(str_contains("hello", "zzz")).to_equal(false)
            expect(str_starts_with("hello", "he")).to_equal(true)
            expect(str_ends_with("hello", "lo")).to_equal(true)

        it "handles index, trim, replace":
            expect(str_index_of("hello", "ell")).to_equal(1)
            expect(str_index_of("hello", "zzz")).to_equal(-1)
            expect(str_trim("  hi \n")).to_equal("hi")
            expect(str_replace("ababa", "ba", "X")).to_equal("aXX")

    describe "int/bool to string":
        it "formats ints and bools":
            expect(int_to_str(42)).to_equal("42")
            expect(bool_to_str(true)).to_equal("true")
            expect(bool_to_str(false)).to_equal("false")

    describe "span pool":
        it "allocates and reads spans":
            val sid = span_new(1, 5, 2, 3)
            expect(span_start(sid)).to_equal(1)
            expect(span_end(sid)).to_equal(5)
            expect(span_line(sid)).to_equal(2)
            expect(span_col(sid)).to_equal(3)

        it "creates dummy span":
            val sid = span_dummy()
            expect(span_start(sid)).to_equal(0)
            expect(span_end(sid)).to_equal(0)
            expect(span_line(sid)).to_equal(0)
            expect(span_col(sid)).to_equal(0)

    describe "token pool":
        it "allocates tokens":
            val sid = span_new(0, 1, 1, 1)
            val tid = token_new(123, sid, "tok")
            expect(token_kind(tid)).to_equal(123)
            expect(token_span(tid)).to_equal(sid)
            expect(token_text(tid)).to_equal("tok")

    describe "symbol table":
        it "allocates symbols":
            val sid = symbol_new("x", SYM_VAR, 0, 10, 1)
            expect(symbol_name(sid)).to_equal("x")
            expect(symbol_type(sid)).to_equal(SYM_VAR)
            expect(symbol_depth(sid)).to_equal(0)
            expect(symbol_decl(sid)).to_equal(10)
            expect(symbol_is_mutable(sid)).to_equal(true)

        it "supports immutable symbols":
            val sid = symbol_new("y", SYM_VAL, 1, 11, 0)
            expect(symbol_is_mutable(sid)).to_equal(false)

    describe "scope stack":
        it "pushes and pops scope":
            expect(scope_depth()).to_equal(0)
            val d1 = scope_push()
            expect(d1).to_equal(1)
            expect(scope_depth()).to_equal(1)
            val sym_idx = symbol_new("z", SYM_VAR, scope_depth(), 12, 1)
            expect(sym_idx).to_equal(0)
            val start = scope_pop()
            expect(start).to_equal(0)
            expect(scope_depth()).to_equal(0)

    describe "type tags":
        it "maps type tag names":
            expect(type_tag_name(TYPE_VOID)).to_equal("void")
            expect(type_tag_name(TYPE_BOOL)).to_equal("bool")
            expect(type_tag_name(TYPE_I64)).to_equal("i64")
            expect(type_tag_name(TYPE_F64)).to_equal("f64")
            expect(type_tag_name(TYPE_TEXT)).to_equal("text")
            expect(type_tag_name(TYPE_ARRAY_I64)).to_equal("[i64]")
            expect(type_tag_name(TYPE_ARRAY_TEXT)).to_equal("[text]")
            expect(type_tag_name(TYPE_ARRAY_BOOL)).to_equal("[bool]")
            expect(type_tag_name(TYPE_ARRAY_ANY)).to_equal("[any]")
            expect(type_tag_name(TYPE_DICT)).to_equal("dict")
            expect(type_tag_name(TYPE_STRUCT)).to_equal("struct")
            expect(type_tag_name(TYPE_FN)).to_equal("fn")
            expect(type_tag_name(TYPE_ANY)).to_equal("any")
            expect(type_tag_name(TYPE_NIL)).to_equal("nil")
            expect(type_tag_name(999)).to_equal("unknown")

        it "maps Option type tag names":
            expect(type_tag_name(TYPE_OPTION)).to_equal("Option")
            expect(type_tag_name(TYPE_OPTION_I64)).to_equal("Option<i64>")
            expect(type_tag_name(TYPE_OPTION_F64)).to_equal("Option<f64>")
            expect(type_tag_name(TYPE_OPTION_TEXT)).to_equal("Option<text>")
            expect(type_tag_name(TYPE_OPTION_BOOL)).to_equal("Option<bool>")
            expect(type_tag_name(TYPE_RESULT)).to_equal("Result")

        it "maps type tags to C":
            expect(type_tag_to_c(TYPE_VOID)).to_equal("void")
            expect(type_tag_to_c(TYPE_BOOL)).to_equal("int")
            expect(type_tag_to_c(TYPE_I64)).to_equal("int64_t")
            expect(type_tag_to_c(TYPE_F64)).to_equal("double")
            expect(type_tag_to_c(TYPE_TEXT)).to_equal("const char*")
            expect(type_tag_to_c(TYPE_ARRAY_I64)).to_equal("SplArray*")
            expect(type_tag_to_c(TYPE_DICT)).to_equal("SplDict*")
            expect(type_tag_to_c(TYPE_STRUCT)).to_equal("void*")
            expect(type_tag_to_c(TYPE_FN)).to_equal("void*")
            expect(type_tag_to_c(TYPE_ANY)).to_equal("SplValue")
            expect(type_tag_to_c(TYPE_NIL)).to_equal("SplValue")
            expect(type_tag_to_c(999)).to_equal("int64_t")

        it "maps Option type tags to C":
            expect(type_tag_to_c(TYPE_OPTION)).to_equal("SplOption*")
            expect(type_tag_to_c(TYPE_OPTION_I64)).to_equal("SplOption*")
            expect(type_tag_to_c(TYPE_OPTION_F64)).to_equal("SplOption*")
            expect(type_tag_to_c(TYPE_OPTION_TEXT)).to_equal("SplOption*")
            expect(type_tag_to_c(TYPE_OPTION_BOOL)).to_equal("SplOption*")
            expect(type_tag_to_c(TYPE_RESULT)).to_equal("SplResult*")

        it "maps async type tag names":
            expect(type_tag_name(TYPE_FUTURE)).to_equal("Future")
            expect(type_tag_name(TYPE_POLL)).to_equal("Poll")
            expect(type_tag_name(TYPE_TASK)).to_equal("Task")

        it "maps async type tags to C":
            expect(type_tag_to_c(TYPE_FUTURE)).to_equal("SplFuture*")
            expect(type_tag_to_c(TYPE_POLL)).to_equal("SplPoll*")
            expect(type_tag_to_c(TYPE_TASK)).to_equal("SplTask*")

    describe "named type registry":
        it "registers and finds types":
            val tid = named_type_register("Point", ["x", "y"], [TYPE_I64, TYPE_I64])
            expect(tid).to_equal(0)
            expect(named_type_find("Point")).to_equal(0)
            expect(named_type_find("Missing")).to_equal(-1)
            expect(named_type_name(tid)).to_equal("Point")
            expect(named_type_fields(tid).len()).to_equal(2)
            expect(named_type_field_type_tags(tid)[1]).to_equal(TYPE_I64)

    describe "function signatures":
        it "registers and finds signatures":
            val sig = fn_sig_register("add", ["a", "b"], [TYPE_I64, TYPE_I64], TYPE_I64, 0)
            expect(sig).to_equal(0)
            expect(fn_sig_find("add")).to_equal(0)
            expect(fn_sig_find("missing")).to_equal(-1)
            expect(fn_sig_name(sig)).to_equal("add")
            expect(fn_sig_ret_type(sig)).to_equal(TYPE_I64)
            expect(fn_sig_param_count(sig)).to_equal(2)
            expect(fn_sig_is_extern_fn(sig)).to_equal(false)

        it "tracks extern signatures":
            val sig = fn_sig_register("ext", [], [], TYPE_VOID, 1)
            expect(fn_sig_is_extern_fn(sig)).to_equal(true)

    describe "reset_all_pools":
        it "clears pools":
            val sid = symbol_new("x", SYM_VAR, 0, 1, 1)
            expect(sid).to_equal(0)
            reset_all_pools()
            val sid2 = symbol_new("y", SYM_VAR, 0, 2, 1)
            expect(sid2).to_equal(0)
            val tid = named_type_register("T", [], [])
            expect(tid).to_equal(0)
            reset_all_pools()
            val tid2 = named_type_register("U", [], [])
            expect(tid2).to_equal(0)
