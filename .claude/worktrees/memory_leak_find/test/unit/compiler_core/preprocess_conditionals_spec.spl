#!/usr/bin/env simple

use compiler.core.ast.{ast_reset}
use compiler.core.parser.{parse_module, parser_has_errors}
extern fn rt_env_set(key: text, value: text)

fn pp_parse_ok(code: text) -> bool:
    ast_reset()
    parse_module(code, "pp_spec.spl")
    parser_has_errors() == false

describe "core preprocessor @when/@elif/@else/@end directives":
    it "supports @when/@else/@end":
        val src = "@when(true):\nfn selected() -> i64:\n    return 1\n@else:\nfn broken( -> i64:\n@end\nfn main() -> i64:\n    return selected()"
        expect(pp_parse_ok(src)).to_equal(true)

    it "supports @elif":
        val src = "@when(false):\nfn broken_a( -> i64:\n@elif(true):\nfn selected() -> i64:\n    return 2\n@else:\nfn broken_b( -> i64:\n@end\nfn main() -> i64:\n    return selected()"
        expect(pp_parse_ok(src)).to_equal(true)

    it "supports android atom with SIMPLE_TARGET_OS override":
        rt_env_set("SIMPLE_TARGET_OS", "android")
        val src = "@when(android):\nfn selected() -> i64:\n    return 9\n@else:\nfn broken( -> i64:\n@end\nfn main() -> i64:\n    return selected()"
        expect(pp_parse_ok(src)).to_equal(true)
        rt_env_set("SIMPLE_TARGET_OS", "")

    it "supports os=unix key-value true path":
        rt_env_set("SIMPLE_TARGET_OS", "linux")
        val src = "@when(os=unix):\nfn selected() -> i64:\n    return 11\n@else:\nfn broken( -> i64:\n@end\nfn main() -> i64:\n    return selected()"
        expect(pp_parse_ok(src)).to_equal(true)
        rt_env_set("SIMPLE_TARGET_OS", "")

    it "supports os=unix key-value false path":
        rt_env_set("SIMPLE_TARGET_OS", "windows")
        val src = "@when(os=unix):\nfn broken( -> i64:\n@else:\nfn selected() -> i64:\n    return 13\n@end\nfn main() -> i64:\n    return selected()"
        expect(pp_parse_ok(src)).to_equal(true)
        rt_env_set("SIMPLE_TARGET_OS", "")

    it "supports ppc64le atom with SIMPLE_TARGET_ARCH override":
        rt_env_set("SIMPLE_TARGET_ARCH", "ppc64le")
        val src = "@when(ppc64le):\nfn selected() -> i64:\n    return 21\n@else:\nfn broken( -> i64:\n@end\nfn main() -> i64:\n    return selected()"
        expect(pp_parse_ok(src)).to_equal(true)
        rt_env_set("SIMPLE_TARGET_ARCH", "")

    it "supports arch=ppc64le key-value":
        rt_env_set("SIMPLE_TARGET_ARCH", "ppc64le")
        val src = "@when(arch=ppc64le):\nfn selected() -> i64:\n    return 22\n@else:\nfn broken( -> i64:\n@end\nfn main() -> i64:\n    return selected()"
        expect(pp_parse_ok(src)).to_equal(true)
        rt_env_set("SIMPLE_TARGET_ARCH", "")
