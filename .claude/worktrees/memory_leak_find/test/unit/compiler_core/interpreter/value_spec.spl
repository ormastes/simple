# Core Interpreter â€” Value Arena Tests
use compiler.core.interpreter.value.{val_reset, val_count}
use compiler.core.interpreter.value.{val_make_nil, val_make_bool, val_make_int, val_make_float}
use compiler.core.interpreter.value.{val_make_text, val_make_array, val_make_struct, val_make_function}
use compiler.core.interpreter.value.{val_get_kind, val_get_int, val_get_bool, val_get_float, val_get_text}
use compiler.core.interpreter.value.{val_get_array, val_get_struct_name, val_get_struct_fields, val_get_struct_values}
use compiler.core.interpreter.value.{val_get_func_name, val_get_func_decl}
use compiler.core.interpreter.value.{val_struct_get_field, val_struct_set_field}
use compiler.core.interpreter.value.{val_is_nil, val_is_bool, val_is_int, val_is_float, val_is_text}
use compiler.core.interpreter.value.{val_is_array, val_is_struct, val_is_function}
use compiler.core.interpreter.value.{val_is_truthy, val_to_text, val_kind_name, val_equals}
use compiler.core.interpreter.value.{VAL_NIL, VAL_BOOL, VAL_INT, VAL_FLOAT, VAL_TEXT, VAL_ARRAY, VAL_STRUCT, VAL_FUNCTION}
use compiler.core.interpreter.value.{VAL_NONE}

describe "Core Interpreter Value Arena":
    before_each:
        val_reset()

    describe "nil values":
        it "creates nil":
            val v = val_make_nil()
            expect(val_get_kind(v)).to_equal(VAL_NIL)

        it "nil is not truthy":
            val v = val_make_nil()
            expect(val_is_truthy(v)).to_equal(false)

        it "nil to text":
            val v = val_make_nil()
            expect(val_to_text(v)).to_equal("nil")

        it "VAL_NONE is nil":
            expect(val_is_nil(VAL_NONE)).to_equal(true)

    describe "bool values":
        it "creates true":
            val v = val_make_bool(true)
            expect(val_get_kind(v)).to_equal(VAL_BOOL)
            expect(val_get_bool(v)).to_equal(true)

        it "creates false":
            val v = val_make_bool(false)
            expect(val_get_bool(v)).to_equal(false)

        it "true is truthy":
            expect(val_is_truthy(val_make_bool(true))).to_equal(true)

        it "false is not truthy":
            expect(val_is_truthy(val_make_bool(false))).to_equal(false)

        it "bool to text":
            expect(val_to_text(val_make_bool(true))).to_equal("true")
            expect(val_to_text(val_make_bool(false))).to_equal("false")

    describe "int values":
        it "creates int":
            val v = val_make_int(42)
            expect(val_get_kind(v)).to_equal(VAL_INT)
            expect(val_get_int(v)).to_equal(42)

        it "zero is not truthy":
            expect(val_is_truthy(val_make_int(0))).to_equal(false)

        it "nonzero is truthy":
            expect(val_is_truthy(val_make_int(42))).to_equal(true)

        it "negative int":
            val v = val_make_int(-5)
            expect(val_get_int(v)).to_equal(-5)

        it "int to text":
            expect(val_to_text(val_make_int(42))).to_equal("42")

    describe "float values":
        it "creates float":
            val v = val_make_float(3.14)
            expect(val_get_kind(v)).to_equal(VAL_FLOAT)

        it "zero float is not truthy":
            expect(val_is_truthy(val_make_float(0.0))).to_equal(false)

        it "nonzero float is truthy":
            expect(val_is_truthy(val_make_float(1.5))).to_equal(true)

    describe "text values":
        it "creates text":
            val v = val_make_text("hello")
            expect(val_get_kind(v)).to_equal(VAL_TEXT)
            expect(val_get_text(v)).to_equal("hello")

        it "empty text is not truthy":
            expect(val_is_truthy(val_make_text(""))).to_equal(false)

        it "nonempty text is truthy":
            expect(val_is_truthy(val_make_text("x"))).to_equal(true)

    describe "array values":
        it "creates array":
            var elems: [i64] = []
            elems.push(val_make_int(1))
            elems.push(val_make_int(2))
            val v = val_make_array(elems)
            expect(val_get_kind(v)).to_equal(VAL_ARRAY)
            val arr = val_get_array(v)
            expect(arr.len()).to_equal(2)
            expect(val_get_int(arr[0])).to_equal(1)
            expect(val_get_int(arr[1])).to_equal(2)

        it "empty array is not truthy":
            val v = val_make_array([])
            expect(val_is_truthy(v)).to_equal(false)

        it "nonempty array is truthy":
            var elems: [i64] = []
            elems.push(val_make_int(1))
            val v = val_make_array(elems)
            expect(val_is_truthy(v)).to_equal(true)

        it "array to text":
            var elems: [i64] = []
            elems.push(val_make_int(1))
            elems.push(val_make_int(2))
            elems.push(val_make_int(3))
            val v = val_make_array(elems)
            expect(val_to_text(v)).to_equal("[1, 2, 3]")

    describe "struct values":
        it "creates struct":
            var fields: [text] = []
            fields.push("x")
            fields.push("y")
            var values: [i64] = []
            values.push(val_make_int(10))
            values.push(val_make_int(20))
            val v = val_make_struct("Point", fields, values)
            expect(val_get_kind(v)).to_equal(VAL_STRUCT)
            expect(val_get_struct_name(v)).to_equal("Point")

        it "accesses struct fields":
            var fields: [text] = []
            fields.push("x")
            fields.push("y")
            var values: [i64] = []
            values.push(val_make_int(10))
            values.push(val_make_int(20))
            val v = val_make_struct("Point", fields, values)
            val xv = val_struct_get_field(v, "x")
            expect(val_get_int(xv)).to_equal(10)
            val yv = val_struct_get_field(v, "y")
            expect(val_get_int(yv)).to_equal(20)

        it "sets struct fields":
            var fields: [text] = []
            fields.push("x")
            var values: [i64] = []
            values.push(val_make_int(10))
            val v = val_make_struct("Pt", fields, values)
            val_struct_set_field(v, "x", val_make_int(99))
            val xv = val_struct_get_field(v, "x")
            expect(val_get_int(xv)).to_equal(99)

        it "missing field returns VAL_NONE":
            var fields: [text] = []
            fields.push("x")
            var values: [i64] = []
            values.push(val_make_int(10))
            val v = val_make_struct("Pt", fields, values)
            expect(val_struct_get_field(v, "z")).to_equal(VAL_NONE)

    describe "function values":
        it "creates function":
            val v = val_make_function("foo", 42)
            expect(val_get_kind(v)).to_equal(VAL_FUNCTION)
            expect(val_get_func_name(v)).to_equal("foo")
            expect(val_get_func_decl(v)).to_equal(42)

    describe "equality":
        it "nil == nil":
            expect(val_equals(val_make_nil(), val_make_nil())).to_equal(true)

        it "int equality":
            expect(val_equals(val_make_int(42), val_make_int(42))).to_equal(true)
            expect(val_equals(val_make_int(42), val_make_int(43))).to_equal(false)

        it "text equality":
            expect(val_equals(val_make_text("hi"), val_make_text("hi"))).to_equal(true)
            expect(val_equals(val_make_text("hi"), val_make_text("lo"))).to_equal(false)

        it "bool equality":
            expect(val_equals(val_make_bool(true), val_make_bool(true))).to_equal(true)
            expect(val_equals(val_make_bool(true), val_make_bool(false))).to_equal(false)

        it "different types not equal":
            expect(val_equals(val_make_int(1), val_make_text("1"))).to_equal(false)

    describe "kind names":
        it "returns correct names":
            expect(val_kind_name(VAL_NIL)).to_equal("nil")
            expect(val_kind_name(VAL_BOOL)).to_equal("bool")
            expect(val_kind_name(VAL_INT)).to_equal("i64")
            expect(val_kind_name(VAL_FLOAT)).to_equal("f64")
            expect(val_kind_name(VAL_TEXT)).to_equal("text")

    describe "type predicates":
        it "is_nil":
            expect(val_is_nil(val_make_nil())).to_equal(true)
            expect(val_is_nil(val_make_int(0))).to_equal(false)

        it "is_bool":
            expect(val_is_bool(val_make_bool(true))).to_equal(true)
            expect(val_is_bool(val_make_bool(false))).to_equal(true)
            expect(val_is_bool(val_make_int(1))).to_equal(false)

        it "is_int":
            expect(val_is_int(val_make_int(42))).to_equal(true)
            expect(val_is_int(val_make_text("x"))).to_equal(false)

        it "is_float":
            expect(val_is_float(val_make_float(3.14))).to_equal(true)
            expect(val_is_float(val_make_int(3))).to_equal(false)

        it "is_text":
            expect(val_is_text(val_make_text("x"))).to_equal(true)
            expect(val_is_text(val_make_int(1))).to_equal(false)

        it "is_array":
            var elems: [i64] = []
            elems.push(val_make_int(1))
            expect(val_is_array(val_make_array(elems))).to_equal(true)
            expect(val_is_array(val_make_int(1))).to_equal(false)

        it "is_struct":
            var fields: [text] = []
            fields.push("x")
            var values: [i64] = []
            values.push(val_make_int(1))
            expect(val_is_struct(val_make_struct("S", fields, values))).to_equal(true)
            expect(val_is_struct(val_make_int(1))).to_equal(false)

        it "is_function":
            expect(val_is_function(val_make_function("f", 0))).to_equal(true)
            expect(val_is_function(val_make_int(1))).to_equal(false)

    describe "arena management":
        it "tracks count":
            val_reset()
            expect(val_count()).to_equal(0)
            val_make_int(1)
            expect(val_count()).to_equal(1)
            val_make_text("x")
            expect(val_count()).to_equal(2)

        it "reset clears arena":
            val_make_int(1)
            val_make_int(2)
            val_reset()
            expect(val_count()).to_equal(0)
