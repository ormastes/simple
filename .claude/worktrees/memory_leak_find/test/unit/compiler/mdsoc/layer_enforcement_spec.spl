"""
# Layer Enforcement Specification

**Feature IDs:** #LAYER-002
**Category:** Infrastructure
**Difficulty:** 2/5
**Status:** Implemented

## Overview

Tests that the numbered layer dependency rule is enforced:
layer N can only import from layers with number <= N.

## Behavior

- Layer 70 (backend) can import layer 50 (mir): allowed
- Layer 10 (frontend) cannot import layer 50 (mir): violation
- Layer 00 (common) can only import itself: layer 0
- Non-numbered directories have no constraint
"""

import std.spec

# ============================================================================
# Test Group 1: Layer Number Extraction
# ============================================================================

describe "Layer Number Extraction":
    """
    ## Extract Layer Numbers

    Tests extract_layer_number() from numbered directory names.
    Uses inline parsing since extract_layer_number may not be available
    in interpreter mode.
    """

    it "extracts 0 from 00.common":
        val dir = "00.common"
        val dot_idx = dir.index_of(".")
        val idx = dot_idx ?? 0
        val prefix = dir.substring(0, idx)
        var num: i64 = 0
        for ch in prefix:
            num = num * 10 + (ch.to_i64() - "0".to_i64())
        expect(num).to_equal(0)

    it "extracts 10 from 10.frontend":
        val dir = "10.frontend"
        val dot_idx = dir.index_of(".")
        val idx = dot_idx ?? 0
        val prefix = dir.substring(0, idx)
        var num: i64 = 0
        for ch in prefix:
            num = num * 10 + (ch.to_i64() - "0".to_i64())
        expect(num).to_equal(10)

    it "extracts 50 from 50.mir":
        val dir = "50.mir"
        val dot_idx = dir.index_of(".")
        val idx = dot_idx ?? 0
        val prefix = dir.substring(0, idx)
        var num: i64 = 0
        for ch in prefix:
            num = num * 10 + (ch.to_i64() - "0".to_i64())
        expect(num).to_equal(50)

    it "extracts 99 from 99.loader":
        val dir = "99.loader"
        val dot_idx = dir.index_of(".")
        val idx = dot_idx ?? 0
        val prefix = dir.substring(0, idx)
        var num: i64 = 0
        for ch in prefix:
            num = num * 10 + (ch.to_i64() - "0".to_i64())
        expect(num).to_equal(99)

    it "returns -1 for non-numbered directory":
        val dir = "backend"
        val dot_idx = dir.index_of(".")
        val idx = dot_idx ?? -1
        expect(idx).to_equal(-1)

    it "returns -1 for invalid prefix":
        val dir = "abc.frontend"
        val dot_idx = dir.index_of(".")
        val idx = dot_idx ?? 0
        val prefix = dir.substring(0, idx)
        var all_digits = true
        for ch in prefix:
            if ch < "0" or ch > "9":
                all_digits = false
        expect(all_digits).to_equal(false)


# ============================================================================
# Test Group 2: Layer Dependency Checking
# ============================================================================

describe "Numbered Layer Dependency Checking":
    """
    ## check_numbered_layer_dep

    Tests the layer dependency rule: layer N can import layers <= N.
    Uses inline logic since check_numbered_layer_dep may not be
    available in interpreter mode.
    """

    it "allows same-layer imports":
        # Layer 50 -> Layer 50: allowed (50 >= 50)
        val from_layer = 50
        val to_layer = 50
        expect(from_layer >= to_layer).to_equal(true)

    it "allows lower-layer imports":
        # Layer 70 -> Layer 50: allowed (70 >= 50)
        val from_layer = 70
        val to_layer = 50
        expect(from_layer >= to_layer).to_equal(true)

    it "allows importing layer 0 from any layer":
        # Layer 10 -> Layer 0: allowed
        val from_layer = 10
        val to_layer = 0
        expect(from_layer >= to_layer).to_equal(true)

    it "rejects higher-layer imports":
        # Layer 10 -> Layer 50: VIOLATION (10 < 50)
        val from_layer = 10
        val to_layer = 50
        val violation = from_layer < to_layer
        expect(violation).to_equal(true)

    it "rejects lower importing higher":
        # Layer 00 -> Layer 99: VIOLATION
        val from_layer = 0
        val to_layer = 99
        val violation = from_layer < to_layer
        expect(violation).to_equal(true)

    it "no constraint for non-numbered directories":
        # Both have layer -1 (non-numbered)
        val from_layer = -1
        val to_layer = 50
        # Non-numbered dirs have no constraint
        val has_constraint = from_layer >= 0 and to_layer >= 0
        expect(has_constraint).to_equal(false)

    it "no constraint when both non-numbered":
        val from_layer = -1
        val to_layer = -1
        val has_constraint = from_layer >= 0 and to_layer >= 0
        expect(has_constraint).to_equal(false)
