# Codegen Trait Hierarchy Tests
#
# Verifies the new Codegen trait, adapters, and factory.

use compiler.backend.common.codegen.{Codegen, CodegenOutput, CodegenOutputKind}
use compiler.backend.codegen_factory.{CodegenFactory}
use compiler.core.backend_types.{BackendKind, CodegenTarget, CompileOptions, compileoptions_default_options}

describe "CodegenOutputKind":
    it "has all expected variants":
        val ok = CodegenOutputKind.ObjectCode
        val ts = CodegenOutputKind.TextSource
        val gpu = CodegenOutputKind.GpuCode
        val ir = CodegenOutputKind.InterpretedResult
        expect(true).to_equal(true)

describe "CodegenOutput":
    it "creates text output":
        val output = CodegenOutput.text("test_module", "int main() {}")
        expect(output.name).to_equal("test_module")
        expect(output.has_text_output).to_equal(true)
        expect(output.text_output).to_equal("int main() {}")
        expect(output.has_object_code).to_equal(false)
        expect(output.kind).to_equal(CodegenOutputKind.TextSource)

    it "creates object output":
        val output = CodegenOutput.object("native_mod", [0x7f, 0x45, 0x4c, 0x46])
        expect(output.name).to_equal("native_mod")
        expect(output.has_object_code).to_equal(true)
        expect(output.has_text_output).to_equal(false)
        expect(output.kind).to_equal(CodegenOutputKind.ObjectCode)

    it "creates gpu output":
        val output = CodegenOutput.gpu("kernel_mod", ".entry kernel() {}")
        expect(output.name).to_equal("kernel_mod")
        expect(output.kind).to_equal(CodegenOutputKind.GpuCode)

    it "creates interpreted output":
        val output = CodegenOutput.interpreted("interp_mod")
        expect(output.name).to_equal("interp_mod")
        expect(output.kind).to_equal(CodegenOutputKind.InterpretedResult)
        expect(output.has_text_output).to_equal(false)
        expect(output.has_object_code).to_equal(false)

    it "converts to CompiledModule":
        val output = CodegenOutput.text("mod", "code")
        val compiled = output.to_compiled_module()
        expect(compiled.name).to_equal("mod")

describe "CodegenFactory":
    it "creates LLVM codegen adapter":
        val opts = compileoptions_default_options()
        val cg = CodegenFactory.create(BackendKind.Llvm, opts)
        expect(cg.backend_kind()).to_equal(BackendKind.Llvm)
        expect(cg.backend_name()).to_equal("llvm")
        expect(cg.output_kind()).to_equal(CodegenOutputKind.ObjectCode)

    it "creates C codegen adapter":
        val opts = compileoptions_default_options()
        val cg = CodegenFactory.create(BackendKind.CCodegen, opts)
        expect(cg.backend_kind()).to_equal(BackendKind.CCodegen)
        expect(cg.backend_name()).to_equal("c")
        expect(cg.output_kind()).to_equal(CodegenOutputKind.TextSource)

    it "creates Native codegen adapter":
        val opts = compileoptions_default_options()
        val cg = CodegenFactory.create(BackendKind.Native, opts)
        expect(cg.backend_kind()).to_equal(BackendKind.Native)
        expect(cg.backend_name()).to_equal("native")
        expect(cg.output_kind()).to_equal(CodegenOutputKind.ObjectCode)

    it "creates Interpreter codegen adapter":
        val opts = compileoptions_default_options()
        val cg = CodegenFactory.create(BackendKind.Interpreter, opts)
        expect(cg.backend_kind()).to_equal(BackendKind.Interpreter)
        expect(cg.backend_name()).to_equal("interpreter")
        expect(cg.output_kind()).to_equal(CodegenOutputKind.InterpretedResult)

    it "creates Cranelift codegen adapter":
        val opts = compileoptions_default_options()
        val cg = CodegenFactory.create(BackendKind.Cranelift, opts)
        expect(cg.backend_kind()).to_equal(BackendKind.Cranelift)
        expect(cg.backend_name()).to_equal("cranelift")

    it "creates WASM codegen adapter":
        val opts = compileoptions_default_options()
        val cg = CodegenFactory.create(BackendKind.Wasm, opts)
        expect(cg.backend_kind()).to_equal(BackendKind.Wasm)
        expect(cg.backend_name()).to_equal("wasm")

    it "creates CUDA backend with Codegen trait":
        val opts = compileoptions_default_options()
        val cg = CodegenFactory.create(BackendKind.Cuda, opts)
        expect(cg.backend_kind()).to_equal(BackendKind.Cuda)
        expect(cg.backend_name()).to_equal("cuda")
        expect(cg.output_kind()).to_equal(CodegenOutputKind.GpuCode)

    it "creates Vulkan backend with Codegen trait":
        val opts = compileoptions_default_options()
        val cg = CodegenFactory.create(BackendKind.Vulkan, opts)
        expect(cg.backend_kind()).to_equal(BackendKind.Vulkan)
        expect(cg.backend_name()).to_equal("vulkan")
        expect(cg.output_kind()).to_equal(CodegenOutputKind.GpuCode)

    it "creates Lean backend with Codegen trait":
        val opts = compileoptions_default_options()
        val cg = CodegenFactory.create(BackendKind.Lean, opts)
        expect(cg.backend_kind()).to_equal(BackendKind.Lean)
        expect(cg.backend_name()).to_equal("lean")
        expect(cg.output_kind()).to_equal(CodegenOutputKind.TextSource)

    it "creates VHDL backend with Codegen trait":
        val opts = compileoptions_default_options()
        val cg = CodegenFactory.create(BackendKind.Vhdl, opts)
        expect(cg.backend_kind()).to_equal(BackendKind.Vhdl)
        expect(cg.backend_name()).to_equal("vhdl")
        expect(cg.output_kind()).to_equal(CodegenOutputKind.TextSource)

describe "Codegen adapter target support":
    it "LLVM supports all targets":
        val opts = compileoptions_default_options()
        val cg = CodegenFactory.create(BackendKind.Llvm, opts)
        expect(cg.supports_target(CodegenTarget.X86_64)).to_equal(true)
        expect(cg.supports_target(CodegenTarget.AArch64)).to_equal(true)

    it "Interpreter supports all targets":
        val opts = compileoptions_default_options()
        val cg = CodegenFactory.create(BackendKind.Interpreter, opts)
        expect(cg.supports_target(CodegenTarget.X86_64)).to_equal(true)
        expect(cg.supports_target(CodegenTarget.AArch64)).to_equal(true)

    it "Native supports CPU targets":
        val opts = compileoptions_default_options()
        val cg = CodegenFactory.create(BackendKind.Native, opts)
        expect(cg.supports_target(CodegenTarget.X86_64)).to_equal(true)
        expect(cg.supports_target(CodegenTarget.AArch64)).to_equal(true)
        expect(cg.supports_target(CodegenTarget.Riscv64)).to_equal(true)
