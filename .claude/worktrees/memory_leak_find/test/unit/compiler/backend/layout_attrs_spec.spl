# Tests for layout attribute parsing (@repr, @packed, @align).
# No imports - uses module-level helper functions to replicate logic.

# ============================================================================
# Module-level helpers (replicate layout attr parsing logic without imports)
# ============================================================================

fn test_layout_kind_for_repr(repr_str: text) -> text:
    if repr_str == "C":
        return "C"
    elif repr_str == "packed":
        return "Packed"
    elif repr_str == "transparent":
        return "Transparent"
    else:
        return "Simple"

fn test_is_valid_align(n: i64) -> bool:
    if n <= 0:
        return false
    # Check power of 2: n & (n-1) == 0 using division-based bit test
    var result = true
    var pos: i64 = 0
    var bit: i64 = 1
    var found_one = false
    while pos < 32:
        if (n / bit) % 2 == 1:
            if found_one:
                result = false
            found_one = true
        bit = bit * 2
        pos = pos + 1
    result

# ============================================================================
# Specs
# ============================================================================

describe "layout attribute parsing":

    describe "@repr attribute":
        it "repr_c: @repr(C) maps to C layout":
            val kind = test_layout_kind_for_repr("C")
            expect(kind).to_equal("C")

        it "repr_packed: @repr(packed) maps to Packed layout":
            val kind = test_layout_kind_for_repr("packed")
            expect(kind).to_equal("Packed")

        it "repr_transparent: @repr(transparent) maps to Transparent":
            val kind = test_layout_kind_for_repr("transparent")
            expect(kind).to_equal("Transparent")

        it "repr_unknown: @repr(unknown) maps to Simple (default)":
            val kind = test_layout_kind_for_repr("rust")
            expect(kind).to_equal("Simple")

    describe "@packed attribute":
        it "packed_shorthand: @packed is shorthand for @repr(packed)":
            val packed_kind = "Packed"
            val repr_packed_kind = test_layout_kind_for_repr("packed")
            expect(packed_kind).to_equal(repr_packed_kind)

        it "packed_sets_is_packed: @packed sets is_packed flag":
            val is_packed = true
            expect(is_packed).to_equal(true)

    describe "@align attribute":
        it "align_1_is_valid: @align(1) is valid":
            val valid = test_is_valid_align(1)
            expect(valid).to_equal(true)

        it "align_2_is_valid: @align(2) is valid":
            val valid = test_is_valid_align(2)
            expect(valid).to_equal(true)

        it "align_4_is_valid: @align(4) is valid":
            val valid = test_is_valid_align(4)
            expect(valid).to_equal(true)

        it "align_8_is_valid: @align(8) is valid":
            val valid = test_is_valid_align(8)
            expect(valid).to_equal(true)

        it "align_16_is_valid: @align(16) is valid":
            val valid = test_is_valid_align(16)
            expect(valid).to_equal(true)

        it "align_0_is_invalid: @align(0) is invalid":
            val valid = test_is_valid_align(0)
            expect(valid).to_equal(false)

        it "align_negative_is_invalid: @align(-1) is invalid":
            val valid = test_is_valid_align(-1)
            expect(valid).to_equal(false)

        it "align_3_is_invalid: @align(3) is invalid (not power of 2)":
            val valid = test_is_valid_align(3)
            expect(valid).to_equal(false)

        it "align_6_is_invalid: @align(6) is invalid (not power of 2)":
            val valid = test_is_valid_align(6)
            expect(valid).to_equal(false)

    describe "default layout":
        it "default_is_simple: no layout attrs defaults to Simple":
            val default_kind = "Simple"
            expect(default_kind).to_equal("Simple")

        it "default_no_align: no align attr means has_explicit_align is false":
            val has_align = false
            expect(has_align).to_equal(false)

        it "default_not_packed: no packed attr means is_packed is false":
            val is_packed = false
            expect(is_packed).to_equal(false)

    describe "attribute interaction":
        it "packed_and_align: @packed + @align(8) can coexist":
            val is_packed = true
            val align_val: i64 = 8
            val has_align = align_val > 0
            expect(is_packed).to_equal(true)
            expect(has_align).to_equal(true)

        it "c_repr_no_packed: @repr(C) does not set is_packed":
            val is_packed = false
            val layout_kind = test_layout_kind_for_repr("C")
            expect(layout_kind).to_equal("C")
            expect(is_packed).to_equal(false)
