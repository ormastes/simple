"""
# Numbered Directory Resolution Specification

**Feature IDs:** #LAYER-001
**Category:** Infrastructure
**Difficulty:** 2/5
**Status:** Implemented

## Overview

Tests that the module resolver correctly handles numbered directory prefixes
(NN.name/ pattern) by stripping the numeric prefix during resolution.

## Behavior

- `use compiler.frontend.X` resolves through `10.frontend/X.spl`
- `use compiler.mir.mir_data` resolves through `50.mir/mir_data.spl`
- Non-numbered directories resolve normally
- Invalid prefixes (non-numeric) are ignored
"""

import std.spec

# ============================================================================
# Test Group 1: Prefix Stripping Logic
# ============================================================================

describe "Numbered Directory Prefix Stripping":
    """
    ## Prefix Stripping

    Validates that NN. prefixes are correctly identified and stripped
    from directory names during module resolution.
    """

    context "when directory has valid 2-digit prefix":
        it "strips prefix and matches segment":
            # 10.frontend -> frontend
            val dir_name = "10.frontend"
            val dot_idx = dir_name.index_of(".")
            val idx = dot_idx ?? -1
            expect(idx).to_equal(2)
            val name = dir_name.substring(idx + 1)
            expect(name).to_equal("frontend")

        it "handles single-digit prefix":
            # 0.common -> common
            val dir_name = "0.common"
            val dot_idx = dir_name.index_of(".")
            val idx = dot_idx ?? -1
            expect(idx).to_equal(1)
            val name = dir_name.substring(idx + 1)
            expect(name).to_equal("common")

        it "handles 3-digit prefix":
            # 100.extra -> extra (if range allowed)
            val dir_name = "100.extra"
            val dot_idx = dir_name.index_of(".")
            val idx = dot_idx ?? -1
            expect(idx).to_equal(3)
            val name = dir_name.substring(idx + 1)
            expect(name).to_equal("extra")

    context "when directory has no numeric prefix":
        it "does not match NN.name pattern":
            val dir_name = "backend"
            val dot_idx = dir_name.index_of(".")
            val idx = dot_idx ?? -1
            expect(idx).to_equal(-1)

    context "when dot is not after digits":
        it "ignores non-numeric prefixes":
            val dir_name = "abc.frontend"
            val dot_idx = dir_name.index_of(".")
            val idx = dot_idx ?? 0
            val prefix = dir_name.substring(0, idx)
            # Verify prefix contains non-digits
            var all_digits = true
            for ch in prefix:
                if ch < "0" or ch > "9":
                    all_digits = false
            expect(all_digits).to_equal(false)


# ============================================================================
# Test Group 2: Layer Number Extraction
# ============================================================================

describe "Layer Number Extraction":
    """
    ## Layer Numbers

    Validates extraction of layer numbers from numbered directory names.
    """

    it "extracts layer 0 from 00.common":
        val dir = "00.common"
        val dot_idx = dir.index_of(".")
        val idx = dot_idx ?? 0
        val prefix = dir.substring(0, idx)
        # Parse: "00" -> 0
        var num: i64 = 0
        for ch in prefix:
            num = num * 10 + (ch.to_i64() - "0".to_i64())
        expect(num).to_equal(0)

    it "extracts layer 70 from 70.backend":
        val dir = "70.backend"
        val dot_idx = dir.index_of(".")
        val idx = dot_idx ?? 0
        val prefix = dir.substring(0, idx)
        var num: i64 = 0
        for ch in prefix:
            num = num * 10 + (ch.to_i64() - "0".to_i64())
        expect(num).to_equal(70)

    it "extracts layer 99 from 99.loader":
        val dir = "99.loader"
        val dot_idx = dir.index_of(".")
        val idx = dot_idx ?? 0
        val prefix = dir.substring(0, idx)
        var num: i64 = 0
        for ch in prefix:
            num = num * 10 + (ch.to_i64() - "0".to_i64())
        expect(num).to_equal(99)
