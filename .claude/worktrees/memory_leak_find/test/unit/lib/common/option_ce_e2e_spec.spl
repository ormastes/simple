# OptionCE end-to-end spec
#
# Tests CE desugaring in eval.spl via `ce option_ce:` block syntax.
# Verifies that STMT_BIND short-circuits on nil (None) and binds vars on Some.

use std.option_ce.{option_ce_bind, option_ce_return, option_ce_zero}

describe "ce option_ce block desugaring":
    describe "successful binds":
        it "evaluates final expression when all binds succeed":
            val result = ce option_ce:
                bind user = "alice"
                bind profile = "admin"
                "{user}:{profile}"
            expect(result).to_equal("alice:admin")

        it "single bind returns value in final expr":
            val result = ce option_ce:
                bind x = 99
                x * 2
            expect(result).to_equal(198)

        it "binds two values and combines":
            val result = ce option_ce:
                bind a = 3
                bind b = 4
                a + b
            expect(result).to_equal(7)

        it "returns string length from bound value":
            val result = ce option_ce:
                bind s = "hello"
                s.len()
            expect(result).to_equal(5)

    describe "short-circuit on None (nil)":
        it "returns nil when first bind is nil":
            val result = ce option_ce:
                bind x = nil
                bind y = "unreachable"
                y
            expect(result).to_be_nil()

        it "returns nil when second bind is nil":
            val result = ce option_ce:
                bind first = "found"
                bind second = nil
                "{first}+{second}"
            expect(result).to_be_nil()

        it "stops evaluation at first nil bind":
            var reached = 0
            val result = ce option_ce:
                bind x = nil
                reached = 1
                x
            expect(result).to_be_nil()

    describe "nested CE blocks":
        it "inner ce block returns value used in outer":
            val inner = ce option_ce:
                bind x = "inner"
                x
            val result = ce option_ce:
                bind y = inner
                "outer: {y}"
            expect(result).to_equal("outer: inner")

        it "inner nil propagates to outer when used as bind rhs":
            val inner = ce option_ce:
                bind x = nil
                x
            val result = ce option_ce:
                bind y = inner
                "should not reach"
            expect(result).to_be_nil()
