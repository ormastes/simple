# Error Trace Spec - Tests for error_trace.spl
#
# Tests the Zig-style error propagation trace library.

use std.error_trace.{ErrorSite, ErrorTrace}
use std.error_trace.{error_trace_new, error_trace_new_with_capacity, error_site_new}
use std.error_trace.{error_trace_begin, error_trace_end, error_trace_push, error_trace_clear}
use std.error_trace.{error_trace_depth, error_trace_is_active, error_trace_format, error_site_at}
use std.error_trace.{trace_depth, trace_site_at, trace_format}

describe "ErrorSite":
    it "creates an error site with correct fields":
        val site = ErrorSite(file: "main.spl", line: 42, function: "read_config")
        expect(site.file).to_equal("main.spl")
        expect(site.line).to_equal(42)
        expect(site.function).to_equal("read_config")

    it "creates an error site via factory function":
        val site = error_site_new("config.spl", 10, "parse")
        expect(site.file).to_equal("config.spl")
        expect(site.line).to_equal(10)
        expect(site.function).to_equal("parse")

describe "ErrorTrace factory":
    it "creates empty trace with default capacity":
        val trace = error_trace_new()
        expect(trace.depth).to_equal(0)
        expect(trace.capacity).to_equal(32)

    it "creates empty trace with custom capacity":
        val trace = error_trace_new_with_capacity(16)
        expect(trace.depth).to_equal(0)
        expect(trace.capacity).to_equal(16)

describe "Active trace - begin and depth":
    it "trace starts empty after begin":
        error_trace_begin()
        expect(error_trace_depth()).to_equal(0)
        error_trace_clear()

    it "is active after begin":
        error_trace_begin()
        expect(error_trace_is_active()).to_equal(true)
        error_trace_clear()

    it "is not active after clear":
        error_trace_begin()
        error_trace_clear()
        expect(error_trace_is_active()).to_equal(false)

describe "Active trace - push records sites":
    it "push increments depth":
        error_trace_begin()
        error_trace_push("a.spl", 1, "fn_a")
        expect(error_trace_depth()).to_equal(1)
        error_trace_clear()

    it "push records file, line, function":
        error_trace_begin()
        error_trace_push("src/app/config.spl", 14, "read_config")
        val site = error_site_at(0)
        expect(site.file).to_equal("src/app/config.spl")
        expect(site.line).to_equal(14)
        expect(site.function).to_equal("read_config")
        error_trace_clear()

    it "multiple pushes accumulate":
        error_trace_begin()
        error_trace_push("config.spl", 14, "read_config")
        error_trace_push("main.spl", 8, "main")
        expect(error_trace_depth()).to_equal(2)
        error_trace_clear()

    it "sites are recorded in push order":
        error_trace_begin()
        error_trace_push("a.spl", 1, "fn_a")
        error_trace_push("b.spl", 2, "fn_b")
        val first = error_site_at(0)
        val second = error_site_at(1)
        expect(first.file).to_equal("a.spl")
        expect(second.file).to_equal("b.spl")
        error_trace_clear()

describe "Active trace - push ignored when not active":
    it "push before begin does nothing":
        error_trace_clear()
        error_trace_push("x.spl", 1, "fn_x")
        expect(error_trace_depth()).to_equal(0)

describe "Active trace - clear resets state":
    it "clear resets depth to 0":
        error_trace_begin()
        error_trace_push("a.spl", 1, "fn_a")
        error_trace_push("b.spl", 2, "fn_b")
        error_trace_clear()
        expect(error_trace_depth()).to_equal(0)

describe "Active trace - error_site_at bounds":
    it "out of bounds index returns empty site":
        error_trace_begin()
        error_trace_push("a.spl", 1, "fn_a")
        val bad = error_site_at(99)
        expect(bad.file).to_equal("")
        expect(bad.line).to_equal(0)
        expect(bad.function).to_equal("")
        error_trace_clear()

    it "negative index returns empty site":
        error_trace_begin()
        error_trace_push("a.spl", 1, "fn_a")
        val bad = error_site_at(-1)
        expect(bad.file).to_equal("")
        error_trace_clear()

describe "Active trace - capacity limit":
    it "does not crash when pushing beyond capacity":
        error_trace_begin()
        var i = 0
        for i in 40:
            error_trace_push("a.spl", i, "fn_a")
        val depth = error_trace_depth()
        expect(depth).to_equal(32)
        error_trace_clear()

describe "Active trace - error_trace_end":
    it "end returns trace with recorded sites":
        error_trace_begin()
        error_trace_push("config.spl", 14, "read_config")
        error_trace_push("main.spl", 8, "main")
        val trace = error_trace_end()
        expect(trace.depth).to_equal(2)

    it "end stops collection":
        error_trace_begin()
        val trace = error_trace_end()
        expect(error_trace_is_active()).to_equal(false)

    it "pushes after end are ignored":
        error_trace_begin()
        error_trace_push("a.spl", 1, "fn_a")
        val trace = error_trace_end()
        error_trace_push("b.spl", 2, "fn_b")
        expect(error_trace_depth()).to_equal(1)

describe "Trace format":
    it "formats empty trace":
        error_trace_begin()
        val msg = error_trace_format()
        expect(msg).to_equal("Error propagation trace: (empty)")
        error_trace_clear()

    it "formats non-empty trace contains site info":
        error_trace_begin()
        error_trace_push("config.spl", 14, "read_config")
        val msg = error_trace_format()
        expect(msg).to_contain("config.spl")
        expect(msg).to_contain("read_config")
        error_trace_clear()

    it "format starts with header":
        error_trace_begin()
        error_trace_push("a.spl", 1, "fn_a")
        val msg = error_trace_format()
        expect(msg).to_start_with("Error propagation trace:")
        error_trace_clear()

describe "Completed trace inspection":
    it "trace_depth returns correct depth":
        error_trace_begin()
        error_trace_push("a.spl", 1, "fn_a")
        error_trace_push("b.spl", 2, "fn_b")
        val trace = error_trace_end()
        expect(trace_depth(trace)).to_equal(2)

    it "trace_site_at returns correct site":
        error_trace_begin()
        error_trace_push("config.spl", 14, "read_config")
        val trace = error_trace_end()
        val site = trace_site_at(trace, 0)
        expect(site.file).to_equal("config.spl")
        expect(site.line).to_equal(14)
        expect(site.function).to_equal("read_config")

    it "trace_site_at out of bounds returns empty site":
        error_trace_begin()
        error_trace_push("a.spl", 1, "fn_a")
        val trace = error_trace_end()
        val bad = trace_site_at(trace, 99)
        expect(bad.file).to_equal("")

    it "trace_format on completed trace with sites is non-empty":
        error_trace_begin()
        error_trace_push("src/app/config.spl", 14, "read_config")
        val trace = error_trace_end()
        val msg = trace_format(trace)
        expect(msg).to_contain("src/app/config.spl")

    it "trace_format on empty trace returns empty message":
        val trace = error_trace_new()
        val msg = trace_format(trace)
        expect(msg).to_equal("Error propagation trace: (empty)")
