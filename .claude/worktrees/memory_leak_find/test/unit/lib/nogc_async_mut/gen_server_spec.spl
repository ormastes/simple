# GenServer spec
#
# Tests for src/lib/gen_server.spl

use std.gen_server.{
    GenServer, GenServerRunner,
    gen_server_runner, gen_server_start, gen_server_stop,
    gen_server_is_running, gen_server_call, gen_server_cast
}

describe "GenServer stdlib":
    describe "gen_server_runner":
        it "creates runner with initial state":
            val runner = gen_server_runner("counter", "0")
            expect(runner.name).to_equal("counter")
            expect(runner.state).to_equal("0")
            expect(runner.running).to_equal(false)

    describe "lifecycle":
        it "starts the runner":
            val runner = gen_server_runner("srv", "init")
            gen_server_start(runner)
            expect(gen_server_is_running(runner)).to_equal(true)

        it "stops the runner":
            val runner = gen_server_runner("srv", "init")
            gen_server_start(runner)
            gen_server_stop(runner)
            expect(gen_server_is_running(runner)).to_equal(false)

    describe "gen_server_call":
        it "updates state and returns new state":
            val runner = gen_server_runner("counter", "0")
            val result = gen_server_call(runner, "inc", fn(req, st):
                "1"
            )
            expect(result).to_equal("1")
            expect(runner.state).to_equal("1")

    describe "gen_server_cast":
        it "updates state without return":
            val runner = gen_server_runner("counter", "0")
            gen_server_cast(runner, "reset", fn(msg, st):
                "0"
            )
            expect(runner.state).to_equal("0")
