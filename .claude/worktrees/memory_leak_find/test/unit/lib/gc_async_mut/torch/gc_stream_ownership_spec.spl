# GC Stream Ownership Pattern Spec
# Documents the 3-field Stream pattern in gc_async_mut/torch/torch_training.spl

var stream_freed = 0

fn mock_stream_destroy(h: i64):
    stream_freed = stream_freed + 1

struct MockStream:
    handle: i64
    owns_handle: bool
    device_id: i64

    static fn create(h: i64, device: i64) -> MockStream:
        MockStream(handle: h, owns_handle: true, device_id: device)

    fn drop():
        if self.owns_handle:
            mock_stream_destroy(self.handle)

    fn device() -> i64:
        self.device_id

describe "GC Stream Ownership":
    describe "3-field Stream pattern":
        it "stream has handle, owns_handle, and device_id":
            val s = MockStream__create(1, 0)
            expect(s.handle).to_equal(1)
            expect(s.owns_handle).to_equal(true)
            expect(s.device_id).to_equal(0)

        it "owned stream frees on drop":
            val prev = stream_freed
            val s = MockStream__create(2, 0)
            s.drop()
            expect(stream_freed).to_equal(prev + 1)

        it "borrowed stream does not free":
            val prev = stream_freed
            val s = MockStream(handle: 3, owns_handle: false, device_id: 0)
            s.drop()
            expect(stream_freed).to_equal(prev)

        it "device id preserved across ownership":
            val s = MockStream__create(4, 1)
            expect(s.device()).to_equal(1)
