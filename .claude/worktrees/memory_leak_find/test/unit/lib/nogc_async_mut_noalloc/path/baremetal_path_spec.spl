# Baremetal Path - Fixed-Buffer Path Operations Tests

describe "Baremetal Path":

    describe "constants":
        it "defines path separator and max length":
            expect(PATH_SEP).to_equal("/")
            expect(MAX_PATH_LEN).to_equal(256)

    describe "bm_path_basename":
        it "extracts filename from path":
            expect(bm_path_basename("/tmp/device.log")).to_equal("device.log")

        it "extracts last component":
            expect(bm_path_basename("/home/user/docs")).to_equal("docs")

        it "handles trailing slash":
            expect(bm_path_basename("/tmp/logs/")).to_equal("logs")

        it "returns empty for empty input":
            expect(bm_path_basename("")).to_equal("")

        it "returns filename without directory":
            expect(bm_path_basename("file.txt")).to_equal("file.txt")

    describe "bm_path_dirname":
        it "extracts directory from path":
            expect(bm_path_dirname("/tmp/device.log")).to_equal("/tmp")

        it "returns root for file in root":
            expect(bm_path_dirname("/file.txt")).to_equal("/")

        it "returns dot for bare filename":
            expect(bm_path_dirname("file.txt")).to_equal(".")

        it "returns dot for empty input":
            expect(bm_path_dirname("")).to_equal(".")

        it "returns root for root path":
            expect(bm_path_dirname("/")).to_equal("/")

    describe "bm_path_extension":
        it "extracts file extension":
            expect(bm_path_extension("device.log")).to_equal("log")

        it "extracts extension from full path":
            expect(bm_path_extension("/tmp/device.log")).to_equal("log")

        it "returns empty for no extension":
            expect(bm_path_extension("README")).to_equal("")

        it "returns empty for hidden files":
            expect(bm_path_extension(".gitignore")).to_equal("")

        it "returns last extension":
            expect(bm_path_extension("archive.tar.gz")).to_equal("gz")

    describe "bm_path_join":
        it "joins base and child":
            expect(bm_path_join("/tmp", "device.log")).to_equal("/tmp/device.log")

        it "handles trailing slash in base":
            expect(bm_path_join("/tmp/", "device.log")).to_equal("/tmp/device.log")

        it "handles leading slash in child":
            expect(bm_path_join("/tmp", "/device.log")).to_equal("/tmp/device.log")

        it "returns child when base empty":
            expect(bm_path_join("", "file.txt")).to_equal("file.txt")

        it "returns base when child empty":
            expect(bm_path_join("/tmp", "")).to_equal("/tmp")

    describe "bm_path_normalize":
        it "resolves dot components":
            expect(bm_path_normalize("foo/./bar")).to_equal("foo/bar")

        it "resolves double-dot components":
            expect(bm_path_normalize("foo/baz/../bar")).to_equal("foo/bar")

        it "preserves absolute paths":
            expect(bm_path_normalize("/tmp/logs")).to_equal("/tmp/logs")

        it "returns dot for empty path":
            expect(bm_path_normalize("")).to_equal(".")

        it "handles root path":
            expect(bm_path_normalize("/")).to_equal("/")

        it "handles complex nested case":
            expect(bm_path_normalize("/a/b/./c/../d")).to_equal("/a/b/d")

    describe "backslash replacement":
        it "replaces backslashes with forward slashes":
            val result = bm_replace_backslash("foo\\bar\\baz")
            expect(result).to_equal("foo/bar/baz")

        it "leaves forward slashes unchanged":
            val result = bm_replace_backslash("foo/bar/baz")
            expect(result).to_equal("foo/bar/baz")

    describe "file operations":
        it "opens and closes file":
            val handle = bm_file_open("/tmp/test.log", 1)
            expect(handle).to_be_greater_than(0)
            bm_file_close(handle)

        it "writes to file":
            val handle = bm_file_open("/tmp/test.log", 1)
            val result = bm_file_write(handle, "hello")
            expect(result).to_equal(0)
            bm_file_close(handle)

        it "returns -1 for invalid handle write":
            val result = bm_file_write(-1, "hello")
            expect(result).to_equal(-1)
