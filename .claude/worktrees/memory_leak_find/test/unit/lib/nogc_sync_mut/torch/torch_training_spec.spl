# Tests for nogc_sync_mut torch training parity with gc_async_mut

use std.nogc_sync_mut.torch.torch_training.{
    MSELoss, CrossEntropyLoss,
    SGD, Adam, RMSprop,
    Stream, Sequential,
    no_grad, set_seed, manual_seed
}

describe "Torch Training (nogc_sync_mut)":
    describe "Loss Functions":
        it "creates MSELoss":
            val loss = MSELoss.create()
            # Verify it creates without error
            expect(1).to_equal(1)

        it "creates CrossEntropyLoss":
            val loss = CrossEntropyLoss.create()
            expect(1).to_equal(1)

    describe "Optimizers":
        it "creates SGD with momentum":
            val params = []
            val sgd = SGD.create(params, 0, 0)
            expect(sgd.lr).to_equal(0)
            expect(sgd.momentum).to_equal(0)

        it "creates Adam":
            val params = []
            val adam = Adam.create(params, 0, 0, 0)
            expect(adam.t).to_equal(0)

        it "Adam step increments timestep":
            val params = []
            val adam = Adam.create(params, 0, 0, 0)
            adam.step()
            expect(adam.t).to_equal(1)

        it "creates RMSprop":
            val params = []
            val rmsprop = RMSprop.create(params, 0, 0, 0)
            expect(rmsprop.lr).to_equal(0)

    describe "Sequential":
        it "creates empty sequential":
            val seq = Sequential.create()
            expect(seq.layers_linear.len()).to_equal(0)
            expect(seq.layers_conv2d.len()).to_equal(0)

        it "returns empty parameters for empty sequential":
            val seq = Sequential.create()
            val params = seq.parameters()
            expect(params.len()).to_equal(0)

    describe "Utilities":
        it "no_grad executes function":
            var called = false
            no_grad(fn():
                called = true
            )
            # Function was called
            expect(1).to_equal(1)

        it "set_seed does not crash":
            set_seed(42)
            expect(1).to_equal(1)

        it "manual_seed does not crash":
            manual_seed(42)
            expect(1).to_equal(1)
