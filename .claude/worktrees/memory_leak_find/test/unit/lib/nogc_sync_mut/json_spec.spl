"""
JSON Module Specification

Tests for JSON-like data handling including building and querying
dict/list structures, string serialization patterns, and round-trip consistency.
"""

describe "JSON-like data structures":
    """
    Validates JSON-like data handling using dicts and lists,
    including construction, access, nesting, and serialization patterns.
    """
    context "Dict operations":
        it "creates empty dict":
            val d = {}
            expect(d.len()).to_equal(0)

        it "creates dict with values":
            val d = {"name": "Alice", "age": 30}
            expect(d["name"]).to_equal("Alice")
            expect(d["age"]).to_equal(30)

        it "adds values to dict":
            var d = {}
            d["key"] = "value"
            expect(d["key"]).to_equal("value")
            expect(d.len()).to_equal(1)

        it "overwrites existing values":
            var d = {"x": 1}
            d["x"] = 2
            expect(d["x"]).to_equal(2)

    context "List operations":
        it "creates empty list":
            val arr = []
            expect(arr.len()).to_equal(0)

        it "creates list with values":
            val arr = [1, 2, 3]
            expect(arr.len()).to_equal(3)
            expect(arr[0]).to_equal(1)

        it "appends to list":
            var arr = [1, 2]
            arr.append(3)
            expect(arr.len()).to_equal(3)
            expect(arr[2]).to_equal(3)

    context "Nested structures":
        it "nests dicts in dicts":
            val d = {"user": {"name": "Bob", "id": 42}}
            expect(d["user"]["name"]).to_equal("Bob")
            expect(d["user"]["id"]).to_equal(42)

        it "nests lists in dicts":
            val d = {"items": [1, 2, 3]}
            expect(d["items"].len()).to_equal(3)
            expect(d["items"][0]).to_equal(1)

        it "nests dicts in lists":
            val arr = [{"a": 1}, {"b": 2}]
            expect(arr[0]["a"]).to_equal(1)
            expect(arr[1]["b"]).to_equal(2)

    context "String serialization patterns":
        it "converts int to string":
            val s = "{42}"
            expect(s).to_equal("42")

        it "converts bool to string":
            val t = "{true}"
            val f = "{false}"
            expect(t).to_equal("true")
            expect(f).to_equal("false")

        it "builds JSON-like string manually":
            val name = "Alice"
            val age = 30
            val json_str = "{\"name\": \"{name}\", \"age\": {age}}"
            expect(json_str).to_contain("Alice")
            expect(json_str).to_contain("30")

    context "Type checking":
        it "distinguishes types":
            val num = 42
            val text_val = "hello"
            val arr = [1, 2]
            val d = {"k": "v"}
            expect(num).to_equal(42)
            expect(text_val).to_equal("hello")
            expect(arr.len()).to_equal(2)
            expect(d.len()).to_equal(1)

    context "Null handling":
        it "handles nil values":
            val x = nil
            expect(x).to_be_nil()

        it "dict with nil value":
            val d = {"key": nil}
            expect(d["key"]).to_be_nil()

    context "Round-trip patterns":
        it "preserves data through dict operations":
            var d = {}
            d["name"] = "test"
            d["count"] = 42
            d["active"] = true
            expect(d["name"]).to_equal("test")
            expect(d["count"]).to_equal(42)
            expect(d["active"]).to_equal(true)

        it "preserves nested data":
            var outer = {}
            var inner = {}
            inner["x"] = 10
            outer["point"] = inner
            expect(outer["point"]["x"]).to_equal(10)
