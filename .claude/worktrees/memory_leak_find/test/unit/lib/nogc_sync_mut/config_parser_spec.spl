# Config Parser Tests
#
# Tests for the unified configuration parser module

use std.spec.{describe, it, expect}

# Create symlink for local resolution
use std.config_parser.{parse_sdn_config, find_section, get_config_int, get_config_bool, get_config_field, get_config_float, get_config_list, strip_quotes, ConfigSection, ConfigParseResult}

fn test():
    describe "config_parser":
        it "parses simple section":
            val content = "database:\n  host: localhost\n  port: 5432"
            val result = parse_sdn_config(content)

            expect(result.sections.len()).to_equal(1)
            val section = result.sections[0]
            expect(section.name).to_equal("database")
            expect(section.fields["host"]).to_equal("localhost")
            expect(section.fields["port"]).to_equal("5432")

        it "strips quotes from values":
            val content = "app:\n  name: \"My App\"\n  version: '1.0'"
            val result = parse_sdn_config(content)
            val section = result.sections[0]

            expect(section.fields["name"]).to_equal("My App")
            expect(section.fields["version"]).to_equal("1.0")

        it "handles multiple sections":
            val content = "section1:\n  key1: val1\nsection2:\n  key2: val2"
            val result = parse_sdn_config(content)

            expect(result.sections.len()).to_equal(2)
            expect(result.sections[0].name).to_equal("section1")
            expect(result.sections[1].name).to_equal("section2")

        it "skips empty lines and comments":
            val content = "# Comment\nsection1:\n  # Another comment\n  key1: val1\n\n  key2: val2"
            val result = parse_sdn_config(content)

            expect(result.sections.len()).to_equal(1)
            val section = result.sections[0]
            expect(section.fields["key1"]).to_equal("val1")
            expect(section.fields["key2"]).to_equal("val2")

        it "get_config_int returns integer values":
            val content = "config:\n  count: 42\n  timeout: 1000"
            val result = parse_sdn_config(content)
            val section = result.sections[0]

            expect(get_config_int(section, "count", 0)).to_equal(42)
            expect(get_config_int(section, "timeout", 0)).to_equal(1000)

        it "get_config_int returns default for missing keys":
            val content = "config:\n  count: 42"
            val result = parse_sdn_config(content)
            val section = result.sections[0]

            expect(get_config_int(section, "missing", 99)).to_equal(99)

        it "get_config_bool returns boolean values":
            val content = "config:\n  enabled: true\n  disabled: false"
            val result = parse_sdn_config(content)
            val section = result.sections[0]

            expect(get_config_bool(section, "enabled", false)).to_equal(true)
            expect(get_config_bool(section, "disabled", true)).to_equal(false)

        it "get_config_bool returns default for missing keys":
            val content = "config:\n  enabled: true"
            val result = parse_sdn_config(content)
            val section = result.sections[0]

            expect(get_config_bool(section, "missing", true)).to_equal(true)

        it "get_config_float returns float values":
            val content = "config:\n  threshold: 0.85\n  factor: 2.5"
            val result = parse_sdn_config(content)
            val section = result.sections[0]

            expect(get_config_float(section, "threshold", 0.0)).to_equal(0.85)
            expect(get_config_float(section, "factor", 0.0)).to_equal(2.5)

        it "get_config_field returns string values":
            val content = "config:\n  name: test\n  path: /tmp/test"
            val result = parse_sdn_config(content)
            val section = result.sections[0]

            expect(get_config_field(section, "name", "")).to_equal("test")
            expect(get_config_field(section, "path", "")).to_equal("/tmp/test")

        it "get_config_field returns default for missing keys":
            val content = "config:\n  name: test"
            val result = parse_sdn_config(content)
            val section = result.sections[0]

            expect(get_config_field(section, "missing", "default")).to_equal("default")

        it "get_config_list parses comma-separated values":
            val content = "config:\n  items: one,two,three"
            val result = parse_sdn_config(content)
            val section = result.sections[0]

            val items = get_config_list(section, "items", ",")
            expect(items.len()).to_equal(3)
            expect(items[0]).to_equal("one")
            expect(items[1]).to_equal("two")
            expect(items[2]).to_equal("three")

        it "get_config_list returns empty array for missing keys":
            val content = "config:\n  name: test"
            val result = parse_sdn_config(content)
            val section = result.sections[0]

            val items = get_config_list(section, "missing", ",")
            expect(items.len()).to_equal(0)

        it "find_section finds section by name":
            val content = "section1:\n  key1: val1\nsection2:\n  key2: val2"
            val result = parse_sdn_config(content)

            val section = find_section(result, "section2")
            expect(section.?).to_equal(true)

        it "find_section returns nil for missing section":
            val content = "section1:\n  key1: val1"
            val result = parse_sdn_config(content)

            val section = find_section(result, "missing")
            expect(section.?).to_equal(false)

        it "reports errors for key-value outside section":
            val content = "key: value"
            val result = parse_sdn_config(content)

            expect(result.errors.len()).to_be_greater_than(0)

        it "strip_quotes removes double quotes":
            val result = strip_quotes("\"hello\"")
            expect(result).to_equal("hello")

        it "strip_quotes removes single quotes":
            val result = strip_quotes("'world'")
            expect(result).to_equal("world")

        it "strip_quotes keeps unquoted strings":
            val result = strip_quotes("test")
            expect(result).to_equal("test")

        it "strip_quotes keeps mismatched quotes":
            val result = strip_quotes("\"test'")
            expect(result).to_equal("\"test'")

        it "handles section with no fields":
            val content = "empty-section:\nother-section:\n  key: value"
            val result = parse_sdn_config(content)

            expect(result.sections.len()).to_equal(2)
            val section = result.sections[0]
            expect(section.name).to_equal("empty-section")
            expect(section.fields.len()).to_equal(0)

        it "handles values with colons":
            val content = "config:\n  url: http://example.com:8080"
            val result = parse_sdn_config(content)
            val section = result.sections[0]

            expect(section.fields["url"]).to_equal("http://example.com:8080")

        it "handles indented key-value pairs":
            val content = "config:\n    key1: val1\n    key2: val2"
            val result = parse_sdn_config(content)

            expect(result.sections.len()).to_equal(1)
            val section = result.sections[0]
            expect(section.fields["key1"]).to_equal("val1")
            expect(section.fields["key2"]).to_equal("val2")
