#!/usr/bin/env simple
# Desugar lazy_val.spl module

use std.spec

extern fn rt_file_read_text(path: text) -> text
extern fn rt_file_write_text(path: text, content: text) -> bool

use app.desugar.static_methods (desugar_static_methods)
use app.desugar.rewriter (rewrite_static_calls)

describe "Desugar LazyVal":
    it "desugars lazy_val.spl":
        val input_path = "src/app/interpreter.lazy/lazy_val.spl"
        val output_path = "src/app/interpreter.lazy/lazy_val_fixed.spl"

        print ""
        print "Reading {input_path}..."
        val source_opt = rt_file_read_text(input_path)
        val source = source_opt ?? ""

        check(source != "")

        print "Pass 1: Hoisting static methods..."
        val pass1 = desugar_static_methods(source)

        print "Pass 2: Rewriting static calls..."
        val pass2 = rewrite_static_calls(pass1)

        print "Writing to {output_path}..."
        val ok = rt_file_write_text(output_path, pass2)
        check(ok)

        if ok:
            print "âœ“ Success! Desugared file written"
            print ""
            print "To apply the fix:"
            print "  cp {output_path} {input_path}"
