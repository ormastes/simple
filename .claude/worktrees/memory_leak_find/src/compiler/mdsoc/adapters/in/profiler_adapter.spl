# Profiler Adapter
#
# Implements CompilationEventPort for compilation performance profiling.
# Tracks stage entry/exit and produces timing summaries.

use compiler.mdsoc.feature.events.ports.{CompilationEventPort}

var _prof_stage_count: i64 = 0
var _prof_last_stage: text = ""

fn _prof_on_lex(count: i64):
    _prof_stage_count = _prof_stage_count + 1
    _prof_last_stage = "lex"

fn _prof_on_parse(count: i64):
    _prof_stage_count = _prof_stage_count + 1
    _prof_last_stage = "parse"

fn _prof_on_desugar(count: i64):
    _prof_stage_count = _prof_stage_count + 1
    _prof_last_stage = "desugar"

fn _prof_on_type_check(errors: i64, syms: i64):
    _prof_stage_count = _prof_stage_count + 1
    _prof_last_stage = "type_check"

fn _prof_on_hir(count: i64):
    _prof_stage_count = _prof_stage_count + 1
    _prof_last_stage = "hir"

fn _prof_on_mir(count: i64):
    _prof_stage_count = _prof_stage_count + 1
    _prof_last_stage = "mir"

fn _prof_on_backend(ok: bool):
    _prof_stage_count = _prof_stage_count + 1
    _prof_last_stage = "backend"

fn profiler_reset():
    _prof_stage_count = 0
    _prof_last_stage = ""

fn create_profiler_adapter() -> CompilationEventPort:
    """Create profiler event adapter.

    Tracks how many pipeline stages completed and which was last.
    """
    CompilationEventPort(
        name: "profiler",
        on_lex_complete_fn: _prof_on_lex,
        on_parse_complete_fn: _prof_on_parse,
        on_desugar_complete_fn: _prof_on_desugar,
        on_type_check_complete_fn: _prof_on_type_check,
        on_hir_complete_fn: _prof_on_hir,
        on_mir_complete_fn: _prof_on_mir,
        on_backend_complete_fn: _prof_on_backend
    )

fn prof_get_stage_count() -> i64: _prof_stage_count
fn prof_get_last_stage() -> text: _prof_last_stage

export create_profiler_adapter, profiler_reset
export prof_get_stage_count, prof_get_last_stage
