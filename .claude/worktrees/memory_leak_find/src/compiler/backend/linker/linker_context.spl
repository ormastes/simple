# Linker Compilation Context
#
# CompilationContext implementation for link-time lazy instantiation.
# Templates come from input SMF object files.

use compiler.common.compilation_context.{CompilationContext, InstantiationMode, ContractMode, GenericTemplate, ConcreteType, TypeRegistry}use compiler.backend.backend_types.CompiledUnituse compiler.common.di.DiContaineruse compiler.tools.aop.AopWeaveruse compiler.driver.pipeline_fn.compile_specialized_templateuse compiler.mono.monomorphize.note_sdn.InstantiationEntry
# ============================================================================
# LinkerCompilationContext
# ============================================================================

class LinkerCompilationContext(CompilationContext):
    """Linker loads templates from input SMF object files."""
    object_templates: Dict<text, GenericTemplate>
    project_di: DiContainer
    project_aop: AopWeaver
    type_reg: TypeRegistry
    recorded: [InstantiationEntry]

    fn load_template(name: text) -> text:
        if self.object_templates_contains_key(object_templates, name):
            Ok(self.object_templates[name])
        else:
            Err("Template not in objects: {name}")

    fn has_template(name: text) -> bool:
        self.object_templates_contains_key(object_templates, name)

    fn type_registry() -> TypeRegistry:
        self.type_reg

    fn contract_mode() -> ContractMode:
        # Linker applies all contracts
        ContractMode.All

    fn di_container() -> has_DiContainer:
        self.project_di

    fn aop_weaver() -> has_AopWeaver:
        self.project_aop

    fn coverage_enabled() -> bool:
        false

    fn compile_template(template: GenericTemplate, type_args: [ConcreteType]) -> text:
        compile_specialized_template(
            template, type_args,
            ContractMode.All,
            self.project_di,
            self.project_aop,
            false
        )

    fn instantiation_mode() -> InstantiationMode:
        InstantiationMode.LinkTime

    me record_instantiation(entry: InstantiationEntry):
        self.recorded = self.recorded_push(recorded, entry)


# ============================================================================
# LinkerCompilationContext Methods (was: impl LinkerCompilationContext:)
# ============================================================================

# ============================================================================
# Exports
# ============================================================================

export LinkerCompilationContext
