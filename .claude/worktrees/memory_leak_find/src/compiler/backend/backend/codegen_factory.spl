# Codegen Factory - Creates Codegen Trait Implementations
#
# Centralizes creation of Codegen trait objects from BackendKind.
# Used by Backend__for_target_and_mode() and other constructors.

use compiler.core.backend_types.{BackendKind, CodegenTarget, CompileOptions, compileoptions_default_options}
use compiler.backend.codegen_types.{Codegen}
use compiler.backend.llvm_codegen_adapter.{LlvmCodegenAdapter}
use compiler.backend.c_codegen_adapter.{CCodegenAdapter}
use compiler.backend.wasm_codegen_adapter.{WasmCodegenAdapter}
use compiler.backend.native_codegen_adapter.{NativeCodegenAdapter}
use compiler.backend.interpreter_codegen_adapter.{InterpreterCodegenAdapter}
use compiler.backend.cranelift_codegen_adapter.{CraneliftCodegenAdapter}
use compiler.backend.cuda_backend.{CudaBackend}
use compiler.backend.vulkan_backend.{VulkanBackend}
use compiler.backend.lean_backend.{LeanBackend, VerificationLevel}
use compiler.backend.vhdl_backend.{VhdlBackend}

# ============================================================================
# Codegen Factory
# ============================================================================

class CodegenFactory:
    """Creates Codegen trait objects for any BackendKind."""

    static fn create(kind: BackendKind, options: CompileOptions) -> Codegen:
        """Create a Codegen implementation for the given backend kind."""
        match kind:
            case Llvm:
                LlvmCodegenAdapter(options: options)
            case CCodegen:
                CCodegenAdapter(options: options)
            case Wasm:
                WasmCodegenAdapter(options: options)
            case Native:
                NativeCodegenAdapter(options: options)
            case Interpreter:
                InterpreterCodegenAdapter(options: options)
            case Cranelift:
                CraneliftCodegenAdapter(options: options)
            case Cuda:
                CudaBackend__create((8, 6))
            case Vulkan:
                val vk_ver = [1, 3]
                VulkanBackend__create(vk_ver)
            case Lean:
                LeanBackend__create(VerificationLevel.Full)
            case Vhdl:
                VhdlBackend__create(options.target, options)

# ============================================================================
# Exports
# ============================================================================


# Desugared static methods for bootstrap interpreter compatibility

fn CodegenFactory__create(kind: BackendKind, options: CompileOptions) -> Codegen:
    """Create a Codegen implementation for the given backend kind."""
    match kind:
        case Llvm:
            LlvmCodegenAdapter(options: options)
        case CCodegen:
            CCodegenAdapter(options: options)
        case Wasm:
            WasmCodegenAdapter(options: options)
        case Native:
            NativeCodegenAdapter(options: options)
        case Interpreter:
            InterpreterCodegenAdapter(options: options)
        case Cranelift:
            CraneliftCodegenAdapter(options: options)
        case Cuda:
            CudaBackend__create((8, 6))
        case Vulkan:
            val vk_ver = [1, 3]
            VulkanBackend__create(vk_ver)
        case Lean:
            LeanBackend__create(VerificationLevel.Full)
        case Vhdl:
            VhdlBackend__create(options.target, options)


export CodegenFactory
