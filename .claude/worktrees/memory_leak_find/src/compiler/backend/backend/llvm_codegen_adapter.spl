# LLVM Codegen Adapter
#
# Wraps MirToLlvm translator to implement the Codegen trait.
# Delegates to existing LLVM IR generation and llc compilation pipeline.

use compiler.mir.mir_data.{MirModule}
use compiler.core.backend_types.{BackendKind, CodegenTarget, CompileOptions, CompileError, compileerror_backend_error}
use compiler.backend.codegen_types.{Codegen, CodegenOutput, CodegenOutputKind}
use compiler.backend.llvm_backend.{MirToLlvm, LlvmTargetConfig, compile_ir_to_object, llc_available,
    MirToLlvm__create, LlvmTargetConfig__for_target}

# ============================================================================
# LLVM Codegen Adapter
# ============================================================================

class LlvmCodegenAdapter:
    """Adapts MirToLlvm translator to the Codegen trait interface."""
    options: CompileOptions

impl Codegen for LlvmCodegenAdapter:
    fn backend_kind() -> BackendKind: BackendKind.Llvm
    fn backend_name() -> text: "llvm"
    fn supports_target(target: CodegenTarget) -> bool: true
    fn output_kind() -> CodegenOutputKind: CodegenOutputKind.ObjectCode

    fn compile_module(module: MirModule) -> Result<CodegenOutput, CompileError>:
        # Check llc availability
        if not llc_available():
            return Err(compileerror_backend_error(BackendKind.Llvm,
                "llc not found. Install LLVM: apt install llvm (Ubuntu) or brew install llvm (macOS)"))

        # Translate MIR to LLVM IR
        val config = LlvmTargetConfig__for_target(self.options.target, nil)
        var translator = MirToLlvm__create(module.name, self.options.target, nil)
        val llvm_ir = translator.translate_module(module)

        # Compile IR to object code via llc
        val result = compile_ir_to_object(llvm_ir, config, self.options.opt_level)
        if result.is_err():
            val err_msg = result.unwrap_err()
            return Err(compileerror_backend_error(BackendKind.Llvm, err_msg))

        val bytes = result.unwrap()
        Ok(CodegenOutput__object(module.name, bytes))

# ============================================================================
# Exports
# ============================================================================

export LlvmCodegenAdapter
