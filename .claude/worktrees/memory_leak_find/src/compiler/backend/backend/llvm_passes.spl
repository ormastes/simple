# LLVM Optimization Passes
#
# LlvmPass enum and passes_for_level helper.
# Split from llvm_ir_builder.spl for modularity.

use compiler.backend.backend_api.*

# ============================================================================
# LLVM Optimization Passes
# ============================================================================

enum LlvmPass:
    """LLVM optimization passes."""
    # Analysis passes
    DominatorTree
    LoopInfo
    ScalarEvolution
    AliasAnalysis

    # Transform passes
    InstCombine
    SimplifyCFG
    Reassociate
    GVN
    LICM
    IndVarSimplify
    LoopUnroll
    LoopVectorize
    SLPVectorize
    DeadCodeElimination
    Inlining

impl LlvmPass:
    fn to_text() -> text:
        match self:
            case DominatorTree: "domtree"
            case LoopInfo: "loop-info"
            case ScalarEvolution: "scev"
            case AliasAnalysis: "alias-analysis"
            case InstCombine: "instcombine"
            case SimplifyCFG: "simplifycfg"
            case Reassociate: "reassociate"
            case GVN: "gvn"
            case LICM: "licm"
            case IndVarSimplify: "indvars"
            case LoopUnroll: "loop-unroll"
            case LoopVectorize: "loop-vectorize"
            case SLPVectorize: "slp-vectorize"
            case DeadCodeElimination: "dce"
            case Inlining: "inline"

fn passes_for_level(level: OptimizationLevel) -> [LlvmPass]:
    """Get LLVM passes for optimization level."""
    match level:
        case nil:
            []
        case Debug:
            [
                LlvmPass.InstCombine,
                LlvmPass.SimplifyCFG
            ]
        case Size:
            [
                LlvmPass.InstCombine,
                LlvmPass.SimplifyCFG,
                LlvmPass.DeadCodeElimination,
                LlvmPass.GVN
            ]
        case Speed:
            [
                LlvmPass.InstCombine,
                LlvmPass.SimplifyCFG,
                LlvmPass.Reassociate,
                LlvmPass.GVN,
                LlvmPass.LICM,
                LlvmPass.DeadCodeElimination,
                LlvmPass.Inlining
            ]
        case Aggressive:
            [
                LlvmPass.InstCombine,
                LlvmPass.SimplifyCFG,
                LlvmPass.Reassociate,
                LlvmPass.GVN,
                LlvmPass.LICM,
                LlvmPass.IndVarSimplify,
                LlvmPass.LoopUnroll,
                LlvmPass.LoopVectorize,
                LlvmPass.SLPVectorize,
                LlvmPass.DeadCodeElimination,
                LlvmPass.Inlining
            ]

export LlvmPass, passes_for_level
