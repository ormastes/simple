# Extended SMF writer with template section support (v1.1)
#
# This module extends the basic SMF builder to include:
# - TemplateCode sections (serialized generic definitions)
# - TemplateMeta sections (monomorphization metadata)
# - ⭐ Trailer-based header design (like ZIP format)
# - Compression support (default: 0 = no compression)
# - Executable SMF support (stub fields)
#
# v1.1 Design: Header written at EOF-128 (trailer), not at offset 0.
# This enables directly executable SMF files (prepend shebang/stub).
#
# Enables .smf files to store both native code AND templates for deferred instantiation.

use compiler.mono.monomorphize.partition (GenericTemplates)
use compiler.mono.monomorphize.metadata (MonomorphizationMetadata)
use compiler.mono.monomorphize.note_sdn (NoteSdnMetadata)
use compiler.frontend.ast (FunctionDef, StructDef, ClassDef, EnumDef, TraitDef)
use compiler.backend.linker.smf_header (SmfHeader, SMF_FLAG_EXECUTABLE)
use compiler.backend.linker.smf_enums (Platform, Arch)
use std.platform.{get_host_os, get_host_arch}

# Target platform information
struct Target:
    os: text        # "linux", "windows", "macos"
    arch: text      # "x86_64", "aarch64", "riscv64"

impl Target:
    static fn host() -> Target:
        # Platform detection using std.platform (Phase 2.1 - TODO #162 ✅)
        Target(os: get_host_os(), arch: get_host_arch())

    static fn x86_64_unknown_linux_gnu() -> Target:
        Target(os: "linux", arch: "x86_64")

    static fn aarch64_unknown_linux_gnu() -> Target:
        Target(os: "linux", arch: "aarch64")

# SMF build options - groups common parameters
struct SmfBuildOptions:
    templates: GenericTemplates?
    metadata: MonomorphizationMetadata?
    note_sdn: NoteSdnMetadata?
    target: Target

impl SmfBuildOptions:
    static fn create(target: Target) -> SmfBuildOptions:
        SmfBuildOptions(
            templates: nil,
            metadata: nil,
            note_sdn: nil,
            target: target
        )

    fn has_any_sections() -> bool:
        self.templates.? or self.metadata.? or self.note_sdn.?

export Target
