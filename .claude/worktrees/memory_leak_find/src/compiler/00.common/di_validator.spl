# DI Constructor Injection Validator
#
# Validates dependency injection rules for constructors:
# - All-or-nothing rule: All params injectable or none
# - No mixing @sys.inject with @inject annotations
#
# Return type: DiValidation struct with ok/error_kind/message
# Error kinds: "MixedInjection" | "MixedAnnotations" | ""

# ============================================================================
# Constructor Parameter Info
# ============================================================================

struct ParamInfo:
    name: text
    type_name: text
    has_inject: bool

impl ParamInfo:
    static fn create(name: text, type_name: text, has_inject: bool) -> ParamInfo:
        ParamInfo(name: name, type_name: type_name, has_inject: has_inject)

struct ConstructorInfo:
    class_name: text
    has_sys_inject: bool
    params: [ParamInfo]

impl ConstructorInfo:
    static fn create(class_name: text, has_sys_inject: bool,
                    params: [ParamInfo]) -> ConstructorInfo:
        ConstructorInfo(class_name: class_name,
                       has_sys_inject: has_sys_inject,
                       params: params)

# ============================================================================
# Validation Result
# ============================================================================

struct DiValidation:
    ok: bool
    error_kind: text    # "" if ok, "MixedInjection" or "MixedAnnotations" if not
    message: text

fn di_ok() -> DiValidation:
    DiValidation(ok: true, error_kind: "", message: "")

fn di_err(kind: text, msg: text) -> DiValidation:
    DiValidation(ok: false, error_kind: kind, message: msg)

# ============================================================================
# Validation logic
# ============================================================================

fn validate_constructor(ctor: ConstructorInfo) -> DiValidation:
    # Rule 3/5: class has @sys.inject
    if ctor.has_sys_inject:
        # Check no @inject on any param (Rule 5: MixedAnnotations)
        var has_param_inject = false
        for param in ctor.params:
            if param.has_inject:
                has_param_inject = true
        if has_param_inject:
            return di_err(
                "MixedAnnotations",
                "Class '{ctor.class_name}' has @sys.inject but some params also have @inject"
            )
        return di_ok()

    # Count inject params
    var inject_count = 0
    for param in ctor.params:
        if param.has_inject:
            inject_count = inject_count + 1

    val total = ctor.params.len()

    # Rule 2: no params injected → plain constructor, OK
    if inject_count == 0:
        return di_ok()

    # Rule 1: all params injected → OK
    if inject_count == total:
        return di_ok()

    # Rule 4: mixed → MixedInjection error
    di_err(
        "MixedInjection",
        "Class '{ctor.class_name}': {inject_count} of {total} params have @inject (all or none required)"
    )

# ============================================================================
# Error code helpers
# ============================================================================

fn di_error_code(kind: text) -> text:
    if kind == "MixedInjection":
        return "E:DI001"
    if kind == "MixedAnnotations":
        return "E:DI002"
    "E:DI000"

export ParamInfo, ConstructorInfo, DiValidation
export validate_constructor, di_ok, di_err, di_error_code
