# CUDA Runtime FFI Declarations
#
# SFFI wrappers for CUDA runtime API.
# extern fn rt_cuda_* (runtime bindings)
# fn cuda_* (Simple API wrappers)

# ============================================================================
# Tier 1: Runtime Bindings (Raw FFI)
# ============================================================================

# --- Device Management ---

extern fn rt_cuda_init() -> i64
extern fn rt_cuda_device_get(device_id: i64) -> i64
extern fn rt_cuda_device_count() -> i64
extern fn rt_cuda_device_name(device: i64) -> text
extern fn rt_cuda_device_compute_capability(device: i64) -> i64

# --- Context Management ---

extern fn rt_cuda_ctx_create(device: i64) -> i64
extern fn rt_cuda_ctx_destroy(ctx: i64) -> i64
extern fn rt_cuda_ctx_synchronize() -> i64

# --- Memory Management ---

extern fn rt_cuda_mem_alloc(size: i64) -> i64
extern fn rt_cuda_mem_free(ptr: i64) -> i64
extern fn rt_cuda_memcpy_htod(dst: i64, src: i64, size: i64) -> i64
extern fn rt_cuda_memcpy_dtoh(dst: i64, src: i64, size: i64) -> i64
extern fn rt_cuda_memcpy_dtod(dst: i64, src: i64, size: i64) -> i64
extern fn rt_cuda_memset(ptr: i64, value: i64, size: i64) -> i64

# --- Module and Kernel Management ---

extern fn rt_cuda_module_load(path: text) -> i64
extern fn rt_cuda_module_load_data(ptx: text) -> i64
extern fn rt_cuda_module_unload(module: i64) -> i64
extern fn rt_cuda_module_get_function(module: i64, func_name: text) -> i64

# --- Kernel Launch ---

extern fn rt_cuda_launch_kernel(module: i64, func_name: text, grid_x: i64, grid_y: i64, grid_z: i64, block_x: i64, block_y: i64, block_z: i64, args_ptr: i64) -> i64
extern fn rt_cuda_sync() -> i64

# --- Error Handling ---

extern fn rt_cuda_get_error_string(error_code: i64) -> text

# ============================================================================
# Tier 2: Simple API Wrappers
# ============================================================================

# --- Device Management ---

fn cuda_init() -> i64:
    """Initialize CUDA runtime. Returns 0 on success."""
    rt_cuda_init()

fn cuda_device_get(device_id: i64) -> i64:
    """Get device handle by ID. Returns device handle or negative error."""
    rt_cuda_device_get(device_id)

fn cuda_device_count() -> i64:
    """Get number of available CUDA devices."""
    rt_cuda_device_count()

fn cuda_device_name(device: i64) -> text:
    """Get device name string."""
    rt_cuda_device_name(device)

fn cuda_device_compute_capability(device: i64) -> i64:
    """Get compute capability as major*10+minor (e.g. 86 for SM 8.6)."""
    rt_cuda_device_compute_capability(device)

# --- Context Management ---

fn cuda_ctx_create(device: i64) -> i64:
    """Create CUDA context for device. Returns context handle or negative error."""
    rt_cuda_ctx_create(device)

fn cuda_ctx_destroy(ctx: i64) -> i64:
    """Destroy CUDA context. Returns 0 on success."""
    rt_cuda_ctx_destroy(ctx)

fn cuda_ctx_synchronize() -> i64:
    """Synchronize current CUDA context. Returns 0 on success."""
    rt_cuda_ctx_synchronize()

# --- Memory Management ---

fn cuda_mem_alloc(size: i64) -> i64:
    """Allocate device memory. Returns device pointer or negative error."""
    rt_cuda_mem_alloc(size)

fn cuda_mem_free(ptr: i64) -> i64:
    """Free device memory. Returns 0 on success."""
    rt_cuda_mem_free(ptr)

fn cuda_memcpy_htod(dst: i64, src: i64, size: i64) -> i64:
    """Copy host memory to device. Returns 0 on success."""
    rt_cuda_memcpy_htod(dst, src, size)

fn cuda_memcpy_dtoh(dst: i64, src: i64, size: i64) -> i64:
    """Copy device memory to host. Returns 0 on success."""
    rt_cuda_memcpy_dtoh(dst, src, size)

fn cuda_memcpy_dtod(dst: i64, src: i64, size: i64) -> i64:
    """Copy device memory to device. Returns 0 on success."""
    rt_cuda_memcpy_dtod(dst, src, size)

fn cuda_memset(ptr: i64, value: i64, size: i64) -> i64:
    """Set device memory to value. Returns 0 on success."""
    rt_cuda_memset(ptr, value, size)

# --- Module and Kernel Management ---

fn cuda_module_load(path: text) -> i64:
    """Load CUDA module from file. Returns module handle or negative error."""
    rt_cuda_module_load(path)

fn cuda_module_load_data(ptx: text) -> i64:
    """Load CUDA module from PTX string. Returns module handle or negative error."""
    rt_cuda_module_load_data(ptx)

fn cuda_module_unload(module: i64) -> i64:
    """Unload CUDA module. Returns 0 on success."""
    rt_cuda_module_unload(module)

fn cuda_module_get_function(module: i64, func_name: text) -> i64:
    """Get kernel function from module. Returns function handle or negative error."""
    rt_cuda_module_get_function(module, func_name)

# --- Kernel Launch ---

fn cuda_launch_kernel(module: i64, func_name: text, grid_x: i64, grid_y: i64, grid_z: i64, block_x: i64, block_y: i64, block_z: i64, args_ptr: i64) -> i64:
    """Launch CUDA kernel. Returns 0 on success."""
    rt_cuda_launch_kernel(module, func_name, grid_x, grid_y, grid_z, block_x, block_y, block_z, args_ptr)

fn cuda_sync() -> i64:
    """Synchronize device (wait for all kernels). Returns 0 on success."""
    rt_cuda_sync()

# --- Error Handling ---

fn cuda_get_error_string(error_code: i64) -> text:
    """Get human-readable error description for a CUDA error code."""
    rt_cuda_get_error_string(error_code)

# --- Helper Constants ---

val CUDA_SUCCESS = 0
val CUDA_ERROR_INVALID_VALUE = -1
val CUDA_ERROR_OUT_OF_MEMORY = -2
val CUDA_ERROR_NOT_INITIALIZED = -3
val CUDA_ERROR_NO_DEVICE = -100

# ============================================================================
# Export
# ============================================================================

export cuda_init, cuda_device_get, cuda_device_count
export cuda_device_name, cuda_device_compute_capability
export cuda_ctx_create, cuda_ctx_destroy, cuda_ctx_synchronize
export cuda_mem_alloc, cuda_mem_free
export cuda_memcpy_htod, cuda_memcpy_dtoh, cuda_memcpy_dtod, cuda_memset
export cuda_module_load, cuda_module_load_data, cuda_module_unload
export cuda_module_get_function
export cuda_launch_kernel, cuda_sync
export cuda_get_error_string
export CUDA_SUCCESS, CUDA_ERROR_INVALID_VALUE, CUDA_ERROR_OUT_OF_MEMORY
export CUDA_ERROR_NOT_INITIALIZED, CUDA_ERROR_NO_DEVICE
