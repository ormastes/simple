# Native Codegen Adapter
#
# Wraps the native ISel/RegAlloc/Encode pipeline to implement the Codegen trait.
# Delegates to compile_native() in native/mod.spl.

use compiler.mir.mir_data.{MirModule}
use compiler.core.backend_types.{BackendKind, CodegenTarget, CompileOptions, CompileError}
use compiler.backend.codegen_types.{Codegen, CodegenOutput, CodegenOutputKind}
use compiler.backend.native.mod.{native_compile_result}

# ============================================================================
# Native Codegen Adapter
# ============================================================================

class NativeCodegenAdapter:
    """Adapts native machine code pipeline to the Codegen trait interface."""
    options: CompileOptions

impl Codegen for NativeCodegenAdapter:
    fn backend_kind() -> BackendKind: BackendKind.Native
    fn backend_name() -> text: "native"

    fn supports_target(target: CodegenTarget) -> bool:
        match target:
            case X86_64 | AArch64 | Riscv64: true
            case AArch64_MacOS | X86_64_MacOS: true
            case Host: true
            case _: false

    fn output_kind() -> CodegenOutputKind: CodegenOutputKind.ObjectCode

    fn compile_module(module: MirModule) -> Result<CodegenOutput, CompileError>:
        val compiled = native_compile_result(module, self.options.target)
        val bytes = if compiled.object_code.?: compiled.object_code.unwrap() else: []
        Ok(CodegenOutput.object(module.name, bytes))

# ============================================================================
# Exports
# ============================================================================

export NativeCodegenAdapter
