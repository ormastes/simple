# LLVM Tool Invocations
#
# Shared LLVM tool discovery and invocation functions.
# Used by both Full Simple and Core Simple LLVM backends.
#
# Bootstrap-compatible: No generics, no Option types, seed_cpp compilable.

# Interpreter-mode fix: use extern fns + io_runtime
extern fn rt_process_run(cmd: text, args: [text]) -> (text, text, i64)
extern fn rt_file_write_text(path: text, content: text) -> bool
extern fn rt_file_delete(path: text) -> bool
extern fn rt_file_read_bytes(path: text) -> [u8]
extern fn rt_getpid() -> i64

fn shell(command: text) -> i64:
    val (stdout, stderr, code) = rt_process_run("/bin/sh", ["-c", command])
    code

fn file_write(path: text, content: text) -> bool:
    rt_file_write_text(path, content)

fn file_delete(path: text) -> bool:
    rt_file_delete(path)

fn file_read_bytes(path: text) -> [u8]:
    rt_file_read_bytes(path)

fn getpid() -> i64:
    rt_getpid()

# ============================================================================
# LLVM Tool Discovery
# ============================================================================

fn find_llc() -> text:
    """
    Find llc binary with fallback chain: llc-18 → llc-17 → llc-16 → llc.

    Returns the command name if found, otherwise empty string.
    Bootstrap-safe: Returns text (not text?) with "" for not found.
    """
    val candidates = ["llc-18", "llc-17", "llc-16", "llc"]
    for candidate in candidates:
        val result = shell("command -v {candidate} >/dev/null 2>&1")
        if result.exit_code == 0:
            return candidate
    ""

fn find_opt() -> text:
    """
    Find LLVM opt binary with fallback chain: opt-18 → opt-17 → opt-16 → opt.

    Returns the command name if found, otherwise empty string.
    Bootstrap-safe: Returns text (not text?) with "" for not found.
    """
    val candidates = ["opt-18", "opt-17", "opt-16", "opt"]
    for candidate in candidates:
        val result = shell("command -v {candidate} >/dev/null 2>&1")
        if result.exit_code == 0:
            return candidate
    ""

fn find_clang() -> text:
    """
    Find clang binary with fallback chain: clang-18 → clang-17 → clang-16 → clang.

    Returns the command name if found, otherwise empty string.
    Bootstrap-safe: Returns text (not text?) with "" for not found.
    """
    val candidates = ["clang-18", "clang-17", "clang-16", "clang"]
    for candidate in candidates:
        val result = shell("command -v {candidate} >/dev/null 2>&1")
        if result.exit_code == 0:
            return candidate
    ""

# ============================================================================
# WASM Tool Discovery
# ============================================================================

fn find_wasm_ld() -> text:
    """
    Find wasm-ld binary with fallback chain: wasm-ld-18 -> wasm-ld-17 -> wasm-ld-16 -> wasm-ld.

    Returns the command name if found, otherwise empty string.
    """
    val candidates = ["wasm-ld-18", "wasm-ld-17", "wasm-ld-16", "wasm-ld"]
    for candidate in candidates:
        val result = shell("command -v {candidate} >/dev/null 2>&1")
        if result.exit_code == 0:
            return candidate
    ""

fn find_wasm_opt() -> text:
    """
    Find wasm-opt binary (from Binaryen).

    Returns the command name if found, otherwise empty string.
    """
    val result = shell("command -v wasm-opt >/dev/null 2>&1")
    if result.exit_code == 0:
        "wasm-opt"
    else:
        ""

fn find_wat2wasm() -> text:
    """
    Find wat2wasm binary (from WABT).

    Returns the command name if found, otherwise empty string.
    """
    val result = shell("command -v wat2wasm >/dev/null 2>&1")
    if result.exit_code == 0:
        "wat2wasm"
    else:
        ""

fn find_wasi_sysroot() -> text:
    """
    Find WASI sysroot directory.

    Checks WASI_SYSROOT env var, then probes common locations.
    Returns the path if found, otherwise empty string.
    """
    # Check env var first
    val env_result = shell("echo $WASI_SYSROOT")
    if env_result.exit_code == 0:
        val env_path = env_result.stdout.trim()
        if env_path != "":
            val check = shell("test -d '{env_path}' && echo ok")
            if check.exit_code == 0:
                return env_path

    # Probe common locations
    val probe_paths = [
        "/opt/wasi-sdk/share/wasi-sysroot",
        "/usr/share/wasi-sysroot",
        "/usr/local/share/wasi-sysroot",
        "/opt/wasi-sysroot"
    ]
    for probe in probe_paths:
        val check = shell("test -d '{probe}' && echo ok")
        if check.exit_code == 0:
            return probe
    ""

# ============================================================================
# WASM Tool Availability Checks
# ============================================================================

fn wasm_ld_available() -> bool:
    """Check if wasm-ld is available on PATH."""
    val tool = find_wasm_ld()
    tool != ""

fn wasm_opt_available() -> bool:
    """Check if wasm-opt (Binaryen optimizer) is available on PATH."""
    val tool = find_wasm_opt()
    tool != ""

fn wat2wasm_available() -> bool:
    """Check if wat2wasm (WABT) is available on PATH."""
    val tool = find_wat2wasm()
    tool != ""

# ============================================================================
# Tool Availability Checks
# ============================================================================

fn opt_available() -> bool:
    """Check if opt (LLVM optimizer) is available on PATH."""
    val tool = find_opt()
    tool != ""

fn llc_available() -> bool:
    """Check if llc (LLVM static compiler) is available on PATH."""
    val tool = find_llc()
    tool != ""

fn clang_available() -> bool:
    """Check if clang (C compiler with LLVM backend) is available on PATH."""
    val tool = find_clang()
    tool != ""

# ============================================================================
# Exports
# ============================================================================

export find_llc, find_opt, find_clang
export llc_available, opt_available, clang_available
export find_wasm_ld, find_wasm_opt, find_wat2wasm, find_wasi_sysroot
export wasm_ld_available, wasm_opt_available, wat2wasm_available
