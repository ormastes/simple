fn mqtt_create_connack_packet(session_present, return_code):
    """Create a CONNACK packet."""
    val headers = (session_present, return_code, nil)
    mqtt_create_packet(PACKET_TYPE_CONNACK, 0, headers, nil)

fn mqtt_connack_get_return_code(packet):
    """Get return code from CONNACK packet."""
    val headers = mqtt_packet_headers(packet)
    val parts = headers
    parts[1]

fn mqtt_connack_has_session_present(packet):
    """Check if session present flag is set in CONNACK packet."""
    val headers = mqtt_packet_headers(packet)
    val parts = headers
    parts[0]

fn mqtt_connack_is_accepted(packet):
    """Check if connection was accepted."""
    val code = mqtt_connack_get_return_code(packet)
    code == CONNACK_ACCEPTED

# ============================================================================
# PUBLISH Packet Functions
# ============================================================================

fn mqtt_create_publish_packet(topic, payload, qos, retain):
    """Create a PUBLISH packet."""
    var flags = 0
    flags = mqtt_set_qos_in_flags(flags, qos)
    flags = mqtt_set_retain_flag(flags, retain)

    val headers = (topic, nil, nil)
    mqtt_create_packet(PACKET_TYPE_PUBLISH, flags, headers, payload)

fn mqtt_publish_set_packet_id(packet, packet_id):
    """Set packet ID in PUBLISH packet (for QoS > 0)."""
    val headers = mqtt_packet_headers(packet)
    val parts = headers
    val topic = parts[0]
    val properties = parts[2]

    val new_headers = (topic, packet_id, properties)
    mqtt_set_packet_headers(packet, new_headers)

fn mqtt_publish_get_topic(packet):
    """Get topic from PUBLISH packet."""
    val headers = mqtt_packet_headers(packet)
    val parts = headers
    parts[0]

fn mqtt_publish_get_packet_id(packet):
    """Get packet ID from PUBLISH packet."""
    val headers = mqtt_packet_headers(packet)
    val parts = headers
    parts[1]

fn mqtt_publish_get_qos(packet):
    """Get QoS from PUBLISH packet."""
    val flags = mqtt_packet_flags(packet)
    mqtt_get_qos_from_flags(flags)

fn mqtt_publish_is_retained(packet):
    """Check if PUBLISH packet has retain flag set."""
    val flags = mqtt_packet_flags(packet)
    mqtt_has_retain_flag(flags)

fn mqtt_publish_is_duplicate(packet):
    """Check if PUBLISH packet has DUP flag set."""
    val flags = mqtt_packet_flags(packet)
    mqtt_has_dup_flag(flags)

fn mqtt_publish_set_duplicate(packet, dup):
    """Set DUP flag in PUBLISH packet."""
    val old_flags = mqtt_packet_flags(packet)
    val new_flags = mqtt_set_dup_flag(old_flags, dup)
    mqtt_set_packet_flags(packet, new_flags)

# ============================================================================
# PUBACK/PUBREC/PUBREL/PUBCOMP Packet Functions
