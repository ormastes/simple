# Environment Variable Validation
#
# Functions for validating variable names, values, and checking requirements.

import std.env.variables

# ============================================================================
# Variable Validation
# ============================================================================

fn validate_var_name(name: text) -> bool:
    """Validate environment variable name.

    Valid names: alphanumeric and underscore, starting with letter or underscore.

    Example:
        validate_var_name("MY_VAR")  # true
        validate_var_name("123VAR")  # false
    """
    if name.len() == 0:
        return false

    # First character must be letter or underscore
    val first = name[0]
    val is_valid_first = (first >= 'a' and first <= 'z') or (first >= 'A' and first <= 'Z') or first == '_'
    if not is_valid_first:
        return false

    # Rest must be alphanumeric or underscore
    var i = 1
    while i < name.len():
        val ch = name[i]
        val is_alpha = (ch >= 'a' and ch <= 'z') or (ch >= 'A' and ch <= 'Z')
        val is_digit = (ch >= '0' and ch <= '9')
        val is_valid = is_alpha or is_digit or ch == '_'
        if not is_valid:
            return false
        i = i + 1

    true

fn check_required_vars(required: [text]) -> [(text, bool)]:
    """Check which required variables are set.

    Returns list of (name, is_set) tuples.

    Example:
        check_required_vars(["HOME", "MISSING"])  # [("HOME", true), ("MISSING", false)]
    """
    var results = []

    for var_name in required:
        val is_set = variables.env_has(var_name)
        results.push((var_name, is_set))

    results

fn ensure_required_vars(required: [text]) -> bool:
    """Ensure all required variables are set. Returns true if all set.

    Example:
        ensure_required_vars(["HOME", "USER"])  # true if both set
    """
    for var_name in required:
        if not variables.env_has(var_name):
            return false

    true

fn validate_var_value(name: text, value: text, pattern: text) -> bool:
    """Validate variable value against pattern (simple contains check).

    Example:
        validate_var_value("PATH", "/usr/bin", "/usr")  # true
    """
    value.contains(pattern)

fn normalize_var_name(name: text) -> text:
    """Normalize variable name to uppercase with underscores.

    Example:
        normalize_var_name("my-var")  # "MY_VAR"
    """
    var result = name.upper()
    result = result.replace("-", "_")
    result = result.replace(".", "_")
    result

fn split_var_name(name: text) -> [text]:
    """Split variable name by underscores.

    Example:
        split_var_name("MY_VAR_NAME")  # ["MY", "VAR", "NAME"]
    """
    name.split("_")

fn is_system_var(name: text) -> bool:
    """Check if variable is a system variable (common system vars).

    Example:
        is_system_var("PATH")  # true
        is_system_var("MY_VAR")  # false
    """
    val system_vars = [
        "PATH", "HOME", "USER", "SHELL", "TERM", "PWD", "OLDPWD",
        "LANG", "LC_ALL", "TMPDIR", "TMP", "TEMP", "EDITOR",
        "DISPLAY", "XDG_CONFIG_HOME", "XDG_DATA_HOME", "XDG_CACHE_HOME"
    ]

    for sys_var in system_vars:
        if sys_var == name:
            return true

    false

fn is_private_var(name: text) -> bool:
    """Check if variable is private (starts with underscore).

    Example:
        is_private_var("_MY_VAR")  # true
        is_private_var("MY_VAR")  # false
    """
    name.starts_with("_")

fn is_readonly_var(name: text) -> bool:
    """Check if variable is typically readonly (common readonly vars).

    Example:
        is_readonly_var("HOME")  # true (common readonly)
    """
    val readonly_vars = ["HOME", "USER", "LOGNAME", "SHELL", "UID"]

    for ro_var in readonly_vars:
        if ro_var == name:
            return true

    false

export validate_var_name, check_required_vars, ensure_required_vars, validate_var_value
export normalize_var_name, split_var_name
export is_system_var, is_private_var, is_readonly_var
