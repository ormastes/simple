# Environment Variable Operations
#
# Core operations for getting, setting, and managing environment variables.

import std.env.types

# ============================================================================
# Core Environment Variable Operations
# ============================================================================

fn env_get(key: text) -> text:
    """Get environment variable value. Returns empty string if not set.

    Example:
        env_get("HOME")  # "/home/user"
        env_get("NONEXISTENT")  # ""
    """
    val value = types.rt_env_get(key)
    if value == nil:
        ""
    else:
        value

fn env_get_or(key: text, default: text) -> text:
    """Get environment variable or return default if not set.

    Example:
        env_get_or("EDITOR", "vim")  # "vim" if EDITOR not set
    """
    val value = env_get(key)
    if value == "":
        default
    else:
        value

fn env_set(key: text, value: text) -> bool:
    """Set environment variable.

    Example:
        env_set("MY_VAR", "hello")  # true
    """
    types.rt_env_set(key, value)

fn env_unset(key: text) -> bool:
    """Remove environment variable.

    Example:
        env_unset("MY_VAR")  # true
    """
    types.rt_env_remove(key)

fn env_has(key: text) -> bool:
    """Check if environment variable exists.

    Example:
        env_has("HOME")  # true
        env_has("NONEXISTENT")  # false
    """
    val value = types.rt_env_get(key)
    if value == nil:
        false
    else:
        value != ""

fn env_list() -> [(text, text)]:
    """Get all environment variables as list of (name, value) tuples.

    Example:
        env_list()  # [("HOME", "/home/user"), ("PATH", "/usr/bin"), ...]
    """
    types.rt_env_vars()

fn env_clear():
    """Clear all environment variables (dangerous, use with caution)."""
    val vars = env_list()
    for pair in vars:
        val (name, value) = pair
        env_unset(name)

fn env_keys() -> [text]:
    """Get list of all environment variable names.

    Example:
        env_keys()  # ["HOME", "PATH", "USER", ...]
    """
    val vars = env_list()
    var keys = []
    for pair in vars:
        val (name, value) = pair
        keys.push(name)
    keys

fn env_values() -> [text]:
    """Get list of all environment variable values.

    Example:
        env_values()  # ["/home/user", "/usr/bin", "alice", ...]
    """
    val vars = env_list()
    var values = []
    for pair in vars:
        val (name, value) = pair
        values.push(value)
    values

fn env_size() -> i64:
    """Get number of environment variables.

    Example:
        env_size()  # 42
    """
    val vars = env_list()
    vars.len()

fn env_snapshot() -> [(text, text)]:
    """Take snapshot of current environment.

    Example:
        env_snapshot()  # captures current state
    """
    env_list()

fn env_restore(snapshot: [(text, text)]):
    """Restore environment from snapshot.

    Example:
        env_restore(snapshot)  # restores previous state
    """
    # Clear current environment
    env_clear()

    # Restore snapshot
    for pair in snapshot:
        val (name, value) = pair
        env_set(name, value)

fn env_diff(before: [(text, text)], after: [(text, text)]) -> [(text, text, text)]:
    """Compare two environment snapshots.

    Returns list of (name, before_value, after_value) tuples for changes.

    Example:
        env_diff(snap1, snap2)  # [("FOO", "old", "new")]
    """
    var changes = []

    # Check for modified and new vars
    for after_pair in after:
        val (name, after_val) = after_pair
        var found = false
        var before_val = ""

        for before_pair in before:
            val (before_name, before_value) = before_pair
            if before_name == name:
                found = true
                before_val = before_value
                break

        if not found:
            # New variable
            changes.push((name, "", after_val))
        elif before_val != after_val:
            # Modified variable
            changes.push((name, before_val, after_val))

    # Check for deleted vars
    for before_pair in before:
        val (name, before_val) = before_pair
        var found = false

        for after_pair in after:
            val (after_name, after_val) = after_pair
            if after_name == name:
                found = true
                break

        if not found:
            # Deleted variable
            changes.push((name, before_val, ""))

    changes

fn env_has_prefix(prefix: text) -> bool:
    """Check if any environment variable starts with prefix.

    Example:
        env_has_prefix("XDG_")  # true if any XDG_ vars exist
    """
    val vars = env_list()

    for pair in vars:
        val (name, value) = pair
        if name.starts_with(prefix):
            return true

    false

fn env_count_prefix(prefix: text) -> i64:
    """Count environment variables with prefix.

    Example:
        env_count_prefix("XDG_")  # 3
    """
    val vars = env_list()
    var count = 0

    for pair in vars:
        val (name, value) = pair
        if name.starts_with(prefix):
            count = count + 1

    count

fn env_find(pattern: text) -> [(text, text)]:
    """Find environment variables matching pattern (simple contains).

    Example:
        env_find("HOME")  # [("HOME", "/home/user"), ("XDG_CONFIG_HOME", "...")]
    """
    val vars = env_list()
    var results = []

    for pair in vars:
        val (name, value) = pair
        if name.contains(pattern):
            results.push((name, value))

    results

fn env_sort_by_name(vars: [(text, text)]) -> [(text, text)]:
    """Sort environment variables by name.

    Example:
        env_sort_by_name(vars)  # sorted alphabetically
    """
    # Simple bubble sort (good enough for environment variables)
    var result = vars
    var n = result.len()
    var i = 0

    while i < n:
        var j = 0
        while j < n - i - 1:
            val (name1, val1) = result[j]
            val (name2, val2) = result[j + 1]

            if name1 > name2:
                # Swap
                val temp = result[j]
                result[j] = result[j + 1]
                result[j + 1] = temp

            j = j + 1
        i = i + 1

    result

fn merge_env(base: [(text, text)], overrides: [(text, text)]) -> [(text, text)]:
    """Merge two environment variable lists, with overrides taking precedence.

    Example:
        merge_env([("A", "1")], [("B", "2"), ("A", "3")])  # [("A", "3"), ("B", "2")]
    """
    var result = []
    var override_keys = []

    # Collect override keys
    for pair in overrides:
        val (name, value) = pair
        override_keys.push(name)
        result.push((name, value))

    # Add base vars not in overrides
    for pair in base:
        val (name, value) = pair
        var found = false
        for key in override_keys:
            if key == name:
                found = true
                break
        if not found:
            result.push((name, value))

    result

fn filter_env(vars: [(text, text)], prefix: text) -> [(text, text)]:
    """Filter environment variables by prefix.

    Example:
        filter_env([("PATH", "/usr/bin"), ("PWD", "/home")], "P")  # [("PATH", "..."), ("PWD", "...")]
    """
    var result = []

    for pair in vars:
        val (name, value) = pair
        if name.starts_with(prefix):
            result.push((name, value))

    result

fn exclude_env(vars: [(text, text)], keys: [text]) -> [(text, text)]:
    """Exclude specific environment variables.

    Example:
        exclude_env([("A", "1"), ("B", "2")], ["A"])  # [("B", "2")]
    """
    var result = []

    for pair in vars:
        val (name, value) = pair
        var excluded = false
        for key in keys:
            if key == name:
                excluded = true
                break
        if not excluded:
            result.push((name, value))

    result

fn include_env(vars: [(text, text)], keys: [text]) -> [(text, text)]:
    """Include only specific environment variables.

    Example:
        include_env([("A", "1"), ("B", "2")], ["A"])  # [("A", "1")]
    """
    var result = []

    for pair in vars:
        val (name, value) = pair
        for key in keys:
            if key == name:
                result.push((name, value))
                break

    result

fn expand_var(text: text) -> text:
    """Expand environment variables in text.

    Supports:
    - ${VAR} - expand variable
    - ${VAR:-default} - use default if not set
    - ${VAR:=default} - set and use default if not set

    Example:
        expand_var("Hello ${USER}")  # "Hello alice"
        expand_var("${MISSING:-default}")  # "default"
    """
    var result = text
    var pos = 0

    while pos < result.len():
        val dollar_pos = result.substring(pos).find("$")
        if not dollar_pos.?:
            break

        val start = pos + dollar_pos.unwrap()
        if start + 1 >= result.len():
            break

        if result[start + 1] == "{":
            # Find closing brace
            val close_pos = result.substring(start + 2).find("}")
            if close_pos.?:
                val close_idx = start + 2 + close_pos.unwrap()
                val var_expr = result.substring(start + 2, close_idx)
                val expanded = expand_var_expr(var_expr)

                # Replace ${...} with expanded value
                val before = result.substring(0, start)
                val after = result.substring(close_idx + 1)
                result = before + expanded + after
                pos = start + expanded.len()
            else:
                pos = start + 2
        else:
            pos = start + 1

    result

fn expand_var_expr(expr: text) -> text:
    """Expand variable expression like VAR, VAR:-default, VAR:=default.

    Internal helper for expand_var.
    """
    # Check for :- (use default)
    val default_pos = expr.find(":-")
    if default_pos.?:
        val sep_idx = default_pos.unwrap()
        val var_name = expr.substring(0, sep_idx)
        val default_val = expr.substring(sep_idx + 2)
        return env_get_or(var_name, default_val)

    # Check for := (set default)
    val set_pos = expr.find(":=")
    if set_pos.?:
        val sep_idx = set_pos.unwrap()
        val var_name = expr.substring(0, sep_idx)
        val default_val = expr.substring(sep_idx + 2)

        if not env_has(var_name):
            env_set(var_name, default_val)
            return default_val
        else:
            return env_get(var_name)

    # Simple variable
    env_get(expr)

fn substitute_vars(text: text, vars: [(text, text)]) -> text:
    """Substitute variables in text from given list.

    Example:
        substitute_vars("Hello ${name}!", [("name", "World")])  # "Hello World!"
    """
    var result = text

    for pair in vars:
        val (name, value) = pair
        val placeholder = "$" + "{" + name + "}"
        result = result.replace(placeholder, value)

    result

export env_get, env_get_or, env_set, env_unset, env_has
export env_list, env_clear, env_keys, env_values, env_size
export env_snapshot, env_restore, env_diff
export env_has_prefix, env_count_prefix, env_find, env_sort_by_name
export merge_env, filter_env, exclude_env, include_env
export expand_var, expand_var_expr, substitute_vars
