# ============================================================================
# Mock Spy - Spy utilities for partial mocking
# ============================================================================
#
# Spy creation, partial mocking, and real method delegation.
#
# ============================================================================

# Re-import required types from builder
import testing.mock.builder: CallRecord

# ============================================================================
# Spy System
# ============================================================================

class Spy:
    name: text
    calls: [CallRecord]
    call_count_value: i32

    static fn new(name: text) -> Spy:
        Spy(
            name: name,
            calls: [],
            call_count_value: 0
        )

    me record_call(method: text, args: [text]):
        val full_args = [method].merge(args)
        val record = CallRecord(
            args: full_args,
            timestamp: 0,
            call_number: self.calls.len() as i32
        )
        self.calls.append(record)
        self.call_count_value = self.call_count_value + 1

    fn get_calls(method: text) -> [CallRecord]:
        var result = []
        for call in self.calls:
            if call.args.len() > 0 and call.args[0] == method:
                result.append(call)
        result

    fn method_called(method: text) -> bool:
        for call in self.calls:
            if call.args.len() > 0 and call.args[0] == method:
                return true
        false

    fn method_call_count(method: text) -> i32:
        var count = 0
        for call in self.calls:
            if call.args.len() > 0 and call.args[0] == method:
                count = count + 1
        count

    fn total_calls() -> i32:
        self.call_count_value

    fn summary() -> text:
        var parts = ["Spy '{self.name}': {self.total_calls()} call(s)"]
        for call in self.calls:
            parts.push("  {call.args}")
        parts.join("\n") + "\n"

# ============================================================================
# Exports
# ============================================================================

export Spy
