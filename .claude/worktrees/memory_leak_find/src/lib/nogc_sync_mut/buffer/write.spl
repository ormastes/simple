# Buffer Write Operations

# Write a single byte
fn buffer_write_byte(buf: Buffer, byte_val: i64):
    if buf.write_pos >= buf.cap:
        return nil
    val clamped = byte_val & 0xFF
    buf.data.set(buf.write_pos, clamped)
    var new_pos = buf.write_pos
    new_pos = new_pos + 1
    buf.write_pos = new_pos

# Write multiple bytes from a list
fn buffer_write_bytes(buf: Buffer, bytes: List):
    var i = 0
    while i < bytes.len() and buf.write_pos < buf.cap:
        val byte_val = bytes.get(i)
        val clamped = byte_val & 0xFF
        buf.data.set(buf.write_pos, clamped)
        var new_pos = buf.write_pos
        new_pos = new_pos + 1
        buf.write_pos = new_pos
        i = i + 1

# Write a 64-bit integer in big-endian format
fn buffer_write_i64_be(buf: Buffer, value: i64):
    buffer_write_byte(buf, (value >> 56) & 0xFF)
    buffer_write_byte(buf, (value >> 48) & 0xFF)
    buffer_write_byte(buf, (value >> 40) & 0xFF)
    buffer_write_byte(buf, (value >> 32) & 0xFF)
    buffer_write_byte(buf, (value >> 24) & 0xFF)
    buffer_write_byte(buf, (value >> 16) & 0xFF)
    buffer_write_byte(buf, (value >> 8) & 0xFF)
    buffer_write_byte(buf, value & 0xFF)

# Write a 64-bit integer in little-endian format
fn buffer_write_i64_le(buf: Buffer, value: i64):
    buffer_write_byte(buf, value & 0xFF)
    buffer_write_byte(buf, (value >> 8) & 0xFF)
    buffer_write_byte(buf, (value >> 16) & 0xFF)
    buffer_write_byte(buf, (value >> 24) & 0xFF)
    buffer_write_byte(buf, (value >> 32) & 0xFF)
    buffer_write_byte(buf, (value >> 40) & 0xFF)
    buffer_write_byte(buf, (value >> 48) & 0xFF)
    buffer_write_byte(buf, (value >> 56) & 0xFF)

# Write a 32-bit integer in big-endian format
fn buffer_write_i32_be(buf: Buffer, value: i64):
    buffer_write_byte(buf, (value >> 24) & 0xFF)
    buffer_write_byte(buf, (value >> 16) & 0xFF)
    buffer_write_byte(buf, (value >> 8) & 0xFF)
    buffer_write_byte(buf, value & 0xFF)

# Write a 32-bit integer in little-endian format
fn buffer_write_i32_le(buf: Buffer, value: i64):
    buffer_write_byte(buf, value & 0xFF)
    buffer_write_byte(buf, (value >> 8) & 0xFF)
    buffer_write_byte(buf, (value >> 16) & 0xFF)
    buffer_write_byte(buf, (value >> 24) & 0xFF)

# Write a 16-bit integer in big-endian format
fn buffer_write_i16_be(buf: Buffer, value: i64):
    buffer_write_byte(buf, (value >> 8) & 0xFF)
    buffer_write_byte(buf, value & 0xFF)

# Write a 16-bit integer in little-endian format
fn buffer_write_i16_le(buf: Buffer, value: i64):
    buffer_write_byte(buf, value & 0xFF)
    buffer_write_byte(buf, (value >> 8) & 0xFF)

# Write a string as UTF-8 bytes with length prefix
fn buffer_write_string(buf: Buffer, s: text):
    val bytes = string_to_bytes(s)
    val len_val = bytes.len()
    buffer_write_i32_be(buf, len_val)
    buffer_write_bytes(buf, bytes)

# Write a string without length prefix
fn buffer_write_raw_string(buf: Buffer, s: text):
    val bytes = string_to_bytes(s)
    buffer_write_bytes(buf, bytes)

# Write a line (string + newline)
fn buffer_write_line(buf: Buffer, s: text):
    buffer_write_raw_string(buf, s)
    buffer_write_byte(buf, 10)  # newline

# Forward declaration
fn string_to_bytes(s: text) -> List
