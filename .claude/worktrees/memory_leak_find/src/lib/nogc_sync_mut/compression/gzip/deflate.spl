# DEFLATE Compression Algorithm
#
# Purpose: DEFLATE compression (LZ77 + Huffman coding)
#
# Contains:
# - DEFLATE block creation (stored, fixed Huffman)
# - Length/distance code mapping
# - Block encoding with Huffman codes
# - Token-to-block conversion

mod compression.gzip.types
mod compression.gzip.huffman

# =============================================================================
# DEFLATE BLOCKS
# =============================================================================

# Create DEFLATE stored block (uncompressed)
fn deflate_block_stored(data, is_final):
    if data == nil:
        return []

    var block = []

    # Block header (3 bits)
    var header = BLOCK_STORED << 1
    if is_final:
        header = header | 1

    block = block + [header]

    # Length (2 bytes)
    val len = data.length()
    block = block + [len & 0xff]
    block = block + [(len >> 8) & 0xff]

    # One's complement of length
    val nlen = (~len) & 0xffff
    block = block + [nlen & 0xff]
    block = block + [(nlen >> 8) & 0xff]

    # Data bytes
    var i = 0
    loop:
        if i >= data.length():
            break
        block = block + [data[i]]
        i = i + 1

    return block

# Create DEFLATE fixed Huffman block
fn deflate_block_fixed(tokens, is_final):
    if tokens == nil:
        return []

    # Block header
    var header = BLOCK_FIXED << 1
    if is_final:
        header = header | 1

    var block = [header]

    # Encode tokens using fixed Huffman codes
    val lit_codes = deflate_fixed_huffman()
    val dist_codes = deflate_fixed_distances()

    var i = 0
    loop:
        if i >= tokens.length():
            break

        val token = tokens[i]
        val token_type = token[0]
        val value = token[1]

        if token_type == 0:
            # Literal
            val code_info = huffman_lookup(lit_codes, value)
            if code_info != nil:
                block = block + [code_info[0]]
        else:
            # Match
            val distance = value
            val length = token[2]

            # Encode length
            val len_code = deflate_length_code(length)
            val len_info = huffman_lookup(lit_codes, len_code)
            if len_info != nil:
                block = block + [len_info[0]]

            # Encode distance
            val dist_code = deflate_distance_code(distance)
            val dist_info = huffman_lookup(dist_codes, dist_code)
            if dist_info != nil:
                block = block + [dist_info[0]]

        i = i + 1

    # End of block marker (256)
    val eob_info = huffman_lookup(lit_codes, 256)
    if eob_info != nil:
        block = block + [eob_info[0]]

    return block

# Get length code for match length
fn deflate_length_code(length):
    if length < 3:
        return 257
    if length <= 10:
        return 257 + (length - 3)
    if length <= 18:
        return 265 + ((length - 11) / 2)
    if length <= 34:
        return 269 + ((length - 19) / 4)
    if length <= 66:
        return 273 + ((length - 35) / 8)
    if length <= 130:
        return 277 + ((length - 67) / 16)
    if length <= 257:
        return 281 + ((length - 131) / 32)
    return 285

# Get distance code for match distance
fn deflate_distance_code(distance):
    if distance <= 4:
        return distance - 1
    if distance <= 8:
        return 4 + ((distance - 5) / 2)
    if distance <= 16:
        return 6 + ((distance - 9) / 4)
    if distance <= 32:
        return 8 + ((distance - 17) / 8)
    if distance <= 64:
        return 10 + ((distance - 33) / 16)
    if distance <= 128:
        return 12 + ((distance - 65) / 32)
    if distance <= 256:
        return 14 + ((distance - 129) / 64)
    if distance <= 512:
        return 16 + ((distance - 257) / 128)
    if distance <= 1024:
        return 18 + ((distance - 513) / 256)
    if distance <= 2048:
        return 20 + ((distance - 1025) / 512)
    if distance <= 4096:
        return 22 + ((distance - 2049) / 1024)
    if distance <= 8192:
        return 24 + ((distance - 4097) / 2048)
    if distance <= 16384:
        return 26 + ((distance - 8193) / 4096)
    return 28

export *
