# CRC32 Checksum Operations
#
# Purpose: CRC32 checksum calculation for data integrity verification
#
# Contains:
# - CRC32 lookup table generation
# - CRC32 calculation (full data)
# - CRC32 streaming updates (chunked data)
# - CRC32 finalization
# - CRC32 verification

# =============================================================================
# CRC32 CHECKSUM
# =============================================================================

# CRC32 lookup table (simplified - only first 16 entries)
fn crc32_table():
    return [
        0x00000000, 0x77073096, 0xee0e612c, 0x990951ba,
        0x076dc419, 0x706af48f, 0xe963a535, 0x9e6495a3,
        0x0edb8832, 0x79dcb8a4, 0xe0d5e91e, 0x97d2d988,
        0x09b64c2b, 0x7eb17cbd, 0xe7b82d07, 0x90bf1d91
    ]

# Calculate CRC32 checksum
fn crc32_calculate(data):
    if data == nil:
        return 0

    var crc = 0xffffffff
    var i = 0
    val table = crc32_table()

    loop:
        if i >= data.length():
            break

        val byte_val = data[i]
        val index = (crc ^ byte_val) & 0x0f
        crc = (crc >> 4) ^ table[index]

        i = i + 1

    return crc ^ 0xffffffff

# Update running CRC32 with new data
fn crc32_update(crc, data):
    if data == nil:
        return crc

    var current = crc
    var i = 0
    val table = crc32_table()

    loop:
        if i >= data.length():
            break

        val byte_val = data[i]
        val index = (current ^ byte_val) & 0x0f
        current = (current >> 4) ^ table[index]

        i = i + 1

    return current

# Finalize CRC32 (XOR with 0xffffffff)
fn crc32_finalize(crc):
    return crc ^ 0xffffffff

# Calculate CRC32 in chunks
fn crc32_chunked(chunks):
    if chunks == nil:
        return 0

    var crc = 0xffffffff
    var i = 0

    loop:
        if i >= chunks.length():
            break

        val chunk = chunks[i]
        crc = crc32_update(crc, chunk)

        i = i + 1

    return crc32_finalize(crc)

# Verify CRC32 checksum
fn crc32_verify(data, expected):
    val calculated = crc32_calculate(data)
    return calculated == expected

export *
