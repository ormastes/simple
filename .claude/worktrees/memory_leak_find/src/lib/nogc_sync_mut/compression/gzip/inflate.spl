# DEFLATE Decompression Algorithm
#
# Purpose: DEFLATE decompression (inflate) operations
#
# Contains:
# - Block parsing and type detection
# - Stored block decompression
# - Fixed/dynamic Huffman block decompression
# - Multi-block stream handling

mod compression.gzip.types
mod compression.gzip.huffman

# =============================================================================
# DEFLATE DECOMPRESSION (INFLATE)
# =============================================================================

# Parse DEFLATE block
fn deflate_block_parse(data, offset):
    if data == nil:
        return nil

    if offset >= data.length():
        return nil

    val header = data[offset]
    val is_final = (header & 1) != 0
    val block_type = (header >> 1) & 3

    var next_offset = offset + 1

    if block_type == BLOCK_STORED:
        # Stored block
        if next_offset + 4 > data.length():
            return nil

        val len = data[next_offset] | (data[next_offset + 1] << 8)
        next_offset = next_offset + 4

        if next_offset + len > data.length():
            return nil

        var block_data = []
        var i = 0
        loop:
            if i >= len:
                break
            block_data = block_data + [data[next_offset + i]]
            i = i + 1

        next_offset = next_offset + len

        return [block_type, is_final, block_data, next_offset]

    # For fixed/dynamic blocks, return partial info
    return [block_type, is_final, [], next_offset]

export *
