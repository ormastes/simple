# MCP SDK - Server Builder
#
# Fluent API for configuring an MCP server: register tools, resources,
# prompts, then build the initialize response and run the server loop.

use std.mcp_sdk.core.json.{LB, RB, Q, jp, js, jo1, jo2, jo3, escape_json, extract_json_string, extract_json_value, extract_nested_string}
use std.mcp_sdk.core.jsonrpc.{jsonrpc_result, jsonrpc_error}
use std.mcp_sdk.core.types.{ToolDef, ResourceDef, PromptDef, McpCapabilities, ServerInfo, tool_def_to_json, resource_def_to_json, prompt_def_to_json, default_capabilities, capabilities_to_json, server_info, server_info_to_json}
use std.mcp_sdk.transport.stdio.{read_stdin_message, write_stdout_message}

# Server configuration holds all registered tools, resources, prompts
struct ServerConfig:
    info: ServerInfo
    capabilities: McpCapabilities
    tool_schemas: [text]
    tool_names: [text]
    resource_schemas: [text]
    prompt_schemas: [text]
    protocol_version: text

# Create a new server configuration
fn server_config(name: text, version: text) -> ServerConfig:
    ServerConfig(
        info: server_info(name, version),
        capabilities: default_capabilities(),
        tool_schemas: [],
        tool_names: [],
        resource_schemas: [],
        prompt_schemas: [],
        protocol_version: "2025-06-18"
    )

# Set server instructions
fn server_set_instructions(cfg: ServerConfig, instructions: text) -> ServerConfig:
    val new_info = ServerInfo(
        name: cfg.info.name,
        version: cfg.info.version,
        instructions: instructions
    )
    ServerConfig(
        info: new_info,
        capabilities: cfg.capabilities,
        tool_schemas: cfg.tool_schemas,
        tool_names: cfg.tool_names,
        resource_schemas: cfg.resource_schemas,
        prompt_schemas: cfg.prompt_schemas,
        protocol_version: cfg.protocol_version
    )

# Set custom capabilities
fn server_set_capabilities(cfg: ServerConfig, caps: McpCapabilities) -> ServerConfig:
    ServerConfig(
        info: cfg.info,
        capabilities: caps,
        tool_schemas: cfg.tool_schemas,
        tool_names: cfg.tool_names,
        resource_schemas: cfg.resource_schemas,
        prompt_schemas: cfg.prompt_schemas,
        protocol_version: cfg.protocol_version
    )

# Add a tool by providing its JSON schema directly
fn server_add_tool_json(cfg: ServerConfig, name: text, schema_json: text) -> ServerConfig:
    var schemas = cfg.tool_schemas
    schemas = schemas + [schema_json]
    var names = cfg.tool_names
    names = names + [name]
    ServerConfig(
        info: cfg.info,
        capabilities: cfg.capabilities,
        tool_schemas: schemas,
        tool_names: names,
        resource_schemas: cfg.resource_schemas,
        prompt_schemas: cfg.prompt_schemas,
        protocol_version: cfg.protocol_version
    )

# Add a tool from a ToolDef struct
fn server_add_tool(cfg: ServerConfig, t: ToolDef) -> ServerConfig:
    server_add_tool_json(cfg, t.name, tool_def_to_json(t))

# Add a resource by providing its JSON schema directly
fn server_add_resource_json(cfg: ServerConfig, schema_json: text) -> ServerConfig:
    var schemas = cfg.resource_schemas
    schemas = schemas + [schema_json]
    ServerConfig(
        info: cfg.info,
        capabilities: cfg.capabilities,
        tool_schemas: cfg.tool_schemas,
        tool_names: cfg.tool_names,
        resource_schemas: schemas,
        prompt_schemas: cfg.prompt_schemas,
        protocol_version: cfg.protocol_version
    )

# Add a resource from a ResourceDef struct
fn server_add_resource(cfg: ServerConfig, r: ResourceDef) -> ServerConfig:
    server_add_resource_json(cfg, resource_def_to_json(r))

# Add a prompt by providing its JSON schema directly
fn server_add_prompt_json(cfg: ServerConfig, schema_json: text) -> ServerConfig:
    var schemas = cfg.prompt_schemas
    schemas = schemas + [schema_json]
    ServerConfig(
        info: cfg.info,
        capabilities: cfg.capabilities,
        tool_schemas: cfg.tool_schemas,
        tool_names: cfg.tool_names,
        resource_schemas: cfg.resource_schemas,
        prompt_schemas: schemas,
        protocol_version: cfg.protocol_version
    )

# Add a prompt from a PromptDef struct
fn server_add_prompt(cfg: ServerConfig, p: PromptDef) -> ServerConfig:
    server_add_prompt_json(cfg, prompt_def_to_json(p))

# Build the initialize result JSON
fn server_build_init_result(cfg: ServerConfig) -> text:
    val caps_json = capabilities_to_json(cfg.capabilities)
    val info_json = server_info_to_json(cfg.info)
    jo3(
        jp("protocolVersion", js(cfg.protocol_version)),
        jp("capabilities", caps_json),
        jp("serverInfo", info_json)
    )

# Build the tools/list result JSON
fn server_build_tools_list(cfg: ServerConfig) -> text:
    var tools_arr = "["
    var first = true
    for schema in cfg.tool_schemas:
        if not first:
            tools_arr = tools_arr + ","
        first = false
        tools_arr = tools_arr + schema
    tools_arr = tools_arr + "]"
    jo1(jp("tools", tools_arr))

# Build the resources/list result JSON
fn server_build_resources_list(cfg: ServerConfig) -> text:
    var res_arr = "["
    var first = true
    for schema in cfg.resource_schemas:
        if not first:
            res_arr = res_arr + ","
        first = false
        res_arr = res_arr + schema
    res_arr = res_arr + "]"
    jo1(jp("resources", res_arr))

# Build the prompts/list result JSON
fn server_build_prompts_list(cfg: ServerConfig) -> text:
    var pr_arr = "["
    var first = true
    for schema in cfg.prompt_schemas:
        if not first:
            pr_arr = pr_arr + ","
        first = false
        pr_arr = pr_arr + schema
    pr_arr = pr_arr + "]"
    jo1(jp("prompts", pr_arr))

# Get the number of registered tools
fn server_tool_count(cfg: ServerConfig) -> i64:
    cfg.tool_schemas.len()

# Get the number of registered resources
fn server_resource_count(cfg: ServerConfig) -> i64:
    cfg.resource_schemas.len()

# Get the number of registered prompts
fn server_prompt_count(cfg: ServerConfig) -> i64:
    cfg.prompt_schemas.len()

# --- Exports ---

export ServerConfig
export server_config, server_set_instructions, server_set_capabilities
export server_add_tool_json, server_add_tool
export server_add_resource_json, server_add_resource
export server_add_prompt_json, server_add_prompt
export server_build_init_result, server_build_tools_list
export server_build_resources_list, server_build_prompts_list
export server_tool_count, server_resource_count, server_prompt_count
