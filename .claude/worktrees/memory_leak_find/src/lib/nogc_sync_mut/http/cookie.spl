# HTTP Cookie Handling
#
# Provides cookie parsing and building functionality.

import common from "std/http/common"

# ============================================================================
# Cookie Parsing
# ============================================================================

# Parse Cookie header into list of (name, value) tuples
# Example: "session=abc123; user=alice" -> [("session", "abc123"), ("user", "alice")]
fn parse_cookie_header(header: text) -> list:
    val pairs = header.split("; ")
    var cookies = []

    var i = 0
    while i < pairs.length():
        val pair = pairs[i]
        val cookie = parse_cookie_pair(pair)
        cookies = cookies.append(cookie)
        i = i + 1

    return cookies

# Parse single cookie pair
fn parse_cookie_pair(pair: text) -> tuple:
    val eq_pos = pair.index_of("=")

    if eq_pos < 0:
        return (pair, "")

    val name = pair.substring(0, eq_pos)
    val value = pair.substring(eq_pos + 1, pair.length())

    return (name, value)

# Build cookie string with options
# options: (max_age, path, domain, secure, http_only, same_site)
fn build_cookie(name: text, value: text, options: tuple) -> text:
    var result = name
    result = result + "="
    result = result + value

    # Add Max-Age if specified
    val max_age = options[0]
    if max_age != nil:
        result = result + "; Max-Age="
        result = result + max_age.to_text()

    # Add Path if specified
    val path = options[1]
    if path != nil:
        result = result + "; Path="
        result = result + path

    # Add Domain if specified
    val domain = options[2]
    if domain != nil:
        result = result + "; Domain="
        result = result + domain

    # Add Secure if true
    val secure = options[3]
    if secure == true:
        result = result + "; Secure"

    # Add HttpOnly if true
    val http_only = options[4]
    if http_only == true:
        result = result + "; HttpOnly"

    # Add SameSite if specified
    val same_site = options[5]
    if same_site != nil:
        result = result + "; SameSite="
        result = result + same_site

    return result

# Parse Set-Cookie header into tuple
# Returns: (name, value, options)
fn parse_set_cookie(header: text) -> tuple:
    val parts = header.split("; ")

    if parts.length() == 0:
        return ("", "", nil)

    # First part is name=value
    val first = parts[0]
    val cookie = parse_cookie_pair(first)
    val name = cookie[0]
    val value = cookie[1]

    # Parse options
    var max_age = nil
    var path = nil
    var domain = nil
    var secure = false
    var http_only = false
    var same_site = nil

    var i = 1
    while i < parts.length():
        val part = parts[i]

        if part == "Secure":
            secure = true
        else:
            if part == "HttpOnly":
                http_only = true
            else:
                val eq_pos = part.index_of("=")
                if eq_pos > 0:
                    val opt_name = part.substring(0, eq_pos)
                    val opt_value = part.substring(eq_pos + 1, part.length())

                    if opt_name == "Max-Age":
                        max_age = common.parse_int(opt_value)
                    else:
                        if opt_name == "Path":
                            path = opt_value
                        else:
                            if opt_name == "Domain":
                                domain = opt_value
                            else:
                                if opt_name == "SameSite":
                                    same_site = opt_value

        i = i + 1

    val options = (max_age, path, domain, secure, http_only, same_site)
    return (name, value, options)
