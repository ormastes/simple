# Scheduler - Priority-Based Task Scheduler
#
# Schedules tasks based on priority levels.

use std.async.task.{Task}
use std.async.executor.{Executor}

class Scheduler:
    """Priority-based task scheduler.

    Schedules tasks based on priority (higher = more urgent).

    Example:
        val scheduler = Scheduler.new()

        scheduler.schedule(Task.with_priority(\: urgent(), 10))
        scheduler.schedule(Task.with_priority(\: normal(), 0))

        scheduler.run()  # Urgent tasks run first
    """
    high_priority: [Task]   # High priority tasks (priority >= 5)
    normal_priority: [Task] # Normal priority tasks
    low_priority: [Task]    # Low priority tasks (priority < 0)
    executor: Executor      # Underlying executor

    static fn new() -> Scheduler:
        """Create new scheduler."""
        Scheduler(
            high_priority: [],
            normal_priority: [],
            low_priority: [],
            executor: Executor.new()
        )

    me schedule(task: Task):
        """Schedule task based on priority.

        Args:
            task: Task to schedule
        """
        if task.priority >= 5:
            self.high_priority = self.high_priority.push(task)
        else if task.priority < 0:
            self.low_priority = self.low_priority.push(task)
        else:
            self.normal_priority = self.normal_priority.push(task)

    me run():
        """Run all scheduled tasks (priority order).

        High priority tasks run first.
        """
        # Spawn high priority tasks
        for task in self.high_priority:
            self.executor.spawn(task)
        self.high_priority = []

        # Spawn normal priority tasks
        for task in self.normal_priority:
            self.executor.spawn(task)
        self.normal_priority = []

        # Spawn low priority tasks
        for task in self.low_priority:
            self.executor.spawn(task)
        self.low_priority = []

        # Run executor
        self.executor.run()

    fn pending_count() -> usize:
        """Get count of pending tasks.

        Returns:
            Number of scheduled tasks
        """
        self.high_priority.len() +
        self.normal_priority.len() +
        self.low_priority.len()

export Scheduler
