# Lazy Value and Stream Evaluation
#
# Functions for evaluating lazy values and consuming streams:
# - Lazy value forcing
# - Stream materialization (to_list, first, nth)
# - Stream reduction (fold, reduce, scan)
# - Stream queries (any, all, find, count_matches, min, max)
# - Generator operations

import types: stream_next_internal
import create: stream_from_list

# ============================================================================
# Exports
# ============================================================================

export force_lazy, is_evaluated
export stream_to_list, stream_first, stream_nth, stream_fold
export stream_any, stream_all, stream_find, stream_count_matches
export stream_reduce, stream_min, stream_max
export generator_next, generator_has_next

# ============================================================================
# Lazy Value Evaluation
# ============================================================================

fn force_lazy(lazy_val):
    """Force evaluation of a lazy value, returning the computed result.

    If already evaluated, returns cached value.

    Example:
        val lv = lazy_value(\: 42)
        force_lazy(lv)  # 42
    """
    if lazy_val["evaluated"]:
        return lazy_val["value"]

    # Compute value
    val computed = lazy_val["thunk"]()

    # Update lazy value (mutation for memoization)
    lazy_val["evaluated"] = true
    lazy_val["value"] = computed
    lazy_val["thunk"] = nil  # Release thunk for GC

    computed

fn is_evaluated(lazy_val):
    """Check if a lazy value has been evaluated.

    Example:
        val lv = lazy_value(\: 42)
        is_evaluated(lv)      # false
        force_lazy(lv)
        is_evaluated(lv)      # true
    """
    lazy_val["evaluated"]

# ============================================================================
# Stream Consumers - Materialization
# ============================================================================

fn stream_to_list(stream):
    """Convert stream to list by materializing all elements.

    CAUTION: Do not use on infinite streams without stream_take first.

    Example:
        val s = stream_from_list([1, 2, 3])
        stream_to_list(s)  # [1, 2, 3]
    """
    var result = []
    var continue = true

    while continue:
        val next_result = stream_next_internal(stream)
        val elem = next_result[0]
        val has_next = next_result[1]

        if has_next:
            result.push(elem)
        else:
            continue = false

    result

fn stream_first(stream):
    """Get the first element of a stream, or nil if empty.

    Example:
        val s = stream_from_list([1, 2, 3])
        stream_first(s)  # 1
    """
    val next_result = stream_next_internal(stream)
    val elem = next_result[0]
    val has_next = next_result[1]

    if has_next:
        elem
    else:
        nil

fn stream_nth(stream, n):
    """Get the nth element of a stream (0-indexed), or nil if not enough elements.

    Example:
        val s = stream_from_list([10, 20, 30, 40])
        stream_nth(s, 2)  # 30
    """
    var count = 0

    while count <= n:
        val next_result = stream_next_internal(stream)
        val elem = next_result[0]
        val has_next = next_result[1]

        if has_next:
            if count == n:
                return elem
            count = count + 1
        else:
            return nil

    nil

fn stream_fold(stream, init, f):
    """Fold/reduce a stream from left with initial value.

    Example:
        val s = stream_from_list([1, 2, 3, 4])
        stream_fold(s, 0, \acc, x: acc + x)  # 10
    """
    var acc = init
    var continue = true

    while continue:
        val next_result = stream_next_internal(stream)
        val elem = next_result[0]
        val has_next = next_result[1]

        if has_next:
            acc = f(acc, elem)
        else:
            continue = false

    acc

# ============================================================================
# Stream Queries - Search and Predicates
# ============================================================================

fn stream_any(stream, predicate):
    """Check if any element satisfies predicate.

    Example:
        val s = stream_from_list([1, 2, 3, 4])
        stream_any(s, \x: x > 3)  # true
    """
    var continue = true

    while continue:
        val next_result = stream_next_internal(stream)
        val elem = next_result[0]
        val has_next = next_result[1]

        if has_next:
            if predicate(elem):
                return true
        else:
            continue = false

    false

fn stream_all(stream, predicate):
    """Check if all elements satisfy predicate.

    Example:
        val s = stream_from_list([2, 4, 6, 8])
        stream_all(s, \x: x % 2 == 0)  # true
    """
    var continue = true

    while continue:
        val next_result = stream_next_internal(stream)
        val elem = next_result[0]
        val has_next = next_result[1]

        if has_next:
            if not predicate(elem):
                return false
        else:
            continue = false

    true

fn stream_find(stream, predicate):
    """Find first element that satisfies predicate, or nil.

    Example:
        val s = stream_from_list([1, 2, 3, 4, 5])
        stream_find(s, \x: x > 3)  # 4
    """
    var continue = true

    while continue:
        val next_result = stream_next_internal(stream)
        val elem = next_result[0]
        val has_next = next_result[1]

        if has_next:
            if predicate(elem):
                return elem
        else:
            continue = false

    nil

fn stream_count_matches(stream, predicate):
    """Count how many elements satisfy predicate.

    Example:
        val s = stream_from_list([1, 2, 3, 4, 5])
        stream_count_matches(s, \x: x % 2 == 0)  # 2
    """
    var count = 0
    var continue = true

    while continue:
        val next_result = stream_next_internal(stream)
        val elem = next_result[0]
        val has_next = next_result[1]

        if has_next:
            if predicate(elem):
                count = count + 1
        else:
            continue = false

    count

fn stream_reduce(stream, f):
    """Reduce stream without initial value (uses first element).

    Returns nil if stream is empty.

    Example:
        val s = stream_from_list([1, 2, 3, 4])
        stream_reduce(s, \acc, x: acc + x)  # 10
    """
    val first_result = stream_next_internal(stream)
    val first_elem = first_result[0]
    val has_first = first_result[1]

    if not has_first:
        return nil

    var acc = first_elem
    var continue = true

    while continue:
        val next_result = stream_next_internal(stream)
        val elem = next_result[0]
        val has_next = next_result[1]

        if has_next:
            acc = f(acc, elem)
        else:
            continue = false

    acc

fn stream_min(stream):
    """Find minimum element in stream, or nil if empty.

    Example:
        val s = stream_from_list([3, 1, 4, 1, 5])
        stream_min(s)  # 1
    """
    stream_reduce(stream, \acc, x: if x < acc: x else: acc)

fn stream_max(stream):
    """Find maximum element in stream, or nil if empty.

    Example:
        val s = stream_from_list([3, 1, 4, 1, 5])
        stream_max(s)  # 5
    """
    stream_reduce(stream, \acc, x: if x > acc: x else: acc)

# ============================================================================
# Generator Operations
# ============================================================================

fn generator_next(generator):
    """Get next value from generator, or nil if exhausted.

    Example:
        val gen = make_generator([1, 2])
        generator_next(gen)  # 1
        generator_next(gen)  # 2
        generator_next(gen)  # nil
    """
    val idx = generator["index"]
    val items = generator["items"]

    if idx >= items.len():
        return nil

    val value = items[idx]
    generator["index"] = idx + 1
    value

fn generator_has_next(generator):
    """Check if generator has more values.

    Example:
        val gen = make_generator([1, 2])
        generator_has_next(gen)  # true
        generator_next(gen)
        generator_next(gen)
        generator_has_next(gen)  # false
    """
    val idx = generator["index"]
    val items = generator["items"]
    idx < items.len()
