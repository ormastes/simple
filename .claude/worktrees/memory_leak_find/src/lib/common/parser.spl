# Parser Error Recovery Utilities
#
# Provides utilities for detecting common syntax mistakes from
# other programming languages and providing helpful suggestions.
#
# Note: This is a simplified implementation that works with
# static string analysis rather than requiring runtime parser access.

use std.text.{contains, starts_with, trim}

# Common mistake types from other languages
enum CommonMistake:
    PythonDef          # def instead of fn
    PythonNone         # None instead of nil
    PythonTrue         # True instead of true
    PythonFalse        # False instead of false
    PythonSelf         # explicit self parameter
    RustLetMut         # let mut instead of var
    RustTurbofish      # .<T> instead of <T>
    RustMacro          # ! instead of @
    TsConst            # const instead of val
    TsFunction         # function instead of fn
    TsLet              # let instead of val/var
    TsArrowFunction    # => instead of lambda
    JavaPublicClass    # public class instead of class
    CTypeFirst         # int x instead of x: i64
    WrongBrackets      # [] instead of <> for generics

# Get error message for a common mistake
fn common_mistake_message(mistake: CommonMistake) -> text:
    var msg = ""
    if mistake == CommonMistake.PythonDef:
        msg = "Python-style 'def' found. Use 'fn' for function definitions in Simple."
    if mistake == CommonMistake.PythonNone:
        msg = "Python-style 'None' found. Use 'nil' for null values in Simple."
    if mistake == CommonMistake.PythonTrue:
        msg = "Python-style 'True' found. Use 'true' (lowercase) in Simple."
    if mistake == CommonMistake.PythonFalse:
        msg = "Python-style 'False' found. Use 'false' (lowercase) in Simple."
    if mistake == CommonMistake.PythonSelf:
        msg = "Python uses explicit 'self.' but Simple has implicit self in methods."
    if mistake == CommonMistake.RustLetMut:
        msg = "Rust-style 'let mut' found. Use 'var' for mutable variables in Simple."
    if mistake == CommonMistake.RustTurbofish:
        msg = "Rust-style turbofish syntax found. Use angle brackets directly in Simple."
    if mistake == CommonMistake.RustMacro:
        msg = "Rust-style macro '!' found. Use '@' for decorators/attributes in Simple."
    if mistake == CommonMistake.TsConst:
        msg = "TypeScript-style 'const' found. Use 'val' for immutable values in Simple."
    if mistake == CommonMistake.TsFunction:
        msg = "TypeScript-style 'function' found. Use 'fn' for functions in Simple."
    if mistake == CommonMistake.TsLet:
        msg = "TypeScript-style 'let' found. Use 'val' or 'var' in Simple."
    if mistake == CommonMistake.TsArrowFunction:
        msg = "TypeScript arrow function '=>' found. Use lambda syntax '\\x: expr' in Simple."
    if mistake == CommonMistake.JavaPublicClass:
        msg = "Java-style 'public class' found. Simple classes are implicitly public."
    if mistake == CommonMistake.CTypeFirst:
        msg = "C-style type-first declaration found. Type comes after the identifier in Simple."
    if mistake == CommonMistake.WrongBrackets:
        msg = "Wrong brackets for generics. Use angle brackets '<>' not square brackets '[]'."
    msg

# Get suggestion for fixing a common mistake
fn common_mistake_suggestion(mistake: CommonMistake) -> text:
    var suggestion = ""
    if mistake == CommonMistake.PythonDef:
        suggestion = "Replace 'def' with 'fn'"
    if mistake == CommonMistake.PythonNone:
        suggestion = "Replace 'None' with 'nil'"
    if mistake == CommonMistake.PythonTrue:
        suggestion = "Replace 'True' with 'true'"
    if mistake == CommonMistake.PythonFalse:
        suggestion = "Replace 'False' with 'false'"
    if mistake == CommonMistake.PythonSelf:
        suggestion = "Remove explicit 'self' parameter - it's implicit in Simple methods"
    if mistake == CommonMistake.RustLetMut:
        suggestion = "Replace 'let mut' with 'var'"
    if mistake == CommonMistake.RustTurbofish:
        suggestion = "Remove the dot: use 'function<T>()' not 'function.<T>()'"
    if mistake == CommonMistake.RustMacro:
        suggestion = "Replace '!' with '@' for attributes"
    if mistake == CommonMistake.TsConst:
        suggestion = "Replace 'const' with 'val'"
    if mistake == CommonMistake.TsFunction:
        suggestion = "Replace 'function' with 'fn'"
    if mistake == CommonMistake.TsLet:
        suggestion = "Replace 'let' with 'val' (immutable) or 'var' (mutable)"
    if mistake == CommonMistake.TsArrowFunction:
        suggestion = "Replace '=>' with lambda syntax: '\\param: expression'"
    if mistake == CommonMistake.JavaPublicClass:
        suggestion = "Remove 'public' keyword - use 'class Name:' directly"
    if mistake == CommonMistake.CTypeFirst:
        suggestion = "Move type after identifier: 'val name: i64' not 'int name'"
    if mistake == CommonMistake.WrongBrackets:
        suggestion = "Use 'List<T>' not 'List[T]' for generics"
    suggestion

# Extension methods for CommonMistake
impl CommonMistake:
    fn message() -> text:
        common_mistake_message(self)

    fn suggestion() -> text:
        common_mistake_suggestion(self)

# Simplified Parser class for error hints
# Note: This doesn't actually parse - it just analyzes strings
class Parser:
    source: text
    errors: [text]

fn parser_new(source: text) -> Parser:
    Parser(source: source, errors: [])

# Parse the source (no-op in this simplified version)
fn parser_parse(parser: Parser):
    pass_do_nothing

# Get error hints based on common patterns
fn parser_error_hints(parser: Parser) -> [text]:
    var hints = []
    val src = parser.source

    # Check for common mistakes
    if contains(src, "def "):
        hints = hints + ["Did you mean 'fn' instead of 'def'?"]
    if contains(src, " None"):
        hints = hints + ["Did you mean 'nil' instead of 'None'?"]
    if contains(src, "True") or contains(src, "False"):
        hints = hints + ["Use lowercase 'true' and 'false' in Simple"]
    if contains(src, "let mut"):
        hints = hints + ["Use 'var' instead of 'let mut'"]
    if contains(src, "const "):
        hints = hints + ["Use 'val' instead of 'const'"]
    if contains(src, "function "):
        hints = hints + ["Use 'fn' instead of 'function'"]

    hints

# Extension methods for Parser
impl Parser:
    static fn new(source: text) -> Parser:
        parser_new(source)

    me parse():
        parser_parse(self)

    fn error_hints() -> [text]:
        parser_error_hints(self)

# Detect common mistake in a source string
fn detect_common_mistake(source: text) -> CommonMistake?:
    if contains(source, "def "):
        Some(CommonMistake.PythonDef)
    else:
        var result = nil
        if contains(source, " None"):
            result = Some(CommonMistake.PythonNone)
        if contains(source, "True"):
            result = Some(CommonMistake.PythonTrue)
        if contains(source, "False"):
            result = Some(CommonMistake.PythonFalse)
        if contains(source, "let mut"):
            result = Some(CommonMistake.RustLetMut)
        if contains(source, "const "):
            result = Some(CommonMistake.TsConst)
        if contains(source, "function "):
            result = Some(CommonMistake.TsFunction)
        if contains(source, " => "):
            result = Some(CommonMistake.TsArrowFunction)
        result

# Export public API
export Parser
export CommonMistake
export detect_common_mistake
export common_mistake_message
export common_mistake_suggestion
