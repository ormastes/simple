# Template Engine Filters Module
# Text operations and formatting filters


import template.utilities

# ============================================================================
# FILTERS - Additional Text Operations
# ============================================================================

fn filter_strip_html(s: text) -> text:
    var result = ""
    var in_tag = false
    var i = 0
    while i < s.len():
        val c = s[i:i+1]
        if c == "<":
            in_tag = true
        else:
            if c == ">":
                in_tag = false
            else:
                if not in_tag:
                    result = result + c
        i = i + 1
    result

fn filter_slug(s: text) -> text:
    var result = str_to_lower(s)
    result = str_replace_all(result, " ", "-")
    result = str_replace_all(result, "_", "-")
    # Remove non-alphanumeric except dash
    var clean = ""
    var i = 0
    while i < result.len():
        val c = result[i:i+1]
        val is_valid = is_alnum_char(c) or c == "-"
        if is_valid:
            clean = clean + c
        i = i + 1
    clean

fn filter_word_count(s: text) -> text:
    val words = str_split(str_trim(s), " ")
    var count = 0
    for word in words:
        if str_trim(word).len() > 0:
            count = count + 1
    int_to_str(count)

fn filter_line_count(s: text) -> text:
    val lines = str_split(s, "\n")
    int_to_str(lines.len())

fn filter_char_count(s: text) -> text:
    int_to_str(s.len())

fn filter_first_line(s: text) -> text:
    val lines = str_split(s, "\n")
    if lines.len() > 0:
        return lines[0]
    ""

fn filter_last_line(s: text) -> text:
    val lines = str_split(s, "\n")
    if lines.len() > 0:
        return lines[lines.len() - 1]
    ""

fn filter_indent(s: text, spaces: i64) -> text:
    val lines = str_split(s, "\n")
    val indent = str_repeat(" ", spaces)
    var result: [text] = []
    for line in lines:
        result.push(indent + line)
    join_strs(result, "\n")

fn filter_dedent(s: text) -> text:
    val lines = str_split(s, "\n")
    # Find minimum indent
    var min_indent = 9999
    for line in lines:
        if str_trim(line).len() > 0:
            var spaces = 0
            var i = 0
            while i < line.len() and line[i:i+1] == " ":
                spaces = spaces + 1
                i = i + 1
            if spaces < min_indent:
                min_indent = spaces
    # Remove min indent from all lines
    var result: [text] = []
    for line in lines:
        if line.len() >= min_indent:
            result.push(line[min_indent:])
        else:
            result.push(line)
    join_strs(result, "\n")

fn filter_quote(s: text) -> text:
    "\"" + s + "\""

fn filter_unquote(s: text) -> text:
    if s.len() >= 2:
        val first = s[0:1]
        val last = s[s.len()-1:s.len()]
        if (first == "\"" and last == "\"") or (first == "'" and last == "'"):
            return s[1:s.len()-1]
    s

# ============================================================================
# FILTERS - Number Formatting
# ============================================================================

fn filter_abs(s: text) -> text:
    if s.len() > 0 and s[0:1] == "-":
        return s[1:]
    s

fn filter_format_bytes(bytes: i64) -> text:
    if bytes < 1024:
        return int_to_str(bytes) + " B"
    val kb = bytes / 1024
    if kb < 1024:
        return int_to_str(kb) + " KB"
    val mb = kb / 1024
    if mb < 1024:
        return int_to_str(mb) + " MB"
    val gb = mb / 1024
    int_to_str(gb) + " GB"

fn filter_ordinal(n: i64) -> text:
    val num_str = int_to_str(n)
    val last_digit = n % 10
    val last_two = n % 100
    if last_two >= 11 and last_two <= 13:
        return num_str + "th"
    if last_digit == 1:
        return num_str + "st"
    if last_digit == 2:
        return num_str + "nd"
    if last_digit == 3:
        return num_str + "rd"
    num_str + "th"

fn filter_percentage(n: i64, decimals: i64) -> text:
    int_to_str(n) + "%"

# ============================================================================
# FILTERS - Array/List Operations
# ============================================================================

fn filter_join_list(items: [text], sep: text) -> text:
    join_strs(items, sep)

fn filter_first_item(items: [text]) -> text:
    if items.len() > 0:
        return items[0]
    ""

fn filter_last_item(items: [text]) -> text:
    if items.len() > 0:
        return items[items.len() - 1]
    ""

fn filter_list_length(items: [text]) -> text:
    int_to_str(items.len())

fn filter_sort_list(items: [text]) -> [text]:
    # Simple bubble sort
    var result: [text] = []
    for item in items:
        result.push(item)
    var n = result.len()
    var swapped = true
    while swapped:
        swapped = false
        var i = 1
        while i < n:
            if result[i-1] > result[i]:
                val temp = result[i-1]
                result[i-1] = result[i]
                result[i] = temp
                swapped = true
            i = i + 1
        n = n - 1
    result

fn filter_reverse_list(items: [text]) -> [text]:
    var result: [text] = []
    var i = items.len() - 1
    while i >= 0:
        result.push(items[i])
        i = i - 1
    result

fn filter_unique_list(items: [text]) -> [text]:
    var result: [text] = []
    var seen: [text] = []
    for item in items:
        var found = false
        for s in seen:
            if s == item:
                found = true
        if not found:
            result.push(item)
            seen.push(item)
    result

# ============================================================================
# EXPORTS
# ============================================================================

export filter_strip_html, filter_slug, filter_word_count, filter_line_count, filter_char_count
export filter_first_line, filter_last_line, filter_indent, filter_dedent
export filter_quote, filter_unquote, filter_abs
export filter_format_bytes, filter_ordinal, filter_percentage
export filter_join_list, filter_first_item, filter_last_item, filter_list_length
export filter_sort_list, filter_reverse_list, filter_unique_list
