# XML DOM Module
# Provides DOM manipulation functions for XML elements

# =============================================================================
# Attribute Operations
# =============================================================================

fn xml_get_attr(element: tuple, attr_name: text) -> text:
    # Get an attribute value by name, returns empty string if not found
    val attrs = xml_get_attributes(element)
    var result = ""
    var i = 0
    val len = attrs.len()
    var found = false

    while i < len and not found:
        val attr = attrs[i]
        val name = attr.0
        val value = attr.1
        if name == attr_name:
            result = value
            found = true
        i = i + 1

    result

fn xml_has_attr(element: tuple, attr_name: text) -> bool:
    # Check if an element has a specific attribute
    val attrs = xml_get_attributes(element)
    var i = 0
    val len = attrs.len()
    var found = false

    while i < len and not found:
        val attr = attrs[i]
        val name = attr.0
        if name == attr_name:
            found = true
        i = i + 1

    found

fn xml_set_attr(element: tuple, attr_name: text, attr_value: text) -> tuple:
    # Set or update an attribute
    val old_attrs = xml_get_attributes(element)
    var new_attrs = []
    var i = 0
    val len = old_attrs.len()
    var found = false

    # Update existing or collect others
    while i < len:
        val attr = old_attrs[i]
        val name = attr.0
        val value = attr.1
        if name == attr_name:
            new_attrs = new_attrs.append((attr_name, attr_value))
            found = true
        else:
            new_attrs = new_attrs.append(attr)
        i = i + 1

    # Add new if not found
    if not found:
        new_attrs = new_attrs.append((attr_name, attr_value))

    xml_set_attributes(element, new_attrs)

fn xml_remove_attr(element: tuple, attr_name: text) -> tuple:
    # Remove an attribute by name
    val old_attrs = xml_get_attributes(element)
    var new_attrs = []
    var i = 0
    val len = old_attrs.len()

    while i < len:
        val attr = old_attrs[i]
        val name = attr.0
        val value = attr.1
        if name != attr_name:
            new_attrs = new_attrs.append(attr)
        i = i + 1

    xml_set_attributes(element, new_attrs)

fn xml_clear_attrs(element: tuple) -> tuple:
    # Remove all attributes
    val empty_attrs = []
    xml_set_attributes(element, empty_attrs)

fn xml_get_attr_names(element: tuple) -> list:
    # Get all attribute names
    val attrs = xml_get_attributes(element)
    var names = []
    var i = 0
    val len = attrs.len()

    while i < len:
        val attr = attrs[i]
        val name = attr.0
        names = names.append(name)
        i = i + 1

    names

fn xml_get_attr_count(element: tuple) -> i64:
    # Get the number of attributes
    val attrs = xml_get_attributes(element)
    attrs.len()

# =============================================================================
# Child Operations
# =============================================================================

fn xml_add_child(element: tuple, child: tuple) -> tuple:
    # Add a child element
    val children = xml_get_children(element)
    val new_children = children.append(child)
    xml_set_children(element, new_children)

fn xml_prepend_child(element: tuple, child: tuple) -> tuple:
    # Add a child at the beginning
    val children = xml_get_children(element)
    var new_children = [child]
    var i = 0
    val len = children.len()

    while i < len:
        new_children = new_children.append(children[i])
        i = i + 1

    xml_set_children(element, new_children)

fn xml_remove_child(element: tuple, index: i64) -> tuple:
    # Remove a child by index
    val children = xml_get_children(element)
    var new_children = []
    var i = 0
    val len = children.len()

    while i < len:
        if i != index:
            new_children = new_children.append(children[i])
        i = i + 1

    xml_set_children(element, new_children)

fn xml_get_child(element: tuple, index: i64) -> tuple:
    # Get a child by index
    val children = xml_get_children(element)
    children[index]

fn xml_get_child_count(element: tuple) -> i64:
    # Get the number of children
    val children = xml_get_children(element)
    children.len()

fn xml_clear_children(element: tuple) -> tuple:
    # Remove all children
    val empty_children = []
    xml_set_children(element, empty_children)

fn xml_has_children(element: tuple) -> bool:
    # Check if element has children
    val count = xml_get_child_count(element)
    count > 0

# =============================================================================
# Text Content Operations
# =============================================================================

fn xml_get_all_text(element: tuple) -> text:
    # Get all text content including from children
    var result = xml_get_text(element)
    val children = xml_get_children(element)
    var i = 0
    val len = children.len()

    while i < len:
        val child = children[i]
        val child_text = xml_get_all_text(child)
        result = result + child_text
        i = i + 1

    result

fn xml_append_text(element: tuple, additional_text: text) -> tuple:
    # Append text to existing text content
    val current = xml_get_text(element)
    val new_text = current + additional_text
    xml_set_text(element, new_text)

fn xml_has_text(element: tuple) -> bool:
    # Check if element has text content
    val text_val = xml_get_text(element)
    text_val.len() > 0

fn xml_is_empty(element: tuple) -> bool:
    # Check if element has no text and no children
    val has_text_val = xml_has_text(element)
    val has_children_val = xml_has_children(element)
    var is_empty_val = false
    if not has_text_val and not has_children_val:
        is_empty_val = true
    is_empty_val

# =============================================================================
# Namespace Support
# =============================================================================

fn xml_set_namespace(element: tuple, ns: tuple) -> tuple:
    # Set namespace on element
    val prefix = xml_get_namespace_prefix(ns)
    val uri = xml_get_namespace_uri(ns)
    val attr_name = "xmlns:" + prefix
    xml_set_attr(element, attr_name, uri)

fn xml_has_namespace(element: tuple, prefix: text) -> bool:
    # Check if element has namespace declaration
    val attr_name = "xmlns:" + prefix
    xml_has_attr(element, attr_name)

# =============================================================================
# Helper Functions (from types module)
# =============================================================================

fn xml_get_tag(element: tuple) -> text:
    element.0

fn xml_get_attributes(element: tuple) -> list:
    element.1

fn xml_get_children(element: tuple) -> list:
    element.2

fn xml_get_text(element: tuple) -> text:
    element.3

fn xml_set_attributes(element: tuple, new_attrs: list) -> tuple:
    val tag = xml_get_tag(element)
    val children = xml_get_children(element)
    val text_val = xml_get_text(element)
    xml_element(tag, new_attrs, children, text_val)

fn xml_set_children(element: tuple, new_children: list) -> tuple:
    val tag = xml_get_tag(element)
    val attrs = xml_get_attributes(element)
    val text_val = xml_get_text(element)
    xml_element(tag, attrs, new_children, text_val)

fn xml_set_text(element: tuple, new_text: text) -> tuple:
    val tag = xml_get_tag(element)
    val attrs = xml_get_attributes(element)
    val children = xml_get_children(element)
    xml_element(tag, attrs, children, new_text)

fn xml_element(tag: text, attributes: list, children: list, text_content: text) -> tuple:
    (tag, attributes, children, text_content)

fn xml_get_namespace_prefix(ns: tuple) -> text:
    ns.0

fn xml_get_namespace_uri(ns: tuple) -> text:
    ns.1
