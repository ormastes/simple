# Regular Expression Engine - Character Utilities
#
# Character classification and escape sequence handling.


# ============================================================================
# CHARACTER UTILITIES
# ============================================================================

fn char_code(ch: text) -> i64:
    """Get ASCII code of character."""
    if ch == "": return 0
    if ch == " ": return 32
    if ch == "!": return 33
    if ch == "\"": return 34
    if ch == "#": return 35
    if ch == "$": return 36
    if ch == "%": return 37
    if ch == "&": return 38
    if ch == "'": return 39
    if ch == "(": return 40
    if ch == ")": return 41
    if ch == "*": return 42
    if ch == "+": return 43
    if ch == ",": return 44
    if ch == "-": return 45
    if ch == ".": return 46
    if ch == "/": return 47
    if ch == "0": return 48
    if ch == "1": return 49
    if ch == "2": return 50
    if ch == "3": return 51
    if ch == "4": return 52
    if ch == "5": return 53
    if ch == "6": return 54
    if ch == "7": return 55
    if ch == "8": return 56
    if ch == "9": return 57
    if ch == ":": return 58
    if ch == ";": return 59
    if ch == "<": return 60
    if ch == "=": return 61
    if ch == ">": return 62
    if ch == "?": return 63
    if ch == "@": return 64
    if ch == "A": return 65
    if ch == "B": return 66
    if ch == "C": return 67
    if ch == "D": return 68
    if ch == "E": return 69
    if ch == "F": return 70
    if ch == "G": return 71
    if ch == "H": return 72
    if ch == "I": return 73
    if ch == "J": return 74
    if ch == "K": return 75
    if ch == "L": return 76
    if ch == "M": return 77
    if ch == "N": return 78
    if ch == "O": return 79
    if ch == "P": return 80
    if ch == "Q": return 81
    if ch == "R": return 82
    if ch == "S": return 83
    if ch == "T": return 84
    if ch == "U": return 85
    if ch == "V": return 86
    if ch == "W": return 87
    if ch == "X": return 88
    if ch == "Y": return 89
    if ch == "Z": return 90
    if ch == "[": return 91
    if ch == "\\": return 92
    if ch == "]": return 93
    if ch == "^": return 94
    if ch == "_": return 95
    if ch == "`": return 96
    if ch == "a": return 97
    if ch == "b": return 98
    if ch == "c": return 99
    if ch == "d": return 100
    if ch == "e": return 101
    if ch == "f": return 102
    if ch == "g": return 103
    if ch == "h": return 104
    if ch == "i": return 105
    if ch == "j": return 106
    if ch == "k": return 107
    if ch == "l": return 108
    if ch == "m": return 109
    if ch == "n": return 110
    if ch == "o": return 111
    if ch == "p": return 112
    if ch == "q": return 113
    if ch == "r": return 114
    if ch == "s": return 115
    if ch == "t": return 116
    if ch == "u": return 117
    if ch == "v": return 118
    if ch == "w": return 119
    if ch == "x": return 120
    if ch == "y": return 121
    if ch == "z": return 122
    if ch == "{": return 123
    if ch == "|": return 124
    if ch == "}": return 125
    if ch == "~": return 126
    if ch == "\n": return 10
    if ch == "\t": return 9
    if ch == "\r": return 13
    0

fn string_from_code(code: i64) -> text:
    """Convert ASCII code to string."""
    if code == 32: return " "
    if code == 33: return "!"
    if code == 34: return "\""
    if code == 35: return "#"
    if code == 36: return "$"
    if code == 37: return "%"
    if code == 38: return "&"
    if code == 39: return "'"
    if code == 40: return "("
    if code == 41: return ")"
    if code == 42: return "*"
    if code == 43: return "+"
    if code == 44: return ","
    if code == 45: return "-"
    if code == 46: return "."
    if code == 47: return "/"
    if code == 48: return "0"
    if code == 49: return "1"
    if code == 50: return "2"
    if code == 51: return "3"
    if code == 52: return "4"
    if code == 53: return "5"
    if code == 54: return "6"
    if code == 55: return "7"
    if code == 56: return "8"
    if code == 57: return "9"
    if code == 58: return ":"
    if code == 59: return ";"
    if code == 60: return "<"
    if code == 61: return "="
    if code == 62: return ">"
    if code == 63: return "?"
    if code == 64: return "@"
    if code == 65: return "A"
    if code == 66: return "B"
    if code == 67: return "C"
    if code == 68: return "D"
    if code == 69: return "E"
    if code == 70: return "F"
    if code == 71: return "G"
    if code == 72: return "H"
    if code == 73: return "I"
    if code == 74: return "J"
    if code == 75: return "K"
    if code == 76: return "L"
    if code == 77: return "M"
    if code == 78: return "N"
    if code == 79: return "O"
    if code == 80: return "P"
    if code == 81: return "Q"
    if code == 82: return "R"
    if code == 83: return "S"
    if code == 84: return "T"
    if code == 85: return "U"
    if code == 86: return "V"
    if code == 87: return "W"
    if code == 88: return "X"
    if code == 89: return "Y"
    if code == 90: return "Z"
    if code == 91: return "["
    if code == 92: return "\\"
    if code == 93: return "]"
    if code == 94: return "^"
    if code == 95: return "_"
    if code == 96: return "`"
    if code == 97: return "a"
    if code == 98: return "b"
    if code == 99: return "c"
    if code == 100: return "d"
    if code == 101: return "e"
    if code == 102: return "f"
    if code == 103: return "g"
    if code == 104: return "h"
    if code == 105: return "i"
    if code == 106: return "j"
    if code == 107: return "k"
    if code == 108: return "l"
    if code == 109: return "m"
    if code == 110: return "n"
    if code == 111: return "o"
    if code == 112: return "p"
    if code == 113: return "q"
    if code == 114: return "r"
    if code == 115: return "s"
    if code == 116: return "t"
    if code == 117: return "u"
    if code == 118: return "v"
    if code == 119: return "w"
    if code == 120: return "x"
    if code == 121: return "y"
    if code == 122: return "z"
    if code == 123: return "{"
    if code == 124: return "|"
    if code == 125: return "}"
    if code == 126: return "~"
    if code == 10: return "\n"
    if code == 9: return "\t"
    if code == 13: return "\r"
    ""

fn is_digit_char(ch: text) -> bool:
    """Check if character is a digit (0-9)."""
    val code = char_code(ch)
    code >= 48 and code <= 57

fn is_alpha_char(ch: text) -> bool:
    """Check if character is alphabetic (a-z, A-Z)."""
    val code = char_code(ch)
    val is_upper = code >= 65 and code <= 90
    val is_lower = code >= 97 and code <= 122
    is_upper or is_lower

fn is_alnum_char(ch: text) -> bool:
    """Check if character is alphanumeric."""
    is_alpha_char(ch) or is_digit_char(ch)

fn is_word_char(ch: text) -> bool:
    """Check if character is a word character (alphanumeric or underscore)."""
    is_alnum_char(ch) or ch == "_"

fn is_whitespace_char(ch: text) -> bool:
    """Check if character is whitespace."""
    ch == " " or ch == "\t" or ch == "\n" or ch == "\r"

fn is_hex_char(ch: text) -> bool:
    """Check if character is hexadecimal digit."""
    val code = char_code(ch)
    val is_num = code >= 48 and code <= 57
    val is_upper = code >= 65 and code <= 70
    val is_lower = code >= 97 and code <= 102
    is_num or is_upper or is_lower

fn is_special_regex_char(ch: text) -> bool:
    """Check if character has special meaning in regex."""
    ch == "." or ch == "*" or ch == "+" or ch == "?" or ch == "|" or ch == "(" or ch == ")" or ch == "[" or ch == "]" or ch == "{" or ch == "}" or ch == "^" or ch == "$" or ch == "\\"

# ============================================================================
# ESCAPE SEQUENCES
# ============================================================================

fn escape_regex(text_str: text) -> text:
    """Escape special regex characters for literal matching."""
    var result = ""
    var i = 0
    while i < text_str.len():
        val ch = text_str[i:i + 1]
        if is_special_regex_char(ch):
            result = result + "\\" + ch
        else:
            result = result + ch
        i = i + 1
    result

fn unescape_regex(text_str: text) -> text:
    """Remove escape backslashes from regex string."""
    var result = ""
    var i = 0
    while i < text_str.len():
        val ch = text_str[i:i + 1]
        if ch == "\\":
            if i + 1 < text_str.len():
                val next_ch = text_str[i + 1:i + 2]
                result = result + next_ch
                i = i + 2
            else:
                result = result + ch
                i = i + 1
        else:
            result = result + ch
            i = i + 1
    result

fn expand_escape(esc: text) -> text:
    """Expand escape sequence like \n, \t, \d, \w, \s."""
    if esc == "n": return "\n"
    if esc == "t": return "\t"
    if esc == "r": return "\r"
    if esc == "d": return "[0-9]"
    if esc == "D": return "[^0-9]"
    if esc == "w": return "[a-zA-Z0-9_]"
    if esc == "W": return "[^a-zA-Z0-9_]"
    if esc == "s": return "[ \t\n\r]"
    if esc == "S": return "[^ \t\n\r]"
    if esc == "b": return "\\b"
    if esc == "B": return "\\B"
    esc

fn is_escape_char(ch: text) -> bool:
    """Check if character can be escaped."""
    ch == "n" or ch == "t" or ch == "r" or ch == "d" or ch == "D" or ch == "w" or ch == "W" or ch == "s" or ch == "S" or ch == "b" or ch == "B"

export char_code, string_from_code
export is_digit_char, is_alpha_char, is_alnum_char, is_word_char
export is_whitespace_char, is_hex_char, is_special_regex_char
export escape_regex, unescape_regex, expand_escape, is_escape_char
