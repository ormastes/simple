# Regular Expression Engine - Replacer
#
# String replacement operations using regex patterns.

from .matcher import regex_find, regex_find_all

# ============================================================================
# REPLACEMENT
# ============================================================================

fn regex_replace(pattern: text, input: text, replacement: text) -> text:
    """Replace first match of pattern with replacement."""
    val find_result = regex_find(pattern, input)
    val found = find_result.0
    if not found:
        return input
    val start = find_result.1
    val end = find_result.2
    val before = input[0:start]
    val after = input[end:input.len()]
    before + replacement + after

fn regex_replace_all(pattern: text, input: text, replacement: text) -> text:
    """Replace all matches of pattern with replacement."""
    val matches = regex_find_all(pattern, input)
    if matches.len() == 0:
        return input
    var result = ""
    var pos = 0
    var i = 0
    while i < matches.len():
        val match_tuple = matches[i]
        val start = match_tuple.0
        val end = match_tuple.1
        result = result + input[pos:start] + replacement
        pos = end
        i = i + 1
    result = result + input[pos:input.len()]
    result

fn regex_replace_fn(pattern: text, input: text, replacer_fn: fn(text) -> text) -> text:
    """Replace matches using replacer function."""
    val matches = regex_find_all(pattern, input)
    if matches.len() == 0:
        return input
    var result = ""
    var pos = 0
    var i = 0
    while i < matches.len():
        val match_tuple = matches[i]
        val start = match_tuple.0
        val end = match_tuple.1
        val matched_text = match_tuple.2
        val replacement = replacer_fn(matched_text)
        result = result + input[pos:start] + replacement
        pos = end
        i = i + 1
    result = result + input[pos:input.len()]
    result

export regex_replace, regex_replace_all, regex_replace_fn
