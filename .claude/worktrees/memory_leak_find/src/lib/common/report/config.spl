# Report Configuration
#
# Configuration for the unified reporting system.
# Controls output format, filtering, and behavior.

import .level
import .report

export ReportConfig, OutputFormat, ColorMode

# =============================================================================
# OutputFormat: How to format report output
# =============================================================================

enum OutputFormat:
    Human       # Human-readable terminal output (default)
    Json        # JSON format for tooling
    Sarif       # SARIF format for static analysis tools
    Compact     # Compact one-line format

impl OutputFormat:
    fn name() -> text:
        match self:
            case OutputFormat.Human: "human"
            case OutputFormat.Json: "json"
            case OutputFormat.Sarif: "sarif"
            case OutputFormat.Compact: "compact"

    static fn parse(s: text) -> OutputFormat?:
        val lower = s.lower()
        match lower:
            case "human": Some(OutputFormat.Human)
            case "json": Some(OutputFormat.Json)
            case "sarif": Some(OutputFormat.Sarif)
            case "compact": Some(OutputFormat.Compact)
            case _: nil

# =============================================================================
# ColorMode: When to use colors in output
# =============================================================================

enum ColorMode:
    Auto        # Detect based on terminal
    Always      # Always use colors
    Never       # Never use colors

impl ColorMode:
    fn name() -> text:
        match self:
            case ColorMode.Auto: "auto"
            case ColorMode.Always: "always"
            case ColorMode.Never: "never"

    static fn parse(s: text) -> ColorMode?:
        val lower = s.lower()
        match lower:
            case "auto": Some(ColorMode.Auto)
            case "always": Some(ColorMode.Always)
            case "never": Some(ColorMode.Never)
            case _: nil

    # Determine if colors should be used
    fn should_use_color(is_tty: bool) -> bool:
        match self:
            case ColorMode.Auto: is_tty
            case ColorMode.Always: true
            case ColorMode.Never: false

# =============================================================================
# ReportConfig: Main configuration
# =============================================================================

class ReportConfig:
    # Level configuration
    level_config: LevelConfig

    # Output settings
    output_format: OutputFormat
    color_mode: ColorMode

    # Display options
    show_source_context: bool   # Show source code snippets
    show_suggestions: bool      # Show fix suggestions
    max_reports: i64            # Maximum reports to display (0 = unlimited)
    max_errors: i64             # Stop after N errors (0 = unlimited)

    # Behavior
    fail_on_warning: bool       # Treat any warning as failure (exit code)

impl ReportConfig:
    # Create default configuration
    static fn default_config() -> ReportConfig:
        ReportConfig(
            level_config: LevelConfig__default_config(),
            output_format: OutputFormat.Human,
            color_mode: ColorMode.Auto,
            show_source_context: true,
            show_suggestions: true,
            max_reports: 0,
            max_errors: 0,
            fail_on_warning: false
        )

    # Create strict configuration for CI
    static fn strict() -> ReportConfig:
        ReportConfig(
            level_config: LevelConfig__strict(),
            output_format: OutputFormat.Human,
            color_mode: ColorMode.Auto,
            show_source_context: true,
            show_suggestions: true,
            max_reports: 0,
            max_errors: 0,
            fail_on_warning: true
        )

    # Create quiet configuration
    static fn quiet() -> ReportConfig:
        ReportConfig(
            level_config: LevelConfig__quiet(),
            output_format: OutputFormat.Compact,
            color_mode: ColorMode.Never,
            show_source_context: false,
            show_suggestions: false,
            max_reports: 100,
            max_errors: 10,
            fail_on_warning: false
        )

    # Create JSON output configuration
    static fn json() -> ReportConfig:
        ReportConfig(
            level_config: LevelConfig__default_config(),
            output_format: OutputFormat.Json,
            color_mode: ColorMode.Never,
            show_source_context: false,
            show_suggestions: true,
            max_reports: 0,
            max_errors: 0,
            fail_on_warning: false
        )

    # ==========================================================================
    # Builder methods
    # ==========================================================================

    fn with_min_level(level: ReportLevel) -> ReportConfig:
        var new_level_config = self.level_config
        new_level_config.set_min_level(level)
        ReportConfig(
            level_config: new_level_config,
            output_format: self.output_format,
            color_mode: self.color_mode,
            show_source_context: self.show_source_context,
            show_suggestions: self.show_suggestions,
            max_reports: self.max_reports,
            max_errors: self.max_errors,
            fail_on_warning: self.fail_on_warning
        )

    fn with_output_format(format: OutputFormat) -> ReportConfig:
        ReportConfig(
            level_config: self.level_config,
            output_format: format,
            color_mode: self.color_mode,
            show_source_context: self.show_source_context,
            show_suggestions: self.show_suggestions,
            max_reports: self.max_reports,
            max_errors: self.max_errors,
            fail_on_warning: self.fail_on_warning
        )

    fn with_color_mode(mode: ColorMode) -> ReportConfig:
        ReportConfig(
            level_config: self.level_config,
            output_format: self.output_format,
            color_mode: mode,
            show_source_context: self.show_source_context,
            show_suggestions: self.show_suggestions,
            max_reports: self.max_reports,
            max_errors: self.max_errors,
            fail_on_warning: self.fail_on_warning
        )

    fn with_warnings_as_errors(enabled: bool) -> ReportConfig:
        var new_level_config = self.level_config
        new_level_config.set_warnings_as_errors(enabled)
        ReportConfig(
            level_config: new_level_config,
            output_format: self.output_format,
            color_mode: self.color_mode,
            show_source_context: self.show_source_context,
            show_suggestions: self.show_suggestions,
            max_reports: self.max_reports,
            max_errors: self.max_errors,
            fail_on_warning: self.fail_on_warning
        )

    fn with_max_errors(max: i64) -> ReportConfig:
        ReportConfig(
            level_config: self.level_config,
            output_format: self.output_format,
            color_mode: self.color_mode,
            show_source_context: self.show_source_context,
            show_suggestions: self.show_suggestions,
            max_reports: self.max_reports,
            max_errors: max,
            fail_on_warning: self.fail_on_warning
        )

    # ==========================================================================
    # Accessors
    # ==========================================================================

    # Check if a report should be displayed
    fn should_display(report: Report) -> bool:
        val effective_level = self.level_config.effective_level(report.level, report.code)
        self.level_config.should_display(effective_level)

    # Get whether to use colors (given terminal state)
    fn use_color(is_tty: bool) -> bool:
        self.color_mode.should_use_color(is_tty)

    # ==========================================================================
    # Mutable setters
    # ==========================================================================

    me set_code_level(code: text, level: ReportLevel):
        self.level_config.set_code_level(code, level)

    me add_pattern_override(pattern: text, level: ReportLevel):
        self.level_config.add_pattern_override(pattern, level)
