# Error Analysis and Validation
#
# Purpose: Error measurement, tolerance checking, and condition number analysis
#
# Contains:
# - Constants (tolerances, epsilon values, golden ratio)
# - Absolute/relative error calculation
# - Convergence checking
# - Tolerance validation
# - Matrix condition numbers

# ============================================================================
# Constants and Defaults
# ============================================================================

val NM_DEFAULT_TOLERANCE = 1e-10
val NM_DEFAULT_MAX_ITERATIONS = 1000
val NM_EPSILON = 1e-14
val NM_SQRT_EPSILON = 1e-7
val NM_GOLDEN_RATIO = 1.618033988749895

# ============================================================================
# Error Analysis and Validation
# ============================================================================

fn nm_absolute_error(approximate: f64, exact: f64) -> f64:
    """Calculate absolute error between approximate and exact values.

    Example:
        nm_absolute_error(3.14, 3.141592653589793)  # 0.001592...
    """
    var diff = approximate - exact
    if diff < 0.0:
        diff = -diff
    diff

fn nm_relative_error(approximate: f64, exact: f64) -> f64:
    """Calculate relative error as fraction of exact value.

    Returns large value if exact is zero.

    Example:
        nm_relative_error(3.14, 3.141592653589793)  # ~0.0005
    """
    if exact == 0.0:
        return 999999999.0

    val abs_error = nm_absolute_error(approximate, exact)
    var abs_exact = exact
    if abs_exact < 0.0:
        abs_exact = -abs_exact

    abs_error / abs_exact

fn nm_check_tolerance(value: f64, tolerance: f64) -> bool:
    """Check if value is within tolerance of zero.

    Example:
        nm_check_tolerance(1e-11, 1e-10)  # true
    """
    var abs_val = value
    if abs_val < 0.0:
        abs_val = -abs_val
    abs_val < tolerance

fn nm_is_converged(current: f64, previous: f64, tolerance: f64) -> bool:
    """Check if iteration has converged.

    Example:
        nm_is_converged(1.0001, 1.0, 1e-3)  # true
    """
    val error = nm_absolute_error(current, previous)
    error < tolerance

fn nm_condition_number(matrix_norm: f64, inverse_norm: f64) -> f64:
    """Calculate condition number of a matrix.

    Condition number = ||A|| * ||A^-1||
    Higher values indicate ill-conditioned systems.

    Example:
        nm_condition_number(10.0, 0.1)  # 1.0 (well-conditioned)
    """
    matrix_norm * inverse_norm

export *
