# Base85 (Ascii85) Encoding Module

use base_encoding.types.{BASE85_ADOBE_ALPHABET, BASE85_RFC1924_ALPHABET}
use base_encoding.utilities.{alphabet_char_at, alphabet_find_index, text_char_at}

# ============================================================================
# BASE85 (ASCII85) ENCODING
# ============================================================================

fn base85_encode(bytes: list) -> text:
    """Encode bytes to Base85 Adobe (Ascii85) format."""
    base85_encode_adobe(bytes)

fn base85_encode_adobe(bytes: list) -> text:
    """Encode bytes to Base85 Adobe (Ascii85) format with special sequences."""
    var result = "<~"
    var i = 0
    while i < bytes.len():
        var b1 = bytes[i]
        var b2 = 0
        var b3 = 0
        var b4 = 0
        var count = 1
        if i + 1 < bytes.len():
            b2 = bytes[i + 1]
            count = 2
        if i + 2 < bytes.len():
            b3 = bytes[i + 2]
            count = 3
        if i + 3 < bytes.len():
            b4 = bytes[i + 3]
            count = 4
        var value = b1 * 16777216 + b2 * 65536 + b3 * 256 + b4
        if value == 0:
            if count == 4:
                result = result + "z"
            else:
                var encoded = base85_encode_value(value, count, BASE85_ADOBE_ALPHABET)
                result = result + encoded
        else:
            var encoded = base85_encode_value(value, count, BASE85_ADOBE_ALPHABET)
            result = result + encoded
        i = i + 4
    result = result + "~>"
    result

fn base85_encode_rfc1924(bytes: list) -> text:
    """Encode bytes to Base85 RFC 1924 (btoa) format."""
    var result = ""
    var i = 0
    while i < bytes.len():
        var b1 = bytes[i]
        var b2 = 0
        var b3 = 0
        var b4 = 0
        var count = 1
        if i + 1 < bytes.len():
            b2 = bytes[i + 1]
            count = 2
        if i + 2 < bytes.len():
            b3 = bytes[i + 2]
            count = 3
        if i + 3 < bytes.len():
            b4 = bytes[i + 3]
            count = 4
        var value = b1 * 16777216 + b2 * 65536 + b3 * 256 + b4
        var encoded = base85_encode_value(value, count, BASE85_RFC1924_ALPHABET)
        result = result + encoded
        i = i + 4
    result

fn base85_encode_value(value: i64, byte_count: i64, alphabet: text) -> text:
    """Encode 32-bit value to Base85 characters."""
    var chars = []
    var v = value
    var i = 0
    while i < 5:
        var remainder = v % 85
        chars.push(remainder)
        v = v / 85
        i = i + 1
    var result = ""
    var output_len = byte_count + 1
    var j = 0
    while j < output_len:
        var idx = chars[4 - j]
        var c = alphabet_char_at(alphabet, idx)
        result = result + c
        j = j + 1
    result

fn base85_decode(encoded: text) -> list:
    """Decode Base85 Adobe (Ascii85) format to bytes."""
    base85_decode_adobe(encoded)

fn base85_decode_adobe(encoded: text) -> list:
    """Decode Base85 Adobe (Ascii85) format to bytes."""
    var clean = encoded
    if clean.starts_with("<~"):
        clean = clean[2:clean.len()]
    if clean.ends_with("~>"):
        clean = clean[0:clean.len()-2]
    var bytes = []
    var i = 0
    while i < clean.len():
        var c = text_char_at(clean, i)
        if c == "z":
            bytes.push(0)
            bytes.push(0)
            bytes.push(0)
            bytes.push(0)
            i = i + 1
        else:
            var chars = []
            var j = 0
            while j < 5:
                if i + j < clean.len():
                    var ch = text_char_at(clean, i + j)
                    chars.push(ch)
                j = j + 1
            var value = base85_decode_value(chars, BASE85_ADOBE_ALPHABET)
            var b1 = value / 16777216
            var b2 = (value / 65536) % 256
            var b3 = (value / 256) % 256
            var b4 = value % 256
            bytes.push(b1)
            if chars.len() > 2:
                bytes.push(b2)
            if chars.len() > 3:
                bytes.push(b3)
            if chars.len() > 4:
                bytes.push(b4)
            i = i + chars.len()
    bytes

fn base85_decode_rfc1924(encoded: text) -> list:
    """Decode Base85 RFC 1924 (btoa) format to bytes."""
    var bytes = []
    var i = 0
    while i < encoded.len():
        var chars = []
        var j = 0
        while j < 5:
            if i + j < encoded.len():
                var ch = text_char_at(encoded, i + j)
                chars.push(ch)
            j = j + 1
        var value = base85_decode_value(chars, BASE85_RFC1924_ALPHABET)
        var b1 = value / 16777216
        var b2 = (value / 65536) % 256
        var b3 = (value / 256) % 256
        var b4 = value % 256
        bytes.push(b1)
        if chars.len() > 2:
            bytes.push(b2)
        if chars.len() > 3:
            bytes.push(b3)
        if chars.len() > 4:
            bytes.push(b4)
        i = i + chars.len()
    bytes

fn base85_decode_value(chars: list, alphabet: text) -> i64:
    """Decode Base85 characters to 32-bit value."""
    var value = 0
    var i = 0
    while i < chars.len():
        var c = chars[i]
        var idx = alphabet_find_index(alphabet, c)
        if idx == -1:
            return 0
        value = value * 85 + idx
        i = i + 1
    value

fn base85_validate_adobe(encoded: text) -> bool:
    """Validate Base85 Adobe (Ascii85) encoded string."""
    if encoded.starts_with("<~") == false:
        return false
    if encoded.ends_with("~>") == false:
        return false
    var clean = encoded[2:encoded.len()-2]
    var i = 0
    while i < clean.len():
        var c = text_char_at(clean, i)
        if c == "z":
            i = i + 1
            pass
        else:
            var idx = alphabet_find_index(BASE85_ADOBE_ALPHABET, c)
            if idx == -1:
                return false
            i = i + 1
    true

fn base85_validate_rfc1924(encoded: text) -> bool:
    """Validate Base85 RFC 1924 (btoa) encoded string."""
    var i = 0
    while i < encoded.len():
        var c = text_char_at(encoded, i)
        var idx = alphabet_find_index(BASE85_RFC1924_ALPHABET, c)
        if idx == -1:
            return false
        i = i + 1
    true
