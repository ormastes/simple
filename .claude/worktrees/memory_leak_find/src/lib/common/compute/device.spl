# GPU Device Management
#
# Provides unified device selection and management across CUDA and Vulkan backends.

use app.io.cuda_ffi.*
use app.io.vulkan_ffi.*

# ============================================================================
# GPU Backend Selection
# ============================================================================

enum GpuBackend:
    Cuda
    Vulkan
    NoGpu

fn detect_backends() -> [GpuBackend]:
    var backends: [GpuBackend] = []
    if cuda_available():
        backends.push(GpuBackend.Cuda)
    if vulkan_available():
        backends.push(GpuBackend.Vulkan)
    backends

fn preferred_backend() -> GpuBackend:
    if cuda_available():
        GpuBackend.Cuda
    elif vulkan_available():
        GpuBackend.Vulkan
    else:
        GpuBackend.NoGpu

# ============================================================================
# Unified GPU Device
# ============================================================================

struct Gpu:
    backend: GpuBackend
    device_id: i64
    is_initialized: bool

fn gpu_default() -> Gpu:
    val backend = preferred_backend()
    if backend == GpuBackend.Cuda:
        cuda_set_device(0)
        Gpu(backend: backend, device_id: 0, is_initialized: true)
    elif backend == GpuBackend.Vulkan:
        vulkan_init()
        vulkan_select_device(0)
        Gpu(backend: backend, device_id: 0, is_initialized: true)
    else:
        Gpu(backend: backend, device_id: -1, is_initialized: false)

fn gpu_cuda(id: i64) -> Gpu:
    if not cuda_available():
        Gpu(backend: GpuBackend.NoGpu, device_id: -1, is_initialized: false)
    else:
        cuda_set_device(id)
        Gpu(backend: GpuBackend.Cuda, device_id: id, is_initialized: true)

fn gpu_vulkan(id: i64) -> Gpu:
    if not vulkan_available():
        Gpu(backend: GpuBackend.NoGpu, device_id: -1, is_initialized: false)
    else:
        vulkan_init()
        vulkan_select_device(id)
        Gpu(backend: GpuBackend.Vulkan, device_id: id, is_initialized: true)

impl Gpu:
    fn is_valid() -> bool:
        self.is_initialized and self.backend != GpuBackend.NoGpu

    fn name() -> text:
        if not self.is_valid():
            "No GPU"
        elif self.backend == GpuBackend.Cuda:
            val info = cuda_device_info(self.device_id)
            info.name
        elif self.backend == GpuBackend.Vulkan:
            val info = vulkan_device_info(self.device_id)
            info.name
        else:
            "No GPU"

    fn total_memory() -> i64:
        if not self.is_valid():
            0
        elif self.backend == GpuBackend.Cuda:
            val info = cuda_device_info(self.device_id)
            info.total_memory
        elif self.backend == GpuBackend.Vulkan:
            val info = vulkan_device_info(self.device_id)
            info.total_memory
        else:
            0

    fn backend_name() -> text:
        if self.backend == GpuBackend.Cuda:
            "CUDA"
        elif self.backend == GpuBackend.Vulkan:
            "Vulkan"
        else:
            "None"

    fn wait_for_idle() -> bool:
        if not self.is_valid():
            true
        elif self.backend == GpuBackend.Cuda:
            cuda_sync()
        elif self.backend == GpuBackend.Vulkan:
            vulkan_wait_idle()
        else:
            true

# ============================================================================
# Device Enumeration
# ============================================================================

struct GpuDeviceEntry:
    backend: GpuBackend
    device_id: i64
    name: text
    memory: i64

fn list_all_gpus() -> [GpuDeviceEntry]:
    var devices: [GpuDeviceEntry] = []
    if cuda_available():
        val count = cuda_device_count()
        for i in 0..count:
            val info = cuda_device_info(i)
            devices.push(GpuDeviceEntry(backend: GpuBackend.Cuda, device_id: i, name: info.name, memory: info.total_memory))
    if vulkan_available():
        vulkan_init()
        val count = vulkan_device_count()
        for i in 0..count:
            val info = vulkan_device_info(i)
            devices.push(GpuDeviceEntry(backend: GpuBackend.Vulkan, device_id: i, name: info.name, memory: info.total_memory))
    devices

fn gpu_available() -> bool:
    cuda_available() or vulkan_available()

fn gpu_count() -> i64:
    var count: i64 = 0
    if cuda_available():
        count = count + cuda_device_count()
    if vulkan_available():
        vulkan_init()
        count = count + vulkan_device_count()
    count

# ============================================================================
# Exports
# ============================================================================

export GpuBackend, detect_backends, preferred_backend
export Gpu, gpu_default, gpu_cuda, gpu_vulkan
export GpuDeviceEntry, list_all_gpus, gpu_available, gpu_count
