# LZ77 Type Definitions
#
# Core data structures and type definitions for LZ77 compression.

# ============================================================================
# Exports
# ============================================================================

export LZ77Token, MatchResult, LZ77Stats, SlidingWindow, HashTable, LookaheadBuffer, CompressionContext
export create_literal_token, create_match_token, create_match_result
export create_stats, create_sliding_window, create_lookahead_buffer, create_hash_table, create_compression_context

# ============================================================================
# Constants
# ============================================================================

val DEFAULT_WINDOW_SIZE = 32768  # 32KB sliding window
val DEFAULT_LOOKAHEAD_SIZE = 258  # Maximum lookahead buffer
val MIN_MATCH_LENGTH = 3  # Minimum match length for compression
val MAX_MATCH_LENGTH = 258  # Maximum match length
val HASH_BITS = 15  # Hash table size (2^15 entries)
val HASH_SIZE = 32768  # 2^15
val HASH_MASK = 32767  # 2^15 - 1
val NIL_INDEX = -1  # Marker for no match

# Token types
val TOKEN_LITERAL = "literal"
val TOKEN_MATCH = "match"

# ============================================================================
# Core Data Structures
# ============================================================================

# Compression token (literal or match)
class LZ77Token:
    token_type: text  # "literal" or "match"
    value: any  # For literal: byte value, for match: (distance, length)

    fn is_literal() -> bool:
        self.token_type == TOKEN_LITERAL

    fn is_match() -> bool:
        self.token_type == TOKEN_MATCH

    fn get_literal_value() -> i64:
        if self.token_type == TOKEN_LITERAL:
            self.value
        else:
            0

    fn get_match_distance() -> i64:
        if self.token_type == TOKEN_MATCH:
            val match_data = self.value
            match_data.0
        else:
            0

    fn get_match_length() -> i64:
        if self.token_type == TOKEN_MATCH:
            val match_data = self.value
            match_data.1
        else:
            0

# Match result
class MatchResult:
    distance: i64  # Distance back in window
    length: i64  # Length of match
    position: i64  # Position in search buffer

    fn is_valid() -> bool:
        self.length >= MIN_MATCH_LENGTH

# Compression statistics
class LZ77Stats:
    input_bytes: i64
    output_tokens: i64
    literal_count: i64
    match_count: i64
    total_match_length: i64
    total_match_distance: i64
    max_match_length: i64
    max_match_distance: i64

    fn compression_ratio() -> i64:
        if self.input_bytes == 0:
            0
        else:
            val total_match = self.total_match_length
            val ratio = (total_match * 100) / self.input_bytes
            ratio

# Sliding window state
class SlidingWindow:
    buffer: list  # Circular buffer for window data
    size: i64  # Window size
    position: i64  # Current position in buffer
    head: i64  # Head position (oldest data)
    tail: i64  # Tail position (newest data)
    count: i64  # Number of bytes in window

    fn is_empty() -> bool:
        self.count == 0

    fn is_full() -> bool:
        self.count == self.size

    fn available_space() -> i64:
        self.size - self.count

# Hash table for fast match finding
class HashTable:
    table: list  # Hash table entries (head pointers)
    prev: list  # Previous pointers for chain
    size: i64  # Table size

    fn clear_entry(index: i64):
        self.table[index] = NIL_INDEX

    fn get_head(hash: i64) -> i64:
        val idx = hash & HASH_MASK
        self.table[idx]

# Lookahead buffer
class LookaheadBuffer:
    data: list  # Buffer data
    size: i64  # Buffer size
    length: i64  # Current data length

    fn is_empty() -> bool:
        self.length == 0

    fn is_full() -> bool:
        self.length == self.size

    fn available_space() -> i64:
        self.size - self.length

# Compression context
class CompressionContext:
    window: any  # SlidingWindow
    lookahead: any  # LookaheadBuffer
    hash_table: any  # HashTable
    stats: any  # LZ77Stats
    input_pos: i64  # Position in input
    lazy_match: any  # MatchResult or nil

    fn has_lazy_match() -> bool:
        val lazy = self.lazy_match
        lazy != nil

# ============================================================================
# Token Creation
# ============================================================================

fn create_literal_token(value: i64) -> any:
    # Create a literal token
    LZ77Token(token_type: TOKEN_LITERAL, value: value)

fn create_match_token(distance: i64, length: i64) -> any:
    # Create a match token
    val match_data = (distance, length)
    LZ77Token(token_type: TOKEN_MATCH, value: match_data)

fn create_match_result(distance: i64, length: i64, position: i64) -> any:
    # Create match result
    MatchResult(distance: distance, length: length, position: position)

# ============================================================================
# Structure Creation
# ============================================================================

fn create_stats() -> any:
    # Create new statistics object
    LZ77Stats(input_bytes: 0, output_tokens: 0, literal_count: 0, match_count: 0, total_match_length: 0, total_match_distance: 0, max_match_length: 0, max_match_distance: 0)

fn create_sliding_window(size: i64) -> any:
    # Create new sliding window
    val buffer = []
    SlidingWindow(buffer: buffer, size: size, position: 0, head: 0, tail: 0, count: 0)

fn create_lookahead_buffer(size: i64) -> any:
    # Create new lookahead buffer
    val data = []
    LookaheadBuffer(data: data, size: size, length: 0)

fn create_hash_table(size: i64) -> any:
    # Create new hash table
    val table = []
    val prev = []
    var i = 0
    while i < HASH_SIZE:
        table.push(NIL_INDEX)
        i = i + 1
    HashTable(table: table, prev: prev, size: HASH_SIZE)

fn create_compression_context(window_size: i64, lookahead_size: i64) -> any:
    # Create compression context
    val window = create_sliding_window(window_size)
    val lookahead = create_lookahead_buffer(lookahead_size)
    val hash_table = create_hash_table(HASH_SIZE)
    val stats = create_stats()
    CompressionContext(window: window, lookahead: lookahead, hash_table: hash_table, stats: stats, input_pos: 0, lazy_match: nil)
