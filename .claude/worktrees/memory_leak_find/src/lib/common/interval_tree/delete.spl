# Interval Tree - Deletion Operations

use interval_tree.types.{
    interval_compare, node_interval, node_left, node_right,
    node_set_interval, node_set_left, node_set_right,
    color_black, node_set_color, update_max_end
}
use interval_tree.query.{find_min}

# ============================================================================
# Deletion
# ============================================================================

fn remove(tree: any, interval: (i64, i64, i64)) -> any:
    if tree == nil:
        nil
    else:
        val result = remove_helper(tree, interval)

        # Ensure root is black
        if result == nil:
            nil
        else:
            val r = result as (i64, (i64, i64, i64), i64, any, any)
            node_set_color(r, color_black())

fn remove_helper(node: any, interval: (i64, i64, i64)) -> any:
    if node == nil:
        nil
    else:
        val n = node as (i64, (i64, i64, i64), i64, any, any)
        val node_interval = node_interval(n)
        val cmp = interval_compare(interval, node_interval)

        var result = n

        if cmp < 0:
            val left = node_left(n)
            val new_left = remove_helper(left, interval)
            result = node_set_left(n, new_left)
        else: if cmp > 0:
            val right = node_right(n)
            val new_right = remove_helper(right, interval)
            result = node_set_right(n, new_right)
        else:
            # Found node to remove
            val left = node_left(n)
            val right = node_right(n)

            if left == nil:
                result = right
            else: if right == nil:
                result = left
            else:
                # Two children: replace with successor
                val successor = find_min(right)
                val succ = successor as (i64, (i64, i64, i64), i64, any, any)
                val succ_interval = node_interval(succ)

                val new_right = remove_helper(right, succ_interval)
                val updated = node_set_interval(n, succ_interval)
                result = node_set_right(updated, new_right)

        update_max_end(result)

# ============================================================================
# Exports
# ============================================================================

export remove, remove_helper
