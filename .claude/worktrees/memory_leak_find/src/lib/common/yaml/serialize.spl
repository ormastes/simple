# YAML Serialize Module
# YAML serialization to text


import yaml.types

# ============================================================================
# Serialization
# ============================================================================

fn yaml_serialize_scalar(value: (text, any), indent_level: i64, indent_size: i64) -> text:
    """Serialize a scalar value to YAML."""
    val scalar_data = value.1
    val scalar_type = scalar_data.0
    val scalar_content = scalar_data.1
    var result = scalar_content
    if scalar_type == "string":
        if yaml_needs_quotes(scalar_content):
            result = yaml_quote_string(scalar_content, "double")
        else:
            result = scalar_content
    result

fn yaml_serialize_sequence_block(value: (text, any), indent_level: i64, indent_size: i64) -> text:
    """Serialize a sequence value to YAML in block style."""
    val items = yaml_get_sequence_items(value)
    var result = ""
    var i = 0
    while i < items.length():
        val item = items.get(i)
        val item_type = item.0
        var item_text = ""
        if item_type == "scalar":
            item_text = yaml_serialize_scalar(item, indent_level, indent_size)
        else if item_type == "sequence":
            item_text = yaml_serialize_sequence_block(item, indent_level + 1, indent_size)
        else if item_type == "mapping":
            item_text = yaml_serialize_mapping_block(item, indent_level + 1, indent_size)
        val indented = yaml_indent("- " + item_text, indent_level, indent_size)
        if i > 0:
            result = result + "\n"
        result = result + indented
        i = i + 1
    result

fn yaml_serialize_mapping_block(value: (text, any), indent_level: i64, indent_size: i64) -> text:
    """Serialize a mapping value to YAML in block style."""
    val pairs = yaml_get_mapping_pairs(value)
    var result = ""
    var i = 0
    while i < pairs.length():
        val pair = pairs.get(i)
        val key = pair.0
        val val_obj = pair.1
        val val_type = val_obj.0
        var val_text = ""
        if val_type == "scalar":
            val_text = yaml_serialize_scalar(val_obj, indent_level, indent_size)
        else if val_type == "sequence":
            val_text = "\n" + yaml_serialize_sequence_block(val_obj, indent_level + 1, indent_size)
        else if val_type == "mapping":
            val_text = "\n" + yaml_serialize_mapping_block(val_obj, indent_level + 1, indent_size)
        val line = key + ": " + val_text
        val indented = yaml_indent(line, indent_level, indent_size)
        if i > 0:
            result = result + "\n"
        result = result + indented
        i = i + 1
    result

fn yaml_serialize_flow_sequence(value: (text, any)) -> text:
    """Serialize a sequence value to YAML in flow style."""
    val items = yaml_get_sequence_items(value)
    var result = "["
    var i = 0
    while i < items.length():
        val item = items.get(i)
        val item_type = item.0
        var item_text = ""
        if item_type == "scalar":
            item_text = yaml_serialize_scalar(item, 0, 0)
        else if item_type == "sequence":
            item_text = yaml_serialize_flow_sequence(item)
        else if item_type == "mapping":
            item_text = yaml_serialize_flow_mapping(item)
        if i > 0:
            result = result + ", "
        result = result + item_text
        i = i + 1
    result = result + "]"
    result

fn yaml_serialize_flow_mapping(value: (text, any)) -> text:
    """Serialize a mapping value to YAML in flow style."""
    val pairs = yaml_get_mapping_pairs(value)
    var result = "{"
    var i = 0
    while i < pairs.length():
        val pair = pairs.get(i)
        val key = pair.0
        val val_obj = pair.1
        val val_type = val_obj.0
        var val_text = ""
        if val_type == "scalar":
            val_text = yaml_serialize_scalar(val_obj, 0, 0)
        else if val_type == "sequence":
            val_text = yaml_serialize_flow_sequence(val_obj)
        else if val_type == "mapping":
            val_text = yaml_serialize_flow_mapping(val_obj)
        if i > 0:
            result = result + ", "
        result = result + key + ": " + val_text
        i = i + 1
    result = result + "}"
    result

fn yaml_serialize(value: (text, any), style: text) -> text:
    """Serialize a YAML value to text. Style can be 'block' or 'flow'."""
    val value_type = value.0
    var result = ""
    if style == "flow":
        if value_type == "scalar":
            result = yaml_serialize_scalar(value, 0, 0)
        else if value_type == "sequence":
            result = yaml_serialize_flow_sequence(value)
        else if value_type == "mapping":
            result = yaml_serialize_flow_mapping(value)
    else:
        if value_type == "scalar":
            result = yaml_serialize_scalar(value, 0, 2)
        else if value_type == "sequence":
            result = yaml_serialize_sequence_block(value, 0, 2)
        else if value_type == "mapping":
            result = yaml_serialize_mapping_block(value, 0, 2)
    result

fn yaml_serialize_block(value: (text, any)) -> text:
    """Serialize a YAML value to block style."""
    yaml_serialize(value, "block")

fn yaml_serialize_flow(value: (text, any)) -> text:
    """Serialize a YAML value to flow style."""
    yaml_serialize(value, "flow")


# ============================================================================
# EXPORTS
# ============================================================================

export yaml_serialize_scalar, yaml_serialize_sequence_block, yaml_serialize_mapping_block
export yaml_serialize_flow_sequence, yaml_serialize_flow_mapping
export yaml_serialize, yaml_serialize_block, yaml_serialize_flow
export yaml_serialize_documents
