# Context Diff Format Module
# Generate context diffs (like diff -c)

import diff.patch

fn format_context(changes: list, file1: text, file2: text, context_lines: i64) -> text:
    # Format diff in context format (like diff -c)
    var result = "*** {file1}\n--- {file2}\n"

    val hunks = create_hunks(changes, context_lines)

    var i = 0
    while i < hunks.length():
        val hunk = hunks.get(i)
        result = result + format_hunk_context(hunk)
        i = i + 1

    result

fn format_hunk_context(hunk: tuple) -> text:
    # Format a single hunk in context format
    val old_start = hunk.old_start + 1
    val old_end = old_start + hunk.old_count - 1
    val new_start = hunk.new_start + 1
    val new_end = new_start + hunk.new_count - 1

    var result = "***************\n"
    result = result + "*** {old_start},{old_end} ****\n"

    val changes = hunk.changes
    var i = 0
    while i < changes.length():
        val change = changes.get(i)
        val op = change.op

        if op == "equal" or op == "delete":
            val prefix = if op == "delete": "- " else: "  "
            result = result + prefix + change.content + "\n"
        else:
            if op == "change":
                result = result + "! " + change.old_content + "\n"

        i = i + 1

    result = result + "--- {new_start},{new_end} ----\n"

    i = 0
    while i < changes.length():
        val change = changes.get(i)
        val op = change.op

        if op == "equal" or op == "add":
            val prefix = if op == "add": "+ " else: "  "
            result = result + prefix + change.content + "\n"
        else:
            if op == "change":
                result = result + "! " + change.new_content + "\n"

        i = i + 1

    result
