# ============================================================================
# URI Encoding/Decoding (Percent Encoding)
# ============================================================================

# Encode a string for use in URI components
fn uri_encode(str: text) -> text:
    var result = ""
    var i = 0
    while i < string_length(str):
        var ch = string_char_at(str, i)
        var code = string_char_code(ch)

        # Unreserved characters (RFC 3986)
        var is_unreserved = false
        is_unreserved = (code >= 65 and code <= 90) or (code >= 97 and code <= 122)  # A-Z, a-z
        is_unreserved = is_unreserved or (code >= 48 and code <= 57)  # 0-9
        is_unreserved = is_unreserved or ch == "-" or ch == "_" or ch == "." or ch == "~"

        if is_unreserved:
            result = result + ch
        else:
            # Percent encode
            var hex = to_hex_byte(code)
            result = result + "%" + hex

        i = i + 1

    result

# Decode a percent-encoded string
fn uri_decode(str: text) -> text:
    var result = ""
    var i = 0
    while i < string_length(str):
        var ch = string_char_at(str, i)

        if ch == "%":
            if i + 2 < string_length(str):
                var hex1 = string_char_at(str, i + 1)
                var hex2 = string_char_at(str, i + 2)
                var code = from_hex_byte(hex1, hex2)
                var decoded = string_from_char_code(code)
                result = result + decoded
                i = i + 3
            else:
                result = result + ch
                i = i + 1
        else:
            if ch == "+":
                result = result + " "
            else:
                result = result + ch
            i = i + 1

    result

# Encode query string component (spaces become +)
fn uri_encode_query(str: text) -> text:
    var encoded = uri_encode(str)
    string_replace_all(encoded, "%20", "+")

