# Iterator Filtering
#
# Functions for filtering and conditional operations on iterators.

import iterator/types (iter_next_internal)
import iterator/create (iter_from_array)

export iter_filter, iter_take_while, iter_drop_while

fn iter_filter(iter, predicate):
    """Keep only elements satisfying the predicate.

    Example:
        val it = iter_from_array([1, 2, 3, 4, 5])
        val evens = iter_filter(it, \x: x % 2 == 0)
        iter_collect(evens)  # [2, 4]
    """
    var result = []
    var continue = true

    while continue:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            if predicate(elem):
                result.push(elem)
        else:
            continue = false

    iter_from_array(result)

fn iter_take_while(iter, predicate):
    """Take elements while predicate is true.

    Example:
        val it = iter_from_array([2, 4, 6, 7, 8])
        val evens = iter_take_while(it, \x: x % 2 == 0)
        iter_collect(evens)  # [2, 4, 6]
    """
    var result = []
    var continue = true

    while continue:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            if predicate(elem):
                result.push(elem)
            else:
                continue = false
        else:
            continue = false

    iter_from_array(result)

fn iter_drop_while(iter, predicate):
    """Drop elements while predicate is true.

    Example:
        val it = iter_from_array([2, 4, 6, 7, 8])
        val rest = iter_drop_while(it, \x: x % 2 == 0)
        iter_collect(rest)  # [7, 8]
    """
    var dropping = true
    var result = []

    while dropping:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            if not predicate(elem):
                dropping = false
                result.push(elem)
        else:
            dropping = false

    # Collect remaining
    var continue = true
    while continue:
        val next_result = iter_next_internal(iter)
        val elem = next_result[0]
        val has_more = next_result[1]

        if has_more:
            result.push(elem)
        else:
            continue = false

    iter_from_array(result)
