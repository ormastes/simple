# HTML Entity Encoding and Decoding
#
# Provides HTML entity encoding/decoding for named and numeric entities.

# =============================================================================
# HTML Entity Decoding
# =============================================================================

fn decode_html_entity(entity: text) -> text:
    var result = entity

    # Named entities
    if entity == "lt":
        result = "<"
    if entity == "gt":
        result = ">"
    if entity == "amp":
        result = "&"
    if entity == "quot":
        result = "\""
    if entity == "apos":
        result = "'"
    if entity == "nbsp":
        result = " "
    if entity == "copy":
        result = "©"
    if entity == "reg":
        result = "®"
    if entity == "trade":
        result = "™"
    if entity == "euro":
        result = "€"
    if entity == "pound":
        result = "£"
    if entity == "yen":
        result = "¥"
    if entity == "cent":
        result = "¢"
    if entity == "sect":
        result = "§"
    if entity == "deg":
        result = "°"
    if entity == "plusmn":
        result = "±"
    if entity == "micro":
        result = "µ"
    if entity == "para":
        result = "¶"
    if entity == "middot":
        result = "·"
    if entity == "frac14":
        result = "¼"
    if entity == "frac12":
        result = "½"
    if entity == "frac34":
        result = "¾"
    if entity == "times":
        result = "×"
    if entity == "divide":
        result = "÷"
    if entity == "hearts":
        result = "♥"
    if entity == "clubs":
        result = "♣"
    if entity == "diams":
        result = "♦"
    if entity == "spades":
        result = "♠"

    # Numeric entities (decimal)
    if entity.starts_with("#"):
        val num_part = entity.substring(1, entity.length())
        if num_part.length() > 0:
            var is_hex = false
            var final_num = num_part
            if num_part.starts_with("x"):
                is_hex = true
                final_num = num_part.substring(1, num_part.length())
            if final_num.length() > 0:
                # Simple numeric conversion (limited)
                var code = 0
                if is_hex:
                    # Hex not fully supported in runtime
                    result = entity
                else:
                    # Decimal - parse simple cases
                    var i = 0
                    var valid = true
                    while i < final_num.length():
                        val c = final_num.substring(i, i + 1)
                        if is_digit(c):
                            val digit = c.char_code_at(0) - 48
                            code = code * 10 + digit
                        else:
                            valid = false
                            i = final_num.length()
                        i = i + 1
                    if valid:
                        if code > 0:
                            if code < 128:
                                result = text_from_char_code(code)

    result

fn decode_html_entities(input: text) -> text:
    var result = ""
    var i = 0
    while i < input.length():
        val c = input.substring(i, i + 1)
        if c == "&":
            # Find end of entity
            var end_pos = i + 1
            var found_semi = false
            while end_pos < input.length():
                val ec = input.substring(end_pos, end_pos + 1)
                if ec == ";":
                    found_semi = true
                    end_pos = end_pos + 1
                    end_pos = input.length()
                else:
                    end_pos = end_pos + 1
                    if end_pos - i > 20:
                        end_pos = input.length()

            if found_semi:
                val entity_full = input.substring(i + 1, end_pos - 1)
                val decoded = decode_html_entity(entity_full)
                result = result + decoded
                i = end_pos
            else:
                result = result + c
                i = i + 1
        else:
            result = result + c
            i = i + 1
    result

fn encode_html_entities(input: text) -> text:
    var result = ""
    var i = 0
    while i < input.length():
        val c = input.substring(i, i + 1)
        if c == "<":
            result = result + "&lt;"
        else:
            if c == ">":
                result = result + "&gt;"
            else:
                if c == "&":
                    result = result + "&amp;"
                else:
                    if c == "\"":
                        result = result + "&quot;"
                    else:
                        result = result + c
        i = i + 1
    result

# =============================================================================
# Character Code Conversion
# =============================================================================

fn text_from_char_code(code: i64) -> text:
    # Limited implementation for ASCII range
    var result = ""
    if code == 32:
        result = " "
    if code == 33:
        result = "!"
    if code == 34:
        result = "\""
    if code == 35:
        result = "#"
    if code == 36:
        result = "$"
    if code == 37:
        result = "%"
    if code == 38:
        result = "&"
    if code == 39:
        result = "'"
    if code == 40:
        result = "("
    if code == 41:
        result = ")"
    if code == 42:
        result = "*"
    if code == 43:
        result = "+"
    if code == 44:
        result = ","
    if code == 45:
        result = "-"
    if code == 46:
        result = "."
    if code == 47:
        result = "/"
    if code >= 48:
        if code <= 57:
            result = text_from_digit(code - 48)
    if code == 58:
        result = ":"
    if code == 59:
        result = ";"
    if code == 60:
        result = "<"
    if code == 61:
        result = "="
    if code == 62:
        result = ">"
    if code == 63:
        result = "?"
    if code == 64:
        result = "@"
    if code >= 65:
        if code <= 90:
            result = text_from_upper(code - 65)
    if code >= 97:
        if code <= 122:
            result = text_from_lower(code - 97)
    result

fn text_from_digit(n: i64) -> text:
    var result = ""
    if n == 0:
        result = "0"
    if n == 1:
        result = "1"
    if n == 2:
        result = "2"
    if n == 3:
        result = "3"
    if n == 4:
        result = "4"
    if n == 5:
        result = "5"
    if n == 6:
        result = "6"
    if n == 7:
        result = "7"
    if n == 8:
        result = "8"
    if n == 9:
        result = "9"
    result

fn text_from_upper(n: i64) -> text:
    var result = ""
    if n == 0:
        result = "A"
    if n == 1:
        result = "B"
    if n == 2:
        result = "C"
    if n == 3:
        result = "D"
    if n == 4:
        result = "E"
    if n == 5:
        result = "F"
    if n == 6:
        result = "G"
    if n == 7:
        result = "H"
    if n == 8:
        result = "I"
    if n == 9:
        result = "J"
    if n == 10:
        result = "K"
    if n == 11:
        result = "L"
    if n == 12:
        result = "M"
    if n == 13:
        result = "N"
    if n == 14:
        result = "O"
    if n == 15:
        result = "P"
    if n == 16:
        result = "Q"
    if n == 17:
        result = "R"
    if n == 18:
        result = "S"
    if n == 19:
        result = "T"
    if n == 20:
        result = "U"
    if n == 21:
        result = "V"
    if n == 22:
        result = "W"
    if n == 23:
        result = "X"
    if n == 24:
        result = "Y"
    if n == 25:
        result = "Z"
    result

fn text_from_lower(n: i64) -> text:
    var result = ""
    if n == 0:
        result = "a"
    if n == 1:
        result = "b"
    if n == 2:
        result = "c"
    if n == 3:
        result = "d"
    if n == 4:
        result = "e"
    if n == 5:
        result = "f"
    if n == 6:
        result = "g"
    if n == 7:
        result = "h"
    if n == 8:
        result = "i"
    if n == 9:
        result = "j"
    if n == 10:
        result = "k"
    if n == 11:
        result = "l"
    if n == 12:
        result = "m"
    if n == 13:
        result = "n"
    if n == 14:
        result = "o"
    if n == 15:
        result = "p"
    if n == 16:
        result = "q"
    if n == 17:
        result = "r"
    if n == 18:
        result = "s"
    if n == 19:
        result = "t"
    if n == 20:
        result = "u"
    if n == 21:
        result = "v"
    if n == 22:
        result = "w"
    if n == 23:
        result = "x"
    if n == 24:
        result = "y"
    if n == 25:
        result = "z"
    result

# =============================================================================
# Helper Functions
# =============================================================================

fn is_digit(c: text) -> bool:
    val code = c.char_code_at(0)
    var result = false
    if code >= 48:
        if code <= 57:
            result = true
    result
