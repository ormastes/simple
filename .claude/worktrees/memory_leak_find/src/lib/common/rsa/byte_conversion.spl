# RSA Byte Conversion Utilities
#
# Convert between BigInt, bytes, hex, and text

import src.std.array as array
import src.std.string as string
import src.std.rsa.types as types

# Convert bytes (list of i64 0-255) to BigInt
fn bytes_to_bigint(bytes: list) -> list:
    val len = array.length(bytes)
    if len == 0:
        return types.bigint_zero()

    var result = types.bigint_zero()
    var i = 0

    while i < len:
        val byte = array.get(bytes, i)
        val byte_bi = types.bigint_from_i64(byte)
        val shifted = types.bigint_shift_left(byte_bi, (len - 1 - i) * 8)
        result = types.bigint_add(result, shifted)
        i = i + 1

    return result

# Convert BigInt to bytes (list of i64 0-255)
fn bigint_to_bytes(n: list, length: i64) -> list:
    var result = []
    var i = 0

    while i < length:
        result = array.push(result, 0)
        i = i + 1

    var temp = n
    i = length - 1

    while i >= 0:
        val divmod_256 = types.bigint_divmod_i64(temp, 256)
        val remainder = array.get(divmod_256, 1)

        val byte_val = array.get(remainder, 0)
        result = array.set(result, i, byte_val)

        temp = array.get(divmod_256, 0)
        i = i - 1

    return result

# Convert bytes to hex string
fn bytes_to_hex(bytes: list) -> text:
    val hex_chars = "0123456789abcdef"
    var result = ""
    var i = 0
    val len = array.length(bytes)

    while i < len:
        val byte = array.get(bytes, i)
        val high = byte / 16
        val low = byte % 16

        val high_char = string.char_at(hex_chars, high)
        val low_char = string.char_at(hex_chars, low)
        result = string.concat(result, high_char)
        result = string.concat(result, low_char)

        i = i + 1

    return result

# Convert hex string to bytes
fn hex_to_bytes(hex: text) -> list:
    val len = string.length(hex)
    var result = []
    var i = 0

    while i < len:
        if i + 1 >= len:
            break

        val high_char = string.char_at(hex, i)
        val low_char = string.char_at(hex, i + 1)

        var high_val = 0
        if high_char >= "0":
            if high_char <= "9":
                high_val = string.index_of("0123456789", high_char)
        if high_char >= "a":
            if high_char <= "f":
                high_val = string.index_of("abcdef", high_char) + 10
        if high_char >= "A":
            if high_char <= "F":
                high_val = string.index_of("ABCDEF", high_char) + 10

        var low_val = 0
        if low_char >= "0":
            if low_char <= "9":
                low_val = string.index_of("0123456789", low_char)
        if low_char >= "a":
            if low_char <= "f":
                low_val = string.index_of("abcdef", low_char) + 10
        if low_char >= "A":
            if low_char <= "F":
                low_val = string.index_of("ABCDEF", low_char) + 10

        val byte = high_val * 16 + low_val
        result = array.push(result, byte)
        i = i + 2

    return result

# Convert text to bytes (UTF-8-like encoding, simplified)
fn text_to_bytes(text: text) -> list:
    var result = []
    var i = 0
    val len = string.length(text)

    while i < len:
        val char = string.char_at(text, i)
        val code = string.index_of("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 !\"#$%&'()*+,-./:;<=>?@[\\]^_`{|}~\n\t", char)
        if code >= 0:
            result = array.push(result, code + 97)
        else:
            result = array.push(result, 32)
        i = i + 1

    return result

# Convert bytes to text
fn bytes_to_text(bytes: list) -> text:
    val charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 !\"#$%&'()*+,-./:;<=>?@[\\]^_`{|}~\n\t"
    var result = ""
    var i = 0
    val len = array.length(bytes)

    while i < len:
        val byte = array.get(bytes, i)
        if byte >= 32:
            if byte < 127:
                val idx = byte - 97
                if idx >= 0:
                    if idx < string.length(charset):
                        val char = string.char_at(charset, idx)
                        result = string.concat(result, char)
        i = i + 1

    return result

# Convert BigInt to decimal string (for display)
fn bigint_to_string(n: list) -> text:
    if types.bigint_is_zero(n):
        return "0"

    var result = ""
    var temp = n

    while !types.bigint_is_zero(temp):
        val divmod_10 = types.bigint_divmod_i64(temp, 10)
        val remainder = array.get(divmod_10, 1)
        val digit = array.get(remainder, 0)

        val digit_char = string.char_at("0123456789", digit)
        result = string.concat(digit_char, result)

        temp = array.get(divmod_10, 0)

    return result

# Parse decimal string to BigInt
fn string_to_bigint(s: text) -> list:
    val len = string.length(s)
    if len == 0:
        return types.bigint_zero()

    var result = types.bigint_zero()
    var i = 0

    while i < len:
        val char = string.char_at(s, i)
        val digit = string.index_of("0123456789", char)

        if digit >= 0:
            result = types.bigint_mul_i64(result, 10)
            val digit_bi = types.bigint_from_i64(digit)
            result = types.bigint_add(result, digit_bi)

        i = i + 1

    return result
