# Map Get Operations

fn map_get(map, key: text):
    """Get value for key. Returns nil if key not found.

    Example:
        val m = map_put(map_create(), "x", 10)
        map_get(m, "x")  # 10
        map_get(m, "y")  # nil
    """
    var i = 0
    while i < map.len():
        val entry = map[i]
        if entry[0] == key:
            return entry[1]
        i = i + 1
    nil

fn map_get_or_default(map, key: text, default_value):
    """Get value for key, or return default if not found.

    Example:
        val m = map_put(map_create(), "x", 10)
        map_get_or_default(m, "x", 0)  # 10
        map_get_or_default(m, "y", 0)  # 0
    """
    val result = map_get(map, key)
    if result == nil:
        return default_value
    result

fn map_get_or_compute(map, key: text, compute_fn):
    """Get value for key, or compute and store if not found.

    Returns tuple: (new_map, value)

    Example:
        val m = map_create()
        val result = map_get_or_compute(m, "x", \: 42)
        val new_map = result[0]
        val value = result[1]  # 42
    """
    val existing = map_get(map, key)
    if existing != nil:
        return (map, existing)

    val computed = compute_fn()
    val new_map = map_put(map, key, computed)
    (new_map, computed)

fn map_nested_get(map, keys):
    """Get value from nested map using array of keys.

    Example:
        val inner = map_put(map_create(), "b", 2)
        val outer = map_put(map_create(), "a", inner)
        map_nested_get(outer, ["a", "b"])  # 2
    """
    var current = map
    var i = 0
    while i < keys.len():
        val key = keys[i]
        current = map_get(current, key)
        if current == nil:
            return nil
        i = i + 1
    current

fn map_contains_key(map, key: text) -> bool:
    """Check if map contains the given key.

    Example:
        val m = map_put(map_create(), "x", 10)
        map_contains_key(m, "x")  # true
        map_contains_key(m, "y")  # false
    """
    var i = 0
    while i < map.len():
        val entry = map[i]
        if entry[0] == key:
            return true
        i = i + 1
    false

fn map_contains_value(map, value) -> bool:
    """Check if map contains the given value.

    Example:
        val m = map_put(map_create(), "x", 10)
        map_contains_value(m, 10)  # true
        map_contains_value(m, 20)  # false
    """
    var i = 0
    while i < map.len():
        val entry = map[i]
        if entry[1] == value:
            return true
        i = i + 1
    false

fn map_find(map, predicate):
    """Find first entry matching predicate. Returns tuple or nil.

    Predicate receives (key, value) and returns bool.

    Example:
        val m = map_put(map_put(map_create(), "x", 1), "y", 2)
        map_find(m, \k, v: v > 1)  # ("y", 2)
    """
    var i = 0
    while i < map.len():
        val entry = map[i]
        if predicate(entry[0], entry[1]):
            return entry
        i = i + 1
    nil
