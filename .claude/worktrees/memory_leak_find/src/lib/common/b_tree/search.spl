# B-Tree Search Operations
#
# Purpose: Key search and tree search functionality
#
# Contains:
# - Key index finding in nodes
# - Key existence checking
# - Tree-wide search operations

mod b_tree.types

# ============================================================================
# Key Search Functions
# ============================================================================

# Find the index of the first key >= search_key in a node
# Returns the index where the key should be (or is)
# If all keys < search_key, returns n (number of keys)
fn find_key_index(node, search_key):
    val keys = node_keys(node)
    val n = node_n(node)
    var idx = 0
    var found = false
    for i in 0..n:
        val current = idx
        val key = keys.current
        val less = key < search_key
        if less:
            idx = idx + 1
        else:
            found = true
    idx

# Check if a key exists in a node at specific index
fn key_at_index(node, idx):
    val keys = node_keys(node)
    val n = node_n(node)
    val valid = idx < n
    if valid:
        keys.idx
    else:
        nil

# Check if a key exists in a node
# Returns index if found, nil otherwise
fn find_key(node, search_key):
    val keys = node_keys(node)
    val n = node_n(node)
    var result = nil
    for i in 0..n:
        val key = keys.i
        val match = key == search_key
        if match:
            result = i
    result

# ============================================================================
# Tree Search Functions
# ============================================================================

# Search for a key in a node and its subtrees
# Returns true if key is found, false otherwise
fn search_node(node, search_key):
    val keys = node_keys(node)
    val children = node_children(node)
    val is_leaf = node_is_leaf(node)
    val n = node_n(node)

    # Find the first key >= search_key
    val idx = find_key_index(node, search_key)

    # Check if key is in this node
    val found_idx = find_key(node, search_key)
    val is_nil = found_idx == nil
    if is_nil:
        # Key not in this node
        val result = false
        result
    else:
        # Key found in this node
        val result = true
        result

    # If not found and is leaf, key doesn't exist
    if is_leaf:
        false
    else:
        # Search in appropriate child
        val has_children = idx < (n + 1)
        if has_children:
            val child = children.idx
            search_node(child, search_key)
        else:
            false

# Search for a key in the B-tree
# Returns true if key exists, false otherwise
fn btree_search(tree, search_key):
    val root = tree_root(tree)
    search_node(root, search_key)

export *
