# Red-Black Tree Query Operations
#
# Advanced query operations including range queries, floor, ceiling, and k-th element.

from .types import tree_root, tree_nil
from .types import node_value, node_left, node_right
from .types import is_nil_node

# ============================================================================
# RANGE QUERIES
# ============================================================================

# Find all values in range [min, max]
fn range_query(tree, min, max):
    val root = tree_root(tree)
    val nil_sentinel = tree_nil(tree)
    var result = []
    range_query_helper(root, min, max, nil_sentinel, result)

# Range query helper
fn range_query_helper(node, min, max, nil_sentinel, result):
    if is_nil_node(node, nil_sentinel):
        result
    else:
        val value = node_value(node)
        var new_result = result

        # Search left if value > min
        if value > min:
            val left = node_left(node)
            new_result = range_query_helper(left, min, max, nil_sentinel, new_result)
        else:
            ()

        # Include value if in range
        if value >= min:
            if value <= max:
                new_result = new_result + [value]
            else:
                ()
        else:
            ()

        # Search right if value < max
        if value < max:
            val right = node_right(node)
            new_result = range_query_helper(right, min, max, nil_sentinel, new_result)
        else:
            ()

        new_result

# Count values in range [min, max]
fn count_range(tree, min, max):
    val values = range_query(tree, min, max)
    values.len

# ============================================================================
# ADVANCED QUERIES
# ============================================================================

# Find largest value <= target (floor)
fn floor(tree, value):
    val root = tree_root(tree)
    val nil_sentinel = tree_nil(tree)
    floor_helper(root, value, nil_sentinel, nil)

# Floor helper
fn floor_helper(node, value, nil_sentinel, best):
    if is_nil_node(node, nil_sentinel):
        best
    else:
        val node_val = node_value(node)

        if node_val == value:
            node_val
        else:
            if node_val < value:
                # This could be floor, search right for better
                val right = node_right(node)
                floor_helper(right, value, nil_sentinel, node_val)
            else:
                # Node value too large, search left
                val left = node_left(node)
                floor_helper(left, value, nil_sentinel, best)

# Find smallest value >= target (ceiling)
fn ceiling(tree, value):
    val root = tree_root(tree)
    val nil_sentinel = tree_nil(tree)
    ceiling_helper(root, value, nil_sentinel, nil)

# Ceiling helper
fn ceiling_helper(node, value, nil_sentinel, best):
    if is_nil_node(node, nil_sentinel):
        best
    else:
        val node_val = node_value(node)

        if node_val == value:
            node_val
        else:
            if node_val > value:
                # This could be ceiling, search left for better
                val left = node_left(node)
                ceiling_helper(left, value, nil_sentinel, node_val)
            else:
                # Node value too small, search right
                val right = node_right(node)
                ceiling_helper(right, value, nil_sentinel, best)

# Find k-th smallest element (1-indexed)
fn kth_smallest(tree, k):
    val root = tree_root(tree)
    val nil_sentinel = tree_nil(tree)
    kth_smallest_helper(root, k, nil_sentinel)

# K-th smallest helper
fn kth_smallest_helper(node, k, nil_sentinel):
    if is_nil_node(node, nil_sentinel):
        nil
    else:
        val left = node_left(node)
        val left_size = count_nodes(left, nil_sentinel)

        if k == left_size + 1:
            node_value(node)
        else:
            if k <= left_size:
                kth_smallest_helper(left, k, nil_sentinel)
            else:
                val right = node_right(node)
                kth_smallest_helper(right, k - left_size - 1, nil_sentinel)

# Count nodes in subtree
fn count_nodes(node, nil_sentinel):
    if is_nil_node(node, nil_sentinel):
        0
    else:
        val left = node_left(node)
        val right = node_right(node)
        val left_count = count_nodes(left, nil_sentinel)
        val right_count = count_nodes(right, nil_sentinel)
        left_count + right_count + 1

# Count values less than target
fn count_less_than(tree, value):
    val root = tree_root(tree)
    val nil_sentinel = tree_nil(tree)
    count_less_than_helper(root, value, nil_sentinel)

# Count less than helper
fn count_less_than_helper(node, value, nil_sentinel):
    if is_nil_node(node, nil_sentinel):
        0
    else:
        val node_val = node_value(node)

        if node_val >= value:
            # Count only left subtree
            val left = node_left(node)
            count_less_than_helper(left, value, nil_sentinel)
        else:
            # Count left subtree + this node + part of right
            val left = node_left(node)
            val right = node_right(node)
            val left_count = count_nodes(left, nil_sentinel)
            val right_count = count_less_than_helper(right, value, nil_sentinel)
            left_count + 1 + right_count
