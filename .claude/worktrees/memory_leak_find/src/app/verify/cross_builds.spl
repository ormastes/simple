# Simple (.spl) replacement for scripts/verify-cross-builds.sh
#
# Verify cross-compiled binaries for all target platforms.
#
# Usage:
#   bin/simple run src/app/verify/cross_builds.spl [--quick] [--targets=linux-arm64,windows-x86]
#
# Checks:
#   1. Binary exists and has correct file format (ELF/PE/Mach-O)
#   2. QEMU smoke test for Linux ARM64/RISC-V
#   3. Wine smoke test for Windows targets

use app.io.mod.{shell, shell_bool, shell_output, cwd, file_exists, get_args, exit}
use std.text.{contains, starts_with, trim, split, replace}
use std.path.{join}

val ALL_TARGETS = "linux-x86_64 linux-arm64 linux-riscv64 windows-x86_64 windows-x86 freebsd-x86_64 freebsd-x86 macos-arm64"

fn get_target_config(target: text, build_dir: text, release_dir: text):
    # Returns [seed_bin, full_bin, expect_seed, expect_full, qemu_cmd]
    if target == "linux-x86_64":
        return [join(build_dir, "seed"), join(release_dir, "simple"), "ELF 64-bit.*x86-64", "ELF 64-bit.*x86-64", ""]
    else if target == "linux-arm64":
        return [join(build_dir, "seed"), join(release_dir, "simple"), "ELF 64-bit.*ARM aarch64", "ELF 64-bit.*ARM aarch64", "qemu-aarch64 -L /usr/aarch64-linux-gnu"]
    else if target == "linux-riscv64":
        return [join(build_dir, "seed"), join(release_dir, "simple"), "ELF 64-bit.*RISC-V", "ELF 64-bit.*RISC-V", "qemu-riscv64 -L /usr/riscv64-linux-gnu"]
    else if target == "windows-x86_64":
        return [join(build_dir, "seed.exe"), join(release_dir, "simple.exe"), "PE32\\+.*x86-64", "PE32\\+.*x86-64", ""]
    else if target == "windows-x86":
        return [join(build_dir, "seed.exe"), join(release_dir, "simple.exe"), "PE32 .*Intel 80386", "PE32 .*Intel 80386", ""]
    else if target == "freebsd-x86_64":
        return [join(build_dir, "seed"), join(release_dir, "simple"), "ELF 64-bit.*x86-64.*FreeBSD", "ELF 64-bit.*x86-64.*FreeBSD", ""]
    else if target == "freebsd-x86":
        return [join(build_dir, "seed"), join(release_dir, "simple"), "ELF 32-bit.*Intel 80386.*FreeBSD", "ELF 32-bit.*Intel 80386.*FreeBSD", ""]
    else if target == "macos-arm64":
        return [join(build_dir, "seed"), join(release_dir, "simple"), "Mach-O 64-bit.*arm64", "Mach-O 64-bit.*arm64", ""]
    else:
        return ["", "", "", "", ""]

fn verify_target(target: text, project_dir: text, quick: bool):
    # Returns true on success, false on failure
    val build_dir = join(project_dir, "build/{target}")
    val release_dir = join(project_dir, "bin/release/{target}")

    print "--- {target} ---"

    val config = get_target_config(target, build_dir, release_dir)
    val seed_bin = config[0]
    val full_bin = config[1]
    val expect_seed = config[2]
    val expect_full = config[3]
    val qemu_cmd = config[4]

    if seed_bin == "":
        print "  SKIP (unknown target)"
        return true

    # Check seed binary
    if file_exists(seed_bin):
        val file_info = trim(shell_output("file {seed_bin}"))
        val grep_result = shell("echo '{file_info}' | grep -qP '{expect_seed}'")
        if grep_result.exit_code == 0:
            print "  seed:    OK ({file_info})"
        else:
            print "  seed:    WRONG FORMAT ({file_info})"
            print "           Expected: {expect_seed}"
            return false
    else:
        print "  seed:    MISSING ({seed_bin})"

    # Check full compiler binary
    if file_exists(full_bin):
        val file_info = trim(shell_output("file {full_bin}"))
        val grep_result = shell("echo '{file_info}' | grep -qP '{expect_full}'")
        if grep_result.exit_code == 0:
            val size = trim(shell_output("wc -c < {full_bin}"))
            print "  simple:  OK ({size} bytes)"
        else:
            print "  simple:  WRONG FORMAT ({file_info})"
            print "           Expected: {expect_full}"
            return false
    else:
        print "  simple:  NOT BUILT (run cross_compile.spl first)"

    # QEMU smoke test (only if not quick mode and QEMU available)
    if (not quick and
        qemu_cmd != "" and
        file_exists(seed_bin)):
        val qemu_parts = split(qemu_cmd, " ")
        val qemu_bin = qemu_parts[0]
        val has_qemu = shell_bool("command -v {qemu_bin}")
        if has_qemu:
            val qemu_test = shell("timeout 10 {qemu_cmd} {seed_bin} --help 2>/dev/null")
            if qemu_test.exit_code == 0:
                print "  qemu:    OK (seed runs under QEMU)"
            else:
                print "  qemu:    FAIL or no --help support"
        else:
            print "  qemu:    SKIP (QEMU not installed)"

    # Wine test for Windows
    if (not quick and
        starts_with(target, "windows-") and
        file_exists(seed_bin)):
        val has_wine = shell_bool("command -v wine")
        if has_wine:
            val wine_test = shell("timeout 10 wine {seed_bin} --help 2>/dev/null")
            if wine_test.exit_code == 0:
                print "  wine:    OK (seed runs under Wine)"
            else:
                print "  wine:    FAIL or no --help support"
        else:
            print "  wine:    SKIP (Wine not installed)"

    return true

fn main():
    val project_dir = cwd()
    val args = get_args()

    var quick = false
    var targets_str = ""

    for arg in args:
        if arg == "--quick":
            quick = true
        else if starts_with(arg, "--targets="):
            var t = arg
            t = replace(t, "--targets=", "")
            targets_str = t

    if targets_str == "":
        targets_str = ALL_TARGETS
    else:
        targets_str = replace(targets_str, ",", " ")

    print "====================================="
    print "  Cross-Build Verification"
    print "====================================="
    print ""

    var pass_count = 0
    var fail_count = 0

    val targets = split(targets_str, " ")
    for target in targets:
        if target == "":
            pass_dn
        else:
            val ok = verify_target(target, project_dir, quick)
            if ok:
                pass_count = pass_count + 1
            else:
                fail_count = fail_count + 1
            print ""

    print "====================================="
    print "  Verification: {pass_count} pass, {fail_count} fail"
    print "====================================="

    exit(fail_count)

main()
