# Diagnostic Tools Handler - Loaded on-demand
#
# Handles: simple_read, simple_check, simple_symbols, simple_status,
#          simple_expand_at, simple_edit, simple_multi_edit, simple_run,
#          simple_diff, simple_log, simple_squash, simple_new
#
# This script is invoked as a subprocess, so imports only load when needed.

use std.mcp.helpers.{make_error_response}
use app.mcp.diag_read_tools.{handle_simple_read, handle_simple_check, handle_simple_symbols, handle_simple_status, handle_expand_at}
use app.mcp.diag_edit_tools.{handle_simple_edit, handle_simple_multi_edit, handle_simple_run}
use app.mcp.diag_vcs_tools.{handle_simple_diff, handle_simple_log, handle_simple_squash, handle_simple_new}

extern fn rt_cli_get_args() -> [text]

val args = rt_cli_get_args()
if args.len() < 4:
    print "ERROR: Usage: diag_handler.spl <tool_name> <id> <request_body>"
else:
    val tool_name = args[1]
    val id = args[2]
    val body = args[3]

    var response = ""
    if tool_name == "simple_read":
        response = handle_simple_read(id, body)
    elif tool_name == "simple_check":
        response = handle_simple_check(id, body)
    elif tool_name == "simple_symbols":
        response = handle_simple_symbols(id, body)
    elif tool_name == "simple_status":
        response = handle_simple_status(id, body)
    elif tool_name == "simple_expand_at":
        response = handle_expand_at(id, body)
    elif tool_name == "simple_edit":
        response = handle_simple_edit(id, body)
    elif tool_name == "simple_multi_edit":
        response = handle_simple_multi_edit(id, body)
    elif tool_name == "simple_run":
        response = handle_simple_run(id, body)
    elif tool_name == "simple_diff":
        response = handle_simple_diff(id, body)
    elif tool_name == "simple_log":
        response = handle_simple_log(id, body)
    elif tool_name == "simple_squash":
        response = handle_simple_squash(id, body)
    elif tool_name == "simple_new":
        response = handle_simple_new(id, body)
    else:
        response = make_error_response(id, -32601, "Unknown tool: " + tool_name)

    print_raw(response)
