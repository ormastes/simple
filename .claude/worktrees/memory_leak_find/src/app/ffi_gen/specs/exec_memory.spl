# Executable Memory Allocation FFI
#
# Provides allocation of executable memory regions for JIT-compiled code.
# Used by JitInstantiator for load-time template instantiation.
#
# Architecture:
# - Allocate RWX (read-write-execute) memory pages
# - Copy compiled code to executable memory
# - Execute code via function pointers
# - Proper cleanup and deallocation
#
# Security Note:
# RWX pages are a security risk. In production, use W^X (write-xor-execute):
# 1. Allocate RW pages
# 2. Write code
# 3. Change protection to RX (no write)
#
# Current implementation uses RWX for simplicity during development.

# ============================================================================
# Executable Memory Allocation
# ============================================================================

## Allocate executable memory region
##
## Allocates memory with RWX permissions (read-write-execute).
## Memory is page-aligned and zero-initialized.
##
## Args:
##   size: Size in bytes (will be rounded up to page size)
##
## Returns:
##   Pointer to executable memory region, or 0 on error
extern fn rt_alloc_exec_memory(size: i64) -> i64

## Free executable memory region
##
## Frees memory allocated by rt_alloc_exec_memory.
##
## Args:
##   address: Pointer returned from rt_alloc_exec_memory
##   size: Size that was allocated (must match original size)
##
## Returns:
##   true on success, false on error
extern fn rt_free_exec_memory(address: i64, size: i64) -> bool

## Copy code to executable memory
##
## Copies compiled code bytes to executable memory region.
## Handles page alignment and size restrictions.
##
## Args:
##   address: Pointer to executable memory (from rt_alloc_exec_memory)
##   code: Byte array containing compiled code
##   offset: Offset within executable memory to start writing
##
## Returns:
##   Number of bytes written, or -1 on error
extern fn rt_write_exec_memory(address: i64, code: [u8], offset: i64) -> i64

## Make memory executable (change protection from RW to RX)
##
## Changes protection from read-write to read-execute.
## Use this for W^X security (write-xor-execute).
##
## Workflow:
##   1. Allocate RW memory with rt_alloc_rw_memory()
##   2. Write code with rt_write_exec_memory()
##   3. Make executable with rt_make_executable()
##
## Args:
##   address: Pointer to memory region
##   size: Size of region
##
## Returns:
##   true on success, false on error
extern fn rt_make_executable(address: i64, size: i64) -> bool

## Allocate read-write memory (non-executable)
##
## Allocates memory with RW permissions (read-write only).
## Use with rt_make_executable() for W^X security.
##
## Args:
##   size: Size in bytes (will be rounded up to page size)
##
## Returns:
##   Pointer to memory region, or 0 on error
extern fn rt_alloc_rw_memory(size: i64) -> i64

## Flush instruction cache (required after writing code)
##
## Flushes CPU instruction cache to ensure newly written code is visible.
## Required on ARM/RISC-V architectures.
## No-op on x86/x64 (hardware cache coherence).
##
## Args:
##   address: Pointer to code region
##   size: Size of code region
extern fn rt_flush_icache(address: i64, size: i64)

# ============================================================================
# Function Pointer Utilities
# ============================================================================

## Get function pointer from executable memory
##
## Returns a function pointer suitable for calling compiled code.
## The returned pointer can be cast to the appropriate function type.
##
## Args:
##   address: Pointer to executable memory containing function code
##
## Returns:
##   Function pointer (same as address, but semantically different)
extern fn rt_get_function_pointer(address: i64) -> i64

## Call function with no arguments
##
## Calls a JIT-compiled function that takes no arguments.
## Use for testing or simple entry points.
##
## Args:
##   fn_ptr: Function pointer from rt_get_function_pointer
##
## Returns:
##   Return value from function (as i64)
extern fn rt_call_function_0(fn_ptr: i64) -> i64

## Call function with one argument
##
## Args:
##   fn_ptr: Function pointer
##   arg1: First argument (as i64)
##
## Returns:
##   Return value from function (as i64)
extern fn rt_call_function_1(fn_ptr: i64, arg1: i64) -> i64

## Call function with two arguments
##
## Args:
##   fn_ptr: Function pointer
##   arg1: First argument
##   arg2: Second argument
##
## Returns:
##   Return value from function (as i64)
extern fn rt_call_function_2(fn_ptr: i64, arg1: i64, arg2: i64) -> i64

# ============================================================================
# Memory Protection Utilities
# ============================================================================

## Check if memory region is executable
##
## Tests if a memory region has execute permission.
##
## Args:
##   address: Pointer to memory region
##
## Returns:
##   true if executable, false otherwise
extern fn rt_is_executable(address: i64) -> bool

## Get current protection flags for memory region
##
## Returns protection flags (PROT_READ, PROT_WRITE, PROT_EXEC bitwise OR).
##
## Args:
##   address: Pointer to memory region
##
## Returns:
##   Protection flags, or -1 on error
extern fn rt_get_protection(address: i64) -> i32

## Change protection flags for memory region
##
## Changes memory protection (e.g., from RW to RX for W^X).
##
## Args:
##   address: Pointer to memory region
##   size: Size of region
##   prot: New protection flags (PROT_READ | PROT_WRITE | PROT_EXEC)
##
## Returns:
##   true on success, false on error
extern fn rt_set_protection(address: i64, size: i64, prot: i32) -> bool

# ============================================================================
# Statistics and Debugging
# ============================================================================

## Get total executable memory allocated
##
## Returns sum of all executable memory allocations.
##
## Returns:
##   Total bytes of executable memory allocated
extern fn rt_exec_memory_total() -> i64

## Get number of executable memory allocations
##
## Returns count of active executable memory regions.
##
## Returns:
##   Number of active allocations
extern fn rt_exec_memory_count() -> i64

## Dump executable memory statistics (for debugging)
##
## Prints executable memory statistics to stderr.
## Includes: total allocated, number of regions, addresses, sizes.
extern fn rt_exec_memory_dump_stats()

# ============================================================================
# FFI Generation Metadata
# ============================================================================

# @ffi-gen-target: build/rust/ffi_gen/src/exec_memory.rs
# @ffi-gen-impl: mmap/mprotect for executable memory (libc bindings)
# @ffi-gen-test: test/ffi/exec_memory_spec.spl
# @ffi-gen-deps: libc (mmap, mprotect, munmap)
