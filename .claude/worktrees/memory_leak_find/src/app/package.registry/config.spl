# Registry Configuration
# URL configuration and defaults for the GHCR-based registry

use app.package.registry.types (RegistryConfig)

use app.io.mod (home)

# Default registry settings
val DEFAULT_REGISTRY_URL = "ghcr.io/simple-lang"
val DEFAULT_INDEX_URL = "https://raw.githubusercontent.com/simple-lang/registry/main"
val DEFAULT_INDEX_REPO = "simple-lang/registry"

fn default_config() -> RegistryConfig:
    val home = home()
    RegistryConfig(
        registry_url: DEFAULT_REGISTRY_URL,
        index_url: DEFAULT_INDEX_URL,
        cache_dir: "{home}/.simple/cache/registry",
        credentials_path: "{home}/.simple/credentials.sdn"
    )

fn config_with_overrides(registry_url: text, index_url: text) -> RegistryConfig:
    val base = default_config()
    val reg = if registry_url != "": registry_url else: base.registry_url
    val idx = if index_url != "": index_url else: base.index_url
    RegistryConfig(
        registry_url: reg,
        index_url: idx,
        cache_dir: base.cache_dir,
        credentials_path: base.credentials_path
    )

# Compute sparse index path for a package name
fn index_path_for(name: text) -> text:
    val len = name.len()
    if len == 1:
        "_/{name}/{name}.sdn"
    elif len == 2:
        "{name[0:1]}/{name[1:2]}/{name}.sdn"
    elif len == 3:
        "{name[0:2]}/{name[2:3]}/{name}.sdn"
    else:
        "{name[0:2]}/{name[2:4]}/{name}.sdn"

# Full URL to fetch an index entry
fn index_entry_url(config: RegistryConfig, name: text) -> text:
    val path = index_path_for(name)
    "{config.index_url}/index/{path}"

# Full URL to the package listing
fn listing_url(config: RegistryConfig) -> text:
    "{config.index_url}/index/_listing.sdn"

# OCI reference for a specific package version
fn oci_ref_for(config: RegistryConfig, name: text, version: text) -> text:
    "{config.registry_url}/{name}:{version}"
