# Package Uninstallation Logic

use app.ioimport std.env
use std.log.{info}

class PackageUninstall:
    static fn run(args: [text]):
        var purge = false

        for arg in args:
            if arg == "--purge":
                purge = true

        val paths = PackagePaths.from_args(args)

        # Check if package is installed
        if not file_exists(paths.manifest_path()):
            info("package", "No package installation found at {paths.prefix}")
            return

        # Read manifest
        val manifest = PackageManifest.from_file(paths.manifest_path())

        info("package", "Uninstalling {manifest.name} v{manifest.version}")
        info("package", "Install prefix: {paths.prefix}")
        print ""

        # Remove symlinks
        info("package", "Removing symlinks...")
        val symlink = paths.bin_dir() + "/simple"
        if file_exists(symlink):
            file_delete(symlink)
            info("package", "  Removed: {symlink}")

        # Remove runtime
        info("package", "Removing runtime...")
        if file_exists(paths.runtime_path()):
            file_delete(paths.runtime_path())
            info("package", "  Removed: {paths.runtime_path()}")

        # Remove stdlib
        info("package", "Removing stdlib...")
        if file_exists(paths.stdlib_dir()):
            dir_remove_all(paths.stdlib_dir())
            info("package", "  Removed: {paths.stdlib_dir()}")

        # Remove apps
        info("package", "Removing apps...")
        if file_exists(paths.app_dir()):
            dir_remove_all(paths.app_dir())
            info("package", "  Removed: {paths.app_dir()}")

        # Remove manifest
        if file_exists(paths.manifest_path()):
            file_delete(paths.manifest_path())

        # Remove lib/simple directory if empty
        if fs.is_empty_dir(paths.lib_dir()):
            dir_remove(paths.lib_dir())

        # Purge config and cache if requested
        if purge:
            info("package", "Purging configuration and cache...")

            if file_exists(paths.config_dir()):
                dir_remove_all(paths.config_dir())
                info("package", "  Removed: {paths.config_dir()}")

            if file_exists(paths.cache_dir()):
                dir_remove_all(paths.cache_dir())
                info("package", "  Removed: {paths.cache_dir()}")

        print ""
        info("package", "Uninstallation complete.")
        print ""
        info("package", "You may need to remove {paths.bin_dir()} from your PATH")
