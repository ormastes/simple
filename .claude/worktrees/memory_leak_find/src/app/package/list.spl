# List Installed Packages

use app.io
use std.log.{info}

class PackageList:
    static fn run(args: [text]):
        val paths = PackagePaths.from_args(args)

        # Check if package is installed
        if not file_exists(paths.manifest_path()):
            info("package", "No packages installed at {paths.prefix}")
            return

        # Read manifest
        val manifest = PackageManifest.from_file(paths.manifest_path())

        print "Installed Packages:"
        print ""
        print "  Name:     {manifest.name}"
        print "  Version:  {manifest.version}"
        print "  Type:     {manifest.package_type}"
        print "  Platform: {manifest.platform}"
        print "  Prefix:   {paths.prefix}"
        print ""

        print "Build Information:"
        print "  Profile:   {manifest.build_profile}"
        print "  Timestamp: {manifest.build_timestamp}"
        print "  Commit:    {manifest.build_commit}"
        print ""

        print "Runtime:"
        print "  Binary:   {manifest.runtime_binary}"
        print "  Size:     {format_size(manifest.runtime_size)}"
        print "  Path:     {paths.runtime_path()}"
        print ""

        print "Contents:"
        print "  Stdlib files: {manifest.stdlib_files.length}"
        print "  Apps:         {manifest.app_dirs.length}"

fn format_size(bytes: i64) -> text:
    if bytes < 1024:
        return "{bytes} B"
    else if bytes < 1024 * 1024:
        val kb = bytes / 1024
        return "{kb} KB"
    else if bytes < 1024 * 1024 * 1024:
        val mb = bytes / (1024 * 1024)
        return "{mb} MB"
    else:
        val gb = bytes / (1024 * 1024 * 1024)
        return "{gb} GB"
