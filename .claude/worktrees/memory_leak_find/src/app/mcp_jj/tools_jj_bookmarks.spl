# tools_jj_bookmarks.spl - Bookmark management tools (6 tools)
#
# Tools: bookmark_create, bookmark_delete, bookmark_list, bookmark_move, bookmark_set, bookmark_rename

use app.mcp_jj.helpers.{LB, RB, Q, jp, js, jo1, jo2, jo3, escape_json, make_tool_result, make_error_response, make_tool_schema_multi, make_tool_schema, make_no_param_tool, make_prop, make_prop_bool, make_prop_int, extract_nested_string, extract_arguments_dict, handle_jj_result, handle_jj_result_stdout}
use app.mcp_jj.jj_runner.{JjResult, jj_run, jj_run_with_args, shell_quote}

# --- 25. jj_bookmark_create ---

fn schema_jj_bookmark_create() -> String:
    var props = LB()
    props = props + make_prop("name", "Name of the bookmark to create")
    props = props + "," + make_prop("revision", "Revision to point the bookmark at (default: @)")
    props = props + RB()
    make_tool_schema_multi("jj_bookmark_create", "Create a new bookmark at a revision", props, "[" + js("name") + "]", false, false, false)

fn handle_jj_bookmark_create(id: String, body: String, repo_path: String) -> String:
    val name = extract_nested_string(body, "arguments", "name")
    val revision = extract_nested_string(body, "arguments", "revision")
    if name == "":
        return make_error_response(id, -32602, "Missing required parameter: name")
    var cmd = "bookmark create " + name
    if revision != "":
        cmd = cmd + " -r " + revision
    handle_jj_result(id, jj_run(cmd, repo_path))

# --- 26. jj_bookmark_delete ---

fn schema_jj_bookmark_delete() -> String:
    make_tool_schema("jj_bookmark_delete", "Delete a bookmark", "name", "Name of the bookmark to delete", true, false, true, false)

fn handle_jj_bookmark_delete(id: String, body: String, repo_path: String) -> String:
    val name = extract_nested_string(body, "arguments", "name")
    if name == "":
        return make_error_response(id, -32602, "Missing required parameter: name")
    var cmd = "bookmark delete " + name
    handle_jj_result(id, jj_run(cmd, repo_path))

# --- 27. jj_bookmark_list ---

fn schema_jj_bookmark_list() -> String:
    var props = LB()
    props = props + make_prop_bool("all_remotes", "Show bookmarks from all remotes")
    props = props + RB()
    make_tool_schema_multi("jj_bookmark_list", "List all bookmarks", props, "[]", true, false, true)

fn handle_jj_bookmark_list(id: String, body: String, repo_path: String) -> String:
    val all_remotes = extract_nested_string(body, "arguments", "all_remotes")
    var cmd = "bookmark list"
    if all_remotes == "true":
        cmd = cmd + " --all-remotes"
    handle_jj_result_stdout(id, jj_run(cmd, repo_path))

# --- 28. jj_bookmark_move ---

fn schema_jj_bookmark_move() -> String:
    var props = LB()
    props = props + make_prop("name", "Name of the bookmark to move")
    props = props + "," + make_prop("to", "Destination revision (default: @)")
    props = props + RB()
    make_tool_schema_multi("jj_bookmark_move", "Move a bookmark to a different revision", props, "[" + js("name") + "]", false, false, false)

fn handle_jj_bookmark_move(id: String, body: String, repo_path: String) -> String:
    val name = extract_nested_string(body, "arguments", "name")
    val to = extract_nested_string(body, "arguments", "to")
    if name == "":
        return make_error_response(id, -32602, "Missing required parameter: name")
    var cmd = "bookmark move " + name
    if to != "":
        cmd = cmd + " --to " + to
    handle_jj_result(id, jj_run(cmd, repo_path))

# --- 29. jj_bookmark_set ---

fn schema_jj_bookmark_set() -> String:
    var props = LB()
    props = props + make_prop("name", "Name of the bookmark to set")
    props = props + "," + make_prop("revision", "Revision to point the bookmark at (default: @)")
    props = props + RB()
    make_tool_schema_multi("jj_bookmark_set", "Set a bookmark to a specific revision, creating if needed", props, "[" + js("name") + "]", false, false, true)

fn handle_jj_bookmark_set(id: String, body: String, repo_path: String) -> String:
    val name = extract_nested_string(body, "arguments", "name")
    val revision = extract_nested_string(body, "arguments", "revision")
    if name == "":
        return make_error_response(id, -32602, "Missing required parameter: name")
    var cmd = "bookmark set " + name
    if revision != "":
        cmd = cmd + " -r " + revision
    handle_jj_result(id, jj_run(cmd, repo_path))

# --- 30. jj_bookmark_rename ---

fn schema_jj_bookmark_rename() -> String:
    var props = LB()
    props = props + make_prop("old_name", "Current name of the bookmark")
    props = props + "," + make_prop("new_name", "New name for the bookmark")
    props = props + RB()
    make_tool_schema_multi("jj_bookmark_rename", "Rename a bookmark", props, "[" + js("old_name") + "," + js("new_name") + "]", false, false, false)

fn handle_jj_bookmark_rename(id: String, body: String, repo_path: String) -> String:
    val old_name = extract_nested_string(body, "arguments", "old_name")
    val new_name = extract_nested_string(body, "arguments", "new_name")
    if old_name == "":
        return make_error_response(id, -32602, "Missing required parameter: old_name")
    if new_name == "":
        return make_error_response(id, -32602, "Missing required parameter: new_name")
    var cmd = "bookmark rename " + old_name + " " + new_name
    handle_jj_result(id, jj_run(cmd, repo_path))

export schema_jj_bookmark_create, schema_jj_bookmark_delete, schema_jj_bookmark_list
export schema_jj_bookmark_move, schema_jj_bookmark_set, schema_jj_bookmark_rename
export handle_jj_bookmark_create, handle_jj_bookmark_delete, handle_jj_bookmark_list
export handle_jj_bookmark_move, handle_jj_bookmark_set, handle_jj_bookmark_rename
