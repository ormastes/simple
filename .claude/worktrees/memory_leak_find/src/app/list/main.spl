# Simple CLI - list command
# Lists installed dependencies from manifest and lockfile

use std.cli.cli_util (get_cli_args)
use app.io.mod (file_exists, file_read, cwd)

fn print_help():
    print "Usage: simple list [options]"
    print ""
    print "List project dependencies."
    print ""
    print "Options:"
    print "  --json       Output as JSON"
    print "  --installed  Show only installed packages"
    print "  -h, --help   Show this help"

fn find_manifest_path() -> text:
    val current_dir = cwd()
    val sdn_path = "{current_dir}/simple.sdn"
    val toml_path = "{current_dir}/simple.toml"
    if file_exists(sdn_path):
        return sdn_path
    if file_exists(toml_path):
        return toml_path
    ""

fn parse_deps_section(content: text, section: text) -> [text]:
    val lines = content.split("\n")
    var deps = []
    var in_section = false

    for line in lines:
        val trimmed = line.trim()
        if trimmed == "{section}:":
            in_section = true
        elif in_section:
            if trimmed == "" or (not line.starts_with("  ") and not line.starts_with("\t")):
                in_section = false
            else:
                val parts = trimmed.split(":")
                if parts.len() > 0:
                    val name = parts[0].trim()
                    if name != "":
                        deps.push(name)
    deps

fn main() -> i64:
    val args = get_cli_args()

    var as_json = false
    var installed_only = false

    for arg in args:
        if arg == "-h" or arg == "--help":
            print_help()
            return 0
        elif arg == "--json":
            as_json = true
        elif arg == "--installed":
            installed_only = true

    val manifest_path = find_manifest_path()
    if manifest_path == "":
        print "list: no simple.sdn or simple.toml found in current directory"
        return 1
    val content = file_read(manifest_path)
    val deps = parse_deps_section(content, "dependencies")
    val dev_deps = parse_deps_section(content, "dev_dependencies")

    val current_dir = cwd()
    val modules_dir = "{current_dir}/simple_modules"

    if as_json:
        print "\"dependencies\":"
        var i = 0
        for name in deps:
            var comma = ""
            if i < deps.len() - 1:
                comma = ","
            print "    \"{name}\": \"*\"{comma}"
            i = i + 1
        print "\"dev_dependencies\":"
        var j = 0
        for name in dev_deps:
            var comma = ""
            if j < dev_deps.len() - 1:
                comma = ","
            print "    \"{name}\": \"*\"{comma}"
            j = j + 1
        return 0

    # Parse project name/version from manifest
    var project_name = "unknown"
    var project_version = "0.0.0"
    val lines = content.split("\n")
    for line in lines:
        val trimmed = line.trim()
        if trimmed.starts_with("name:"):
            project_name = trimmed[5:].trim()
        elif trimmed.starts_with("version:"):
            project_version = trimmed[8:].trim()

    print "{project_name} v{project_version}"
    print ""

    if deps.len() == 0 and dev_deps.len() == 0:
        print "No dependencies."
        return 0

    if deps.len() > 0:
        print "Dependencies ({deps.len()}):"
        for name in deps:
            var status = ""
            if file_exists("{modules_dir}/{name}/__init__.spl"):
                status = " (installed)"
            if not installed_only or status != "":
                print "  {name}: *{status}"

    if dev_deps.len() > 0:
        print ""
        print "Dev Dependencies ({dev_deps.len()}):"
        for name in dev_deps:
            var status = ""
            if file_exists("{modules_dir}/{name}/__init__.spl"):
                status = " (installed)"
            if not installed_only or status != "":
                print "  {name}: *{status}"

    0
