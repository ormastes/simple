# Unary Operators
#
# Handles all unary prefix operators including negation, logical not,
# bitwise not, references, dereference, move, await, and yield.

from token import {TokenKind}
from ast import {Expr, UnaryOp}

impl Parser:

    fn parse_unary() -> Expr:
        match self.current.kind:
            TokenKind.Minus:
                self.advance()
                val operand = self.parse_unary()
                Expr.Unary(op: UnaryOp.Neg, operand: operand)
            TokenKind.Not:
                self.advance()
                val operand = self.parse_unary()
                Expr.Unary(op: UnaryOp.Not, operand: operand)
            TokenKind.Tilde:
                self.advance()
                val operand = self.parse_unary()
                Expr.Unary(op: UnaryOp.BitNot, operand: operand)
            TokenKind.Ampersand:
                self.advance()
                if self.check(TokenKind.Mut):
                    self.advance()
                    val operand = self.parse_unary()
                    Expr.Unary(op: UnaryOp.RefMut, operand: operand)
                else:
                    val operand = self.parse_unary()
                    Expr.Unary(op: UnaryOp.Ref, operand: operand)
            TokenKind.Star:
                self.advance()
                val operand = self.parse_unary()
                Expr.Unary(op: UnaryOp.Deref, operand: operand)
            TokenKind.ChannelArrow:
                self.advance()
                val operand = self.parse_unary()
                Expr.Unary(op: UnaryOp.ChannelRecv, operand: operand)
            TokenKind.Move:
                self.advance()
                val operand = self.parse_unary()
                Expr.Unary(op: UnaryOp.Move, operand: operand)
            TokenKind.Await:
                self.advance()
                val operand = self.parse_unary()
                Expr.Await(operand)
            TokenKind.Yield:
                self.advance()
                if self.is_at_end() or match self.current.kind:
                    TokenKind.Newline: true
                    TokenKind.Dedent: true
                    TokenKind.RParen: true
                    TokenKind.RBrace: true
                    TokenKind.Comma: true
                    _: false:
                    Expr.Yield(nil)
                else:
                    val operand = self.parse_expression()
                    Expr.Yield(operand)
            _:
                self.parse_postfix()
