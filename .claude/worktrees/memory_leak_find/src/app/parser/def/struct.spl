# Definition Parser - Struct Definitions
#
# Parsing for struct definitions:
# - struct Name<T>: fields...
# - Optional trait implementation syntax
# - Fields and methods

from token import {Span, TokenKind}
from ast import {Node, StructDef, DocComment, Visibility, Attribute}
from error import {ParseError}

export StructParser

# ============================================================================
# Struct
# ============================================================================

# Parse struct definition: struct Name<T>: fields...
fn parse_struct(self) -> Result<Node, ParseError>:
    self.parse_struct_with_attrs([])

fn parse_struct_with_attrs(self, attributes: [Attribute]) -> Result<Node, ParseError>:
    val start_span = self.current.span
    self.expect(TokenKind.Struct)
    val name = self.expect_identifier()
    val generic_params = self.parse_generic_params_as_strings()

    # Optional trait implementation syntax: struct Name(Trait):
    val implements_trait = if self.check(TokenKind.LParen):
        self.advance()
        val trait_name = self.expect_identifier()
        self.expect(TokenKind.RParen)
        Some(trait_name)
    else:
        nil

    val where_clause = self.parse_where_clause()

    # Empty struct (no body) or indented fields/methods
    val (fields, methods, invariant, doc_comment) = if self.check(TokenKind.Newline) or self.is_at_end():
        ([], [], nil, nil)
    else:
        self.parse_indented_fields_and_methods()

    Ok(Node.Struct(StructDef(
        span: self.make_span(start_span),
        name: name,
        generic_params: generic_params,
        where_clause: where_clause,
        fields: fields,
        methods: methods,
        visibility: Visibility.Private,
        attributes: attributes,
        doc_comment: doc_comment,
        invariant: invariant,
        is_generic_template: not generic_params.is_empty(),
        specialization_of: nil,
        type_bindings: {},
    )))

# Parse struct with leading doc comment
fn parse_struct_with_doc(self, doc_comment: Option<DocComment>) -> Result<Node, ParseError>:
    var node = self.parse_struct()
    match node:
        Ok(Node.Struct(s)):
            s.doc_comment = doc_comment ?? s.doc_comment
    node
