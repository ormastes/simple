# Simple (.spl) replacement for src/build_tools.sh
# Build script for Simple self-hosted development tools
# Compiles .spl files to executables in simple/bin_simple/
#
# Tools:
#   - simple_fmt     : Formatter
#   - simple_lint    : Linter
#   - simple_lsp     : Language Server
#   - simple_dap     : Debug Adapter
#   - simple_sdn     : SDN (Simple Data Notation) CLI
#   - simple_lms     : Language Model Server (MCP)
#   - simple_depgraph: Dependency Graph Generator
#
# Usage: bin/simple run src/app/build/tools.spl

use app.io.mod.{shell, file_exists, dir_create_all, exit}
use std.log.{error}

fn find_compiler() -> text:
    if file_exists("./target/debug/simple"):
        return "./target/debug/simple"
    if file_exists("./simple/bin/simple"):
        return "./simple/bin/simple"
    ""

fn build_tool(compiler: text, source: text, output: text, build_dir: text, name: text):
    print "Building {name}..."
    val result = shell("'{compiler}' compile {source} --output {output} --build-dir {build_dir}")
    if result.exit_code != 0:
        print "Failed to build {name}"
        print result.stderr
        exit(1)
    print "  {name} built: {output}"

fn main():
    print "=== Building Simple Development Tools ==="
    print ""

    # Create output directories
    val out_dirs = [
        "simple/bin_simple",
        "simple/build/formatter",
        "simple/build/lint",
        "simple/build/lsp",
        "simple/build/dap",
        "simple/build/sdn",
        "simple/build/lms",
        "simple/build/depgraph"
    ]
    for d in out_dirs:
        dir_create_all(d)

    val compiler = find_compiler()
    if compiler.len() == 0:
        error("build", "Simple compiler not found")
        print "Please build the compiler first: cargo build"
        exit(1)

    print "Using compiler: {compiler}"

    # Build each tool
    build_tool(compiler, "simple/app/formatter/main.spl", "simple/bin_simple/simple_fmt", "simple/build/formatter", "Formatter")
    build_tool(compiler, "simple/app/lint/main.spl", "simple/bin_simple/simple_lint", "simple/build/lint", "Linter")
    build_tool(compiler, "simple/app/lsp/main.spl", "simple/bin_simple/simple_lsp", "simple/build/lsp", "LSP server")
    build_tool(compiler, "simple/app/dap/main.spl", "simple/bin_simple/simple_dap", "simple/build/dap", "DAP server")
    build_tool(compiler, "simple/app/sdn/main.spl", "simple/bin_simple/simple_sdn", "simple/build/sdn", "SDN CLI")
    build_tool(compiler, "simple/app/lms/main.spl", "simple/bin_simple/simple_lms", "simple/build/lms", "LMS (Language Model Server)")
    build_tool(compiler, "simple/app/depgraph/main.spl", "simple/bin_simple/simple_depgraph", "simple/build/depgraph", "Dependency Graph Generator")

    print ""
    print "=== Build Complete ==="
    print ""
    print "Executables:"
    print "  simple/bin_simple/simple_fmt      - Formatter"
    print "  simple/bin_simple/simple_lint     - Linter"
    print "  simple/bin_simple/simple_lsp      - Language Server Protocol server"
    print "  simple/bin_simple/simple_dap      - Debug Adapter Protocol server"
    print "  simple/bin_simple/simple_sdn      - SDN (Simple Data Notation) CLI"
    print "  simple/bin_simple/simple_lms      - Language Model Server (MCP)"
    print "  simple/bin_simple/simple_depgraph - Dependency Graph Generator"
    print ""
    print "Usage:"
    print "  Formatter:"
    print "    ./simple/bin_simple/simple_fmt <file.spl> [--check] [--write]"
    print ""
    print "  Linter:"
    print "    ./simple/bin_simple/simple_lint <file.spl> [--deny-all]"
    print ""
    print "  LSP Server:"
    print "    ./simple/bin_simple/simple_lsp"
    print "    (Communicates via stdin/stdout, typically started by editor)"
    print "    Set SIMPLE_LSP_DEBUG=1 for debug logging"
    print ""
    print "  DAP Server:"
    print "    ./simple/bin_simple/simple_dap"
    print "    (Communicates via stdin/stdout, typically started by debugger)"
    print "    Set SIMPLE_DAP_DEBUG=1 for debug logging"
    print ""
    print "  SDN CLI:"
    print "    ./simple/bin_simple/simple_sdn check <file.sdn>"
    print "    ./simple/bin_simple/simple_sdn to-json <file.sdn>"
    print "    ./simple/bin_simple/simple_sdn get <file.sdn> <path>"
    print "    ./simple/bin_simple/simple_sdn set <file.sdn> <path> <value>"
    print "    ./simple/bin_simple/simple_sdn fmt <file.sdn> [--write]"
    print ""
    print "  LMS (Language Model Server):"
    print "    ./simple/bin_simple/simple_lms"
    print "    (Implements Anthropic's Model Context Protocol over stdin/stdout)"
    print "    Set SIMPLE_LMS_DEBUG=1 for debug logging"
    print ""
    print "  Dependency Graph Generator:"
    print "    ./simple/bin_simple/simple_depgraph <directory> [OPTIONS]"
    print "    Options:"
    print "      --recursive    Analyze subdirectories recursively"
    print "      --verbose      Enable verbose AOP logging"
    print "      --dry-run      Print analysis without writing files"
    print "      --summary      Print summary report"
    print "    Output: .__init__.spl (dot-prefixed dependency analysis)"

main()
