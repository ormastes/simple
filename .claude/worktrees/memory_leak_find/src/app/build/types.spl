# Build System Types
#
# Core types for the Simple build system

# Build profiles
enum BuildProfile:
    Debug          # Fast builds with debug info
    Release        # Optimized builds
    Bootstrap      # Minimal size builds for distribution

# MIR Optimization levels
enum OptimizationLevel:
    None_           # No optimization (fast compile, slow runtime)
    Size           # Optimize for binary size
    Speed          # Optimize for speed (default release)
    Aggressive     # Maximum optimization (slow compile, fast runtime)

# Build result
struct BuildResult:
    success: bool
    exit_code: i64
    stdout: text
    stderr: text
    duration_ms: i64

# Build error
struct BuildError:
    message: text
    exit_code: i64
    stderr: text

# Build configuration
struct BuildConfig:
    profile: BuildProfile
    features: [text]
    workspace_root: text
    target_dir: text
    jobs: i64
    verbose: bool
    opt_level: OptimizationLevel      # MIR optimization level
    show_opt_stats: bool              # Display optimization statistics
    warn_docs: bool                   # Emit documentation warnings
    use_lto: bool                     # Enable ThinLTO
    march_target: text                # Target CPU arch (e.g. x86-64-v3, native)
    pgo_generate: bool                # Build instrumented binary for PGO
    pgo_use_path: text                # Path to PGO profile data
    release_optimized: bool           # Convenience: -O2 + x86-64-v3 + ThinLTO
    target: text                      # Target architecture (e.g. wasm32-wasi, x86_64)
    wasm_backend: text                # WASM backend: "auto", "llvm", "wat"

# Test result
struct TestResult:
    success: bool
    exit_code: i64
    stdout: text
    stderr: text
    tests_run: i64
    tests_passed: i64
    tests_failed: i64

# Test error
struct TestError:
    message: text
    exit_code: i64
    stderr: text

fn profile_to_string(profile: BuildProfile) -> text:
    match profile:
        case BuildProfile.Debug: "debug"
        case BuildProfile.Release: "release"
        case BuildProfile.Bootstrap: "bootstrap"

fn profile_from_string(s: text) -> BuildProfile:
    match s:
        case "debug": BuildProfile.Debug
        case "release": BuildProfile.Release
        case "bootstrap": BuildProfile.Bootstrap
        case _: BuildProfile.Debug  # Default to debug

fn opt_level_to_string(level: OptimizationLevel) -> text:
    match level:
        case OptimizationLevel.None_: "none"
        case OptimizationLevel.Size: "size"
        case OptimizationLevel.Speed: "speed"
        case OptimizationLevel.Aggressive: "aggressive"

fn opt_level_from_string(s: text) -> OptimizationLevel:
    match s:
        case "none" | "0": OptimizationLevel.None_
        case "size" | "s": OptimizationLevel.Size
        case "speed" | "2": OptimizationLevel.Speed
        case "aggressive" | "3": OptimizationLevel.Aggressive
        case _: OptimizationLevel.None_  # Default to no optimization

fn default_opt_level_for_profile(profile: BuildProfile) -> OptimizationLevel:
    """Get default optimization level for build profile."""
    match profile:
        case BuildProfile.Debug: OptimizationLevel.None_
        case BuildProfile.Release: OptimizationLevel.Speed
        case BuildProfile.Bootstrap: OptimizationLevel.Size

# Test configuration
struct TestConfig:
    filter: text          # Test name filter (empty = all tests)
    level: text           # Test level: all, unit, integration, system
    tag: text             # Tag filter (empty = all tags)
    fail_fast: bool       # Stop on first failure
    timeout: i64          # Test timeout in ms (0 = no timeout)
    parallel: bool        # Run test suites in parallel
    rust_only: bool       # Run only Rust tests
    doc_only: bool        # Run only doc-tests
    simple_only: bool     # Run only Simple tests
    # Bare-metal test configuration
    baremetal: bool       # Run bare-metal tests in QEMU
    baremetal_board: text # Board for bare-metal tests (default: qemu_x86)
    baremetal_timeout: i64 # QEMU timeout in ms (default: 30000)

# Combined test results (all 4 test types)
struct TestResults:
    rust: TestResult      # Rust workspace tests
    doc: TestResult       # Doc-tests
    simple: TestResult    # Simple/SSpec tests
    baremetal: TestResult # Bare-metal QEMU tests
    total_duration_ms: i64

impl TestResults:
    fn all_passed() -> bool:
        self.rust.success and self.doc.success and self.simple.success and self.baremetal.success

    fn total_tests() -> i64:
        self.rust.tests_run + self.doc.tests_run + self.simple.tests_run + self.baremetal.tests_run

    fn total_passed() -> i64:
        self.rust.tests_passed + self.doc.tests_passed + self.simple.tests_passed + self.baremetal.tests_passed

    fn total_failed() -> i64:
        self.rust.tests_failed + self.doc.tests_failed + self.simple.tests_failed + self.baremetal.tests_failed

# Coverage level
enum CoverageLevel:
    Unit          # Unit tests only
    Integration   # Integration tests only
    System        # System tests only
    All           # All test levels

# Coverage format
enum CoverageFormat:
    Text          # Plain text summary
    Html          # HTML report
    Lcov          # LCOV format for CI
    Json          # JSON format for tooling
