# Winit Windowing System SFFI Bindings
#
# SFFI pattern for Winit cross-platform windowing.
# Provides window creation, event handling, and input management.
#
# Documentation: https://docs.rs/winit/

# ============================================================================
# Tier 1: Extern Declarations (Raw FFI)
# ============================================================================

# --- Event Loop ---
extern fn rt_winit_event_loop_new() -> i64
extern fn rt_winit_event_loop_free(event_loop: i64) -> bool
extern fn rt_winit_event_loop_run_return(event_loop: i64) -> bool
extern fn rt_winit_event_loop_poll_events(event_loop: i64, max_events: i64) -> i64
extern fn rt_winit_event_loop_wait_events(event_loop: i64, timeout_ms: i64) -> i64

# --- Window Creation ---
extern fn rt_winit_window_new(event_loop: i64, width: i64, height: i64, title: text) -> i64
extern fn rt_winit_window_new_with_config(event_loop: i64, config_json: text) -> i64
extern fn rt_winit_window_free(window: i64) -> bool

# --- Window Properties ---
extern fn rt_winit_window_get_size(window: i64) -> (i64, i64)
extern fn rt_winit_window_set_size(window: i64, width: i64, height: i64) -> bool
extern fn rt_winit_window_get_position(window: i64) -> (i64, i64)
extern fn rt_winit_window_set_position(window: i64, x: i64, y: i64) -> bool
extern fn rt_winit_window_get_inner_size(window: i64) -> (i64, i64)
extern fn rt_winit_window_get_outer_size(window: i64) -> (i64, i64)
extern fn rt_winit_window_set_min_size(window: i64, width: i64, height: i64) -> bool
extern fn rt_winit_window_set_max_size(window: i64, width: i64, height: i64) -> bool

# --- Window State ---
extern fn rt_winit_window_set_title(window: i64, title: text) -> bool
extern fn rt_winit_window_set_visible(window: i64, visible: bool) -> bool
extern fn rt_winit_window_is_visible(window: i64) -> bool
extern fn rt_winit_window_set_resizable(window: i64, resizable: bool) -> bool
extern fn rt_winit_window_set_minimized(window: i64, minimized: bool) -> bool
extern fn rt_winit_window_set_maximized(window: i64, maximized: bool) -> bool
extern fn rt_winit_window_is_maximized(window: i64) -> bool
extern fn rt_winit_window_set_fullscreen(window: i64, fullscreen: bool) -> bool
extern fn rt_winit_window_is_fullscreen(window: i64) -> bool
extern fn rt_winit_window_set_decorations(window: i64, decorations: bool) -> bool
extern fn rt_winit_window_set_always_on_top(window: i64, on_top: bool) -> bool
extern fn rt_winit_window_focus(window: i64) -> bool
extern fn rt_winit_window_request_redraw(window: i64) -> bool

# --- Window Information ---
extern fn rt_winit_window_id(window: i64) -> i64
extern fn rt_winit_window_scale_factor(window: i64) -> f64
extern fn rt_winit_window_set_cursor_visible(window: i64, visible: bool) -> bool
extern fn rt_winit_window_set_cursor_grab(window: i64, grab: bool) -> bool
extern fn rt_winit_window_set_cursor_position(window: i64, x: i64, y: i64) -> bool

# --- Events ---
extern fn rt_winit_event_get_type(event: i64) -> i64
extern fn rt_winit_event_get_window_id(event: i64) -> i64
extern fn rt_winit_event_free(event: i64) -> bool

# Window Events
extern fn rt_winit_event_window_resized(event: i64) -> (i64, i64)
extern fn rt_winit_event_window_moved(event: i64) -> (i64, i64)
extern fn rt_winit_event_window_close_requested(event: i64) -> bool
extern fn rt_winit_event_window_focused(event: i64) -> bool
extern fn rt_winit_event_window_scale_factor_changed(event: i64) -> f64

# Keyboard Events
extern fn rt_winit_event_keyboard_input(event: i64) -> (i64, i64, bool)
extern fn rt_winit_event_keyboard_scancode(event: i64) -> i64
extern fn rt_winit_event_keyboard_virtual_keycode(event: i64) -> i64
extern fn rt_winit_event_keyboard_modifiers(event: i64) -> i64
extern fn rt_winit_event_received_character(event: i64) -> text

# Mouse Events
extern fn rt_winit_event_mouse_button(event: i64) -> (i64, bool)
extern fn rt_winit_event_mouse_moved(event: i64) -> (f64, f64)
extern fn rt_winit_event_mouse_wheel(event: i64) -> (f64, f64)
extern fn rt_winit_event_cursor_entered(event: i64) -> bool
extern fn rt_winit_event_cursor_left(event: i64) -> bool

# Touch Events
extern fn rt_winit_event_touch(event: i64) -> (i64, i64, f64, f64)

# --- Monitor Information ---
extern fn rt_winit_monitor_count() -> i64
extern fn rt_winit_monitor_get_name(monitor_id: i64) -> text
extern fn rt_winit_monitor_get_size(monitor_id: i64) -> (i64, i64)
extern fn rt_winit_monitor_get_position(monitor_id: i64) -> (i64, i64)
extern fn rt_winit_monitor_get_scale_factor(monitor_id: i64) -> f64

# --- Clipboard ---
extern fn rt_winit_clipboard_get_text() -> text
extern fn rt_winit_clipboard_set_text(text: text) -> bool

# --- Utilities ---
extern fn rt_winit_get_last_error() -> text

# ============================================================================
# Tier 2: Simple-Friendly Wrapper Functions
# ============================================================================

# --- Event Loop ---

struct EventLoop:
    handle: i64
    is_valid: bool

fn window_create_event_loop() -> EventLoop:
    val handle = rt_winit_event_loop_new()
    EventLoop(handle: handle, is_valid: handle != 0)

fn window_destroy_event_loop(event_loop: EventLoop) -> bool:
    if event_loop.is_valid:
        rt_winit_event_loop_free(event_loop.handle)
    else:
        true

fn window_run_event_loop(event_loop: EventLoop) -> bool:
    if not event_loop.is_valid:
        false
    else:
        rt_winit_event_loop_run_return(event_loop.handle)

struct EventBatch:
    handle: i64
    count: i64
    event_loop: EventLoop

fn window_poll_events(event_loop: EventLoop, max_events: i64) -> EventBatch:
    if not event_loop.is_valid:
        EventBatch(handle: 0, count: 0, event_loop: event_loop)
    else:
        val handle = rt_winit_event_loop_poll_events(event_loop.handle, max_events)
        EventBatch(handle: handle, count: max_events, event_loop: event_loop)

fn window_wait_events(event_loop: EventLoop, timeout_ms: i64) -> EventBatch:
    if not event_loop.is_valid:
        EventBatch(handle: 0, count: 0, event_loop: event_loop)
    else:
        val handle = rt_winit_event_loop_wait_events(event_loop.handle, timeout_ms)
        EventBatch(handle: handle, count: 100, event_loop: event_loop)

# --- Window Configuration ---

struct WindowConfig:
    width: i64
    height: i64
    title: text
    resizable: bool
    decorations: bool
    transparent: bool
    always_on_top: bool
    fullscreen: bool
    maximized: bool
    visible: bool
    min_width: i64
    min_height: i64
    max_width: i64
    max_height: i64

fn window_config_default() -> WindowConfig:
    WindowConfig(
        width: 800,
        height: 600,
        title: "Simple Window",
        resizable: true,
        decorations: true,
        transparent: false,
        always_on_top: false,
        fullscreen: false,
        maximized: false,
        visible: true,
        min_width: 0,
        min_height: 0,
        max_width: 0,
        max_height: 0
    )

# --- Window ---

struct Window:
    handle: i64
    event_loop: EventLoop
    is_valid: bool

fn window_create(event_loop: EventLoop, width: i64, height: i64, title: text) -> Window:
    if not event_loop.is_valid:
        Window(handle: 0, event_loop: event_loop, is_valid: false)
    else:
        val handle = rt_winit_window_new(event_loop.handle, width, height, title)
        Window(handle: handle, event_loop: event_loop, is_valid: handle != 0)

fn window_create_with_config(event_loop: EventLoop, config: WindowConfig) -> Window:
    if not event_loop.is_valid:
        Window(handle: 0, event_loop: event_loop, is_valid: false)
    else:
        # Build JSON config string
        val config_json = "{{\"width\":{config.width},\"height\":{config.height},\"title\":\"{config.title}\",\"resizable\":{config.resizable},\"decorations\":{config.decorations},\"transparent\":{config.transparent},\"always_on_top\":{config.always_on_top},\"fullscreen\":{config.fullscreen},\"maximized\":{config.maximized},\"visible\":{config.visible}}}"
        val handle = rt_winit_window_new_with_config(event_loop.handle, config_json)
        Window(handle: handle, event_loop: event_loop, is_valid: handle != 0)

fn window_destroy(window: Window) -> bool:
    if not window.is_valid:
        true
    else:
        rt_winit_window_free(window.handle)

# --- Window Properties ---

struct Size:
    width: i64
    height: i64

struct Position:
    x: i64
    y: i64

fn window_get_size(window: Window) -> Size:
    if not window.is_valid:
        Size(width: 0, height: 0)
    else:
        val result = rt_winit_window_get_size(window.handle)
        Size(width: result.0, height: result.1)

fn window_set_size(window: Window, size: Size) -> bool:
    if not window.is_valid:
        false
    else:
        rt_winit_window_set_size(window.handle, size.width, size.height)

fn window_get_position(window: Window) -> Position:
    if not window.is_valid:
        Position(x: 0, y: 0)
    else:
        val result = rt_winit_window_get_position(window.handle)
        Position(x: result.0, y: result.1)

fn window_set_position(window: Window, pos: Position) -> bool:
    if not window.is_valid:
        false
    else:
        rt_winit_window_set_position(window.handle, pos.x, pos.y)

fn window_get_inner_size(window: Window) -> Size:
    if not window.is_valid:
        Size(width: 0, height: 0)
    else:
        val result = rt_winit_window_get_inner_size(window.handle)
        Size(width: result.0, height: result.1)

fn window_get_outer_size(window: Window) -> Size:
    if not window.is_valid:
        Size(width: 0, height: 0)
    else:
        val result = rt_winit_window_get_outer_size(window.handle)
        Size(width: result.0, height: result.1)

fn window_set_min_size(window: Window, size: Size) -> bool:
    if not window.is_valid:
        false
    else:
        rt_winit_window_set_min_size(window.handle, size.width, size.height)

fn window_set_max_size(window: Window, size: Size) -> bool:
    if not window.is_valid:
        false
    else:
        rt_winit_window_set_max_size(window.handle, size.width, size.height)

# --- Window State ---

fn window_set_title(window: Window, title: text) -> bool:
    if not window.is_valid:
        false
    else:
        rt_winit_window_set_title(window.handle, title)

fn window_set_visible(window: Window, visible: bool) -> bool:
    if not window.is_valid:
        false
    else:
        rt_winit_window_set_visible(window.handle, visible)

fn window_is_visible(window: Window) -> bool:
    if not window.is_valid:
        false
    else:
        rt_winit_window_is_visible(window.handle)

fn window_set_resizable(window: Window, resizable: bool) -> bool:
    if not window.is_valid:
        false
    else:
        rt_winit_window_set_resizable(window.handle, resizable)

fn window_set_minimized(window: Window, minimized: bool) -> bool:
    if not window.is_valid:
        false
    else:
        rt_winit_window_set_minimized(window.handle, minimized)

fn window_set_maximized(window: Window, maximized: bool) -> bool:
    if not window.is_valid:
        false
    else:
        rt_winit_window_set_maximized(window.handle, maximized)

fn window_is_maximized(window: Window) -> bool:
    if not window.is_valid:
        false
    else:
        rt_winit_window_is_maximized(window.handle)

fn window_set_fullscreen(window: Window, fullscreen: bool) -> bool:
    if not window.is_valid:
        false
    else:
        rt_winit_window_set_fullscreen(window.handle, fullscreen)

fn window_is_fullscreen(window: Window) -> bool:
    if not window.is_valid:
        false
    else:
        rt_winit_window_is_fullscreen(window.handle)

fn window_set_decorations(window: Window, decorations: bool) -> bool:
    if not window.is_valid:
        false
    else:
        rt_winit_window_set_decorations(window.handle, decorations)

fn window_set_always_on_top(window: Window, on_top: bool) -> bool:
    if not window.is_valid:
        false
    else:
        rt_winit_window_set_always_on_top(window.handle, on_top)

fn window_focus(window: Window) -> bool:
    if not window.is_valid:
        false
    else:
        rt_winit_window_focus(window.handle)

fn window_request_redraw(window: Window) -> bool:
    if not window.is_valid:
        false
    else:
        rt_winit_window_request_redraw(window.handle)

# --- Window Information ---

fn window_id(window: Window) -> i64:
    if not window.is_valid:
        0
    else:
        rt_winit_window_id(window.handle)

fn window_scale_factor(window: Window) -> f64:
    if not window.is_valid:
        1.0
    else:
        rt_winit_window_scale_factor(window.handle)

# --- Cursor ---

fn window_set_cursor_visible(window: Window, visible: bool) -> bool:
    if not window.is_valid:
        false
    else:
        rt_winit_window_set_cursor_visible(window.handle, visible)

fn window_set_cursor_grab(window: Window, grab: bool) -> bool:
    if not window.is_valid:
        false
    else:
        rt_winit_window_set_cursor_grab(window.handle, grab)

fn window_set_cursor_position(window: Window, pos: Position) -> bool:
    if not window.is_valid:
        false
    else:
        rt_winit_window_set_cursor_position(window.handle, pos.x, pos.y)

# --- Events ---

enum EventType:
    WindowResized
    WindowMoved
    WindowCloseRequested
    WindowDestroyed
    WindowFocused
    WindowUnfocused
    WindowScaleFactorChanged
    KeyboardInput
    ReceivedCharacter
    MouseButton
    MouseMoved
    MouseWheel
    CursorEntered
    CursorLeft
    TouchEvent
    RedrawRequested
    Unknown

struct Event:
    handle: i64
    event_type: EventType
    window_id: i64
    is_valid: bool

fn event_get_type_code(event: Event) -> i64:
    if not event.is_valid:
        0
    else:
        rt_winit_event_get_type(event.handle)

fn event_parse_type(type_code: i64) -> EventType:
    if type_code == 1:
        EventType.WindowResized
    elif type_code == 2:
        EventType.WindowMoved
    elif type_code == 3:
        EventType.WindowCloseRequested
    elif type_code == 4:
        EventType.WindowDestroyed
    elif type_code == 5:
        EventType.WindowFocused
    elif type_code == 6:
        EventType.WindowUnfocused
    elif type_code == 7:
        EventType.WindowScaleFactorChanged
    elif type_code == 10:
        EventType.KeyboardInput
    elif type_code == 11:
        EventType.ReceivedCharacter
    elif type_code == 20:
        EventType.MouseButton
    elif type_code == 21:
        EventType.MouseMoved
    elif type_code == 22:
        EventType.MouseWheel
    elif type_code == 23:
        EventType.CursorEntered
    elif type_code == 24:
        EventType.CursorLeft
    elif type_code == 30:
        EventType.TouchEvent
    elif type_code == 40:
        EventType.RedrawRequested
    else:
        EventType.Unknown

fn event_destroy(event: Event) -> bool:
    if not event.is_valid:
        true
    else:
        rt_winit_event_free(event.handle)

# --- Window Events ---

fn event_window_resized(event: Event) -> Size:
    if not event.is_valid:
        Size(width: 0, height: 0)
    else:
        val result = rt_winit_event_window_resized(event.handle)
        Size(width: result.0, height: result.1)

fn event_window_moved(event: Event) -> Position:
    if not event.is_valid:
        Position(x: 0, y: 0)
    else:
        val result = rt_winit_event_window_moved(event.handle)
        Position(x: result.0, y: result.1)

fn event_window_focused(event: Event) -> bool:
    if not event.is_valid:
        false
    else:
        rt_winit_event_window_focused(event.handle)

fn event_window_scale_factor(event: Event) -> f64:
    if not event.is_valid:
        1.0
    else:
        rt_winit_event_window_scale_factor(event.handle)

# --- Keyboard Events ---

enum KeyState:
    Pressed
    Released

enum VirtualKey:
    A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S, T, U, V, W, X, Y, Z
    Key0, Key1, Key2, Key3, Key4, Key5, Key6, Key7, Key8, Key9
    Escape, Enter, Space, Backspace, Tab
    Left, Right, Up, Down
    F1, F2, F3, F4, F5, F6, F7, F8, F9, F10, F11, F12
    LShift, RShift, LControl, RControl, LAlt, RAlt
    Unknown

struct KeyboardEvent:
    scancode: i64
    virtual_key: VirtualKey
    state: KeyState
    modifiers: i64

fn event_keyboard_input(event: Event) -> KeyboardEvent:
    if not event.is_valid:
        KeyboardEvent(scancode: 0, virtual_key: VirtualKey.Unknown, state: KeyState.Released, modifiers: 0)
    else:
        val result = rt_winit_event_keyboard_input(event.handle)
        val state = if result.2: KeyState.Pressed else: KeyState.Released
        val vkey = parse_virtual_key(result.1)
        KeyboardEvent(scancode: result.0, virtual_key: vkey, state: state, modifiers: rt_winit_event_keyboard_modifiers(event.handle))

fn parse_virtual_key(code: i64) -> VirtualKey:
    if code == 65: VirtualKey.A
    elif code == 66: VirtualKey.B
    elif code == 67: VirtualKey.C
    elif code == 68: VirtualKey.D
    elif code == 69: VirtualKey.E
    elif code == 87: VirtualKey.W
    elif code == 83: VirtualKey.S
    elif code == 27: VirtualKey.Escape
    elif code == 13: VirtualKey.Enter
    elif code == 32: VirtualKey.Space
    elif code == 37: VirtualKey.Left
    elif code == 38: VirtualKey.Up
    elif code == 39: VirtualKey.Right
    elif code == 40: VirtualKey.Down
    else: VirtualKey.Unknown

fn event_received_character(event: Event) -> text:
    if not event.is_valid:
        ""
    else:
        rt_winit_event_received_character(event.handle)

# --- Mouse Events ---

enum MouseButton:
    Left
    Right
    Middle
    Other

struct MouseButtonEvent:
    button: MouseButton
    state: KeyState

fn event_mouse_button(event: Event) -> MouseButtonEvent:
    if not event.is_valid:
        MouseButtonEvent(button: MouseButton.Left, state: KeyState.Released)
    else:
        val result = rt_winit_event_mouse_button(event.handle)
        val button = if result.0 == 0:
            MouseButton.Left
        elif result.0 == 1:
            MouseButton.Right
        elif result.0 == 2:
            MouseButton.Middle
        else:
            MouseButton.Other
        val state = if result.1: KeyState.Pressed else: KeyState.Released
        MouseButtonEvent(button: button, state: state)

struct MousePosition:
    x: f64
    y: f64

fn event_mouse_moved(event: Event) -> MousePosition:
    if not event.is_valid:
        MousePosition(x: 0.0, y: 0.0)
    else:
        val result = rt_winit_event_mouse_moved(event.handle)
        MousePosition(x: result.0, y: result.1)

struct MouseWheel:
    delta_x: f64
    delta_y: f64

fn event_mouse_wheel(event: Event) -> MouseWheel:
    if not event.is_valid:
        MouseWheel(delta_x: 0.0, delta_y: 0.0)
    else:
        val result = rt_winit_event_mouse_wheel(event.handle)
        MouseWheel(delta_x: result.0, delta_y: result.1)

# --- Monitor Information ---

struct Monitor:
    id: i64
    name: text
    size: Size
    position: Position
    scale_factor: f64

fn window_get_monitor_count() -> i64:
    rt_winit_monitor_count()

fn window_get_monitor_info(monitor_id: i64) -> Monitor:
    val name = rt_winit_monitor_get_name(monitor_id)
    val size_result = rt_winit_monitor_get_size(monitor_id)
    val pos_result = rt_winit_monitor_get_position(monitor_id)
    val scale = rt_winit_monitor_get_scale_factor(monitor_id)

    Monitor(
        id: monitor_id,
        name: name,
        size: Size(width: size_result.0, height: size_result.1),
        position: Position(x: pos_result.0, y: pos_result.1),
        scale_factor: scale
    )

# --- Clipboard ---

fn window_clipboard_get() -> text:
    rt_winit_clipboard_get_text()

fn window_clipboard_set(text: text) -> bool:
    rt_winit_clipboard_set_text(text)

# --- Utilities ---

fn window_last_error() -> text:
    rt_winit_get_last_error()

# ============================================================================
# Exports
# ============================================================================

export EventLoop, window_create_event_loop, window_destroy_event_loop
export window_run_event_loop, window_poll_events, window_wait_events, EventBatch
export WindowConfig, window_config_default
export Window, window_create, window_create_with_config, window_destroy
export Size, Position
export window_get_size, window_set_size, window_get_position, window_set_position
export window_get_inner_size, window_get_outer_size
export window_set_min_size, window_set_max_size
export window_set_title, window_set_visible, window_is_visible
export window_set_resizable, window_set_minimized, window_set_maximized, window_is_maximized
export window_set_fullscreen, window_is_fullscreen
export window_set_decorations, window_set_always_on_top
export window_focus, window_request_redraw
export window_id, window_scale_factor
export window_set_cursor_visible, window_set_cursor_grab, window_set_cursor_position
export EventType, Event, event_get_type_code, event_parse_type, event_destroy
export event_window_resized, event_window_moved, event_window_focused, event_window_scale_factor
export KeyState, VirtualKey, KeyboardEvent, event_keyboard_input, event_received_character
export MouseButton, MouseButtonEvent, event_mouse_button
export MousePosition, event_mouse_moved, MouseWheel, event_mouse_wheel
export Monitor, window_get_monitor_count, window_get_monitor_info
export window_clipboard_get, window_clipboard_set
export window_last_error
