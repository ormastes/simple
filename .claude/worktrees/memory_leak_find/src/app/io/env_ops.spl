# Environment Operations - Pure Simple I/O
# Extracted from mod.spl for modularity

# Extern fn declarations (runtime resolves at file level)
extern fn rt_env_get(key: text) -> text
extern fn rt_env_set(key: text, value_str: text) -> bool
extern fn rt_env_vars() -> Dict<text, text>
extern fn rt_process_run(cmd: text, args: [text]) -> (text, text, i64)

# Platform detection - inlined to avoid bootstrap runtime limitations
fn _is_windows_platform() -> bool:
    val os_env = rt_env_get("OS")
    if os_env == nil:
        false
    else:
        os_env.lower().contains("windows")

# --- Shell helpers (local copies to avoid circular imports) ---

fn _env_shell(command: text) -> (text, text, i64):
    rt_process_run("/bin/sh", ["-c", command])

fn _env_shell_output_trimmed(command: text, default: text) -> text:
    val (out, err, code) = _env_shell(command)
    if code == 0:
        out.trim()
    else:
        default

# ============================================================================
# Environment Functions
# ============================================================================

fn env_get(key: text) -> text:
    rt_env_get(key)

fn env_set(key: text, value: text) -> bool:
    rt_env_set(key, value)

fn cwd() -> text:
    val (out, err, code) = _env_shell("pwd")
    if code == 0:
        out.trim()
    else:
        "."

fn home() -> text:
    rt_env_get("HOME")

fn env_vars() -> Dict<text, text>:
    rt_env_vars()

fn host_arch() -> text:
    if _is_windows_platform():
        val proc_arch = env_get("PROCESSOR_ARCHITECTURE")
        if proc_arch.?:
            match proc_arch.lower():
                case "amd64" | "x64": "x86_64"
                case "x86": "i686"
                case "arm64": "aarch64"
                case "arm": "arm"
                case _: "x86_64"
        else:
            "x86_64"
    else:
        val arch = _env_shell_output_trimmed("uname -m", "x86_64")
        match arch:
            case "x86_64" | "amd64": "x86_64"
            case "i686" | "i386" | "i586": "i686"
            case "aarch64" | "arm64": "aarch64"
            case "armv7l" | "armv7" | "arm": "armv7"
            case "riscv64": "riscv64"
            case "riscv32": "riscv32"
            case _: arch

fn host_os() -> text:
    if _is_windows_platform():
        "windows"
    else:
        val os = _env_shell_output_trimmed("uname -s", "linux")
        match os:
            case "Linux": "linux"
            case "Darwin": "macos"
            case "FreeBSD": "freebsd"
            case "OpenBSD": "openbsd"
            case "NetBSD": "netbsd"
            case _: os.lower()

export cwd, home, env_get, env_set, env_vars
export host_arch, host_os
