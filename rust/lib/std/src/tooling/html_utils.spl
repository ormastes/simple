# HTML generation utilities
# Pure Simple implementation for creating HTML documents

use super.string_utils.{repeat}

# =====================================
# HTML Escaping
# =====================================

# Escape HTML special characters
fn escape_html(text: text) -> text:
    text
        .replace("&", "&amp;")
        .replace("<", "&lt;")
        .replace(">", "&gt;")
        .replace("\"", "&quot;")
        .replace("'", "&#39;")

# Unescape HTML entities
fn unescape_html(text: text) -> text:
    text
        .replace("&lt;", "<")
        .replace("&gt;", ">")
        .replace("&quot;", "\"")
        .replace("&#39;", "'")
        .replace("&amp;", "&")

# =====================================
# Basic HTML Elements
# =====================================

# Create HTML tag with content
fn tag(name: text, content: text) -> text:
    "<{name}>{content}</{name}>"

# Create self-closing tag
fn self_closing_tag(name: text) -> text:
    "<{name} />"

# Create tag with attributes
fn tag_with_attrs(name: text, attrs: List<(text, text)>, content: text) -> text:
    var attr_str = ""
    for (key, value) in attrs:
        attr_str = attr_str + " {key}=\"{escape_html(value)}\""

    "<{name}{attr_str}>{content}</{name}>"

# Create self-closing tag with attributes
fn self_closing_tag_with_attrs(name: text, attrs: List<(text, text)>) -> text:
    var attr_str = ""
    for (key, value) in attrs:
        attr_str = attr_str + " {key}=\"{escape_html(value)}\""

    "<{name}{attr_str} />"

# =====================================
# Document Structure
# =====================================

# Create complete HTML document
fn html_document(head_content: text, body_content: text) -> text:
    "<!DOCTYPE html>\n<html>\n<head>\n{head_content}\n</head>\n<body>\n{body_content}\n</body>\n</html>"

# Create HTML5 document with lang attribute
fn html5_document(lang: text, head_content: text, body_content: text) -> text:
    "<!DOCTYPE html>\n<html lang=\"{lang}\">\n<head>\n{head_content}\n</head>\n<body>\n{body_content}\n</body>\n</html>"

# Create DOCTYPE declaration
fn doctype_html5() -> text:
    "<!DOCTYPE html>"

# =====================================
# Head Elements
# =====================================

# Create title tag
fn title(text: text) -> text:
    "<title>{escape_html(text)}</title>"

# Create meta tag
fn meta(name: text, content: text) -> text:
    self_closing_tag_with_attrs("meta", [("name", name), ("content", content)])

# Create meta charset tag
fn meta_charset(charset: text) -> text:
    self_closing_tag_with_attrs("meta", [("charset", charset)])

# Create meta viewport tag
fn meta_viewport() -> text:
    meta("viewport", "width=device-width, initial-scale=1.0")

# Create link tag (for CSS)
fn link_stylesheet(href: text) -> text:
    self_closing_tag_with_attrs("link", [("rel", "stylesheet"), ("href", href)])

# Create script tag
fn script_src(src: text) -> text:
    tag_with_attrs("script", [("src", src)], "")

# Create inline script tag
fn script_inline(code: text) -> text:
    "<script>\n{code}\n</script>"

# Create style tag
fn style(css: text) -> text:
    "<style>\n{css}\n</style>"

# =====================================
# Text Elements
# =====================================

# Heading tags
fn h1(text: text) -> text:
    "<h1>{escape_html(text)}</h1>"

fn h2(text: text) -> text:
    "<h2>{escape_html(text)}</h2>"

fn h3(text: text) -> text:
    "<h3>{escape_html(text)}</h3>"

fn h4(text: text) -> text:
    "<h4>{escape_html(text)}</h4>"

fn h5(text: text) -> text:
    "<h5>{escape_html(text)}</h5>"

fn h6(text: text) -> text:
    "<h6>{escape_html(text)}</h6>"

# Paragraph
fn p(text: text) -> text:
    "<p>{escape_html(text)}</p>"

# Div
fn div(content: text) -> text:
    "<div>{content}</div>"

# Div with class
fn div_with_class(class_name: text, content: text) -> text:
    tag_with_attrs("div", [("class", class_name)], content)

# Span
fn span(text: text) -> text:
    "<span>{escape_html(text)}</span>"

# Span with class
fn span_with_class(class_name: text, text: text) -> text:
    tag_with_attrs("span", [("class", class_name)], escape_html(text))

# =====================================
# Formatting Elements
# =====================================

# Bold text
fn strong(text: text) -> text:
    "<strong>{escape_html(text)}</strong>"

# Italic text
fn em(text: text) -> text:
    "<em>{escape_html(text)}</em>"

# Code
fn code(text: text) -> text:
    "<code>{escape_html(text)}</code>"

# Preformatted text
fn pre(text: text) -> text:
    "<pre>{escape_html(text)}</pre>"

# Code block
fn code_block(code: text, language: text) -> text:
    tag_with_attrs("pre", [], tag_with_attrs("code", [("class", "language-{language}")], escape_html(code)))

# Blockquote
fn blockquote(text: text) -> text:
    "<blockquote>{escape_html(text)}</blockquote>"

# Line break
fn br() -> text:
    "<br />"

# Horizontal rule
fn hr() -> text:
    "<hr />"

# =====================================
# Link Elements
# =====================================

# Anchor link
fn a(href: text, text: text) -> text:
    tag_with_attrs("a", [("href", href)], escape_html(text))

# Link with target
fn a_target(href: text, text: text, target: text) -> text:
    tag_with_attrs("a", [("href", href), ("target", target)], escape_html(text))

# External link (opens in new tab)
fn a_external(href: text, text: text) -> text:
    a_target(href, text, "_blank")

# =====================================
# Image Elements
# =====================================

# Image tag
fn img(src: text, alt: text) -> text:
    self_closing_tag_with_attrs("img", [("src", src), ("alt", alt)])

# Image with width and height
fn img_sized(src: text, alt: text, width: i32, height: i32) -> text:
    self_closing_tag_with_attrs("img", [
        ("src", src),
        ("alt", alt),
        ("width", width.to_string()),
        ("height", height.to_string())
    ])

# =====================================
# List Elements
# =====================================

# Unordered list
fn ul(items: List<text>) -> text:
    var content = ""
    for item in items:
        content = content + "<li>{escape_html(item)}</li>\n"
    "<ul>\n{content}</ul>"

# Ordered list
fn ol(items: List<text>) -> text:
    var content = ""
    for item in items:
        content = content + "<li>{escape_html(item)}</li>\n"
    "<ol>\n{content}</ol>"

# List item
fn li(text: text) -> text:
    "<li>{escape_html(text)}</li>"

# Description list
fn dl(items: List<(text, text)>) -> text:
    var content = ""
    for (term, description) in items:
        content = content + "<dt>{escape_html(term)}</dt>\n"
        content = content + "<dd>{escape_html(description)}</dd>\n"
    "<dl>\n{content}</dl>"

# =====================================
# Table Elements
# =====================================

# Table
fn table(headers: List<text>, rows: List<List<text>>) -> text:
    var content = "<thead>\n<tr>\n"

    for header in headers:
        content = content + "<th>{escape_html(header)}</th>"
    content = content + "\n</tr>\n</thead>\n<tbody>\n"

    for row in rows:
        content = content + "<tr>\n"
        for cell in row:
            content = content + "<td>{escape_html(cell)}</td>"
        content = content + "\n</tr>\n"

    content = content + "</tbody>"
    "<table>\n{content}\n</table>"

# Table with class
fn table_with_class(class_name: text, headers: List<text>, rows: List<List<text>>) -> text:
    val table_content = table(headers, rows)
    table_content.replace("<table>", "<table class=\"{class_name}\">")

# Table row
fn tr(cells: List<text>) -> text:
    var content = ""
    for cell in cells:
        content = content + "<td>{escape_html(cell)}</td>"
    "<tr>{content}</tr>"

# Table header cell
fn th(text: text) -> text:
    "<th>{escape_html(text)}</th>"

# Table data cell
fn td(text: text) -> text:
    "<td>{escape_html(text)}</td>"

# =====================================
# Form Elements
# =====================================

# Form
fn form(action: text, method: text, content: text) -> text:
    tag_with_attrs("form", [("action", action), ("method", method)], content)

# Input field
fn input(type: text, name: text, value: text) -> text:
    self_closing_tag_with_attrs("input", [("type", type), ("name", name), ("value", value)])

# Text input
fn input_text(name: text, value: text) -> text:
    input("text", name, value)

# Textarea
fn textarea(name: text, rows: i32, cols: i32, content: text) -> text:
    tag_with_attrs("textarea", [
        ("name", name),
        ("rows", rows.to_string()),
        ("cols", cols.to_string())
    ], escape_html(content))

# Button
fn button(text: text, type: text) -> text:
    tag_with_attrs("button", [("type", type)], escape_html(text))

# Submit button
fn button_submit(text: text) -> text:
    button(text, "submit")

# Label
fn label(for_id: text, text: text) -> text:
    tag_with_attrs("label", [("for", for_id)], escape_html(text))

# Select dropdown
fn select(name: text, options: List<(text, text)>) -> text:
    var content = ""
    for (value, label) in options:
        content = content + tag_with_attrs("option", [("value", value)], escape_html(label))

    tag_with_attrs("select", [("name", name)], content)

# =====================================
# Semantic Elements
# =====================================

# Header
fn header(content: text) -> text:
    "<header>{content}</header>"

# Footer
fn footer(content: text) -> text:
    "<footer>{content}</footer>"

# Nav
fn nav(content: text) -> text:
    "<nav>{content}</nav>"

# Main
fn main(content: text) -> text:
    "<main>{content}</main>"

# Article
fn article(content: text) -> text:
    "<article>{content}</article>"

# Section
fn section(content: text) -> text:
    "<section>{content}</section>"

# Aside
fn aside(content: text) -> text:
    "<aside>{content}</aside>"

# =====================================
# Builder Pattern
# =====================================

struct HtmlBuilder:
    parts: List<text>

impl HtmlBuilder:
    static fn new() -> HtmlBuilder:
        HtmlBuilder(parts: [])

    me add(html: text):
        self.parts.push(html)

    me add_heading(level: i32, text: text):
        match level:
            1 => self.parts.push(h1(text))
            2 => self.parts.push(h2(text))
            3 => self.parts.push(h3(text))
            4 => self.parts.push(h4(text))
            5 => self.parts.push(h5(text))
            6 => self.parts.push(h6(text))
            _ => self.parts.push(h1(text))

    me add_paragraph(text: text):
        self.parts.push(p(text))

    me add_list(items: List<text>):
        self.parts.push(ul(items))

    me add_table(headers: List<text>, rows: List<List<text>>):
        self.parts.push(table(headers, rows))

    fn build() -> text:
        self.parts.join("\n")

    fn build_document(title_text: text) -> text:
        val head = title(title_text) + "\n" + meta_charset("UTF-8") + "\n" + meta_viewport()
        val body = self.build()
        html5_document("en", head, body)

# =====================================
# Common Patterns
# =====================================

# Create simple page
fn simple_page(title_text: text, heading: text, content: text) -> text:
    val head = title(title_text) + "\n" + meta_charset("UTF-8") + "\n" + meta_viewport()
    val body = h1(heading) + "\n" + div(content)
    html5_document("en", head, body)

# Create page with stylesheet
fn page_with_css(title_text: text, css_href: text, content: text) -> text:
    val head = title(title_text) + "\n" + meta_charset("UTF-8") + "\n" + meta_viewport() + "\n" + link_stylesheet(css_href)
    html5_document("en", head, content)

# Create navigation menu
fn nav_menu(links: List<(text, text)>) -> text:
    var items = []
    for (href, text) in links:
        items.push(a(href, text))

    nav(ul(items))

# Create card component
fn card(title_text: text, content: text) -> text:
    div_with_class("card", h3(title_text) + "\n" + div(content))

# Create alert component
fn alert(type: text, message: text) -> text:
    div_with_class("alert alert-{type}", escape_html(message))
