# Test Database Integrity Validation
#
# This module provides data integrity checking for the test database,
# detecting stale/inconsistent test run data early in debug mode.
#
# Validation checks:
# 1. Stale runs - Running status >2 hours old
# 2. Dead processes - Running status but PID doesn't exist
# 3. Timestamp consistency - end_time > start_time, no future timestamps
# 4. Count consistency - passed+failed+crashed+timed_out ≤ test_count
# 5. Status consistency - Completed/Crashed must have end_time

use core.result.{Result, Ok, Err}
use std.path.Path

# Extern declarations for FFI functions
extern fn rt_test_db_validate(db_path: text) -> i64
extern fn rt_test_db_enable_validation(enabled: bool)
extern fn rt_test_run_is_stale(run_id: text, hours_threshold: i64) -> bool
extern fn rt_test_db_cleanup_stale_runs(db_path: text) -> i64

# Enable or disable database validation
pub fn enable_validation(enabled: bool):
    """Enable or disable test database validation.

    When enabled, sets SIMPLE_TEST_DEBUG=basic environment variable
    which triggers validation on database load.

    Args:
        enabled: True to enable validation, False to disable
    """
    rt_test_db_enable_validation(enabled)

# Validate test database and return violation count
pub fn validate_database(db_path: text) -> Result<i64, text>:
    """Validate test database for integrity violations.

    Performs comprehensive validation including:
    - Stale runs (running >2 hours)
    - Dead processes (PID doesn't exist)
    - Timestamp consistency
    - Count consistency
    - Status consistency

    Args:
        db_path: Path to test database file (e.g., "doc/test/test_db.sdn")

    Returns:
        Ok(count) - Number of violations found (0 = all clean)
        Err(msg) - Error message if validation failed

    Example:
        match validate_database("doc/test/test_db.sdn"):
            Ok(0): print "Database is clean!"
            Ok(n): print "Found {n} violations"
            Err(e): print "Validation error: {e}"
    """
    val result = rt_test_db_validate(db_path)

    if result < 0:
        Err("Failed to validate database")
    else:
        Ok(result)

# Check if a test run is stale
pub fn is_run_stale(run_id: text, hours_threshold: i64) -> bool:
    """Check if a test run has been running for too long.

    Args:
        run_id: Test run identifier
        hours_threshold: Number of hours after which run is considered stale

    Returns:
        True if run has been in 'running' state for > hours_threshold

    Note:
        Currently not fully implemented in interpreter mode.
        Returns false as a safe default.
    """
    rt_test_run_is_stale(run_id, hours_threshold)

# Cleanup stale test runs
pub fn cleanup_stale_runs(db_path: text) -> Result<i64, text>:
    """Cleanup stale test runs in the database.

    Marks runs as 'crashed' if:
    - Status is 'running' but >2 hours old
    - Status is 'running' but PID doesn't exist

    Args:
        db_path: Path to test database file

    Returns:
        Ok(count) - Number of runs cleaned up
        Err(msg) - Error message if cleanup failed

    Example:
        match cleanup_stale_runs("doc/test/test_db.sdn"):
            Ok(0): print "No stale runs found"
            Ok(n): print "Cleaned up {n} stale runs"
            Err(e): print "Cleanup error: {e}"
    """
    val result = rt_test_db_cleanup_stale_runs(db_path)

    if result < 0:
        Err("Failed to cleanup stale runs")
    else:
        Ok(result)

# Validate and report violations
pub fn validate_and_report(db_path: text):
    """Validate database and print a comprehensive report.

    This is a convenience function that:
    1. Enables validation
    2. Validates the database
    3. Prints a user-friendly report

    Args:
        db_path: Path to test database file

    Example:
        validate_and_report("doc/test/test_db.sdn")
    """
    enable_validation(true)

    match validate_database(db_path):
        Ok(0):
            print "✓ Database validation passed - no violations found"
        Ok(count):
            print "⚠ Found {count} integrity violation(s)"
            print "Run with SIMPLE_TEST_DEBUG=basic to see details"
        Err(msg):
            print "✗ Validation error: {msg}"

# Cleanup and report
pub fn cleanup_and_report(db_path: text):
    """Cleanup stale runs and print a report.

    Args:
        db_path: Path to test database file

    Example:
        cleanup_and_report("doc/test/test_db.sdn")
    """
    match cleanup_stale_runs(db_path):
        Ok(0):
            print "✓ No stale runs found"
        Ok(count):
            print "✓ Cleaned up {count} stale run(s)"
        Err(msg):
            print "✗ Cleanup error: {msg}"

# Default test database path
pub val DEFAULT_TEST_DB_PATH = "doc/test/test_db.sdn"

# Quick validation of default database
pub fn validate_default() -> Result<i64, text>:
    """Validate the default test database at doc/test/test_db.sdn.

    Returns:
        Ok(count) - Number of violations found
        Err(msg) - Error message if validation failed
    """
    validate_database(DEFAULT_TEST_DB_PATH)

# Quick cleanup of default database
pub fn cleanup_default() -> Result<i64, text>:
    """Cleanup stale runs in the default test database.

    Returns:
        Ok(count) - Number of runs cleaned up
        Err(msg) - Error message if cleanup failed
    """
    cleanup_stale_runs(DEFAULT_TEST_DB_PATH)

# Validation configuration
pub class ValidationConfig:
    """Configuration for database validation behavior."""

    pub auto_validate: bool        # Validate on database load
    pub auto_cleanup: bool          # Auto-cleanup stale runs
    pub hours_threshold: i64        # Hours before run is stale

    pub fn new() -> ValidationConfig:
        """Create default validation configuration."""
        ValidationConfig {
            auto_validate: true,
            auto_cleanup: false,
            hours_threshold: 2
        }

    pub fn with_auto_validate(self, enabled: bool) -> ValidationConfig:
        """Set auto-validate flag (fluent API)."""
        self.auto_validate = enabled
        self

    pub fn with_auto_cleanup(self, enabled: bool) -> ValidationConfig:
        """Set auto-cleanup flag (fluent API)."""
        self.auto_cleanup = enabled
        self

    pub fn with_threshold(self, hours: i64) -> ValidationConfig:
        """Set stale threshold in hours (fluent API)."""
        self.hours_threshold = hours
        self

    pub fn apply(self):
        """Apply this configuration to the environment."""
        if self.auto_validate:
            enable_validation(true)

        if self.auto_cleanup:
            std.env.set("SIMPLE_TEST_AUTO_CLEANUP", "1")

        if self.hours_threshold != 2:
            std.env.set("SIMPLE_TEST_STALE_THRESHOLD", self.hours_threshold.to_string())
