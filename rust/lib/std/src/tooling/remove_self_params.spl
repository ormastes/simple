# Simple Language Syntax Migration Tool - remove self parameters
# Migrated from: scripts/remove_self_params.py
# Purpose: Remove explicit self parameters from method signatures

use fs.{read_text, write_text, create_dir, basename, join}
use regex.{replace_all}

# use time_utils.{migration_backup_dir}  # TODO: Import time utils module
# use file_utils.{find_spl_files, count_changed_lines}  # TODO: Import file utils module

# Migration statistics
struct RemoveSelfStats:
    files_processed: u64
    files_modified: u64
    lines_changed: u64
    backup_dir: text

impl RemoveSelfStats:
    # Create empty stats
    static fn new(backup_dir: text) -> RemoveSelfStats:
        RemoveSelfStats(
            files_processed: 0,
            files_modified: 0,
            lines_changed: 0,
            backup_dir: backup_dir
        )

    # Record processed file
    me add_processed():
        self.files_processed = self.files_processed + 1

    # Record modified file
    me add_modified(lines: u64):
        self.files_modified = self.files_modified + 1
        self.lines_changed = self.lines_changed + lines

    # Generate summary report
    fn summary() -> text:
        var report = ""
        report = report + "=== Migration Complete ===\n"
        report = report + "Files processed: {self.files_processed}\n"
        report = report + "Files modified: {self.files_modified}\n"
        report = report + "Lines changed: {self.lines_changed}\n"
        report = report + "Backups saved to: {self.backup_dir}\n"
        report

# File migration result
struct MigrationResult:
    modified: bool
    lines_changed: u64
    error: text

impl MigrationResult:
    # No changes made
    static fn unchanged() -> MigrationResult:
        MigrationResult(
            modified: false,
            lines_changed: 0,
            error: ""
        )

    # Changes made successfully
    static fn changed(lines: u64) -> MigrationResult:
        MigrationResult(
            modified: true,
            lines_changed: lines,
            error: ""
        )

    # Error occurred
    static fn error(message: text) -> MigrationResult:
        MigrationResult(
            modified: false,
            lines_changed: 0,
            error: message
        )

# Remove self parameters from method signatures
fn migrate_remove_self_content(content: text) -> text:
    # Transformations (ORDER MATTERS!):
    # 1. method(self) -> method()        (MUST come before method(self, ...))
    # 2. method(self, params) -> method(params)

    var result = content

    # Pattern 1: method(self) -> method() (no trailing comma)
    # Matches: "  me method(self) ->" or "  fn method(self):"
    result = replace_all(r"(\s*(?:me|fn)\s+\w+)\s*\(\s*self\s*\)", result, "$1()")

    # Pattern 2: method(self, params) -> method(params) (with trailing comma)
    # Matches: "  me method(self, x: i64)" or "  fn method(self, x: i64)"
    result = replace_all(r"(\s*(?:me|fn)\s+\w+)\s*\(\s*self\s*,\s*", result, "$1(")

    result

# Migrate a single file
fn migrate_remove_self_file(filepath: text, backup_dir: text) -> MigrationResult:
    # Read file content
    match read_text(filepath):
        Ok(content):
            # Remove self parameters
            val migrated = migrate_remove_self_content(content)

            # Check if anything changed
            if migrated == content:
                return MigrationResult.unchanged()

            # Backup original to backup_dir
            val file_name = basename(filepath)
            val backup_path = join([backup_dir, file_name])

            match write_text(backup_path, content):
                Ok(_):
                    # Write migrated content
                    match write_text(filepath, migrated):
                        Ok(_):
                            # Count changed lines accurately
                            val changed = count_changed_lines(content, migrated)
                            MigrationResult.changed(changed)
                        Err(e):
                            MigrationResult.error("Failed to write migrated file: {e}")
                Err(e):
                    MigrationResult.error("Failed to backup file: {e}")
        Err(e):
            MigrationResult.error("Failed to read file: {e}")

# Note: find_spl_files is now imported from file_utils
# It automatically filters out target, .git, .migration_backup directories

# Run migration on all .spl files
fn run_remove_self_migration(root_dir: text) -> RemoveSelfStats:
    # Create backup directory with timestamp
    val backup_dir = migration_backup_dir("remove_self")
    var stats = RemoveSelfStats.new(backup_dir)

    # Create backup directory
    match create_dir(backup_dir, true):
        Ok(_):
            # Find all .spl files
            val files = find_spl_files(root_dir)

            # Process each file
            var i = 0
            while i < files.len():
                val filepath = files[i]
                stats.add_processed()

                val result = migrate_remove_self_file(filepath, backup_dir)
                if result.modified:
                    stats.add_modified(result.lines_changed)
                    print "Migrated: {filepath}"
                elif not result.error.is_empty():
                    print "Error processing {filepath}: {result.error}"

                i = i + 1
        Err(e):
            print "Error creating backup directory: {e}"

    stats

# Syntax transformation patterns (for documentation)
struct RemoveSelfPattern:
    order: u64
    name: text
    description: text
    before: text
    after: text

impl RemoveSelfPattern:
    # Create a transformation pattern
    static fn new(order: u64, name: text, desc: text, before: text, after: text) -> RemoveSelfPattern:
        RemoveSelfPattern(
            order: order,
            name: name,
            description: desc,
            before: before,
            after: after
        )

# Get all transformation patterns
fn get_remove_self_patterns() -> List<RemoveSelfPattern>:
    [
        RemoveSelfPattern.new(
            1,
            "remove_self_only",
            "Remove self from method(self)",
            "me method(self) ->",
            "me method() ->"
        ),
        RemoveSelfPattern.new(
            2,
            "remove_self_with_params",
            "Remove self from method(self, params)",
            "fn method(self, x: i64) ->",
            "fn method(x: i64) ->"
        )
    ]

# Print transformation examples
fn print_remove_self_examples() -> text:
    var output = ""
    output = output + "=== Remove Self Parameters Migration Patterns ===\n\n"
    output = output + "⚠️  ORDER MATTERS! Transformations must run in sequence:\n\n"

    val patterns = get_remove_self_patterns()
    var i = 0
    while i < patterns.len():
        val pattern = patterns[i]
        output = output + "{pattern.order}. {pattern.name}\n"
        output = output + "   {pattern.description}\n"
        output = output + "   Before: {pattern.before}\n"
        output = output + "   After:  {pattern.after}\n\n"
        i = i + 1

    output

# CLI options for remove_self_params command
struct RemoveSelfOptions:
    dry_run: bool
    backup_dir: Option<text>
    root_dir: text
    show_help: bool

impl RemoveSelfOptions:
    # Create default options
    static fn default() -> RemoveSelfOptions:
        RemoveSelfOptions(
            dry_run: false,
            backup_dir: None,
            root_dir: ".",
            show_help: false
        )

    # Parse CLI arguments
    static fn parse(args: List<text>) -> RemoveSelfOptions:
        var options = RemoveSelfOptions.default()
        var i = 0

        while i < args.len():
            val arg = args[i]

            if arg == "--dry-run" or arg == "-n":
                options.dry_run = true
            elif arg == "--backup-dir" and i + 1 < args.len():
                i = i + 1
                options.backup_dir = Some(args[i])
            elif arg == "--help" or arg == "-h":
                options.show_help = true
            elif not arg.starts_with("-"):
                # Positional argument: root directory
                options.root_dir = arg

            i = i + 1

        options

# Print usage help for remove_self_params
fn print_remove_self_help() -> text:
    var help = ""
    help = help + "Usage: simple remove-self-params [OPTIONS] [ROOT_DIR]\n\n"
    help = help + "Remove explicit self parameters from method signatures.\n\n"
    help = help + "Arguments:\n"
    help = help + "  ROOT_DIR         Directory to migrate (default: current directory)\n\n"
    help = help + "Options:\n"
    help = help + "  -n, --dry-run    Preview changes without writing files\n"
    help = help + "  --backup-dir     Custom backup directory for original files\n"
    help = help + "  -h, --help       Show this help message\n\n"
    help = help + "Examples:\n"
    help = help + "  simple remove-self-params                    # Migrate current directory\n"
    help = help + "  simple remove-self-params src/               # Migrate src/ directory\n"
    help = help + "  simple remove-self-params --dry-run src/     # Preview changes only\n"
    help

# Main entry point
fn main_remove_self_params(args: List<text>) -> Result<(), text>:
    val options = RemoveSelfOptions.parse(args)

    # Show help if requested
    if options.show_help:
        print print_remove_self_help()
        return Ok(())

    # Show what we're doing
    if options.dry_run:
        print "=== Dry Run Mode - No files will be modified ===\n"

    print "Removing self parameters in: {options.root_dir}"

    # Run the migration
    val stats = run_remove_self_migration(options.root_dir)

    # Print summary
    print stats.summary()

    # Print transformation patterns for reference
    if options.dry_run:
        print print_remove_self_examples()

    Ok(())
