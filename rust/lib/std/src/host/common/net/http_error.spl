# HTTP Error Types
# Extracted from types.spl

use core.traits.*

pub enum HttpError:
    ConnectionFailed(IoError)
    Timeout
    InvalidUrl
    TooManyRedirects
    InvalidResponse
    InvalidHeader
    BodyTooLarge
    Cancelled
    TlsError(str)
    Other(str)

use host.common.io.error.IoError

impl HttpError:
    pub fn message(self) -> str:
        match self:
            case ConnectionFailed(e): return "connection failed: {e.message()}"
            case Timeout: return "request timed out"
            case InvalidUrl: return "invalid URL"
            case TooManyRedirects: return "too many redirects"
            case InvalidResponse: return "invalid response"
            case InvalidHeader: return "invalid header"
            case BodyTooLarge: return "response body too large"
            case Cancelled: return "request cancelled"
            case TlsError(msg): return "TLS error: {msg}"
            case Other(msg): return msg

impl Display for HttpError:
    fn fmt() -> str:
        self.message()

    # =========================================================================
    # Helper Methods
    # =========================================================================

    pub fn is_connection_failed(self) -> bool:
        """Check if error is ConnectionFailed.

        Returns:
            True if ConnectionFailed
        """
        match self:
            case ConnectionFailed(_): true
            case _: false

    pub fn is_timeout(self) -> bool:
        """Check if error is Timeout.

        Returns:
            True if Timeout
        """
        match self:
            case Timeout: true
            case _: false

    pub fn is_invalid_url(self) -> bool:
        """Check if error is InvalidUrl.

        Returns:
            True if InvalidUrl
        """
        match self:
            case InvalidUrl: true
            case _: false

    pub fn is_tls_error(self) -> bool:
        """Check if error is TlsError.

        Returns:
            True if TlsError
        """
        match self:
            case TlsError(_): true
            case _: false

    pub fn is_network_error(self) -> bool:
        """Check if error is network-related.

        Returns:
            True if ConnectionFailed, Timeout, or TlsError
        """
        match self:
            case ConnectionFailed(_): true
            case Timeout: true
            case TlsError(_): true
            case _: false

    pub fn is_protocol_error(self) -> bool:
        """Check if error is protocol-related.

        Returns:
            True if InvalidResponse, InvalidHeader, BodyTooLarge
        """
        match self:
            case InvalidResponse: true
            case InvalidHeader: true
            case BodyTooLarge: true
            case _: false

    pub fn is_retryable(self) -> bool:
        """Check if error might be retryable.

        Returns:
            True if Timeout or ConnectionFailed
        """
        match self:
            case Timeout: true
            case ConnectionFailed(_): true
            case _: false

    pub fn to_string(self) -> text:
        """Convert HTTP error to string.

        Returns:
            Error type name

        Example:
            HttpError.Timeout.to_string()  # → "timeout"
        """
        match self:
            case ConnectionFailed(_): "connection-failed"
            case Timeout: "timeout"
            case InvalidUrl: "invalid-url"
            case TooManyRedirects: "too-many-redirects"
            case InvalidResponse: "invalid-response"
            case InvalidHeader: "invalid-header"
            case BodyTooLarge: "body-too-large"
            case Cancelled: "cancelled"
            case TlsError(_): "tls-error"
            case Other(_): "other"

    pub fn description(self) -> text:
        """Get HTTP error description.

        Returns:
            Human-readable description

        Example:
            HttpError.Timeout.description()
            # → "Request operation timed out"
        """
        match self:
            case ConnectionFailed(_): "Failed to establish connection"
            case Timeout: "Request operation timed out"
            case InvalidUrl: "URL format is invalid"
            case TooManyRedirects: "Too many redirects encountered"
            case InvalidResponse: "Server response is invalid"
            case InvalidHeader: "HTTP header is malformed"
            case BodyTooLarge: "Response body exceeds size limit"
            case Cancelled: "Request was cancelled"
            case TlsError(_): "TLS/SSL error occurred"
            case Other(_): "Other HTTP error"

    pub fn summary(self) -> str:
        """Get summary of HTTP error.

        Returns:
            Human-readable summary

        Example:
            HttpError.Timeout.summary()
            # → "HttpError: request timed out (retryable)"
        """
        val msg = self.message()
        val props = []
        if self.is_retryable():
            props.push("retryable")
        if self.is_network_error():
            props.push("network")
        if self.is_protocol_error():
            props.push("protocol")
        val props_str = if props.len() > 0: " ({props.join(\", \")})" else: ""
        return "HttpError: {msg}{props_str}"

impl Error for HttpError

# Network error types
