# Network Error Types
# Extracted from types.spl

use core.traits.*

pub enum NetError:
    IoError(message: text)
    AddrParseError(message: text)
    ConnectionRefused
    ConnectionReset
    TimedOut
    WouldBlock
    NotConnected
    AlreadyConnected
    InvalidData
    PermissionDenied

impl NetError:
    # Convert from error code
    pub fn from_code(code: i64) -> NetError:
        match code:
            case -1: return NetError.IoError("I/O operation failed")
            case -2: return NetError.ConnectionRefused
            case -3: return NetError.ConnectionReset
            case -4: return NetError.TimedOut
            case -5: return NetError.WouldBlock
            case -6: return NetError.NotConnected
            case -7: return NetError.AlreadyConnected
            case -8: return NetError.InvalidData
            case -9: return NetError.PermissionDenied
            case _: return NetError.IoError("Unknown error")

    # Convert to string message
    pub fn to_string(self) -> text:
        match self:
            case NetError.IoError(msg): return msg
            case NetError.AddrParseError(msg): return "Address parse error: {msg}"
            case NetError.ConnectionRefused: return "Connection refused"
            case NetError.ConnectionReset: return "Connection reset"
            case NetError.TimedOut: return "Operation timed out"
            case NetError.WouldBlock: return "Operation would block"
            case NetError.NotConnected: return "Not connected"
            case NetError.AlreadyConnected: return "Already connected"
            case NetError.InvalidData: return "Invalid data"
            case NetError.PermissionDenied: return "Permission denied"

impl Display for NetError:
    fn fmt() -> str:
        self.to_string()

    # =========================================================================
    # Helper Methods
    # =========================================================================

    pub fn is_io_error(self) -> bool:
        """Check if error is IoError.

        Returns:
            True if IoError
        """
        match self:
            case IoError(_): true
            case _: false

    pub fn is_connection_refused(self) -> bool:
        """Check if error is ConnectionRefused.

        Returns:
            True if ConnectionRefused
        """
        match self:
            case ConnectionRefused: true
            case _: false

    pub fn is_connection_reset(self) -> bool:
        """Check if error is ConnectionReset.

        Returns:
            True if ConnectionReset
        """
        match self:
            case ConnectionReset: true
            case _: false

    pub fn is_timed_out(self) -> bool:
        """Check if error is TimedOut.

        Returns:
            True if TimedOut
        """
        match self:
            case TimedOut: true
            case _: false

    pub fn is_would_block(self) -> bool:
        """Check if error is WouldBlock.

        Returns:
            True if WouldBlock
        """
        match self:
            case WouldBlock: true
            case _: false

    pub fn is_not_connected(self) -> bool:
        """Check if error is NotConnected.

        Returns:
            True if NotConnected
        """
        match self:
            case NotConnected: true
            case _: false

    pub fn is_permission_denied(self) -> bool:
        """Check if error is PermissionDenied.

        Returns:
            True if PermissionDenied
        """
        match self:
            case PermissionDenied: true
            case _: false

    pub fn is_connection_error(self) -> bool:
        """Check if error is connection-related.

        Returns:
            True if ConnectionRefused, ConnectionReset, or NotConnected
        """
        match self:
            case ConnectionRefused: true
            case ConnectionReset: true
            case NotConnected: true
            case _: false

    pub fn is_transient(self) -> bool:
        """Check if error is transient (temporary).

        Returns:
            True if WouldBlock or TimedOut
        """
        match self:
            case WouldBlock: true
            case TimedOut: true
            case _: false

    pub fn is_retryable(self) -> bool:
        """Check if error might be retryable.

        Returns:
            True if transient or ConnectionRefused
        """
        match self:
            case WouldBlock: true
            case TimedOut: true
            case ConnectionRefused: true
            case _: false

    pub fn is_fatal(self) -> bool:
        """Check if error is likely fatal (non-retryable).

        Returns:
            True if PermissionDenied or InvalidData
        """
        match self:
            case PermissionDenied: true
            case InvalidData: true
            case _: false

    pub fn description(self) -> text:
        """Get network error description.

        Returns:
            Human-readable description

        Example:
            NetError.TimedOut.description()
            # → "Network operation timed out"
        """
        match self:
            case IoError(_): "Low-level I/O error"
            case AddrParseError(_): "Failed to parse network address"
            case ConnectionRefused: "Connection refused by remote host"
            case ConnectionReset: "Connection reset by peer"
            case TimedOut: "Network operation timed out"
            case WouldBlock: "Operation would block (non-blocking mode)"
            case NotConnected: "Socket is not connected"
            case AlreadyConnected: "Socket is already connected"
            case InvalidData: "Invalid network data received"
            case PermissionDenied: "Permission denied for network operation"

    pub fn summary(self) -> text:
        """Get summary of network error.

        Returns:
            Human-readable summary

        Example:
            NetError.TimedOut.summary()
            # → "NetError: Operation timed out (transient, retryable)"
        """
        val msg = self.to_string()
        val props = []
        if self.is_transient():
            props.push("transient")
        if self.is_retryable():
            props.push("retryable")
        if self.is_fatal():
            props.push("fatal")
        if self.is_connection_error():
            props.push("connection")
        val props_str = if props.len() > 0: " ({props.join(\", \")})" else: ""
        return "NetError: {msg}{props_str}"

impl Error for NetError
