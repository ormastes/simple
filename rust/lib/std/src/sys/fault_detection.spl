# Fault Detection System Library
#
# Provides runtime fault detection configuration:
# - Stack overflow detection (recursion depth limits)
# - Wall-clock timeout detection
# - Execution instruction limit
#
# All features are toggleable at runtime via this API.

# FFI declarations (bridge to Rust runtime)
extern fn rt_fault_set_stack_overflow_detection(enabled: bool)
extern fn rt_fault_set_max_recursion_depth(depth: i64)
extern fn rt_fault_set_timeout(secs: i64)
extern fn rt_fault_set_execution_limit(limit: i64)

# Default configuration values
val DEFAULT_MAX_RECURSION_DEPTH = 1000
val DEFAULT_EXECUTION_LIMIT = 10000000
val DEFAULT_TIMEOUT = 0


struct FaultConfig:
    """
    Configuration for runtime fault detection.

    All fields default to safe values. Use FaultConfig.defaults() or
    FaultConfig.strict() for preset configurations.
    """
    stack_overflow_enabled: bool
    max_recursion_depth: i64
    timeout_secs: i64
    execution_limit: i64

impl FaultConfig:
    static fn defaults() -> FaultConfig:
        """Create config with default values (stack overflow on, no timeout)."""
        FaultConfig(
            stack_overflow_enabled: true,
            max_recursion_depth: DEFAULT_MAX_RECURSION_DEPTH,
            timeout_secs: DEFAULT_TIMEOUT,
            execution_limit: DEFAULT_EXECUTION_LIMIT)

    static fn strict() -> FaultConfig:
        """Create strict config: lower limits, timeout enabled."""
        FaultConfig(
            stack_overflow_enabled: true,
            max_recursion_depth: 500,
            timeout_secs: 30,
            execution_limit: 5000000)

    static fn permissive() -> FaultConfig:
        """Create permissive config: higher limits, no timeout."""
        FaultConfig(
            stack_overflow_enabled: true,
            max_recursion_depth: 10000,
            timeout_secs: 0,
            execution_limit: 100000000)

    static fn disabled() -> FaultConfig:
        """Create config with all detection disabled."""
        FaultConfig(
            stack_overflow_enabled: false,
            max_recursion_depth: 0,
            timeout_secs: 0,
            execution_limit: 0)

    fn apply():
        """Apply this configuration to the runtime."""
        apply_config(self)

    fn with_timeout(secs: i64) -> FaultConfig:
        """Return a copy with a different timeout."""
        FaultConfig(
            stack_overflow_enabled: self.stack_overflow_enabled,
            max_recursion_depth: self.max_recursion_depth,
            timeout_secs: secs,
            execution_limit: self.execution_limit)

    fn with_max_depth(depth: i64) -> FaultConfig:
        """Return a copy with a different max recursion depth."""
        FaultConfig(
            stack_overflow_enabled: self.stack_overflow_enabled,
            max_recursion_depth: depth,
            timeout_secs: self.timeout_secs,
            execution_limit: self.execution_limit)

    fn with_execution_limit(limit: i64) -> FaultConfig:
        """Return a copy with a different execution limit."""
        FaultConfig(
            stack_overflow_enabled: self.stack_overflow_enabled,
            max_recursion_depth: self.max_recursion_depth,
            timeout_secs: self.timeout_secs,
            execution_limit: limit)


fn apply_config(config: FaultConfig):
    """Apply a FaultConfig to the runtime."""
    rt_fault_set_stack_overflow_detection(config.stack_overflow_enabled)
    if config.max_recursion_depth > 0:
        rt_fault_set_max_recursion_depth(config.max_recursion_depth)
    if config.timeout_secs > 0:
        rt_fault_set_timeout(config.timeout_secs)
    else:
        rt_fault_set_timeout(0)
    if config.execution_limit > 0:
        rt_fault_set_execution_limit(config.execution_limit)


fn enable_stack_overflow_detection():
    """Enable stack overflow detection with default depth."""
    rt_fault_set_stack_overflow_detection(true)
    rt_fault_set_max_recursion_depth(DEFAULT_MAX_RECURSION_DEPTH)

fn disable_stack_overflow_detection():
    """Disable stack overflow detection."""
    rt_fault_set_stack_overflow_detection(false)

fn set_recursion_limit(depth: i64):
    """Set max recursion depth and enable detection."""
    rt_fault_set_stack_overflow_detection(true)
    rt_fault_set_max_recursion_depth(depth)

fn set_timeout(secs: i64):
    """Set wall-clock timeout in seconds. 0 disables."""
    rt_fault_set_timeout(secs)

fn set_execution_limit(limit: i64):
    """Set instruction count limit. 0 disables."""
    rt_fault_set_execution_limit(limit)

fn reset_defaults():
    """Reset all fault detection to default values."""
    FaultConfig.defaults().apply()
