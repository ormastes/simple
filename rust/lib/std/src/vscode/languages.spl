# VSCode Languages API
# Register language feature providers

# External FFI declarations
extern fn vscode_languages_register_completion(language: text, callback_id: i64): i64
extern fn vscode_languages_register_hover(language: text, callback_id: i64): i64
extern fn vscode_languages_register_definition(language: text, callback_id: i64): i64
extern fn vscode_languages_register_code_actions(language: text, callback_id: i64): i64
extern fn vscode_languages_create_diagnostic_collection(name: text): i64
extern fn vscode_languages_set_diagnostics(collection_id: i64, uri: text, diagnostics_json: text): void

# Provider callback storage
var _completion_callbacks: Dict<i64, fn(TextDocument, Position): List<CompletionItem>> = {}
var _hover_callbacks: Dict<i64, fn(TextDocument, Position): Option<Hover>> = {}
var _definition_callbacks: Dict<i64, fn(TextDocument, Position): Option<Range>> = {}
var _next_callback_id: i64 = 0

# Document and Position types
pub class TextDocument:
    pub uri: text
    pub language_id: text
    pub version: i32
    pub line_count: i32

    pub fn new(): TextDocument =
        TextDocument {
            uri: "",
            language_id: "",
            version: 0,
            line_count: 0
        }

    pub fn line_at(self, line: i32): TextLine =
        """Get text line at index."""
        # FFI call to get line
        TextLine {
            line_number: line,
            text: "",
            range: Range.new(Position.new(line, 0), Position.new(line, 0))
        }

    pub fn get_text(self): text =
        """Get full document text."""
        # FFI call
        ""

    pub fn get_word_range_at_position(self, position: Position): Option<Range> =
        """Get range of word at position."""
        # FFI call
        none

pub class TextLine:
    pub line_number: i32
    pub text: text
    pub range: Range

pub class Position:
    pub line: i32
    pub character: i32

    pub fn new(line: i32, character: i32): Position =
        Position {line: line, character: character}

pub class Range:
    pub start: Position
    pub end: Position

    pub fn new(start: Position, end: Position): Range =
        Range {start: start, end: end}

# Completion items
pub class CompletionItem:
    pub label: text
    pub kind: i32
    pub detail: text
    pub documentation: text
    pub insert_text: text

    pub fn new(label: text, kind: i32): CompletionItem =
        """Create completion item.

        Kinds:
        - 0: Text
        - 1: Method
        - 2: Function
        - 3: Constructor
        - 4: Field
        - 5: Variable
        - 6: Class
        - 7: Interface
        - 8: Module
        - 9: Property
        - 10: Unit
        - 11: Value
        - 12: Enum
        - 13: Keyword
        - 14: Snippet
        """
        CompletionItem {
            label: label,
            kind: kind,
            detail: "",
            documentation: "",
            insert_text: label
        }

pub val CompletionItemKind_Text: i32 = 0
pub val CompletionItemKind_Method: i32 = 1
pub val CompletionItemKind_Function: i32 = 2
pub val CompletionItemKind_Constructor: i32 = 3
pub val CompletionItemKind_Field: i32 = 4
pub val CompletionItemKind_Variable: i32 = 5
pub val CompletionItemKind_Class: i32 = 6
pub val CompletionItemKind_Interface: i32 = 7
pub val CompletionItemKind_Module: i32 = 8
pub val CompletionItemKind_Property: i32 = 9
pub val CompletionItemKind_Keyword: i32 = 13
pub val CompletionItemKind_Snippet: i32 = 14

# Hover information
pub class Hover:
    pub contents: text  # Markdown string
    pub range: Option<Range>

    pub fn new(contents: text): Hover =
        """Create hover information."""
        Hover {
            contents: contents,
            range: none
        }

# Diagnostic (error/warning)
pub class Diagnostic:
    pub range: Range
    pub message: text
    pub severity: i32
    pub source: text
    pub code: text

    pub fn new(range: Range, message: text, severity: i32): Diagnostic =
        """Create diagnostic.

        Severity:
        - 0: Error
        - 1: Warning
        - 2: Information
        - 3: Hint
        """
        Diagnostic {
            range: range,
            message: message,
            severity: severity,
            source: "",
            code: ""
        }

pub val DiagnosticSeverity_Error: i32 = 0
pub val DiagnosticSeverity_Warning: i32 = 1
pub val DiagnosticSeverity_Information: i32 = 2
pub val DiagnosticSeverity_Hint: i32 = 3

# Diagnostic collection
pub class DiagnosticCollection:
    pub id: i64
    pub name: text

    pub fn new(name: text): DiagnosticCollection =
        """Create diagnostic collection."""
        val id = vscode_languages_create_diagnostic_collection(name)
        DiagnosticCollection {
            id: id,
            name: name
        }

    pub fn set(self, uri: text, diagnostics: List<Diagnostic>):
        """Set diagnostics for a file."""
        # Serialize diagnostics to JSON
        val diagnostics_json = _serialize_diagnostics(diagnostics)
        vscode_languages_set_diagnostics(self.id, uri, diagnostics_json)

    pub fn clear(self):
        """Clear all diagnostics."""
        # FFI call
        pass

    pub fn dispose(self):
        """Dispose collection."""
        # FFI call
        pass

# Completion provider
pub fn register_completion_provider(
    language: text,
    provider: fn(document: TextDocument, position: Position): List<CompletionItem>
): i64 =
    """Register completion provider.

    Example:
        languages.register_completion_provider("simple", fn(doc, pos):
            return [
                CompletionItem.new("fn", CompletionItemKind_Keyword),
                CompletionItem.new("val", CompletionItemKind_Keyword)
            ]
        )
    """
    # Store provider callback
    val callback_id = _next_callback_id
    _next_callback_id = _next_callback_id + 1
    _completion_callbacks[callback_id] = provider
    vscode_languages_register_completion(language, callback_id)

# Hover provider
pub fn register_hover_provider(
    language: text,
    provider: fn(document: TextDocument, position: Position): Option<Hover>
): i64 =
    """Register hover provider."""
    val callback_id = 0
    vscode_languages_register_hover(language, callback_id)

# Definition provider
pub fn register_definition_provider(
    language: text,
    provider: fn(document: TextDocument, position: Position): Option<Range>
): i64 =
    """Register definition provider."""
    val callback_id = 0
    vscode_languages_register_definition(language, callback_id)

# Helper: Serialize diagnostics to JSON
fn _serialize_diagnostics(diagnostics: List<Diagnostic>): text =
    """Convert diagnostics to JSON array."""
    val parts: List<text> = []

    for diag in diagnostics:
        val json = '{'
        json = json + '"range":{"start":{"line":' + diag.range.start.line.to_string()
        json = json + ',"character":' + diag.range.start.character.to_string() + '}'
        json = json + ',"end":{"line":' + diag.range.end.line.to_string()
        json = json + ',"character":' + diag.range.end.character.to_string() + '}}'
        json = json + ',"message":"' + diag.message + '"'
        json = json + ',"severity":' + diag.severity.to_string()
        json = json + ',"source":"' + diag.source + '"'
        json = json + ',"code":"' + diag.code + '"'
        json = json + '}'
        parts.append(json)

    "[" + parts.join(",") + "]"
