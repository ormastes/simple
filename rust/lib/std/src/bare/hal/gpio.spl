# GPIO - General Purpose Input/Output HAL
#
# Hardware abstraction layer for GPIO pins.

# Pin mode enumeration
enum PinMode:
    Input
    Output
    InputPullUp
    InputPullDown
    OpenDrain
    Alternate(u8)  # Alternate function number

# Pin state
enum PinState:
    Low
    High

# Edge trigger mode for interrupts
enum EdgeTrigger:
    Rising
    Falling
    Both

# GPIO Pin abstraction
trait GpioPin:
    # Get pin number
    fn pin() -> u8

    # Get port number (if applicable)
    fn port() -> u8

    # Configure pin mode
    me set_mode(mode: PinMode)

    # Read pin state
    fn read() -> PinState

    # Write pin state (for output pins)
    me write(state: PinState)

    # Toggle pin state
    me toggle()

    # Check if pin is high
    fn is_high() -> bool:
        match self.read():
            PinState.High: return true
            PinState.Low: return false

    # Check if pin is low
    fn is_low() -> bool:
        return not self.is_high()

    # Set pin high
    me set_high():
        self.write(PinState.High)

    # Set pin low
    me set_low():
        self.write(PinState.Low)

# GPIO Port abstraction (group of pins)
trait GpioPort:
    # Get port number
    fn port() -> u8

    # Get number of pins
    fn pin_count() -> u8

    # Read all pins as bitmask
    fn read_all() -> u32

    # Write all pins from bitmask
    me write_all(value: u32)

    # Set specific pins (OR with current)
    me set_bits(mask: u32)

    # Clear specific pins (AND with inverse)
    me clear_bits(mask: u32)

    # Toggle specific pins (XOR)
    me toggle_bits(mask: u32)

# Generic GPIO implementation (platform-specific)
struct GenericGpioPin:
    port_num: u8
    pin_num: u8
    base_addr: usize

    static fn new(port: u8, pin: u8, base: usize) -> GenericGpioPin:
        return GenericGpioPin(port_num: port, pin_num: pin, base_addr: base)

impl GenericGpioPin: GpioPin:
    fn pin() -> u8:
        return self.pin_num

    fn port() -> u8:
        return self.port_num

    me set_mode(mode: PinMode):
        # Platform-specific implementation
        pass

    fn read() -> PinState:
        # Platform-specific implementation
        return PinState.Low

    me write(state: PinState):
        # Platform-specific implementation
        pass

    me toggle():
        match self.read():
            PinState.High: self.write(PinState.Low)
            PinState.Low: self.write(PinState.High)

# Interrupt handler type
type GpioInterruptHandler = fn(u8, u8) -> ()  # (port, pin)

# Enable GPIO interrupt
fn enable_interrupt(port: u8, pin: u8, trigger: EdgeTrigger, handler: GpioInterruptHandler):
    # Platform-specific implementation
    pass

# Disable GPIO interrupt
fn disable_interrupt(port: u8, pin: u8):
    # Platform-specific implementation
    pass

export PinMode, PinState, EdgeTrigger
export GpioPin, GpioPort, GenericGpioPin
export enable_interrupt, disable_interrupt, GpioInterruptHandler
