# #1280: Coverage overlay integration
# =============================================================================

pub fn add_coverage_overlay(output: &mut McpOutput, coverage: &CoverageData) -> Result<(), McpError>:
    for item in &mut output.items:
        if val Some(cov) = coverage.get_coverage(&item.metadata.location):
            item.metadata.add_overlay("coverage", format!("{}%", cov.percentage))
    return Ok(())

struct CoverageData:
    file_coverage: Dict<text, FileCoverage>

impl CoverageData:
    fn get_coverage(loc: &SourceLocation) -> Option<Coverage>:
        return None

struct FileCoverage:
    lines: Dict<u32, Coverage>

struct Coverage:
    hits: u64
    percentage: f32

# =============================================================================
# #1281: Block guide markers
# =============================================================================

pub fn add_block_guides(output: &mut McpOutput) -> Result<(), McpError>:
    for item in &mut output.items:
        if not item.children.is_empty():
            # Add "end" marker
            val marker = match item.kind:
                case ItemKind.Function: "V• end"
                case ItemKind.Struct: "V• end"
                case ItemKind.Enum: "V• end"
                case _: ""

            if not marker.is_empty():
                item.children.push(McpItem {
                    kind: ItemKind.Marker,
                    line: marker.to_string(),
                    children: [],
                    metadata: McpMetadata.empty()
                })
    return Ok(())

# =============================================================================
# #1282: Line number formatting
# =============================================================================

pub fn format_with_line_numbers(output: &McpOutput, format: LineNumberFormat) -> text:
    var result = text.new()
    val width = match format:
        case LineNumberFormat.Plain: 0
        case LineNumberFormat.ZeroPadded(w): w

    for item in &output.items:
        val line_num = item.metadata.location.line
        val line_str = if width > 0:
            format!("{:0width$} ", line_num)
        else:
            format!("{} ", line_num)

        result.push_str(&line_str)
        result.push_str(&item.line)
        result.push('\n')

    return result

pub enum LineNumberFormat:
    Plain
    ZeroPadded(u8)

impl LineNumberFormat:
    # =========================================================================
    # Helper Methods
    # =========================================================================

    fn is_plain() -> bool:
        """Check if format is Plain.

        Returns:
            true for Plain

        Example:
            LineNumberFormat.Plain.is_plain()  # → true
        """
        match self:
            case Plain: true
            case _: false

    fn is_zero_padded() -> bool:
        """Check if format is ZeroPadded.

        Returns:
            true for ZeroPadded

        Example:
            LineNumberFormat.ZeroPadded(4).is_zero_padded()  # → true
        """
        match self:
            case ZeroPadded(_): true
            case _: false

    fn get_width() -> u8:
        """Get padding width.

        Returns:
            Width for ZeroPadded, 0 for Plain

        Example:
            LineNumberFormat.ZeroPadded(4).get_width()  # → 4
            LineNumberFormat.Plain.get_width()  # → 0
        """
        match self:
            case ZeroPadded(w): w
            case Plain: 0

    fn uses_padding() -> bool:
        """Check if format uses zero padding.

        Returns:
            true for ZeroPadded

        Example:
            LineNumberFormat.ZeroPadded(4).uses_padding()  # → true
        """
        return self.is_zero_padded()

    fn to_string() -> text:
        """Convert format to string.

        Returns:
            Format name

        Example:
            LineNumberFormat.Plain.to_string()  # → "plain"
        """
        match self:
            case Plain: "plain"
            case ZeroPadded(_): "zero_padded"

    fn description() -> text:
        """Get format description.

        Returns:
            Human-readable description

        Example:
            LineNumberFormat.ZeroPadded(4).description()
            # → "Zero-padded with width 4"
        """
        match self:
            case Plain: "Plain line numbers"
            case ZeroPadded(w): "Zero-padded with width {w}"

    fn summary() -> text:
        """Get summary of line number format.

        Returns:
            Human-readable summary

        Example:
            LineNumberFormat.ZeroPadded(4).summary()
            # → "LineNumberFormat: zero_padded (width=4)"
        """
        val name = self.to_string()
        match self:
            case Plain:
                "LineNumberFormat: {name}"
            case ZeroPadded(w):
                "LineNumberFormat: {name} (width={w})"

# =============================================================================
