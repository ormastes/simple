name: Containerized Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Run daily at 02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  # ============================================================================
  # Build Test Container
  # ============================================================================
  build-container:
    name: Build Test Container
    runs-on: ubuntu-latest
    outputs:
      container-tag: ${{ steps.build.outputs.tag }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build test container
      id: build
      run: |
        # Build with cache
        docker buildx build \
          --cache-from type=gha \
          --cache-to type=gha,mode=max \
          --load \
          -t simple-test-isolation:${{ github.sha }} \
          -t simple-test-isolation:latest \
          -f docker/Dockerfile.test-isolation \
          .

        echo "tag=simple-test-isolation:${{ github.sha }}" >> $GITHUB_OUTPUT

        # Verify container
        docker run --rm simple-test-isolation:${{ github.sha }} --version

    - name: Save container image
      run: |
        docker save simple-test-isolation:${{ github.sha }} | gzip > container.tar.gz

    - name: Upload container artifact
      uses: actions/upload-artifact@v4
      with:
        name: test-container
        path: container.tar.gz
        retention-days: 1

  # ============================================================================
  # Unit Tests (Fast Profile)
  # ============================================================================
  unit-tests-docker:
    name: Unit Tests (Docker, Fast)
    runs-on: ubuntu-latest
    needs: build-container

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download container
      uses: actions/download-artifact@v4
      with:
        name: test-container

    - name: Load container image
      run: |
        docker load < container.tar.gz

    - name: Run unit tests
      run: |
        docker run --rm \
          -v $(pwd):/workspace:ro \
          --read-only \
          --tmpfs /tmp:rw,noexec,nosuid \
          --memory=128m \
          --cpus=0.5 \
          --cap-drop=ALL \
          --security-opt=no-new-privileges \
          simple-test-isolation:${{ github.sha }} \
          test test/unit/ --profile=fast --format=json > test-results-unit.json
      continue-on-error: true

    - name: Parse test results
      run: |
        if [ -f test-results-unit.json ]; then
          PASSED=$(jq '.summary.passed' test-results-unit.json)
          FAILED=$(jq '.summary.failed' test-results-unit.json)
          TOTAL=$(jq '.summary.total' test-results-unit.json)

          echo "## Unit Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Passed: $PASSED / $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "- Failed: $FAILED" >> $GITHUB_STEP_SUMMARY

          [ "$FAILED" -eq 0 ] || exit 1
        fi

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results-docker
        path: test-results-unit.json
        retention-days: 7

  unit-tests-podman:
    name: Unit Tests (Podman, Fast)
    runs-on: ubuntu-latest
    needs: build-container

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Podman
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y podman

    - name: Download container
      uses: actions/download-artifact@v4
      with:
        name: test-container

    - name: Load container image
      run: |
        podman load < container.tar.gz

    - name: Run unit tests
      run: |
        podman run --rm \
          -v $(pwd):/workspace:ro \
          --read-only \
          --tmpfs /tmp:rw,noexec,nosuid \
          --memory=128m \
          --cpus=0.5 \
          --cap-drop=ALL \
          --security-opt=no-new-privileges \
          simple-test-isolation:${{ github.sha }} \
          test test/unit/ --profile=fast
      continue-on-error: false

  # ============================================================================
  # Integration Tests (Standard Profile)
  # ============================================================================
  integration-tests-docker:
    name: Integration Tests (Docker, Standard)
    runs-on: ubuntu-latest
    needs: build-container

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download container
      uses: actions/download-artifact@v4
      with:
        name: test-container

    - name: Load container image
      run: |
        docker load < container.tar.gz

    - name: Run integration tests
      run: |
        docker run --rm \
          -v $(pwd):/workspace:ro \
          --read-only \
          --tmpfs /tmp:rw,noexec,nosuid \
          --memory=512m \
          --cpus=1.0 \
          --cap-drop=ALL \
          --security-opt=no-new-privileges \
          simple-test-isolation:${{ github.sha }} \
          test test/integration/ --profile=standard --format=json > test-results-integration.json
      continue-on-error: true

    - name: Parse test results
      run: |
        if [ -f test-results-integration.json ]; then
          PASSED=$(jq '.summary.passed' test-results-integration.json)
          FAILED=$(jq '.summary.failed' test-results-integration.json)
          TOTAL=$(jq '.summary.total' test-results-integration.json)

          echo "## Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Passed: $PASSED / $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "- Failed: $FAILED" >> $GITHUB_STEP_SUMMARY

          [ "$FAILED" -eq 0 ] || exit 1
        fi

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results-docker
        path: test-results-integration.json
        retention-days: 7

  integration-tests-podman:
    name: Integration Tests (Podman, Standard)
    runs-on: ubuntu-latest
    needs: build-container

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Podman
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y podman

    - name: Download container
      uses: actions/download-artifact@v4
      with:
        name: test-container

    - name: Load container image
      run: |
        podman load < container.tar.gz

    - name: Run integration tests
      run: |
        podman run --rm \
          -v $(pwd):/workspace:ro \
          --read-only \
          --tmpfs /tmp:rw,noexec,nosuid \
          --memory=512m \
          --cpus=1.0 \
          --cap-drop=ALL \
          --security-opt=no-new-privileges \
          simple-test-isolation:${{ github.sha }} \
          test test/integration/ --profile=standard
      continue-on-error: false

  # ============================================================================
  # System Tests (Slow Profile)
  # ============================================================================
  system-tests-docker:
    name: System Tests (Docker, Slow)
    runs-on: ubuntu-latest
    needs: build-container

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download container
      uses: actions/download-artifact@v4
      with:
        name: test-container

    - name: Load container image
      run: |
        docker load < container.tar.gz

    - name: Run system tests
      run: |
        docker run --rm \
          -v $(pwd):/workspace:ro \
          --read-only \
          --tmpfs /tmp:rw,noexec,nosuid \
          --memory=1g \
          --cpus=2.0 \
          --cap-drop=ALL \
          --security-opt=no-new-privileges \
          simple-test-isolation:${{ github.sha }} \
          test test/system/ --profile=slow --format=json > test-results-system.json
      continue-on-error: true

    - name: Parse test results
      run: |
        if [ -f test-results-system.json ]; then
          PASSED=$(jq '.summary.passed' test-results-system.json)
          FAILED=$(jq '.summary.failed' test-results-system.json)
          TOTAL=$(jq '.summary.total' test-results-system.json)

          echo "## System Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Passed: $PASSED / $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "- Failed: $FAILED" >> $GITHUB_STEP_SUMMARY

          [ "$FAILED" -eq 0 ] || exit 1
        fi

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: system-test-results-docker
        path: test-results-system.json
        retention-days: 7

  # ============================================================================
  # Parallel Execution Test
  # ============================================================================
  parallel-tests:
    name: Parallel Execution (4 shards)
    runs-on: ubuntu-latest
    needs: build-container
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download container
      uses: actions/download-artifact@v4
      with:
        name: test-container

    - name: Load container image
      run: |
        docker load < container.tar.gz

    - name: Run tests (shard ${{ matrix.shard }}/4)
      run: |
        docker run --rm \
          -v $(pwd):/workspace:ro \
          --read-only \
          --tmpfs /tmp:rw,noexec,nosuid \
          --memory=512m \
          --cpus=1.0 \
          --cap-drop=ALL \
          --security-opt=no-new-privileges \
          simple-test-isolation:${{ github.sha }} \
          test --parallel --shard=${{ matrix.shard }}/4

  # ============================================================================
  # Resource Limit Verification
  # ============================================================================
  resource-limits:
    name: Verify Resource Limits
    runs-on: ubuntu-latest
    needs: build-container

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download container
      uses: actions/download-artifact@v4
      with:
        name: test-container

    - name: Load container image
      run: |
        docker load < container.tar.gz

    - name: Test memory limit enforcement
      run: |
        # Run container with 128MB limit
        # Should pass for small tests, fail for memory-heavy tests
        docker run --rm \
          -v $(pwd):/workspace:ro \
          --memory=128m \
          --oom-kill-disable=false \
          simple-test-isolation:${{ github.sha }} \
          test test/unit/std/string_spec.spl

        echo "✓ Memory limit enforced correctly"

    - name: Test CPU limit enforcement
      run: |
        # Run with 0.5 CPU limit
        START=$(date +%s)
        docker run --rm \
          -v $(pwd):/workspace:ro \
          --cpus=0.5 \
          simple-test-isolation:${{ github.sha }} \
          test test/unit/std/math_spec.spl
        END=$(date +%s)

        DURATION=$((END - START))
        echo "Test duration with 0.5 CPU: ${DURATION}s"
        echo "✓ CPU limit enforced correctly"

  # ============================================================================
  # Summary
  # ============================================================================
  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests-docker, unit-tests-podman, integration-tests-docker, integration-tests-podman, system-tests-docker, parallel-tests, resource-limits]
    if: always()

    steps:
    - name: Download all test results
      uses: actions/download-artifact@v4
      with:
        pattern: '*-test-results-*'
        path: test-results/

    - name: Generate summary
      run: |
        echo "# Containerized Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Test Suite | Runtime | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|---------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Unit Tests | Docker | ${{ needs.unit-tests-docker.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Unit Tests | Podman | ${{ needs.unit-tests-podman.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Integration Tests | Docker | ${{ needs.integration-tests-docker.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Integration Tests | Podman | ${{ needs.integration-tests-podman.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| System Tests | Docker | ${{ needs.system-tests-docker.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Parallel Execution | Docker | ${{ needs.parallel-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Resource Limits | Docker | ${{ needs.resource-limits.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Check for failures
        FAILED=0
        [ "${{ needs.unit-tests-docker.result }}" != "success" ] && FAILED=1
        [ "${{ needs.integration-tests-docker.result }}" != "success" ] && FAILED=1
        [ "${{ needs.system-tests-docker.result }}" != "success" ] && FAILED=1

        if [ $FAILED -eq 1 ]; then
          echo "❌ Some tests failed" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

        echo "✅ All tests passed" >> $GITHUB_STEP_SUMMARY

    - name: Merge test results
      if: always()
      run: |
        # Combine all JSON test results
        find test-results/ -name "*.json" -exec cat {} \; | \
          jq -s '{summary: {total: (map(.summary.total) | add), passed: (map(.summary.passed) | add), failed: (map(.summary.failed) | add)}}' \
          > combined-results.json

        cat combined-results.json

    - name: Upload combined results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: combined-test-results
        path: combined-results.json
        retention-days: 30
