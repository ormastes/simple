name: Seed Compiler Cross-Compile

on:
  push:
    branches: [ main ]
    paths:
      - 'src/compiler_seed/**'
      - '.github/workflows/seed-build.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/compiler_seed/**'
      - '.github/workflows/seed-build.yml'
  workflow_dispatch:

jobs:
  seed-crosscompile:
    name: Cross-compile seed
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install cross-compile toolchains
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq clang lld llvm \
          gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
          gcc-riscv64-linux-gnu g++-riscv64-linux-gnu \
          gcc-mingw-w64-x86-64 g++-mingw-w64-x86-64 \
          gcc-mingw-w64-i686 g++-mingw-w64-i686 \
          qemu-user xz-utils

    - name: Download macOS SDK
      run: |
        curl -L -o /tmp/MacOSX14.5.sdk.tar.xz \
          https://github.com/joseluisq/macosx-sdks/releases/download/14.5/MacOSX14.5.sdk.tar.xz
        sudo mkdir -p /opt/sysroots/macos
        sudo tar xf /tmp/MacOSX14.5.sdk.tar.xz -C /opt/sysroots/macos
        sudo chmod -R a+rX /opt/sysroots/macos
        # Also set up legacy path for backward compat
        mkdir -p /tmp/macos-sdk
        ln -s /opt/sysroots/macos/MacOSX14.5.sdk /tmp/macos-sdk/MacOSX14.5.sdk

    - name: Download FreeBSD x86_64 sysroot
      run: |
        curl -L -o /tmp/freebsd-base.txz \
          https://archive.freebsd.org/old-releases/amd64/14.1-RELEASE/base.txz
        sudo mkdir -p /opt/sysroots/freebsd-x86_64
        sudo tar xf /tmp/freebsd-base.txz -C /opt/sysroots/freebsd-x86_64 ./usr/include ./usr/lib ./lib
        sudo chmod -R a+rX /opt/sysroots/freebsd-x86_64
        # Legacy path
        mkdir -p /tmp/freebsd-sysroot
        ln -s /opt/sysroots/freebsd-x86_64/usr /tmp/freebsd-sysroot/usr
        ln -s /opt/sysroots/freebsd-x86_64/lib /tmp/freebsd-sysroot/lib

    - name: Download FreeBSD i386 sysroot
      run: |
        curl -L -o /tmp/freebsd-i386-base.txz \
          https://archive.freebsd.org/old-releases/i386/13.2-RELEASE/base.txz
        sudo mkdir -p /opt/sysroots/freebsd-x86
        sudo tar xf /tmp/freebsd-i386-base.txz -C /opt/sysroots/freebsd-x86 ./usr/include ./usr/lib ./lib
        sudo chmod -R a+rX /opt/sysroots/freebsd-x86

    # ---- Build all 8 targets using CMake toolchain files ----
    - name: Build seed — Linux x86_64
      run: |
        cmake -B build/linux-x86_64 src/compiler_seed \
          -DCMAKE_TOOLCHAIN_FILE=src/compiler_seed/cmake/toolchains/linux-x86_64.cmake
        cmake --build build/linux-x86_64
        file build/linux-x86_64/seed build/linux-x86_64/seed_cpp

    - name: Build seed — Linux ARM64
      run: |
        cmake -B build/linux-arm64 src/compiler_seed \
          -DCMAKE_TOOLCHAIN_FILE=src/compiler_seed/cmake/toolchains/linux-arm64.cmake
        cmake --build build/linux-arm64
        file build/linux-arm64/seed build/linux-arm64/seed_cpp

    - name: Build seed — Linux RISC-V 64
      run: |
        cmake -B build/linux-riscv64 src/compiler_seed \
          -DCMAKE_TOOLCHAIN_FILE=src/compiler_seed/cmake/toolchains/linux-riscv64.cmake
        cmake --build build/linux-riscv64
        file build/linux-riscv64/seed build/linux-riscv64/seed_cpp

    - name: Build seed — Windows x86_64
      run: |
        cmake -B build/windows-x86_64 src/compiler_seed \
          -DCMAKE_TOOLCHAIN_FILE=src/compiler_seed/cmake/toolchains/windows-x86_64.cmake
        cmake --build build/windows-x86_64 --target seed --target seed_cpp --target spl_runtime
        file build/windows-x86_64/seed.exe build/windows-x86_64/seed_cpp.exe

    - name: Build seed — Windows x86
      run: |
        cmake -B build/windows-x86 src/compiler_seed \
          -DCMAKE_TOOLCHAIN_FILE=src/compiler_seed/cmake/toolchains/windows-x86.cmake
        cmake --build build/windows-x86 --target seed --target seed_cpp --target spl_runtime
        file build/windows-x86/seed.exe build/windows-x86/seed_cpp.exe

    - name: Build seed — FreeBSD x86_64
      run: |
        cmake -B build/freebsd-x86_64 src/compiler_seed \
          -DCMAKE_TOOLCHAIN_FILE=src/compiler_seed/cmake/toolchains/freebsd-x86_64.cmake
        cmake --build build/freebsd-x86_64 --target seed --target seed_cpp --target spl_runtime
        file build/freebsd-x86_64/seed build/freebsd-x86_64/seed_cpp

    - name: Build seed — FreeBSD x86
      run: |
        cmake -B build/freebsd-x86 src/compiler_seed \
          -DCMAKE_TOOLCHAIN_FILE=src/compiler_seed/cmake/toolchains/freebsd-x86.cmake
        cmake --build build/freebsd-x86 --target seed --target seed_cpp --target spl_runtime
        file build/freebsd-x86/seed build/freebsd-x86/seed_cpp

    - name: Build seed — macOS ARM64
      run: |
        cmake -B build/macos-arm64 src/compiler_seed \
          -DCMAKE_TOOLCHAIN_FILE=src/compiler_seed/cmake/toolchains/macos-arm64.cmake
        cmake --build build/macos-arm64 --target seed --target seed_cpp --target spl_runtime
        file build/macos-arm64/seed build/macos-arm64/seed_cpp

    # ---- QEMU smoke tests ----
    - name: QEMU test — Linux ARM64 seed
      run: |
        qemu-aarch64 -L /usr/aarch64-linux-gnu build/linux-arm64/seed 2>&1 | head -3
        echo "ARM64 seed runs under QEMU"

    - name: QEMU test — Linux RISC-V 64 seed
      run: |
        qemu-riscv64 -L /usr/riscv64-linux-gnu build/linux-riscv64/seed 2>&1 | head -3
        echo "RISC-V 64 seed runs under QEMU"

    # ---- Roundtrip test (Linux native) ----
    - name: Roundtrip test — Linux seed
      run: |
        cat > /tmp/test_seed.spl <<'EOF'
        fn main():
            val x = 42
            print "hello {x}"
        EOF
        ./build/linux-x86_64/seed /tmp/test_seed.spl > /tmp/test_seed.c
        clang -std=c11 -o /tmp/test_seed /tmp/test_seed.c src/compiler_seed/runtime.c -Isrc/compiler_seed
        OUTPUT=$(/tmp/test_seed)
        echo "Output: $OUTPUT"
        echo "$OUTPUT" | grep -q "hello 42" && echo "Roundtrip PASSED" || (echo "FAILED"; exit 1)

    # ---- Upload all artifacts ----
    - name: Upload seed binaries
      uses: actions/upload-artifact@v4
      with:
        name: seed-all-platforms
        path: |
          build/linux-x86_64/seed
          build/linux-x86_64/seed_cpp
          build/linux-x86_64/libspl_runtime.a
          build/linux-arm64/seed
          build/linux-arm64/seed_cpp
          build/linux-arm64/libspl_runtime.a
          build/linux-riscv64/seed
          build/linux-riscv64/seed_cpp
          build/linux-riscv64/libspl_runtime.a
          build/windows-x86_64/seed.exe
          build/windows-x86_64/seed_cpp.exe
          build/windows-x86_64/libspl_runtime.a
          build/windows-x86/seed.exe
          build/windows-x86/seed_cpp.exe
          build/windows-x86/libspl_runtime.a
          build/freebsd-x86_64/seed
          build/freebsd-x86_64/seed_cpp
          build/freebsd-x86_64/libspl_runtime.a
          build/freebsd-x86/seed
          build/freebsd-x86/seed_cpp
          build/freebsd-x86/libspl_runtime.a
          build/macos-arm64/seed
          build/macos-arm64/seed_cpp
          build/macos-arm64/libspl_runtime.a
        retention-days: 30

  # ---- Native macOS build (full link) ----
  seed-macos:
    name: macOS native
    runs-on: macos-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build seed — macOS
      run: |
        cmake -B build src/compiler_seed
        cmake --build build
        file build/seed
        file build/seed_cpp

    - name: Roundtrip test
      run: |
        cat > /tmp/test_seed.spl <<'EOF'
        fn main():
            val x = 42
            print "hello {x}"
        EOF
        ./build/seed /tmp/test_seed.spl > /tmp/test_seed.c
        cc -std=c11 -o /tmp/test_seed /tmp/test_seed.c src/compiler_seed/runtime.c -Isrc/compiler_seed
        OUTPUT=$(/tmp/test_seed)
        echo "Output: $OUTPUT"
        echo "$OUTPUT" | grep -q "hello 42" && echo "Roundtrip PASSED" || (echo "FAILED"; exit 1)

    - name: Upload macOS seed
      uses: actions/upload-artifact@v4
      with:
        name: seed-macos
        path: |
          build/seed
          build/seed_cpp
          build/libspl_runtime.a
        retention-days: 30

  # ---- Native FreeBSD build (full link) ----
  seed-freebsd:
    name: FreeBSD native
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build seed on FreeBSD VM
      uses: vmactions/freebsd-vm@v1
      with:
        release: "14.1"
        usesh: true
        run: |
          pkg install -y cmake
          cmake -B build src/compiler_seed
          cmake --build build
          file build/seed
          file build/seed_cpp

          # Roundtrip test
          cat > /tmp/test_seed.spl <<'SPLEOF'
          fn main():
              val x = 42
              print "hello {x}"
          SPLEOF
          ./build/seed /tmp/test_seed.spl > /tmp/test_seed.c
          cc -std=c11 -o /tmp/test_seed /tmp/test_seed.c src/compiler_seed/runtime.c -Isrc/compiler_seed
          OUTPUT=$(/tmp/test_seed)
          echo "Output: $OUTPUT"
          echo "$OUTPUT" | grep -q "hello 42" && echo "Roundtrip PASSED" || (echo "FAILED"; exit 1)
      continue-on-error: true

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [seed-crosscompile, seed-macos, seed-freebsd]
    if: always()
    steps:
    - name: Generate summary
      run: |
        echo "# Seed Compiler Build Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Target | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| All 8 cross-compile targets | ${{ needs.seed-crosscompile.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| macOS native | ${{ needs.seed-macos.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| FreeBSD native | ${{ needs.seed-freebsd.result }} |" >> $GITHUB_STEP_SUMMARY
