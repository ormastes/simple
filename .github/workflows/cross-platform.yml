name: Cross-Platform CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  # ============================================================================
  # Platform Detection & Basic Tests
  # ============================================================================
  platform-detection:
    name: Platform Detection (${{ matrix.platform }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x86_64
            shell: bash
          - os: macos-latest
            platform: darwin-aarch64
            shell: bash
          - os: windows-latest
            platform: windows-x86_64
            shell: pwsh

    defaults:
      run:
        shell: ${{ matrix.shell }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup bootstrap runtime (Unix)
      if: runner.os != 'Windows'
      run: |
        if [ -f "bin/bootstrap/simple" ]; then
          chmod +x bin/bootstrap/simple
          echo "✓ Bootstrap runtime ready"
        else
          echo "✗ No bootstrap runtime"
          exit 1
        fi

    - name: Setup bootstrap runtime (Windows)
      if: runner.os == 'Windows'
      run: |
        if (Test-Path "bin\bootstrap\simple") {
          Write-Host "✓ Bootstrap runtime ready"
        } else {
          Write-Host "✗ No bootstrap runtime"
          exit 1
        }
      shell: pwsh

    - name: Test platform name (Unix)
      if: runner.os != 'Windows'
      run: |
        export PATH="$PWD/bin:$PWD/bin/bootstrap:$PATH"
        DETECTED=$(simple -c "use std.platform; print platform_name()")
        echo "Detected platform: $DETECTED"
        if [[ "$DETECTED" != *"${{ matrix.platform }}"* ]]; then
          echo "❌ Platform detection mismatch"
          echo "Expected: ${{ matrix.platform }}"
          echo "Got: $DETECTED"
          exit 1
        fi
        echo "✅ Platform detection correct"

    - name: Test platform name (Windows)
      if: runner.os == 'Windows'
      run: |
        $env:PATH = "${{ github.workspace }}\bin;${{ github.workspace }}\bin\bootstrap;$env:PATH"
        $DETECTED = simple -c "use std.platform; print platform_name()"
        Write-Host "Detected platform: $DETECTED"
        if ($DETECTED -notlike "*${{ matrix.platform }}*") {
          Write-Host "❌ Platform detection mismatch"
          Write-Host "Expected: ${{ matrix.platform }}"
          Write-Host "Got: $DETECTED"
          exit 1
        }
        Write-Host "✅ Platform detection correct"

    - name: Test separators (Unix)
      if: runner.os != 'Windows'
      run: |
        export PATH="$PWD/bin:$PWD/bin/bootstrap:$PATH"
        DIR_SEP=$(simple -c "use std.platform; print dir_sep()")
        PATH_SEP=$(simple -c "use std.platform; print path_sep()")
        echo "Directory separator: $DIR_SEP"
        echo "Path separator: $PATH_SEP"

        if [ "${{ runner.os }}" == "Linux" ] || [ "${{ runner.os }}" == "macOS" ]; then
          [ "$DIR_SEP" == "/" ] || (echo "❌ Wrong dir separator"; exit 1)
          [ "$PATH_SEP" == ":" ] || (echo "❌ Wrong path separator"; exit 1)
          echo "✅ Separators correct for Unix"
        fi

    - name: Test separators (Windows)
      if: runner.os == 'Windows'
      run: |
        $env:PATH = "${{ github.workspace }}\bin;${{ github.workspace }}\bin\bootstrap;$env:PATH"
        $DIR_SEP = simple -c "use std.platform; print dir_sep()"
        $PATH_SEP = simple -c "use std.platform; print path_sep()"
        Write-Host "Directory separator: $DIR_SEP"
        Write-Host "Path separator: $PATH_SEP"

        if ($DIR_SEP -ne "\") {
          Write-Host "❌ Wrong dir separator for Windows"
          exit 1
        }
        if ($PATH_SEP -ne ";") {
          Write-Host "❌ Wrong path separator for Windows"
          exit 1
        }
        Write-Host "✅ Separators correct for Windows"

  # ============================================================================
  # Path Normalization Tests
  # ============================================================================
  path-normalization:
    name: Path Normalization (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup bootstrap runtime
      shell: bash
      run: |
        if [ -f "bin/bootstrap/simple" ]; then
          chmod +x bin/bootstrap/simple
          echo "✓ Bootstrap runtime ready"
        else
          echo "✗ No bootstrap runtime"
          exit 1
        fi

    - name: Test path joining (Unix)
      if: runner.os != 'Windows'
      run: |
        export PATH="$PWD/bin:$PWD/bin/bootstrap:$PATH"
        simple -c "use std.fs.path; val p = Path.new('/usr').join('bin').join('simple'); print p.to_string()"

    - name: Test path joining (Windows)
      if: runner.os == 'Windows'
      run: |
        $env:PATH = "${{ github.workspace }}\bin;${{ github.workspace }}\bin\bootstrap;$env:PATH"
        simple -c "use std.fs.path; val p = Path.new('C:\Users').join('Test').join('file.txt'); print p.to_string()"
      shell: pwsh

    - name: Test Windows path normalization
      if: runner.os == 'Windows'
      run: |
        $env:PATH = "${{ github.workspace }}\bin;${{ github.workspace }}\bin\bootstrap;$env:PATH"
        # Test forward slash to backslash conversion
        simple -c "use std.fs.path; val p = Path.new('C:/Users/Test/file.txt').normalize(); print p.to_string()"

        # Test UNC path handling
        simple -c "use std.platform; print normalize_path('//server/share/file.txt')"
      shell: pwsh

  # ============================================================================
  # Process Management Tests
  # ============================================================================
  process-management:
    name: Process Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup bootstrap runtime
      shell: bash
      run: |
        if [ -f "bin/bootstrap/simple" ]; then
          chmod +x bin/bootstrap/simple
          echo "✓ Bootstrap runtime ready"
        else
          echo "✗ No bootstrap runtime"
          exit 1
        fi

    - name: Test shell execution (Unix)
      if: runner.os != 'Windows'
      run: |
        export PATH="$PWD/bin:$PWD/bin/bootstrap:$PATH"
        OUTPUT=$(simple -c "use app.io; val r = shell('echo test'); print r.stdout")
        echo "Shell output: $OUTPUT"
        if [[ "$OUTPUT" != *"test"* ]]; then
          echo "❌ Shell execution failed"
          exit 1
        fi
        echo "✅ Shell execution works"

    - name: Test shell execution (Windows)
      if: runner.os == 'Windows'
      run: |
        $env:PATH = "${{ github.workspace }}\bin;${{ github.workspace }}\bin\bootstrap;$env:PATH"
        $OUTPUT = simple -c "use app.io; val r = shell('echo test'); print r.stdout"
        Write-Host "Shell output: $OUTPUT"
        if ($OUTPUT -notlike "*test*") {
          Write-Host "❌ Shell execution failed"
          exit 1
        }
        Write-Host "✅ Shell execution works"
      shell: pwsh

    - name: Test command resolution (Windows)
      if: runner.os == 'Windows'
      run: |
        $env:PATH = "${{ github.workspace }}\bin;${{ github.workspace }}\bin\bootstrap;$env:PATH"
        # Test that notepad resolves to notepad.exe
        $RESOLVED = simple -c "use std.platform; print resolve_command('notepad')"
        Write-Host "Resolved: $RESOLVED"
        if ($RESOLVED -notlike "*notepad.exe*") {
          Write-Host "⚠️ Command resolution may not be working correctly"
        }
      shell: pwsh

  # ============================================================================
  # Linker Auto-Detection
  # ============================================================================
  linker-detection:
    name: Linker Detection (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup bootstrap runtime
      shell: bash
      run: |
        if [ -f "bin/bootstrap/simple" ]; then
          chmod +x bin/bootstrap/simple
          echo "✓ Bootstrap runtime ready"
        else
          echo "✗ No bootstrap runtime"
          exit 1
        fi

    - name: Install mold (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        wget -q https://github.com/rui314/mold/releases/download/v2.4.0/mold-2.4.0-x86_64-linux.tar.gz
        tar xzf mold-2.4.0-x86_64-linux.tar.gz
        sudo cp mold-2.4.0-x86_64-linux/bin/mold /usr/local/bin/
        mold --version
        which mold

    - name: Test linker detection (Unix)
      if: runner.os != 'Windows'
      run: |
        export PATH="$PWD/bin:$PWD/bin/bootstrap:$PATH"
        simple -c "use compiler.linker.link; print get_linker_info()"

        LINKER=$(simple -c "use compiler.linker.link; val l = auto_detect_linker(); print l.name()")
        echo "Detected linker: $LINKER"

        if [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
          if [[ "$LINKER" == *"mold"* ]]; then
            echo "✅ Correctly detected mold on Linux"
          else
            echo "⚠️ Expected mold but got: $LINKER"
          fi
        elif [ "${{ runner.os }}" == "macOS" ]; then
          if [[ "$LINKER" == *"ld64"* ]] || [[ "$LINKER" == *"ld"* ]]; then
            echo "✅ Correctly detected ld on macOS"
          else
            echo "⚠️ Expected ld64 but got: $LINKER"
          fi
        fi
      continue-on-error: true

    - name: Test linker detection (Windows)
      if: runner.os == 'Windows'
      run: |
        $env:PATH = "${{ github.workspace }}\bin;${{ github.workspace }}\bin\bootstrap;$env:PATH"
        simple -c "use compiler.linker.link; print get_linker_info()"

        $LINKER = simple -c "use compiler.linker.link; val l = auto_detect_linker(); print l.name()"
        Write-Host "Detected linker: $LINKER"

        if ($LINKER -like "*MSVC*" -or $LINKER -like "*lld-link*") {
          Write-Host "✅ Correctly detected Windows linker"
        } else {
          Write-Host "⚠️ Unexpected linker: $LINKER"
        }
      shell: pwsh
      continue-on-error: true

  # ============================================================================
  # Build Examples (Cross-Platform)
  # ============================================================================
  build-examples:
    name: Build Examples (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup bootstrap runtime
      shell: bash
      run: |
        if [ -f "bin/bootstrap/simple" ]; then
          chmod +x bin/bootstrap/simple
          echo "✓ Bootstrap runtime ready"
        else
          echo "✗ No bootstrap runtime"
          exit 1
        fi

    - name: Install mold (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        wget -q https://github.com/rui314/mold/releases/download/v2.4.0/mold-2.4.0-x86_64-linux.tar.gz
        tar xzf mold-2.4.0-x86_64-linux.tar.gz
        sudo cp mold-2.4.0-x86_64-linux/bin/mold /usr/local/bin/

    - name: Build hello example (Unix)
      if: runner.os != 'Windows'
      run: |
        export PATH="$PWD/bin:$PWD/bin/bootstrap:$PATH"
        if [ -f examples/hello.spl ]; then
          simple build examples/hello.spl -o hello
          ./hello
          echo "✅ Built and ran hello example"
        else
          echo "⚠️ hello.spl not found"
        fi
      continue-on-error: true

    - name: Build hello example (Windows)
      if: runner.os == 'Windows'
      run: |
        $env:PATH = "${{ github.workspace }}\bin;${{ github.workspace }}\bin\bootstrap;$env:PATH"
        if (Test-Path examples/hello.spl) {
          simple build examples/hello.spl -o hello.exe
          .\hello.exe
          Write-Host "✅ Built and ran hello example"
        } else {
          Write-Host "⚠️ hello.spl not found"
        }
      shell: pwsh
      continue-on-error: true

  # ============================================================================
  # Summary
  # ============================================================================
  summary:
    name: All Tests Summary
    runs-on: ubuntu-latest
    needs: [platform-detection, path-normalization, process-management, linker-detection, build-examples]
    if: always()

    steps:
    - name: Generate summary
      run: |
        echo "# Cross-Platform Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Platform Detection | ${{ needs.platform-detection.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Path Normalization | ${{ needs.path-normalization.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Process Management | ${{ needs.process-management.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Linker Detection | ${{ needs.linker-detection.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build Examples | ${{ needs.build-examples.result }} |" >> $GITHUB_STEP_SUMMARY

    - name: Check critical failures
      run: |
        FAILED=0
        [ "${{ needs.platform-detection.result }}" != "success" ] && FAILED=1
        [ "${{ needs.path-normalization.result }}" != "success" ] && FAILED=1

        if [ $FAILED -eq 1 ]; then
          echo "❌ Critical tests failed"
          exit 1
        fi

        echo "✅ All critical tests passed"
