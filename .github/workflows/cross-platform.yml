name: Cross-Platform CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  # ============================================================================
  # Platform Detection & Basic Tests
  # ============================================================================
  platform-detection:
    name: Platform Detection (${{ matrix.platform }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x86_64
            shell: bash
          - os: macos-latest
            platform: darwin-aarch64
            shell: bash
          - os: windows-latest
            platform: windows-x86_64
            shell: pwsh

    defaults:
      run:
        shell: ${{ matrix.shell }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate bootstrap runtime (Unix)
      if: runner.os != 'Windows'
      id: validate-unix
      run: |
        if [ -f "bin/bootstrap/simple" ]; then
          chmod +x bin/bootstrap/simple
          # Verify binary can actually execute on this platform
          if bin/bootstrap/simple -c "print 1" > /dev/null 2>&1; then
            echo "can_execute=true" >> $GITHUB_OUTPUT
            echo "✓ Bootstrap runtime validated"
          else
            echo "can_execute=false" >> $GITHUB_OUTPUT
            echo "⚠ Bootstrap binary exists but cannot execute on this platform"
            echo "  (Expected: only linux-x86_64 binaries are available currently)"
          fi
        else
          echo "can_execute=false" >> $GITHUB_OUTPUT
          echo "✗ No bootstrap runtime"
        fi

    - name: Validate bootstrap runtime (Windows)
      if: runner.os == 'Windows'
      id: validate-windows
      run: |
        if (Test-Path "bin\bootstrap\simple") {
          # Linux ELF binary - cannot execute on Windows
          echo "can_execute=false" >> $env:GITHUB_OUTPUT
          Write-Host "⚠ Bootstrap binary exists but is Linux ELF (cannot execute on Windows)"
          Write-Host "  Native Windows binary not yet available"
        } else {
          echo "can_execute=false" >> $env:GITHUB_OUTPUT
          Write-Host "✗ No bootstrap runtime"
        }
      shell: pwsh

    - name: Test platform detection (Linux)
      if: runner.os == 'Linux' && steps.validate-unix.outputs.can_execute == 'true'
      run: |
        export PATH="$PWD/bin:$PWD/bin/bootstrap:$PATH"
        DETECTED=$(simple -c "use std.platform.{is_linux}; print is_linux()")
        echo "Detected is_linux: $DETECTED"
        if [[ "$DETECTED" == *"true"* ]]; then
          echo "✅ Platform detection correct"
        else
          echo "❌ Expected is_linux() == true"
          exit 1
        fi

    - name: Test separators (Linux)
      if: runner.os == 'Linux' && steps.validate-unix.outputs.can_execute == 'true'
      run: |
        export PATH="$PWD/bin:$PWD/bin/bootstrap:$PATH"
        DIR_SEP=$(simple -c "use std.platform.{dir_sep}; print dir_sep()")
        PATH_SEP=$(simple -c "use std.platform.{path_sep}; print path_sep()")
        echo "Directory separator: '$DIR_SEP'"
        echo "Path separator: '$PATH_SEP'"

        [ "$DIR_SEP" == "/" ] || (echo "❌ Wrong dir separator"; exit 1)
        [ "$PATH_SEP" == ":" ] || (echo "❌ Wrong path separator"; exit 1)
        echo "✅ Separators correct for Linux"

    - name: Skip notice (non-Linux)
      if: (runner.os == 'macOS' && steps.validate-unix.outputs.can_execute != 'true') || runner.os == 'Windows'
      run: |
        echo "⚠ Skipping platform tests - no native binary for this platform yet"
        echo "  Only linux-x86_64 bootstrap binary is currently available"
      shell: bash

  # ============================================================================
  # FreeBSD Tests (via VM)
  # ============================================================================
  freebsd-tests:
    name: FreeBSD Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Test on FreeBSD
      uses: vmactions/freebsd-vm@v1
      with:
        release: "14.1"
        usesh: true
        run: |
          # Enable Linux compatibility for running Linux ELF binary
          sysctl kern.elf64.fallback_brand=Linux

          # Setup bootstrap (Linux binary runs via Linuxulator)
          chmod +x bin/bootstrap/simple

          # Install Linux runtime libraries and gcc
          pkg install -y linux_base-c7 gcc

          # Test basic execution
          if bin/bootstrap/simple -c "print 42" 2>/dev/null; then
            echo "✅ Bootstrap binary works on FreeBSD (via Linuxulator)"
          else
            echo "⚠ Bootstrap binary cannot run on FreeBSD"
            echo "  Linuxulator may need additional setup"
            exit 0
          fi

          # Test platform detection
          export PATH="$PWD/bin:$PWD/bin/bootstrap:$PATH"
          simple -c "use std.platform.{is_unix, dir_sep}; print is_unix(); print dir_sep()" || true

          # Test shell execution
          simple -c "use app.io.mod (shell); val r = shell(\"echo hello_freebsd\"); print r.stdout" || true

          # Run native compile spec (multi-file link tests)
          echo ""
          echo "=== Running native compile spec on FreeBSD ==="
          gcc --version | head -1 || true
          clang --version | head -1 || true
          bin/bootstrap/simple test test/compiler/native_compile_spec.spl
      continue-on-error: true

  # ============================================================================
  # Path Normalization Tests
  # ============================================================================
  path-normalization:
    name: Path Normalization
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup bootstrap runtime
      run: |
        chmod +x bin/bootstrap/simple
        echo "✓ Bootstrap runtime ready"

    - name: Test path functions
      run: |
        export PATH="$PWD/bin:$PWD/bin/bootstrap:$PATH"

        # Test normalize_path
        RESULT=$(simple -c "use std.platform.{normalize_path}; print normalize_path(\"/usr//bin/../local/bin\")")
        echo "normalize_path result: $RESULT"

        # Test join_path
        RESULT=$(simple -c "use std.platform.{join_path}; print join_path(\"/usr\", \"bin\")")
        echo "join_path result: $RESULT"
        if [[ "$RESULT" == *"/usr"*"bin"* ]]; then
          echo "✅ Path functions working"
        else
          echo "⚠ Unexpected path result"
        fi

  # ============================================================================
  # Process Management Tests
  # ============================================================================
  process-management:
    name: Process Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup bootstrap runtime
      run: |
        chmod +x bin/bootstrap/simple
        echo "✓ Bootstrap runtime ready"

    - name: Test shell execution
      run: |
        export PATH="$PWD/bin:$PWD/bin/bootstrap:$PATH"
        OUTPUT=$(simple -c "use app.io.mod (shell); val r = shell(\"echo test\"); print r.stdout")
        echo "Shell output: '$OUTPUT'"
        if [[ "$OUTPUT" == *"test"* ]]; then
          echo "✅ Shell execution works"
        else
          echo "❌ Shell execution failed"
          exit 1
        fi

  # ============================================================================
  # Linker Auto-Detection
  # ============================================================================
  linker-detection:
    name: Linker Detection
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup bootstrap runtime
      run: |
        chmod +x bin/bootstrap/simple
        echo "✓ Bootstrap runtime ready"

    - name: Install mold
      run: |
        wget -q https://github.com/rui314/mold/releases/download/v2.4.0/mold-2.4.0-x86_64-linux.tar.gz
        tar xzf mold-2.4.0-x86_64-linux.tar.gz
        sudo cp mold-2.4.0-x86_64-linux/bin/mold /usr/local/bin/
        mold --version
      continue-on-error: true

    - name: Test linker detection
      run: |
        export PATH="$PWD/bin:$PWD/bin/bootstrap:$PATH"
        simple -c "use compiler.linker.link (get_linker_info); print get_linker_info()"
      continue-on-error: true

  # ============================================================================
  # Multi-File Link Tests (Native Compilation)
  # ============================================================================
  multi-file-link:
    name: Multi-File Link Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup bootstrap runtime
      run: |
        chmod +x bin/bootstrap/simple
        echo "✓ Bootstrap runtime ready"

    - name: Install gcc
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq gcc
        gcc --version

    - name: Run native compile spec tests
      run: |
        export PATH="$PWD/bin:$PWD/bin/bootstrap:$PATH"
        bin/bootstrap/simple test test/compiler/native_compile_spec.spl

  # ============================================================================
  # Windows MinGW Cross-Compilation
  # ============================================================================
  windows-mingw:
    name: Windows MinGW Cross-Compile
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup bootstrap runtime
      run: |
        chmod +x bin/bootstrap/simple
        echo "✓ Bootstrap runtime ready"

    - name: Install MinGW-w64
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq gcc-mingw-w64-x86-64
        x86_64-w64-mingw32-gcc --version

    - name: Run Windows MinGW cross-compile test
      run: |
        export PATH="$PWD/bin:$PWD/bin/bootstrap:$PATH"
        bin/bootstrap/simple script/test_windows_mingw.spl

  # ============================================================================
  # Build Examples
  # ============================================================================
  build-examples:
    name: Build Examples
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup bootstrap runtime
      run: |
        chmod +x bin/bootstrap/simple
        echo "✓ Bootstrap runtime ready"

    - name: Build hello example
      run: |
        export PATH="$PWD/bin:$PWD/bin/bootstrap:$PATH"
        if [ -f examples/hello.spl ]; then
          simple build examples/hello.spl -o hello
          ./hello
          echo "✅ Built and ran hello example"
        else
          echo "⚠ hello.spl not found"
        fi
      continue-on-error: true

  # ============================================================================
  # Summary
  # ============================================================================
  summary:
    name: All Tests Summary
    runs-on: ubuntu-latest
    needs: [platform-detection, freebsd-tests, path-normalization, process-management, linker-detection, multi-file-link, windows-mingw, build-examples]
    if: always()

    steps:
    - name: Generate summary
      run: |
        echo "# Cross-Platform Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Platform Detection | ${{ needs.platform-detection.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Path Normalization | ${{ needs.path-normalization.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Process Management | ${{ needs.process-management.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Linker Detection | ${{ needs.linker-detection.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Multi-File Link | ${{ needs.multi-file-link.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Windows MinGW | ${{ needs.windows-mingw.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| FreeBSD Tests | ${{ needs.freebsd-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build Examples | ${{ needs.build-examples.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Note:** macOS and Windows VM tests require local QEMU setup." >> $GITHUB_STEP_SUMMARY
        echo "FreeBSD uses Linux binary via Linuxulator." >> $GITHUB_STEP_SUMMARY
        echo "Windows MinGW cross-compiles a PE binary from Linux." >> $GITHUB_STEP_SUMMARY

    - name: Check critical failures
      run: |
        # Linux tests and multi-file link are critical
        FAILED=0
        [ "${{ needs.path-normalization.result }}" != "success" ] && FAILED=1
        [ "${{ needs.process-management.result }}" != "success" ] && FAILED=1
        [ "${{ needs.multi-file-link.result }}" != "success" ] && FAILED=1

        if [ $FAILED -eq 1 ]; then
          echo "❌ Critical tests failed"
          exit 1
        fi

        echo "✅ All critical tests passed"
