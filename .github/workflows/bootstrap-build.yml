name: Bootstrap Multi-Platform Build

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - '.github/workflows/bootstrap-build.yml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  download-bootstrap:
    name: Download Bootstrap Binaries
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download pre-built binaries from v0.5.0
        run: |
          # Create bootstrap directories
          mkdir -p bin/bootstrap/{linux-x86_64,linux-arm64,linux-riscv64,macos-x86_64,macos-arm64,windows-x86_64,windows-arm64}

          # Download linux-x86_64
          gh release download v0.5.0 \
            -p "simple-bootstrap-0.5.0-linux-x86_64.spk" \
            -D /tmp
          mv /tmp/simple-bootstrap-0.5.0-linux-x86_64.spk bin/bootstrap/linux-x86_64/simple
          chmod +x bin/bootstrap/linux-x86_64/simple

          # Download macos-arm64
          gh release download v0.5.0 \
            -p "simple-bootstrap-0.5.0-darwin-arm64.spk" \
            -D /tmp
          mv /tmp/simple-bootstrap-0.5.0-darwin-arm64.spk bin/bootstrap/macos-arm64/simple
          chmod +x bin/bootstrap/macos-arm64/simple

          # Download macos-x86_64
          gh release download v0.5.0 \
            -p "simple-bootstrap-0.5.0-darwin-x86_64.spk" \
            -D /tmp
          mv /tmp/simple-bootstrap-0.5.0-darwin-x86_64.spk bin/bootstrap/macos-x86_64/simple
          chmod +x bin/bootstrap/macos-x86_64/simple

          # For missing platforms, use linux-x86_64 as placeholder
          for platform in linux-arm64 linux-riscv64 windows-x86_64 windows-arm64; do
            if [ "$platform" = "windows-x86_64" ] || [ "$platform" = "windows-arm64" ]; then
              cp bin/bootstrap/linux-x86_64/simple bin/bootstrap/$platform/simple.exe
            else
              cp bin/bootstrap/linux-x86_64/simple bin/bootstrap/$platform/simple
              chmod +x bin/bootstrap/$platform/simple
            fi
          done

          # Show sizes
          ls -lh bin/bootstrap/*/simple*
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create release package
        run: |
          # Create tarball with all binaries
          tar czf simple-bootstrap-multi-platform.tar.gz \
            bin/bootstrap/ \
            bin/simple \
            README.md \
            PLATFORMS.md

          ls -lh simple-bootstrap-multi-platform.tar.gz

      - name: Upload bootstrap binaries
        uses: actions/upload-artifact@v4
        with:
          name: bootstrap-multi-platform
          path: |
            bin/bootstrap/
            simple-bootstrap-multi-platform.tar.gz
          retention-days: 90
