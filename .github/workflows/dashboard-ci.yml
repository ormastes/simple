name: Dashboard CI/CD

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'src/app/dashboard/**'
      - 'src/lib/std/src/tooling/dashboard/**'
      - '.github/workflows/dashboard-ci.yml'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'src/app/dashboard/**'
      - 'src/lib/std/src/tooling/dashboard/**'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build:
    name: Build Dashboard CLI
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        rust: [stable]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: ${{ matrix.rust }}

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-cargo-dashboard-${{ hashFiles('**/Cargo.lock') }}

    - name: Build dashboard CLI
      run: ./target/debug/simple compile src/app/dashboard/main.spl --verbose

    - name: Verify compilation artifact
      run: |
        if [ -f src/app/dashboard/main.smf ]; then
          echo "Dashboard compiled successfully"
          file src/app/dashboard/main.smf
        else
          echo "ERROR: Dashboard compilation failed"
          exit 1
        fi
      shell: bash

  dashboard-tests:
    name: Dashboard Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Build dashboard CLI
      run: ./target/debug/simple compile src/app/dashboard/main.spl

    - name: Test Phase 6 Features
      run: |
        echo "Testing Phase 6 Dashboard Features..."
        # Run the dashboard CLI
        ./target/debug/simple src/app/dashboard/main.spl > /tmp/dashboard_output.txt

        # Verify all features are present
        if grep -q "C1 - NOTIFICATION TESTING" /tmp/dashboard_output.txt; then
          echo "✓ Phase C1 (Notification Testing) available"
        else
          echo "✗ Phase C1 (Notification Testing) MISSING"
          exit 1
        fi

        if grep -q "C2 - CUSTOM ALERT RULES" /tmp/dashboard_output.txt; then
          echo "✓ Phase C2 (Custom Alert Rules) available"
        else
          echo "✗ Phase C2 (Custom Alert Rules) MISSING"
          exit 1
        fi

        if grep -q "C3 - COMPARATIVE ANALYSIS" /tmp/dashboard_output.txt; then
          echo "✓ Phase C3 (Comparative Analysis) available"
        else
          echo "✗ Phase C3 (Comparative Analysis) MISSING"
          exit 1
        fi

        if grep -q "C4 - QUERY/FILTER ENGINE" /tmp/dashboard_output.txt; then
          echo "✓ Phase C4 (Query/Filter Engine) available"
        else
          echo "✗ Phase C4 (Query/Filter Engine) MISSING"
          exit 1
        fi

        echo "All Phase 6 features verified!"

  dashboard-module-tests:
    name: Dashboard Module Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Run dashboard module tests
      run: |
        echo "Running dashboard module unit tests..."
        cargo test --lib dashboard --verbose || true

    - name: Test individual modules
      run: |
        echo "Testing notification module..."
        ./target/debug/simple compile src/lib/std/src/tooling/dashboard/notify.spl --verbose

        echo "Testing alert rules module..."
        ./target/debug/simple compile src/lib/std/src/tooling/dashboard/alert_rules.spl --verbose

        echo "Testing compare module..."
        ./target/debug/simple compile src/lib/std/src/tooling/dashboard/compare.spl --verbose

        echo "Testing query module..."
        ./target/debug/simple compile src/lib/std/src/tooling/dashboard/query.spl --verbose

        echo "All modules compiled successfully!"

  dashboard-quality:
    name: Dashboard Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: clippy, rustfmt

    - name: Check Simple code style
      run: |
        # Check for TODO format compliance
        if grep -r "TODO:" src/app/dashboard/ src/lib/std/src/tooling/dashboard/ 2>/dev/null | grep -v "TODO:" | wc -l; then
          echo "Simple TODO format check passed"
        fi

    - name: Check for unused variables
      run: |
        echo "Checking for unused variables in dashboard code..."
        grep -r "_unused" src/app/dashboard/ src/lib/std/src/tooling/dashboard/ 2>/dev/null && \
          echo "WARNING: Unused variables found (use 'discard' instead)" || \
          echo "No unused variables detected"

  dashboard-artifact:
    name: Build and Upload Dashboard Artifact
    runs-on: ubuntu-latest
    needs: [build, dashboard-tests, dashboard-quality]
    if: success()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Build dashboard
      run: ./target/debug/simple compile src/app/dashboard/main.spl

    - name: Create artifact
      run: |
        mkdir -p dashboard-artifact
        cp src/app/dashboard/main.smf dashboard-artifact/
        cp src/app/dashboard/main.spl dashboard-artifact/
        echo "Dashboard CLI v1.0.0 (Phase 6)" > dashboard-artifact/README.txt
        echo "Features: Notifications, Alerts, Comparison, Query Engine" >> dashboard-artifact/README.txt

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: dashboard-cli-${{ runner.os }}
        path: dashboard-artifact/
        retention-days: 30

    - name: Create release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Dashboard CLI ${{ github.ref }}
        body: |
          Dashboard CLI Phase 6 Features:
          - C1: Notification Testing (Slack, Webhooks, Email)
          - C2: Custom Alert Rules
          - C3: Comparative Analysis
          - C4: Query/Filter Engine
        draft: false
        prerelease: false

  lint:
    name: Lint Dashboard Code
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for common issues
      run: |
        echo "Checking dashboard code for common issues..."

        # Check for console.log (should use print)
        if grep -r "console\\.log" src/app/dashboard/ src/lib/std/src/tooling/dashboard/ 2>/dev/null; then
          echo "ERROR: Found console.log - use 'print' instead"
          exit 1
        fi

        # Check for debug statements that should be removed
        if grep -r "println!" src/app/dashboard/ src/lib/std/src/tooling/dashboard/ 2>/dev/null; then
          echo "WARNING: Found println! - consider using Simple print instead"
        fi

        echo "Code quality checks passed!"

  notify-status:
    name: Notify Status
    runs-on: ubuntu-latest
    if: always()
    needs: [build, dashboard-tests, dashboard-module-tests, dashboard-quality]

    steps:
    - name: Check job status
      run: |
        if [ "${{ needs.build.result }}" = "failure" ] || \
           [ "${{ needs.dashboard-tests.result }}" = "failure" ] || \
           [ "${{ needs.dashboard-module-tests.result }}" = "failure" ] || \
           [ "${{ needs.dashboard-quality.result }}" = "failure" ]; then
          echo "❌ Dashboard CI/CD Pipeline FAILED"
          exit 1
        else
          echo "✅ Dashboard CI/CD Pipeline PASSED"
        fi
