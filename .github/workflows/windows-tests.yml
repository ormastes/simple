name: Windows Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
    inputs:
      run_slow_tests:
        description: 'Run slow tests'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  # ============================================================================
  # Windows x64 Tests (Native)
  # ============================================================================
  windows-x64:
    name: Windows x64 Tests
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Verify bootstrap runtime
      shell: bash
      run: |
        if [ -f "bin/bootstrap/simple" ]; then
          echo "✓ Bootstrap runtime found"
          chmod +x bin/bootstrap/simple
        else
          echo "✗ No bootstrap runtime at bin/bootstrap/simple"
          exit 1
        fi

    - name: Install QEMU
      run: |
        choco install qemu --no-progress -y
        $env:PATH = "C:\Program Files\qemu;$env:PATH"
        qemu-system-i386 --version
        qemu-system-x86_64 --version
        qemu-system-arm --version
        qemu-system-riscv32 --version
      shell: pwsh

    - name: Verify MSVC linker
      run: |
        $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
        if (Test-Path $vswhere) {
          & $vswhere -latest -property installationPath
          Write-Host "MSVC link.exe available"
        } else {
          Write-Host "MSVC not found, will use lld-link"
        }
      shell: pwsh

    - name: Test Simple platform detection
      run: |
        $env:PATH = "${{ github.workspace }}\bin;${{ github.workspace }}\bin\bootstrap;$env:PATH"
        simple -c "use std.platform; print platform_name()"
        simple -c "use std.platform; print dir_sep()"
      shell: pwsh

    - name: Test cross-platform paths
      run: |
        $env:PATH = "${{ github.workspace }}\bin;${{ github.workspace }}\bin\bootstrap;$env:PATH"
        simple -c "use std.fs.path; val p = Path.new('C:/Users/Test').normalize(); print p.to_string()"
      shell: pwsh

    - name: Test Windows command resolution
      run: |
        $env:PATH = "${{ github.workspace }}\bin;${{ github.workspace }}\bin\bootstrap;$env:PATH"
        simple -c "use std.platform; print resolve_command('notepad')"
      shell: pwsh

    - name: Test shell execution
      run: |
        $env:PATH = "${{ github.workspace }}\bin;${{ github.workspace }}\bin\bootstrap;$env:PATH"
        simple -c "use app.io; val r = shell('echo test'); print r.stdout"
      shell: pwsh

    - name: Run Simple tests
      run: |
        $env:PATH = "${{ github.workspace }}\bin;${{ github.workspace }}\bin\bootstrap;$env:PATH"
        simple test
      shell: pwsh
      continue-on-error: true

    - name: Test linker auto-detection
      run: |
        $env:PATH = "${{ github.workspace }}\bin;${{ github.workspace }}\bin\bootstrap;$env:PATH"
        simple -c "use compiler.linker.link; val linker = auto_detect_linker(); print linker.name()"
      shell: pwsh
      continue-on-error: true

    - name: Build example with MSVC
      run: |
        $env:PATH = "${{ github.workspace }}\bin;${{ github.workspace }}\bin\bootstrap;$env:PATH"
        simple build examples/hello.spl -o hello.exe
        if (Test-Path hello.exe) {
          Write-Host "Build successful with Windows linker"
          .\hello.exe
        }
      shell: pwsh
      continue-on-error: true

  # ============================================================================
  # Windows ARM64 Cross-Compilation
  # ============================================================================
  windows-arm64:
    name: Windows ARM64 Cross-Compile
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Verify bootstrap runtime
      shell: bash
      run: |
        if [ -f "bin/bootstrap/simple" ]; then
          echo "✓ Bootstrap runtime found"
          chmod +x bin/bootstrap/simple
        else
          echo "✗ No bootstrap runtime at bin/bootstrap/simple"
          exit 1
        fi

    - name: Build for ARM64
      run: |
        $env:PATH = "${{ github.workspace }}\bin;${{ github.workspace }}\bin\bootstrap;$env:PATH"
        simple build --release --target aarch64-pc-windows-msvc
      shell: pwsh
      continue-on-error: true

  # ============================================================================
  # Cross-Platform Build Matrix
  # ============================================================================
  cross-platform-matrix:
    name: Cross-Platform (${{ matrix.os }} - ${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - os: ubuntu-latest
            arch: x86_64
            platform: linux-x86_64
            shell: bash

          # macOS Apple Silicon
          - os: macos-latest
            arch: aarch64
            platform: darwin-aarch64
            shell: bash

          # Windows
          - os: windows-latest
            arch: x86_64
            platform: windows-x86_64
            shell: pwsh

    defaults:
      run:
        shell: ${{ matrix.shell }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup bootstrap runtime (Unix)
      if: runner.os != 'Windows'
      run: |
        if [ -f "bin/bootstrap/simple" ]; then
          chmod +x bin/bootstrap/simple
          echo "✓ Bootstrap runtime ready"
        else
          echo "✗ No bootstrap runtime"
          exit 1
        fi

    - name: Setup bootstrap runtime (Windows)
      if: runner.os == 'Windows'
      run: |
        if (Test-Path "bin\bootstrap\simple") {
          Write-Host "✓ Bootstrap runtime ready"
        } else {
          Write-Host "✗ No bootstrap runtime"
          exit 1
        }
      shell: pwsh

    - name: Install QEMU (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-system-x86 qemu-system-arm qemu-system-misc
        qemu-system-i386 --version
        qemu-system-riscv32 --version

    - name: Install QEMU (macOS)
      if: startsWith(matrix.os, 'macos')
      run: |
        brew install qemu
        qemu-system-i386 --version
        qemu-system-riscv32 --version

    - name: Install QEMU (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        choco install qemu --no-progress -y
        $env:PATH = "C:\Program Files\qemu;$env:PATH"
        qemu-system-i386 --version
      shell: pwsh

    - name: Test platform detection
      if: runner.os != 'Windows'
      run: |
        export PATH="$PWD/bin:$PWD/bin/bootstrap:$PATH"
        simple -c "use std.platform; print platform_name()"
        simple -c "use std.platform; print dir_sep()"

    - name: Test platform detection (Windows)
      if: runner.os == 'Windows'
      run: |
        $env:PATH = "${{ github.workspace }}\bin;${{ github.workspace }}\bin\bootstrap;$env:PATH"
        simple -c "use std.platform; print platform_name()"
      shell: pwsh

    - name: Run platform-specific tests
      if: runner.os != 'Windows'
      run: |
        export PATH="$PWD/bin:$PWD/bin/bootstrap:$PATH"
        simple test test/platform/ || echo "Platform tests may not exist yet"
      continue-on-error: true

    - name: Run platform-specific tests (Windows)
      if: runner.os == 'Windows'
      run: |
        $env:PATH = "${{ github.workspace }}\bin;${{ github.workspace }}\bin\bootstrap;$env:PATH"
        simple test test/platform/
      shell: pwsh
      continue-on-error: true

  # ============================================================================
  # QEMU Boot Tests (All Platforms)
  # ============================================================================
  qemu-boot-tests:
    name: QEMU Boot Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup bootstrap runtime
      shell: bash
      run: |
        if [ -f "bin/bootstrap/simple" ]; then
          chmod +x bin/bootstrap/simple
          echo "✓ Bootstrap runtime ready"
        else
          echo "✗ No bootstrap runtime"
          exit 1
        fi

    - name: Install QEMU (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-system-x86 qemu-system-arm qemu-system-misc
        qemu-system-i386 --version
        qemu-system-arm --version
        qemu-system-riscv32 --version

    - name: Install QEMU (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install qemu
        qemu-system-i386 --version
        qemu-system-arm --version
        qemu-system-riscv32 --version

    - name: Install QEMU (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        choco install qemu --no-progress -y
        $env:PATH = "C:\Program Files\qemu;$env:PATH"
        qemu-system-i386 --version
        qemu-system-arm --version
        qemu-system-riscv32 --version
      shell: pwsh

    - name: Run QEMU boot tests (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        export PATH="$PWD/bin:$PWD/bin/bootstrap:$PATH"
        simple test test/baremetal/boot_test_spec.spl || echo "Boot tests may not all pass yet"
      continue-on-error: true

    - name: Run QEMU boot tests (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        $env:PATH = "${{ github.workspace }}\bin;${{ github.workspace }}\bin\bootstrap;C:\Program Files\qemu;$env:PATH"
        simple test test/baremetal/boot_test_spec.spl
      shell: pwsh
      continue-on-error: true

  # ============================================================================
  # Linker Integration Tests
  # ============================================================================
  linker-tests:
    name: Linker Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup bootstrap runtime
      shell: bash
      run: |
        if [ -f "bin/bootstrap/simple" ]; then
          chmod +x bin/bootstrap/simple
          echo "✓ Bootstrap runtime ready"
        else
          echo "✗ No bootstrap runtime"
          exit 1
        fi

    - name: Install linkers (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        # Install mold (fastest)
        wget -q https://github.com/rui314/mold/releases/download/v2.4.0/mold-2.4.0-x86_64-linux.tar.gz
        tar xzf mold-2.4.0-x86_64-linux.tar.gz
        sudo cp mold-2.4.0-x86_64-linux/bin/mold /usr/local/bin/
        sudo cp mold-2.4.0-x86_64-linux/libexec/mold/ld.mold /usr/local/bin/
        mold --version

        # lld should be available
        sudo apt-get update
        sudo apt-get install -y lld
        lld --version

    - name: Install linkers (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        # ld is built-in on macOS
        ld -v

    - name: Verify linkers (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        # Check for MSVC link.exe
        $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
        if (Test-Path $vswhere) {
          Write-Host "MSVC available"
        }

        # Check for lld-link (if LLVM installed)
        $lldLink = (Get-Command lld-link -ErrorAction SilentlyContinue)
        if ($lldLink) {
          Write-Host "lld-link available"
        } else {
          Write-Host "lld-link not available (expected)"
        }
      shell: pwsh

    - name: Test linker auto-detection (Unix)
      if: runner.os != 'Windows'
      run: |
        export PATH="$PWD/bin:$PWD/bin/bootstrap:$PATH"
        simple -c "use compiler.linker.link; print get_linker_info()"

    - name: Test linker auto-detection (Windows)
      if: runner.os == 'Windows'
      run: |
        $env:PATH = "${{ github.workspace }}\bin;${{ github.workspace }}\bin\bootstrap;$env:PATH"
        simple -c "use compiler.linker.link; print get_linker_info()"
      shell: pwsh
      continue-on-error: true

    - name: Build test binary (Unix)
      if: runner.os != 'Windows'
      run: |
        export PATH="$PWD/bin:$PWD/bin/bootstrap:$PATH"
        simple build examples/hello.spl -o hello
        ./hello
      continue-on-error: true

    - name: Build test binary (Windows)
      if: runner.os == 'Windows'
      run: |
        $env:PATH = "${{ github.workspace }}\bin;${{ github.workspace }}\bin\bootstrap;$env:PATH"
        simple build examples/hello.spl -o hello.exe
        .\hello.exe
      shell: pwsh
      continue-on-error: true

  # ============================================================================
  # Summary Job
  # ============================================================================
  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [windows-x64, windows-arm64, cross-platform-matrix, qemu-boot-tests, linker-tests]
    if: always()

    steps:
    - name: Check results
      run: |
        echo "Windows x64 tests: ${{ needs.windows-x64.result }}"
        echo "Windows ARM64 cross-compile: ${{ needs.windows-arm64.result }}"
        echo "Cross-platform matrix: ${{ needs.cross-platform-matrix.result }}"
        echo "QEMU boot tests: ${{ needs.qemu-boot-tests.result }}"
        echo "Linker tests: ${{ needs.linker-tests.result }}"

        if [ "${{ needs.windows-x64.result }}" != "success" ]; then
          echo "⚠ Windows x64 tests did not fully pass"
        fi

        echo "✅ Workflow completed"
