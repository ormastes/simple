name: Windows Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
    inputs:
      run_slow_tests:
        description: 'Run slow tests'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  # ============================================================================
  # Linux Validation (verify bootstrap works)
  # ============================================================================
  linux-validation:
    name: Linux Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup bootstrap runtime
      run: |
        chmod +x bin/bootstrap/simple
        echo "✓ Bootstrap runtime ready"

    - name: Test Simple platform detection
      run: |
        export PATH="$PWD/bin:$PWD/bin/bootstrap:$PATH"
        simple -c "use std.platform.{is_linux, dir_sep}; print is_linux(); print dir_sep()"

    - name: Test shell execution
      run: |
        export PATH="$PWD/bin:$PWD/bin/bootstrap:$PATH"
        OUTPUT=$(simple -c "use app.io.mod (shell); val r = shell(\"echo test\"); print r.stdout")
        echo "Shell output: '$OUTPUT'"
        if [[ "$OUTPUT" == *"test"* ]]; then
          echo "✅ Shell execution works"
        else
          echo "❌ Shell execution failed"
          exit 1
        fi

    - name: Run Simple tests
      run: |
        export PATH="$PWD/bin:$PWD/bin/bootstrap:$PATH"
        bin/simple test
      continue-on-error: true

  # ============================================================================
  # Windows x64 Tests (Native)
  # NOTE: Currently skipped - no native Windows binary available.
  #       All tests use continue-on-error since bootstrap is Linux ELF.
  # ============================================================================
  windows-x64:
    name: Windows x64 Tests
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Verify bootstrap runtime exists
      shell: bash
      run: |
        if [ -f "bin/bootstrap/simple" ]; then
          echo "✓ Bootstrap runtime found (Linux ELF - cannot execute on Windows)"
          echo "⚠ Native Windows binary not yet available"
          echo "  Windows-specific tests will be skipped"
        else
          echo "✗ No bootstrap runtime at bin/bootstrap/simple"
        fi

    - name: Windows environment info
      run: |
        Write-Host "OS: $env:OS"
        Write-Host "Architecture: $env:PROCESSOR_ARCHITECTURE"
        Write-Host "Note: Windows tests require native binary (not yet available)"
      shell: pwsh

  # ============================================================================
  # Windows ARM64 Cross-Compilation
  # ============================================================================
  windows-arm64:
    name: Windows ARM64 Cross-Compile
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Verify bootstrap runtime
      shell: bash
      run: |
        if [ -f "bin/bootstrap/simple" ]; then
          echo "✓ Bootstrap runtime found (Linux ELF)"
          echo "⚠ Cross-compilation requires native Windows binary (not yet available)"
        else
          echo "✗ No bootstrap runtime"
        fi

  # ============================================================================
  # Linker Integration Tests (Linux only - has working binary)
  # ============================================================================
  linker-tests:
    name: Linker Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup bootstrap runtime
      run: |
        chmod +x bin/bootstrap/simple
        echo "✓ Bootstrap runtime ready"

    - name: Install mold
      run: |
        wget -q https://github.com/rui314/mold/releases/download/v2.4.0/mold-2.4.0-x86_64-linux.tar.gz
        tar xzf mold-2.4.0-x86_64-linux.tar.gz
        sudo cp mold-2.4.0-x86_64-linux/bin/mold /usr/local/bin/
        mold --version
      continue-on-error: true

    - name: Install lld
      run: |
        sudo apt-get update
        sudo apt-get install -y lld
        lld --version
      continue-on-error: true

    - name: Test linker auto-detection
      run: |
        export PATH="$PWD/bin:$PWD/bin/bootstrap:$PATH"
        simple -c "use compiler.linker.link (get_linker_info); print get_linker_info()"
      continue-on-error: true

    - name: Build test binary
      run: |
        export PATH="$PWD/bin:$PWD/bin/bootstrap:$PATH"
        if [ -f examples/hello.spl ]; then
          simple build examples/hello.spl -o hello
          ./hello
          echo "✅ Build and run successful"
        else
          echo "⚠ hello.spl not found"
        fi
      continue-on-error: true

  # ============================================================================
  # Summary Job
  # ============================================================================
  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [linux-validation, windows-x64, windows-arm64, linker-tests]
    if: always()

    steps:
    - name: Check results
      run: |
        echo "Linux validation: ${{ needs.linux-validation.result }}"
        echo "Windows x64 tests: ${{ needs.windows-x64.result }}"
        echo "Windows ARM64 cross-compile: ${{ needs.windows-arm64.result }}"
        echo "Linker tests: ${{ needs.linker-tests.result }}"

        # Only Linux validation is critical
        if [ "${{ needs.linux-validation.result }}" != "success" ]; then
          echo "❌ Linux validation failed"
          exit 1
        fi

        echo "✅ Critical tests passed"
        echo ""
        echo "Note: Windows tests are informational until native binaries are available"
