# GPU Async Streams - Command queues for overlapped GPU operations

use std.core.result.*
use std.gpu.host.async_nogc_mut.buffer.GpuError
use std.gpu.host.async_nogc_mut.kernel.KernelEvent

# GPU command stream
struct Stream:
    _handle: u64

impl Stream:
    fn new() -> Result<Stream, GpuError>
    async fn sync(self) -> Result<(), GpuError>
    fn is_idle() -> bool
    fn record_event() -> Result<KernelEvent, GpuError>
    async fn wait_event(self, event: KernelEvent) -> Result<(), GpuError>

    # =========================================================================
    # Helper Methods
    # =========================================================================

    fn get_handle() -> u64:
        """Get underlying stream handle.

        Returns:
            Stream handle identifier

        Example:
            stream.get_handle()  # → 0x7f8a1c000000
        """
        return self._handle

    fn is_busy() -> bool:
        """Check if stream has pending operations.

        Returns:
            true if stream is busy (not idle)

        Example:
            stream.is_busy()  # → false
        """
        return not self.is_idle()

    async fn synchronize(self) -> Result<(), GpuError>:
        """Wait for all operations in stream to complete (alias for sync).

        Returns:
            Result with () on success, GpuError on failure

        Example:
            await stream.synchronize()
        """
        return await self.sync()

    fn try_record_event() -> Option<KernelEvent>:
        """Try to record event, returning None on error.

        Returns:
            Some(event) on success, None on failure

        Example:
            if let Some(event) = stream.try_record_event():
                print("Event recorded")
        """
        match self.record_event():
            case Ok(event):
                return Some(event)
            case Err(_):
                return None

    fn summary() -> str:
        """Get stream summary.

        Returns:
            Human-readable summary

        Example:
            stream.summary()
            # → "Stream: handle=0x7f8a1c000000, idle=true"
        """
        let idle_str = if self.is_idle() { "true" } else { "false" }
        return "Stream: handle=0x{self._handle:x}, idle={idle_str}"

# Default stream
extern fn default_stream() -> Stream
extern fn create_streams(count: u32) -> Result<Array<Stream>, GpuError>
