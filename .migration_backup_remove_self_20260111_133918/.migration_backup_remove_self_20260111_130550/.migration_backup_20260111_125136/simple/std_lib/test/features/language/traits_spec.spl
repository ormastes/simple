# Traits Feature Specification
# Feature #31: Trait definitions and implementations
# Category: Language | Difficulty: 4 | Status: Complete

# =====================================================
# Feature Metadata
# =====================================================

class FeatureMetadata:
    id: Int
    name: String
    category: String
    difficulty: Int
    status: String
    impl_type: String
    spec_ref: String
    files: List[String]
    tests: List[String]
    description: String
    code_examples: List[String]
    dependencies: List[Int]
    required_by: List[Int]
    notes: String

# Feature Definition
let FEATURE = FeatureMetadata {
    id: 31,
    name: 'Traits',
    category: 'Language',
    difficulty: 4,
    status: 'Complete',
    impl_type: 'Rust',
    spec_ref: 'doc/spec/traits.md',
    files: [
        'src/compiler/src/interpreter.rs',
        'src/compiler/src/interpreter_method.rs',
        'src/parser/src/statements/mod.rs'
    ],
    tests: [
        'src/driver/tests/interpreter_oop.rs'
    ],
    description: 'Trait definitions for shared behavior. Supports impl Trait for Type, default methods, dynamic dispatch with dyn Trait, and TraitObject coercion.',
    code_examples: [],
    dependencies: [1, 2, 11, 14],
    required_by: [32],
    notes: 'Traits enable polymorphism. dyn Trait creates TraitObjects for runtime dispatch.'
}

# =====================================================
# BDD Specification Tests
# =====================================================

print('============================================================')
print('  TRAITS FEATURE SPECIFICATION (#31)')
print('  Category: Language | Difficulty: 4 | Status: Complete')
print('============================================================')
print('')

let mut passed = 0
let mut failed = 0

# -----------------------------------------------------
# Basic Trait Definition
# -----------------------------------------------------

print('describe Trait definition:')
print('  context simple trait:')
print('    it defines a trait with method:')

trait Summable:
    fn sum(self):
        return 0

struct Point:
    x: i64
    y: i64

impl Summable for Point:
    fn sum(self):
        return self.x + self.y

let p = Point { x: 10, y: 20 }
if p.sum() == 30:
    print('      [PASS] trait with method')
    passed = passed + 1
else:
    print('      [FAIL] trait with method')
    failed = failed + 1

print('')
print('  context trait on multiple types:')
print('    it implements trait for different types:')

trait Valuable:
    fn value(self):
        return 0

struct Coin:
    amount: i64

struct Bill:
    amount: i64

impl Valuable for Coin:
    fn value(self):
        return self.amount

impl Valuable for Bill:
    fn value(self):
        return self.amount * 100

let c = Coin { amount: 5 }
let b = Bill { amount: 2 }
if c.value() + b.value() == 205:
    print('      [PASS] trait on multiple types')
    passed = passed + 1
else:
    print('      [FAIL] trait on multiple types')
    failed = failed + 1

# -----------------------------------------------------
# Trait Method with Arguments
# -----------------------------------------------------

print('')
print('describe Trait method arguments:')
print('  context method with parameters:')
print('    it passes arguments to trait method:')

trait Calculator:
    fn add(self, n):
        return 0

struct Counter:
    value: i64

impl Calculator for Counter:
    fn add(self, n):
        return self.value + n

let cnt = Counter { value: 50 }
if cnt.add(25) == 75:
    print('      [PASS] trait method with args')
    passed = passed + 1
else:
    print('      [FAIL] trait method with args')
    failed = failed + 1

# -----------------------------------------------------
# Default Methods
# -----------------------------------------------------

print('')
print('describe Default methods:')
print('  context trait with default implementation:')
print('    it uses default when not overridden:')

trait Greeter:
    fn greet(self) -> i64:
        return 42
    fn farewell(self) -> i64:
        return 99

struct Person:
    name: str

impl Greeter for Person:
    fn greet(self) -> i64:
        return 42

let person = Person { name: "Alice" }
if person.farewell() == 99:
    print('      [PASS] uses default method')
    passed = passed + 1
else:
    print('      [FAIL] uses default method')
    failed = failed + 1

print('    it allows overriding default:')

trait Greeter2:
    fn greet(self) -> i64:
        return 42
    fn farewell(self) -> i64:
        return 99

struct Person2:
    name: str

impl Greeter2 for Person2:
    fn greet(self) -> i64:
        return 42
    fn farewell(self) -> i64:
        return 7

let person2 = Person2 { name: "Bob" }
if person2.farewell() == 7:
    print('      [PASS] overrides default method')
    passed = passed + 1
else:
    print('      [FAIL] overrides default method')
    failed = failed + 1

print('')
print('  context default calling abstract:')
print('    it default method calls required method:')

trait Compute:
    fn compute(self) -> i64
    fn double(self) -> i64:
        return self.compute() * 2

struct Value:
    n: i64

impl Compute for Value:
    fn compute(self) -> i64:
        return self.n

let v = Value { n: 21 }
if v.double() == 42:
    print('      [PASS] default calls abstract')
    passed = passed + 1
else:
    print('      [FAIL] default calls abstract')
    failed = failed + 1

# -----------------------------------------------------
# Dynamic Dispatch (dyn Trait)
# -----------------------------------------------------

print('')
print('describe Dynamic dispatch:')
print('  context dyn Trait syntax:')
print('    it parses dyn Trait in function:')

trait Drawable:
    fn draw(self) -> i64

struct Circle:
    radius: i64

impl Drawable for Circle:
    fn draw(self) -> i64:
        return self.radius * 2

fn process(obj: dyn Drawable) -> i64:
    return 42

let circle = Circle { radius: 21 }
if circle.draw() == 42:
    print('      [PASS] dyn Trait syntax')
    passed = passed + 1
else:
    print('      [FAIL] dyn Trait syntax')
    failed = failed + 1

print('')
print('  context TraitObject coercion:')
print('    it coerces to dyn Trait via let:')

trait Drawable2:
    fn draw(self) -> i64

struct Circle2:
    radius: i64

impl Drawable2 for Circle2:
    fn draw(self) -> i64:
        return self.radius * 3

let c2 = Circle2 { radius: 7 }
let drawable: dyn Drawable2 = c2
if drawable.draw() == 21:
    print('      [PASS] TraitObject via let')
    passed = passed + 1
else:
    print('      [FAIL] TraitObject via let')
    failed = failed + 1

print('    it coerces via function parameter:')

trait Shape:
    fn area(self) -> i64

struct Square:
    side: i64

impl Shape for Square:
    fn area(self) -> i64:
        return self.side * self.side

fn process_shape(s: dyn Shape) -> i64:
    return s.area()

let sq = Square { side: 6 }
if process_shape(sq) == 36:
    print('      [PASS] TraitObject via parameter')
    passed = passed + 1
else:
    print('      [FAIL] TraitObject via parameter')
    failed = failed + 1

print('')
print('  context multiple types with dyn:')
print('    it dispatches to correct type:')

trait Describable:
    fn value(self) -> i64

struct TypeA:
    x: i64

struct TypeB:
    y: i64

impl Describable for TypeA:
    fn value(self) -> i64:
        return self.x * 10

impl Describable for TypeB:
    fn value(self) -> i64:
        return self.y + 100

fn get_value(d: dyn Describable) -> i64:
    return d.value()

let a = TypeA { x: 5 }
let b = TypeB { y: 7 }
if get_value(a) + get_value(b) == 157:
    print('      [PASS] multiple types dyn dispatch')
    passed = passed + 1
else:
    print('      [FAIL] multiple types dyn dispatch')
    failed = failed + 1

# -----------------------------------------------------
# Polymorphism without dyn
# -----------------------------------------------------

print('')
print('describe Static polymorphism:')
print('  context multiple impls:')
print('    it uses correct impl for each type:')

trait Shape2:
    fn area(self) -> i64

struct Square2:
    side: i64

struct Rectangle:
    width: i64
    height: i64

impl Shape2 for Square2:
    fn area(self) -> i64:
        return self.side * self.side

impl Shape2 for Rectangle:
    fn area(self) -> i64:
        return self.width * self.height

let sq2 = Square2 { side: 5 }
let rect = Rectangle { width: 4, height: 3 }
if sq2.area() + rect.area() == 37:
    print('      [PASS] static polymorphism')
    passed = passed + 1
else:
    print('      [FAIL] static polymorphism')
    failed = failed + 1

# =====================================================
# Documentation Output
# =====================================================

print('')
print('============================================================')
print('  GENERATED DOCUMENTATION')
print('============================================================')
print('')
print('# Traits')
print('')
print('**Feature ID:** #31')
print('**Category:** Language')
print('**Difficulty:** Level 4/5')
print('**Status:** Complete')
print('**Implementation:** Rust')
print('')
print('## Description')
print('')
print(FEATURE.description)
print('')
print('## Syntax')
print('')
print('```simple')
print('trait TraitName:')
print('    fn required_method(self) -> Type')
print('    fn default_method(self) -> Type:')
print('        return default_value')
print('')
print('impl TraitName for StructName:')
print('    fn required_method(self) -> Type:')
print('        return implementation')
print('```')
print('')
print('## Dynamic Dispatch')
print('')
print('```simple')
print('let obj: dyn Trait = concrete_value  # TraitObject coercion')
print('fn process(x: dyn Trait) -> Type     # Function parameter coercion')
print('```')
print('')
print('## Notes')
print('')
print(FEATURE.notes)

# Summary
print('')
print('============================================================')
print('  TEST SUMMARY')
print('============================================================')
let total = passed + failed
print("Passed: {passed}")
print("Failed: {failed}")
print("Total:  {total}")
if failed == 0:
    print('All tests PASSED!')
print('============================================================')
