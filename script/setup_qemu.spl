#!/usr/bin/env simple
# QEMU Setup Script
# Installs or verifies QEMU for all required architectures

# Direct extern fn declarations (bootstrap runtime)
extern fn rt_process_run(cmd: text, args: [text]) -> (text, text, i64)
extern fn rt_file_exists(path: text) -> bool

fn main():
    print "QEMU Setup for Simple Bare-Metal Testing"
    print "========================================"
    print ""

    # Check each architecture
    val required_archs = [
        ("i386", "qemu-system-i386"),
        ("x86_64", "qemu-system-x86_64"),
        ("arm", "qemu-system-arm"),
        ("aarch64", "qemu-system-aarch64"),
        ("riscv32", "qemu-system-riscv32"),
        ("riscv64", "qemu-system-riscv64")
    ]

    var missing: [text] = []

    print "Checking installed QEMU emulators:"
    print ""

    for (arch, cmd) in required_archs:
        if command_exists(cmd):
            val version = get_qemu_version(cmd)
            print "âœ“ {arch:12} {cmd:25} {version}"
        else:
            print "âœ— {arch:12} {cmd:25} NOT FOUND"
            missing.push(arch)

    print ""

    if missing.len() == 0:
        print "========================================="
        print "SUCCESS! All QEMU emulators available"
        print "========================================="
        print ""
        print "You can now run bare-metal tests:"
        print "  simple test test/baremetal/"
        return

    # Provide installation instructions
    print "Missing architectures: {missing.join(\", \")}"
    print ""
    print "========================================="
    print "Installation Required"
    print "========================================="
    print ""

    # Determine which packages to install
    var packages: [text] = []

    if missing.contains("arm") or missing.contains("aarch64"):
        packages.push("qemu-system-arm")

    if missing.contains("riscv32") or missing.contains("riscv64"):
        packages.push("qemu-system-misc")

    print "Required packages:"
    for pkg in packages:
        print "  - {pkg}"
    print ""

    print "Ubuntu/Debian:"
    print "  sudo apt update"
    print "  sudo apt install {packages.join(\" \")}"
    print ""

    print "macOS:"
    print "  brew install qemu"
    print ""

    print "Windows (MSYS2):"
    print "  pacman -S mingw-w64-x86_64-qemu"
    print ""

    print "Or build from source:"
    print "  simple run script/download_qemu.spl"
    print "  simple run script/build_qemu.spl"

fn command_exists(cmd: text) -> bool:
    val (stdout, stderr, exit_code) = rt_process_run("which", [cmd])
    exit_code == 0

fn get_qemu_version(cmd: text) -> text:
    val (stdout, stderr, exit_code) = rt_process_run(cmd, ["--version"])
    if exit_code != 0:
        return "unknown"

    # Parse version from output
    # Example: "QEMU emulator version 8.2.2 (Debian 1:8.2.2+ds-0ubuntu1.10)"
    val lines = stdout.split("\n")
    if lines.len() > 0:
        val first_line = lines[0]
        val parts = first_line.split(" ")
        if parts.len() >= 4:
            return parts[3]

    "unknown"
