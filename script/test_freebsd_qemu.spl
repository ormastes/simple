#!/usr/bin/env simple
# Test Simple on FreeBSD via QEMU
#
# Runs the full multi-file native compilation pipeline inside FreeBSD
# using Linuxulator to execute the Linux bootstrap binary.
#
# Replaces test-freebsd-qemu.sh with a Simple implementation.
#
# Usage: bin/release/simple script/test_freebsd_qemu.spl

extern fn rt_file_exists(path: text) -> bool
extern fn rt_cli_get_args() -> [str]

use app.io.file_shell.{shell, shell_output, file_write}
use app.vm.qemu_manager.{VmConfig, freebsd_config, vm_start, vm_stop, vm_is_running, vm_wait_ssh, vm_exec, vm_copy_to}

fn main() -> i64:
    print "=========================================="
    print "Simple FreeBSD QEMU Multi-File Link Test"
    print "=========================================="
    print ""

    val config = freebsd_config()

    # Step 1: Check prerequisites
    print "Step 1: Check Prerequisites"
    print "----------------------------------------"

    val qemu_check = shell_output("which qemu-system-x86_64 2>/dev/null")
    if qemu_check == "":
        print "SKIP: QEMU not found"
        return 0

    if not rt_file_exists(config.image_path):
        print "SKIP: FreeBSD VM image not found at {config.image_path}"
        print "Run: bin/release/simple script/setup_freebsd_vm.spl"
        return 0

    if not rt_file_exists("bin/release/simple"):
        print "FAIL: Simple bootstrap binary not found"
        return 1

    print "Prerequisites OK"
    print ""

    # Step 2: Start FreeBSD VM
    print "Step 2: Start FreeBSD VM"
    print "----------------------------------------"
    if not vm_is_running(config):
        if not vm_start(config):
            print "FAIL: Could not start FreeBSD VM"
            return 1
    else:
        print "FreeBSD VM already running"
    print ""

    # Step 3: Wait for SSH
    print "Step 3: Wait for SSH"
    print "----------------------------------------"
    if not vm_wait_ssh(config, 60):
        print "FAIL: SSH timeout"
        return 1
    print ""

    # Step 4: Setup environment
    print "Step 4: Setup FreeBSD Environment"
    print "----------------------------------------"
    vm_exec(config, "kldload linux64 2>/dev/null || true")
    vm_exec(config, "pkg install -y linux-c7 >/dev/null 2>&1 || true")
    vm_exec(config, "pkg install -y gcc >/dev/null 2>&1 || true")
    print "Environment ready"
    print ""

    # Step 5: Copy bootstrap binary and compile sources
    print "Step 5: Copy Files to VM"
    print "----------------------------------------"
    if not vm_copy_to(config, "bin/release/simple", "/tmp/simple-bootstrap"):
        print "FAIL: Could not copy bootstrap"
        return 1
    vm_exec(config, "chmod +x /tmp/simple-bootstrap")

    if not vm_copy_to(config, "src/app/compile/native.spl", "/tmp/native.spl"):
        print "FAIL: Could not copy native.spl"
        return 1
    if not vm_copy_to(config, "src/app/compile/c_codegen.spl", "/tmp/c_codegen.spl"):
        print "FAIL: Could not copy c_codegen.spl"
        return 1
    if not vm_copy_to(config, "src/app/compile/c_runtime.c", "/tmp/c_runtime.c"):
        print "FAIL: Could not copy c_runtime.c"
        return 1
    print "Files copied"
    print ""

    # Step 6: Write multi-file test sources inside VM
    print "Step 6: Create Multi-File Test Sources"
    print "----------------------------------------"

    val base_spl = "fn square(x: i64) -> i64:\n    return x * x\n\nexport square\n"
    val mid_spl = "use base.{square}\n\nfn sum_of_squares(a: i64, b: i64) -> i64:\n    return square(a) + square(b)\n\nexport sum_of_squares\n"
    val main_spl = "use mid.{sum_of_squares}\n\nfn main():\n    val result = sum_of_squares(3, 4)\n    print \"{result}\"\n"

    # Write test files locally, then copy
    file_write("/tmp/freebsd_test_base.spl", base_spl)
    file_write("/tmp/freebsd_test_mid.spl", mid_spl)
    file_write("/tmp/freebsd_test_main.spl", main_spl)

    vm_copy_to(config, "/tmp/freebsd_test_base.spl", "/tmp/base.spl")
    vm_copy_to(config, "/tmp/freebsd_test_mid.spl", "/tmp/mid.spl")
    vm_copy_to(config, "/tmp/freebsd_test_main.spl", "/tmp/main.spl")
    print "Test sources created"
    print ""

    # Step 7: Run full pipeline inside VM
    print "Step 7: Run Native Compilation Pipeline"
    print "----------------------------------------"
    val (compile_out, compile_err, compile_exit) = vm_exec(config, "/tmp/simple-bootstrap /tmp/native.spl /tmp/main.spl /tmp/output --linked")
    if compile_exit != 0:
        print "FAIL: Compilation failed inside VM"
        if compile_err != "":
            print compile_err
        if compile_out != "":
            print compile_out
        return 1
    print "Compilation: {compile_out}"
    print ""

    # Step 8: Execute binary and verify output
    print "Step 8: Verify Output"
    print "----------------------------------------"
    val (run_out, run_err, run_exit) = vm_exec(config, "/tmp/output")
    val output = run_out.trim()
    if output == "25":
        print "Output: {output}"
        print ""
        print "=========================================="
        print "PASS: FreeBSD Multi-File Link Test"
        print "=========================================="
        print ""
        print "Summary:"
        print "  VM: FreeBSD x86_64 (via QEMU)"
        print "  Method: Linuxulator (Linux binary)"
        print "  Pipeline: native.spl --linked"
        print "  Test: 3-file dependency chain"
        print "  Expected: 25 (3^2 + 4^2)"
        print "  Got: {output}"
        return 0
    else:
        print "FAIL: Expected output '25', got '{output}'"
        if run_err != "":
            print "Stderr: {run_err}"
        return 1
