#!/usr/bin/env simple
# Setup FreeBSD VM for Simple Testing
#
# Downloads FreeBSD VM image and prepares QEMU environment.
# Replaces setup-freebsd-vm.sh with a Simple implementation.
#
# Usage: bin/release/simple script/setup_freebsd_vm.spl

extern fn rt_file_exists(path: text) -> bool
extern fn rt_cli_get_args() -> [str]

use app.io.file_shell.{shell, shell_output, file_write}

fn main():
    val home = shell_output("echo $HOME").trim()
    val vm_dir = "{home}/vms/freebsd"
    val freebsd_version = "14.3-RELEASE"
    val freebsd_arch = "amd64"
    val image_file = "FreeBSD-{freebsd_version}-{freebsd_arch}.qcow2"

    print "======================================"
    print "FreeBSD VM Setup for Simple Testing"
    print "======================================"
    print ""

    # Step 1: Check QEMU
    print "Step 1: Verify QEMU Installation"
    print "--------------------------------------"
    val qemu_check = shell_output("which qemu-system-x86_64 2>/dev/null")
    if qemu_check == "":
        print "Error: QEMU not found"
        print ""
        print "Please install QEMU:"
        print "  sudo apt-get install -y qemu-system-x86 qemu-utils"
        return
    val qemu_version = shell_output("qemu-system-x86_64 --version 2>/dev/null").split("\n")[0]
    print "QEMU installed: {qemu_version}"
    print ""

    # Step 2: Create VM directory
    print "Step 2: Create VM Directory"
    print "--------------------------------------"
    shell("mkdir -p {vm_dir}")
    print "VM directory: {vm_dir}"
    print ""

    # Step 3: Download FreeBSD image
    print "Step 3: Download FreeBSD Image"
    print "--------------------------------------"
    val image_path = "{vm_dir}/{image_file}"
    if rt_file_exists(image_path):
        print "Image already exists: {image_file}"
    else:
        val image_url = "https://download.freebsd.org/releases/VM-IMAGES/{freebsd_version}/{freebsd_arch}/Latest/{image_file}.xz"
        print "Downloading FreeBSD {freebsd_version} ({freebsd_arch})..."
        print "URL: {image_url}"
        print ""
        val (out, err, dl_exit) = shell("wget --progress=bar:force -O {image_path}.xz {image_url}")
        if dl_exit != 0:
            print "Error: Download failed"
            print err
            return
        print "Extracting image..."
        val (out2, err2, xz_exit) = shell("unxz {image_path}.xz")
        if xz_exit != 0:
            print "Error: Extraction failed"
            return
        print "Downloaded and extracted: {image_file}"
    print ""

    # Step 4: Create interactive start script
    print "Step 4: Create VM Start Scripts"
    print "--------------------------------------"
    val start_script = "{vm_dir}/start-freebsd.sh"
    var script_content = "#!/bin/bash\n"
    script_content = script_content + "# Start FreeBSD VM with SSH forwarding\n"
    script_content = script_content + "VM_DIR=\"$(dirname \"$0\")\"\n"
    script_content = script_content + "cd \"$VM_DIR\"\n"
    script_content = script_content + "echo 'Starting FreeBSD VM (SSH: ssh -p 2222 root@localhost)'\n"
    script_content = script_content + "qemu-system-x86_64 \\\n"
    script_content = script_content + "  -machine type=q35,accel=kvm:tcg \\\n"
    script_content = script_content + "  -cpu host -smp 4 -m 4G \\\n"
    script_content = script_content + "  -drive file={image_file},if=virtio,format=qcow2 \\\n"
    script_content = script_content + "  -netdev user,id=net0,hostfwd=tcp::2222-:22 \\\n"
    script_content = script_content + "  -device virtio-net-pci,netdev=net0 \\\n"
    script_content = script_content + "  -display none -serial mon:stdio\n"
    file_write(start_script, script_content)
    shell("chmod +x {start_script}")
    print "Created: {start_script}"

    # Step 5: Create daemon start script
    var daemon_content = "#!/bin/bash\n"
    daemon_content = daemon_content + "# Start FreeBSD VM in background\n"
    daemon_content = daemon_content + "VM_DIR=\"$(dirname \"$0\")\"\n"
    daemon_content = daemon_content + "cd \"$VM_DIR\"\n"
    daemon_content = daemon_content + "if [ -f /tmp/freebsd-qemu.pid ]; then\n"
    daemon_content = daemon_content + "  PID=$(cat /tmp/freebsd-qemu.pid)\n"
    daemon_content = daemon_content + "  if kill -0 $PID 2>/dev/null; then\n"
    daemon_content = daemon_content + "    echo \"FreeBSD VM already running (PID: $PID)\"\n"
    daemon_content = daemon_content + "    exit 0\n"
    daemon_content = daemon_content + "  fi\n"
    daemon_content = daemon_content + "fi\n"
    daemon_content = daemon_content + "echo 'Starting FreeBSD VM in background...'\n"
    daemon_content = daemon_content + "qemu-system-x86_64 \\\n"
    daemon_content = daemon_content + "  -machine type=q35,accel=kvm:tcg \\\n"
    daemon_content = daemon_content + "  -cpu host -smp 2 -m 2G \\\n"
    daemon_content = daemon_content + "  -drive file={image_file},if=virtio,format=qcow2 \\\n"
    daemon_content = daemon_content + "  -netdev user,id=net0,hostfwd=tcp::2222-:22 \\\n"
    daemon_content = daemon_content + "  -device virtio-net-pci,netdev=net0 \\\n"
    daemon_content = daemon_content + "  -display none -daemonize -pidfile /tmp/freebsd-qemu.pid\n"
    daemon_content = daemon_content + "sleep 2\n"
    daemon_content = daemon_content + "if [ -f /tmp/freebsd-qemu.pid ]; then\n"
    daemon_content = daemon_content + "  echo \"FreeBSD VM started (PID: $(cat /tmp/freebsd-qemu.pid))\"\n"
    daemon_content = daemon_content + "  echo 'SSH: ssh -p 2222 root@localhost'\n"
    daemon_content = daemon_content + "else\n"
    daemon_content = daemon_content + "  echo 'Failed to start VM'\n"
    daemon_content = daemon_content + "  exit 1\n"
    daemon_content = daemon_content + "fi\n"
    val daemon_script = "{vm_dir}/start-freebsd-daemon.sh"
    file_write(daemon_script, daemon_content)
    shell("chmod +x {daemon_script}")
    print "Created: {daemon_script}"
    print ""

    # Summary
    print "======================================"
    print "FreeBSD VM Setup Complete"
    print "======================================"
    print ""
    print "Location: {vm_dir}"
    print "Image:    {image_file}"
    print ""
    print "Usage:"
    print "  Interactive: {vm_dir}/start-freebsd.sh"
    print "  Background:  {vm_dir}/start-freebsd-daemon.sh"
    print ""
    print "First-time setup:"
    print "  1. Start VM and wait for boot"
    print "  2. Login as 'root' (default password: empty or 'root')"
    print "  3. Set password: passwd"
    print "  4. Enable SSH: echo 'sshd_enable=\"YES\"' >> /etc/rc.conf && service sshd start"
    print "  5. Enable Linuxulator: kldload linux64 && sysrc linux_enable=\"YES\""
    print ""
    print "Test Simple:"
    print "  bin/release/simple script/test_freebsd_qemu.spl"
    print ""
