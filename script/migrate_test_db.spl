#!/usr/bin/env simple
# Migrate test database to new schema
#
# Adds missing tables: test_runs, test_results
# Preserves existing data: strings, files, suites, tests

use lib.database.core (SdnDatabase, SdnTable, StringInterner)
use lib.database.test (create_test_database)

fn main() -> i32:
    val db_path = "doc/test/test_db.sdn"

    print "=== Test Database Migration ==="
    print "File: {db_path}"
    print ""

    # Check if database exists
    if not file_exists(db_path):
        print "Error: Database file not found: {db_path}"
        return 1

    # Create backup
    val backup_path = "{db_path}.backup"
    print "Creating backup: {backup_path}"
    if not file_copy(db_path, backup_path):
        print "Error: Failed to create backup"
        return 1

    print "✓ Backup created"
    print ""

    # Try to load old database
    print "Loading old database..."
    val old_db_opt = SdnDatabase.load(db_path)

    if not old_db_opt.?:
        print "Warning: Could not load old database (may be corrupted)"
        print "Creating new database from scratch..."

        # Create new database with correct schema
        var new_db = create_test_database(db_path)
        new_db.save()

        print "✓ New database created with correct schema"
        print ""
        print "Old data could not be migrated (old file backed up)"
        return 0

    val old_db = old_db_opt?
    print "✓ Old database loaded"
    print ""

    # Create new database with correct schema
    print "Creating new database with correct schema..."
    var new_db = create_test_database(db_path)

    # Migrate existing tables
    print "Migrating tables..."

    # 1. Migrate strings table (StringInterner)
    if val Some(strings_table) = old_db.get_table("strings"):
        print "  ✓ Migrating strings table ({strings_table.rows.len()} rows)"
        new_db.db.set_table("strings", strings_table)
    else:
        print "  ⚠ No strings table found (creating empty)"

    # 2. Migrate files table
    if val Some(files_table) = old_db.get_table("files"):
        print "  ✓ Migrating files table ({files_table.rows.len()} rows)"
        new_db.db.set_table("files", files_table)
    else:
        print "  ⚠ No files table found (creating empty)"

    # 3. Migrate suites table
    if val Some(suites_table) = old_db.get_table("suites"):
        print "  ✓ Migrating suites table ({suites_table.rows.len()} rows)"
        new_db.db.set_table("suites", suites_table)
    else:
        print "  ⚠ No suites table found (creating empty)"

    # 4. Migrate tests table
    if val Some(tests_table) = old_db.get_table("tests"):
        print "  ✓ Migrating tests table ({tests_table.rows.len()} rows)"
        new_db.db.set_table("tests", tests_table)
    else:
        print "  ⚠ No tests table found (creating empty)"

    # 5. test_runs table - should be empty (new table)
    print "  ✓ Added test_runs table (empty)"

    # 6. test_results table - should be empty (new table)
    print "  ✓ Added test_results table (empty)"

    print ""

    # Save new database
    print "Saving migrated database..."
    if new_db.save():
        print "✓ Migration complete!"
        print ""
        print "Summary:"
        print "  - Backup: {backup_path}"
        print "  - Migrated: 4 existing tables"
        print "  - Added: 2 new tables (test_runs, test_results)"
        print ""
        print "You can now run: simple test --list-runs"
        0
    else:
        print "✗ Error: Failed to save migrated database"
        print "Old database backed up at: {backup_path}"
        1
