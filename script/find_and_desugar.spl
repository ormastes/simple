# Find and Desugar - Systematic Phase 3B
#
# Strategy:
# 1. Start with known high-frequency static method patterns
# 2. Find all .spl files that use these patterns
# 3. Desugar them systematically

use std.spec

extern fn rt_file_read_text(path: text) -> text
extern fn rt_file_write_text(path: text, content: text) -> bool
extern fn rt_file_exists(path: text) -> bool
extern fn rt_process_run(cmd: text, args: [text]) -> (text, text, i32)

use app.desugar.static_methods (desugar_static_methods)
use app.desugar.rewriter (rewrite_static_calls)

# Common static method patterns that need fixing
val STATIC_METHOD_PATTERNS = [
    "LazySeq.",
    "Cache.",
    "ActorHeap.",
    "HeapConfig.",
    "ResourceRegistry.",
    "TestDatabase.",
    "InputValidator.",
    "GlobalFlags.",
    "Builder.",
    "Config.",
]

fn find_files_with_patterns() -> [text]:
    """Find all .spl files that use static method patterns."""
    var files: [text] = []

    # Search in src/ and test/ directories
    for pattern in STATIC_METHOD_PATTERNS:
        # Use grep to find files with the pattern
        val (stdout, stderr, code) = rt_process_run("grep", [
            "-r",
            "-l",
            "--include=*.spl",
            pattern,
            "src/",
            "test/"
        ])

        if code == 0:
            val lines = stdout.split("\n")
            for line in lines:
                val trimmed = line.trim()
                if trimmed != "" and not files.contains(trimmed):
                    files.push(trimmed)

    files

fn desugar_file(path: text) -> bool:
    """Desugar a single file."""
    if not rt_file_exists(path):
        return false

    val source_opt = rt_file_read_text(path)
    val source = source_opt ?? ""

    if source == "":
        return false

    # Check if file actually needs desugaring
    var needs_desugar = false
    for pattern in STATIC_METHOD_PATTERNS:
        if source.contains(pattern):
            needs_desugar = true
            break

    if not needs_desugar:
        return true  # No changes needed, consider success

    # Determine processing based on file type
    var result = source

    if path.starts_with("src/") and path.contains("/lib/") or path.contains("/app/"):
        # Library source: full desugaring
        result = desugar_static_methods(result)

    # All files: rewrite calls
    result = rewrite_static_calls(result)

    # Only write if changed
    if result != source:
        rt_file_write_text(path, result)

    true

describe "Find and Desugar":
    it "finds and desugars all affected files":
        print ""
        print "=== Phase 3B: Systematic Desugaring ==="
        print ""
        print "Step 1: Finding files with static method patterns..."

        val files = find_files_with_patterns()
        print "Found {files.len()} files"
        print ""

        print "Step 2: Desugaring files..."
        var success_count = 0
        var fail_count = 0

        for file_path in files:
            if desugar_file(file_path):
                print "  ✓ {file_path}"
                success_count = success_count + 1
            else:
                print "  ✗ {file_path}"
                fail_count = fail_count + 1

        print ""
        print "=== Results ==="
        print "✓ Success: {success_count} files"
        print "✗ Failed:  {fail_count} files"
        print ""

        check(success_count > 0)

        if fail_count == 0:
            print "All files desugared successfully!"
            print ""
            print "Next: Run tests to verify fixes"
            print "  bin/simple test"
