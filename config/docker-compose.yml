# Docker Compose for Simple Language Test Environment
# Provides easy local development and testing with isolated containers

version: '3.9'

services:
  # Fast unit tests (default service)
  unit-tests:
    build:
      context: .
      dockerfile: docker/Dockerfile.test-isolation
    image: simple-test-isolation:latest
    container_name: simple-unit-tests
    volumes:
      - .:/workspace:ro
    command: test test/unit/ --profile=fast
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges

  # Integration tests
  integration-tests:
    build:
      context: .
      dockerfile: docker/Dockerfile.test-isolation
    image: simple-test-isolation:latest
    container_name: simple-integration-tests
    volumes:
      - .:/workspace:ro
    command: test test/integration/ --profile=standard
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges

  # System tests
  system-tests:
    build:
      context: .
      dockerfile: docker/Dockerfile.test-isolation
    image: simple-test-isolation:latest
    container_name: simple-system-tests
    volumes:
      - .:/workspace:ro
    command: test test/system/ --profile=slow
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges

  # All tests (parallel execution)
  all-tests:
    build:
      context: .
      dockerfile: docker/Dockerfile.test-isolation
    image: simple-test-isolation:latest
    container_name: simple-all-tests
    volumes:
      - .:/workspace:ro
    command: test --parallel
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 2G
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges

  # Interactive development shell
  dev-shell:
    build:
      context: .
      dockerfile: docker/Dockerfile.test-isolation
    image: simple-test-isolation:latest
    container_name: simple-dev-shell
    volumes:
      - .:/workspace  # Read-write for development
    entrypoint: /bin/bash
    stdin_open: true
    tty: true
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G

  # Test watcher (auto-run on file changes)
  # Requires docker-compose-wait or similar
  watch-tests:
    build:
      context: .
      dockerfile: docker/Dockerfile.test-isolation
    image: simple-test-isolation:latest
    container_name: simple-watch-tests
    volumes:
      - .:/workspace:ro
    command: test --watch test/unit/
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 256M
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid

  # Critical tests (QEMU, baremetal)
  critical-tests:
    build:
      context: .
      dockerfile: docker/Dockerfile.test-isolation
    image: simple-test-isolation:latest
    container_name: simple-critical-tests
    volumes:
      - .:/workspace:ro
      - /dev/kvm:/dev/kvm  # QEMU acceleration
    command: test test/qemu/ test/baremetal/ --profile=critical
    privileged: true  # Required for QEMU/KVM
    deploy:
      resources:
        limits:
          cpus: '8.0'
          memory: 4G
    tmpfs:
      - /tmp:rw,size=1g

# Named volumes for caching (optional)
volumes:
  test-cache:
    driver: local
  build-cache:
    driver: local

# Networks (optional - for multi-container tests)
networks:
  test-network:
    driver: bridge
