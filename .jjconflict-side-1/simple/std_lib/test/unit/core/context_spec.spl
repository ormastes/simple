# Context Manager Tests
# Tests for the ContextManager trait and built-in context managers

use spec.*
use core.context.*

describe "ContextManager trait":
    it "can be implemented by custom classes":
        class Counter:
            fn __init__(self):
                self.count = 0

            fn __enter__(self):
                self.count = self.count + 1
                return self

            fn __exit__(self, exc_type, exc_value, traceback):
                self.count = self.count - 1
                return false

        c = Counter()
        expect(c.count).to_equal(0)

        with c:
            expect(c.count).to_equal(1)

        expect(c.count).to_equal(0)


describe "Timer context manager":
    it "times code execution":
        with Timer("test") as t:
            # Perform some work
            x = 1 + 1

        # Should have printed timing info
        expect(t.start_time).to_be_greater_than(0)


describe "Lock context manager":
    it "acquires and releases lock":
        lock = Lock()
        expect(lock.locked).to_be_false()

        with lock:
            expect(lock.locked).to_be_true()

        expect(lock.locked).to_be_false()


describe "TransactionContext":
    it "commits on success":
        with TransactionContext() as tx:
            # Perform operations
            x = 1 + 1

        expect(tx.committed).to_be_true()
        expect(tx.rolled_back).to_be_false()

    it "rolls back on manual rollback":
        with TransactionContext() as tx:
            tx.rollback()

        expect(tx.committed).to_be_false()
        expect(tx.rolled_back).to_be_true()


describe "contextmanager helper":
    it "creates context manager from functions":
        entered = false
        exited = false

        fn my_enter():
            entered = true
            return "resource"

        fn my_exit(exc_type, exc_value, tb):
            exited = true
            return false

        cm = contextmanager(my_enter, my_exit)

        with cm as resource:
            expect(entered).to_be_true()
            expect(resource).to_equal("resource")

        expect(exited).to_be_true()


describe "suppress context manager":
    it "suppresses specified exceptions":
        error_raised = false

        with suppress(ValueError):
            error_raised = true
            # In real implementation, this would raise ValueError
            # For now, just set flag

        # Should continue normally
        expect(error_raised).to_be_true()
