# MCP (Minimal Code Preview) - LLM-friendly code representation tool
# Generates token-efficient code previews with progressive disclosure

use core.*
use mcp.*
use host.async_nogc_mut.io.stdio.*
use host.async_nogc_mut.sys.*

# Main entry point
fn main():
    args = sys_get_args()

    if args.len() < 2:
        print_usage()
        sys_exit(1)

    command = args[1]

    if command == "--help" or command == "-h":
        print_usage()
        sys_exit(0)

    elif command == "read":
        # Read file in MCP mode
        handle_read(args)

    elif command == "expand":
        # Expand specific symbol
        handle_expand(args)

    elif command == "search":
        # Search for symbols
        handle_search(args)

    elif command == "json":
        # Generate JSON output
        handle_json(args)

    else:
        # Default: treat as file path for reading
        handle_default_read(args)

# Print usage information
fn print_usage():
    println("MCP (Minimal Code Preview) - LLM-friendly code representation")
    println("")
    println("Usage:")
    println("  simple mcp <file.spl>                    # Generate MCP outline")
    println("  simple mcp read <file.spl>               # Read file in MCP mode")
    println("  simple mcp expand <file.spl> <symbol>    # Expand specific symbol")
    println("  simple mcp search <query> [--public]     # Search for symbols")
    println("  simple mcp json <file.spl> [--meta]      # Generate JSON output")
    println("")
    println("Options:")
    println("  --help, -h          Show this help message")
    println("  --all               Show private symbols too")
    println("  --public            Filter to public symbols only (default)")
    println("  --meta              Include metadata in JSON output")
    println("  --expand=<what>     What to expand: signature|body|all")
    println("")
    println("Examples:")
    println("  simple mcp user.spl")
    println("  simple mcp expand user.spl UserService --expand=all")
    println("  simple mcp json user.spl --meta")

# Handle read command
fn handle_read(args: List[String]):
    if args.len() < 3:
        println("Error: Missing file path")
        println("Usage: simple mcp read <file.spl>")
        sys_exit(1)

    file_path = args[2]
    show_all = has_flag(args, "--all")

    # TODO: Read actual file when IO is available
    # For now, use example source
    source = get_example_source()

    text = mcp_from_source(source, show_all)
    println(text)

# Handle expand command
fn handle_expand(args: List[String]):
    if args.len() < 4:
        println("Error: Missing file path or symbol name")
        println("Usage: simple mcp expand <file.spl> <symbol> [--expand=<what>]")
        sys_exit(1)

    file_path = args[2]
    symbol_name = args[3]
    what = get_flag_value(args, "--expand", "all")

    # TODO: Read actual file
    source = get_example_source()

    symbols = parse_file(source)
    symbol_opt = find_symbol(symbols, symbol_name)

    if symbol_opt.is_none():
        println("Error: Symbol not found: " + symbol_name)
        sys_exit(1)

    symbol = symbol_opt.unwrap()
    text = format_single_symbol(symbol, what)
    println(text)

# Handle search command
fn handle_search(args: List[String]):
    if args.len() < 3:
        println("Error: Missing search query")
        println("Usage: simple mcp search <query> [--public]")
        sys_exit(1)

    query = args[2]
    filter = "all"
    if has_flag(args, "--public"):
        filter = "public"

    results = search(query, filter)
    for result in results:
        println(result)

# Handle JSON output command
fn handle_json(args: List[String]):
    if args.len() < 3:
        println("Error: Missing file path")
        println("Usage: simple mcp json <file.spl> [--meta] [--all]")
        sys_exit(1)

    file_path = args[2]
    show_all = has_flag(args, "--all")
    include_meta = has_flag(args, "--meta")

    # TODO: Read actual file
    source = get_example_source()

    json = mcp_json_from_source(source, show_all, include_meta)
    println(json)

# Handle default read (just file path)
fn handle_default_read(args: List[String]):
    file_path = args[1]
    show_all = has_flag(args, "--all")

    # TODO: Read actual file
    source = get_example_source()

    text = mcp_from_source(source, show_all)
    println(text)

# Check if a flag is present in args
fn has_flag(args: List[String], flag: String) -> bool:
    for arg in args:
        if arg == flag:
            return true
    return false

# Get value of a flag like --expand=all
fn get_flag_value(args: List[String], flag_prefix: String, default: String) -> String:
    for arg in args:
        if arg.starts_with(flag_prefix + "="):
            parts = arg.split("=")
            if parts.len() >= 2:
                return parts[1]
    return default

# Get example source code for testing
fn get_example_source() -> String:
    return "pub class User:\n    name: String\n    age: i64\n\n    pub fn login(name: String) -> bool:\n        # Implementation\n        return true\n\npub fn get_user(id: i64) -> User:\n    # Get user by ID\n    return User()\n\ntrait Display:\n    fn show() -> String\n\npointcut logging @ User.login"

# Entry point
main()
