# Session Management for Language Model Server

import sys
import protocol

# Session state for a client connection
pub class Session:
    id: String
    workspace_root: Option<String>
    client_info: Option<protocol.ClientInfo>
    created_at: Int          # Timestamp in milliseconds
    last_activity: Int       # Timestamp in milliseconds

    # Create a new session
    pub fn new() -> Session:
        let now = sys.time.now_ms()
        Session {
            id: generate_session_id(),
            workspace_root: None,
            client_info: None,
            created_at: now,
            last_activity: now
        }

    # Update last activity timestamp
    pub fn touch(mut self):
        self.last_activity = sys.time.now_ms()

    # Set workspace root
    pub fn set_workspace_root(mut self, root: String):
        self.workspace_root = Some(root)

    # Set client information
    pub fn set_client_info(mut self, info: protocol.ClientInfo):
        self.client_info = Some(info)

# Workspace state
pub class Workspace:
    root: String
    files: Set<String>       # Tracked files
    dirty_files: Set<String> # Modified but not saved

    # Create a new workspace
    pub fn new(root: String) -> Workspace:
        Workspace {
            root: root,
            files: Set.new(),
            dirty_files: Set.new()
        }

    # Track a file
    pub fn track_file(mut self, path: String):
        self.files.insert(path)

    # Mark file as dirty
    pub fn mark_dirty(mut self, path: String):
        self.dirty_files.insert(path)

    # Mark file as clean
    pub fn mark_clean(mut self, path: String):
        self.dirty_files.remove(path)

    # Check if file is tracked
    pub fn is_tracked(self, path: String) -> Bool:
        self.files.contains(path)

    # Get all tracked files
    pub fn get_files(self) -> List<String>:
        self.files.to_list()

# Generate a unique session ID
fn generate_session_id() -> String:
    # Use timestamp + random component
    let now = sys.time.now_ms()
    let random = sys.random.random_int()
    f"session_{now}_{random}"
