# Doc Coverage Threshold System Demo
#
# Demonstrates the full threshold system workflow:
# 1. Parse config from doc_coverage.sdn
# 2. Calculate coverage per scope
# 3. Validate thresholds
# 4. Generate report

use app.doc_coverage.thresholds.config_parser.{parse_threshold_config}
use app.doc_coverage.thresholds.calculator.{calculate_scope_coverage}
use app.doc_coverage.thresholds.validator.{
    validate_thresholds,
    generate_threshold_report,
    get_overall_coverage
}

fn main():
    print "=== Doc Coverage Threshold Demo ==="
    print ""

    # Parse config
    print "1. Loading config from doc_coverage.sdn..."
    val config = parse_threshold_config("doc_coverage.sdn")
    print "   Default threshold: {config.default_threshold}%"
    print "   Enforce: {config.enforce}"
    print "   Fail on below: {config.fail_on_below}"
    print "   Scope thresholds: {config.scope_names.len()}"
    print ""

    # Mock coverage data
    print "2. Calculating coverage..."
    val all_files = [
        "src/std/string.spl",
        "src/std/array.spl",
        "src/std/math.spl",
        "src/std/spec.spl",
        "src/core/lexer.spl",
        "src/core/parser.spl",
        "src/core/tokens.spl",
        "src/lib/database/core.spl",
        "src/lib/database/query.spl",
        "src/app/cli/main.spl",
        "src/app/build/main.spl"
    ]

    val covered_files = [
        "src/std/string.spl",
        "src/std/array.spl",
        "src/std/math.spl",
        "src/std/spec.spl",
        "src/core/lexer.spl",
        "src/core/parser.spl",
        "src/lib/database/core.spl",
        "src/lib/database/query.spl",
        "src/app/cli/main.spl"
    ]

    val coverages = calculate_scope_coverage(all_files, covered_files, config)
    print "   Found {coverages.len()} scope(s)"
    print ""

    # Validate
    print "3. Validating thresholds..."
    val result = validate_thresholds(coverages)
    val all_passed = result.0
    val failed_scopes = result.1
    print "   All passed: {all_passed}"
    print "   Failed scopes: {failed_scopes.len()}"
    print ""

    # Generate report
    print "4. Generating report..."
    val report = generate_threshold_report(coverages, all_passed, failed_scopes)
    print report

    # Overall coverage
    val overall = get_overall_coverage(coverages)
    print ""
    print "Overall coverage: {overall}%"
    print ""
    print "Demo complete!"

main()
