# Minimal x86_64 SIMD test to verify basics work

use compiler.backend.native.x86_64_simd.{vex_2byte, ymm_to_index, encode_vaddps_ymm}
use compiler.backend.native.mach_inst.{X86_YMM0, X86_YMM1, X86_YMM2}

fn test_vex_encoding():
    print "Testing VEX 2-byte encoding..."
    val vex = vex_2byte(0, false, 0)
    print "  VEX length: {vex.len()}"
    print "  VEX[0]: {vex[0]} (expected 0xC5 = 197)"
    print "  VEX[1]: {vex[1]} (expected 0xF8 = 248)"

    if vex.len() == 2 and vex[0] == 197 and vex[1] == 248:
        print "  PASS: VEX 2-byte encoding correct"
    else:
        print "  FAIL: VEX 2-byte encoding incorrect"

fn test_register_index():
    print "Testing YMM register index conversion..."
    val idx0 = ymm_to_index(X86_YMM0)
    val idx1 = ymm_to_index(X86_YMM1)
    val idx2 = ymm_to_index(X86_YMM2)
    print "  YMM0 -> {idx0} (expected 0)"
    print "  YMM1 -> {idx1} (expected 1)"
    print "  YMM2 -> {idx2} (expected 2)"

    if idx0 == 0 and idx1 == 1 and idx2 == 2:
        print "  PASS: Register indexing correct"
    else:
        print "  FAIL: Register indexing incorrect"

fn test_vaddps():
    print "Testing VADDPS ymm0, ymm1, ymm2 encoding..."
    val bytes = encode_vaddps_ymm(X86_YMM0, X86_YMM1, X86_YMM2)
    print "  Encoded {bytes.len()} bytes"

    if bytes.len() == 5:
        print "  Byte 0: {bytes[0]} (expected 0xC4 = 196)"
        print "  Byte 1: {bytes[1]} (expected 0xE1 = 225)"
        print "  Byte 2: {bytes[2]} (expected 0x74 = 116)"
        print "  Byte 3: {bytes[3]} (expected 0x58 = 88)"
        print "  Byte 4: {bytes[4]} (expected 0xC2 = 194)"

        if (bytes[0] == 196 and bytes[1] == 225 and bytes[2] == 116 and
            bytes[3] == 88 and bytes[4] == 194):
            print "  PASS: VADDPS encoding correct"
        else:
            print "  FAIL: VADDPS encoding incorrect"
    else:
        print "  FAIL: Wrong number of bytes"

fn main():
    print "=== x86_64 SIMD Minimal Test ==="
    print ""

    test_vex_encoding()
    print ""

    test_register_index()
    print ""

    test_vaddps()
    print ""

    print "=== Tests Complete ==="
