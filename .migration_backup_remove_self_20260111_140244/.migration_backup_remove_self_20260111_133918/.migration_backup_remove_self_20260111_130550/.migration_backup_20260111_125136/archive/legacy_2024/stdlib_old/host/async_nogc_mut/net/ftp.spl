# FTP Client - Async FTP client

use units.net.*
use units.url.*
use units.file.*
use units.size.*
use units.time.*
use io.fs.IoError

# FTP transfer mode
enum TransferMode:
    Binary
    Ascii

impl TransferMode:
    fn to_cmd(self) -> str:
        match self:
            case Binary: return "TYPE I"
            case Ascii: return "TYPE A"

# FTP file type
enum FtpFileType:
    File
    Directory
    Link
    Other

# FTP error type
enum FtpError:
    ConnectionFailed(IoError)
    LoginFailed
    NotFound
    PermissionDenied
    AlreadyExists
    NotADirectory
    NotAFile
    InvalidResponse(str)
    TransferFailed
    Timeout
    Disconnected
    Other(str)

impl FtpError:
    fn message(self) -> str:
        match self:
            case ConnectionFailed(e): return f"connection failed: {e.message()}"
            case LoginFailed: return "login failed"
            case NotFound: return "file or directory not found"
            case PermissionDenied: return "permission denied"
            case AlreadyExists: return "file or directory already exists"
            case NotADirectory: return "not a directory"
            case NotAFile: return "not a file"
            case InvalidResponse(msg): return f"invalid response: {msg}"
            case TransferFailed: return "transfer failed"
            case Timeout: return "operation timed out"
            case Disconnected: return "disconnected from server"
            case Other(msg): return msg

# FTP directory entry
pub struct FtpEntry:
    name: FileName
    file_type: FtpFileType
    size: Option<ByteCount>
    modified: Option<Timestamp>
    permissions: Option<str>

impl FtpEntry:
    pub fn name(self) -> FileName:
        return self.name

    pub fn file_type(self) -> FtpFileType:
        return self.file_type

    pub fn size(self) -> Option<ByteCount>:
        return self.size

    pub fn modified(self) -> Option<Timestamp>:
        return self.modified

    pub fn permissions(self) -> Option<str>:
        return self.permissions

    pub fn is_file(self) -> bool:
        return self.file_type == FtpFileType::File

    pub fn is_directory(self) -> bool:
        return self.file_type == FtpFileType::Directory

# FTP Client
pub struct FtpClient:
    handle: i64
    host: Host
    port: Port
    connected: bool
    transfer_mode: TransferMode
    passive: bool

impl FtpClient:
    # Connect to FTP server from URL
    pub async fn connect(url: FtpUrl) -> Result<FtpClient, FtpError>:
        let host = url.host()
        let port = url.port()

        let username = url.username().unwrap_or("anonymous")
        let password = url.password().unwrap_or("anonymous@")

        return FtpClient::connect_with_creds(host, port, username, password)

    # Connect with explicit credentials
    pub async fn connect_with_creds(
        host: Host,
        port: Port,
        username: str,
        password: str
    ) -> Result<FtpClient, FtpError>:
        let handle = native_ftp_connect(host, port)?
        let client = FtpClient {
            handle: handle,
            host: host,
            port: port,
            connected: true,
            transfer_mode: TransferMode::Binary,
            passive: true
        }

        # Login
        native_ftp_login(handle, username, password)?

        return Ok(client)

    # Connect to host on default port
    pub async fn connect_to(host: Host) -> Result<FtpClient, FtpError>:
        return FtpClient::connect_with_creds(host, 21_port, "anonymous", "anonymous@")

    # ===============================
    # Navigation
    # ===============================

    # Print working directory
    pub async fn pwd(self) -> Result<UrlPath, FtpError>:
        return native_ftp_pwd(self.handle)

    # Change directory
    pub async fn cd(self, path: UrlPath) -> Result<(), FtpError>:
        return native_ftp_cwd(self.handle, path)

    # Change to parent directory
    pub async fn cdup(self) -> Result<(), FtpError>:
        return native_ftp_cdup(self.handle)

    # List directory contents
    pub async fn list(self) -> Result<Array<FtpEntry>, FtpError>:
        return native_ftp_list(self.handle)

    # List directory at path
    pub async fn list_path(self, path: UrlPath) -> Result<Array<FtpEntry>, FtpError>:
        return native_ftp_list_path(self.handle, path)

    # Get file/directory info
    pub async fn stat(self, path: UrlPath) -> Result<FtpEntry, FtpError>:
        return native_ftp_stat(self.handle, path)

    # ===============================
    # Transfer Operations
    # ===============================

    # Download file to local path
    pub async fn download(self, remote: UrlPath, local: FilePath) -> Result<ByteCount, FtpError>:
        return native_ftp_download(self.handle, remote, local, self.transfer_mode)

    # Upload local file to remote path
    pub async fn upload(self, local: FilePath, remote: UrlPath) -> Result<ByteCount, FtpError>:
        return native_ftp_upload(self.handle, local, remote, self.transfer_mode)

    # Download file to bytes
    pub async fn download_bytes(self, remote: UrlPath) -> Result<Bytes, FtpError>:
        return native_ftp_download_bytes(self.handle, remote, self.transfer_mode)

    # Upload bytes to remote path
    pub async fn upload_bytes(self, data: &Bytes, remote: UrlPath) -> Result<ByteCount, FtpError>:
        return native_ftp_upload_bytes(self.handle, data, remote, self.transfer_mode)

    # Resume download from offset
    pub async fn resume_download(self, remote: UrlPath, local: FilePath, offset: ByteCount) -> Result<ByteCount, FtpError>:
        return native_ftp_resume_download(self.handle, remote, local, offset, self.transfer_mode)

    # ===============================
    # File Operations
    # ===============================

    # Delete file
    pub async fn delete(self, path: UrlPath) -> Result<(), FtpError>:
        return native_ftp_delete(self.handle, path)

    # Create directory
    pub async fn mkdir(self, path: UrlPath) -> Result<(), FtpError>:
        return native_ftp_mkdir(self.handle, path)

    # Remove directory
    pub async fn rmdir(self, path: UrlPath) -> Result<(), FtpError>:
        return native_ftp_rmdir(self.handle, path)

    # Rename file or directory
    pub async fn rename(self, from: UrlPath, to: UrlPath) -> Result<(), FtpError>:
        return native_ftp_rename(self.handle, from, to)

    # Get file size
    pub async fn size(self, path: UrlPath) -> Result<ByteCount, FtpError>:
        return native_ftp_size(self.handle, path)

    # Get modification time
    pub async fn modified(self, path: UrlPath) -> Result<Timestamp, FtpError>:
        return native_ftp_mdtm(self.handle, path)

    # ===============================
    # Settings
    # ===============================

    # Set transfer mode
    pub fn set_transfer_mode(self, mode: TransferMode) -> FtpClient:
        self.transfer_mode = mode
        return self

    # Set passive mode
    pub fn set_passive(self, passive: bool) -> FtpClient:
        self.passive = passive
        return self

    # ===============================
    # Connection Management
    # ===============================

    # Send NOOP to keep connection alive
    pub async fn noop(self) -> Result<(), FtpError>:
        return native_ftp_noop(self.handle)

    # Check if connected
    pub fn is_connected(self) -> bool:
        return self.connected

    # Get server features
    pub async fn features(self) -> Result<Array<str>, FtpError>:
        return native_ftp_feat(self.handle)

    # Send raw FTP command
    pub async fn raw_command(self, cmd: str) -> Result<str, FtpError>:
        return native_ftp_raw(self.handle, cmd)

    # Disconnect from server
    pub async fn quit(self) -> Result<(), FtpError>:
        if self.connected:
            native_ftp_quit(self.handle)?
            self.connected = false
        return Ok(())

# Native function declarations
extern fn native_ftp_connect(host: Host, port: Port) -> Result<i64, FtpError>
extern fn native_ftp_login(handle: i64, username: str, password: str) -> Result<(), FtpError>
extern fn native_ftp_pwd(handle: i64) -> Result<UrlPath, FtpError>
extern fn native_ftp_cwd(handle: i64, path: UrlPath) -> Result<(), FtpError>
extern fn native_ftp_cdup(handle: i64) -> Result<(), FtpError>
extern fn native_ftp_list(handle: i64) -> Result<Array<FtpEntry>, FtpError>
extern fn native_ftp_list_path(handle: i64, path: UrlPath) -> Result<Array<FtpEntry>, FtpError>
extern fn native_ftp_stat(handle: i64, path: UrlPath) -> Result<FtpEntry, FtpError>
extern fn native_ftp_download(handle: i64, remote: UrlPath, local: FilePath, mode: TransferMode) -> Result<ByteCount, FtpError>
extern fn native_ftp_upload(handle: i64, local: FilePath, remote: UrlPath, mode: TransferMode) -> Result<ByteCount, FtpError>
extern fn native_ftp_download_bytes(handle: i64, remote: UrlPath, mode: TransferMode) -> Result<Bytes, FtpError>
extern fn native_ftp_upload_bytes(handle: i64, data: &Bytes, remote: UrlPath, mode: TransferMode) -> Result<ByteCount, FtpError>
extern fn native_ftp_resume_download(handle: i64, remote: UrlPath, local: FilePath, offset: ByteCount, mode: TransferMode) -> Result<ByteCount, FtpError>
extern fn native_ftp_delete(handle: i64, path: UrlPath) -> Result<(), FtpError>
extern fn native_ftp_mkdir(handle: i64, path: UrlPath) -> Result<(), FtpError>
extern fn native_ftp_rmdir(handle: i64, path: UrlPath) -> Result<(), FtpError>
extern fn native_ftp_rename(handle: i64, from: UrlPath, to: UrlPath) -> Result<(), FtpError>
extern fn native_ftp_size(handle: i64, path: UrlPath) -> Result<ByteCount, FtpError>
extern fn native_ftp_mdtm(handle: i64, path: UrlPath) -> Result<Timestamp, FtpError>
extern fn native_ftp_noop(handle: i64) -> Result<(), FtpError>
extern fn native_ftp_feat(handle: i64) -> Result<Array<str>, FtpError>
extern fn native_ftp_raw(handle: i64, cmd: str) -> Result<str, FtpError>
extern fn native_ftp_quit(handle: i64) -> Result<(), FtpError>
