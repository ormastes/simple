# Truthiness Rules
#
# Unified truthiness rules for Simple language.
# Determines how values are coerced to boolean in conditionals.
# This is the single source of truth - both interpreter and codegen MUST use these rules.
#
# Port of rust/compiler/src/semantics/truthiness.rs (197 lines)

export TruthinessRules

# ============================================================================
# Language Semantics
# ============================================================================
#
# In Simple, the following values are considered falsy:
# - `false`
# - `0` (integer)
# - `0.0` (float)
# - `""` (empty string)
# - `[]` (empty array)
# - `()` (empty tuple)
# - `{}` (empty dict)
# - `nil`
#
# All other values are truthy, including:
# - Non-zero numbers
# - Non-empty strings
# - Non-empty collections
# - Objects, functions, lambdas, actors, etc.

# ============================================================================
# Truthiness Evaluation
# ============================================================================

struct TruthinessRules

impl TruthinessRules:
    static fn is_truthy(
        from_bool: bool?,
        from_int: i64?,
        from_float: f64?,
        is_empty_collection: bool?,
        is_nil: bool
    ) -> bool:
        """Evaluate truthiness of a value.

        Arguments:
        - from_bool: If the value is a boolean
        - from_int: If the value is an integer
        - from_float: If the value is a float
        - is_empty_collection: If the value is a collection, whether it's empty
        - is_nil: If the value is nil

        Returns:
        true if the value is truthy, false otherwise.

        Examples:
        - Bool: is_truthy(Some(true), None, None, None, false) -> true
        - Int: is_truthy(None, Some(0), None, None, false) -> false
        - Float: is_truthy(None, None, Some(0.0), None, false) -> false
        - Empty collection: is_truthy(None, None, None, Some(true), false) -> false
        - Nil: is_truthy(None, None, None, None, true) -> false
        """
        # Nil is always falsy
        if is_nil:
            return false

        # Bool: direct value
        if from_bool.?:
            return from_bool ?? false

        # Int: non-zero is truthy
        if from_int.?:
            return (from_int ?? 0) != 0

        # Float: non-zero is truthy
        if from_float.?:
            return (from_float ?? 0.0) != 0.0

        # Collection: empty is falsy
        if is_empty_collection.?:
            return not (is_empty_collection ?? false)

        # All other values (objects, functions, etc.) are truthy
        true

    static fn is_always_truthy_type(type_name: text) -> bool:
        """Check if a specific type is always truthy.

        Some types are always truthy regardless of their value:
        - Functions, Lambdas, Closures
        - Objects, Actors, Channels
        - etc.
        """
        type_name in [
            "Function",
            "Lambda",
            "Closure",
            "Object",
            "Actor",
            "Channel",
            "Future",
            "Generator",
            "ThreadPool",
            "Mock",
            "Matcher",
            "NativeFunction",
            "EnumType",
            "EnumVariant",
            "Constructor",
            "TraitObject",
            "Block"
        ]

    static fn is_value_dependent_type(type_name: text) -> bool:
        """Check if a type's truthiness depends on its value."""
        type_name in [
            "Bool",
            "Int",
            "Float",
            "String",
            "Array",
            "Tuple",
            "Dict",
            "Nil"
        ]
