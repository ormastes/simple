# Memory-Mapped File I/O FFI - mmap/munmap syscalls
#
# Provides memory-mapped file I/O for efficient file access.
# Used for lazy loading of SMF files and template bytecode.
#
# Architecture:
# - Rust implements low-level mmap(2) syscalls
# - Simple provides high-level caching and management
# - Zero-copy file access for large files

# ============================================================================
# Constants
# ============================================================================

## Protection flags (bitwise OR)
val PROT_NONE: i32 = 0x0   # No access
val PROT_READ: i32 = 0x1   # Read access
val PROT_WRITE: i32 = 0x2  # Write access
val PROT_EXEC: i32 = 0x4   # Execute access

## Mapping flags (bitwise OR)
val MAP_SHARED: i32 = 0x1      # Share changes
val MAP_PRIVATE: i32 = 0x2     # Private copy-on-write
val MAP_ANONYMOUS: i32 = 0x20  # No file backing
val MAP_FIXED: i32 = 0x10      # Fixed address

# ============================================================================
# Memory Mapping Operations
# ============================================================================

## Map a file into memory
##
## Args:
##   path: File path to map
##   prot: Protection flags (PROT_READ | PROT_WRITE | PROT_EXEC)
##   flags: Mapping flags (MAP_SHARED or MAP_PRIVATE)
##   offset: Offset in file (must be page-aligned)
##   length: Length to map (0 = entire file)
##
## Returns:
##   (address, size) tuple on success, where:
##   - address: Pointer to mapped region (non-zero)
##   - size: Actual size of mapped region in bytes
##   Returns (0, 0) on error
extern fn rt_mmap_file(path: text, prot: i32, flags: i32, offset: i64, length: i64) -> (i64, i64)

## Unmap a previously mapped region
##
## Args:
##   address: Address returned from rt_mmap_file
##   size: Size returned from rt_mmap_file
##
## Returns:
##   true on success, false on error
extern fn rt_munmap(address: i64, size: i64) -> bool

## Read bytes from mapped memory
##
## Args:
##   address: Base address of mapped region
##   offset: Offset within mapped region
##   length: Number of bytes to read
##
## Returns:
##   Byte array containing the data
extern fn rt_mmap_read_bytes(address: i64, offset: i64, length: i64) -> [u8]

## Read string from mapped memory (null-terminated or length-limited)
##
## Args:
##   address: Base address of mapped region
##   offset: Offset within mapped region
##   max_length: Maximum bytes to read (0 = read until null terminator)
##
## Returns:
##   String containing the data
extern fn rt_mmap_read_string(address: i64, offset: i64, max_length: i64) -> text

## Get file size (needed for mmap)
##
## Args:
##   path: File path
##
## Returns:
##   File size in bytes, or -1 on error
extern fn rt_file_size_for_mmap(path: text) -> i64

## Get system page size (for alignment)
##
## Returns:
##   System page size in bytes (usually 4096)
extern fn rt_get_page_size() -> i64

## Sync mapped memory to disk
##
## Args:
##   address: Base address of mapped region
##   size: Size of region to sync
##   is_async: If true, return immediately; if false, wait for sync
##
## Returns:
##   true on success, false on error
extern fn rt_msync(address: i64, size: i64, is_async: bool) -> bool

## Lock mapped memory in RAM (prevent swapping)
##
## Args:
##   address: Base address of mapped region
##   size: Size of region to lock
##
## Returns:
##   true on success, false on error
extern fn rt_mlock(address: i64, size: i64) -> bool

## Unlock mapped memory (allow swapping)
##
## Args:
##   address: Base address of mapped region
##   size: Size of region to unlock
##
## Returns:
##   true on success, false on error
extern fn rt_munlock(address: i64, size: i64) -> bool

## Advise kernel about memory usage pattern
##
## Args:
##   address: Base address of mapped region
##   size: Size of region
##   advice: Advice code (MADV_SEQUENTIAL, MADV_RANDOM, etc.)
##
## Advice codes:
##   0 = MADV_NORMAL - No special treatment
##   1 = MADV_RANDOM - Random access pattern
##   2 = MADV_SEQUENTIAL - Sequential access pattern
##   3 = MADV_WILLNEED - Will need this data soon (prefetch)
##   4 = MADV_DONTNEED - Won't need this data (can free)
##
## Returns:
##   true on success, false on error
extern fn rt_madvise(address: i64, size: i64, advice: i32) -> bool

# ============================================================================
# FFI Generation Metadata
# ============================================================================

# @ffi-gen-target: build/rust/ffi_gen/src/mmap.rs
# @ffi-gen-impl: libc mmap/munmap bindings
# @ffi-gen-test: test/ffi/mmap_spec.spl
