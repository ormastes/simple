# Treesitter SFFI Specification
#
# SFFI bindings for tree-sitter C library.
# Provides minimal FFI bridge for parsing and querying.
#
# Usage:
#   simple sffi-gen --gen-intern src/app/ffi_gen/specs/treesitter.spl
#
# Generates:
#   build/rust/ffi_gen/src/treesitter.rs

@sffi_spec("treesitter")
module TreesitterFFI:
    """
    Tree-sitter bindings for Simple language parsing.

    Tree-sitter is a parser generator and incremental parsing library.
    It builds concrete syntax trees for source files and efficiently updates
    the trees as the source files change.
    """

    # ========================================================================
    # Parser Management
    # ========================================================================

    @extern("rt_ts_parser_new")
    fn parser_new(language: text) -> i64:
        """Create new parser for language.

        Args:
            language - Language name (e.g., "simple", "rust", "python")

        Returns:
            Parser handle (>0) or 0 on error
        """

    @extern("rt_ts_parser_free")
    fn parser_free(handle: i64):
        """Free parser resources.

        Args:
            handle - Parser handle from parser_new
        """

    @extern("rt_ts_parser_set_language")
    fn parser_set_language(handle: i64, language: text) -> bool:
        """Change parser language.

        Args:
            handle - Parser handle
            language - New language name

        Returns:
            true on success, false on error
        """

    # ========================================================================
    # Parsing Operations
    # ========================================================================

    @extern("rt_ts_parser_parse")
    fn parser_parse(handle: i64, source: text) -> i64:
        """Parse source code to syntax tree.

        Args:
            handle - Parser handle
            source - Source code to parse

        Returns:
            Tree handle (>0) or 0 on error
        """

    @extern("rt_ts_parser_parse_incremental")
    fn parser_parse_incremental(handle: i64, old_tree: i64, source: text) -> i64:
        """Parse with old tree for incremental update.

        Args:
            handle - Parser handle
            old_tree - Previous tree handle (for reuse)
            source - New source code

        Returns:
            New tree handle (>0) or 0 on error
        """

    # ========================================================================
    # Tree Management
    # ========================================================================

    @extern("rt_ts_tree_free")
    fn tree_free(handle: i64):
        """Free tree resources.

        Args:
            handle - Tree handle from parser_parse
        """

    @extern("rt_ts_tree_root_node")
    fn tree_root_node(tree_handle: i64) -> i64:
        """Get root node of tree.

        Args:
            tree_handle - Tree handle

        Returns:
            Root node handle
        """

    @extern("rt_ts_tree_edit")
    fn tree_edit(tree_handle: i64,
                 start_byte: i64, old_end_byte: i64, new_end_byte: i64,
                 start_row: i64, start_col: i64,
                 old_end_row: i64, old_end_col: i64,
                 new_end_row: i64, new_end_col: i64):
        """Apply edit to tree for incremental parsing.

        Args:
            tree_handle - Tree to edit
            start_byte - Edit start position (bytes)
            old_end_byte - Old edit end position
            new_end_byte - New edit end position
            start_row, start_col - Edit start point (line, column)
            old_end_row, old_end_col - Old edit end point
            new_end_row, new_end_col - New edit end point
        """

    # ========================================================================
    # Node Operations - Type and Position
    # ========================================================================

    @extern("rt_ts_node_type")
    fn node_type(node_handle: i64) -> text:
        """Get node type string.

        Args:
            node_handle - Node handle

        Returns:
            Type name (e.g., "function_definition", "identifier")
        """

    @extern("rt_ts_node_symbol")
    fn node_symbol(node_handle: i64) -> i32:
        """Get node symbol ID.

        Args:
            node_handle - Node handle

        Returns:
            Symbol ID (language-specific)
        """

    @extern("rt_ts_node_start_byte")
    fn node_start_byte(node_handle: i64) -> i64:
        """Get node start byte offset.

        Args:
            node_handle - Node handle

        Returns:
            Start byte in source
        """

    @extern("rt_ts_node_end_byte")
    fn node_end_byte(node_handle: i64) -> i64:
        """Get node end byte offset.

        Args:
            node_handle - Node handle

        Returns:
            End byte in source
        """

    @extern("rt_ts_node_start_point")
    fn node_start_point(node_handle: i64) -> (i64, i64):
        """Get node start point (row, column).

        Args:
            node_handle - Node handle

        Returns:
            Tuple (row, column) - zero-indexed
        """

    @extern("rt_ts_node_end_point")
    fn node_end_point(node_handle: i64) -> (i64, i64):
        """Get node end point (row, column).

        Args:
            node_handle - Node handle

        Returns:
            Tuple (row, column) - zero-indexed
        """

    # ========================================================================
    # Node Operations - Tree Navigation
    # ========================================================================

    @extern("rt_ts_node_child_count")
    fn node_child_count(node_handle: i64) -> i64:
        """Get number of children (including anonymous nodes).

        Args:
            node_handle - Node handle

        Returns:
            Child count
        """

    @extern("rt_ts_node_child")
    fn node_child(node_handle: i64, index: i64) -> i64:
        """Get child at index.

        Args:
            node_handle - Node handle
            index - Child index (0-based)

        Returns:
            Child node handle or 0 if out of bounds
        """

    @extern("rt_ts_node_named_child_count")
    fn node_named_child_count(node_handle: i64) -> i64:
        """Get number of named children (excludes anonymous nodes).

        Args:
            node_handle - Node handle

        Returns:
            Named child count
        """

    @extern("rt_ts_node_named_child")
    fn node_named_child(node_handle: i64, index: i64) -> i64:
        """Get named child at index.

        Args:
            node_handle - Node handle
            index - Named child index (0-based)

        Returns:
            Child node handle or 0 if out of bounds
        """

    @extern("rt_ts_node_parent")
    fn node_parent(node_handle: i64) -> i64:
        """Get parent node.

        Args:
            node_handle - Node handle

        Returns:
            Parent node handle or 0 if root
        """

    @extern("rt_ts_node_next_sibling")
    fn node_next_sibling(node_handle: i64) -> i64:
        """Get next sibling.

        Args:
            node_handle - Node handle

        Returns:
            Next sibling handle or 0 if last
        """

    @extern("rt_ts_node_prev_sibling")
    fn node_prev_sibling(node_handle: i64) -> i64:
        """Get previous sibling.

        Args:
            node_handle - Node handle

        Returns:
            Previous sibling handle or 0 if first
        """

    # ========================================================================
    # Node Operations - Properties
    # ========================================================================

    @extern("rt_ts_node_is_named")
    fn node_is_named(node_handle: i64) -> bool:
        """Check if node is named (not anonymous).

        Args:
            node_handle - Node handle

        Returns:
            true if named node
        """

    @extern("rt_ts_node_is_missing")
    fn node_is_missing(node_handle: i64) -> bool:
        """Check if node is missing (inserted by error recovery).

        Args:
            node_handle - Node handle

        Returns:
            true if missing
        """

    @extern("rt_ts_node_is_extra")
    fn node_is_extra(node_handle: i64) -> bool:
        """Check if node is extra (e.g., whitespace, comments).

        Args:
            node_handle - Node handle

        Returns:
            true if extra
        """

    @extern("rt_ts_node_has_error")
    fn node_has_error(node_handle: i64) -> bool:
        """Check if node or descendants have parse errors.

        Args:
            node_handle - Node handle

        Returns:
            true if errors present
        """

    @extern("rt_ts_node_is_null")
    fn node_is_null(node_handle: i64) -> bool:
        """Check if node handle is null/invalid.

        Args:
            node_handle - Node handle to check

        Returns:
            true if null
        """

    # ========================================================================
    # Query Operations
    # ========================================================================

    @extern("rt_ts_query_new")
    fn query_new(language: text, source: text) -> i64:
        """Create query from S-expression pattern.

        Args:
            language - Language name
            source - S-expression query pattern

        Returns:
            Query handle (>0) or 0 on error

        Example:
            query_new("simple", "(function_definition name: (identifier) @name)")
        """

    @extern("rt_ts_query_free")
    fn query_free(handle: i64):
        """Free query resources.

        Args:
            handle - Query handle from query_new
        """

    @extern("rt_ts_query_pattern_count")
    fn query_pattern_count(handle: i64) -> i64:
        """Get number of patterns in query.

        Args:
            handle - Query handle

        Returns:
            Pattern count
        """

    @extern("rt_ts_query_capture_count")
    fn query_capture_count(handle: i64) -> i64:
        """Get number of captures in query.

        Args:
            handle - Query handle

        Returns:
            Capture count
        """

    @extern("rt_ts_query_capture_name")
    fn query_capture_name(handle: i64, index: i64) -> text:
        """Get capture name by index.

        Args:
            handle - Query handle
            index - Capture index

        Returns:
            Capture name (e.g., "name", "param")
        """

    # ========================================================================
    # Query Cursor Operations
    # ========================================================================

    @extern("rt_ts_query_cursor_new")
    fn query_cursor_new() -> i64:
        """Create new query cursor.

        Returns:
            Cursor handle
        """

    @extern("rt_ts_query_cursor_free")
    fn query_cursor_free(handle: i64):
        """Free query cursor resources.

        Args:
            handle - Cursor handle from query_cursor_new
        """

    @extern("rt_ts_query_cursor_exec")
    fn query_cursor_exec(cursor_handle: i64, query_handle: i64, node_handle: i64):
        """Execute query on node.

        Args:
            cursor_handle - Cursor handle
            query_handle - Query handle
            node_handle - Root node to search from
        """

    @extern("rt_ts_query_cursor_next_match")
    fn query_cursor_next_match(cursor_handle: i64) -> (bool, i64, i64):
        """Get next query match.

        Args:
            cursor_handle - Cursor handle

        Returns:
            Tuple (has_match, pattern_index, capture_count)
        """

    @extern("rt_ts_query_cursor_next_capture")
    fn query_cursor_next_capture(cursor_handle: i64) -> (bool, i64, i64):
        """Get next capture from current match.

        Args:
            cursor_handle - Cursor handle

        Returns:
            Tuple (has_capture, node_handle, capture_index)
        """

    @extern("rt_ts_query_cursor_set_byte_range")
    fn query_cursor_set_byte_range(cursor_handle: i64, start: i64, end: i64):
        """Set byte range for query cursor (optimization).

        Args:
            cursor_handle - Cursor handle
            start - Start byte
            end - End byte
        """

    @extern("rt_ts_query_cursor_set_point_range")
    fn query_cursor_set_point_range(cursor_handle: i64,
                                     start_row: i64, start_col: i64,
                                     end_row: i64, end_col: i64):
        """Set point range for query cursor (optimization).

        Args:
            cursor_handle - Cursor handle
            start_row, start_col - Start point
            end_row, end_col - End point
        """
