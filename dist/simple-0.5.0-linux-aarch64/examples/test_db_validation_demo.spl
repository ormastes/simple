# Test Database Validation Demo
#
# This script demonstrates the new data integrity checking system
# for the test database. It shows how to validate and cleanup stale runs.

use std.tooling.testing.validation

fn main():
    print "=== Test Database Integrity Validation Demo ==="
    print ""

    # 1. Enable validation
    print "1. Enabling validation mode..."
    validation.enable_validation(true)
    print "   ✓ Validation enabled"
    print ""

    # 2. Validate default test database
    print "2. Validating default test database..."
    match validation.validate_default():
        Ok(0):
            print "   ✓ Database is clean - no violations found!"
        Ok(count):
            print "   ⚠ Found {count} integrity violation(s)"
            print "   Run with SIMPLE_TEST_DEBUG=basic to see details"
        Err(msg):
            print "   ✗ Error: {msg}"
    print ""

    # 3. Cleanup stale runs
    print "3. Cleaning up stale test runs..."
    match validation.cleanup_default():
        Ok(0):
            print "   ✓ No stale runs found"
        Ok(count):
            print "   ✓ Cleaned up {count} stale run(s)"
        Err(msg):
            print "   ✗ Error: {msg}"
    print ""

    # 4. Validate specific database
    val custom_db = "doc/test/test_db.sdn"
    print "4. Validating specific database: {custom_db}"
    validation.validate_and_report(custom_db)
    print ""

    # 5. Configuration example
    print "5. Using validation configuration..."
    val config = validation.ValidationConfig.new()
        .with_auto_validate(true)
        .with_auto_cleanup(false)
        .with_threshold(3)  # 3 hours threshold

    print "   Config: auto_validate={config.auto_validate}, "
    print "           auto_cleanup={config.auto_cleanup}, "
    print "           threshold={config.hours_threshold}h"

    config.apply()
    print "   ✓ Configuration applied"
    print ""

    print "=== Demo Complete ==="
    print ""
    print "Available functions:"
    print "  - validation.enable_validation(bool)"
    print "  - validation.validate_database(path)"
    print "  - validation.cleanup_stale_runs(path)"
    print "  - validation.validate_default()"
    print "  - validation.cleanup_default()"
    print "  - validation.validate_and_report(path)"
    print "  - validation.cleanup_and_report(path)"
