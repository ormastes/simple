# Primary Expressions
#
# Entry point for primary expressions - the highest precedence level.
# Dispatches to specialized parsers for literals, identifiers, lambdas,
# collections, control flow, and math blocks.

from token import {TokenKind}
from ast import {Expr}
from error import {ParseError}

impl Parser:

    fn parse_primary() -> Expr:
        match self.current.kind:
            TokenKind.Ellipsis:
                self.advance()
                Expr.Tuple([])

            TokenKind.Underscore:
                self.advance()
                Expr.Identifier("_")

            TokenKind.Integer(_) | TokenKind.TypedInteger(_, _) | TokenKind.Float(_) |
            TokenKind.TypedFloat(_, _) | TokenKind.String(_) | TokenKind.RawString(_) |
            TokenKind.TypedString(_, _) | TokenKind.TypedRawString(_, _) |
            TokenKind.FString(_) | TokenKind.Bool(_) | TokenKind.Nil |
            TokenKind.Symbol(_) | TokenKind.CustomBlock(_, _, _):
                self.parse_primary_literal()

            TokenKind.I18nString(_, _) | TokenKind.I18nFString(_, _):
                self.parse_i18n_literal()

            TokenKind.Result | TokenKind.Identifier(_, _) | TokenKind.Self_ |
            TokenKind.Super | TokenKind.Out | TokenKind.OutErr | TokenKind.Type |
            TokenKind.Feature | TokenKind.Scenario | TokenKind.Outline |
            TokenKind.Examples | TokenKind.Given | TokenKind.When |
            TokenKind.Then | TokenKind.AndThen | TokenKind.Context |
            TokenKind.Common | TokenKind.Vec | TokenKind.Gpu |
            TokenKind.Slice | TokenKind.Flat | TokenKind.Alias |
            TokenKind.Bounds | TokenKind.Default | TokenKind.From | TokenKind.To:
                self.parse_primary_identifier()

            TokenKind.Backslash | TokenKind.Pipe | TokenKind.Move:
                self.parse_primary_lambda()

            TokenKind.Fn:
                val next = self.peek_token()
                if match next.kind:
                    TokenKind.LParen: true
                    _: false:
                    self.parse_primary_lambda()
                else:
                    raise ParseError.unexpected_token("expression",
                        "fn (function definitions are not expressions - use fn(): for lambdas)",
                        self.current.span)

            TokenKind.LParen | TokenKind.LBracket | TokenKind.LBrace:
                self.parse_primary_collection()

            TokenKind.New:
                val next = self.peek_token()
                match next.kind:
                    TokenKind.Identifier(_, _) | TokenKind.Ampersand |
                    TokenKind.Star | TokenKind.Plus | TokenKind.Minus:
                        self.parse_primary_control()
                    _:
                        self.parse_primary_identifier()

            TokenKind.Old:
                val next = self.peek_token()
                if match next.kind:
                    TokenKind.LParen: true
                    _: false:
                    self.parse_primary_control()
                else:
                    self.parse_primary_identifier()

            TokenKind.Spawn | TokenKind.Go | TokenKind.If | TokenKind.Elif |
            TokenKind.Match | TokenKind.Dollar:
                self.parse_primary_control()

            TokenKind.Grid | TokenKind.Tensor:
                self.parse_primary_math()

            TokenKind.At:
                val next = self.peek_token()
                if match next.kind:
                    TokenKind.Identifier(_, _): true
                    _: false:
                    self.advance()  # consume '@'
                    val name = self.expect_identifier()
                    Expr.Identifier("@{name}")
                else:
                    raise ParseError.unexpected_token("expression",
                        "@ (matrix mul requires left operand, FFI calls require @identifier)",
                        self.current.span)

            TokenKind.Forall:
                self.parse_forall()

            TokenKind.Exists:
                self.parse_exists()

            _:
                raise ParseError.unexpected_token("expression",
                    "{self.current.kind}", self.current.span)
