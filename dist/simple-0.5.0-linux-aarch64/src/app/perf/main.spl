# Performance Tools - Main Entry Point
# Pure Simple implementation of performance analysis and optimization

import io
import perf.profiler
import perf.benchmark
import perf.optimizer

fn show_help():
    print "Simple Performance Tools"
    print "=" * 60
    print ""
    print "Usage: simple perf <command> [options]"
    print ""
    print "Commands:"
    print "  profile <file>         Run profiler on Simple script"
    print "  benchmark <file>       Run benchmarks"
    print "  optimize <file|dir>    Analyze code and suggest optimizations"
    print "  compare <cur> <base>   Compare benchmark results"
    print "  help                   Show this help"
    print ""
    print "Examples:"
    print "  simple perf profile examples/fibonacci.spl"
    print "  simple perf benchmark benchmarks/loops.spl"
    print "  simple perf optimize src/"
    print "  simple perf compare results/current.json results/baseline.json"

fn cmd_profile(args: List<text>):
    if args.len() < 2:
        print "Error: No file specified"
        print "Usage: simple perf profile <file>"
        return

    val file = args[1]
    if not io.file_exists(file):
        print "Error: File not found: {file}"
        return

    print "Profiling: {file}"
    print ""

    # Initialize profiler
    profiler.init_profiler()

    # Execute the file with profiling enabled
    # (This would need SFFI support to actually execute)
    print "Note: Profiling requires executing the target file"
    print "Use profiler.profile_region() in your code to mark regions"
    print ""
    print "Example:"
    print "  import perf.profiler"
    print ""
    print "  fn slow_function():"
    print "      profiler.profile_region(\"computation\", \:"
    print "          # Your code here"
    print "      )"
    print ""
    print "  profiler.print_profile()"

fn cmd_benchmark(args: List<text>):
    if args.len() < 2:
        print "Error: No file specified"
        print "Usage: simple perf benchmark <file>"
        return

    val file = args[1]
    print "Benchmark file: {file}"
    print ""
    print "Add benchmark.run_bench() calls in your code:"
    print ""
    print "  import perf.benchmark"
    print ""
    print "  var suite = benchmark.BenchSuite.create(\"My Benchmarks\")"
    print ""
    print "  val result = suite.run_bench(\"test1\", 1000, \:"
    print "      # Code to benchmark"
    print "  )"
    print "  suite.add_result(result)"
    print ""
    print "  suite.save(\"results.json\")"
    print "  print suite.report()"

fn cmd_optimize(args: List<text>):
    if args.len() < 2:
        print "Error: No file or directory specified"
        print "Usage: simple perf optimize <file|dir>"
        return

    val target = args[1]

    print "Analyzing: {target}"
    print ""

    var suggestions = []
    if io.is_dir(target):
        suggestions = optimizer.analyze_project(target)
    else:
        suggestions = optimizer.analyze_code(target)

    if suggestions.is_empty():
        print "âœ“ No optimization suggestions found"
        return

    print optimizer.generate_report(suggestions)

fn cmd_compare(args: List<text>):
    if args.len() < 3:
        print "Error: Need two files to compare"
        print "Usage: simple perf compare <current> <baseline>"
        return

    val current = args[1]
    val baseline = args[2]

    if not io.file_exists(current):
        print "Error: Current file not found: {current}"
        return

    if not io.file_exists(baseline):
        print "Error: Baseline file not found: {baseline}"
        return

    benchmark.compare_with_baseline(current, baseline)

fn main():
    val args = rt_get_args()

    if args.len() < 2:
        show_help()
        return

    val command = args[1]
    val rest_args = args[1..]

    match command:
        "profile": cmd_profile(rest_args)
        "benchmark": cmd_benchmark(rest_args)
        "optimize": cmd_optimize(rest_args)
        "compare": cmd_compare(rest_args)
        "help": show_help()
        _:
            print "Unknown command: {command}"
            print ""
            show_help()

# SFFI hooks
extern fn rt_get_args() -> List<text>
