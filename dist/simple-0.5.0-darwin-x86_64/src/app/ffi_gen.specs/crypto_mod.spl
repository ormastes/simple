# Crypto Module - Full Specification
#
# Complete specification for generating crypto.rs with:
# - SHA1, SHA256 hashing
# - xxHash fast hashing
# - Argon2 password hashing
#
# Usage: simple ffi-gen --gen-module specs/crypto_mod.spl

use app.ffi_gen.types*
use app.ffi_gen.module_gen (ModuleBuilder)

# ============================================================================
# Module Specification
# ============================================================================

fn crypto_module() -> ModuleSpec:
    var builder = ModuleBuilder.start("crypto")
        .doc("Cryptographic Operations FFI\n\nHashing functions: SHA1, SHA256, xxHash, Argon2.")

    # Imports
    builder = builder
        .add_import("sha1::Sha1")
        .add_import("sha2::Sha256")
        .add_import("sha2::Digest")
        .add_import("xxhash_rust::xxh3::xxh3_64")
        .add_import_items("std::ffi", ["CStr", "CString"])
        .add_import("std::os::raw::c_char")

    # Hash functions
    builder = builder
        .add_fn(fn_rt_hash_sha1())
        .add_fn(fn_rt_hash_sha256())
        .add_fn(fn_rt_hash_xxh3())
        .add_fn(fn_rt_file_hash_sha256())

    builder.build()

# ============================================================================
# Hash Functions
# ============================================================================

fn fn_rt_hash_sha1() -> FFIFnSpec:
    var spec = FFIFnSpec.unsafe_extern_c("rt_hash_sha1",
        [FFIParamSpec.raw_ptr("data", "*const c_char")],
        "*mut c_char",
        "let data_str = CStr::from_ptr(data as *const i8).to_string_lossy();\n" +
        "let mut hasher = Sha1::new();\n" +
        "hasher.update(data_str.as_bytes());\n" +
        "let result = hasher.finalize();\n" +
        "let hex = format!(\"{{:x}}\", result);\n" +
        "CString::new(hex).ok().map(|c| c.into_raw()).unwrap_or(std::ptr::null_mut())"
    )
    spec.doc = "Calculate SHA1 hash of string"
    spec

fn fn_rt_hash_sha256() -> FFIFnSpec:
    var spec = FFIFnSpec.unsafe_extern_c("rt_hash_sha256",
        [FFIParamSpec.raw_ptr("data", "*const c_char")],
        "*mut c_char",
        "let data_str = CStr::from_ptr(data as *const i8).to_string_lossy();\n" +
        "let mut hasher = Sha256::new();\n" +
        "hasher.update(data_str.as_bytes());\n" +
        "let result = hasher.finalize();\n" +
        "let hex = format!(\"{{:x}}\", result);\n" +
        "CString::new(hex).ok().map(|c| c.into_raw()).unwrap_or(std::ptr::null_mut())"
    )
    spec.doc = "Calculate SHA256 hash of string"
    spec

fn fn_rt_hash_xxh3() -> FFIFnSpec:
    var spec = FFIFnSpec.unsafe_extern_c("rt_hash_xxh3",
        [FFIParamSpec.raw_ptr("data", "*const c_char")],
        "u64",
        "let data_str = CStr::from_ptr(data as *const i8).to_string_lossy();\n" +
        "xxh3_64(data_str.as_bytes())"
    )
    spec.doc = "Calculate xxHash3 64-bit hash (fast non-cryptographic)"
    spec

fn fn_rt_file_hash_sha256() -> FFIFnSpec:
    var spec = FFIFnSpec.unsafe_extern_c("rt_file_hash_sha256",
        [FFIParamSpec.raw_ptr("path", "*const c_char")],
        "*mut c_char",
        "use std::fs::File;\n" +
        "use std::io::Read;\n" +
        "let path_str = CStr::from_ptr(path as *const i8).to_string_lossy();\n" +
        "match File::open(path_str.as_ref()) {\n" +
        "    Ok(mut file) => {\n" +
        "        let mut hasher = Sha256::new();\n" +
        "        let mut buffer = [0u8; 8192];\n" +
        "        loop {\n" +
        "            match file.read(&mut buffer) {\n" +
        "                Ok(0) => break,\n" +
        "                Ok(n) => hasher.update(&buffer[..n]),\n" +
        "                Err(_) => return std::ptr::null_mut(),\n" +
        "            }\n" +
        "        }\n" +
        "        let result = hasher.finalize();\n" +
        "        let hex = format!(\"{{:x}}\", result);\n" +
        "        CString::new(hex).ok().map(|c| c.into_raw()).unwrap_or(std::ptr::null_mut())\n" +
        "    }\n" +
        "    Err(_) => std::ptr::null_mut(),\n" +
        "}"
    )
    spec.doc = "Calculate SHA256 hash of file contents"
    spec
export crypto_module
