# Test Runner Client Assertions
#
# Minimal assertion functions for embedded test cases.
# Uses string handles (interned at compile time) for minimal binary size.
#
# Usage with harness:
#   harness.begin_test(1)
#   assert_true(condition, 0, 0, 42, harness)  # msg=0, file=0, line=42
#   harness.pass_test()

# =========================================================================
# Assertion Result
# =========================================================================

class AssertResult:
    passed: bool
    msg_handle: i32
    file_handle: i32
    line: i32

fn AssertResult_pass() -> AssertResult:
    AssertResult(passed: true, msg_handle: 0, file_handle: 0, line: 0)

fn AssertResult_fail(msg_handle: i32, file_handle: i32, line: i32) -> AssertResult:
    AssertResult(passed: false, msg_handle: msg_handle, file_handle: file_handle, line: line)

# =========================================================================
# Basic Assertions
# =========================================================================

# Assert condition is true
fn assert_true(condition: bool, msg_handle: i32, file_handle: i32, line: i32) -> AssertResult:
    if condition:
        AssertResult_pass()
    else:
        AssertResult_fail(msg_handle, file_handle, line)

# Assert condition is false
fn assert_false(condition: bool, msg_handle: i32, file_handle: i32, line: i32) -> AssertResult:
    assert_true(not condition, msg_handle, file_handle, line)

# =========================================================================
# Equality Assertions
# =========================================================================

fn assert_eq_i32(actual: i32, expected: i32, msg_handle: i32, file_handle: i32, line: i32) -> AssertResult:
    if actual == expected:
        AssertResult_pass()
    else:
        AssertResult_fail(msg_handle, file_handle, line)

fn assert_eq_i64(actual: i64, expected: i64, msg_handle: i32, file_handle: i32, line: i32) -> AssertResult:
    if actual == expected:
        AssertResult_pass()
    else:
        AssertResult_fail(msg_handle, file_handle, line)

fn assert_eq_bool(actual: bool, expected: bool, msg_handle: i32, file_handle: i32, line: i32) -> AssertResult:
    if actual == expected:
        AssertResult_pass()
    else:
        AssertResult_fail(msg_handle, file_handle, line)

# =========================================================================
# Inequality Assertions
# =========================================================================

fn assert_ne_i32(actual: i32, expected: i32, msg_handle: i32, file_handle: i32, line: i32) -> AssertResult:
    if actual != expected:
        AssertResult_pass()
    else:
        AssertResult_fail(msg_handle, file_handle, line)

fn assert_ne_i64(actual: i64, expected: i64, msg_handle: i32, file_handle: i32, line: i32) -> AssertResult:
    if actual != expected:
        AssertResult_pass()
    else:
        AssertResult_fail(msg_handle, file_handle, line)

# =========================================================================
# Comparison Assertions
# =========================================================================

fn assert_lt_i32(actual: i32, expected: i32, msg_handle: i32, file_handle: i32, line: i32) -> AssertResult:
    if actual < expected:
        AssertResult_pass()
    else:
        AssertResult_fail(msg_handle, file_handle, line)

fn assert_le_i32(actual: i32, expected: i32, msg_handle: i32, file_handle: i32, line: i32) -> AssertResult:
    if actual <= expected:
        AssertResult_pass()
    else:
        AssertResult_fail(msg_handle, file_handle, line)

fn assert_gt_i32(actual: i32, expected: i32, msg_handle: i32, file_handle: i32, line: i32) -> AssertResult:
    if actual > expected:
        AssertResult_pass()
    else:
        AssertResult_fail(msg_handle, file_handle, line)

fn assert_ge_i32(actual: i32, expected: i32, msg_handle: i32, file_handle: i32, line: i32) -> AssertResult:
    if actual >= expected:
        AssertResult_pass()
    else:
        AssertResult_fail(msg_handle, file_handle, line)

# =========================================================================
# Range Assertions
# =========================================================================

fn assert_in_range_i32(actual: i32, min: i32, max: i32, msg_handle: i32, file_handle: i32, line: i32) -> AssertResult:
    if actual >= min and actual <= max:
        AssertResult_pass()
    else:
        AssertResult_fail(msg_handle, file_handle, line)

# =========================================================================
# Harness Integration
# =========================================================================

# Check assertion and report to harness if failed
fn check_assert(harness: TestHarness, result: AssertResult) -> bool:
    if not result.passed:
        harness.assert_fail(result.msg_handle, result.file_handle, result.line)
    result.passed

# Run assertion and fail test immediately if failed
fn require_assert(harness: TestHarness, result: AssertResult) -> bool:
    if not result.passed:
        harness.fail_test(result.msg_handle, result.file_handle, result.line)
        false
    else:
        true

# =========================================================================
# Assertion Collector (for multiple assertions per test)
# =========================================================================

class AssertCollector:
    results: [AssertResult]
    all_passed: bool

fn AssertCollector_create() -> AssertCollector:
    AssertCollector(results: [], all_passed: true)

impl AssertCollector:
    me add(result: AssertResult):
        self.results.push(result)
        if not result.passed:
            self.all_passed = false

    fn is_passed() -> bool:
        self.all_passed

    fn failure_count() -> i32:
        var count: i32 = 0
        for r in self.results:
            if not r.passed:
                count = count + 1
        count

    fn get_first_failure() -> AssertResult:
        for r in self.results:
            if not r.passed:
                return r
        AssertResult_pass()

    # Report all failures to harness
    me report_to_harness(harness: TestHarness):
        for r in self.results:
            if not r.passed:
                harness.assert_fail(r.msg_handle, r.file_handle, r.line)
