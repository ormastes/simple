# FFI Package Generator
#
# Packages the FFI wrapper for distribution.
#
# Usage:
#   simple src/app/ffi_gen/package.spl

use app.io.mod (file_read, file_write, file_exists, dir_create, cwd)

fn main():
    val root = cwd()
    val build_dir = root + "/build/rust"
    val pkg_dir = root + "/build/package"
    val template_dir = root + "/src/app/ffi_gen/templates"

    print "FFI Package Generator"
    print "====================="
    print ""

    # Step 1: Check FFI source exists
    print "Step 1: Check FFI source..."
    val bootstrap_ffi = build_dir + "/ffi_gen/src/bootstrap_ffi.rs"
    if not file_exists(bootstrap_ffi):
        print "  ERROR: FFI source not found. Run bootstrap first:"
        print "    simple src/app/ffi_gen/bootstrap_gen.spl"
        return
    print "  FFI source ready"

    # Step 2: Create package directories
    print ""
    print "Step 2: Create package structure..."
    dir_create(pkg_dir, true)
    dir_create(pkg_dir + "/lib", true)
    dir_create(pkg_dir + "/include", true)
    dir_create(pkg_dir + "/src", true)
    print "  Created " + pkg_dir

    # Step 3: Copy templates
    print ""
    print "Step 3: Copy package files..."
    copy_template(template_dir, pkg_dir, "simple_ffi.h", "include/simple_ffi.h")
    copy_template(template_dir, pkg_dir, "lib.txt", "src/lib.txt")
    copy_template(template_dir, pkg_dir, "gc.txt", "src/gc.txt")
    copy_template(template_dir, pkg_dir, "env.txt", "src/env.txt")
    copy_template(template_dir, pkg_dir, "file_io.txt", "src/file_io.txt")
    copy_template(template_dir, pkg_dir, "runtime_value.txt", "src/runtime_value.txt")
    copy_template(template_dir, pkg_dir, "bootstrap_ffi.txt", "src/bootstrap_ffi.txt")
    copy_template(template_dir, pkg_dir, "MANIFEST.sdn", "MANIFEST.sdn")
    copy_template(template_dir, pkg_dir, "build.sh", "build.sh")

    print ""
    print "Package created: " + pkg_dir
    print ""
    print "To build:"
    print "  cd " + pkg_dir
    print "  chmod +x build.sh"
    print "  ./build.sh --release"

fn copy_template(src_dir: text, dst_dir: text, src_name: text, dst_name: text):
    val src_path = src_dir + "/" + src_name
    val dst_path = dst_dir + "/" + dst_name
    if file_exists(src_path):
        val content = file_read(src_path)
        file_write(dst_path, content)
        print "  Copied " + dst_name
    else:
        print "  WARNING: " + src_name + " not found"
