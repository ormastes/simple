name: Release Distribution

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags (e.g., v0.5.0)
  workflow_dispatch:  # Allow manual trigger
    inputs:
      version:
        description: 'Version to release (e.g., 0.5.0)'
        required: true
        default: '0.5.0'

env:
  CARGO_TERM_COLOR: always

jobs:
  # =========================================================================
  # Build Runtime Binaries for All Platforms
  # =========================================================================
  build-runtime:
    name: Build Runtime - ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        include:
          # Linux
          - os: ubuntu-latest
            platform: linux-x86_64
            target: x86_64-unknown-linux-gnu

          - os: ubuntu-latest
            platform: linux-aarch64
            target: aarch64-unknown-linux-gnu
            cross: true

          # macOS
          - os: macos-13  # Intel
            platform: darwin-x86_64
            target: x86_64-apple-darwin

          - os: macos-latest  # ARM64
            platform: darwin-arm64
            target: aarch64-apple-darwin

          # Windows
          - os: windows-latest
            platform: windows-x86_64
            target: x86_64-pc-windows-msvc

          - os: windows-latest
            platform: windows-aarch64
            target: aarch64-pc-windows-msvc
            cross: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools (Linux ARM64)
        if: matrix.platform == 'linux-aarch64'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Install cross (for cross-compilation)
        if: matrix.cross == true
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build runtime (native)
        if: matrix.cross != true
        run: |
          cd rust
          cargo build --profile bootstrap --target ${{ matrix.target }}

      - name: Build runtime (cross)
        if: matrix.cross == true
        run: |
          cd rust
          cross build --profile bootstrap --target ${{ matrix.target }}

      - name: Prepare runtime artifact (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p artifacts/${{ matrix.platform }}
          cp rust/target/${{ matrix.target }}/bootstrap/simple_runtime artifacts/${{ matrix.platform }}/
          chmod +x artifacts/${{ matrix.platform }}/simple_runtime
          ls -lh artifacts/${{ matrix.platform }}/

      - name: Prepare runtime artifact (Windows)
        if: runner.os == 'Windows'
        run: |
          mkdir -p artifacts/${{ matrix.platform }}
          cp rust/target/${{ matrix.target }}/bootstrap/simple_runtime.exe artifacts/${{ matrix.platform }}/
          dir artifacts/${{ matrix.platform }}

      - name: Upload runtime artifact
        uses: actions/upload-artifact@v4
        with:
          name: runtime-${{ matrix.platform }}
          path: artifacts/${{ matrix.platform }}/*
          retention-days: 7

  # =========================================================================
  # Create Distribution Packages
  # =========================================================================
  create-distribution:
    name: Create Distribution Packages
    needs: build-runtime
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all runtime artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          find artifacts -type f -exec ls -lh {} \;

      - name: Organize runtime binaries
        run: |
          mkdir -p bin/bootstrap
          # Copy Linux x86_64 runtime for running the builder
          cp artifacts/runtime-linux-x86_64/simple_runtime bin/bootstrap/
          chmod +x bin/bootstrap/simple_runtime
          # Copy all runtimes to dist/runtimes/
          mkdir -p dist/runtimes
          for platform in linux-x86_64 linux-aarch64 darwin-x86_64 darwin-arm64 windows-x86_64 windows-aarch64; do
            mkdir -p dist/runtimes/$platform
            cp artifacts/runtime-$platform/* dist/runtimes/$platform/ || true
          done

      - name: Install rsync (for distribution builder)
        run: sudo apt-get update && sudo apt-get install -y rsync

      - name: Run distribution builder
        run: |
          # Use the Linux x86_64 runtime to build distributions
          ./bin/bootstrap/simple_runtime src/app/package/dist.spl

      - name: List created packages
        run: |
          echo "Created distribution packages:"
          ls -lh dist/*.tar.gz dist/*.zip 2>/dev/null || echo "No packages found"
          du -sh dist/simple-*/ 2>/dev/null || echo "No directories found"

      - name: Upload distribution packages
        uses: actions/upload-artifact@v4
        with:
          name: distributions
          path: |
            dist/*.tar.gz
            dist/*.zip
          retention-days: 30

  # =========================================================================
  # Create GitHub Release
  # =========================================================================
  create-release:
    name: Create GitHub Release
    needs: create-distribution
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download distribution packages
        uses: actions/download-artifact@v4
        with:
          name: distributions
          path: dist

      - name: Extract version from tag
        id: version
        run: echo "VERSION=\${GITHUB_REF#refs/tags/v}" >> \$GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Simple v\${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
          files: |
            dist/simple-*.tar.gz
            dist/simple-*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
