# Simple CLI - query command
# Search source files for code patterns

use app.cli_util (get_cli_args)
use app.io.mod (file_exists, file_read, cwd, dir_walk)

fn print_help():
    print "Usage: simple query <pattern> [path] [options]"
    print ""
    print "Search Simple source files for patterns."
    print ""
    print "Arguments:"
    print "  <pattern>          Text pattern to search for"
    print "  [path]             Directory to search (default: src/)"
    print ""
    print "Options:"
    print "  --generated        Find LLM-generated code markers"
    print "  --todo             Find TODO/FIXME comments"
    print "  --fn               Find function definitions"
    print "  --class            Find class/struct definitions"
    print "  --extern           Find extern declarations"
    print "  --count            Show count only"
    print "  -i                 Case-insensitive search"
    print "  -h, --help         Show this help"

fn search_file(path: text, pattern: text, case_insensitive: bool) -> [(i64, text)]:
    val content = file_read(path)
    val lines = content.split("\n")
    var matches = []
    var line_num = 1

    val search_pattern = if case_insensitive: pattern.lower() else: pattern

    for line in lines:
        val search_line = if case_insensitive: line.lower() else: line
        if search_line.contains(search_pattern):
            matches.push((line_num, line))
        line_num = line_num + 1

    matches

fn main() -> i64:
    val args = get_cli_args()

    if args.len() == 0:
        print_help()
        return 0

    var pattern = ""
    var search_path = ""
    var find_generated = false
    var find_todos = false
    var find_fns = false
    var find_classes = false
    var find_externs = false
    var count_only = false
    var case_insensitive = false

    for arg in args:
        if arg == "-h" or arg == "--help":
            print_help()
            return 0
        elif arg == "--generated":
            find_generated = true
        elif arg == "--todo":
            find_todos = true
        elif arg == "--fn":
            find_fns = true
        elif arg == "--class":
            find_classes = true
        elif arg == "--extern":
            find_externs = true
        elif arg == "--count":
            count_only = true
        elif arg == "-i":
            case_insensitive = true
        elif not arg.starts_with("-"):
            if pattern == "":
                pattern = arg
            else:
                search_path = arg

    # Set pattern based on flags
    if find_generated:
        pattern = "Generated by"
    elif find_todos:
        pattern = "TODO"
    elif find_fns:
        pattern = "fn "
    elif find_classes:
        pattern = "class "
    elif find_externs:
        pattern = "extern fn"

    if pattern == "":
        print "error: missing search pattern"
        return 1

    val cwd = cwd()
    if search_path == "":
        search_path = "{cwd}/src"

    if not file_exists(search_path):
        print "error: path not found: {search_path}"
        return 1

    val files = dir_walk(search_path)
    var total_matches = 0

    for file in files:
        if not file.ends_with(".spl"):
            pass
        else:
            val matches = search_file(file, pattern, case_insensitive)
            if matches.len() > 0:
                total_matches = total_matches + matches.len()
                if not count_only:
                    val display_path = if file.starts_with(cwd): file[cwd.len() + 1:] else: file
                    for (line_num, line) in matches:
                        print "{display_path}:{line_num}: {line.trim()}"

    if count_only:
        print "{total_matches}"
    elif total_matches == 0:
        print "No matches found for '{pattern}'"

    0
