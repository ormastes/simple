# Watchdog Timer
#
# Wall-clock timeout detection using a background thread.
# The watchdog sets a shared flag when the deadline expires.
# Loop bodies poll the flag with zero overhead (single bool check).
#
# Port of rust/compiler/src/watchdog.rs

from std.common.fault_detection import {
    is_timeout_exceeded, set_timeout_exceeded, reset_timeout
}

export start_watchdog, stop_watchdog, check_timeout

# ============================================================================
# FFI to Rust watchdog (background thread spawning)
# ============================================================================

extern fn rt_watchdog_start(timeout_secs: i64)
extern fn rt_watchdog_stop()

# ============================================================================
# Watchdog API
# ============================================================================

fn start_watchdog(timeout_secs: i64):
    """Start a watchdog timer. If execution exceeds timeout_secs, the
    timeout flag is set. Any existing watchdog is stopped first."""
    stop_watchdog()
    reset_timeout()
    rt_watchdog_start(timeout_secs)

fn stop_watchdog():
    """Stop the watchdog timer if running."""
    rt_watchdog_stop()

fn check_timeout() -> Result<(), text>:
    """Check if the watchdog has fired. Returns Err if timed out."""
    if is_timeout_exceeded():
        Err("execution timed out")
    else:
        Ok(())
