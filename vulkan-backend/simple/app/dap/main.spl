# Simple Debug Adapter
# DAP server for Simple language (self-hosted implementation)
# Usage: simple_dap (communicates via stdin/stdout)

import sys
import dap.server as server
import dap.transport as transport

fn main():
    # Check for help flag
    val args = sys.args()
    if args.contains("--help") or args.contains("-h"):
        print_usage()
        sys.exit(0)

    # Check for version flag
    if args.contains("--version") or args.contains("-v"):
        print("simple-dap 0.1.0")
        print("Simple Debug Adapter Protocol (DAP)")
        sys.exit(0)

    # Log startup
    transport.log_debug("Starting Simple DAP server")

    # Create and run server
    val dap_server = server.DapServer.new()

    match dap_server.run():
        case Ok(_):
            transport.log_debug("DAP server exited normally")
            sys.exit(0)
        case Err(error):
            transport.log_error(f"DAP server error: {error}")
            sys.exit(1)

fn print_usage():
    print("Simple Debug Adapter Protocol (DAP)")
    print("")
    print("Usage: simple_dap [options]")
    print("")
    print("The debug adapter communicates via stdin/stdout using the")
    print("Debug Adapter Protocol (DAP) with JSON messages.")
    print("")
    print("Options:")
    print("  -h, --help       Show this help message")
    print("  -v, --version    Show version information")
    print("")
    print("Environment Variables:")
    print("  SIMPLE_DAP_DEBUG  Enable debug logging to stderr")
    print("")
    print("Editor Integration:")
    print("  VS Code: Configure launch.json")
    print("    {")
    print("      \"type\": \"simple\",")
    print("      \"request\": \"launch\",")
    print("      \"program\": \"${file}\"")
    print("    }")
    print("")
    print("  Neovim: Use nvim-dap")
    print("    require('dap').adapters.simple = {")
    print("      type = 'executable',")
    print("      command = 'path/to/simple_dap'")
    print("    }")
    print("")
    print("Features:")
    print("  - Breakpoints (line, conditional)")
    print("  - Execution control (continue, step, pause)")
    print("  - Stack trace inspection")
    print("  - Variable viewing")
    print("")
    print("Documentation:")
    print("  https://github.com/simple-lang/simple/doc/status/dap_implementation.md")
