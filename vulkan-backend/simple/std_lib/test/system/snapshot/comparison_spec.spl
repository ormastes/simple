# Snapshot Testing Framework - Comparison Tests
# Tests for snapshot comparison and diff generation

module tests.snapshot.comparison_spec:
    use std.spec.{describe, context, it, expect}
    use std.spec.snapshot.comparison.{compare_snapshots, generate_unified_diff, ComparisonResult}

    describe("Snapshot Comparison"):
        context("Basic Comparison"):
            it("matches identical snapshots"):
                val expected = "Hello, World!"
                val actual = "Hello, World!"

                val result = compare_snapshots(
                    expected,
                    actual,
                    "test_match",
                    "text"
                )

                expect(result.is_match()).to_be_true()

            it("detects mismatches"):
                val expected = "Hello, World!"
                val actual = "Hello, Universe!"

                val result = compare_snapshots(
                    expected,
                    actual,
                    "test_mismatch",
                    "text"
                )

                expect(result.is_mismatch()).to_be_true()

            it("normalizes whitespace before comparison"):
                val expected = "Hello, World!  "
                val actual = "Hello, World!"

                val result = compare_snapshots(
                    expected,
                    actual,
                    "test_whitespace",
                    "text"
                )

                # Should match after normalization
                expect(result.is_match()).to_be_true()

        context("Multi-line Comparison"):
            it("compares multi-line content"):
                val expected = "line1\nline2\nline3"
                val actual = "line1\nline2\nline3"

                val result = compare_snapshots(
                    expected,
                    actual,
                    "test_multiline",
                    "text"
                )

                expect(result.is_match()).to_be_true()

            it("detects line differences"):
                val expected = "line1\nline2\nline3"
                val actual = "line1\nmodified\nline3"

                val result = compare_snapshots(
                    expected,
                    actual,
                    "test_line_diff",
                    "text"
                )

                expect(result.is_mismatch()).to_be_true()

        context("Unified Diff Generation"):
            it("generates diff for simple change"):
                val expected = "Hello, World!"
                val actual = "Hello, Universe!"

                val diff = generate_unified_diff(
                    expected,
                    actual,
                    "test_simple_diff"
                )

                expect(diff).to_contain("Snapshot mismatch")
                expect(diff).to_contain("--- Expected")
                expect(diff).to_contain("+++ Actual")

            it("shows added lines with + prefix"):
                val expected = "line1\nline2"
                val actual = "line1\nline2\nline3"

                val diff = generate_unified_diff(
                    expected,
                    actual,
                    "test_added"
                )

                expect(diff).to_contain("+line3")

            it("shows removed lines with - prefix"):
                val expected = "line1\nline2\nline3"
                val actual = "line1\nline3"

                val diff = generate_unified_diff(
                    expected,
                    actual,
                    "test_removed"
                )

                expect(diff).to_contain("-line2")

            it("shows changed lines"):
                val expected = "line1\nold line\nline3"
                val actual = "line1\nnew line\nline3"

                val diff = generate_unified_diff(
                    expected,
                    actual,
                    "test_changed"
                )

                expect(diff).to_contain("-old line")
                expect(diff).to_contain("+new line")

            it("includes line numbers in hunks"):
                val expected = "line1\nline2\nline3\nline4"
                val actual = "line1\nmodified\nline3\nline4"

                val diff = generate_unified_diff(
                    expected,
                    actual,
                    "test_line_numbers"
                )

                expect(diff).to_contain("@@")  # Hunk header

        context("Comparison Result Formatting"):
            it("formats match result"):
                val result = ComparisonResult.Match
                val formatted = format_comparison_result(result)

                expect(formatted).to_contain("âœ“")
                expect(formatted).to_contain("matches")

            it("formats mismatch result with diff"):
                val expected = "old"
                val actual = "new"

                val result = compare_snapshots(
                    expected,
                    actual,
                    "test_format",
                    "text"
                )

                val formatted = format_comparison_result(result)

                expect(formatted).to_contain("Snapshot mismatch")
                expect(formatted).to_contain("Summary")
                expect(formatted).to_contain("--snapshot-update")

            it("includes update command in mismatch"):
                val result = compare_snapshots(
                    "old",
                    "new",
                    "test_update_cmd",
                    "text"
                )

                val formatted = format_comparison_result(result)

                expect(formatted).to_contain("simple test --snapshot-update=test_update_cmd")

        context("Diff Statistics"):
            it("counts added lines"):
                val result = compare_snapshots(
                    "line1",
                    "line1\nline2",
                    "test_stats_added",
                    "text"
                )

                match result:
                    ComparisonResult.Mismatch(_, context) ->
                        expect(context.added_lines).to_be_gt(0)
                    _ ->
                        fail("Expected mismatch")

            it("counts removed lines"):
                val result = compare_snapshots(
                    "line1\nline2",
                    "line1",
                    "test_stats_removed",
                    "text"
                )

                match result:
                    ComparisonResult.Mismatch(_, context) ->
                        expect(context.removed_lines).to_be_gt(0)
                    _ ->
                        fail("Expected mismatch")

            it("counts changed lines"):
                val result = compare_snapshots(
                    "old line",
                    "new line",
                    "test_stats_changed",
                    "text"
                )

                match result:
                    ComparisonResult.Mismatch(_, context) ->
                        val summary = context.summary()
                        expect(summary).to_contain("+")
                        expect(summary).to_contain("-")
                    _ ->
                        fail("Expected mismatch")
