# Snapshot Testing Framework - Basic Tests
# Tests for core snapshot functionality

module tests.snapshot.basic_spec:
    use std.spec.{describe, context, it, expect}
    use std.spec.snapshot.{expect_snapshot, expect_snapshot_named, SnapshotConfig}
    use std.spec.snapshot.{SnapshotTestResult}
    use std.spec.snapshot.storage.{SnapshotFile, load_snapshot, save_snapshot, snapshot_exists}

    describe("Snapshot Testing Framework"):
        context("Basic Snapshot Creation"):
            it("creates snapshot file with metadata"):
                val snapshot = SnapshotFile.new(
                    test_file: "test/example_spec.spl",
                    test_name: "test_basic",
                    content: "Hello, World!",
                    format: "text"
                )

                expect(snapshot.test_name).to_equal("test_basic")
                expect(snapshot.content).to_equal("Hello, World!")
                expect(snapshot.format).to_equal("text")
                expect(snapshot.created_at).to_not_be_empty()

            it("generates correct snapshot file path"):
                val snapshot = SnapshotFile.new(
                    test_file: "test/user_service_spec.spl",
                    test_name: "test_render_user",
                    content: "",
                    format: "json"
                )

                val path = snapshot.get_path(".snapshots")
                expect(path).to_equal(".snapshots/user_service_spec/test_render_user.snap")

            it("serializes to file format with header"):
                val snapshot = SnapshotFile.new(
                    test_file: "test/example.spl",
                    test_name: "test_example",
                    content: "test content",
                    format: "text"
                )

                val file_content = snapshot.to_file_format()

                expect(file_content).to_contain("# Snapshot: test_example")
                expect(file_content).to_contain("# Format: text")
                expect(file_content).to_contain("test content")

            it("parses from file format"):
                val file_content = """
# Snapshot: test_example
# Created: 2025-12-24 00:00:00 UTC
# Updated: 2025-12-24 00:00:00 UTC
# Format: json

{"key": "value"}
"""
                val result = SnapshotFile.from_file_format(
                    file_content,
                    "test/example.spl",
                    "test_example"
                )

                expect(result.is_ok()).to_be_true()
                val snapshot = result.unwrap()
                expect(snapshot.content).to_equal('{"key": "value"}')
                expect(snapshot.format).to_equal("json")

        context("Snapshot Storage"):
            it("checks if snapshot exists"):
                # Assuming no snapshot exists initially
                val exists = snapshot_exists(
                    "test/nonexistent.spl",
                    "test_missing",
                    ".snapshots"
                )
                expect(exists).to_be_false()

            it("saves and loads snapshot"):
                val snapshot = SnapshotFile.new(
                    test_file: "test/temp_test.spl",
                    test_name: "test_save_load",
                    content: "test data",
                    format: "text"
                )

                # Save
                val save_result = save_snapshot(snapshot, ".snapshots_test")
                expect(save_result.is_ok()).to_be_true()

                # Load
                val load_result = load_snapshot(
                    "test/temp_test.spl",
                    "test_save_load",
                    ".snapshots_test"
                )
                expect(load_result.is_ok()).to_be_true()

                val loaded = load_result.unwrap()
                expect(loaded.content).to_equal("test data")

        context("Snapshot Configuration"):
            it("creates default configuration"):
                val config = SnapshotConfig.default()

                expect(config.format).to_equal("text")
                expect(config.normalize).to_be_false()
                expect(config.update_snapshots).to_be_false()
                expect(config.snapshot_dir).to_equal(".snapshots")

            it("uses builder pattern for configuration"):
                val config = SnapshotConfig.default()
                    .with_name("custom_name")
                    .with_format("json")
                    .with_normalization()

                expect(config.name).to_equal(Some("custom_name"))
                expect(config.format).to_equal("json")
                expect(config.normalize).to_be_true()
                expect(config.normalize_ids).to_be_true()
                expect(config.normalize_timestamps).to_be_true()

            it("respects CI environment"):
                env.set("CI", "true")
                val config = from_env()
                expect(config.update_snapshots).to_be_false()
                env.unset("CI")

            it("respects update environment variable"):
                env.set("SIMPLE_UPDATE_SNAPSHOTS", "1")
                val config = from_env()
                expect(config.update_snapshots).to_be_true()
                env.unset("SIMPLE_UPDATE_SNAPSHOTS")

        context("expect_snapshot Function"):
            it("fails when snapshot doesn't exist (no update mode)"):
                val config = SnapshotConfig.default()
                val result = expect_snapshot("test output", config)

                expect(result.is_fail()).to_be_true()

            it("creates snapshot on first run (update mode)"):
                val config = SnapshotConfig.default()
                    .with_name("test_first_run")
                    .with_update()

                val result = expect_snapshot("test output", config)

                match result:
                    SnapshotTestResult.Created(name) ->
                        expect(name).to_equal("test_first_run")
                    _ ->
                        fail("Expected Created result")

            it("passes when snapshot matches"):
                # Assuming snapshot exists and matches
                val config = SnapshotConfig.default()
                    .with_name("test_matching")

                # First create the snapshot
                save_snapshot(
                    SnapshotFile.new(
                        "test/current.spl",
                        "test_matching",
                        "expected output",
                        "text"
                    ),
                    ".snapshots"
                )

                # Now test it matches
                val result = expect_snapshot("expected output", config)
                expect(result.is_pass()).to_be_true()

            it("fails when snapshot doesn't match"):
                # Create snapshot with one value
                save_snapshot(
                    SnapshotFile.new(
                        "test/current.spl",
                        "test_mismatch",
                        "expected output",
                        "text"
                    ),
                    ".snapshots"
                )

                val config = SnapshotConfig.default()
                    .with_name("test_mismatch")

                # Test with different value
                val result = expect_snapshot("different output", config)

                match result:
                    SnapshotTestResult.Fail(name, diff) ->
                        expect(name).to_equal("test_mismatch")
                        expect(diff).to_contain("Snapshot mismatch")
                    _ ->
                        fail("Expected Fail result")

            it("updates snapshot in update mode"):
                # Create initial snapshot
                save_snapshot(
                    SnapshotFile.new(
                        "test/current.spl",
                        "test_update",
                        "old output",
                        "text"
                    ),
                    ".snapshots"
                )

                val config = SnapshotConfig.default()
                    .with_name("test_update")
                    .with_update()

                # Update with new value
                val result = expect_snapshot("new output", config)

                match result:
                    SnapshotTestResult.Updated(name) ->
                        expect(name).to_equal("test_update")
                    _ ->
                        fail("Expected Updated result")
