# Snapshot Testing Framework - Runner Tests
# Tests for snapshot test execution

module tests.snapshot.runner_spec:
    use std.spec.{describe, context, it, expect}
    use std.spec.snapshot.{expect_snapshot, expect_snapshot_json, expect_snapshot_yaml}
    use std.spec.snapshot.{SnapshotConfig, SnapshotTestResult}
    use std.spec.snapshot.runner.{run_snapshot_tests, SnapshotSummary}

    describe("Snapshot Test Runner"):
        context("Test Execution"):
            it("returns Pass for matching snapshot"):
                # Pre-create snapshot
                save_test_snapshot("test_pass", "expected output")

                val config = SnapshotConfig.default()
                    .with_name("test_pass")

                val result = expect_snapshot("expected output", config)

                expect(result.is_pass()).to_be_true()

            it("returns Fail for mismatching snapshot"):
                # Pre-create snapshot
                save_test_snapshot("test_fail", "expected output")

                val config = SnapshotConfig.default()
                    .with_name("test_fail")

                val result = expect_snapshot("different output", config)

                expect(result.is_fail()).to_be_true()

            it("returns Created when creating new snapshot"):
                val config = SnapshotConfig.default()
                    .with_name("test_create_new")
                    .with_update()

                val result = expect_snapshot("new output", config)

                match result:
                    SnapshotTestResult.Created(name) ->
                        expect(name).to_equal("test_create_new")
                    _ ->
                        fail("Expected Created result")

            it("returns Updated when updating existing snapshot"):
                # Pre-create snapshot
                save_test_snapshot("test_update_existing", "old output")

                val config = SnapshotConfig.default()
                    .with_name("test_update_existing")
                    .with_update()

                val result = expect_snapshot("new output", config)

                match result:
                    SnapshotTestResult.Updated(name) ->
                        expect(name).to_equal("test_update_existing")
                    _ ->
                        fail("Expected Updated result")

        context("Convenience Functions"):
            it("uses expect_snapshot_json for JSON format"):
                val config = SnapshotConfig.default()
                    .with_name("test_json")
                    .with_update()

                val data = {"name": "Alice", "age": 30}
                val result = expect_snapshot_json(data)

                # Should serialize to JSON
                match result:
                    SnapshotTestResult.Created(_) | SnapshotTestResult.Updated(_) ->
                        pass  # Success
                    _ ->
                        fail("Expected snapshot to be created/updated")

            it("uses expect_snapshot_yaml for YAML format"):
                val config = SnapshotConfig.default()
                    .with_name("test_yaml")
                    .with_update()

                val data = {"name": "Bob", "age": 25}
                val result = expect_snapshot_yaml(data)

                # Should serialize to YAML
                match result:
                    SnapshotTestResult.Created(_) | SnapshotTestResult.Updated(_) ->
                        pass
                    _ ->
                        fail("Expected snapshot to be created/updated")

        context("Batch Test Execution"):
            it("runs multiple snapshot tests"):
                val tests = [
                    || {
                        val config = SnapshotConfig.default()
                            .with_name("batch_test_1")
                            .with_update()
                        return expect_snapshot("output1", config)
                    },
                    || {
                        val config = SnapshotConfig.default()
                            .with_name("batch_test_2")
                            .with_update()
                        return expect_snapshot("output2", config)
                    }
                ]

                val config = SnapshotConfig.default()
                val summary = run_snapshot_tests(tests, config)

                expect(summary.passed + summary.created + summary.updated).to_equal(2)

            it("tracks failures in batch run"):
                # Create snapshot that will mismatch
                save_test_snapshot("batch_fail", "expected")

                val tests = [
                    || {
                        val config = SnapshotConfig.default()
                            .with_name("batch_pass")
                            .with_update()
                        return expect_snapshot("pass", config)
                    },
                    || {
                        val config = SnapshotConfig.default()
                            .with_name("batch_fail")
                        return expect_snapshot("actual", config)  # Will fail
                    }
                ]

                val config = SnapshotConfig.default()
                val summary = run_snapshot_tests(tests, config)

                expect(summary.failed).to_be_gt(0)
                expect(summary.failures.length()).to_be_gt(0)

        context("Summary Formatting"):
            it("formats successful summary"):
                val summary = SnapshotSummary(
                    passed: 10,
                    failed: 0,
                    updated: 0,
                    created: 0,
                    failures: []
                )

                expect(summary.is_success()).to_be_true()

                val formatted = summary.format()
                expect(formatted).to_contain("✓ Passed: 10")

            it("formats summary with failures"):
                val summary = SnapshotSummary(
                    passed: 8,
                    failed: 2,
                    updated: 0,
                    created: 0,
                    failures: [
                        ("test_fail_1", "diff output 1"),
                        ("test_fail_2", "diff output 2")
                    ]
                )

                expect(summary.is_success()).to_be_false()

                val formatted = summary.format()
                expect(formatted).to_contain("✗ Failed: 2")
                expect(formatted).to_contain("test_fail_1")
                expect(formatted).to_contain("test_fail_2")

            it("formats summary with updates"):
                val summary = SnapshotSummary(
                    passed: 5,
                    failed: 0,
                    updated: 3,
                    created: 2,
                    failures: []
                )

                val formatted = summary.format()
                expect(formatted).to_contain("↻ Updated: 3")
                expect(formatted).to_contain("⊕ Created: 2")

        context("Update Modes"):
            it("fails without update flag"):
                val config = SnapshotConfig.default()
                    .with_name("test_no_update")
                    # No update flag

                val result = expect_snapshot("new output", config)

                expect(result.is_fail()).to_be_true()

            it("updates with update flag"):
                # Pre-create snapshot
                save_test_snapshot("test_with_update", "old")

                val config = SnapshotConfig.default()
                    .with_name("test_with_update")
                    .with_update()

                val result = expect_snapshot("new", config)

                match result:
                    SnapshotTestResult.Updated(_) ->
                        pass  # Success
                    _ ->
                        fail("Expected Updated result")

        context("Normalization Integration"):
            it("applies timestamp normalization"):
                val config = SnapshotConfig.default()
                    .with_name("test_normalize_time")
                    .with_normalization()
                    .with_update()

                val output = "created_at: 2025-12-24T10:30:00Z"
                val result = expect_snapshot(output, config)

                # Should normalize timestamp
                match result:
                    SnapshotTestResult.Created(_) | SnapshotTestResult.Updated(_) ->
                        # Verify normalized content was saved
                        val loaded = load_snapshot(
                            get_current_test_file(),
                            "test_normalize_time",
                            ".snapshots"
                        )
                        expect(loaded.unwrap().content).to_contain("<TIMESTAMP>")
                    _ ->
                        fail("Expected snapshot creation/update")

            it("applies custom normalizer"):
                fn custom_normalizer(content: String) -> String:
                    return content.replace("SECRET", "<REDACTED>")

                val config = SnapshotConfig.default()
                    .with_name("test_custom_normalizer")
                    .with_normalizer(custom_normalizer)
                    .with_update()

                val output = "api_key: SECRET123"
                val result = expect_snapshot(output, config)

                # Should apply custom normalizer
                match result:
                    SnapshotTestResult.Created(_) | SnapshotTestResult.Updated(_) ->
                        val loaded = load_snapshot(
                            get_current_test_file(),
                            "test_custom_normalizer",
                            ".snapshots"
                        )
                        expect(loaded.unwrap().content).to_contain("<REDACTED>")
                    _ ->
                        fail("Expected snapshot creation/update")

    # Helper function to create test snapshots
    fn save_test_snapshot(name: String, content: String):
        val snapshot = SnapshotFile.new(
            get_current_test_file(),
            name,
            content,
            "text"
        )
        save_snapshot(snapshot, ".snapshots")
