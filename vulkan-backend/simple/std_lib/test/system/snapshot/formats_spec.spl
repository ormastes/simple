# Snapshot Testing Framework - Format Tests
# Tests for multi-format snapshot support

module tests.snapshot.formats_spec:
    use std.spec.{describe, context, it, expect}
    use std.spec.snapshot.formats.{get_formatter, apply_normalizations}
    use std.spec.snapshot.formats.{TextFormatter, JsonFormatter, YamlFormatter, HtmlFormatter, Base64Formatter}

    describe("Snapshot Formats"):
        context("Text Formatter"):
            it("serializes values to string"):
                val formatter = TextFormatter()
                val result = formatter.serialize("Hello, World!")

                expect(result.is_ok()).to_be_true()
                expect(result.unwrap()).to_equal("Hello, World!")

            it("normalizes line endings"):
                val formatter = TextFormatter()
                val content = "line1\r\nline2\r\nline3"
                val normalized = formatter.normalize(content)

                expect(normalized).to_equal("line1\nline2\nline3")

            it("trims trailing whitespace"):
                val formatter = TextFormatter()
                val content = "line1   \nline2  \nline3 "
                val normalized = formatter.normalize(content)

                expect(normalized).to_not_contain("   ")

        context("JSON Formatter"):
            it("serializes to pretty JSON"):
                val formatter = JsonFormatter.new()
                val value = {"name": "Alice", "age": 30}
                val result = formatter.serialize(value)

                expect(result.is_ok()).to_be_true()
                val json = result.unwrap()
                expect(json).to_contain("name")
                expect(json).to_contain("Alice")

            it("serializes to compact JSON"):
                val formatter = JsonFormatter.compact()
                val value = {"name": "Alice", "age": 30}
                val result = formatter.serialize(value)

                expect(result.is_ok()).to_be_true()
                val json = result.unwrap()
                expect(json).to_not_contain("\n")

            it("normalizes JSON formatting"):
                val formatter = JsonFormatter.new()
                val unnormalized = '{"name":"Alice","age":30}'
                val normalized = formatter.normalize(unnormalized)

                # Should be pretty-printed
                expect(normalized).to_contain("\n")

        context("YAML Formatter"):
            it("serializes to YAML"):
                val formatter = YamlFormatter()
                val value = {"name": "Alice", "age": 30}
                val result = formatter.serialize(value)

                expect(result.is_ok()).to_be_true()
                val yaml = result.unwrap()
                expect(yaml).to_contain("name: Alice")

            it("normalizes YAML formatting"):
                val formatter = YamlFormatter()
                val unnormalized = "name:Alice\nage:30"
                val normalized = formatter.normalize(unnormalized)

                # Should have proper spacing
                expect(normalized).to_contain("name: Alice")

        context("HTML Formatter"):
            it("prettifies HTML"):
                val formatter = HtmlFormatter.new()
                val html = "<div><span>Hello</span></div>"
                val result = formatter.serialize(html)

                expect(result.is_ok()).to_be_true()
                val pretty = result.unwrap()
                # Should be indented
                expect(pretty).to_contain("\n")

            it("normalizes whitespace in HTML"):
                val formatter = HtmlFormatter.new()
                val html = "<div>\r\n\t<span>Hello</span>\r\n</div>"
                val normalized = formatter.normalize(html)

                expect(normalized).to_not_contain("\r")
                expect(normalized).to_not_contain("\t")

        context("Base64 Formatter"):
            it("encodes binary data"):
                val formatter = Base64Formatter()
                val data = [72, 101, 108, 108, 111]  # "Hello" in ASCII
                val result = formatter.serialize(data)

                expect(result.is_ok()).to_be_true()
                val encoded = result.unwrap()
                expect(encoded).to_be_instance_of(String)

            it("decodes Base64 strings"):
                val formatter = Base64Formatter()
                val encoded = "SGVsbG8="  # "Hello" in Base64
                val result = formatter.deserialize(encoded)

                expect(result.is_ok()).to_be_true()

        context("Format Selection"):
            it("gets formatter by name - text"):
                val formatter = get_formatter("text")
                expect(formatter).to_be_instance_of(TextFormatter)

            it("gets formatter by name - json"):
                val formatter = get_formatter("json")
                expect(formatter).to_be_instance_of(JsonFormatter)

            it("gets formatter by name - yaml"):
                val formatter = get_formatter("yaml")
                expect(formatter).to_be_instance_of(YamlFormatter)

            it("gets formatter by name - html"):
                val formatter = get_formatter("html")
                expect(formatter).to_be_instance_of(HtmlFormatter)

            it("defaults to text for unknown format"):
                val formatter = get_formatter("unknown")
                expect(formatter).to_be_instance_of(TextFormatter)

        context("Normalization"):
            it("normalizes ISO timestamps"):
                val content = "created_at: 2025-12-24T10:30:00Z"
                val normalized = apply_normalizations(
                    content,
                    normalize_timestamps: true,
                    normalize_ids: false
                )

                expect(normalized).to_contain("<TIMESTAMP>")
                expect(normalized).to_not_contain("2025-12-24")

            it("normalizes Unix timestamps"):
                val content = "timestamp: 1703419800"
                val normalized = apply_normalizations(
                    content,
                    normalize_timestamps: true,
                    normalize_ids: false
                )

                expect(normalized).to_contain("<TIMESTAMP>")

            it("normalizes UUIDs"):
                val content = "id: 550e8400-e29b-41d4-a716-446655440000"
                val normalized = apply_normalizations(
                    content,
                    normalize_timestamps: false,
                    normalize_ids: true
                )

                expect(normalized).to_contain("<UUID>")
                expect(normalized).to_not_contain("550e8400")

            it("normalizes sequential IDs"):
                val content = '"id": 12345'
                val normalized = apply_normalizations(
                    content,
                    normalize_timestamps: false,
                    normalize_ids: true
                )

                expect(normalized).to_contain("<ID-")

            it("applies multiple normalizations"):
                val content = """
                {
                  "id": 42,
                  "uuid": "550e8400-e29b-41d4-a716-446655440000",
                  "created_at": "2025-12-24T10:30:00Z"
                }
                """
                val normalized = apply_normalizations(
                    content,
                    normalize_timestamps: true,
                    normalize_ids: true
                )

                expect(normalized).to_contain("<ID-")
                expect(normalized).to_contain("<UUID>")
                expect(normalized).to_contain("<TIMESTAMP>")
