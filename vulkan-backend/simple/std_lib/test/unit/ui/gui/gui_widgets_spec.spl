# GUI Widgets Tests
#
# Tests for graphical UI widgets: Card, Chip, Avatar, Badge, Tooltip, Divider

use spec.*
use ui.element.*
use ui.gui.widgets.*
use ui.gui.theme.*

# Helper struct for allocating node IDs
struct IdAllocator:
    counter: u64

impl IdAllocator:
    pub fn new() -> IdAllocator:
        return IdAllocator { counter: 0 }

    pub fn alloc(self) -> NodeId:
        self.counter = self.counter + 1
        return NodeId::new(self.counter)

    pub fn count(self) -> u64:
        return self.counter

describe "Card":
    describe "new()":
        it "creates card with default settings":
            val card = Card::new(NodeId::new(1))
            expect(card.elevation).to_equal(1)
            expect(card.padding).to_equal(16)
            expect(card.title).to_be_none()

    describe "with_title()":
        it "sets card title":
            val card = Card::new(NodeId::new(1))
                .with_title("Settings")
            expect(card.title).to_be_some()

    describe "with_elevation()":
        it "sets elevation level capped at 5":
            val card = Card::new(NodeId::new(1))
                .with_elevation(3)
            expect(card.elevation).to_equal(3)

        it "caps elevation at maximum":
            val card = Card::new(NodeId::new(1))
                .with_elevation(10)
            expect(card.elevation).to_equal(5)

    describe "with_padding()":
        it "sets custom padding":
            val card = Card::new(NodeId::new(1))
                .with_padding(24)
            expect(card.padding).to_equal(24)

    describe "to_element()":
        it "converts to Element with proper structure":
            val alloc = IdAllocator::new()
            val theme = Theme::light()
            val card = Card::new(NodeId::new(1))
                .with_title("Test Card")

            val elem = card.to_element(|| alloc.alloc(), &theme)
            expect(elem.classes).to_contain("card")

describe "Chip":
    describe "new()":
        it "creates chip with label":
            val chip = Chip::new(NodeId::new(1), "Tag")
            expect(chip.label).to_equal("Tag")
            expect(chip.deletable).to_be_false()
            expect(chip.selected).to_be_false()

    describe "with_icon()":
        it "adds icon to chip":
            val chip = Chip::new(NodeId::new(1), "Tag")
                .with_icon("star")
            expect(chip.icon).to_be_some()

    describe "deletable()":
        it "makes chip deletable":
            val chip = Chip::new(NodeId::new(1), "Tag")
                .deletable()
            expect(chip.deletable).to_be_true()

    describe "selected()":
        it "marks chip as selected":
            val chip = Chip::new(NodeId::new(1), "Tag")
                .selected()
            expect(chip.selected).to_be_true()

    describe "outlined()":
        it "changes chip variant to outlined":
            val chip = Chip::new(NodeId::new(1), "Tag")
                .outlined()
            expect(chip.variant).to_equal(ChipVariant::Outlined)

    describe "to_element()":
        it "renders with proper classes":
            val alloc = IdAllocator::new()
            val theme = Theme::light()
            val chip = Chip::new(NodeId::new(1), "Tag")

            val elem = chip.to_element(|| alloc.alloc(), &theme)
            expect(elem.classes).to_contain("chip")

describe "Avatar":
    describe "new()":
        it "creates avatar with alt text":
            val avatar = Avatar::new(NodeId::new(1), "John Doe")
            expect(avatar.alt).to_equal("John Doe")
            expect(avatar.size).to_equal(AvatarSize::Medium)

    describe "with_src()":
        it "sets image source":
            val avatar = Avatar::new(NodeId::new(1), "User")
                .with_src("https://example.com/avatar.png")
            expect(avatar.src).to_be_some()

    describe "with_initials()":
        it "sets initials fallback":
            val avatar = Avatar::new(NodeId::new(1), "John Doe")
                .with_initials("JD")
            expect(avatar.initials).to_be_some()

    describe "size modifiers":
        it "small() sets 32px size":
            val avatar = Avatar::new(NodeId::new(1), "User")
                .small()
            expect(avatar.size).to_equal(AvatarSize::Small)

        it "large() sets 56px size":
            val avatar = Avatar::new(NodeId::new(1), "User")
                .large()
            expect(avatar.size).to_equal(AvatarSize::Large)

    describe "to_element()":
        it "renders circular avatar":
            val alloc = IdAllocator::new()
            val theme = Theme::light()
            val avatar = Avatar::new(NodeId::new(1), "User")

            val elem = avatar.to_element(|| alloc.alloc(), &theme)
            expect(elem.classes).to_contain("avatar")

describe "Badge":
    describe "new()":
        it "creates badge with content":
            val badge = Badge::new(NodeId::new(1), "New")
            expect(badge.content).to_equal("New")

    describe "count()":
        it "creates numeric badge":
            val badge = Badge::count(NodeId::new(1), 42)
            expect(badge.content).to_equal("42")

    describe "with_max()":
        it "caps displayed count":
            val badge = Badge::count(NodeId::new(1), 150)
                .with_max(99)
            expect(badge.content).to_equal("99+")

        it "shows actual count if under max":
            val badge = Badge::count(NodeId::new(1), 50)
                .with_max(99)
            expect(badge.content).to_equal("50")

    describe "variant modifiers":
        it "primary() sets primary variant":
            val badge = Badge::new(NodeId::new(1), "!").primary()
            expect(badge.variant).to_equal(BadgeVariant::Primary)

        it "error() sets error variant":
            val badge = Badge::new(NodeId::new(1), "!").error()
            expect(badge.variant).to_equal(BadgeVariant::Error)

        it "success() sets success variant":
            val badge = Badge::new(NodeId::new(1), "!").success()
            expect(badge.variant).to_equal(BadgeVariant::Success)

    describe "to_element()":
        it "renders badge with styles":
            val alloc = IdAllocator::new()
            val theme = Theme::light()
            val badge = Badge::count(NodeId::new(1), 5)

            val elem = badge.to_element(|| alloc.alloc(), &theme)
            expect(elem.classes).to_contain("badge")

describe "Tooltip":
    describe "new()":
        it "creates tooltip with content":
            val tooltip = Tooltip::new(NodeId::new(1), "Help text")
            expect(tooltip.content).to_equal("Help text")
            expect(tooltip.position).to_equal(TooltipPosition::Top)

    describe "position modifiers":
        it "bottom() sets position":
            val tooltip = Tooltip::new(NodeId::new(1), "Help")
                .bottom()
            expect(tooltip.position).to_equal(TooltipPosition::Bottom)

        it "left() sets position":
            val tooltip = Tooltip::new(NodeId::new(1), "Help")
                .left()
            expect(tooltip.position).to_equal(TooltipPosition::Left)

        it "right() sets position":
            val tooltip = Tooltip::new(NodeId::new(1), "Help")
                .right()
            expect(tooltip.position).to_equal(TooltipPosition::Right)

    describe "to_element()":
        it "renders tooltip with data attributes":
            val alloc = IdAllocator::new()
            val theme = Theme::light()
            val tooltip = Tooltip::new(NodeId::new(1), "Help")

            val elem = tooltip.to_element(|| alloc.alloc(), &theme)
            expect(elem.classes).to_contain("tooltip")

describe "Divider":
    describe "horizontal()":
        it "creates horizontal divider":
            val divider = Divider::horizontal(NodeId::new(1))
            expect(divider.orientation).to_equal(DividerOrientation::Horizontal)

    describe "vertical()":
        it "creates vertical divider":
            val divider = Divider::vertical(NodeId::new(1))
            expect(divider.orientation).to_equal(DividerOrientation::Vertical)

    describe "variant modifiers":
        it "inset() creates inset divider":
            val divider = Divider::horizontal(NodeId::new(1))
                .inset()
            expect(divider.variant).to_equal(DividerVariant::Inset)

        it "middle() creates middle divider":
            val divider = Divider::horizontal(NodeId::new(1))
                .middle()
            expect(divider.variant).to_equal(DividerVariant::Middle)

    describe "to_element()":
        it "renders divider with correct dimensions":
            val theme = Theme::light()
            val divider = Divider::horizontal(NodeId::new(1))

            val elem = divider.to_element(&theme)
            expect(elem.classes).to_contain("divider")
