# GUI HTML Renderer Tests
#
# Tests for HTML/CSS generation and hydration manifest

use spec.*
use ui.element.*
use ui.gui.html.*

describe "HtmlRenderer":
    describe "new()":
        it "creates renderer with empty state":
            val renderer = HtmlRenderer::new()
            expect(renderer.html()).to_equal("")
            expect(renderer.css()).to_equal("")

    describe "minified()":
        it "enables minified output mode":
            val renderer = HtmlRenderer::new().minified()
            expect(renderer.minify).to_be_true()

    describe "render_element":
        it "renders basic div element":
            var renderer = HtmlRenderer::new()
            val elem = Element::new(NodeId::new(1), ElementKind::Div)
                .with_class("container")

            val tree = ElementTree::new(elem)
            renderer.render_tree(&tree)

            val html = renderer.html()
            expect(html).to_contain("<div")
            expect(html).to_contain("class=\"container\"")
            expect(html).to_contain("</div>")

        it "renders text content with escaping":
            var renderer = HtmlRenderer::new()
            val elem = Element::new(NodeId::new(1), ElementKind::Span)
                .with_text("<script>alert('xss')</script>")

            val tree = ElementTree::new(elem)
            renderer.render_tree(&tree)

            val html = renderer.html()
            expect(html).to_contain("&lt;script&gt;")
            expect(html).not.to_contain("<script>")

        it "renders nested elements":
            var renderer = HtmlRenderer::new()
            val parent = Element::new(NodeId::new(1), ElementKind::Div)
            val child = Element::new(NodeId::new(2), ElementKind::Span)
                .with_text("Hello")

            val tree = ElementTree::new(parent.with_child(child))
            renderer.render_tree(&tree)

            val html = renderer.html()
            expect(html).to_contain("<div")
            expect(html).to_contain("<span")
            expect(html).to_contain("Hello")
            expect(html).to_contain("</span>")
            expect(html).to_contain("</div>")

    describe "render_document":
        it "generates complete HTML document":
            var renderer = HtmlRenderer::new()
            val elem = Element::new(NodeId::new(1), ElementKind::Div)

            val tree = ElementTree::new(elem)
            val doc = renderer.render_document(&tree, "Test Page")

            expect(doc).to_contain("<!DOCTYPE html>")
            expect(doc).to_contain("<html>")
            expect(doc).to_contain("<head>")
            expect(doc).to_contain("<title>Test Page</title>")
            expect(doc).to_contain("<body>")
            expect(doc).to_contain("</html>")

        it "includes base CSS styles":
            var renderer = HtmlRenderer::new()
            val elem = Element::new(NodeId::new(1), ElementKind::Div)
            val tree = ElementTree::new(elem)
            val doc = renderer.render_document(&tree, "Test")

            expect(doc).to_contain("<style>")
            expect(doc).to_contain("box-sizing: border-box")

        it "includes event handler JavaScript":
            var renderer = HtmlRenderer::new()
            val elem = Element::new(NodeId::new(1), ElementKind::Div)
            val tree = ElementTree::new(elem)
            val doc = renderer.render_document(&tree, "Test")

            expect(doc).to_contain("<script>")
            expect(doc).to_contain("suiEvent")

    describe "escape_html":
        it "escapes all HTML special characters":
            val renderer = HtmlRenderer::new()
            val escaped = renderer.escape_html("<div class=\"test\">Tom & Jerry's</div>")
            expect(escaped).to_contain("&lt;")
            expect(escaped).to_contain("&gt;")
            expect(escaped).to_contain("&quot;")
            expect(escaped).to_contain("&amp;")
            expect(escaped).to_contain("&#39;")

    describe "is_void_element":
        it "identifies void elements correctly":
            val renderer = HtmlRenderer::new()
            expect(renderer.is_void_element("br")).to_be_true()
            expect(renderer.is_void_element("img")).to_be_true()
            expect(renderer.is_void_element("input")).to_be_true()
            expect(renderer.is_void_element("div")).to_be_false()
            expect(renderer.is_void_element("span")).to_be_false()

describe "HydrationManifest":
    describe "new()":
        it "creates empty manifest":
            val manifest = HydrationManifest::new()
            expect(manifest.version).to_equal(1)

    describe "add_node":
        it "adds node to manifest":
            var manifest = HydrationManifest::new()
            manifest.add_node(NodeId::new(42), "#sui-42")
            expect(manifest.node_map.len()).to_equal(1)

    describe "add_event":
        it "adds event binding":
            var manifest = HydrationManifest::new()
            manifest.add_event(NodeId::new(1), "click", 100)
            expect(manifest.event_bindings.len()).to_equal(1)

    describe "set_state":
        it "stores initial state":
            var manifest = HydrationManifest::new()
            manifest.set_state("counter", "0")
            manifest.set_state("name", "Test")
            expect(manifest.initial_state.len()).to_equal(2)

    describe "to_json":
        it "generates valid JSON structure":
            var manifest = HydrationManifest::new()
            manifest.add_node(NodeId::new(1), "#sui-1")
            manifest.add_event(NodeId::new(1), "click", 100)
            manifest.set_state("count", "0")

            val json = manifest.to_json()
            expect(json).to_contain("\"version\"")
            expect(json).to_contain("\"nodes\"")
            expect(json).to_contain("\"events\"")
            expect(json).to_contain("\"state\"")

describe "patches_to_js":
    it "generates JavaScript for SetText patch":
        var patches = PatchSet::new()
        patches.set_text(NodeId::new(1), "Hello")

        var dom_ids = Dict::new()
        dom_ids.set(1, "sui-1".to_string())

        val js = patches_to_js(&patches, &dom_ids)
        expect(js).to_contain("document.getElementById")
        expect(js).to_contain("textContent")
        expect(js).to_contain("Hello")

    it "generates JavaScript for SetAttr patch":
        var patches = PatchSet::new()
        patches.set_attr(NodeId::new(2), "class", "active")

        var dom_ids = Dict::new()
        dom_ids.set(2, "sui-2".to_string())

        val js = patches_to_js(&patches, &dom_ids)
        expect(js).to_contain("setAttribute")
        expect(js).to_contain("class")
        expect(js).to_contain("active")

describe "escape_js_string":
    it "escapes quotes and backslashes":
        val escaped = escape_js_string("He said \"Hello\"")
        expect(escaped).to_contain("\\\"")

    it "escapes newlines":
        val escaped = escape_js_string("Line1\nLine2")
        expect(escaped).to_contain("\\n")
