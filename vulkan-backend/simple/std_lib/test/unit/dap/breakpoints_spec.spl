# Unit tests for DAP breakpoint management

import spec.{describe, it, expect}
import dap.breakpoints as breakpoints
import dap.protocol as protocol

describe("BreakpointEntry"):
    it("creates breakpoint entry"):
        val bp = breakpoints.BreakpointEntry.new(1, "test.spl", 10)

        expect(bp.id).to_equal(1)
        expect(bp.source_path).to_equal("test.spl")
        expect(bp.line).to_equal(10)
        expect(bp.verified).to_be(true)
        expect(bp.hit_count).to_equal(0)

    it("adds condition to breakpoint"):
        val bp = breakpoints.BreakpointEntry.new(1, "test.spl", 10)
            .with_condition("x > 0")

        expect(bp.condition.is_some()).to_be(true)
        match bp.condition:
            case Some(cond):
                expect(cond).to_equal("x > 0")
            case None:
                fail("Expected condition")

    it("converts to protocol breakpoint"):
        val bp = breakpoints.BreakpointEntry.new(5, "main.spl", 42)
        val proto_bp = bp.to_protocol_breakpoint()

        expect(proto_bp.id).to_equal(5)
        expect(proto_bp.verified).to_be(true)
        expect(proto_bp.line.unwrap()).to_equal(42)

describe("BreakpointManager"):
    it("creates breakpoint manager"):
        val manager = breakpoints.BreakpointManager.new()

        expect(manager.next_id).to_equal(1)
        expect(manager.count()).to_equal(0)

    it("sets breakpoints for source file"):
        var manager = breakpoints.BreakpointManager.new()

        val source_bps = [
            protocol.SourceBreakpoint.new(10),
            protocol.SourceBreakpoint.new(20),
            protocol.SourceBreakpoint.new(30)
        ]

        val entries = manager.set_breakpoints("test.spl", source_bps)

        expect(entries.len()).to_equal(3)
        expect(manager.count()).to_equal(3)
        expect(entries[0].line).to_equal(10)
        expect(entries[1].line).to_equal(20)
        expect(entries[2].line).to_equal(30)

    it("assigns unique IDs to breakpoints"):
        var manager = breakpoints.BreakpointManager.new()

        val source_bps = [
            protocol.SourceBreakpoint.new(10),
            protocol.SourceBreakpoint.new(20)
        ]

        val entries = manager.set_breakpoints("test.spl", source_bps)

        expect(entries[0].id).to_equal(1)
        expect(entries[1].id).to_equal(2)
        expect(manager.next_id).to_equal(3)

    it("preserves conditions from source breakpoints"):
        var manager = breakpoints.BreakpointManager.new()

        val source_bps = [
            protocol.SourceBreakpoint.new(10).with_condition("x > 5")
        ]

        val entries = manager.set_breakpoints("test.spl", source_bps)

        expect(entries[0].condition.is_some()).to_be(true)
        expect(entries[0].condition.unwrap()).to_equal("x > 5")

    it("replaces existing breakpoints"):
        var manager = breakpoints.BreakpointManager.new()

        # Set initial breakpoints
        val initial_bps = [
            protocol.SourceBreakpoint.new(10),
            protocol.SourceBreakpoint.new(20)
        ]
        manager.set_breakpoints("test.spl", initial_bps)
        expect(manager.count()).to_equal(2)

        # Replace with new breakpoints
        val new_bps = [
            protocol.SourceBreakpoint.new(30)
        ]
        manager.set_breakpoints("test.spl", new_bps)

        expect(manager.count()).to_equal(1)
        val bps = manager.get_breakpoints("test.spl")
        expect(bps[0].line).to_equal(30)

    it("manages breakpoints for multiple files"):
        var manager = breakpoints.BreakpointManager.new()

        manager.set_breakpoints("file1.spl", [
            protocol.SourceBreakpoint.new(10)
        ])
        manager.set_breakpoints("file2.spl", [
            protocol.SourceBreakpoint.new(20),
            protocol.SourceBreakpoint.new(30)
        ])

        expect(manager.count()).to_equal(3)
        expect(manager.get_breakpoints("file1.spl").len()).to_equal(1)
        expect(manager.get_breakpoints("file2.spl").len()).to_equal(2)

    it("clears breakpoints for source file"):
        var manager = breakpoints.BreakpointManager.new()

        manager.set_breakpoints("test.spl", [
            protocol.SourceBreakpoint.new(10),
            protocol.SourceBreakpoint.new(20)
        ])
        expect(manager.count()).to_equal(2)

        manager.clear_breakpoints("test.spl")

        expect(manager.count()).to_equal(0)
        expect(manager.get_breakpoints("test.spl").len()).to_equal(0)

    it("returns empty list for file with no breakpoints"):
        val manager = breakpoints.BreakpointManager.new()

        val bps = manager.get_breakpoints("nonexistent.spl")

        expect(bps.len()).to_equal(0)

    it("checks if should stop at line"):
        var manager = breakpoints.BreakpointManager.new()

        manager.set_breakpoints("test.spl", [
            protocol.SourceBreakpoint.new(10),
            protocol.SourceBreakpoint.new(20)
        ])

        # Should stop at breakpoint line
        val bp = manager.should_stop_at_line("test.spl", 10)
        expect(bp.is_some()).to_be(true)

        # Should not stop at non-breakpoint line
        val no_bp = manager.should_stop_at_line("test.spl", 15)
        expect(no_bp.is_none()).to_be(true)

    it("returns correct breakpoint when checking stop"):
        var manager = breakpoints.BreakpointManager.new()

        val entries = manager.set_breakpoints("test.spl", [
            protocol.SourceBreakpoint.new(10).with_condition("x > 0"),
            protocol.SourceBreakpoint.new(20)
        ])

        val bp = manager.should_stop_at_line("test.spl", 10).unwrap()

        expect(bp.line).to_equal(10)
        expect(bp.condition.is_some()).to_be(true)

    it("increments hit count for breakpoint"):
        var manager = breakpoints.BreakpointManager.new()

        val entries = manager.set_breakpoints("test.spl", [
            protocol.SourceBreakpoint.new(10)
        ])
        val bp_id = entries[0].id

        expect(entries[0].hit_count).to_equal(0)

        manager.increment_hit_count(bp_id)

        val bps = manager.get_breakpoints("test.spl")
        expect(bps[0].hit_count).to_equal(1)

    it("increments hit count multiple times"):
        var manager = breakpoints.BreakpointManager.new()

        val entries = manager.set_breakpoints("test.spl", [
            protocol.SourceBreakpoint.new(10)
        ])
        val bp_id = entries[0].id

        manager.increment_hit_count(bp_id)
        manager.increment_hit_count(bp_id)
        manager.increment_hit_count(bp_id)

        val bps = manager.get_breakpoints("test.spl")
        expect(bps[0].hit_count).to_equal(3)

    it("counts total breakpoints"):
        var manager = breakpoints.BreakpointManager.new()

        manager.set_breakpoints("file1.spl", [
            protocol.SourceBreakpoint.new(10),
            protocol.SourceBreakpoint.new(20)
        ])
        manager.set_breakpoints("file2.spl", [
            protocol.SourceBreakpoint.new(30),
            protocol.SourceBreakpoint.new(40),
            protocol.SourceBreakpoint.new(50)
        ])

        expect(manager.count()).to_equal(5)

describe("Integration"):
    it("manages breakpoint lifecycle"):
        var manager = breakpoints.BreakpointManager.new()

        # Set initial breakpoints
        val entries1 = manager.set_breakpoints("test.spl", [
            protocol.SourceBreakpoint.new(10).with_condition("x > 0"),
            protocol.SourceBreakpoint.new(20)
        ])

        expect(manager.count()).to_equal(2)

        # Check stop at line 10
        val bp = manager.should_stop_at_line("test.spl", 10).unwrap()
        expect(bp.line).to_equal(10)

        # Increment hit count
        manager.increment_hit_count(bp.id)

        # Verify hit count increased
        val bps = manager.get_breakpoints("test.spl")
        expect(bps[0].hit_count).to_equal(1)

        # Update breakpoints (remove line 10, add line 30)
        val entries2 = manager.set_breakpoints("test.spl", [
            protocol.SourceBreakpoint.new(20),
            protocol.SourceBreakpoint.new(30)
        ])

        expect(manager.count()).to_equal(2)

        # Line 10 no longer stops
        val no_bp = manager.should_stop_at_line("test.spl", 10)
        expect(no_bp.is_none()).to_be(true)

        # Line 30 now stops
        val bp30 = manager.should_stop_at_line("test.spl", 30)
        expect(bp30.is_some()).to_be(true)

        # Clear all
        manager.clear_breakpoints("test.spl")
        expect(manager.count()).to_equal(0)
