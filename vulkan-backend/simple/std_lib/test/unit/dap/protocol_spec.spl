# Unit tests for DAP protocol types

import spec.{describe, it, expect}
import dap.protocol as protocol

describe("Source"):
    it("creates source with path"):
        val source = protocol.Source.with_path("test.spl")

        expect(source.path.is_some()).to_be(true)
        match source.path:
            case Some(path):
                expect(path).to_equal("test.spl")
            case None:
                fail("Expected path to be Some")

    it("creates source with name"):
        val source = protocol.Source.with_name("Main")

        expect(source.name.is_some()).to_be(true)

describe("Breakpoint"):
    it("creates breakpoint"):
        val bp = protocol.Breakpoint.new(1, true, 42)

        expect(bp.id).to_equal(1)
        expect(bp.verified).to_be(true)
        expect(bp.line.unwrap()).to_equal(42)

    it("creates unverified breakpoint"):
        val bp = protocol.Breakpoint.new(2, false, None)

        expect(bp.verified).to_be(false)
        expect(bp.line.is_none()).to_be(true)

    it("converts to JSON"):
        val bp = protocol.Breakpoint.new(1, true, 42)
        val json = bp.to_json()

        expect(json.get("id").unwrap()).to_equal(1)
        expect(json.get("verified").unwrap()).to_equal(true)
        expect(json.get("line").unwrap()).to_equal(42)

describe("SourceBreakpoint"):
    it("creates source breakpoint"):
        val bp = protocol.SourceBreakpoint.new(10)

        expect(bp.line).to_equal(10)
        expect(bp.condition.is_none()).to_be(true)
        expect(bp.hit_condition.is_none()).to_be(true)

    it("creates breakpoint with condition"):
        val bp = protocol.SourceBreakpoint.new(10)
            .with_condition("x > 0")

        expect(bp.condition.is_some()).to_be(true)
        match bp.condition:
            case Some(cond):
                expect(cond).to_equal("x > 0")
            case None:
                fail("Expected condition")

    it("creates breakpoint with hit condition"):
        val bp = protocol.SourceBreakpoint.new(10)
            .with_hit_condition("5")

        expect(bp.hit_condition.is_some()).to_be(true)

    it("parses from JSON"):
        val json = {
            "line": 20,
            "condition": "y == 42",
            "hitCondition": "3"
        }

        val bp = protocol.SourceBreakpoint.from_json(json).unwrap()

        expect(bp.line).to_equal(20)
        expect(bp.condition.unwrap()).to_equal("y == 42")
        expect(bp.hit_condition.unwrap()).to_equal("3")

describe("StackFrame"):
    it("creates stack frame"):
        val frame = protocol.StackFrame.new(1, "main", 10, 4)

        expect(frame.id).to_equal(1)
        expect(frame.name).to_equal("main")
        expect(frame.line).to_equal(10)
        expect(frame.column).to_equal(4)

    it("adds source to frame"):
        val source = protocol.Source.with_path("test.spl")
        val frame = protocol.StackFrame.new(1, "foo", 20, 0)
            .with_source(source)

        expect(frame.source.is_some()).to_be(true)

    it("converts to JSON"):
        val frame = protocol.StackFrame.new(1, "main", 10, 4)
        val json = frame.to_json()

        expect(json.get("id").unwrap()).to_equal(1)
        expect(json.get("name").unwrap()).to_equal("main")
        expect(json.get("line").unwrap()).to_equal(10)
        expect(json.get("column").unwrap()).to_equal(4)

describe("Thread"):
    it("creates thread"):
        val thread = protocol.Thread.new(1, "Main Thread")

        expect(thread.id).to_equal(1)
        expect(thread.name).to_equal("Main Thread")

    it("converts to JSON"):
        val thread = protocol.Thread.new(2, "Worker")
        val json = thread.to_json()

        expect(json.get("id").unwrap()).to_equal(2)
        expect(json.get("name").unwrap()).to_equal("Worker")

describe("Scope"):
    it("creates scope"):
        val scope = protocol.Scope.new("Local", 1)

        expect(scope.name).to_equal("Local")
        expect(scope.variables_reference).to_equal(1)
        expect(scope.expensive).to_be(false)

    it("creates expensive scope"):
        val scope = protocol.Scope.new("Heap", 10)
            .set_expensive(true)

        expect(scope.expensive).to_be(true)

    it("converts to JSON"):
        val scope = protocol.Scope.new("Global", 2)
        val json = scope.to_json()

        expect(json.get("name").unwrap()).to_equal("Global")
        expect(json.get("variablesReference").unwrap()).to_equal(2)

describe("Variable"):
    it("creates variable"):
        val var = protocol.Variable.new("x", "42")

        expect(var.name).to_equal("x")
        expect(var.value).to_equal("42")
        expect(var.type_name.is_none()).to_be(true)
        expect(var.variables_reference).to_equal(0)

    it("creates variable with type"):
        val var = protocol.Variable.new("count", "10")
            .with_type("Int")

        expect(var.type_name.is_some()).to_be(true)
        expect(var.type_name.unwrap()).to_equal("Int")

    it("creates variable with children"):
        val var = protocol.Variable.new("obj", "Object{...}")
            .with_children(5)

        expect(var.variables_reference).to_be_greater_than(0)

    it("converts to JSON"):
        val var = protocol.Variable.new("name", "\"test\"")
            .with_type("String")
        val json = var.to_json()

        expect(json.get("name").unwrap()).to_equal("name")
        expect(json.get("value").unwrap()).to_equal("\"test\"")
        expect(json.get("type").unwrap()).to_equal("String")

describe("Capabilities"):
    it("creates default capabilities"):
        val caps = protocol.Capabilities.default()

        expect(caps.get("supportsConfigurationDoneRequest").unwrap()).to_be(true)
        expect(caps.get("supportsConditionalBreakpoints").unwrap()).to_be(true)
        expect(caps.get("supportsHitConditionalBreakpoints").unwrap()).to_be(true)

describe("StopReason"):
    it("converts to string"):
        expect(protocol.StopReason.Step.to_string()).to_equal("step")
        expect(protocol.StopReason.Breakpoint.to_string()).to_equal("breakpoint")
        expect(protocol.StopReason.Exception.to_string()).to_equal("exception")
        expect(protocol.StopReason.Pause.to_string()).to_equal("pause")

describe("DapRequest"):
    it("creates request"):
        val req = protocol.DapRequest.new(1, "initialize", None)

        expect(req.id).to_equal(1)
        expect(req.command).to_equal("initialize")
        expect(req.arguments.is_none()).to_be(true)

    it("creates request with arguments"):
        val args = {"program": "test.spl"}
        val req = protocol.DapRequest.new(2, "launch", Some(args))

        expect(req.arguments.is_some()).to_be(true)

    it("parses from JSON"):
        val json = {
            "type": "request",
            "seq": 1,
            "command": "setBreakpoints",
            "arguments": {"source": {"path": "test.spl"}}
        }

        val req = protocol.DapRequest.from_json(json).unwrap()

        expect(req.id).to_equal(1)
        expect(req.command).to_equal("setBreakpoints")
        expect(req.arguments.is_some()).to_be(true)

describe("DapResponse"):
    it("creates success response"):
        val resp = protocol.DapResponse.success(1, "initialize", None)

        expect(resp.request_seq).to_equal(1)
        expect(resp.success).to_be(true)
        expect(resp.command).to_equal("initialize")

    it("creates failure response"):
        val resp = protocol.DapResponse.failure(2, "launch", "Failed to launch")

        expect(resp.success).to_be(false)
        expect(resp.message.is_some()).to_be(true)

    it("creates response with body"):
        val body = {"breakpoints": []}
        val resp = protocol.DapResponse.success(3, "setBreakpoints", Some(body))

        expect(resp.body.is_some()).to_be(true)

describe("DapEvent"):
    it("creates event"):
        val event = protocol.DapEvent.new("initialized", {})

        expect(event.event).to_equal("initialized")

    it("creates stopped event"):
        val body = {
            "reason": "breakpoint",
            "threadId": 1
        }
        val event = protocol.DapEvent.new("stopped", body)

        expect(event.body.get("reason").unwrap()).to_equal("breakpoint")
