# Tests for LMS Server

import spec.{describe, it, expect}
import lms.server as server
import lms.error as error
import lms.protocol as protocol

describe("LmsServer"):
    it("should create a new server"):
        val srv = server.LmsServer.new()
        expect(srv.state).to_equal(server.ServerState.Uninitialized)

    it("should start in Uninitialized state"):
        val srv = server.LmsServer.new()
        match srv.state:
            case server.ServerState.Uninitialized:
                # Pass
                expect(true).to_be(true)
            case _:
                expect(false).to_be(true) # Fail

describe("Error handling"):
    it("should convert errors to JSON-RPC codes"):
        val code1 = error.to_json_rpc_code(error.LmsError.MethodNotFound("test"))
        expect(code1).to_equal(-32601)

        val code2 = error.to_json_rpc_code(error.LmsError.InvalidParams("bad"))
        expect(code2).to_equal(-32602)

    it("should create error messages"):
        val msg = error.to_message(error.LmsError.NotInitialized)
        expect(msg).to_equal("Server not initialized")

describe("Protocol"):
    it("should create initialize response"):
        val server_info = protocol.ServerInfo {
            name: "test-server",
            version: "1.0.0"
        }
        val caps = protocol.ServerCapabilities {
            tools: None,
            resources: None,
            prompts: None
        }

        val response = protocol.create_initialize_response(server_info, caps)
        expect(response.contains_key("protocolVersion")).to_be(true)
        expect(response.contains_key("serverInfo")).to_be(true)
