# Unit tests for language detection

import spec.{describe, it, expect}
import parser.treesitter.language_detect as detect

describe("DetectionResult"):
    it("creates detection result"):
        val result = detect.DetectionResult.new("python", 0.9)

        expect(result.language).to_equal("python")
        expect(result.confidence).to_equal(0.9)

describe("LanguageDetector"):
    it("creates detector"):
        val detector = detect.LanguageDetector.new()

        expect(detector.extension_map.len()).to_be_greater_than(0)
        expect(detector.shebang_patterns.len()).to_be_greater_than(0)

    it("has Simple language extension"):
        val detector = detect.LanguageDetector.new()

        expect(detector.extension_map.contains_key(".spl")).to_be(true)
        expect(detector.extension_map[".spl"]).to_equal("simple")

describe("Extension-based detection"):
    it("detects Simple from .spl extension"):
        val detector = detect.LanguageDetector.new()

        val result = detector.detect_from_path("main.spl").unwrap()

        expect(result.language).to_equal("simple")
        expect(result.confidence).to_equal(1.0)

    it("detects Rust from .rs extension"):
        val detector = detect.LanguageDetector.new()

        val result = detector.detect_from_path("lib.rs").unwrap()

        expect(result.language).to_equal("rust")
        expect(result.confidence).to_equal(1.0)

    it("detects Python from .py extension"):
        val detector = detect.LanguageDetector.new()

        val result = detector.detect_from_path("script.py").unwrap()

        expect(result.language).to_equal("python")
        expect(result.confidence).to_equal(1.0)

    it("detects JavaScript from .js extension"):
        val detector = detect.LanguageDetector.new()

        val result = detector.detect_from_path("app.js").unwrap()

        expect(result.language).to_equal("javascript")
        expect(result.confidence).to_equal(1.0)

    it("detects TypeScript from .ts extension"):
        val detector = detect.LanguageDetector.new()

        val result = detector.detect_from_path("app.ts").unwrap()

        expect(result.language).to_equal("typescript")
        expect(result.confidence).to_equal(1.0)

    it("detects Go from .go extension"):
        val detector = detect.LanguageDetector.new()

        val result = detector.detect_from_path("main.go").unwrap()

        expect(result.language).to_equal("go")
        expect(result.confidence).to_equal(1.0)

    it("detects C from .c extension"):
        val detector = detect.LanguageDetector.new()

        val result = detector.detect_from_path("main.c").unwrap()

        expect(result.language).to_equal("c")
        expect(result.confidence).to_equal(1.0)

    it("detects C++ from .cpp extension"):
        val detector = detect.LanguageDetector.new()

        val result = detector.detect_from_path("main.cpp").unwrap()

        expect(result.language).to_equal("cpp")
        expect(result.confidence).to_equal(1.0)

    it("detects Ruby from .rb extension"):
        val detector = detect.LanguageDetector.new()

        val result = detector.detect_from_path("app.rb").unwrap()

        expect(result.language).to_equal("ruby")
        expect(result.confidence).to_equal(1.0)

    it("detects Erlang from .erl extension"):
        val detector = detect.LanguageDetector.new()

        val result = detector.detect_from_path("server.erl").unwrap()

        expect(result.language).to_equal("erlang")
        expect(result.confidence).to_equal(1.0)

    it("handles files with path"):
        val detector = detect.LanguageDetector.new()

        val result = detector.detect_from_path("/path/to/file.spl").unwrap()

        expect(result.language).to_equal("simple")

    it("returns None for unknown extension"):
        val detector = detect.LanguageDetector.new()

        val result = detector.detect_from_path("file.xyz")

        expect(result.is_none()).to_be(true)

    it("returns None for no extension"):
        val detector = detect.LanguageDetector.new()

        val result = detector.detect_from_path("README")

        expect(result.is_none()).to_be(true)

describe("Shebang-based detection"):
    it("detects Python from python shebang"):
        val detector = detect.LanguageDetector.new()

        val result = detector.detect_from_shebang("#!/usr/bin/env python3").unwrap()

        expect(result.language).to_equal("python")
        expect(result.confidence).to_equal(0.9)

    it("detects Ruby from ruby shebang"):
        val detector = detect.LanguageDetector.new()

        val result = detector.detect_from_shebang("#!/usr/bin/ruby").unwrap()

        expect(result.language).to_equal("ruby")

    it("detects Bash from bash shebang"):
        val detector = detect.LanguageDetector.new()

        val result = detector.detect_from_shebang("#!/bin/bash").unwrap()

        expect(result.language).to_equal("bash")

    it("detects Node.js from node shebang"):
        val detector = detect.LanguageDetector.new()

        val result = detector.detect_from_shebang("#!/usr/bin/env node").unwrap()

        expect(result.language).to_equal("javascript")

    it("returns None for non-shebang line"):
        val detector = detect.LanguageDetector.new()

        val result = detector.detect_from_shebang("# This is a comment")

        expect(result.is_none()).to_be(true)

describe("Content-based detection"):
    it("detects Simple from content"):
        val detector = detect.LanguageDetector.new()

        val content = """
fn main():
    import core.io
    print("Hello")
"""

        val result = detector.detect_from_content(content).unwrap()

        expect(result.language).to_equal("simple")
        expect(result.confidence).to_be_greater_than(0.0)

    it("detects Rust from content"):
        val detector = detect.LanguageDetector.new()

        val content = """
fn main() {
    println!("Hello");
}

impl MyStruct {
    pub fn new() -> Self {
        MyStruct {}
    }
}
"""

        val result = detector.detect_from_content(content).unwrap()

        expect(result.language).to_equal("rust")

    it("detects Python from content"):
        val detector = detect.LanguageDetector.new()

        val content = """
import os

def main():
    print("Hello")
    return 0
"""

        val result = detector.detect_from_content(content).unwrap()

        expect(result.language).to_equal("python")

    it("detects Go from content"):
        val detector = detect.LanguageDetector.new()

        val content = """
package main

func main() {
    fmt.Println("Hello")
}
"""

        val result = detector.detect_from_content(content).unwrap()

        expect(result.language).to_equal("go")

    it("detects JavaScript from content"):
        val detector = detect.LanguageDetector.new()

        val content = """
const greet = () => {
    console.log("Hello");
};

function main() {
    greet();
}
"""

        val result = detector.detect_from_content(content).unwrap()

        expect(result.language).to_equal("javascript")

    it("detects C++ from content"):
        val detector = detect.LanguageDetector.new()

        val content = """
#include <iostream>

namespace myapp {
    int main() {
        std::cout << "Hello" << std::endl;
    }
}
"""

        val result = detector.detect_from_content(content).unwrap()

        expect(result.language).to_equal("cpp")

    it("detects C from content"):
        val detector = detect.LanguageDetector.new()

        val content = """
#include <stdio.h>

int main() {
    printf("Hello\\n");
    return 0;
}
"""

        val result = detector.detect_from_content(content).unwrap()

        expect(result.language).to_equal("c")

    it("detects from shebang in content"):
        val detector = detect.LanguageDetector.new()

        val content = """#!/usr/bin/env python3
import sys

def main():
    print("Hello")
"""

        val result = detector.detect_from_content(content).unwrap()

        expect(result.language).to_equal("python")
        expect(result.confidence).to_equal(0.9)

describe("Multi-strategy detection"):
    it("uses path when available"):
        val detector = detect.LanguageDetector.new()

        val result = detector.detect(Some("test.spl"), None).unwrap()

        expect(result.language).to_equal("simple")
        expect(result.confidence).to_equal(1.0)

    it("uses content when path unavailable"):
        val detector = detect.LanguageDetector.new()

        val content = "fn main():\n    import core.io"
        val result = detector.detect(None, Some(content)).unwrap()

        expect(result.language).to_equal("simple")

    it("prefers path over content"):
        val detector = detect.LanguageDetector.new()

        # Path says .py, content looks like Simple
        val content = "fn main():\n    import core.io"
        val result = detector.detect(Some("test.py"), Some(content)).unwrap()

        # Should use path (higher confidence)
        expect(result.language).to_equal("python")
        expect(result.confidence).to_equal(1.0)

    it("returns None when no detection possible"):
        val detector = detect.LanguageDetector.new()

        val result = detector.detect(None, None)

        expect(result.is_none()).to_be(true)

describe("Custom mappings"):
    it("adds custom extension"):
        var detector = detect.LanguageDetector.new()

        detector.add_extension(".custom", "mylang")

        val result = detector.detect_from_path("test.custom").unwrap()

        expect(result.language).to_equal("mylang")

    it("adds custom shebang pattern"):
        var detector = detect.LanguageDetector.new()

        detector.add_shebang_pattern("mylang", "mylang")

        val result = detector.detect_from_shebang("#!/usr/bin/mylang").unwrap()

        expect(result.language).to_equal("mylang")

describe("Supported languages"):
    it("gets list of supported languages"):
        val detector = detect.LanguageDetector.new()

        val languages = detector.get_supported_languages()

        expect(languages.len()).to_be_greater_than(0)
        expect(languages.contains("simple")).to_be(true)
        expect(languages.contains("rust")).to_be(true)
        expect(languages.contains("python")).to_be(true)

    it("checks if language is supported"):
        val detector = detect.LanguageDetector.new()

        expect(detector.is_supported("simple")).to_be(true)
        expect(detector.is_supported("rust")).to_be(true)
        expect(detector.is_supported("unknown")).to_be(false)

describe("Convenience functions"):
    it("detects from path"):
        val language = detect.detect_language_from_path("test.spl").unwrap()

        expect(language).to_equal("simple")

    it("detects from content"):
        val content = "fn main():\n    import core.io"
        val language = detect.detect_language_from_content(content).unwrap()

        expect(language).to_equal("simple")

    it("detects with all info"):
        val language = detect.detect_language(Some("test.spl"), None).unwrap()

        expect(language).to_equal("simple")

    it("gets supported languages"):
        val languages = detect.get_supported_languages()

        expect(languages.len()).to_be_greater_than(0)
        expect(languages.contains("simple")).to_be(true)

describe("Edge cases"):
    it("handles empty content"):
        val detector = detect.LanguageDetector.new()

        val result = detector.detect_from_content("")

        expect(result.is_none()).to_be(true)

    it("handles single-line content"):
        val detector = detect.LanguageDetector.new()

        val result = detector.detect_from_content("fn main(): pass")

        # May or may not detect, but shouldn't crash
        # Just verify it returns a valid Option
        match result:
            case Some(r):
                expect(r.confidence).to_be_greater_than(0.0)
            case None:
                pass

    it("handles file with multiple extensions"):
        val detector = detect.LanguageDetector.new()

        val result = detector.detect_from_path("test.min.js").unwrap()

        expect(result.language).to_equal("javascript")

describe("Integration"):
    it("detects language for complete workflow"):
        val detector = detect.LanguageDetector.new()

        # Scenario: User opens a file
        val file_path = "examples/hello.spl"
        val file_content = """
# Simple program
import core.io

fn main():
    io.println("Hello, World!")
"""

        # Detect language
        val result = detector.detect(Some(file_path), Some(file_content)).unwrap()

        expect(result.language).to_equal("simple")
        expect(result.confidence).to_equal(1.0)  # High confidence from extension

        # Verify language is supported
        expect(detector.is_supported(result.language)).to_be(true)
