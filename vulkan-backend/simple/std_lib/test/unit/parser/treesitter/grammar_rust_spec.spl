# Unit tests for Rust grammar

import spec.{describe, it, expect}
import parser.treesitter.grammar_rust as rust_grammar
import parser.treesitter.grammar_test as gt

describe("RustGrammar"):
    it("creates Rust grammar"):
        val grammar = rust_grammar.RustGrammar.new()

        expect(grammar.grammar.name).to_equal("rust")
        expect(grammar.grammar.entry_point).to_equal("source_file")

describe("Rust parsing"):
    it("parses function definition"):
        val suite = gt.GrammarTestBuilder.new()
            .test("function", "rust", "fn main() { }\n", "source_file")
            .build()

        val result = suite.run()

        expect(result.all_passed()).to_be(true)

    it("parses struct definition"):
        val suite = gt.GrammarTestBuilder.new()
            .test("struct", "rust", "struct Point { x: i32, y: i32 }\n", "source_file")
            .build()

        val result = suite.run()

        expect(result.all_passed()).to_be(true)

    it("parses enum definition"):
        val suite = gt.GrammarTestBuilder.new()
            .test("enum", "rust", "enum Option<T> { Some(T), None }\n", "source_file")
            .build()

        val result = suite.run()

        expect(result.all_passed()).to_be(true)

    it("parses trait definition"):
        val suite = gt.GrammarTestBuilder.new()
            .test("trait", "rust", "trait Display { fn fmt(&self); }\n", "source_file")
            .build()

        val result = suite.run()

        expect(result.all_passed()).to_be(true)

    it("parses impl block"):
        val suite = gt.GrammarTestBuilder.new()
            .test("impl", "rust", "impl Point { fn new() -> Self { } }\n", "source_file")
            .build()

        val result = suite.run()

        expect(result.all_passed()).to_be(true)

    it("parses match expression"):
        val suite = gt.GrammarTestBuilder.new()
            .test("match", "rust", "match x { Some(v) => v, None => 0 }\n", "source_file")
            .build()

        val result = suite.run()

        expect(result.all_passed()).to_be(true)

    it("parses closure"):
        val suite = gt.GrammarTestBuilder.new()
            .test("closure", "rust", "|x| x + 1\n", "source_file")
            .build()

        val result = suite.run()

        expect(result.all_passed()).to_be(true)

    it("parses macro invocation"):
        val suite = gt.GrammarTestBuilder.new()
            .test("macro", "rust", "println!(\"Hello\")\n", "source_file")
            .build()

        val result = suite.run()

        expect(result.all_passed()).to_be(true)
