# Unit tests for Tree-sitter CLI tools

import spec.{describe, it, expect}
import parser.treesitter.cli as cli
import parser.treesitter.grammar_simple as simple_grammar

describe("CliResult"):
    it("creates Success result"):
        val result = cli.CliResult.Success("test message")

        match result:
            case Success(msg):
                expect(msg).to_equal("test message")
            case _:
                expect(false).to_be(true)  # Should not reach here

    it("creates Error result"):
        val result = cli.CliResult.Error("error message")

        match result:
            case Error(msg):
                expect(msg).to_equal("error message")
            case _:
                expect(false).to_be(true)

    it("creates Help result"):
        val result = cli.CliResult.Help

        match result:
            case Help:
                expect(true).to_be(true)
            case _:
                expect(false).to_be(true)

describe("Command parsing"):
    it("parses parse command"):
        val cli_tool = cli.TreeSitterCli.new()
        val args = ["ts-cli", "parse", "test.spl"]

        val cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Parse(path, lang, show_tree)):
                expect(path).to_equal("test.spl")
                expect(lang).to_equal(None)
                expect(show_tree).to_be(false)
            case _:
                expect(false).to_be(true)

    it("parses parse command with language option"):
        val cli_tool = cli.TreeSitterCli.new()
        val args = ["ts-cli", "parse", "test.rs", "--language", "rust"]

        val cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Parse(path, lang, show_tree)):
                expect(path).to_equal("test.rs")
                expect(lang).to_equal(Some("rust"))
                expect(show_tree).to_be(false)
            case _:
                expect(false).to_be(true)

    it("parses parse command with tree flag"):
        val cli_tool = cli.TreeSitterCli.new()
        val args = ["ts-cli", "parse", "test.spl", "--tree"]

        val cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Parse(path, lang, show_tree)):
                expect(path).to_equal("test.spl")
                expect(show_tree).to_be(true)
            case _:
                expect(false).to_be(true)

    it("parses parse command with all options"):
        val cli_tool = cli.TreeSitterCli.new()
        val args = ["ts-cli", "parse", "test.py", "-l", "python", "-t"]

        val cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Parse(path, lang, show_tree)):
                expect(path).to_equal("test.py")
                expect(lang).to_equal(Some("python"))
                expect(show_tree).to_be(true)
            case _:
                expect(false).to_be(true)

    it("parses query command"):
        val cli_tool = cli.TreeSitterCli.new()
        val args = ["ts-cli", "query", "test.spl", "(function_def)"]

        val cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Query(path, query, lang)):
                expect(path).to_equal("test.spl")
                expect(query).to_equal("(function_def)")
                expect(lang).to_equal(None)
            case _:
                expect(false).to_be(true)

    it("parses query command with language"):
        val cli_tool = cli.TreeSitterCli.new()
        val args = ["ts-cli", "query", "test.rs", "(function_item)", "--language", "rust"]

        val cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Query(path, query, lang)):
                expect(path).to_equal("test.rs")
                expect(query).to_equal("(function_item)")
                expect(lang).to_equal(Some("rust"))
            case _:
                expect(false).to_be(true)

    it("parses test command"):
        val cli_tool = cli.TreeSitterCli.new()
        val args = ["ts-cli", "test", "grammar_tests.spl"]

        val cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Test(path)):
                expect(path).to_equal("grammar_tests.spl")
            case _:
                expect(false).to_be(true)

    it("parses highlight command"):
        val cli_tool = cli.TreeSitterCli.new()
        val args = ["ts-cli", "highlight", "example.spl"]

        val cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Highlight(path, lang)):
                expect(path).to_equal("example.spl")
                expect(lang).to_equal(None)
            case _:
                expect(false).to_be(true)

    it("parses highlight command with language"):
        val cli_tool = cli.TreeSitterCli.new()
        val args = ["ts-cli", "highlight", "example.rs", "-l", "rust"]

        val cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Highlight(path, lang)):
                expect(path).to_equal("example.rs")
                expect(lang).to_equal(Some("rust"))
            case _:
                expect(false).to_be(true)

    it("parses validate command"):
        val cli_tool = cli.TreeSitterCli.new()
        val args = ["ts-cli", "validate", "grammar.spl"]

        val cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Validate(path)):
                expect(path).to_equal("grammar.spl")
            case _:
                expect(false).to_be(true)

    it("parses languages command"):
        val cli_tool = cli.TreeSitterCli.new()
        val args = ["ts-cli", "languages"]

        val cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Languages):
                expect(true).to_be(true)
            case _:
                expect(false).to_be(true)

    it("parses help command"):
        val cli_tool = cli.TreeSitterCli.new()
        val args = ["ts-cli", "help"]

        val cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Help):
                expect(true).to_be(true)
            case _:
                expect(false).to_be(true)

    it("parses --help flag"):
        val cli_tool = cli.TreeSitterCli.new()
        val args = ["ts-cli", "--help"]

        val cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Help):
                expect(true).to_be(true)
            case _:
                expect(false).to_be(true)

    it("parses version command"):
        val cli_tool = cli.TreeSitterCli.new()
        val args = ["ts-cli", "version"]

        val cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Version):
                expect(true).to_be(true)
            case _:
                expect(false).to_be(true)

    it("parses --version flag"):
        val cli_tool = cli.TreeSitterCli.new()
        val args = ["ts-cli", "--version"]

        val cmd = cli_tool.parse_command(args)

        match cmd:
            case Ok(Command.Version):
                expect(true).to_be(true)
            case _:
                expect(false).to_be(true)

describe("Command parsing errors"):
    it("errors on unknown command"):
        val cli_tool = cli.TreeSitterCli.new()
        val args = ["ts-cli", "unknown"]

        val cmd = cli_tool.parse_command(args)

        match cmd:
            case Err(msg):
                expect(msg).to_contain("Unknown command")
            case _:
                expect(false).to_be(true)

    it("errors on parse without file"):
        val cli_tool = cli.TreeSitterCli.new()
        val args = ["ts-cli", "parse"]

        val cmd = cli_tool.parse_command(args)

        match cmd:
            case Err(msg):
                expect(msg).to_contain("Usage")
            case _:
                expect(false).to_be(true)

    it("errors on query without file"):
        val cli_tool = cli.TreeSitterCli.new()
        val args = ["ts-cli", "query"]

        val cmd = cli_tool.parse_command(args)

        match cmd:
            case Err(msg):
                expect(msg).to_contain("Usage")
            case _:
                expect(false).to_be(true)

    it("errors on query without query string"):
        val cli_tool = cli.TreeSitterCli.new()
        val args = ["ts-cli", "query", "test.spl"]

        val cmd = cli_tool.parse_command(args)

        match cmd:
            case Err(msg):
                expect(msg).to_contain("Usage")
            case _:
                expect(false).to_be(true)

    it("errors on test without file"):
        val cli_tool = cli.TreeSitterCli.new()
        val args = ["ts-cli", "test"]

        val cmd = cli_tool.parse_command(args)

        match cmd:
            case Err(msg):
                expect(msg).to_contain("Usage")
            case _:
                expect(false).to_be(true)

    it("errors on unknown option"):
        val cli_tool = cli.TreeSitterCli.new()
        val args = ["ts-cli", "parse", "test.spl", "--unknown"]

        val cmd = cli_tool.parse_command(args)

        match cmd:
            case Err(msg):
                expect(msg).to_contain("Unknown option")
            case _:
                expect(false).to_be(true)

    it("errors on --language without argument"):
        val cli_tool = cli.TreeSitterCli.new()
        val args = ["ts-cli", "parse", "test.spl", "--language"]

        val cmd = cli_tool.parse_command(args)

        match cmd:
            case Err(msg):
                expect(msg).to_contain("--language requires an argument")
            case _:
                expect(false).to_be(true)

describe("TreeSitterCli"):
    it("creates new CLI instance"):
        val cli_tool = cli.TreeSitterCli.new()

        expect(cli_tool).to_not_be(None)

    it("shows help when no args"):
        val cli_tool = cli.TreeSitterCli.new()
        val args = ["ts-cli"]

        val result = cli_tool.run(args)

        match result:
            case Help:
                expect(true).to_be(true)
            case _:
                expect(false).to_be(true)

    it("returns help result"):
        val cli_tool = cli.TreeSitterCli.new()
        val result = cli_tool.print_help()

        match result:
            case Help:
                expect(true).to_be(true)
            case _:
                expect(false).to_be(true)

    it("returns version result"):
        val cli_tool = cli.TreeSitterCli.new()
        val result = cli_tool.print_version()

        match result:
            case Success(msg):
                expect(msg).to_equal("Version info displayed")
            case _:
                expect(false).to_be(true)

describe("Languages command"):
    it("lists supported languages"):
        val cli_tool = cli.TreeSitterCli.new()
        val result = cli_tool.cmd_languages()

        match result:
            case Success(msg):
                expect(msg).to_equal("Language list complete")
            case _:
                expect(false).to_be(true)

describe("Convenience functions"):
    it("parse_file returns tree on success"):
        # This test would require a real file - skipped for unit tests
        expect(true).to_be(true)

    it("query_file returns cursor on success"):
        # This test would require a real file - skipped for unit tests
        expect(true).to_be(true)
