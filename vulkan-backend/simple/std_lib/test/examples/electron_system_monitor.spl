# System Monitor - Electron App Example
# Monitors CPU, memory, and battery status via system tray

import electron.app
import electron.tray
import electron.power
import electron.notification

# State
val tray: Tray? = none
val cpu_usage: i32 = 0
val memory_usage: i32 = 0
val battery_level: f64 = 1.0
val is_on_battery: bool = false

# Main entry point
fn main():
    print("Starting System Monitor...")

    # Setup app lifecycle
    app.when_ready(on_ready)
    app.prevent_quit()  # Keep running as tray app

fn on_ready():
    print("App ready, creating tray...")

    # Create system tray
    tray = Tray.new("System Monitor")
    tray!.set_icon("icon.png")
    tray!.set_tooltip("System Monitor - Initializing...")

    # Setup initial menu
    update_menu()

    # Monitor power events
    power.on_battery_low(on_battery_low)
    power.on_ac_power(on_ac_connected)

    # Start monitoring loop
    start_monitoring()

fn start_monitoring():
    """Main monitoring loop."""
    # Update stats every 5 seconds
    update_stats()

    # Schedule next update
    # (In real implementation, use setTimeout or timer)

fn update_stats():
    """Update CPU, memory, and battery statistics."""
    # Get system stats (would call native APIs)
    cpu_usage = get_cpu_usage()
    memory_usage = get_memory_usage()
    battery_level = power.get_battery_level()
    is_on_battery = power.is_on_battery()

    # Update tray
    update_menu()
    update_icon()
    update_tooltip()

    print("CPU: {cpu_usage}%, Memory: {memory_usage}%, Battery: {(battery_level * 100.0).to_i32()}%")

fn update_menu():
    """Update context menu with current stats."""
    if tray == none:
        return

    val menu = [
        MenuItem.new("CPU: {cpu_usage}%", none).set_enabled(false),
        MenuItem.new("Memory: {memory_usage}%", none).set_enabled(false),
        MenuItem.new("Battery: {(battery_level * 100.0).to_i32()}%", none).set_enabled(false),
        MenuSeparator.new(),
        MenuItem.new("Refresh", on_refresh),
        MenuItem.new("Settings", on_settings),
        MenuSeparator.new(),
        MenuItem.new("Quit", on_quit)
    ]

    tray!.set_context_menu(menu)

fn update_icon():
    """Update tray icon based on system status."""
    if tray == none:
        return

    # Change icon color based on CPU usage
    if cpu_usage > 80:
        tray!.set_icon("icon_red.png")   # High usage
    elif cpu_usage > 50:
        tray!.set_icon("icon_yellow.png") # Medium usage
    else:
        tray!.set_icon("icon_green.png")  # Normal usage

fn update_tooltip():
    """Update tooltip with current stats."""
    if tray == none:
        return

    val tooltip = "System Monitor\n"
    tooltip = tooltip + "CPU: {cpu_usage}%\n"
    tooltip = tooltip + "Memory: {memory_usage}%\n"
    tooltip = tooltip + "Battery: {(battery_level * 100.0).to_i32()}%"

    if is_on_battery:
        tooltip = tooltip + " (Battery)"
    else:
        tooltip = tooltip + " (AC Power)"

    tray!.set_tooltip(tooltip)

# Event handlers

fn on_refresh():
    """Handle refresh menu item click."""
    print("Refreshing stats...")
    update_stats()

fn on_settings():
    """Handle settings menu item click."""
    print("Opening settings... (not implemented)")
    # Would open a settings window

fn on_quit():
    """Handle quit menu item click."""
    print("Quitting...")
    app.quit()

fn on_battery_low():
    """Handle low battery event."""
    print("Battery low! Showing notification...")

    notification.show_warning(
        "Battery Low",
        "Battery level is below 20%. Please plug in your device."
    )

fn on_ac_connected():
    """Handle AC power connected."""
    print("AC power connected")

# Helper functions (would be implemented via FFI)

fn get_cpu_usage(): i32 =
    """Get current CPU usage percentage."""
    # In real implementation, would call system APIs
    # For demo, return simulated value
    45

fn get_memory_usage(): i32 =
    """Get current memory usage percentage."""
    # In real implementation, would call system APIs
    # For demo, return simulated value
    62
