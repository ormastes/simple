# VSCode Commands API
# Register and execute commands

# External FFI declarations
extern fn vscode_commands_register(command: String, callback_id: i64): i64
extern fn vscode_commands_execute(command: String, args_json: String): String
extern fn vscode_commands_get_commands(): String

# Command callback registry
val command_callbacks: Dict<String, fn(args: List<String>): void> = {}
val next_callback_id: i64 = 0

# Extension context for subscriptions
pub class ExtensionContext:
    pub subscriptions: List<i64>
    pub workspace_state: Dict<String, String>
    pub global_state: Dict<String, String>

    pub fn new(): ExtensionContext =
        """Create new extension context."""
        ExtensionContext {
            subscriptions: [],
            workspace_state: {},
            global_state: {}
        }

    pub fn push(self, subscription_id: i64):
        """Add a subscription to be disposed on deactivation."""
        self.subscriptions.append(subscription_id)

# Register a command
pub fn register_command(command: String, handler: fn(args: List<String>): void): i64 =
    """Register a command handler.

    Args:
        command: Command ID (e.g., "simple.formatDocument")
        handler: Function to call when command executed

    Returns:
        Subscription ID for disposal

    Example:
        sub_id = commands.register_command("simple.hello", fn(args):
            window.show_message("Hello from Simple!")
        )
    """
    # Store callback
    val callback_id = next_callback_id
    next_callback_id = next_callback_id + 1

    command_callbacks[command] = handler

    # Register with VSCode
    vscode_commands_register(command, callback_id)

# Execute a command
pub fn execute_command(command: String, args: List<String>): String =
    """Execute a VSCode command.

    Args:
        command: Command ID
        args: Command arguments

    Returns:
        Result from command (JSON string)

    Example:
        # Execute built-in command
        commands.execute_command("editor.action.formatDocument", [])

        # Execute custom command
        commands.execute_command("simple.analyze", ["file.spl"])
    """
    # Serialize args to JSON
    val args_json = "[" + args.map(fn(arg): '"' + arg + '"').join(",") + "]"

    vscode_commands_execute(command, args_json)

# Get all registered commands
pub fn get_commands(): List<String> =
    """Get list of all registered commands.

    Returns:
        List of command IDs
    """
    val json = vscode_commands_get_commands()

    # Parse JSON array (simplified)
    val commands: List<String> = []
    # TODO: Proper JSON parsing
    commands

# Trigger callback from FFI
pub fn _trigger_callback(callback_id: i64, args_json: String):
    """Internal: Called by FFI when command executed."""
    # Find command by callback ID
    for command, handler in command_callbacks.items():
        # Parse args from JSON
        val args: List<String> = []
        # TODO: Parse args_json into List<String>

        handler(args)
