# Simple Language MCP Provider
# Implements ResourceProvider for Simple language code

use core.*
use mcp.core.*
use mcp.simple_lang.types.*
use mcp.simple_lang.parser.*
use mcp.simple_lang.formatter.*

# Simple language resource provider
pub class SimpleLangProvider:
    pub base: BaseProvider
    pub file_cache: Dict[String, String]  # URI -> source code
    pub symbol_cache: Dict[String, List[Symbol]]  # URI -> symbols
    
    pub fn new(root_path: String) -> SimpleLangProvider:
        return SimpleLangProvider:
            base: BaseProvider.new(root_path)
            file_cache: {}
            symbol_cache: {}
    
    # Register a Simple source file
    pub fn register_simple_file(self, path: String, source: String):
        uri = "file://" + path
        name = path
        resource = Resource.new(uri, name, "text/x-simple")
        self.base.add_resource(resource)
        
        # Cache source and parse symbols
        self.file_cache.set(uri, source)
        symbols = parse_file(source)
        self.symbol_cache.set(uri, symbols)
        
        # Register each symbol as a resource
        for symbol in symbols:
            self.register_symbol_resource(path, symbol)
    
    # Register a symbol as a separate resource
    fn register_symbol_resource(self, file_path: String, symbol: Symbol):
        uri = "symbol://" + file_path + "#" + symbol.name
        name = symbol.name + " (" + file_path + ")"
        resource = Resource.new(uri, name, "text/x-simple-symbol")
        resource.description = symbol.signature
        self.base.add_resource(resource)
    
    # Get MCP representation of a file
    fn get_file_mcp(self, uri: String, show_all: bool) -> String:
        if not self.file_cache.has_key(uri):
            return "# File not found: " + uri
        
        source = self.file_cache.get(uri)
        symbols = parse_file(source)
        
        if show_all:
            return format_symbols(symbols, true)
        else:
            pub_symbols = filter_public_symbols(symbols)
            return format_symbols(pub_symbols, false)
    
    # Get symbol details
    fn get_symbol_details(self, uri: String, symbol_name: String) -> String:
        if not self.symbol_cache.has_key(uri):
            return "# File not found"
        
        symbols = self.symbol_cache.get(uri)
        symbol_opt = find_symbol(symbols, symbol_name)
        
        if symbol_opt.is_none():
            return "# Symbol not found: " + symbol_name
        
        symbol = symbol_opt.unwrap()
        return format_single_symbol(symbol, "all")

impl ResourceProvider for SimpleLangProvider:
    fn list_resources(self) -> List[Resource]:
        result = []
        for uri in self.base.resources.keys():
            resource = self.base.resources.get(uri)
            result.append(resource)
        return result
    
    fn read_resource(self, uri: String) -> ResourceContents:
        if uri.starts_with("file://"):
            # Return MCP-formatted file
            text = self.get_file_mcp(uri, false)
            return ResourceContents.new(uri, "text/x-simple-mcp", text)
        
        elif uri.starts_with("symbol://"):
            # Return expanded symbol
            parts = uri.split("#")
            if parts.len() >= 2:
                file_uri = parts[0]
                symbol_name = parts[1]
                text = self.get_symbol_details(file_uri, symbol_name)
                return ResourceContents.new(uri, "text/x-simple-mcp", text)
            else:
                return ResourceContents.new(uri, "text/plain", "# Invalid symbol URI")
        
        else:
            return ResourceContents.new(uri, "text/plain", "# Unknown URI scheme")
    
    fn search_resources(self, query: String) -> List[Resource]:
        result = []
        
        # Search in symbols
        for uri in self.symbol_cache.keys():
            symbols = self.symbol_cache.get(uri)
            for symbol in symbols:
                if symbol.name.contains(query):
                    symbol_uri = "symbol://" + uri + "#" + symbol.name
                    if self.base.resources.has_key(symbol_uri):
                        resource = self.base.resources.get(symbol_uri)
                        result.append(resource)
        
        return result

# Create MCP tools for Simple language
pub fn create_simple_tools(provider: SimpleLangProvider) -> List[ToolHandler]:
    tools = []
    
    # Tool: Read code with MCP formatting
    read_code_tool = Tool.new("read_code", "Read Simple code file in MCP format")
    read_code_handler = fn(args: Dict[String, Any]) -> String:
        path = args.get("path")
        uri = "file://" + path
        contents = provider.read_resource(uri)
        return contents.text
    
    tools.append(create_text_tool("read_code", "Read Simple code in MCP format", read_code_handler))
    
    # Tool: Expand symbol
    expand_symbol_tool = Tool.new("expand_symbol", "Expand a specific symbol to show full details")
    expand_handler = fn(args: Dict[String, Any]) -> String:
        file_path = args.get("file")
        symbol_name = args.get("symbol")
        uri = "file://" + file_path
        return provider.get_symbol_details(uri, symbol_name)
    
    tools.append(create_text_tool("expand_symbol", "Expand symbol details", expand_handler))
    
    # Tool: Search symbols
    search_tool = Tool.new("search_symbols", "Search for symbols in Simple code")
    search_handler = fn(args: Dict[String, Any]) -> String:
        query = args.get("query")
        resources = provider.search_resources(query)
        
        result = "Found " + resources.len().to_string() + " symbols:\n"
        for resource in resources:
            result = result + "- " + resource.name + " (" + resource.uri + ")\n"
        
        return result
    
    tools.append(create_text_tool("search_symbols", "Search for symbols", search_handler))
    
    return tools
