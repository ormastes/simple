# Snapshot Testing - Configuration
# Feature #899: Configuration for snapshot tests

module std.spec.snapshot.config:
    use core.option.{Option, Some, None}

    # Snapshot test configuration
    pub struct SnapshotConfig:
        # Custom snapshot name (default: function name)
        name: Option<String>

        # Output format: "text", "json", "yaml", "html", "base64"
        format: String

        # Enable normalization (timestamps, IDs, etc.)
        normalize: bool

        # Normalize generated IDs
        normalize_ids: bool

        # Normalize timestamps
        normalize_timestamps: bool

        # Custom normalizer function
        normalizer: Option<fn(String) -> String>

        # Update snapshots (set by CLI flag)
        update_snapshots: bool

        # Snapshot directory (default: ".snapshots")
        snapshot_dir: String

        # Interactive update mode
        interactive: bool

    impl SnapshotConfig:
        # Default configuration
        pub fn default() -> SnapshotConfig:
            return SnapshotConfig(
                name: None,
                format: "text",
                normalize: false,
                normalize_ids: false,
                normalize_timestamps: false,
                normalizer: None,
                update_snapshots: false,
                snapshot_dir: ".snapshots",
                interactive: false
            )

        # Builder methods
        pub fn with_name(mut self, name: String) -> SnapshotConfig:
            self.name = Some(name)
            return self

        pub fn with_format(mut self, format: String) -> SnapshotConfig:
            self.format = format
            return self

        pub fn with_normalization(mut self) -> SnapshotConfig:
            self.normalize = true
            self.normalize_ids = true
            self.normalize_timestamps = true
            return self

        pub fn with_normalizer(mut self, f: fn(String) -> String) -> SnapshotConfig:
            self.normalizer = Some(f)
            return self

        pub fn with_update(mut self) -> SnapshotConfig:
            self.update_snapshots = true
            return self

        pub fn interactive(mut self) -> SnapshotConfig:
            self.interactive = true
            return self

    # Environment configuration
    pub fn from_env() -> SnapshotConfig:
        var config = SnapshotConfig.default()

        # Check for CI environment
        if env.get("CI").is_some():
            config.update_snapshots = false

        # Check for update flag
        if env.get("SIMPLE_UPDATE_SNAPSHOTS").is_some():
            config.update_snapshots = true

        # Check for snapshot directory override
        if val Some(dir) = env.get("SIMPLE_SNAPSHOT_DIR"):
            config.snapshot_dir = dir

        return config
