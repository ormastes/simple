# Markdown Documentation Generator for BDD Specs
# Converts describe/context/it blocks into GitHub-compatible Markdown

use core.collections.{List, Dict}
use core.string.String

class MarkdownFormatter:
    output: String

    static fn new() -> MarkdownFormatter:
        return MarkdownFormatter(output: String.empty())

    fn format_describe(name: String, level: i32) -> String:
        val prefix = "#" * (level + 1)
        return f"{prefix} {name}\n\n"

    fn format_context(name: String, level: i32) -> String:
        val prefix = "#" * (level + 2)
        return f"{prefix} {name}\n\n"

    fn format_example(name: String, status: String, error: Option<String>) -> String:
        val icon = match status:
            "pass" => "✅"
            "fail" => "❌"
            "skip" => "⏭️"
            _ => "❓"

        var result = f"{icon} **{name}**\n\n"

        if val Some(err) = error:
            result = result + f"```\nError: {err}\n```\n\n"

        return result

    fn format_code_block(code: String, language: String) -> String:
        return f"```{language}\n{code}\n```\n\n"

# Convert spec results to Markdown documentation
fn format_spec_to_markdown(spec_results: Dict<String, Any>) -> String:
    val formatter = MarkdownFormatter.new()
    var output = String.empty()

    # Extract spec metadata
    val suite_name = spec_results.get("suite_name").unwrap_or("Test Suite")
    output = output + f"# {suite_name}\n\n"

    # Add timestamp
    if val Some(timestamp) = spec_results.get("timestamp"):
        output = output + f"*Generated: {timestamp}*\n\n"

    # Process describe blocks
    if val Some(describes) = spec_results.get("describe_blocks"):
        for describe in describes:
            output = output + formatter.format_describe(
                describe.get("description").unwrap_or(""),
                1
            )

            # Process contexts
            if val Some(contexts) = describe.get("contexts"):
                for context in contexts:
                    output = output + formatter.format_context(
                        context.get("description").unwrap_or(""),
                        2
                    )

                    # Process examples (it blocks)
                    if val Some(examples) = context.get("examples"):
                        for example in examples:
                            val status = example.get("status").unwrap_or("unknown")
                            val name = example.get("description").unwrap_or("")
                            val error = example.get("error")

                            output = output + formatter.format_example(name, status, error)

                            # Add code if available
                            if val Some(code) = example.get("code"):
                                output = output + formatter.format_code_block(code, "simple")

    # Add summary
    if val Some(summary) = spec_results.get("summary"):
        output = output + "\n---\n\n## Summary\n\n"
        val total = summary.get("total").unwrap_or(0)
        val passed = summary.get("passed").unwrap_or(0)
        val failed = summary.get("failed").unwrap_or(0)
        val skipped = summary.get("skipped").unwrap_or(0)

        output = output + f"- **Total:** {total} tests\n"
        output = output + f"- **Passed:** {passed} ✅\n"
        output = output + f"- **Failed:** {failed} ❌\n"
        output = output + f"- **Skipped:** {skipped} ⏭️\n"

    return output
