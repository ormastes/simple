/// Doctest Discovery
/// 
/// Discovers doctests from .spl, .md, and .sdt files

use parser::{DoctestExample, parse_spl_file, parse_sdt_file}

/// Discovery configuration
struct DiscoveryConfig:
    /// Paths to search for doctests
    search_paths: List[String]
    /// File patterns to include
    include_patterns: List[String]
    /// File patterns to exclude
    exclude_patterns: List[String]
    
    fn default() -> DiscoveryConfig:
        return DiscoveryConfig(
            search_paths: ["lib/", "src/", "doc/"],
            include_patterns: ["**/*.spl", "**/*.md", "**/test/doctest/**/*.sdt"],
            exclude_patterns: ["**/target/**", "**/build/**"]
        )

/// Discover all doctests in configured paths
fn discover_all(config: DiscoveryConfig = DiscoveryConfig.default()) -> List[DoctestExample]:
    examples = []
    
    for search_path in config.search_paths:
        if not path_exists(search_path):
            continue
        
        # Walk directory tree
        files = walk_directory(search_path, config.include_patterns, config.exclude_patterns)
        
        for file_path in files:
            file_examples = discover_file(file_path)
            examples.extend(file_examples)
    
    return examples

/// Discover doctests from a single file
fn discover_file(path: String) -> List[DoctestExample]:
    if path.ends_with(".spl"):
        return parse_spl_file(path)
    elif path.ends_with(".sdt"):
        return parse_sdt_file(path)
    elif path.ends_with(".md"):
        return parse_markdown_file(path)
    else:
        return []

/// Parse doctests from Markdown file
fn parse_markdown_file(path: String) -> List[DoctestExample]:
    content = read_file(path)
    examples = []
    
    # State machine to extract ```simple-doctest blocks
    lines = content.split("\n")
    in_block = False
    current_block = []
    block_start_line = 0
    
    for i, line in lines.enumerate():
        if line.starts_with("```simple-doctest"):
            in_block = True
            block_start_line = i + 2  # Line after fence
            current_block = []
        elif line.starts_with("```") and in_block:
            # End of code block
            in_block = False
            block_content = current_block.join("\n")
            block_examples = parse_docstring(block_content, source: path)
            
            # Adjust line numbers
            for ex in block_examples:
                ex.location.line += block_start_line
            
            examples.extend(block_examples)
            current_block = []
        elif in_block:
            current_block.push(line)
    
    return examples

/// Walk directory tree and return matching files
fn walk_directory(root: String, include_patterns: List[String], exclude_patterns: List[String]) -> List[String]:
    # TODO: Implement recursive directory walking with glob pattern matching
    # This will use std.io.walk_dir and std.path.matches_glob when available
    # For now, return empty list (stub)
    return []

/// Check if path exists
fn path_exists(path: String) -> Bool:
    # TODO: Use std.io.path_exists
    return False

/// Read file contents
fn read_file(path: String) -> String:
    # TODO: Use std.io.read_text_file
    return ""
