# Generate Runtime FFI Wrappers
#
# Directly invokes the FFI generator to create build/rust/ structure
# with wrappers for external libraries (bdwgc, etc.)

import app.ffi_gen.main as ffi_gen
import app.ffi_gen.rust_codegen
import app.ffi_gen.cargo_gen
import app.ffi_gen.builder

use app.io.mod (file_read, file_write, dir_create, cwd, print)

fn main() -> i64:
    print "Generating Runtime FFI wrappers..."
    print ""

    val project_root = cwd()

    # Read Rust config
    val rust_config = ffi_gen.read_rust_config(project_root)

    # Ensure build/rust/ environment exists
    val env_result = ffi_gen.ensure_rust_env(project_root, rust_config, true)
    if env_result != 0:
        return env_result

    print "✓ Rust environment ready"
    print ""

    # Generate RuntimeValue FFI from spec
    val spec_path = "src/app/ffi_gen/specs/runtime_value.spl"

    print "Generating from spec: {spec_path}"

    val opts = ffi_gen.CliOptions(
        input_file: spec_path,
        output_dir: "build/rust/ffi_gen",
        dry_run: false,
        verbose: true,
        lang_filter: "",
        clean: false,
        gen_intern: true,
        show_help: false
    )

    # Generate intern FFI
    val result = ffi_gen.generate_intern(spec_path, opts)

    if result == 0:
        print ""
        print "✓ FFI generation complete!"
        print "  Generated files in build/rust/ffi_gen/"
    else:
        print ""
        print "✗ FFI generation failed"

    result
