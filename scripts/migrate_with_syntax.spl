"""
Migration Script: Convert .with({...}) to .with {...}

This script converts the old parenthesized syntax to the preferred no-paren syntax:
  Before: template.with({"key": "value"})
  After:  template.with {"key": "value"}

Usage:
  simple scripts/migrate_with_syntax.spl <file_or_directory>
"""

import std.io
import std.fs

# Pattern to match: .with({ followed by content and closing })
# We need to be careful with nested braces

fn migrate_with_syntax(content: String) -> String:
    var result = content
    var i = 0

    while i < result.len():
        # Look for ".with({"
        val pattern = ".with({"
        val idx = result.find(pattern, i)

        if idx < 0:
            break

        # Find matching closing })"
        val start = idx + pattern.len() - 1  # Position of the opening {
        var depth = 1
        var j = start + 1

        while j < result.len() and depth > 0:
            if result.char_at(j) == "{":
                depth = depth + 1
            else if result.char_at(j) == "}":
                depth = depth - 1
            j = j + 1

        # j now points right after the closing }
        # Check if next char is )
        if j < result.len() and result.char_at(j) == ")":
            # Replace .with({ with .with {
            # and remove the trailing )
            val before = result.slice(0, idx)
            val dict_content = result.slice(start, j)  # includes { and }
            val after = result.slice(j + 1, result.len())

            result = before + ".with " + dict_content + after
            i = idx + 6 + (j - start)  # Skip past the replacement
        else:
            i = idx + 1

    result


fn process_file(path: String):
    print("Processing: {path}")
    val content = fs.read_file(path)
    val migrated = migrate_with_syntax(content)

    if content != migrated:
        fs.write_file(path, migrated)
        print("  Updated!")
    else:
        print("  No changes needed")


fn process_directory(path: String):
    val entries = fs.list_dir(path)

    for entry in entries:
        val full_path = "{path}/{entry}"

        if fs.is_dir(full_path):
            process_directory(full_path)
        else if entry.ends_with(".spl") or entry.ends_with(".simple"):
            process_file(full_path)


fn main():
    val args = std.env.args()

    if args.len() < 2:
        print("Usage: simple scripts/migrate_with_syntax.spl <file_or_directory>")
        return 1

    val target = args[1]

    if fs.is_dir(target):
        process_directory(target)
    else:
        process_file(target)

    print("Migration complete!")
    0

main = main()
