#!/usr/bin/env simple
# Setup Windows VM for Simple Testing
#
# Guides the user through setting up a Windows 11 evaluation VM
# under QEMU for cross-platform testing.
#
# Usage: bin/release/simple scripts/setup_windows_vm.spl

extern fn rt_file_exists(path: text) -> bool

use app.io.file_shell.{shell, shell_output, file_write}

fn main():
    val home = shell_output("echo $HOME").trim()
    val vm_dir = "{home}/vms/windows"

    print "======================================"
    print "Windows VM Setup for Simple Testing"
    print "======================================"
    print ""

    # Step 1: Check QEMU
    print "Step 1: Verify QEMU Installation"
    print "--------------------------------------"
    val qemu_check = shell_output("which qemu-system-x86_64 2>/dev/null")
    if qemu_check == "":
        print "Error: QEMU not found"
        print "Install: sudo apt-get install -y qemu-system-x86 qemu-utils"
        return
    print "QEMU available"
    print ""

    # Step 2: Create VM directory
    print "Step 2: Create VM Directory"
    print "--------------------------------------"
    shell("mkdir -p {vm_dir}")
    print "VM directory: {vm_dir}"
    print ""

    # Step 3: Download instructions
    print "Step 3: Download Windows 11 Eval VM"
    print "--------------------------------------"
    val image_path = "{vm_dir}/windows11.qcow2"
    if rt_file_exists(image_path):
        print "Image already exists: {image_path}"
    else:
        print "Windows evaluation VMs cannot be auto-downloaded."
        print ""
        print "Manual steps:"
        print "  1. Visit: https://developer.microsoft.com/en-us/windows/downloads/virtual-machines/"
        print "  2. Download the 'Windows 11 development environment'"
        print "  3. Convert to qcow2:"
        print "     qemu-img convert -f vhdx -O qcow2 WinDev*.vhdx {image_path}"
        print ""
        print "  Or use a Windows ISO:"
        print "  1. Download from: https://www.microsoft.com/en-us/evalcenter/evaluate-windows-11-enterprise"
        print "  2. Create disk: qemu-img create -f qcow2 {image_path} 64G"
        print "  3. Boot installer: qemu-system-x86_64 -m 8G -cdrom Win11.iso -drive file={image_path},format=qcow2 -boot d"
    print ""

    # Step 4: Create start script
    print "Step 4: Create VM Start Script"
    print "--------------------------------------"
    var script_content = "#!/bin/bash\n"
    script_content = script_content + "# Start Windows VM with SSH forwarding\n"
    script_content = script_content + "VM_DIR=\"$(dirname \"$0\")\"\n"
    script_content = script_content + "cd \"$VM_DIR\"\n"
    script_content = script_content + "if [ -f /tmp/windows-qemu.pid ]; then\n"
    script_content = script_content + "  PID=$(cat /tmp/windows-qemu.pid)\n"
    script_content = script_content + "  if kill -0 $PID 2>/dev/null; then\n"
    script_content = script_content + "    echo \"Windows VM already running (PID: $PID)\"\n"
    script_content = script_content + "    exit 0\n"
    script_content = script_content + "  fi\n"
    script_content = script_content + "fi\n"
    script_content = script_content + "echo 'Starting Windows VM...'\n"
    script_content = script_content + "qemu-system-x86_64 \\\n"
    script_content = script_content + "  -machine type=q35,accel=kvm:tcg \\\n"
    script_content = script_content + "  -cpu host -smp 4 -m 8G \\\n"
    script_content = script_content + "  -drive file=windows11.qcow2,if=virtio,format=qcow2 \\\n"
    script_content = script_content + "  -netdev user,id=net0,hostfwd=tcp::2223-:22 \\\n"
    script_content = script_content + "  -device virtio-net-pci,netdev=net0 \\\n"
    script_content = script_content + "  -display none -daemonize -pidfile /tmp/windows-qemu.pid\n"
    script_content = script_content + "sleep 3\n"
    script_content = script_content + "if [ -f /tmp/windows-qemu.pid ]; then\n"
    script_content = script_content + "  echo \"Windows VM started (PID: $(cat /tmp/windows-qemu.pid))\"\n"
    script_content = script_content + "  echo 'SSH: ssh -p 2223 user@localhost'\n"
    script_content = script_content + "else\n"
    script_content = script_content + "  echo 'Failed to start VM'\n"
    script_content = script_content + "  exit 1\n"
    script_content = script_content + "fi\n"
    val start_script = "{vm_dir}/start-windows.sh"
    file_write(start_script, script_content)
    shell("chmod +x {start_script}")
    print "Created: {start_script}"
    print ""

    # Summary
    print "======================================"
    print "Windows VM Setup Guide Complete"
    print "======================================"
    print ""
    print "After installing Windows in the VM:"
    print ""
    print "  1. Install OpenSSH Server:"
    print "     Settings > Apps > Optional Features > Add OpenSSH Server"
    print "     Then in PowerShell (Admin):"
    print "       Start-Service sshd"
    print "       Set-Service -Name sshd -StartupType Automatic"
    print ""
    print "  2. Install MinGW-w64 (for gcc):"
    print "     Download from: https://www.mingw-w64.org/"
    print "     Or use MSYS2: https://www.msys2.org/"
    print "     In MSYS2: pacman -S mingw-w64-x86_64-gcc"
    print ""
    print "  3. Add gcc to PATH in Windows"
    print ""
    print "  4. Test: bin/release/simple scripts/test_windows_vm.spl"
    print ""
