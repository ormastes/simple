# Test Dictionary Semantics
# Verifies the exact pattern used in driver.spl works correctly

class Context:
    modules: Dict<text, i32>

fn test_copy_modify_reassign():
    print "=== Test: Copy-Modify-Reassign Pattern ==="
    val ctx = Context(modules: {})

    print "Initial count: {ctx.modules.keys().len()}"

    # Exact pattern from driver.spl line 468-470
    var modules = ctx.modules
    modules["test"] = 42
    ctx.modules = modules

    print "After mutation count: {ctx.modules.keys().len()}"
    print "Value check: {ctx.modules['test']}"

    if ctx.modules.keys().len() == 1:
        print "✓ PASS: Pattern works correctly"
        return true
    else:
        print "✗ FAIL: Pattern doesn't work"
        return false

fn test_direct_mutation():
    print ""
    print "=== Test: Direct Mutation ==="
    val ctx = Context(modules: {})

    print "Initial count: {ctx.modules.keys().len()}"

    # Direct mutation
    ctx.modules["test"] = 42

    print "After mutation count: {ctx.modules.keys().len()}"

    if ctx.modules.keys().len() == 1:
        print "✓ PASS: Direct mutation works"
        return true
    else:
        print "✗ FAIL: Direct mutation doesn't work"
        return false

fn main():
    var pass1 = test_copy_modify_reassign()
    var pass2 = test_direct_mutation()

    print ""
    if pass1 and pass2:
        print "=== ALL TESTS PASSED ==="
        print "Dictionary semantics are NOT the issue."
    else:
        print "=== TESTS FAILED ==="
        print "Dictionary semantics issue confirmed."
