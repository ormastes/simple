#!/usr/bin/env simple
# Test JSON parser implementation

import std.json.*

# Test 1: Parse primitive values
print "=== Test 1: Parsing Primitives ==="
val json_null = JsonValue.parse("null")
print "Parsed null: {json_null.ok.?}"

val json_bool = JsonValue.parse("true")
print "Parsed bool: {json_bool.ok.?}"

val json_number = JsonValue.parse("42.5")
print "Parsed number: {json_number.ok.?}"

val json_string = JsonValue.parse("\"hello world\"")
print "Parsed string: {json_string.ok.?}"

# Test 2: Parse array
print "\n=== Test 2: Parsing Arrays ==="
val json_array = JsonValue.parse("[1, 2, 3, 4, 5]")
match json_array:
    case Result.Ok(arr):
        print "Parsed array successfully"
        print "Serialized: {arr.serialize()}"
    case Result.Err(e):
        print "Error: {e}"

# Test 3: Parse object
print "\n=== Test 3: Parsing Objects ==="
val json_obj = JsonValue.parse("{\"name\": \"Alice\", \"age\": 30, \"active\": true}")
match json_obj:
    case Result.Ok(obj):
        print "Parsed object successfully"
        print "Pretty printed:\n{obj.pretty()}"

        # Access fields
        if val Some(name) = obj.get("name"):
            if val Some(name_str) = name.as_string():
                print "Name: {name_str}"

        if val Some(age) = obj.get("age"):
            if val Some(age_num) = age.as_number():
                print "Age: {age_num}"
    case Result.Err(e):
        print "Error: {e}"

# Test 4: Error handling
print "\n=== Test 4: Error Handling ==="
val json_invalid = JsonValue.parse("{invalid json}")
match json_invalid:
    case Result.Ok(_):
        print "Should not succeed!"
    case Result.Err(e):
        print "Correctly caught error"

# Test 5: Builder pattern
print "\n=== Test 5: JSON Builder ==="
val built = JsonBuilder.new()
    .put_string("name", "Bob")
    .put_number("age", 25.0)
    .put_bool("verified", true)
    .build()

print "Built object: {built.serialize()}"

# Test 6: Array builder
print "\n=== Test 6: JSON Array Builder ==="
val arr = JsonArray.new()
    .push_number(1.0)
    .push_number(2.0)
    .push_number(3.0)
    .push_string("four")
    .build()

print "Built array: {arr.serialize()}"

# Test 7: parse_int utility
print "\n=== Test 7: parse_int Utility ==="
if val Some(num) = parse_int("123"):
    print "Parsed 123 as: {num}"

if parse_int("not a number").?:
    print "Should not parse!"
else:
    print "Correctly failed to parse 'not a number'"

print "\n=== All tests complete! ==="
