#!/usr/bin/env simple
# Cross-Platform Multi-File Link Test Orchestrator
#
# Runs all platform tests, reporting pass/fail/skip for each.
# Gracefully skips tests when prerequisites are missing.
#
# Usage: bin/release/simple scripts/test_cross_platform_all.spl

extern fn rt_file_exists(path: text) -> bool

use app.io.file_shell.{shell, shell_output}

fn run_test(name: text, script: text) -> text:
    print "--- {name} ---"
    val (out, err, exit_code) = shell("bin/release/simple {script}")
    if out != "":
        print out
    if exit_code == 0:
        # Check if test was skipped
        if out.contains("SKIP:"):
            print "[{name}] SKIP"
            return "skip"
        print "[{name}] PASS"
        return "pass"
    print "[{name}] FAIL (exit code {exit_code})"
    if err != "":
        print err
    "fail"

fn main() -> i64:
    print "=========================================="
    print "Cross-Platform Multi-File Link Tests"
    print "=========================================="
    print ""

    var total = 0
    var passed = 0
    var failed = 0
    var skipped = 0

    # Test 1: Linux native (existing tests)
    print "--- Linux Native ---"
    total = total + 1
    val gcc_check = shell_output("which gcc 2>/dev/null")
    if gcc_check == "":
        print "[Linux Native] SKIP: gcc not found"
        skipped = skipped + 1
    else:
        val (out, err, exit_code) = shell("bin/simple test test/compiler/native_compile_spec.spl 2>&1")
        if out != "":
            print out
        if exit_code == 0:
            print "[Linux Native] PASS"
            passed = passed + 1
        else:
            print "[Linux Native] FAIL"
            failed = failed + 1
    print ""

    # Test 2: FreeBSD QEMU
    total = total + 1
    val result_freebsd = run_test("FreeBSD QEMU", "scripts/test_freebsd_qemu.spl")
    if result_freebsd == "pass":
        passed = passed + 1
    elif result_freebsd == "skip":
        skipped = skipped + 1
    else:
        failed = failed + 1
    print ""

    # Test 3: Windows MinGW cross-compile
    total = total + 1
    val result_mingw = run_test("Windows MinGW", "scripts/test_windows_mingw.spl")
    if result_mingw == "pass":
        passed = passed + 1
    elif result_mingw == "skip":
        skipped = skipped + 1
    else:
        failed = failed + 1
    print ""

    # Test 4: Windows VM
    total = total + 1
    val result_winvm = run_test("Windows VM", "scripts/test_windows_vm.spl")
    if result_winvm == "pass":
        passed = passed + 1
    elif result_winvm == "skip":
        skipped = skipped + 1
    else:
        failed = failed + 1
    print ""

    # Test 5: macOS VM
    total = total + 1
    val result_macos = run_test("macOS VM", "scripts/test_macos_qemu.spl")
    if result_macos == "pass":
        passed = passed + 1
    elif result_macos == "skip":
        skipped = skipped + 1
    else:
        failed = failed + 1
    print ""

    # Summary
    print "=========================================="
    print "Cross-Platform Test Summary"
    print "=========================================="
    print ""
    print "| Test             | Result |"
    print "|------------------|--------|"
    print "| Linux Native     | {if gcc_check != "": if failed == 0: "PASS" else: "FAIL" else: "SKIP"} |"
    print "| FreeBSD QEMU     | {result_freebsd} |"
    print "| Windows MinGW    | {result_mingw} |"
    print "| Windows VM       | {result_winvm} |"
    print "| macOS VM         | {result_macos} |"
    print ""
    print "Total: {total}, Passed: {passed}, Failed: {failed}, Skipped: {skipped}"
    print ""

    if failed > 0:
        return 1
    0
