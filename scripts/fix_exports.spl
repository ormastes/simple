# Fix Exports - Add desugared function exports

use std.spec

extern fn rt_file_read_text(path: text) -> text
extern fn rt_file_write_text(path: text, content: text) -> bool

describe "Fix Exports":
    it "adds exports for LazySeq desugared functions":
        val path = "src/app/interpreter.lazy/lazy_seq.spl"
        val source_opt = rt_file_read_text(path)
        val source = source_opt ?? ""

        check(source != "")

        # Find all LazySeq__ functions
        val desugared_fns = [
            "LazySeq__empty",
            "LazySeq__single",
            "LazySeq__cons",
            "LazySeq__from_array",
            "LazySeq__from_array_helper",
            "LazySeq__iterate",
            "LazySeq__unfold",
            "LazySeq__generate",
            "LazySeq__generate_helper",
            "LazySeq__repeat_val",
            "LazySeq__repeat_n",
            "SeqIterator__new",
        ]

        # Build export statement
        var export_line = "export " + desugared_fns.join(", ")
        export_line = export_line + "\n"

        # Find the existing export lines and add after them
        val lines = source.split("\n")
        var result_lines: [text] = []
        var added_export = false

        for line in lines:
            result_lines.push(line)

            # Add new export after the existing exports
            if not added_export and line.starts_with("export ") and line.contains("range_lazy"):
                result_lines.push(export_line)
                added_export = true

        val result = result_lines.join("\n")

        if rt_file_write_text(path, result):
            print "✓ Added exports for desugared functions"
            check(true)
        else:
            print "✗ Failed to write file"
            check(false)
