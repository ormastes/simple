#!/usr/bin/env simple
# Safe Bootstrap Runner with Timeout Protection
#
# Usage:
#   ./scripts/bootstrap-safe.spl [--timeout=SECONDS] [--retries=N]

use app.build.bootstrap_safe (run_safe_bootstrap, TimeoutConfig)
use app.io.mod (cli_get_args)

fn main():
    val args = cli_get_args()

    # Parse command line arguments
    var timeout_sec = 300
    var max_retries = 3
    var kill_on_timeout = true

    for arg in args:
        if arg.starts_with("--timeout="):
            val value_str = arg.substring(10, arg.len())
            timeout_sec = int(value_str)
        elif arg.starts_with("--retries="):
            val value_str = arg.substring(10, arg.len())
            max_retries = int(value_str)
        elif arg == "--no-kill":
            kill_on_timeout = false
        elif arg == "--help":
            print_help()
            return ()

    # Create configuration
    val config = TimeoutConfig(
        stage_timeout_sec: timeout_sec,
        max_retries: max_retries,
        kill_on_timeout: kill_on_timeout
    )

    # Run safe bootstrap
    val result = run_safe_bootstrap(config)

    # Report final statistics
    print ""
    print "═══════════════════════════════════════════════════════════════════"
    print "Final Statistics:"
    print "═══════════════════════════════════════════════════════════════════"
    print "  Success:        {result.inner.overall_success}"
    print "  Timeouts:       {result.timeouts}"
    print "  Retries:        {result.retries}"
    print "  Total duration: {result.total_duration_ms}ms"
    print ""

fn print_help():
    print "Safe Bootstrap Runner with Timeout Protection"
    print ""
    print "Usage:"
    print "  ./scripts/bootstrap-safe.spl [options]"
    print ""
    print "Options:"
    print "  --timeout=SECONDS  Timeout per stage (default: 300)"
    print "  --retries=N        Max retry attempts (default: 3)"
    print "  --no-kill          Don't kill on timeout (default: kill)"
    print "  --help             Show this help message"
    print ""
    print "Description:"
    print "  Runs the 3-stage bootstrap with timeout protection to handle"
    print "  Cranelift hang bugs. If a stage hangs, it will be retried up"
    print "  to the specified number of times."
    print ""
    print "Examples:"
    print "  # Default timeout (5 minutes per stage, 3 retries):"
    print "  ./scripts/bootstrap-safe.spl"
    print ""
    print "  # Custom timeout (10 minutes per stage):"
    print "  ./scripts/bootstrap-safe.spl --timeout=600"
    print ""
    print "  # More retries:"
    print "  ./scripts/bootstrap-safe.spl --retries=5"
