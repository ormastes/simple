#!/usr/bin/env simple
# Standalone duplication checker for stdlib utils files
# Works around import issues by inlining necessary functions

use app.io.mod.{shell, file_read, file_write}

fn main():
    print "Collecting *_utils.spl files from src/lib/..."

    val result = shell("find src/lib -name '*_utils.spl' -type f")
    val output = result.stdout
    val lines = output.split("\n")

    var files = []
    for line in lines:
        val trimmed = line.trim()
        if trimmed.len() > 0:
            files = files + [trimmed]

    print "Found {files.len()} utility files"
    print ""

    # Write files list for manual duplication check
    var file_list = "# stdlib utility files for duplication analysis\n\n"
    for f in files:
        file_list = file_list + f + "\n"

    file_write("doc/analysis/stdlib_utils_files.txt", file_list)
    print "Wrote file list to: doc/analysis/stdlib_utils_files.txt"

    # Now call duplicate-check on each individual file
    # Since bulk scanning fails, we'll generate a report differently
    print ""
    print "Attempting duplication scan..."
    print "Note: Due to runtime limitations, using alternative approach"
    print ""

    # Create a concatenated version for manual analysis
    var all_content = ""
    var file_sizes = []

    for f in files:
        val content = file_read(f)
        all_content = all_content + "\n# FILE: {f}\n# Size: {content.len()} bytes\n\n"
        all_content = all_content + content + "\n\n"
        file_sizes = file_sizes + ["{f}: {content.len()} bytes"]

    file_write("doc/analysis/stdlib_utils_concatenated.spl", all_content)
    print "Wrote concatenated source to: doc/analysis/stdlib_utils_concatenated.spl"

    # Write summary
    var summary = "# Standard Library Utility Files - Duplication Analysis\n\n"
    summary = summary + "## Overview\n\n"
    summary = summary + "Total utility files analyzed: {files.len()}\n\n"
    summary = summary + "## Files\n\n"
    for fsize in file_sizes:
        summary = summary + "- {fsize}\n"

    summary = summary + "\n## Analysis Approach\n\n"
    summary = summary + "Due to runtime import system limitations, automated duplication\n"
    summary = summary + "detection encountered errors. Manual analysis recommended using:\n\n"
    summary = summary + "1. The concatenated source file for grep/search\n"
    summary = summary + "2. Individual file inspection for pattern recognition\n"
    summary = summary + "3. Simple text-based similarity metrics\n\n"

    summary = summary + "## Common Patterns to Look For\n\n"
    summary = summary + "- Iteration boilerplate (while i < len loops)\n"
    summary = summary + "- Validation patterns (nil checks, range checks)\n"
    summary = summary + "- Error handling (Option/Result patterns)\n"
    summary = summary + "- Collection operations (map, filter, reduce equivalents)\n"
    summary = summary + "- Helper function duplications\n\n"

    file_write("doc/analysis/phase1_stdlib_utils_duplicates.md", summary)
    print "Wrote initial analysis to: doc/analysis/phase1_stdlib_utils_duplicates.md"

    print ""
    print "Files for manual review:"
    print "  - doc/analysis/stdlib_utils_files.txt"
    print "  - doc/analysis/stdlib_utils_concatenated.spl"
    print "  - doc/analysis/phase1_stdlib_utils_duplicates.md"
