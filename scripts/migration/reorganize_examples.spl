#!/usr/bin/env simple
# Examples Folder Reorganization Script
# Executes the migration plan from doc/plan/examples_reorganization_2026-02-16.md

use app.io.mod.{shell, file_exists, dir_exists, file_read, file_write}

fn main():
    print "Starting examples/ reorganization..."

    # Step 1: Create new directory structure
    create_directory_structure()

    # Step 2: Move files to new locations
    migrate_getting_started()
    migrate_language_features()
    migrate_concurrency()
    migrate_data_formats()
    migrate_stdlib()
    migrate_io()
    migrate_ml()
    migrate_gpu()
    migrate_embedded()
    migrate_tooling()
    migrate_advanced()
    migrate_experiments()
    migrate_projects()

    # Step 3: Delete duplicates and obsolete files
    delete_duplicates()

    # Step 4: Clean up empty directories
    cleanup_empty_dirs()

    print "Migration complete!"
    print "Run: jj status to review changes"

fn create_directory_structure():
    print "\n[1/4] Creating directory structure..."

    val dirs = [
        "examples/01_getting_started",
        "examples/02_language_features/blocks",
        "examples/02_language_features/polymorphism",
        "examples/02_language_features/aop",
        "examples/02_language_features/syntax",
        "examples/03_concurrency",
        "examples/04_data_formats",
        "examples/05_stdlib",
        "examples/06_io/file",
        "examples/06_io/network",
        "examples/06_io/graphics",
        "examples/06_io/multimedia",
        "examples/07_ml/pure_nn/01_basics",
        "examples/07_ml/pure_nn/02_layers",
        "examples/07_ml/pure_nn/03_training",
        "examples/07_ml/pure_nn/04_complete",
        "examples/07_ml/pure_nn/runtime_compatible",
        "examples/08_gpu/cuda",
        "examples/08_gpu/patterns",
        "examples/08_gpu/pipelines",
        "examples/09_embedded/baremetal",
        "examples/09_embedded/qemu",
        "examples/09_embedded/vhdl",
        "examples/10_tooling/debugging",
        "examples/10_tooling/testing",
        "examples/10_tooling/backends",
        "examples/10_tooling/libraries",
        "examples/11_advanced/optimization",
        "examples/11_advanced/mir",
        "examples/11_advanced/type_inference",
        "examples/experiments/autograd",
        "examples/experiments/mutability",
        "examples/experiments/runtime",
        "examples/projects"
    ]

    for dir in dirs:
        shell("mkdir -p {dir}")

fn migrate_getting_started():
    print "\n[2/4] Migrating 01_getting_started..."

    # Move existing files
    mv("examples/hello_native.spl", "examples/01_getting_started/hello_native.spl")
    mv("examples/hello_native.smf", "examples/01_getting_started/hello_native.smf")

fn migrate_language_features():
    print "Migrating 02_language_features..."

    # Blocks
    mv("examples/blocks/custom_blocks_examples.spl", "examples/02_language_features/blocks/custom_blocks.spl")
    mv("examples/blocks/user_defined_block_demo.spl", "examples/02_language_features/blocks/user_defined_blocks.spl")

    # Polymorphism
    mv("examples/language_features/static_polymorphism.spl", "examples/02_language_features/polymorphism/static_polymorphism.spl")
    mv("examples/language_features/static_polymorphism.smf", "examples/02_language_features/polymorphism/static_polymorphism.smf")

    # AOP
    mv("examples/language_features/aop_demo.spl", "examples/02_language_features/aop/aspect_oriented.spl")
    mv("examples/language_features/aop_demo.smf", "examples/02_language_features/aop/aspect_oriented.smf")

    # Execution context & lean blocks
    mv("examples/language_features/execution_context_demo.spl", "examples/02_language_features/execution_context.spl")
    mv("examples/language_features/lean_block_demo.spl", "examples/02_language_features/lean_blocks.spl")
    mv("examples/language_features/lean_block_demo.smf", "examples/02_language_features/lean_blocks.smf")

    # Parser syntax examples
    mv("examples/parser/async_syntax_example.spl", "examples/02_language_features/syntax/async_syntax.spl")
    mv("examples/parser/attribute_syntax_example.spl", "examples/02_language_features/syntax/attribute_syntax.spl")
    mv("examples/parser/spawn_syntax_example.spl", "examples/02_language_features/syntax/spawn_syntax.spl")

fn migrate_concurrency():
    print "Migrating 03_concurrency..."

    mv("examples/async_demo.spl", "examples/03_concurrency/async_basics.spl")
    mv("examples/async_structure_demo.spl", "examples/03_concurrency/async_structure.spl")
    mv("examples/actors/actor_basics.spl", "examples/03_concurrency/actor_basics.spl")
    mv("examples/language_features/concurrency_modes.spl", "examples/03_concurrency/concurrency_modes.spl")

fn migrate_data_formats():
    print "Migrating 04_data_formats..."

    mv("examples/sdn_parser_usage.spl", "examples/04_data_formats/sdn_parser.spl")
    mv("examples/cbor_demo.spl", "examples/04_data_formats/cbor_encoding.spl")

fn migrate_stdlib():
    print "Migrating 05_stdlib..."

    mv("examples/platform_library_example.spl", "examples/05_stdlib/platform_library.spl")

fn migrate_io():
    print "Migrating 06_io..."

    # File I/O
    mv("examples/file_io/file_staging.spl", "examples/06_io/file/file_staging.spl")
    mv("examples/file_io/file_staging_parallel.spl", "examples/06_io/file/file_staging_parallel.spl")

    # Network
    mv("examples/http_demo.spl", "examples/06_io/network/http_client.spl")

    # Graphics
    mv("examples/graphics2d_demo.spl", "examples/06_io/graphics/graphics2d.spl")
    mv("examples/window_demo.spl", "examples/06_io/graphics/window_creation.spl")

    # Multimedia
    mv("examples/audio_demo.spl", "examples/06_io/multimedia/audio_playback.spl")
    mv("examples/gamepad_demo.spl", "examples/06_io/multimedia/gamepad_input.spl")

fn migrate_ml():
    print "Migrating 07_ml..."

    # Pure NN - Basics
    mv("examples/pure_nn/autograd_example.spl", "examples/07_ml/pure_nn/01_basics/autograd.spl")
    mv("examples/pure_nn/simple_regression.spl", "examples/07_ml/pure_nn/01_basics/simple_regression.spl")
    mv("examples/pure_nn/xor_example.spl", "examples/07_ml/pure_nn/01_basics/xor_minimal.spl")
    mv("examples/pure_nn/xor_example.smf", "examples/07_ml/pure_nn/01_basics/xor_minimal.smf")

    # Pure NN - Layers
    mv("examples/pure_nn/nn_layers_example.spl", "examples/07_ml/pure_nn/02_layers/nn_layers.spl")
    mv("examples/pure_nn/training_demo.spl", "examples/07_ml/pure_nn/02_layers/training_infrastructure.spl")

    # Pure NN - Training
    mv("examples/pure_nn/xor_training_example.spl", "examples/07_ml/pure_nn/03_training/xor_training.spl")
    mv("examples/pure_nn/iris_classification.spl", "examples/07_ml/pure_nn/03_training/iris_classification.spl")

    # Pure NN - Complete
    mv("examples/pure_nn/complete_demo.spl", "examples/07_ml/pure_nn/04_complete/full_pipeline.spl")

    # Pure NN - Runtime compatible
    mv("examples/pure_nn/autograd_example_runtime.spl", "examples/07_ml/pure_nn/runtime_compatible/autograd_runtime.spl")
    mv("examples/pure_nn/nn_layers_runtime.spl", "examples/07_ml/pure_nn/runtime_compatible/nn_layers_runtime.spl")
    mv("examples/pure_nn/xor_training_runtime.spl", "examples/07_ml/pure_nn/runtime_compatible/xor_training_runtime.spl")
    mv("examples/pure_nn/complete_demo_runtime.spl", "examples/07_ml/pure_nn/runtime_compatible/full_pipeline_runtime.spl")
    mv("examples/pure_nn/simple_regression_runtime.spl", "examples/07_ml/pure_nn/runtime_compatible/simple_regression_runtime.spl")
    mv("examples/pure_nn/data_utils_runtime.spl", "examples/07_ml/pure_nn/runtime_compatible/data_utils_runtime.spl")
    mv("examples/pure_nn/minibatch_training_runtime.spl", "examples/07_ml/pure_nn/runtime_compatible/minibatch_sgd_runtime.spl")
    mv("examples/pure_nn/README_RUNTIME_COMPATIBLE.md", "examples/07_ml/pure_nn/runtime_compatible/README_RUNTIME.md")

    # Torch - keep existing structure, just move the directory
    shell("mv examples/torch examples/07_ml/torch")

fn migrate_gpu():
    print "Migrating 08_gpu..."

    # CUDA
    mv("examples/cuda/basic.spl", "examples/08_gpu/cuda/basic.spl")
    mv("examples/cuda/basic_working.spl", "examples/08_gpu/cuda/vectorized.spl")
    mv("examples/cuda/simple_demo.spl", "examples/08_gpu/cuda/simple_demo.spl")

    # Patterns
    mv("examples/gpu_patterns/device_user_enum_demo.spl", "examples/08_gpu/patterns/device_enum.spl")
    mv("examples/gpu_patterns/enum_as_index_demo.spl", "examples/08_gpu/patterns/enum_as_index.spl")
    mv("examples/gpu_patterns/gpu_type_inference_demo.spl", "examples/08_gpu/patterns/type_inference.spl")
    mv("examples/gpu_patterns/user_gpu_enum_demo.spl", "examples/08_gpu/patterns/user_gpu_enum.spl")

    # Pipelines
    mv("examples/gpu/async_pipeline.spl", "examples/08_gpu/pipelines/async_pipeline.spl")
    mv("examples/gpu/training_pipeline.spl", "examples/08_gpu/pipelines/training_pipeline.spl")
    mv("examples/gpu/context_basic.spl", "examples/08_gpu/pipelines/context_basic.spl")
    mv("examples/gpu/runtime_example.spl", "examples/08_gpu/pipelines/runtime_example.spl")
    mv("examples/gpu/test_simple.spl", "examples/08_gpu/pipelines/test_simple.spl")

fn migrate_embedded():
    print "Migrating 09_embedded..."

    # Baremetal - move entire directory
    shell("mv examples/baremetal examples/09_embedded/baremetal")

    # QEMU
    mv("examples/qemu/unified_runner_example.spl", "examples/09_embedded/qemu/unified_runner.spl")

    # VHDL - move entire directory
    shell("mv examples/vhdl examples/09_embedded/vhdl")

fn migrate_tooling():
    print "Migrating 10_tooling..."

    # Debugging - move directory
    shell("mv examples/debugging examples/10_tooling/debugging")

    # Testing
    mv("examples/testing/test_attributes_example.spl", "examples/10_tooling/testing/test_attributes.spl")

    # Backends
    mv("examples/backend_switching.spl", "examples/10_tooling/backends/backend_switching.spl")
    mv("examples/jit_demo.spl", "examples/10_tooling/backends/jit_compiler.spl")
    mv("examples/interpreter_demo.spl", "examples/10_tooling/backends/interpreter_modes.spl")
    mv("examples/interpreter_demo.smf", "examples/10_tooling/backends/interpreter_modes.smf")
    mv("examples/pure_runtime_demo.spl", "examples/10_tooling/backends/pure_runtime.spl")
    mv("examples/pure_runtime_demo.smf", "examples/10_tooling/backends/pure_runtime.smf")
    mv("examples/pure_simple_demo.spl", "examples/10_tooling/backends/pure_simple.spl")
    mv("examples/pure_simple_demo.smf", "examples/10_tooling/backends/pure_simple.smf")
    mv("examples/real_impl_demo.spl", "examples/10_tooling/backends/real_impl.spl")
    mv("examples/real_impl_demo.smf", "examples/10_tooling/backends/real_impl.smf")
    mv("examples/unified_execution_demo.spl", "examples/10_tooling/backends/unified_execution.spl")

    # Libraries - move directory
    shell("mv examples/lib_smf examples/10_tooling/libraries")

fn migrate_advanced():
    print "Migrating 11_advanced..."

    # Optimization
    mv("examples/opt_before.spl", "examples/11_advanced/optimization/opt_before.spl")
    mv("examples/opt_after.spl", "examples/11_advanced/optimization/opt_after.spl")

    # MIR
    mv("examples/test_mir_json_simple.spl", "examples/11_advanced/mir/mir_json.spl")
    mv("examples/test_mir_serialization.spl", "examples/11_advanced/mir/mir_serialization.spl")

    # Type inference
    mv("examples/type_inference_demo.spl", "examples/11_advanced/type_inference/type_inference_demo.spl")
    mv("examples/type_inference_demo.smf", "examples/11_advanced/type_inference/type_inference_demo.smf")

fn migrate_experiments():
    print "Migrating experiments..."

    # Autograd experiments
    mv("examples/test_autograd.spl", "examples/experiments/autograd/test_autograd.spl")
    mv("examples/test_autograd.smf", "examples/experiments/autograd/test_autograd.smf")
    mv("examples/test_autograd_debug.spl", "examples/experiments/autograd/test_autograd_debug.spl")
    mv("examples/test_autograd_debug.smf", "examples/experiments/autograd/test_autograd_debug.smf")
    mv("examples/test_autograd_global.spl", "examples/experiments/autograd/test_autograd_global.spl")
    mv("examples/test_autograd_manual.spl", "examples/experiments/autograd/test_autograd_manual.spl")
    mv("examples/test_autograd_manual.smf", "examples/experiments/autograd/test_autograd_manual.smf")
    mv("examples/test_autograd_store.spl", "examples/experiments/autograd/test_autograd_store.spl")
    mv("examples/test_jit_autograd.spl", "examples/experiments/autograd/test_jit_autograd.spl")
    mv("examples/test_jit_autograd.smf", "examples/experiments/autograd/test_jit_autograd.smf")

    # Mutability experiments
    mv("examples/test_mutability.spl", "examples/experiments/mutability/test_mutability.spl")
    mv("examples/test_mutability.smf", "examples/experiments/mutability/test_mutability.smf")
    mv("examples/test_reference.spl", "examples/experiments/mutability/test_reference.spl")
    mv("examples/test_reference.smf", "examples/experiments/mutability/test_reference.smf")
    mv("examples/test_array_mutability.spl", "examples/experiments/mutability/test_array_mutability.spl")
    mv("examples/test_array_mutability.smf", "examples/experiments/mutability/test_array_mutability.smf")

    # Runtime experiments
    mv("examples/test_runtime_builtins.spl", "examples/experiments/runtime/test_runtime_builtins.spl")
    mv("examples/test_runtime_builtins.smf", "examples/experiments/runtime/test_runtime_builtins.smf")
    mv("examples/test_import.spl", "examples/experiments/runtime/test_import.spl")
    mv("examples/test_import.smf", "examples/experiments/runtime/test_import.smf")
    mv("examples/test_jit_backend.spl", "examples/experiments/runtime/test_jit_backend.spl")
    mv("examples/native_v2_test.spl", "examples/experiments/runtime/native_v2_test.spl")
    mv("examples/native_advanced.spl", "examples/experiments/runtime/native_advanced.spl")
    mv("examples/native_advanced.smf", "examples/experiments/runtime/native_advanced.smf")

    # Other experiments
    mv("examples/test_db_validation_demo.spl", "examples/experiments/test_db_validation_demo.spl")
    mv("examples/todo_fixed_demo.spl", "examples/experiments/todo_fixed_demo.spl")
    mv("examples/todo_fixed_demo.smf", "examples/experiments/todo_fixed_demo.smf")
    mv("examples/simple_math_test.spl", "examples/experiments/simple_math_test.spl")
    mv("examples/simple_math_test.smf", "examples/experiments/simple_math_test.smf")
    mv("examples/perf_demo.spl", "examples/experiments/perf_demo.spl")
    mv("examples/physics_rapier2d_demo.spl", "examples/experiments/physics_rapier2d_demo.spl")
    mv("examples/bcrypt_demo.spl", "examples/experiments/bcrypt_demo.spl")

fn migrate_projects():
    print "Migrating projects..."

    shell("mv examples/medgemma_korean examples/projects/medgemma_korean")

fn delete_duplicates():
    print "\n[3/4] Deleting duplicates and obsolete files..."

    # Delete specific duplicates
    rm_if_exists("examples/torch_demo_fallback.spl")
    rm_if_exists("examples/torch_example.spl")
    rm_if_exists("examples/torch_demo.spl")
    rm_if_exists("examples/torch_demo.smf")
    rm_if_exists("examples/lexer_test.spl")
    rm_if_exists("examples/lexer_test.smf")
    rm_if_exists("examples/debug.wrapper_spec")
    rm_if_exists("examples/cuda.wrapper_spec")

fn cleanup_empty_dirs():
    print "\n[4/4] Cleaning up empty directories..."

    # Remove old empty directories
    shell("rmdir examples/blocks 2>/dev/null || true")
    shell("rmdir examples/language_features 2>/dev/null || true")
    shell("rmdir examples/parser 2>/dev/null || true")
    shell("rmdir examples/actors 2>/dev/null || true")
    shell("rmdir examples/async 2>/dev/null || true")
    shell("rmdir examples/file_io 2>/dev/null || true")
    shell("rmdir examples/pure_nn 2>/dev/null || true")
    shell("rmdir examples/cuda 2>/dev/null || true")
    shell("rmdir examples/gpu_patterns 2>/dev/null || true")
    shell("rmdir examples/gpu 2>/dev/null || true")
    shell("rmdir examples/qemu 2>/dev/null || true")
    shell("rmdir examples/testing 2>/dev/null || true")

fn mv(src: text, dst: text):
    if file_exists(src):
        shell("mv '{src}' '{dst}'")
        print "  {src} -> {dst}"
    else:
        print "  SKIP (not found): {src}"

fn rm_if_exists(path: text):
    if file_exists(path):
        shell("rm '{path}'")
        print "  DELETE: {path}"

main()
