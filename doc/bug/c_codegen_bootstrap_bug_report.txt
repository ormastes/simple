C Codegen Bootstrap Bug Report
Date: 2026-02-22
Scope: src/compiler/70.backend/backend/* (C backend path only)

Status Summary
- Fixed: static C++ emission issues that can cause generated `.cpp` compile failures.
- Fixed: CMake generation policy mismatch (root `CMakeLists.txt` generation removed).
- Fixed: explicit Windows clang-cl detection macros in generated code preamble.
- Pending: runtime compile verification of generated outputs (deferred by request).

Findings And Fixes

1) Local redeclaration in emitted expressions
- Area: `c_ir_builder.spl`
- Issue: `emit_binop`, `emit_unaryop`, and `emit_cmp` emitted `type dest = ...` even though locals are already declared in function prologue.
- Impact: duplicate-definition compile errors in generated `.cpp`.
- Fix: changed these helpers to assignment form: `dest = (...)`.

2) Load instruction redeclaration
- Area: `c_backend.spl`
- Issue: `Load` emitted `type dest = *(type*)ptr;` directly, redeclaring existing local.
- Impact: duplicate-definition compile errors in generated `.cpp`.
- Fix: changed to assignment emission via `emit_assign(dest, *(type*)ptr)`.

3) Missing tuple include path for generated tuple types
- Area: `c_ir_builder.spl`
- Issue: type mapper can emit `std::tuple<...>` but generated preamble did not include `<tuple>`.
- Impact: compile failure when tuple types appear.
- Fix: added `#include <tuple>` to generated header and implementation preambles.

4) Root CMakeLists policy mismatch
- Area: `cmake_gen.spl`
- Issue: generator created root `CMakeLists.txt` in output dir.
- Required behavior: root project should own root `CMakeLists.txt`; generated output should provide include-able cmake fragment only.
- Fix: removed root `CMakeLists.txt` generation. Generator now emits:
  - per-directory `CMakeLists.txt`
  - root `generated_sources.cmake`

5) Generated include-root variable coupling
- Area: `cmake_gen.spl`
- Issue: per-dir `CMakeLists.txt` used `${CMAKE_SOURCE_DIR}` as generated include root, which can point to unrelated project root when included externally.
- Impact: header include path resolution can break in integrated root builds.
- Fix: switched to `${SIMPLE_GENERATED_ROOT}`, set by `generated_sources.cmake`.

6) Explicit clang-cl conditional requirement
- Area: `c_ir_builder.spl`
- Issue: generated code had generic portability branch but no explicit clang-cl macro.
- Fix: added:
  - `SPL_CLANG_CL` detection macro in generated `.h` and `.cpp` preambles
  - `SPL_UNREACHABLE()` mapping branch using `SPL_CLANG_CL`

Files Changed
- src/compiler/70.backend/backend/c_ir_builder.spl
- src/compiler/70.backend/backend/c_backend.spl
- src/compiler/70.backend/backend/cmake_gen.spl

Verification State
- Static review: complete
- Build/compile validation: not run in this pass (intentionally deferred)
