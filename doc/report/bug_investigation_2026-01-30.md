# Bug Investigation Report - 2026-01-30

**Investigation Type:** Hanging tests, slow tests, and interpreter performance bugs
**Duration:** ~2 hours
**Tools Used:** Simple MCP, unified_db analysis, SDN parser investigation
**Status:** ✅ COMPLETE

---

## Executive Summary

Investigated reports of:
1. **Hanging/timeout tests** (3 tests)
2. **SDN parse errors** (test_db.sdn)
3. **Interpreter performance** issues

### Key Findings

✅ **NO hanging or performance bugs in interpreter**
✅ **Tests complete quickly** when run individually
✅ **4 critical code bugs** discovered and filed
✅ **Unified database architecture confirmed** (atomic writes + file locking)

---

## Investigation Results

### 1. Hanging Tests Investigation

**Status:** ✅ RESOLVED - Not actually hanging

| Test File | Reported Status | Actual Behavior |
|-----------|----------------|-----------------|
| `fixture_spec.spl` | "Timeout after 30s" | ✅ **PASS** in <1s (4/4 tests) |
| `spec_framework_spec.spl` | "Timeout after 30s" | ✅ **PASS** in <1s (31/31 tests) |
| `cli_spec.spl` | "Timeout after 30s" | ❌ **FAIL** in <2s (14/25 failures - NOT timeout) |

**Conclusion:** Timeout entries in test_db.sdn were **stale data** from old test runs. Tests execute quickly with modern codebase.

---

### 2. Root Cause Analysis - cli_spec.spl Failures

Tests fail fast due to **4 critical bugs** (not hanging):

#### Bug #1: Missing String Methods (P0 - Critical)
**ID:** `string_001`
**File:** `src/rust/compiler/src/interpreter_method/string.rs`
**Error:** `method 'trim_start_matches' not found on type 'str'`
**Impact:** 7+ test failures in CLI parsing
**Fix:** Implement `trim_start_matches()` and `trim_end_matches()` methods

```rust
"trim_start_matches" => {
    let prefix = eval_arg(args, 0, Value::Str(String::new()), env, ...)?.to_key_string();
    return Ok(Value::Str(s.trim_start_matches(&prefix).to_string()));
}
```

#### Bug #2: Parser Rejects `&[T]` Syntax (P1 - High)
**ID:** `parser_001`
**File:** `src/lib/std/src/file/mmap.spl:52`
**Error:** "Unexpected token: expected RBracket, found Gt"
**Code:** `pub fn slice(...) -> Result<&[u8], FileError>`
**Fix:** Add parser support for slice reference syntax OR rewrite file

#### Bug #3: Method Mutability Errors (P1 - High)
**ID:** `cli_001`
**File:** `src/lib/std/src/cli/parser.spl:122+`
**Error:** `cannot modify self.X in immutable fn method`
**Pattern:** Methods declared as `pub fn method(mut self)` try to mutate self
**Fix:** Change to `pub me method()` (14 methods affected)

```simple
# ❌ WRONG
pub fn no_auto_stage(mut self) -> ArgParser:
    self.auto_stage_files = false  # Error: can't mutate in immutable method

# ✅ CORRECT
pub me no_auto_stage() -> ArgParser:
    self.auto_stage_files = false  # OK: 'me' keyword allows mutation
```

#### Bug #4: Parser Rejects if-then Syntax (P2 - Medium)
**ID:** `parser_002`
**File:** `src/lib/std/src/file/async_handle.spl`
**Error:** "Unexpected token: expected Colon, found Then"
**Fix:** Add if-then syntax support OR rewrite to use standard if: syntax

---

### 3. SDN Table Serialization Bug

**Status:** ⚠️ STALE DATA ISSUE (not current code bug)

**Finding:** The `test_db.sdn` file contains malformed table syntax where the first row appears on the same line as the table header:

```sdn
# MALFORMED (in backed up file):
test_runs |run_id, start_time|        1769655987, "1769655987"

# CORRECT (should be):
test_runs |run_id, start_time|
        1769655987, "1769655987"
```

**Analysis:**
- SDN library tests **pass** (45/45)
- Current serializer code appears **correct**
- Malformed file likely generated by **older version** of code
- Parse error: "Unexpected token: expected identifier, found INDENT"

**Resolution:** Delete stale test_db.sdn and regenerate with current code.

---

### 4. Unified Database Architecture ✅

**File:** `src/rust/driver/src/unified_db.rs`

**Confirmed Features:**
- ✅ **Atomic writes** - Temp file + rename pattern
- ✅ **Thread-safe** - File locking via `FileLock::acquire()`
- ✅ **Multi-table support** - Preserves other tables in same file
- ✅ **Type-safe** - Generic `Database<T>` with `Record` trait
- ✅ **SDN format** - All databases use SDN serialization

**Databases Using Unified Architecture:**
| Database | Record Type | File | Status |
|----------|------------|------|--------|
| test_db | `TestRecord` | `test_db.rs` | ✅ Uses unified_db |
| todo_db | `TodoRecord` | `todo_db.rs` | ✅ Uses unified_db |
| feature_db | `FeatureRecord` | (inferred) | ✅ Uses unified_db |
| bug_db | - | - | ✅ SDN format |

**Example Usage:**
```rust
let mut db: Database<TestRecord> = Database::load("doc/test/test_db.sdn")?;
db.insert(record);
db.save()?;  // Atomic write with file locking
```

---

## Bugs Filed in Database

All discovered bugs have been filed in `doc/bug/bug_db.sdn`:

| Bug ID | Severity | Title | File | Status |
|--------|----------|-------|------|--------|
| `string_001` | P0 | Missing string method trim_start_matches | string.rs | confirmed |
| `parser_001` | P1 | Parser rejects slice reference syntax &[T] | mmap.spl:52 | confirmed |
| `parser_002` | P2 | Parser rejects if-then syntax | async_handle.spl | confirmed |
| `cli_001` | P1 | Method mutability errors in CLI parser | parser.spl:122 | confirmed |

**Test Cases Created:**
- `cli_spec_test` - Reproduces all CLI bugs
- `mmap_parse_test` - Reproduces parser &[T] bug
- `async_handle_parse_test` - Reproduces if-then bug

**Fix Proposals Added:**
- `implement_methods` - Add trim_start/end_matches to string interpreter
- `support_slice_refs` - Add &[T] parser support
- `fix_if_then` - Add if-then syntax or rewrite file
- `fix_mutability` - Change methods to use `me` keyword

---

## Recommendations

### Priority 1: Fix String Methods (Critical)
**Impact:** Unblocks 7+ CLI test failures
**Effort:** 30 minutes
**File:** `src/rust/compiler/src/interpreter_method/string.rs`

Add after line containing other string methods:
```rust
"trim_start_matches" => {
    let prefix = eval_arg(args, 0, Value::Str(String::new()), env, functions, classes, enums, impl_methods)?.to_key_string();
    return Ok(Value::Str(s.trim_start_matches(&prefix).to_string()));
}
"trim_end_matches" => {
    let suffix = eval_arg(args, 0, Value::Str(String::new()), env, functions, classes, enums, impl_methods)?.to_key_string();
    return Ok(Value::Str(s.trim_end_matches(&suffix).to_string()));
}
```

### Priority 2: Fix CLI Method Mutability (High)
**Impact:** Unblocks remaining CLI test failures
**Effort:** 15 minutes
**File:** `src/lib/std/src/cli/parser.spl`

Change 14 methods from:
```simple
pub fn method(mut self) -> ArgParser:
```
To:
```simple
pub me method() -> ArgParser:
```

**Lines to update:** 100, 110, 122, 127, 132, 137, 156, 175, 179, 183, 202, 223, 242, 261

### Priority 3: Parser Syntax Support (Medium)
**Option A:** Add parser support for:
- `&[T]` slice reference syntax
- `if-then` conditional syntax

**Option B:** Rewrite affected files to use current syntax

### Priority 4: Clean Test Database (Low)
```bash
# Delete stale test database
rm doc/test/test_db.sdn

# Run tests to regenerate with correct format
./target/debug/simple_old test
```

---

## Performance Analysis

**Interpreter Performance:** ✅ NO ISSUES FOUND

- fixture_spec.spl: 4 tests in <1s
- spec_framework_spec.spl: 31 tests in <1s
- cli_spec.spl: 25 tests in <2s (failures are fast, not slow)

**Conclusion:** No hanging, no infinite loops, no performance bugs in interpreter. All "timeout" reports were stale database artifacts.

---

## Next Steps

1. ✅ **Bugs filed** in `doc/bug/bug_db.sdn`
2. ⏭️ **Implement string methods** (P0 - Critical)
3. ⏭️ **Fix CLI mutability** (P1 - High)
4. ⏭️ **Parser syntax support** (P2 - Medium)
5. ⏭️ **Clean test database** (P3 - Low)

---

## Investigation Tools Used

- **Simple MCP** - Code search and analysis
- **Background agents** - Parallel investigation of hanging tests
- **Unified DB analysis** - Architecture verification
- **SDN parser** - Format validation and error analysis
- **Direct test execution** - Individual test runs to confirm behavior

---

## Lessons Learned

1. **Check stale data first** - Timeout reports were old database entries
2. **Run tests individually** - Revealed true behavior vs cached status
3. **Unified architecture works** - atomic_db pattern is solid
4. **Fast failure is good** - Tests fail quickly with clear errors

---

**Report Generated:** 2026-01-30
**Investigator:** Claude Sonnet 4.5 (MCP-enabled)
**Session:** simple-bug-investigation
