"""
# Execution Mode Verification Script

Tests all execution modes (Interpreter, SMF, Native) to verify they work correctly.

**Usage:**
    simple_runtime doc/report/mode_verification_2026-01-31.spl
"""

use std.spec

# Create a simple test file for verification
val test_content = """
use std.spec

describe "Mode Verification":
    it "basic arithmetic works":
        val result = 2 + 2
        expect result == 4

    it "string operations work":
        val text = "Hello"
        expect text.length() == 5

    it "boolean logic works":
        val flag = true
        expect flag == true
"""

extern fn rt_file_write_text(path: text, content: text) -> bool
extern fn rt_file_read_text(path: text) -> text
extern fn rt_file_exists(path: text) -> bool
extern fn rt_file_delete(path: text) -> bool
extern fn rt_process_run_timeout(cmd: text, args: List<text>, timeout_ms: i64) -> (text, text, i32)

# Test file paths
val test_file = "/tmp/mode_verification_test.spl"
val smf_file = "/tmp/mode_verification_test.smf"

# Write test file
print "Creating test file..."
rt_file_write_text(test_file, test_content)

if not rt_file_exists(test_file):
    print "ERROR: Could not create test file!"
    exit 1

print "✓ Test file created at {test_file}\n"

# Test 1: Interpreter Mode
print "=" * 60
print "TEST 1: Interpreter Mode"
print "=" * 60

val (out1, err1, code1) = rt_process_run_timeout(
    "./rust/target/debug/simple_runtime",
    [test_file],
    10000
)

print "Exit code: {code1}"
if code1 == 0:
    print "✅ INTERPRETER MODE: PASSED"
    print "Output: {out1.split("\n").last()}"
else:
    print "❌ INTERPRETER MODE: FAILED"
    print "Error: {err1}"

print ""

# Test 2: SMF Mode (if compiler available)
print "=" * 60
print "TEST 2: SMF Mode"
print "=" * 60

# Try to compile to SMF first
val (compile_out, compile_err, compile_code) = rt_process_run_timeout(
    "./rust/target/debug/simple_runtime",
    ["compile", test_file, "-o", smf_file],
    30000
)

if compile_code == 0 and rt_file_exists(smf_file):
    print "✓ SMF compilation successful"

    # Run SMF binary
    val (out2, err2, code2) = rt_process_run_timeout(
        "./rust/target/debug/simple_runtime",
        [smf_file],
        10000
    )

    print "Exit code: {code2}"
    if code2 == 0:
        print "✅ SMF MODE: PASSED"
        print "Output: {out2.split("\n").last()}"
    else:
        print "❌ SMF MODE: FAILED"
        print "Error: {err2}"

    # Cleanup
    rt_file_delete(smf_file)
else:
    print "⚠️  SMF MODE: SKIPPED (compilation not available or failed)"
    if compile_err.?:
        print "Compile error: {compile_err}"

print ""

# Test 3: Native Mode (if LLVM available)
print "=" * 60
print "TEST 3: Native Mode"
print "=" * 60

val native_bin = "/tmp/mode_verification_test_native"

# Try native compilation
val (native_compile_out, native_compile_err, native_compile_code) = rt_process_run_timeout(
    "./rust/target/debug/simple_runtime",
    ["compile", "--native", test_file, "-o", native_bin],
    60000
)

if native_compile_code == 0 and rt_file_exists(native_bin):
    print "✓ Native compilation successful"

    # Run native binary
    val (out3, err3, code3) = rt_process_run_timeout(
        native_bin,
        [],
        10000
    )

    print "Exit code: {code3}"
    if code3 == 0:
        print "✅ NATIVE MODE: PASSED"
        print "Output: {out3.split("\n").last()}"
    else:
        print "❌ NATIVE MODE: FAILED"
        print "Error: {err3}"

    # Cleanup
    rt_file_delete(native_bin)
else:
    print "⚠️  NATIVE MODE: SKIPPED (LLVM not available or compilation failed)"
    if native_compile_err.?:
        print "Compile error: {native_compile_err}"

print ""

# Cleanup test file
rt_file_delete(test_file)

# Summary
print "=" * 60
print "VERIFICATION SUMMARY"
print "=" * 60
print ""
print "Status:"
print "  Interpreter: " + if code1 == 0: "✅ PASS" else: "❌ FAIL"
print "  SMF:         " + if compile_code == 0: if code2 == 0: "✅ PASS" else: "❌ FAIL" else: "⚠️  SKIP"
print "  Native:      " + if native_compile_code == 0: if code3 == 0: "✅ PASS" else: "❌ FAIL" else: "⚠️  SKIP"
print ""
print "All critical modes verified successfully!" if code1 == 0
