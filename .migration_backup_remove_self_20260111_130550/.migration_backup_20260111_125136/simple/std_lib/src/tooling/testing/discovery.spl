# Test Discovery Across Languages
# Find all tests in a multi-language project

use tooling.core.project.{Language, ProjectContext}
use host.async_nogc_mut.io.fs
use host.common.io.types.{FileType, DirPath, FilePath}

# Test suite information
pub class TestSuite:
    pub language: Language
    pub path: String
    pub test_count: i32
    pub test_files: List<String>

    pub fn new(language: Language, path: String): TestSuite =
        """Create test suite.

        Args:
            language: Test language
            path: Suite root path

        Returns:
            Test suite
        """
        TestSuite {
            language: language,
            path: path,
            test_count: 0,
            test_files: []
        }

    pub fn is_empty(self): bool =
        """Check if suite has no tests.

        Returns:
            True if no tests found

        Example:
            if suite.is_empty():
                print("No tests found for {suite.language}")
        """
        self.test_count == 0

    pub fn has_files(self): bool =
        """Check if suite has test files.

        Returns:
            True if test files exist
        """
        self.test_files.len() > 0

    pub fn summary(self): String =
        """Get suite summary.

        Returns:
            Human-readable summary

        Example:
            suite.summary()
            # â†’ "Rust: 25 tests in 10 files"
        """
        "{self.language}: {self.test_count} tests in {self.test_files.len()} files"

# Test discovery
pub class TestDiscovery:
    pub root: String
    pub verbose: bool

    pub fn new(root: String): TestDiscovery =
        """Create test discovery.

        Args:
            root: Project root

        Returns:
            Test discovery instance

        Example:
            let discovery = TestDiscovery.new(".")
            let suites = discovery.discover_all()

            for suite in suites:
                print("{suite.language}: {suite.test_count} tests")
        """
        TestDiscovery {
            root: root,
            verbose: false
        }

    pub fn set_verbose(self, enabled: bool):
        """Enable verbose logging."""
        self.verbose = enabled

    pub fn count_total_tests(self): i32 =
        """Count total tests across all languages.

        Returns:
            Total test count

        Example:
            let discovery = TestDiscovery.new(".")
            let total = discovery.count_total_tests()
            print("Found {total} tests")
        """
        let suites = self.discover_all()
        let mut total = 0
        for suite in suites:
            total += suite.test_count
        total

    pub fn get_language_summary(self): Dict<Language, i32> =
        """Get test count by language.

        Returns:
            Map of language to test count

        Example:
            let summary = discovery.get_language_summary()
            for (lang, count) in summary.items():
                print("{lang}: {count} tests")
        """
        let suites = self.discover_all()
        let summary: Dict<Language, i32> = {}
        for suite in suites:
            summary[suite.language] = suite.test_count
        summary

    pub fn discover_all(self): List<TestSuite> =
        """Discover all test suites.

        Returns:
            List of test suites
        """
        let mut suites: List<TestSuite> = []

        # Discover Simple tests
        suites.extend(self.discover_simple_tests())

        # Discover Rust tests
        suites.extend(self.discover_rust_tests())

        # Discover Python tests
        suites.extend(self.discover_python_tests())

        # Discover JavaScript tests
        suites.extend(self.discover_javascript_tests())

        suites

    pub fn discover_by_language(self, language: Language): List<TestSuite> =
        """Discover tests for specific language.

        Args:
            language: Language to discover

        Returns:
            List of test suites
        """
        match language:
            Language::Simple:
                self.discover_simple_tests()
            Language::Rust:
                self.discover_rust_tests()
            Language::Python:
                self.discover_python_tests()
            Language::JavaScript:
                self.discover_javascript_tests()
            Language::TypeScript:
                self.discover_javascript_tests()
            _:
                []

    pub fn discover_by_pattern(self, pattern: String): List<TestSuite> =
        """Discover tests matching pattern.

        Args:
            pattern: Test name pattern

        Returns:
            Filtered test suites
        """
        # TODO: [stdlib][P3] Filter test suites by pattern
        self.discover_all()

    fn discover_simple_tests(): List<TestSuite> =
        """Discover Simple language tests.

        Returns:
            Simple test suites

        Patterns:
        - *_spec.spl
        - *_test.spl
        """
        let test_files = self.find_files_matching(["*_spec.spl", "*_test.spl"])

        if test_files.len() == 0:
            return []

        let suite = TestSuite.new(Language::Simple, self.root)
        suite.test_files = test_files
        suite.test_count = test_files.len()

        [suite]

    fn discover_rust_tests(): List<TestSuite> =
        """Discover Rust tests.

        Returns:
            Rust test suites

        Patterns:
        - Files with #[test] or #[cfg(test)]
        - Cargo.toml projects
        """
        # Find Cargo projects
        let cargo_files = self.find_files_named("Cargo.toml")

        let suites: List<TestSuite> = []

        for cargo_file in cargo_files:
            let suite = TestSuite.new(Language::Rust, cargo_file)
            # TODO: [stdlib][P3] Count tests in project
            suite.test_count = 0
            suites.append(suite)

        suites

    fn discover_python_tests(): List<TestSuite> =
        """Discover Python tests.

        Returns:
            Python test suites

        Patterns:
        - test_*.py
        - *_test.py
        """
        let test_files = self.find_files_matching(["test_*.py", "*_test.py"])

        if test_files.len() == 0:
            return []

        let suite = TestSuite.new(Language::Python, self.root)
        suite.test_files = test_files
        suite.test_count = test_files.len()

        [suite]

    fn discover_javascript_tests(): List<TestSuite> =
        """Discover JavaScript/TypeScript tests.

        Returns:
            JS test suites

        Patterns:
        - *.test.js, *.spec.js
        - *.test.ts, *.spec.ts
        """
        let test_files = self.find_files_matching([
            "*.test.js", "*.spec.js",
            "*.test.ts", "*.spec.ts"
        ])

        if test_files.len() == 0:
            return []

        let suite = TestSuite.new(Language::JavaScript, self.root)
        suite.test_files = test_files
        suite.test_count = test_files.len()

        [suite]

    fn find_files_matching(patterns: List<String>): List<String> =
        """Find files matching glob patterns.

        Args:
            patterns: Glob patterns (simplified - supports *.ext and name_*.ext)

        Returns:
            Matching file paths
        """
        let results: List<String> = []
        for pattern in patterns:
            self.find_files_by_pattern(self.root, pattern, results)
        results

    fn find_files_by_pattern(dir: String, pattern: String, results: List<String>):
        """Recursively find files matching pattern."""
        match fs.read_dir(dir as DirPath):
            Ok(entries):
                for entry in entries:
                    let name = entry.name() as String
                    let path = entry.path() as String

                    match entry.file_type():
                        FileType::File:
                            # Check if file matches pattern
                            if self.matches_pattern(name, pattern):
                                results.append(path)
                        FileType::Directory:
                            # Skip common exclude patterns
                            if not self.should_skip_dir(name):
                                self.find_files_by_pattern(path, pattern, results)
                        _:
                            pass
            Err(_):
                # Ignore errors
                pass

    fn matches_pattern(name: String, pattern: String): bool =
        """Check if name matches simplified glob pattern.

        Supports:
        - *.ext (ends with .ext)
        - prefix_*.ext (starts with prefix_, ends with .ext)
        - *_suffix.ext (ends with _suffix.ext)
        """
        if pattern.starts_with("*"):
            # Pattern: *.ext or *_suffix.ext
            let suffix = pattern[1:]  # Remove leading *
            name.ends_with(suffix)
        elif pattern.ends_with("*"):
            # Pattern: prefix_*
            let prefix = pattern[0:pattern.len()-1]
            name.starts_with(prefix)
        elif pattern.contains("*"):
            # Pattern: prefix_*.ext
            let star_idx = pattern.find("*")
            let prefix = pattern[0:star_idx]
            let suffix = pattern[star_idx+1:]
            name.starts_with(prefix) and name.ends_with(suffix)
        else:
            # Exact match
            name == pattern

    fn should_skip_dir(name: String): bool =
        """Check if directory should be skipped during test discovery."""
        name == "node_modules" or
        name == "target" or
        name == "__pycache__" or
        name == ".git" or
        name == ".venv" or
        name == "venv" or
        name == "build" or
        name == "dist" or
        name.starts_with(".")

    fn find_files_named(name: String): List<String> =
        """Find files with exact name.

        Args:
            name: File name

        Returns:
            Matching file paths
        """
        let results: List<String> = []
        self.find_files_named_recursive(self.root, name, results)
        results

    fn find_files_named_recursive(dir: String, name: String, results: List<String>):
        """Recursively find files with exact name."""
        match fs.read_dir(dir as DirPath):
            Ok(entries):
                for entry in entries:
                    let entry_name = entry.name() as String
                    let path = entry.path() as String

                    # If this is the file we're looking for, add its path
                    if entry_name == name:
                        results.append(path)

                    # Recursively search subdirectories
                    if entry.file_type() == FileType::Directory:
                        if not self.should_skip_dir(entry_name):
                            self.find_files_named_recursive(path, name, results)
            Err(_):
                # Ignore errors
                pass
