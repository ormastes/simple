# Markdown Document Folding for MCP
# Collapses markdown documents into outline format

use core.*

# Markdown section types
pub enum SectionType:
    Heading1
    Heading2
    Heading3
    Heading4
    Heading5
    Heading6
    CodeBlock
    List
    Table
    Quote

# Markdown section
pub class MarkdownSection:
    pub section_type: SectionType
    pub title: String
    pub content: String
    pub line_start: i64
    pub line_end: i64
    pub collapsed: bool

# Parse markdown document into sections
pub fn parse_markdown(source: String) -> List[MarkdownSection]:
    sections = []
    lines = source.split("\n")
    i = 0

    while i < lines.len():
        line = lines[i]

        # Heading detection
        if line.starts_with("# "):
            section = parse_heading(lines, i, SectionType.Heading1)
            sections.append(section)
            i = section.line_end + 1
        elif line.starts_with("## "):
            section = parse_heading(lines, i, SectionType.Heading2)
            sections.append(section)
            i = section.line_end + 1
        elif line.starts_with("### "):
            section = parse_heading(lines, i, SectionType.Heading3)
            sections.append(section)
            i = section.line_end + 1
        elif line.starts_with("#### "):
            section = parse_heading(lines, i, SectionType.Heading4)
            sections.append(section)
            i = section.line_end + 1
        elif line.starts_with("##### "):
            section = parse_heading(lines, i, SectionType.Heading5)
            sections.append(section)
            i = section.line_end + 1
        elif line.starts_with("###### "):
            section = parse_heading(lines, i, SectionType.Heading6)
            sections.append(section)
            i = section.line_end + 1

        # Code block detection
        elif line.starts_with("```"):
            section = parse_code_block(lines, i)
            sections.append(section)
            i = section.line_end + 1

        # List detection
        elif line.starts_with("- ") or line.starts_with("* ") or line.starts_with("+ "):
            section = parse_list(lines, i)
            sections.append(section)
            i = section.line_end + 1

        # Table detection
        elif line.contains("|"):
            section = parse_table(lines, i)
            sections.append(section)
            i = section.line_end + 1

        # Quote detection
        elif line.starts_with("> "):
            section = parse_quote(lines, i)
            sections.append(section)
            i = section.line_end + 1

        else:
            i = i + 1

    return sections

# Parse heading section
fn parse_heading(lines: List[String], start: i64, section_type: SectionType) -> MarkdownSection:
    title_line = lines[start]

    # Extract title (remove # prefix)
    title = title_line
    if section_type == SectionType.Heading1:
        title = title_line[2:]  # Remove "# "
    elif section_type == SectionType.Heading2:
        title = title_line[3:]  # Remove "## "
    elif section_type == SectionType.Heading3:
        title = title_line[4:]  # Remove "### "
    elif section_type == SectionType.Heading4:
        title = title_line[5:]  # Remove "#### "
    elif section_type == SectionType.Heading5:
        title = title_line[6:]  # Remove "##### "
    else:
        title = title_line[7:]  # Remove "###### "

    # Find content until next heading or end
    content_lines = []
    i = start + 1
    while i < lines.len():
        line = lines[i]
        if line.starts_with("#"):
            break
        content_lines.append(line)
        i = i + 1

    content = "\n".join(content_lines)

    return MarkdownSection:
        section_type: section_type
        title: title.strip()
        content: content
        line_start: start
        line_end: i - 1
        collapsed: true

# Parse code block
fn parse_code_block(lines: List[String], start: i64) -> MarkdownSection:
    first_line = lines[start]
    language = first_line[3:]  # After ```

    # Find closing ```
    content_lines = []
    i = start + 1
    while i < lines.len():
        line = lines[i]
        if line.starts_with("```"):
            break
        content_lines.append(line)
        i = i + 1

    content = "\n".join(content_lines)
    title = "Code block (" + language + ")"

    return MarkdownSection:
        section_type: SectionType.CodeBlock
        title: title
        content: content
        line_start: start
        line_end: i
        collapsed: true

# Parse list
fn parse_list(lines: List[String], start: i64) -> MarkdownSection:
    content_lines = []
    i = start

    while i < lines.len():
        line = lines[i]
        if not (line.starts_with("- ") or line.starts_with("* ") or line.starts_with("+ ") or line.starts_with("  ")):
            break
        content_lines.append(line)
        i = i + 1

    content = "\n".join(content_lines)
    item_count = 0
    for line in content_lines:
        if line.starts_with("- ") or line.starts_with("* ") or line.starts_with("+ "):
            item_count = item_count + 1

    title = "List (" + item_count.to_string() + " items)"

    return MarkdownSection:
        section_type: SectionType.List
        title: title
        content: content
        line_start: start
        line_end: i - 1
        collapsed: true

# Parse table
fn parse_table(lines: List[String], start: i64) -> MarkdownSection:
    content_lines = []
    i = start

    while i < lines.len():
        line = lines[i]
        if not line.contains("|"):
            break
        content_lines.append(line)
        i = i + 1

    content = "\n".join(content_lines)
    row_count = content_lines.len()
    title = "Table (" + row_count.to_string() + " rows)"

    return MarkdownSection:
        section_type: SectionType.Table
        title: title
        content: content
        line_start: start
        line_end: i - 1
        collapsed: true

# Parse quote
fn parse_quote(lines: List[String], start: i64) -> MarkdownSection:
    content_lines = []
    i = start

    while i < lines.len():
        line = lines[i]
        if not line.starts_with("> "):
            break
        content_lines.append(line)
        i = i + 1

    content = "\n".join(content_lines)
    title = "Quote"

    return MarkdownSection:
        section_type: SectionType.Quote
        title: title
        content: content
        line_start: start
        line_end: i - 1
        collapsed: true

# Format markdown sections for MCP
pub fn format_markdown_mcp(sections: List[MarkdownSection], show_all: bool) -> String:
    result = ""

    for section in sections:
        if section.collapsed and not show_all:
            result = result + format_collapsed_section(section) + "\n"
        else:
            result = result + format_expanded_section(section) + "\n"

    return result

# Format collapsed section
fn format_collapsed_section(section: MarkdownSection) -> String:
    mark = get_section_mark(section.section_type)
    return mark + " " + section.title + " { â€¦ }"

# Format expanded section
fn format_expanded_section(section: MarkdownSection) -> String:
    mark = get_section_mark(section.section_type)
    result = mark + " " + section.title + " {\n"
    result = result + section.content + "\n"
    result = result + "}"
    return result

# Get section block mark
fn get_section_mark(section_type: SectionType) -> String:
    if section_type == SectionType.Heading1:
        return "H1>"
    elif section_type == SectionType.Heading2:
        return "H2>"
    elif section_type == SectionType.Heading3:
        return "H3>"
    elif section_type == SectionType.Heading4:
        return "H4>"
    elif section_type == SectionType.Heading5:
        return "H5>"
    elif section_type == SectionType.Heading6:
        return "H6>"
    elif section_type == SectionType.CodeBlock:
        return "CB>"
    elif section_type == SectionType.List:
        return "L>"
    elif section_type == SectionType.Table:
        return "T>"
    else:
        return "Q>"
