///
SDN CLI Command Implementations

Implements all SDN CLI commands:
- check: Validate syntax
- to-json: Convert SDN → JSON
- from-json: Convert JSON → SDN
- get: Extract value at path
- set: Update value at path
- fmt: Format/normalize
///

import std.io
import std.fs
import std.process
import std.json
import sdn.document.SdnDocument
import sdn.parser.parse
import sdn.serializer.{to_sdn, to_json}
import sdn.value.SdnValue

# Public exports
export cmd_check, cmd_to_json, cmd_from_json, cmd_get, cmd_set, cmd_fmt

### Command: check
### Validate SDN file syntax

fn cmd_check(args: List[String]):
    if args.len < 1:
        io.eprintln("Error: Missing file argument")
        io.eprintln("Usage: simple_sdn check <file>")
        process.exit(1)

    let file_path = args[0]

    # Read file
    let source = match fs.read_to_string(file_path):
        case Ok(content):
            content
        case Err(e):
            io.eprintln("Error reading file: ${e.to_string()}")
            process.exit(1)

    # Parse
    match parse(source):
        case Ok(_):
            io.println("✓ ${file_path} is valid SDN")
            process.exit(0)
        case Err(e):
            io.eprintln("✗ Syntax error in ${file_path}:")
            io.eprintln("  ${e.to_string()}")
            process.exit(1)

### Command: to-json
### Convert SDN file to JSON

fn cmd_to_json(args: List[String]):
    if args.len < 1:
        io.eprintln("Error: Missing file argument")
        io.eprintln("Usage: simple_sdn to-json <file>")
        process.exit(1)

    let file_path = args[0]

    # Read file
    let source = match fs.read_to_string(file_path):
        case Ok(content):
            content
        case Err(e):
            io.eprintln("Error reading file: ${e.to_string()}")
            process.exit(1)

    # Parse
    let value = match parse(source):
        case Ok(v):
            v
        case Err(e):
            io.eprintln("Parse error: ${e.to_string()}")
            process.exit(1)

    # Convert to JSON
    let json_output = to_json(value)
    io.println(json_output)
    process.exit(0)

### Command: from-json
### Convert JSON file to SDN

fn cmd_from_json(args: List[String]):
    if args.len < 1:
        io.eprintln("Error: Missing file argument")
        io.eprintln("Usage: simple_sdn from-json <file>")
        process.exit(1)

    let file_path = args[0]

    # Read file
    let source = match fs.read_to_string(file_path):
        case Ok(content):
            content
        case Err(e):
            io.eprintln("Error reading file: ${e.to_string()}")
            process.exit(1)

    # Parse JSON
    let json_value = match json.parse(source):
        case Ok(v):
            v
        case Err(e):
            io.eprintln("JSON parse error: ${e.to_string()}")
            process.exit(1)

    # Convert JSON value to SdnValue
    let sdn_value = json_to_sdn(json_value)

    # Convert to SDN
    let sdn_output = to_sdn(sdn_value)
    io.println(sdn_output)
    process.exit(0)

### Command: get
### Get value at path from SDN file

fn cmd_get(args: List[String]):
    if args.len < 2:
        io.eprintln("Error: Missing file or path argument")
        io.eprintln("Usage: simple_sdn get <file> <path>")
        io.eprintln("Example: simple_sdn get config.sdn server.port")
        process.exit(1)

    let file_path = args[0]
    let path = args[1]

    # Load document
    let doc = match SdnDocument.from_file(file_path):
        case Ok(d):
            d
        case Err(e):
            io.eprintln("Error loading file: ${e.to_string()}")
            process.exit(1)

    # Get value at path
    match doc.get(path):
        case Some(value):
            # Print value as SDN
            let output = to_sdn(value)
            io.println(output)
            process.exit(0)
        case None:
            io.eprintln("Error: Path not found: ${path}")
            process.exit(1)

### Command: set
### Set value at path in SDN file

fn cmd_set(args: List[String]):
    if args.len < 3:
        io.eprintln("Error: Missing arguments")
        io.eprintln("Usage: simple_sdn set <file> <path> <value>")
        io.eprintln("Example: simple_sdn set config.sdn server.port 8080")
        process.exit(1)

    let file_path = args[0]
    let path = args[1]
    let value_str = args[2]

    # Load document
    let mut doc = match SdnDocument.from_file(file_path):
        case Ok(d):
            d
        case Err(e):
            io.eprintln("Error loading file: ${e.to_string()}")
            process.exit(1)

    # Parse value
    let value = parse_value_arg(value_str)

    # Set value
    match doc.set(path, value):
        case Ok(_):
            pass
        case Err(e):
            io.eprintln("Error setting value: ${e.to_string()}")
            process.exit(1)

    # Write back
    match doc.write_file(file_path):
        case Ok(_):
            io.println("✓ Updated ${file_path}")
            process.exit(0)
        case Err(e):
            io.eprintln("Error writing file: ${e.to_string()}")
            process.exit(1)

### Command: fmt
### Format/normalize SDN file

fn cmd_fmt(args: List[String]):
    if args.len < 1:
        io.eprintln("Error: Missing file argument")
        io.eprintln("Usage: simple_sdn fmt <file> [--write]")
        process.exit(1)

    let file_path = args[0]
    let write_mode = args.len > 1 && args[1] == "--write"

    # Load document
    let doc = match SdnDocument.from_file(file_path):
        case Ok(d):
            d
        case Err(e):
            io.eprintln("Error loading file: ${e.to_string()}")
            process.exit(1)

    # Format
    let formatted = doc.to_sdn()

    if write_mode:
        # Write back to file
        match fs.write(file_path, formatted):
            case Ok(_):
                io.println("✓ Formatted ${file_path}")
                process.exit(0)
            case Err(e):
                io.eprintln("Error writing file: ${e.to_string()}")
                process.exit(1)
    else:
        # Print to stdout
        io.println(formatted)
        process.exit(0)

### Helper Functions

fn json_to_sdn(json_value: json.Value) -> SdnValue:
    """Convert JSON value to SDN value"""
    match json_value:
        case json.Value.Null:
            return SdnValue.Null
        case json.Value.Bool(b):
            return SdnValue.Bool(b)
        case json.Value.Number(n):
            # Check if integer or float
            if n.floor() == n:
                return SdnValue.Int(n.to_i64())
            else:
                return SdnValue.Float(n)
        case json.Value.String(s):
            return SdnValue.String(s)
        case json.Value.Array(arr):
            let mut sdn_arr = []
            for item in arr:
                sdn_arr.push(json_to_sdn(item))
            return SdnValue.Array(sdn_arr)
        case json.Value.Object(obj):
            let mut sdn_dict = {}
            for (key, val) in obj.items():
                sdn_dict[key] = json_to_sdn(val)
            return SdnValue.Dict(sdn_dict)

fn parse_value_arg(value_str: String) -> SdnValue:
    """Parse command-line value argument"""
    # Try to parse as SDN first
    match parse(value_str):
        case Ok(value):
            return value
        case Err(_):
            pass

    # Try as integer
    match value_str.parse_int():
        case Some(i):
            return SdnValue.Int(i)
        case None:
            pass

    # Try as float
    match value_str.parse_float():
        case Some(f):
            return SdnValue.Float(f)
        case None:
            pass

    # Try as bool
    match value_str:
        case "true":
            return SdnValue.Bool(True)
        case "false":
            return SdnValue.Bool(False)
        case "null":
            return SdnValue.Null
        case _:
            pass

    # Default: treat as string
    return SdnValue.String(value_str)
