# Common Network Types
# Shared across all host variants (async_nogc_mut, async_gc_immut, etc.)

use core.traits.*

# Shutdown modes for TCP connections
pub enum Shutdown:
    Read
    Write
    Both

impl Display for Shutdown:
    fn fmt(self) -> str:
        match self:
            case Read: "read"
            case Write: "write"
            case Both: "both"

# HTTP Methods
pub enum HttpMethod:
    Get
    Post
    Put
    Delete
    Patch
    Head
    Options
    Connect
    Trace

impl HttpMethod:
    pub fn as_str(self) -> &str:
        match self:
            case Get: "GET"
            case Post: "POST"
            case Put: "PUT"
            case Delete: "DELETE"
            case Patch: "PATCH"
            case Head: "HEAD"
            case Options: "OPTIONS"
            case Connect: "CONNECT"
            case Trace: "TRACE"

impl Display for HttpMethod:
    fn fmt(self) -> str:
        match self:
            case Get: "GET"
            case Post: "POST"
            case Put: "PUT"
            case Delete: "DELETE"
            case Patch: "PATCH"
            case Head: "HEAD"
            case Options: "OPTIONS"
            case Connect: "CONNECT"
            case Trace: "TRACE"

# HTTP status code
pub unit StatusCode: u16 as status

impl StatusCode:
    pub fn from_u16(code: u16) -> StatusCode:
        return code_status

    pub fn as_u16(self) -> u16:
        return self as u16

    pub fn is_informational(self) -> bool:
        let code = self as u16
        return code >= 100 and code < 200

    pub fn is_success(self) -> bool:
        let code = self as u16
        return code >= 200 and code < 300

    pub fn is_redirect(self) -> bool:
        let code = self as u16
        return code >= 300 and code < 400

    pub fn is_client_error(self) -> bool:
        let code = self as u16
        return code >= 400 and code < 500

    pub fn is_server_error(self) -> bool:
        let code = self as u16
        return code >= 500 and code < 600

    pub fn reason_phrase(self) -> str:
        match self as u16:
            case 200: return "OK"
            case 201: return "Created"
            case 204: return "No Content"
            case 301: return "Moved Permanently"
            case 302: return "Found"
            case 304: return "Not Modified"
            case 400: return "Bad Request"
            case 401: return "Unauthorized"
            case 403: return "Forbidden"
            case 404: return "Not Found"
            case 405: return "Method Not Allowed"
            case 408: return "Request Timeout"
            case 429: return "Too Many Requests"
            case 500: return "Internal Server Error"
            case 502: return "Bad Gateway"
            case 503: return "Service Unavailable"
            case 504: return "Gateway Timeout"
            case _: return "Unknown"

    # Common status codes
    pub fn ok() -> StatusCode:
        return 200_status

    pub fn created() -> StatusCode:
        return 201_status

    pub fn no_content() -> StatusCode:
        return 204_status

    pub fn bad_request() -> StatusCode:
        return 400_status

    pub fn unauthorized() -> StatusCode:
        return 401_status

    pub fn forbidden() -> StatusCode:
        return 403_status

    pub fn not_found() -> StatusCode:
        return 404_status

    pub fn internal_server_error() -> StatusCode:
        return 500_status

impl Display for StatusCode:
    fn fmt(self) -> str:
        f"{self as u16} {self.reason_phrase()}"

# HTTP header name (case-insensitive)
pub unit HeaderName: str as header

impl HeaderName:
    pub fn from_str(s: str) -> HeaderName:
        return s.to_lower()_header

    # Common headers
    pub fn content_type() -> HeaderName:
        return "content-type"_header

    pub fn content_length() -> HeaderName:
        return "content-length"_header

    pub fn authorization() -> HeaderName:
        return "authorization"_header

    pub fn user_agent() -> HeaderName:
        return "user-agent"_header

    pub fn accept() -> HeaderName:
        return "accept"_header

    pub fn host() -> HeaderName:
        return "host"_header

    pub fn connection() -> HeaderName:
        return "connection"_header

    pub fn cache_control() -> HeaderName:
        return "cache-control"_header

    pub fn cookie() -> HeaderName:
        return "cookie"_header

    pub fn set_cookie() -> HeaderName:
        return "set-cookie"_header

impl Display for HeaderName:
    fn fmt(self) -> str:
        self as str

# HTTP header value
pub unit HeaderValue: str as hval

impl HeaderValue:
    pub fn from_str(s: str) -> HeaderValue:
        return s_hval

    # Common content types
    pub fn json() -> HeaderValue:
        return "application/json"_hval

    pub fn form() -> HeaderValue:
        return "application/x-www-form-urlencoded"_hval

    pub fn multipart() -> HeaderValue:
        return "multipart/form-data"_hval

    pub fn text() -> HeaderValue:
        return "text/plain"_hval

    pub fn html() -> HeaderValue:
        return "text/html"_hval

    pub fn xml() -> HeaderValue:
        return "application/xml"_hval

impl Display for HeaderValue:
    fn fmt(self) -> str:
        self as str

# HTTP error type
pub enum HttpError:
    ConnectionFailed(IoError)
    Timeout
    InvalidUrl
    TooManyRedirects
    InvalidResponse
    InvalidHeader
    BodyTooLarge
    Cancelled
    TlsError(str)
    Other(str)

use host.common.io.error.IoError

impl HttpError:
    pub fn message(self) -> str:
        match self:
            case ConnectionFailed(e): return f"connection failed: {e.message()}"
            case Timeout: return "request timed out"
            case InvalidUrl: return "invalid URL"
            case TooManyRedirects: return "too many redirects"
            case InvalidResponse: return "invalid response"
            case InvalidHeader: return "invalid header"
            case BodyTooLarge: return "response body too large"
            case Cancelled: return "request cancelled"
            case TlsError(msg): return f"TLS error: {msg}"
            case Other(msg): return msg

impl Display for HttpError:
    fn fmt(self) -> str:
        self.message()

impl Error for HttpError
