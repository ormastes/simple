# Decorator Tests
# Tests for built-in decorators: @cached, @logged, @deprecated, @timeout

use spec.*
use core.decorators.*

describe "@cached decorator":
    it "caches function results":
        # Simple test without mutable closures
        @cached
        fn square(x: i64) -> i64:
            return x * x

        # First call - cache miss
        result1 = square(5)
        expect(result1).to_equal(25)

        # Second call with same arg - cache hit (should return same value)
        result2 = square(5)
        expect(result2).to_equal(25)

        # Different arg - cache miss
        result3 = square(10)
        expect(result3).to_equal(100)

    it "caches different arguments":
        @cached
        fn double(x: i64) -> i64:
            return x * 2

        result1 = double(5)
        expect(result1).to_equal(10)

        result2 = double(10)
        expect(result2).to_equal(20)

        # Calling with previous args should still work
        result3 = double(5)
        expect(result3).to_equal(10)


describe "@logged decorator":
    it "logs function calls and returns":
        @logged
        fn add(x: i64, y: i64) -> i64:
            return x + y

        result = add(10, 20)
        expect(result).to_equal(30)
        # Log output should be visible in test output


describe "@deprecated decorator":
    it "warns about deprecated functions":
        @deprecated("Use new_function() instead")
        fn old_function(x: i64) -> i64:
            return x + 1

        result = old_function(5)
        expect(result).to_equal(6)
        # Should print warning on first call

    it "works with default message":
        @deprecated(nil)
        fn legacy_function(x: i64) -> i64:
            return x * 2

        result = legacy_function(5)
        expect(result).to_equal(10)
        # Should print warning


describe "@timeout decorator":
    it "accepts timeout parameter":
        @timeout(5)
        fn slow_work():
            return 42

        result = slow_work()
        expect(result).to_equal(42)
        # Currently just logs timeout, doesn't enforce
