"""
Deploy Smoke Test Specification

Smoke tests to verify the Simple runtime is properly deployed and functional.
Tests binary existence, version output, help output, and basic compilation.

Feature: Deployment Smoke Tests
Category: Deploy Testing
Status: Active
"""

extern fn rt_shell(cmd: text) -> text
extern fn rt_file_exists(path: text) -> bool
extern fn rt_file_read_text(path: text) -> text

describe "deploy: binary existence":
    it "bin/simple exists":
        val found = rt_file_exists("bin/simple")
        expect(found).to_equal(true)

    it "bin/release/simple exists":
        val found = rt_file_exists("bin/release/simple")
        expect(found).to_equal(true)

describe "deploy: version and help":
    it "simple --version returns output":
        val output = rt_shell("bin/simple --version 2>&1 || true")
        expect(output.len()).to_be_greater_than(0)

    it "simple --help returns output":
        val output = rt_shell("bin/simple --help 2>&1 || true")
        expect(output.len()).to_be_greater_than(0)

    it "simple with no args returns output":
        val output = rt_shell("bin/simple 2>&1 || true")
        expect(output.len()).to_be_greater_than(0)

describe "deploy: basic execution":
    it "simple can evaluate a simple expression via echo":
        # Write a temp file, run it, check output
        val tmp = "/tmp/simple_smoke_test.spl"
        rt_shell("printf 'print \"hello_smoke\"' > {tmp}")
        val output = rt_shell("bin/simple run {tmp} 2>&1 || true")
        val cleanup = rt_shell("rm -f {tmp}")
        expect(output).to_contain("hello_smoke")

    it "simple test --list produces test listing":
        val output = rt_shell("bin/simple test --list 2>&1 | head -5 || true")
        expect(output.len()).to_be_greater_than(0)

describe "deploy: key files present":
    it "src/ directory exists":
        val output = rt_shell("test -d src && echo exists || echo missing")
        expect(output).to_contain("exists")

    it "test/ directory exists":
        val output = rt_shell("test -d test && echo exists || echo missing")
        expect(output).to_contain("exists")

    it "CLAUDE.md exists":
        val found = rt_file_exists("CLAUDE.md")
        expect(found).to_equal(true)

describe "deploy: runtime functionality":
    it "print produces output":
        val tmp = "/tmp/simple_smoke_print.spl"
        rt_shell("printf 'val x = 42\nprint \"{x}\"' > {tmp}")
        val output = rt_shell("bin/simple run {tmp} 2>&1 || true")
        val cleanup = rt_shell("rm -f {tmp}")
        expect(output).to_contain("42")

    it "basic arithmetic works in runtime":
        val tmp = "/tmp/simple_smoke_arith.spl"
        rt_shell("printf 'val a = 10\nval b = 20\nprint \"{a + b}\"' > {tmp}")
        val output = rt_shell("bin/simple run {tmp} 2>&1 || true")
        val cleanup = rt_shell("rm -f {tmp}")
        expect(output).to_contain("30")
