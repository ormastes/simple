"""
Parser Improvement Tests for the Simple language compiler.
Validates implemented parser enhancements including match arrow syntax,
function return types, generics, struct literals, and string operations.
"""

# Parser Improvement Tests
# Tests for improvements documented in simple/improve_request.md
#
# Tests marked with `it` are WORKING features.
# Tests marked with `skip` are NOT YET IMPLEMENTED.
#
# NOTE: Function definitions are at module level to avoid BDD scoping bug


# Module-level definitions (workaround for scoping bug)
fn double(x: i32) -> i32:
    return x * 2

fn make_pair(x: i32) -> Option<i32>:
    return Some(x)

fn compute() -> Result<i32, text>:
    return Ok(100)

class Point:
    x: i32
    y: i32

class Config:
    name: text
    value: i32

describe "Parser Improvements - Working Features":
    """
    Tests verified parser improvements that are fully implemented
    and working in the current compiler version.
    """

    # IMPROVEMENT: Match Arrow Syntax
    # Status: IMPLEMENTED
    context "Match Arrow Syntax":
        it "supports arrow syntax in match expressions":
            val value = 2
            val result = match value:
                1 -> "one"
                2 -> "two"
                _ -> "other"
            expect result == "two"

        it "supports multiple patterns with arrows":
            val x = 3
            val msg = match x:
                0 -> "zero"
                1 -> "one"
                2 -> "two"
                _ -> "many"
            expect msg == "many"

    # IMPROVEMENT: Function Return Type Annotations
    # Status: IMPLEMENTED
    context "Function Return Types":
        it "parses return type annotations":
            expect double(5) == 10

        it "supports complex return types":
            val result = make_pair(42)
            expect result.is_some == true

    # IMPROVEMENT: Generic Type Syntax
    # Status: IMPLEMENTED
    context "Generic Types":
        it "supports Option generic type":
            val v = make_pair(42)
            expect v.unwrap() == 42

        it "supports Result generic type":
            val r = compute()
            expect r.is_ok == true

    # IMPROVEMENT: Struct Literal Syntax
    # Status: IMPLEMENTED
    context "Struct Literal Syntax":
        it "supports named field initialization":
            val p = Point { x: 10, y: 20 }
            expect p.x == 10
            expect p.y == 20

        it "supports multi-line struct literals":
            val c = Config {
                name: "test",
                value: 42
            }
            expect c.name == "test"

    # IMPROVEMENT: text Multiplication
    # Status: IMPLEMENTED
    context "text Multiplication":
        it "repeats string with * operator":
            val sep = "=" * 5
            expect sep == "====="

        it "handles zero repetition":
            val empty = "x" * 0
            expect empty == ""

        it "handles single repetition":
            val single = "ab" * 1
            expect single == "ab"

describe "Parser Improvements - Now Implemented":

    # IMPROVEMENT: Multi-line Method Chaining
    # Status: FIXED (2026-01-23)
    context "Multi-line Method Chaining":
        it "supports method chaining across lines":
            # Multi-line chaining now works
            class ChainBuilder:
                val_: i32
                static fn start() -> ChainBuilder:
                    ChainBuilder(val_: 0)
                me add(n: i32) -> ChainBuilder:
                    self.val_ = self.val_ + n
                    self
            val result = ChainBuilder.start()
                .add(1)
                .add(2)
            expect result.val_ == 3

        it "supports fluent interface pattern":
            class Fluent:
                data: text
                static fn create() -> Fluent:
                    Fluent(data: "")
                me append(s: text) -> Fluent:
                    self.data = self.data + s
                    self
            val f = Fluent.create()
                .append("a")
                .append("b")
            expect f.data == "ab"

    # IMPROVEMENT: Enum Variant Construction
    # Status: IMPLEMENTED (2026-01-04)
    context "Enum Variant Construction":
        it "supports qualified enum variant creation":
            # EnumName.VariantName syntax now works
            expect true == true  # Proper tests in bugs spec

        it "supports enum variant with data":
            # EnumName.Variant(data) syntax now works
            expect true == true  # Proper tests in bugs spec

    # IMPROVEMENT: Qualified Method Call Chains
    # Status: PARTIAL (2026-01-23) - basic chaining works, nested classes pending
    context "Qualified Method Calls":
        it "supports method call chains":
            # Basic method chaining works
            class Container:
                inner_val: i32
                static fn create() -> Container:
                    Container(inner_val: 42)
                fn get_value() -> i32:
                    self.inner_val
            val v = Container.create().get_value()
            expect v == 42

        # TODO: use statements inside it blocks cause stack overflow
        skip_it "supports module-level access":
            # Module function access works via alias
            use std.spec as sp
            sp.expect(true == true)

    # IMPROVEMENT: String Interpolation
    # Status: FIXED (2026-01-23) - string interpolation works
    context "String Interpolation":
        it "supports string interpolation with variables":
            val name = "World"
            val greeting = "Hello, {name}!"
            expect greeting == "Hello, World!"

        it "supports expressions in braces":
            val x = 5
            val y = 3
            val result = "Sum: {x + y}"
            expect result == "Sum: 8"
