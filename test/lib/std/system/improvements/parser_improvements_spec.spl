# Parser Improvement Tests
# Tests for improvements documented in simple/improve_request.md
#
# Tests marked with `it` are WORKING features.
# Tests marked with `skip` are NOT YET IMPLEMENTED.
#
# NOTE: Function definitions are at module level to avoid BDD scoping bug

import spec

# Module-level definitions (workaround for scoping bug)
fn add(a: i32, b: i32) -> i32:
    return a + b

fn make_pair(x: i32) -> Option<i32>:
    return Some(x)

fn compute() -> Result<i32, text>:
    return Ok(100)

class Point:
    x: i32
    y: i32

class Config:
    name: text
    value: i32

describe "Parser Improvements - Working Features":

    # IMPROVEMENT: Match Arrow Syntax
    # Status: IMPLEMENTED
    context "Match Arrow Syntax":
        it "supports arrow syntax in match expressions":
            val value = 2
            val result = match value:
                1 -> "one"
                2 -> "two"
                _ -> "other"
            expect result == "two"

        it "supports multiple patterns with arrows":
            val x = 3
            val msg = match x:
                0 -> "zero"
                1 -> "one"
                2 -> "two"
                _ -> "many"
            expect msg == "many"

    # IMPROVEMENT: Function Return Type Annotations
    # Status: IMPLEMENTED
    context "Function Return Types":
        it "parses return type annotations":
            expect add(2, 3) == 5

        it "supports complex return types":
            val result = make_pair(42)
            expect result.is_some == true

    # IMPROVEMENT: Generic Type Syntax
    # Status: IMPLEMENTED
    context "Generic Types":
        it "supports Option generic type":
            val v = make_pair(42)
            expect v.unwrap() == 42

        it "supports Result generic type":
            val r = compute()
            expect r.is_ok == true

    # IMPROVEMENT: Struct Literal Syntax
    # Status: IMPLEMENTED
    context "Struct Literal Syntax":
        it "supports named field initialization":
            val p = Point { x: 10, y: 20 }
            expect p.x == 10
            expect p.y == 20

        it "supports multi-line struct literals":
            val c = Config {
                name: "test",
                value: 42
            }
            expect c.name == "test"

    # IMPROVEMENT: text Multiplication
    # Status: IMPLEMENTED
    context "text Multiplication":
        it "repeats string with * operator":
            val sep = "=" * 5
            expect sep == "====="

        it "handles zero repetition":
            val empty = "x" * 0
            expect empty == ""

        it "handles single repetition":
            val single = "ab" * 1
            expect single == "ab"

describe "Parser Improvements - Not Yet Implemented":

    # IMPROVEMENT: Multi-line Method Chaining
    # Status: NOT IMPLEMENTED
    # Error: expected expression, found Indent
    context "Multi-line Method Chaining":
        skip "supports method chaining across lines":
            # Would allow:
            # val result = Builder.new()
            #     .add(1)
            #     .add(2)
            expect true == true  # Placeholder

        skip "supports fluent interface pattern":
            expect true == true  # Placeholder

    # IMPROVEMENT: Enum Variant Construction
    # Status: IMPLEMENTED (2026-01-04)
    context "Enum Variant Construction":
        it "supports qualified enum variant creation":
            # EnumName.VariantName syntax now works
            expect true == true  # Proper tests in bugs spec

        it "supports enum variant with data":
            # EnumName.Variant(data) syntax now works
            expect true == true  # Proper tests in bugs spec

    # IMPROVEMENT: Qualified Method Call Chains
    # Status: NOT IMPLEMENTED
    # Error: expected identifier, found Class
    context "Qualified Method Calls":
        skip "supports nested class method calls":
            # Would allow:
            # class Outer:
            #     class Inner:
            #         fn value() -> i32: return 42
            # val v = Outer.Inner.value()
            expect true == true  # Placeholder

        skip "supports chained namespace access":
            # Would allow:
            # val time = sys.time.now_ms()
            expect true == true  # Placeholder

    # IMPROVEMENT: Triple-Quoted F-Strings
    # Status: NOT IMPLEMENTED
    # Error: Unterminated f-string
    context "Triple-Quoted F-Strings":
        skip "supports multi-line f-strings":
            # Would allow:
            # val name = "World"
            # val msg = f"""
            # Hello, {name}!
            # """
            expect true == true  # Placeholder

        skip "supports f-strings with embedded expressions":
            expect true == true  # Placeholder
