# Advanced tests for doctest framework
# Tests edge cases in parsing, matching, and execution

use doctest.parser.*
use doctest.matcher.*
use doctest.runner.*

describe "Doctest Advanced Parser":
    context "simple code blocks":
        it "parses single line examples":
            val docstring = ">>> 1 + 1\n2\n"
            val parsed = parse_docstring(docstring)
            expect parsed.len() to_be 1

        it "parses multiple examples":
            val docstring = ">>> x = 5\n>>> x * 2\n10\n"
            val parsed = parse_docstring(docstring)
            expect parsed.len() to_be 2

    context "exception handling":
        it "parses expected exceptions":
            val docstring = ">>> 1 / 0\nError: ZeroDivisionError: division by zero\n"
            val parsed = parse_docstring(docstring)
            expect parsed.len() to_be 1
            expect parsed[0].expected.is_exception() to_be true

        it "parses exception type only":
            val docstring = ">>> raise ValueError\nError: ValueError\n"
            val parsed = parse_docstring(docstring)
            val expected_val = parsed[0].expected
            expect expected_val.get_exception_type() to_be Some("ValueError")

describe "Doctest Advanced Matcher":
    context "wildcard patterns":
        it "matches single character wildcard":
            expect wildcard_match("hello", "h.llo") to_be true
            expect wildcard_match("hello", "h.x.o") to_be false

        it "matches multi-character wildcard":
            expect wildcard_match("hello world", "hello*") to_be true
            expect wildcard_match("hello world", "*world") to_be true
            expect wildcard_match("hello world", "h*d") to_be true

        it "matches combined wildcards":
            expect wildcard_match("hello", "h.l*") to_be true

    context "normalized matching":
        it "ignores trailing whitespace":
            expect exact_match("hello   ", "hello") to_be true
            expect exact_match("hello", "hello   ") to_be true

        it "normalizes text":
            val normalized = normalize("hello\nworld")
            expect normalized.contains("hello") to_be true

    context "output matching":
        it "handles multiline output":
            val result = match_output("line1\nline2", Expected::Output("line1\nline2"))
            expect result.is_pass() to_be true

        it "fails on mismatch":
            val result = match_output("line1", Expected::Output("line2"))
            expect result.is_fail() to_be true

describe "Doctest Advanced Runner":
    context "timeout handling":
        it "respects custom timeout":
            val runner = DoctestRunner.new(timeout_ms: 1000)
            expect runner.get_timeout() to_be 1000

        it "creates runner with different timeouts":
            val fast = DoctestRunner.new(timeout_ms: 100)
            val slow = DoctestRunner.new(timeout_ms: 10000)
            expect fast.get_timeout() < slow.get_timeout() to_be true

    context "result counting":
        it "counts passed and failed":
            val runner = DoctestRunner.new()
            # Test the runner exists and has methods
            expect runner.get_timeout() > 0 to_be true

describe "Source Location":
    it "formats location string":
        val loc = SourceLocation(file: "test.spl", line: 42)
        expect loc.to_string() to_be "test.spl:42"

    it "compares locations":
        val loc1 = SourceLocation(file: "test.spl", line: 10)
        val loc2 = SourceLocation(file: "test.spl", line: 20)
        val loc3 = SourceLocation(file: "other.spl", line: 10)

        expect loc1.is_same_file(loc2) to_be true
        expect loc1.is_same_file(loc3) to_be false
        expect loc1.is_before(loc2) to_be true
        expect loc2.is_before(loc1) to_be false

describe "Expected variants":
    it "provides variant checks":
        val output = Expected::Output("42")
        val exception = Expected::Exception("ValueError", None)
        val empty = Expected::Empty

        expect output.is_output() to_be true
        expect exception.is_exception() to_be true
        expect empty.is_empty() to_be true

    it "provides summaries":
        val output = Expected::Output("hello world")
        val exception = Expected::Exception("ValueError", Some("bad input"))

        expect output.summary().contains("Output") to_be true
        expect exception.summary().contains("ValueError") to_be true
