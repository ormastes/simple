"""
Feature Documentation Framework System Tests.
Validates FeatureMetadata, FeatureRegistry, and documentation generation
including markdown output, category indexing, and master index creation.
"""

# Feature Documentation Framework System Tests
# Tests the feature documentation generation system

use std.spec.*
use spec.feature_doc.{FeatureMetadata, register_feature, get_feature, get_features_by_category, get_all_features, get_all_categories, clear_feature_registry, generate_feature_doc, generate_category_index, generate_master_index, format_feature_filename, get_difficulty_label}

describe "Feature Documentation Framework":
    """
    Tests the complete feature documentation framework including
    metadata creation, registry operations, and markdown generation.
    """
    before_each:
        clear_feature_registry()

    context "FeatureMetadata":
        it "creates metadata with required fields":
            val meta = FeatureMetadata(
                id: 1,
                name: "Test Feature",
                category: "Testing",
                difficulty: 2,
                status: "âœ… Complete",
                impl_type: "S",
                spec_ref: "test_spec.spl",
                files: ["src/test.spl"],
                tests: ["test/test_spec.spl"],
                description: "A test feature",
                code_examples: ["val x = 1"],
                dependencies: [],
                required_by: [],
                notes: "Test notes"
            )
            expect meta.id == 1
            expect meta.name == "Test Feature"
            expect meta.category == "Testing"

        it "validates metadata correctness":
            val meta = FeatureMetadata(
                id: 42,
                name: "Parser",
                category: "Infrastructure",
                difficulty: 3,
                status: "ðŸ”„ In Progress",
                impl_type: "R",
                spec_ref: "",
                files: [],
                tests: [],
                description: "Parser component",
                code_examples: [],
                dependencies: [1, 2],
                required_by: [10],
                notes: ""
            )
            expect meta.id == 42
            expect meta.difficulty == 3
            expect meta.dependencies.len() == 2

        it "handles difficulty levels":
            expect get_difficulty_label(1) == "Trivial"
            expect get_difficulty_label(2) == "Easy"
            expect get_difficulty_label(3) == "Medium"
            expect get_difficulty_label(4) == "Hard"
            expect get_difficulty_label(5) == "Very Hard"
            expect get_difficulty_label(99) == "Unknown"

        it "generates correct filename":
            val filename = format_feature_filename(1, "Lexer")
            expect filename == "0001_lexer.md"
            val filename2 = format_feature_filename(42, "Parser Core")
            expect filename2 == "0042_parser_core.md"
            val filename3 = format_feature_filename(100, "Test")
            expect filename3 == "0100_test.md"
            val filename4 = format_feature_filename(1000, "Feature")
            expect filename4 == "1000_feature.md"

        it "generates filename with padding":
            expect format_feature_filename(1, "test") == "0001_test.md"
            expect format_feature_filename(10, "test") == "0010_test.md"
            expect format_feature_filename(100, "test") == "0100_test.md"

    context "Feature Registry":
        it "registers features":
            val meta = FeatureMetadata(
                id: 1,
                name: "Test",
                category: "Testing",
                difficulty: 1,
                status: "âœ… Complete",
                impl_type: "S",
                spec_ref: "",
                files: [],
                tests: [],
                description: "Test",
                code_examples: [],
                dependencies: [],
                required_by: [],
                notes: ""
            )
            register_feature(meta)
            val all = get_all_features()
            expect all.len() == 1

        it "retrieves features by category":
            val meta1 = FeatureMetadata(
                id: 1, name: "Test1", category: "Cat1",
                difficulty: 1, status: "âœ… Complete", impl_type: "S",
                spec_ref: "", files: [], tests: [],
                description: "Test 1", code_examples: [],
                dependencies: [], required_by: [], notes: ""
            )
            val meta2 = FeatureMetadata(
                id: 2, name: "Test2", category: "Cat2",
                difficulty: 1, status: "âœ… Complete", impl_type: "S",
                spec_ref: "", files: [], tests: [],
                description: "Test 2", code_examples: [],
                dependencies: [], required_by: [], notes: ""
            )
            register_feature(meta1)
            register_feature(meta2)
            val cat1_features = get_features_by_category("Cat1")
            expect cat1_features.len() == 1

        it "lists all categories":
            val meta1 = FeatureMetadata(
                id: 1, name: "Test1", category: "Cat1",
                difficulty: 1, status: "âœ… Complete", impl_type: "S",
                spec_ref: "", files: [], tests: [],
                description: "Test 1", code_examples: [],
                dependencies: [], required_by: [], notes: ""
            )
            val meta2 = FeatureMetadata(
                id: 2, name: "Test2", category: "Cat2",
                difficulty: 1, status: "âœ… Complete", impl_type: "S",
                spec_ref: "", files: [], tests: [],
                description: "Test 2", code_examples: [],
                dependencies: [], required_by: [], notes: ""
            )
            register_feature(meta1)
            register_feature(meta2)
            val cats = get_all_categories()
            expect cats.len() == 2

        it "gets all features":
            val meta1 = FeatureMetadata(
                id: 1, name: "Test1", category: "Testing",
                difficulty: 1, status: "âœ… Complete", impl_type: "S",
                spec_ref: "", files: [], tests: [],
                description: "Test 1", code_examples: [],
                dependencies: [], required_by: [], notes: ""
            )
            val meta2 = FeatureMetadata(
                id: 2, name: "Test2", category: "Testing",
                difficulty: 1, status: "âœ… Complete", impl_type: "S",
                spec_ref: "", files: [], tests: [],
                description: "Test 2", code_examples: [],
                dependencies: [], required_by: [], notes: ""
            )
            register_feature(meta1)
            register_feature(meta2)
            val all = get_all_features()
            expect all.len() == 2

    context "Documentation Generation":
        it "generates markdown for a feature":
            val meta = FeatureMetadata(
                id: 1,
                name: "Test Feature",
                category: "Testing",
                difficulty: 2,
                status: "âœ… Complete",
                impl_type: "S",
                spec_ref: "test_spec.spl",
                files: ["src/test.spl"],
                tests: ["test/test_spec.spl"],
                description: "A test feature for documentation",
                code_examples: ["val x = 1"],
                dependencies: [],
                required_by: [],
                notes: "Some notes"
            )
            register_feature(meta)
            match generate_feature_doc(1):
                case Some(md):
                    expect md.contains("Test Feature")
                    expect md.contains("Testing")
                case None:
                    nil

        it "includes metadata table in generated markdown":
            val meta = FeatureMetadata(
                id: 42,
                name: "Parser",
                category: "Infrastructure",
                difficulty: 3,
                status: "âœ… Complete",
                impl_type: "R",
                spec_ref: "",
                files: [],
                tests: [],
                description: "Parser component",
                code_examples: [],
                dependencies: [],
                required_by: [],
                notes: ""
            )
            register_feature(meta)
            match generate_feature_doc(42):
                case Some(md):
                    expect md.contains("| Property | Value |")
                    expect md.contains("| **Feature ID** |")
                    expect md.contains("#42")
                case None:
                    nil

    context "Index Generation":
        it "generates category index":
            val meta = FeatureMetadata(
                id: 1,
                name: "Test Feature",
                category: "Testing",
                difficulty: 2,
                status: "âœ… Complete",
                impl_type: "S",
                spec_ref: "",
                files: [],
                tests: [],
                description: "A test feature",
                code_examples: [],
                dependencies: [],
                required_by: [],
                notes: ""
            )
            register_feature(meta)
            val index_md = generate_category_index("Testing")
            expect index_md.contains("Testing Features")
            expect index_md.contains("Test Feature")

        it "generates master index":
            val meta1 = FeatureMetadata(
                id: 1, name: "Feature1", category: "Cat1",
                difficulty: 1, status: "âœ… Complete", impl_type: "S",
                spec_ref: "", files: [], tests: [],
                description: "Feature 1", code_examples: [],
                dependencies: [], required_by: [], notes: ""
            )
            val meta2 = FeatureMetadata(
                id: 2, name: "Feature2", category: "Cat2",
                difficulty: 2, status: "ðŸ“‹ Planned", impl_type: "R",
                spec_ref: "", files: [], tests: [],
                description: "Feature 2", code_examples: [],
                dependencies: [], required_by: [], notes: ""
            )
            register_feature(meta1)
            register_feature(meta2)
            val index_md = generate_master_index()
            expect index_md.contains("Feature Index")
            expect index_md.contains("Summary")
            expect index_md.contains("Categories")
            expect index_md.contains("Cat1")
            expect index_md.contains("Cat2")
