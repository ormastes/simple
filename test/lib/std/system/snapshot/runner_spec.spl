# Snapshot Testing Framework - Runner Tests

use std.spec.*
use std.spec.snapshot.runner.{
    SnapshotTestResult,
    SnapshotSummary,
    expect_snapshot,
    expect_snapshot_json,
    expect_snapshot_yaml,
    run_snapshot_tests
}
use std.spec.snapshot.config.{SnapshotConfig, from_env}

describe "Snapshot Test Runner":
    context "SnapshotTestResult":
        it "identifies Pass result":
            val result = SnapshotTestResult.Pass(test_name: "my_test")
            expect(result.is_pass()).to(be_true())
            expect(result.is_fail()).to(be_false())

        it "identifies Fail result":
            val result = SnapshotTestResult.Fail(
                test_name: "my_test",
                diff: "some diff"
            )
            expect(result.is_fail()).to(be_true())
            expect(result.is_pass()).to(be_false())

        it "has Updated variant":
            val result = SnapshotTestResult.Updated(test_name: "my_test")
            expect(result.is_pass()).to(be_false())
            expect(result.is_fail()).to(be_false())

        it "has Created variant":
            val result = SnapshotTestResult.Created(test_name: "my_test")
            expect(result.is_pass()).to(be_false())
            expect(result.is_fail()).to(be_false())

    context "SnapshotSummary":
        it "reports success when no failures":
            val summary = SnapshotSummary(
                passed: 5,
                failed: 0,
                updated: 0,
                created: 0,
                failures: []
            )
            expect(summary.is_success()).to(be_true())

        it "reports failure when tests fail":
            val summary = SnapshotSummary(
                passed: 3,
                failed: 2,
                updated: 0,
                created: 0,
                failures: [("test1", "diff1"), ("test2", "diff2")]
            )
            expect(summary.is_success()).to(be_false())

        it "formats successful summary":
            val summary = SnapshotSummary(
                passed: 10,
                failed: 0,
                updated: 0,
                created: 0,
                failures: []
            )
            val formatted = summary.format()
            expect(formatted.contains("Passed: 10")).to(be_true())
            expect(formatted.contains("Failed")).to(be_false())

        it "formats summary with failures":
            val summary = SnapshotSummary(
                passed: 5,
                failed: 2,
                updated: 0,
                created: 0,
                failures: [("test1", "diff1")]
            )
            val formatted = summary.format()
            expect(formatted.contains("Passed: 5")).to(be_true())
            expect(formatted.contains("Failed: 2")).to(be_true())
            expect(formatted.contains("Failures:")).to(be_true())

        it "formats summary with updates":
            val summary = SnapshotSummary(
                passed: 3,
                failed: 0,
                updated: 2,
                created: 0,
                failures: []
            )
            val formatted = summary.format()
            expect(formatted.contains("Updated: 2")).to(be_true())

        it "formats summary with created snapshots":
            val summary = SnapshotSummary(
                passed: 0,
                failed: 0,
                updated: 0,
                created: 3,
                failures: []
            )
            val formatted = summary.format()
            expect(formatted.contains("Created: 3")).to(be_true())

    context "Configuration Integration":
        it "uses default config from environment":
            val config = from_env()
            expect(config.update_snapshots).to(be_false())
            expect(config.snapshot_dir).to(eq(".snapshots"))

        it "supports update mode configuration":
            val config = SnapshotConfig.default().with_update()
            expect(config.update_snapshots).to(be_true())

        it "supports format configuration":
            val config = SnapshotConfig.default().with_format("json")
            expect(config.format).to(eq("json"))

        it "supports normalization configuration":
            val config = SnapshotConfig.default().with_normalization()
            expect(config.normalize).to(be_true())
            expect(config.normalize_timestamps).to(be_true())
            expect(config.normalize_ids).to(be_true())
