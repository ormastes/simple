# Snapshot Testing Framework - Basic Tests

use std.spec.*
use std.spec.snapshot.storage.{SnapshotFile, load_snapshot, save_snapshot, snapshot_exists}
use std.spec.snapshot.config.{SnapshotConfig, from_env}

describe "Snapshot Testing Framework":
    context "Basic Snapshot Creation":
        it "creates snapshot file with metadata":
            val snap = SnapshotFile.new(
                "test/example_spec.spl",
                "test_render",
                "Hello World",
                "text"
            )
            expect(snap.test_file).to(eq("test/example_spec.spl"))
            expect(snap.test_name).to(eq("test_render"))
            expect(snap.content).to(eq("Hello World"))
            expect(snap.format).to(eq("text"))
            expect(snap.created_at.length() > 0).to(be_true())

        it "generates correct snapshot file path":
            val snap = SnapshotFile.new(
                "test/user_spec.spl",
                "test_json_output",
                "{}",
                "json"
            )
            val path = snap.get_path(".snapshots")
            expect(path).to(eq(".snapshots/user_spec/test_json_output.snap"))

        it "serializes to file format with header":
            val snap = SnapshotFile.new(
                "test/example_spec.spl",
                "my_test",
                "content here",
                "text"
            )
            val output = snap.to_file_format()
            expect(output.contains("# Snapshot: my_test")).to(be_true())
            expect(output.contains("# Format: text")).to(be_true())
            expect(output.contains("content here")).to(be_true())

        it "parses from file format":
            val content = """# Snapshot: my_test
# Created: 2026-01-23T00:00:00Z
# Updated: 2026-01-23T00:00:00Z
# Format: json

{"name": "test"}"""
            val result = SnapshotFile.from_file_format(content, "test.spl", "my_test")
            expect(result.is_ok()).to(be_true())
            val snap = result.unwrap()
            expect(snap.format).to(eq("json"))
            expect(snap.content).to(eq("{\"name\": \"test\"}"))

    context "Snapshot Configuration":
        it "creates default configuration":
            val config = SnapshotConfig.default()
            expect(config.format).to(eq("text"))
            expect(config.normalize).to(be_false())
            expect(config.update_snapshots).to(be_false())
            expect(config.snapshot_dir).to(eq(".snapshots"))

        it "uses builder pattern for configuration":
            val config = SnapshotConfig.default()
                .with_format("json")
                .with_name("custom_name")
                .with_normalization()
            expect(config.format).to(eq("json"))
            expect(config.name.unwrap()).to(eq("custom_name"))
            expect(config.normalize).to(be_true())
            expect(config.normalize_timestamps).to(be_true())
            expect(config.normalize_ids).to(be_true())

        it "creates config from environment":
            val config = from_env()
            # Should create valid config
            expect(config.format).to(eq("text"))
            expect(config.snapshot_dir).to(eq(".snapshots"))
