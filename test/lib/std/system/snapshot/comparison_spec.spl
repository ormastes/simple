# Snapshot Testing Framework - Comparison Tests

use std.spec.*
use std.spec.snapshot.comparison.{
    compare_snapshots,
    ComparisonResult,
    DiffContext,
    generate_unified_diff,
    format_comparison_result
}

describe "Snapshot Comparison":
    context "Basic Comparison":
        it "matches identical snapshots":
            val result = compare_snapshots(
                "Hello World",
                "Hello World",
                "test_match",
                "text"
            )
            expect(result.is_match()).to(be_true())

        it "detects mismatches":
            val result = compare_snapshots(
                "Hello World",
                "Hello Universe",
                "test_mismatch",
                "text"
            )
            expect(result.is_mismatch()).to(be_true())

        it "normalizes whitespace before comparison":
            val result = compare_snapshots(
                "Hello World  ",
                "Hello World",
                "test_whitespace",
                "text"
            )
            expect(result.is_match()).to(be_true())

    context "Multi-line Comparison":
        it "compares multi-line content":
            val expected = """line 1
line 2
line 3"""
            val actual = """line 1
line 2
line 3"""
            val result = compare_snapshots(expected, actual, "multi_line", "text")
            expect(result.is_match()).to(be_true())

        it "detects line differences":
            val expected = """line 1
line 2
line 3"""
            val actual = """line 1
line CHANGED
line 3"""
            val result = compare_snapshots(expected, actual, "line_diff", "text")
            expect(result.is_mismatch()).to(be_true())

    context "Unified Diff Generation":
        it "generates diff for simple change":
            val diff = generate_unified_diff(
                "old content",
                "new content",
                "test_diff"
            )
            expect(diff.contains("---")).to(be_true())
            expect(diff.contains("+++")).to(be_true())

        it "shows added lines with + prefix":
            val diff = generate_unified_diff(
                "line 1",
                "line 1\nline 2",
                "test_add"
            )
            expect(diff.contains("+")).to(be_true())

        it "shows removed lines with - prefix":
            val diff = generate_unified_diff(
                "line 1\nline 2",
                "line 1",
                "test_remove"
            )
            expect(diff.contains("-")).to(be_true())

        it "includes line numbers in hunks":
            val diff = generate_unified_diff(
                "a\nb\nc",
                "a\nX\nc",
                "test_hunks"
            )
            expect(diff.contains("@@")).to(be_true())

    context "Comparison Result Formatting":
        it "formats match result":
            val result = ComparisonResult.Match
            val formatted = format_comparison_result(result)
            expect(formatted.contains("âœ“")).to(be_true())
            expect(formatted.contains("matches")).to(be_true())

        it "formats mismatch result with diff":
            val context = DiffContext(
                expected_file: ".snapshots/test.snap",
                actual_content: "actual",
                test_name: "my_test",
                format: "text",
                added_lines: 1,
                removed_lines: 1,
                changed_lines: 0
            )
            val result = ComparisonResult.Mismatch(
                diff: "--- Expected\n+++ Actual",
                context: context
            )
            val formatted = format_comparison_result(result)
            expect(formatted.contains("Expected")).to(be_true())
            expect(formatted.contains("Actual")).to(be_true())

        it "includes update command in mismatch":
            val context = DiffContext(
                expected_file: ".snapshots/test.snap",
                actual_content: "actual",
                test_name: "my_test",
                format: "text",
                added_lines: 0,
                removed_lines: 0,
                changed_lines: 1
            )
            val result = ComparisonResult.Mismatch(
                diff: "diff here",
                context: context
            )
            val formatted = format_comparison_result(result)
            expect(formatted.contains("--snapshot-update")).to(be_true())

    context "Diff Statistics":
        it "provides diff summary":
            val context = DiffContext(
                expected_file: ".snapshots/test.snap",
                actual_content: "actual",
                test_name: "stats_test",
                format: "text",
                added_lines: 5,
                removed_lines: 3,
                changed_lines: 2
            )
            val summary = context.summary()
            expect(summary).to(eq("+5 -3 ~2"))
