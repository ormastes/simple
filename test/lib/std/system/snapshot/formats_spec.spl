# Snapshot Testing Framework - Format Tests

use std.spec.*
use std.spec.snapshot.formats.{
    TextFormatter,
    JsonFormatter,
    YamlFormatter,
    HtmlFormatter,
    Base64Formatter,
    get_formatter,
    apply_normalizations,
    SnapshotFormatter
}

describe "Snapshot Formats":
    context "Text Formatter":
        it "serializes values to string":
            val formatter = TextFormatter()
            val result = formatter.serialize("Hello World")
            expect(result.is_ok()).to(be_true())
            expect(result.unwrap()).to(eq("Hello World"))

        it "normalizes line endings":
            val formatter = TextFormatter()
            val normalized = formatter.normalize("line1\r\nline2\r\n")
            expect(normalized.contains("\r")).to(be_false())
            expect(normalized.contains("\n")).to(be_true())

        it "trims trailing whitespace":
            val formatter = TextFormatter()
            val normalized = formatter.normalize("line1   \nline2  ")
            expect(normalized).to(eq("line1\nline2"))

    context "JSON Formatter":
        it "creates pretty JSON formatter":
            val formatter = JsonFormatter.new()
            expect(formatter.pretty).to(be_true())

        it "creates compact JSON formatter":
            val formatter = JsonFormatter.compact()
            expect(formatter.pretty).to(be_false())

        it "normalizes JSON formatting":
            val formatter = JsonFormatter.new()
            val input = "{\"a\":1,\"b\":2}"
            val normalized = formatter.normalize(input)
            # Pretty formatted should have newlines
            expect(normalized.contains("\n") or normalized == input).to(be_true())

    context "YAML Formatter":
        it "creates YAML formatter":
            val formatter = YamlFormatter()
            # Basic construction test
            expect(true).to(be_true())

    context "HTML Formatter":
        it "creates HTML formatter":
            val formatter = HtmlFormatter.new()
            expect(formatter.pretty).to(be_true())

        it "normalizes whitespace in HTML":
            val formatter = HtmlFormatter.new()
            val input = "<div>\r\n\t<span>text</span>\r\n</div>"
            val normalized = formatter.normalize(input)
            expect(normalized.contains("\r")).to(be_false())
            expect(normalized.contains("\t")).to(be_false())

    context "Base64 Formatter":
        it "creates Base64 formatter":
            val formatter = Base64Formatter()
            # Basic construction test
            expect(true).to(be_true())

        it "normalizes by trimming whitespace":
            val formatter = Base64Formatter()
            val normalized = formatter.normalize("  SGVsbG8=  ")
            expect(normalized).to(eq("SGVsbG8="))

    context "Format Selection":
        it "gets formatter by name - text":
            val formatter = get_formatter("text")
            val result = formatter.serialize("test")
            expect(result.is_ok()).to(be_true())

        it "gets formatter by name - json":
            val formatter = get_formatter("json")
            # Should be JsonFormatter
            expect(true).to(be_true())

        it "gets formatter by name - yaml":
            val formatter = get_formatter("yaml")
            # Should be YamlFormatter
            expect(true).to(be_true())

        it "gets formatter by name - html":
            val formatter = get_formatter("html")
            # Should be HtmlFormatter
            expect(true).to(be_true())

        it "defaults to text for unknown format":
            val formatter = get_formatter("unknown_format")
            val result = formatter.serialize("test")
            expect(result.is_ok()).to(be_true())
            expect(result.unwrap()).to(eq("test"))

    context "Normalization":
        it "normalizes ISO timestamps":
            val content = "created: 2026-01-23T12:30:45Z"
            val normalized = apply_normalizations(content, true, false)
            expect(normalized.contains("<TIMESTAMP>")).to(be_true())

        it "normalizes Unix timestamps":
            val content = "timestamp: 1706012345678"
            val normalized = apply_normalizations(content, true, false)
            expect(normalized.contains("<TIMESTAMP>")).to(be_true())

        it "normalizes UUIDs":
            val content = "id: 550e8400-e29b-41d4-a716-446655440000"
            val normalized = apply_normalizations(content, false, true)
            expect(normalized.contains("<UUID>")).to(be_true())

        it "applies multiple normalizations":
            val content = """id: 550e8400-e29b-41d4-a716-446655440000
created: 2026-01-23T12:30:45Z"""
            val normalized = apply_normalizations(content, true, true)
            expect(normalized.contains("<UUID>")).to(be_true())
            expect(normalized.contains("<TIMESTAMP>")).to(be_true())
