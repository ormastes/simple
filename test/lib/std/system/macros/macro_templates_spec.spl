# @pending
"""
Macro template substitution specification.

Tests template substitution in macros including string interpolation,
dynamic function name generation, and identifier templating.
"""


# ============================================================================
# Module-level macro definitions
# ============================================================================

macro tpl_gen_getter(NAME: Str const) -> (
    intro getter: enclosing.module.fn "tpl_get_{NAME}"() -> Int
):
    emit getter:
        fn "tpl_get_{NAME}"() -> Int:
            return 42

macro tpl_make_named_adder(name: Str const, amount: Int const) -> (
    returns result: Int,
    intro adder: enclosing.module.fn "tpl_{name}_op_adder"(x: Int) -> Int
):
    emit adder:
        fn add_impl(x: Int) -> Int:
            return x + amount

    emit result:
        0

macro tpl_gen_getters(N: Int const) -> (
    intro getters:
        for i in 0..N:
            enclosing.module.fn "tpl_loop_get_{i}"() -> Int
):
    emit getters:
        for i in 0..N:
            fn "tpl_loop_get_{i}"() -> Int:
                return i

macro tpl_make_adder_n(n: Int const) -> (
    returns result: Int,
    intro add_fn: enclosing.module.fn "tpl_add_num_{n}"(x: Int) -> Int
):
    emit add_fn:
        fn add_n(x: Int) -> Int:
            return x + n

    emit result:
        0

macro tpl_make_named_adder_v2(name: Str const, amount: Int const) -> (
    returns result: Int,
    intro adder: enclosing.module.fn "tpl_{name}_v2_adder"(x: Int) -> Int
):
    emit adder:
        fn add_impl(x: Int) -> Int:
            return x + amount

    emit result:
        0

# ============================================================================
# Invoke macros that generate functions at module level
# ============================================================================
tpl_gen_getter!("value")
let _ = tpl_make_named_adder!("math", 10)
tpl_gen_getters!(3)
let _ = tpl_make_adder_n!(10)
let _ = tpl_make_named_adder_v2!("custom", 10)

# ============================================================================
# Tests
# ============================================================================

describe "Template Substitution":
    """
    Tests template substitution in macros including function name generation,
    loop-based indexing, number-to-string conversion, and const parameters.
    """

    describe "Templates in function names":
        it "generates functions with template names":
            val x = tpl_get_value()
            expect(x).to_equal(42)

        it "generates operation functions":
            val x = tpl_math_op_adder(32)
            expect(x).to_equal(42)

    describe "Templates with for loops":
        it "generates multiple functions with loop index":
            val sum = tpl_loop_get_0() + tpl_loop_get_1() + tpl_loop_get_2()
            expect(sum).to_equal(3)

    describe "Templates with numbers":
        it "combines strings and numbers in names":
            val x = tpl_add_num_10(32)
            expect(x).to_equal(42)

    describe "Template intro with const param":
        it "uses const parameter in intro name":
            val x = tpl_custom_v2_adder(32)
            expect(x).to_equal(42)
