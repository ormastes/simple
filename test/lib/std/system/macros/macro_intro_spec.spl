# @pending
"""
Macro intro contracts specification.

Tests function introduction via macros including simple function generation,
parameterized functions, loop-based generation, and template substitution.
"""


# ============================================================================
# Module-level macro definitions
# ============================================================================

# Simple function introduction
macro intro_make_adder(n: Int const) -> (
    returns result: Int,
    intro add_fn: enclosing.module.fn "intro_add_n"(x: Int) -> Int
):
    emit add_fn:
        fn intro_add_n(x: Int) -> Int:
            return x + n

    emit result:
        0

macro intro_make_multiplier(factor: Int const) -> (
    intro mul_fn: enclosing.module.fn "intro_multiply"(x: Int) -> Int
):
    emit mul_fn:
        fn intro_multiply(x: Int) -> Int:
            return x * factor

# Multiple function generation
macro intro_gen_axis_getters(N: Int const) -> (
    intro getters:
        for i in 0..N:
            enclosing.module.fn "intro_get_axis_{i}"() -> Int
):
    emit getters:
        for i in 0..N:
            fn "intro_get_axis_{i}"() -> Int:
                return i

macro intro_make_pair() -> (
    intro first: enclosing.module.fn "intro_get_first"() -> Int,
    intro second: enclosing.module.fn "intro_get_second"() -> Int
):
    emit first:
        fn intro_get_first() -> Int:
            return 10

    emit second:
        fn intro_get_second() -> Int:
            return 32

# Template substitution in names
macro intro_gen_getter(NAME: Str const) -> (
    intro getter: enclosing.module.fn "intro_get_{NAME}"() -> Int
):
    emit getter:
        fn "intro_get_{NAME}"() -> Int:
            return 42

macro intro_make_checker(name: Str const, value: Int const) -> (
    intro checker: enclosing.module.fn "intro_check_{name}"() -> Bool
):
    emit checker:
        fn "intro_check_{name}"() -> Bool:
            return value > 0

# Combined intro patterns
macro intro_make_accessors(name: Str const) -> (
    intro getter: enclosing.module.fn "intro_prop_get_{name}"() -> Int,
    intro setter: enclosing.module.fn "intro_prop_set_{name}"(v: Int) -> Int
):
    emit getter:
        fn "intro_prop_get_{name}"() -> Int:
            return 42

    emit setter:
        fn "intro_prop_set_{name}"(v: Int) -> Int:
            return v

# ============================================================================
# Invoke macros that generate functions at module level
# ============================================================================
let _ = intro_make_adder!(10)
intro_make_multiplier!(6)
intro_gen_axis_getters!(3)
intro_make_pair!()
intro_gen_getter!("value")
intro_make_checker!("positive", 42)
intro_make_checker!("negative", -1)
intro_make_accessors!("data")

# ============================================================================
# Tests
# ============================================================================

describe "Intro Contracts":
    """
    Tests function introduction via intro contracts including simple
    generation, parameterized functions, loop-based generation, and
    template substitution in function names.
    """

    describe "Simple function introduction":
        it "generates functions":
            val x = intro_add_n(32)
            expect(x).to_equal(42)

        it "generates functions with parameters":
            expect(intro_multiply(7)).to_equal(42)

    describe "Multiple function generation":
        it "generates axis functions from loop":
            val sum = intro_get_axis_0() + intro_get_axis_1() + intro_get_axis_2()
            expect(sum).to_equal(3)

        it "generates multiple named functions":
            expect(intro_get_first() + intro_get_second()).to_equal(42)

    describe "Template substitution in names":
        it "generates getter functions with string values":
            expect(intro_get_value()).to_equal(42)

        it "generates checker functions":
            expect(intro_check_positive()).to_equal(true)
            expect(intro_check_negative()).to_equal(false)

    describe "Combined intro patterns":
        it "generates accessor pair with template":
            expect(intro_prop_get_data()).to_equal(42)
            expect(intro_prop_set_data(100)).to_equal(100)
