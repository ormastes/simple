# CPU-Aware Parallel Test Runner System Tests
#
# Tests for CPU-aware parallel test execution via subprocess.
#
# Commands tested:
# - test --parallel: Parallel test execution
# - test --full-parallel: Full parallel mode (ignore CPU limits)
# - test --threads=N: Explicit thread count
# - test --cpu-threshold=N: CPU throttle threshold

use std.spec.*
use std.process.{run, ProcessResult}

# Test file for validation
val TEST_FILE = "test/unit/spec/matchers_spec.spl"

describe "CPU-Aware CLI Arguments":
    context "parallel flags":
        it "accepts --parallel flag":
            val result = run("./target/debug/simple", ["test", "--parallel", "--list", TEST_FILE])
            expect result.exit_code == 0

        it "accepts -p short flag":
            val result = run("./target/debug/simple", ["test", "-p", "--list", TEST_FILE])
            expect result.exit_code == 0

        it "accepts --full-parallel flag":
            val result = run("./target/debug/simple", ["test", "--full-parallel", "--list", TEST_FILE])
            expect result.exit_code == 0

        it "accepts -P short flag":
            val result = run("./target/debug/simple", ["test", "-P", "--list", TEST_FILE])
            expect result.exit_code == 0

    context "thread count flags":
        it "accepts --threads=N flag":
            val result = run("./target/debug/simple", ["test", "--parallel", "--threads=4", "--list", TEST_FILE])
            expect result.exit_code == 0

        it "accepts -jN flag":
            val result = run("./target/debug/simple", ["test", "--parallel", "-j4", "--list", TEST_FILE])
            expect result.exit_code == 0

        it "accepts -j N flag with space":
            val result = run("./target/debug/simple", ["test", "--parallel", "-j", "2", "--list", TEST_FILE])
            expect result.exit_code == 0

    context "cpu threshold flags":
        it "accepts --cpu-threshold flag":
            val result = run("./target/debug/simple", ["test", "--parallel", "--cpu-threshold=50", "--list", TEST_FILE])
            expect result.exit_code == 0

        it "accepts --throttled-threads flag":
            val result = run("./target/debug/simple", ["test", "--parallel", "--throttled-threads=2", "--list", TEST_FILE])
            expect result.exit_code == 0


describe "Parallel Test Execution":
    context "with --parallel flag":
        it "runs tests successfully in parallel mode":
            val result = run("./target/debug/simple", ["test", "--parallel", TEST_FILE])
            expect result.exit_code == 0

        it "shows parallel execution message":
            val result = run("./target/debug/simple", ["test", "--parallel", "--threads=2", TEST_FILE])
            expect result.exit_code == 0
            expect result.stdout.contains("parallel") == true

    context "with --full-parallel flag":
        it "runs tests in full parallel mode":
            val result = run("./target/debug/simple", ["test", "--full-parallel", TEST_FILE])
            expect result.exit_code == 0


describe "Safe Mode Integration":
    context "parallel implies safe mode":
        it "enables safe mode when --parallel is set":
            val result = run("./target/debug/simple", ["test", "--parallel", TEST_FILE])
            expect result.exit_code == 0
            # Safe mode shows progress with brackets [1/N]
            expect result.stdout.contains("[") == true


describe "Thread Configuration":
    context "with explicit thread count":
        it "runs with specified threads":
            val result = run("./target/debug/simple", ["test", "--parallel", "--threads=1", TEST_FILE])
            expect result.exit_code == 0
            expect result.stdout.contains("1 thread") == true

        it "runs with multiple threads":
            val result = run("./target/debug/simple", ["test", "--parallel", "--threads=2", TEST_FILE])
            expect result.exit_code == 0
            expect result.stdout.contains("2 thread") == true

    context "with auto thread detection":
        it "auto-detects thread count when threads=0":
            val result = run("./target/debug/simple", ["test", "--parallel", "--threads=0", TEST_FILE])
            expect result.exit_code == 0
            expect result.stdout.contains("thread") == true


describe "CPU Threshold Configuration":
    context "with custom threshold":
        it "accepts low threshold value":
            val result = run("./target/debug/simple", ["test", "--parallel", "--cpu-threshold=10", TEST_FILE])
            expect result.exit_code == 0

        it "accepts high threshold value":
            val result = run("./target/debug/simple", ["test", "--parallel", "--cpu-threshold=90", TEST_FILE])
            expect result.exit_code == 0

    context "with throttled threads":
        it "runs with throttled thread count":
            val result = run("./target/debug/simple", ["test", "--parallel", "--throttled-threads=1", TEST_FILE])
            expect result.exit_code == 0
