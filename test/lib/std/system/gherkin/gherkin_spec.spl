# Gherkin DSL System Tests

import std.spec.{StepKind, StepDefinition, ScenarioContext, feature, scenario, scenario_outline, given, when, then, and_then, examples, get_examples, get_examples_headers, get_examples_data, get_var, set_var, define_given, define_when, define_then, expect, describe, it, eq, be_true, be_truthy, include, is_some}

describe "Gherkin DSL":
    describe "StepKind enum":
        it "converts to string correctly":
            expect(StepKind.Given.to_string()).to eq("Given")
            expect(StepKind.When.to_string()).to eq("When")
            expect(StepKind.Then.to_string()).to eq("Then")
            expect(StepKind.AndThen.to_string()).to eq("And")

        it "provides descriptions":
            expect(StepKind.Given.description()).to include("Setup")
            expect(StepKind.When.description()).to include("Action")
            expect(StepKind.Then.description()).to include("Assertion")

        it "has type check methods":
            expect(StepKind.Given.is_given()).to be_true
            expect(StepKind.When.is_when()).to be_true
            expect(StepKind.Then.is_then()).to be_true
            expect(StepKind.Given.is_setup()).to be_true
            expect(StepKind.When.is_action()).to be_true
            expect(StepKind.Then.is_assertion()).to be_true

    describe "feature block":
        it "creates a feature context":
            # Feature function exists and can be called
            var executed = false
            feature "Test Feature":
                executed = true
            expect(executed).to be_true

    describe "scenario block":
        it "creates a scenario":
            # Scenario function exists and can be called
            var executed = false
            scenario "Test Scenario":
                executed = true
            expect(executed).to be_true

describe "Examples Tables":
    it "registers examples table":
        val rows = [
            ["x", "y", "sum"],
            [1, 2, 3],
            [4, 5, 9]
        ]
        examples("addition", rows)
        val retrieved = get_examples("addition")
        expect(retrieved.is_some()).to be_true

    it "parses header row from examples":
        val rows = [
            ["name", "age"],
            ["Alice", 30],
            ["Bob", 25]
        ]
        val headers = get_examples_headers(rows)
        expect(headers.len()).to eq(2)
        expect(headers[0]).to eq("name")
        expect(headers[1]).to eq("age")

    it "extracts data rows excluding header":
        val rows = [
            ["x", "y"],
            [1, 2],
            [3, 4]
        ]
        val data = get_examples_data(rows)
        expect(data.len()).to eq(2)  # Excludes header row

describe "Scenario Context":
    it "stores and retrieves variables":
        set_var("test_key", "test_value")
        val result = get_var("test_key")
        expect(result).to eq("test_value")

describe "BDD Integration":
    it "feature and scenario functions are callable":
        # Basic integration test - functions exist and execute
        var count = 0
        feature "Integration Test":
            scenario "Test Scenario":
                count = count + 1
        expect(count).to be_truthy  # Should have executed
