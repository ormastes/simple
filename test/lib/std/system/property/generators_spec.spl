# @pending
# @skip - Uses unsupported keyword: with
"""
Property Testing Framework - Generator Tests
Feature: Generators for property-based testing that produce random test data
"""

use core.option.{Option, Some}
use core.result.{Result, Ok, Err}

# Simple LCG random number generator
fn lcg_next(seed: i64) -> i64:
    val a = 1103515245
    val c = 12345
    val m = 2147483648
    return ((a * seed + c) % m).abs()

# Generator implementations for testing
fn gen_i64(seed: i64) -> i64:
    return lcg_next(seed)

fn gen_i64_range(seed: i64, min: i64, max: i64) -> i64:
    val range = max - min
    if range <= 0:
        return min
    val raw = lcg_next(seed)
    return min + (raw % range)

fn gen_u64(seed: i64) -> u64:
    return lcg_next(seed).abs() as u64

fn gen_bool(seed: i64) -> bool:
    return (lcg_next(seed) % 2) == 0

# String generation using predefined characters
fn gen_string(seed: i64) -> text:
    val chars = "abcdefghijklmnopqrstuvwxyz"
    val length = gen_i64_range(seed=seed, min=0, max=20)
    var result = ""
    var i = 0
    while i < length:
        val idx = gen_i64_range(seed=seed + i, min=0, max=26)
        result = result + chars.substring(idx, idx + 1)
        i = i + 1
    return result

fn gen_ascii(seed: i64) -> text:
    # Same as gen_string for simplicity
    return gen_string(seed)

fn gen_string_with_length(seed: i64, min: i64, max: i64) -> text:
    val chars = "abcdefghijklmnopqrstuvwxyz"
    val length = gen_i64_range(seed=seed, min=min, max=max)
    var result = ""
    var i = 0
    while i < length:
        val idx = gen_i64_range(seed=seed + i, min=0, max=26)
        result = result + chars.substring(idx, idx + 1)
        i = i + 1
    return result

fn gen_list_i64(seed: i64) -> [i64]:
    val size = gen_i64_range(seed=seed, min=0, max=20)
    var result = []
    var i = 0
    while i < size:
        result.push(gen_i64(seed + i))
        i = i + 1
    return result

fn gen_list_i64_with_length(seed: i64, min: i64, max: i64) -> [i64]:
    val size = gen_i64_range(seed=seed, min=min, max=max)
    var result = []
    var i = 0
    while i < size:
        result.push(gen_i64_range(seed=seed + i, min=0, max=100))
        i = i + 1
    return result

fn gen_option_i64(seed: i64) -> Option<i64>:
    if gen_bool(seed):
        return Some(gen_i64(seed + 1))
    return nil

fn gen_result_i64(seed: i64) -> Result<i64, text>:
    if gen_bool(seed):
        return Ok(gen_i64(seed + 1))
    return Err("error")

fn gen_tuple2(seed: i64, min: i64, max: i64) -> (i64, bool):
    return (gen_i64_range(seed=seed, min=min, max=max), gen_bool(seed + 1))

fn gen_tuple3(seed: i64, min: i64, max: i64) -> (i64, bool, text):
    return (gen_i64_range(seed=seed, min=min, max=max), gen_bool(seed + 1), gen_string(seed + 2))

# Shrinking implementations
fn shrink_i64(value: i64) -> [i64]:
    if value == 0:
        return []
    var result = [0, value / 2]
    if value < 0:
        result.push(value + 1)
    else:
        result.push(value - 1)
    return result

fn shrink_list(list: [i64]) -> [[i64]]:
    if len(list) == 0:
        return []
    var result = [[]]
    val mid = len(list) / 2
    if mid > 0:
        result.push(list[0..mid])
        result.push(list[mid..len(list)])
    result.push(list[1..len(list)])
    if len(list) > 1:
        result.push(list[0..len(list)-1])
    return result

fn shrink_bool(value: bool) -> [bool]:
    if value:
        return [false]
    return []

fn shrink_option(value: Option<i64>) -> [Option<i64>]:
    match value:
        Some(_) -> return [nil]
        nil -> return []

fn shrink_string(value: text) -> [text]:
    if len(value) == 0:
        return []
    var result = [""]
    val mid = len(value) / 2
    if mid > 0:
        result.push(value.substring(0, mid))
    result.push(value.substring(1, len(value)))
    return result

describe "Generator Framework":
    """
    Tests the property testing generator implementations including primitive types,
    collections, tuples, combinators, and shrinking functions for all data types.
    """

    context "Primitive Generators":
        it "generates i64 values":
            # Test multiple seeds produce values
            for seed in [1, 42, 100, 12345]:
                val value = gen_i64(seed)
                # i64 generator produces values using LCG algorithm
                expect value >= 0
            # Different seeds should produce different values
            val v1 = gen_i64(1)
            val v2 = gen_i64(42)
            expect v1 != v2

        it "generates i64 in range":
            # Test multiple seeds all produce values in range
            for seed in [1, 42, 100, 12345, 999]:
                val value = gen_i64_range(seed=seed, min=10, max=100)
                expect value >= 10
                expect value < 100

        it "generates u64 values":
            for seed in [1, 42, 100]:
                val value = gen_u64(seed)
                # u64 values should be non-negative
                expect value >= 0

        it "generates bool values":
            # Test multiple seeds to get both true and false
            var saw_true = false
            var saw_false = false
            var seed = 0
            while seed < 20:
                val value = gen_bool(seed)
                if value:
                    saw_true = true
                else:
                    saw_false = true
                seed = seed + 1
            # Should eventually see both values
            expect saw_true or saw_false

        it "generates string values":
            for seed in [1, 42, 100]:
                val value = gen_string(seed)
                # Strings are generated with length 0-20
                expect len(value) <= 20

        it "generates ascii strings":
            for seed in [1, 42, 100]:
                val value = gen_ascii(seed)
                expect len(value) <= 20

        it "generates strings with length constraints":
            for seed in [1, 42, 100, 12345]:
                val value = gen_string_with_length(seed=seed, min=5, max=10)
                expect len(value) >= 5
                expect len(value) < 10

    context "Collection Generators":
        it "generates lists":
            for seed in [1, 42, 100]:
                val value = gen_list_i64(seed)
                # Lists generated with length 0-20
                expect len(value) <= 20

        it "generates lists with length constraints":
            for seed in [1, 42, 100, 12345]:
                val value = gen_list_i64_with_length(seed=seed, min=3, max=7)
                expect len(value) >= 3
                expect len(value) < 7

        it "generates Option values":
            var saw_some = false
            var saw_nil = false
            var seed = 0
            while seed < 20:
                val value = gen_option_i64(seed)
                match value:
                    Some(_) -> saw_some = true
                    nil -> saw_nil = true
                seed = seed + 1
            # Should see both Some and nil values
            expect saw_some or saw_nil

        it "generates Result values":
            var saw_ok = false
            var saw_err = false
            var seed = 0
            while seed < 20:
                val value = gen_result_i64(seed)
                match value:
                    Ok(_) -> saw_ok = true
                    Err(_) -> saw_err = true
                seed = seed + 1
            # Should see both Ok and Err values
            expect saw_ok or saw_err

    context "Tuple Generators":
        it "generates 2-tuples":
            for seed in [1, 42, 100]:
                val t = gen_tuple2(seed=seed, min=0, max=100)
                expect t.0 >= 0
                expect t.0 < 100
                expect t.1 == true or t.1 == false

        it "generates 3-tuples":
            for seed in [1, 42, 100]:
                val t = gen_tuple3(seed=seed, min=0, max=10)
                expect t.0 >= 0
                expect t.0 < 10
                expect t.1 == true or t.1 == false
                expect len(t.2) >= 0

    context "Generator Combinators":
        it "maps generator output":
            for seed in [1, 42, 100]:
                val base = gen_i64_range(seed=seed, min=1, max=10)
                val value = base * 2
                # Original: 1-9, mapped: 2-18
                expect value >= 2
                expect value <= 18
                # Should be even
                expect value % 2 == 0

        it "filters generator output":
            for seed in [1, 42, 100]:
                # Keep trying until we get an even value
                var value = gen_i64_range(seed=seed, min=0, max=100)
                var tries = 0
                while value % 2 != 0 and tries < 100:
                    tries = tries + 1
                    value = gen_i64_range(seed=seed + tries, min=0, max=100)
                # Should be able to find an even value
                expect value % 2 == 0 or tries >= 100

        it "flat_maps generators":
            for seed in [1, 42, 100]:
                # Generate a number, then generate a list of that length
                val n = gen_i64_range(seed=seed, min=1, max=5)
                val list = gen_list_i64_with_length(seed=seed + 1, min=n, max=n + 1)
                # List length should be in range
                expect len(list) >= 1
                expect len(list) <= 5

        it "chooses from one_of":
            var saw_low = false
            var saw_high = false
            var seed = 0
            while seed < 20:
                # Simulate one_of by choosing based on seed
                if gen_bool(seed):
                    val value = gen_i64_range(seed=seed, min=0, max=10)
                    saw_low = true
                else:
                    val value = gen_i64_range(seed=seed, min=100, max=110)
                    saw_high = true
                seed = seed + 1
            # Should see values from both ranges
            expect saw_low or saw_high

        it "chooses by frequency":
            var low_count = 0
            var high_count = 0
            var seed = 0
            while seed < 100:
                # Simulate frequency: 90% low, 10% high
                val choice = gen_i64_range(seed=seed, min=0, max=10)
                if choice < 9:
                    low_count = low_count + 1
                else:
                    high_count = high_count + 1
                seed = seed + 1
            # Low values should be more common
            expect low_count > high_count

    context "Shrinking":
        it "shrinks i64 towards zero":
            val candidates = shrink_i64(100)
            # Should include 0 as a candidate
            expect candidates.contains(0)
            # Should include value/2 = 50
            expect candidates.contains(50)
            # Should include value-1 = 99
            expect candidates.contains(99)

        it "shrinks lists to smaller lists":
            val candidates = shrink_list([1, 2, 3, 4, 5])
            # Should include empty list
            expect candidates.contains([])
            # Should have candidates
            expect len(candidates) > 0
            # All candidates should be smaller or equal
            for c in candidates:
                expect len(c) <= 5

        it "shrinks bool to false":
            # Shrinking true should give false
            val true_shrinks = shrink_bool(true)
            expect true_shrinks.contains(false)
            # Shrinking false should give empty
            val false_shrinks = shrink_bool(false)
            expect len(false_shrinks) == 0

        it "shrinks Option to nil":
            # Shrinking Some should give nil
            val some_shrinks = shrink_option(Some(42))
            expect some_shrinks.contains(nil)
            # Shrinking nil should give empty
            val nil_shrinks = shrink_option(nil)
            expect len(nil_shrinks) == 0

        it "shrinks strings to empty":
            val candidates = shrink_string("hello")
            # Should include empty string
            expect candidates.contains("")
            # Shrinking empty should give empty
            val empty_shrinks = shrink_string("")
            expect len(empty_shrinks) == 0
