# Crash Prevention System Tests
# Feature: Protocol Server Crash Prevention
# Category: FailSafe, System Tests, Crash Prevention
# Status: In Progress

use std.spec
use std.failsafe.panic.{PanicInfo, PanicHandler}
use std.failsafe.ratelimit.{RateLimiter, RateLimitDecision}
use std.failsafe.circuit.{CircuitBreaker, CircuitState}
use std.failsafe.timeout.{TimeoutManager, Deadline}
use std.failsafe.resource_monitor.{ResourceMonitor, ResourceType, AlertLevel}
use std.failsafe.core.{ErrorCategory}

# ============================================================================
# PANIC RECOVERY TESTS
# ============================================================================

describe "Panic Recovery":
    it "preserves panic location for debugging":
        val info = PanicInfo.new("Test panic")
        expect(info.message).to_equal("Test panic")

        val error = info.to_error()
        expect(error.category).to_equal(ErrorCategory.Panic)
        expect(error.recoverable).to_equal(false)

# ============================================================================
# RATE LIMIT PROTECTION TESTS
# ============================================================================

describe "Rate Limit Protection":
    it "prevents DoS from single client":
        var limiter = RateLimiter.default()

        val decision1 = limiter.check("attacker")
        expect(decision1).to_equal(RateLimitDecision.Allow)

    it "allows legitimate clients during attack":
        var limiter = RateLimiter.default()

        val client1 = limiter.check("client1")
        val client2 = limiter.check("client2")

        expect(client1).to_equal(RateLimitDecision.Allow)
        expect(client2).to_equal(RateLimitDecision.Allow)

# ============================================================================
# CIRCUIT BREAKER PROTECTION TESTS
# ============================================================================

describe "Circuit Breaker Protection":
    it "starts in closed state":
        var breaker = CircuitBreaker.default("test")
        expect(breaker.state).to_equal(CircuitState.Closed)
        expect(breaker.allow_request()).to_equal(true)

    skip_it "records successful operations":
        # Runtime issue with stats field access
        var breaker = CircuitBreaker.default("success-test")
        breaker.record_success()
        expect(breaker.stats.successes).to_be_greater_than(0)

# ============================================================================
# TIMEOUT PROTECTION TESTS
# ============================================================================

describe "Timeout Protection":
    it "creates timeout tokens":
        var manager = TimeoutManager.default()
        val token = manager.start_timeout("operation")
        expect(token.is_active()).to_equal(true)

    it "supports deadline for multi-step operations":
        var deadline = Deadline.new(10000)
        deadline.start_operation()
        deadline.complete_operation()

        expect(deadline.operations_started).to_equal(1)
        expect(deadline.operations_completed).to_equal(1)

# ============================================================================
# RESOURCE PROTECTION TESTS
# ============================================================================

describe "Resource Protection":
    it "monitors memory usage":
        var monitor = ResourceMonitor.default()
        expect(monitor.enabled).to_equal(true)

    it "tracks alerts":
        var monitor = ResourceMonitor.default()
        val initial_count = monitor.get_unacknowledged_alerts().len()
        expect(initial_count).to_be_greater_than(-1)
