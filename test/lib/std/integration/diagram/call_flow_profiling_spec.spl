# Call Flow Profiling End-to-End Tests
#
# Tests the call flow profiling and mermaid diagram generation
# Run with: simple test --diagram-all simple/std_lib/test/integration/diagram/call_flow_profiling_spec.spl
"""
Call flow profiling integration tests for mermaid diagram generation.
Validates FFI recording of function calls, method traces, and return
values, then verifies correct sequence diagram output format.
"""

import std.spec.{describe, context, it, expect, eq, be, include_string}
import std.spec.diagram.{enable_ffi_recording, disable_ffi_recording, clear_ffi_recording, trace_method, trace_call, trace_return, mark_architectural, generate_sequence_ffi, generate_class_ffi, generate_arch_ffi}

describe "Call Flow Profiling":
    """
    Tests call flow tracing and mermaid sequence diagram generation
    from recorded function calls, method invocations, and return values.
    """
    it "traces simple function calls and generates diagrams":
        clear_ffi_recording()
        enable_ffi_recording()

        # Manually trace calls
        trace_call("main")
        trace_call("helper")
        trace_return(Some("result"))

        # Trace method calls
        trace_method("Calculator", "add", ["1", "2"])
        trace_return(Some("3"))

        val diagram = generate_sequence_ffi()
        disable_ffi_recording()

        expect(diagram).to(include_string("sequenceDiagram"))
        expect(diagram).to(include_string("main"))
        expect(diagram).to(include_string("helper"))
        expect(diagram).to(include_string("Calculator"))
