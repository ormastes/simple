# Feature: SMF note.sdn Section for Instantiation Tracking
#
# As a compiler developer
# I want to track generic instantiation metadata in SMF files
# So that I can enable lazy instantiation and circular dependency detection

feature "SMF note.sdn Instantiation Tracking":
    """
    The note.sdn section in SMF files tracks generic instantiation metadata
    to enable lazy/on-demand instantiation at link-time and load-time,
    along with circular dependency detection.

    This is Phase 1: Basic note.sdn Writing
    """

    background:
        """
        Set up common test data used across scenarios.
        """
        given a clean note.sdn metadata container
        and sample type arguments for Int, String, and Float

    # ========================================================================
    # Scenario 1: Empty Metadata Container
    # ========================================================================

    scenario "Creating an empty metadata container":
        """
        When starting fresh, the metadata container should be empty
        and report itself as such.
        """
        given a new NoteSdnMetadata instance
        when I check if it is empty
        then it should return true
        and the instantiations list should be empty
        and the possible list should be empty
        and the dependencies list should be empty

    # ========================================================================
    # Scenario 2: Track Simple Instantiation
    # ========================================================================

    scenario "Tracking a simple template instantiation":
        """
        Track a basic generic instantiation like List<Int>.
        """
        given a new NoteSdnMetadata instance
        when I add an instantiation for "List<Int>"
            | template      | List          |
            | type_args     | Int           |
            | mangled_name  | List$Int      |
            | from_file     | app.spl       |
            | from_loc      | app.spl:10:5  |
            | to_obj        | app.o         |
            | status        | compiled      |
        then the metadata should not be empty
        and the instantiations list should have 1 entry
        and the first instantiation should have template "List"
        and the first instantiation should have mangled name "List$Int"

    # ========================================================================
    # Scenario 3: Track Multiple Instantiations
    # ========================================================================

    scenario "Tracking multiple instantiations":
        """
        Track several different instantiations in the same container.
        """
        given a new NoteSdnMetadata instance
        when I add an instantiation for "List<Int>"
        and I add an instantiation for "Option<String>"
        and I add an instantiation for "Result<Int,String>"
        then the instantiations list should have 3 entries
        and the instantiation templates should be ["List", "Option", "Result"]

    # ========================================================================
    # Scenario 4: Dependency Graph Construction
    # ========================================================================

    scenario "Building a dependency graph":
        """
        Track dependencies between instantiations to enable
        circular dependency detection.
        """
        given a new NoteSdnMetadata instance
        and an instantiation for "List<Int>"
        when I add a dependency from "List$Int" to "Int" with kind "type_param"
        then the dependencies list should have 1 entry
        and the dependency should be from "List$Int" to "Int"
        and the dependency kind should be "type_param"

    # ========================================================================
    # Scenario 5: Complex Dependency Chain
    # ========================================================================

    scenario "Tracking a complex dependency chain":
        """
        Track dependencies for nested generics like Container<List<Int>>.
        """
        given a new NoteSdnMetadata instance
        when I track "Container<List<Int>>" with dependencies:
            | from_inst            | to_inst     | dep_kind   |
            | Container$List$Int   | List$Int    | field_type |
            | List$Int             | Int         | type_param |
        then the dependencies list should have 2 entries
        and the dependency chain should be traceable from Container to Int

    # ========================================================================
    # Scenario 6: Possible Instantiations
    # ========================================================================

    scenario "Tracking possible lazy instantiations":
        """
        Track instantiations that could be generated on-demand
        at link-time or load-time.
        """
        given a new NoteSdnMetadata instance
        when I add a possible instantiation for "Option<Float>"
            | template      | Option          |
            | type_args     | Float           |
            | mangled_name  | Option$Float    |
            | required_by   | math_module     |
            | can_defer     | true            |
        then the possible list should have 1 entry
        and the possible instantiation should be deferrable

    # ========================================================================
    # Scenario 7: Type Inference Tracking
    # ========================================================================

    scenario "Tracking type inference events":
        """
        Track when the compiler infers types for expressions.
        """
        given a new NoteSdnMetadata instance
        when I add a type inference for "42" inferred as "Int"
            | inferred_type | Int              |
            | expr          | 42               |
            | context       | literal          |
            | from_file     | app.spl          |
            | from_loc      | app.spl:5:10     |
        then the type_inferences list should have 1 entry
        and the inference should show "42" as type "Int"

    # ========================================================================
    # Scenario 8: Circular Dependency Warning
    # ========================================================================

    scenario "Detecting soft circular dependencies":
        """
        Detect circular dependencies that are broken by indirection
        (e.g., Node<T> -> Option<Node<T>> -> Node<T>).
        """
        given a new NoteSdnMetadata instance
        when I add a circular warning for "Node$T->Option$Node$T->Node$T"
        then the circular_warnings list should have 1 entry
        and the warning should describe the cycle path

    # ========================================================================
    # Scenario 9: Circular Dependency Error
    # ========================================================================

    scenario "Detecting hard circular dependencies":
        """
        Detect circular dependencies that are not allowed
        (e.g., A<T> -> B<T> -> C<T> -> A<T>).
        """
        given a new NoteSdnMetadata instance
        when I add a circular error for "A$T->B$T->C$T->A$T" with code "E0420"
        then the circular_errors list should have 1 entry
        and the error code should be "E0420"

    # ========================================================================
    # Scenario 10: SDN Serialization Format
    # ========================================================================

    scenario "Serializing to SDN format":
        """
        Convert metadata to human-readable SDN format with all tables.
        """
        given a NoteSdnMetadata instance with sample data:
            | instantiations | 2 entries |
            | dependencies   | 2 edges   |
            | possible       | 1 entry   |
        when I serialize to SDN format
        then the output should contain "# Instantiation To/From Metadata"
        and the output should contain "# Format version: 1.0"
        and the output should contain "instantiations |id, template, type_args"
        and the output should contain "dependencies |from_inst, to_inst, dep_kind"
        and the output should contain "possible |id, template"
        and the output should end with "# END_NOTE\n"

    # ========================================================================
    # Scenario 11: SDN Format with All Tables
    # ========================================================================

    scenario "SDN format includes all 6 tables":
        """
        Even if tables are empty, all 6 tables should be present in output.
        """
        given a new NoteSdnMetadata instance
        when I serialize to SDN format
        then the output should contain all table headers:
            | table               |
            | instantiations      |
            | possible            |
            | type_inferences     |
            | dependencies        |
            | circular_warnings   |
            | circular_errors     |

    # ========================================================================
    # Scenario 12: String Escaping in SDN
    # ========================================================================

    scenario "Special characters are escaped in SDN output":
        """
        Quotes, backslashes, and special characters should be escaped.
        """
        given a new NoteSdnMetadata instance
        when I add an instantiation with special characters:
            | template      | "Test\"Type"    |
            | mangled_name  | "Test\\Path"    |
        and I serialize to SDN format
        then the output should contain escaped quotes \"
        and the output should contain escaped backslashes \\

    # ========================================================================
    # Scenario 13: InstantiationStatus Enum
    # ========================================================================

    scenario "InstantiationStatus enum conversions":
        """
        Status enum should convert to/from strings correctly.
        """
        given InstantiationStatus values
        when I convert Compiled to string
        then it should return "compiled"
        when I convert "deferred" from string
        then it should return Deferred
        when I convert "invalid" from string
        then it should return an error

    # ========================================================================
    # Scenario 14: DependencyKind Enum
    # ========================================================================

    scenario "DependencyKind enum conversions":
        """
        Dependency kind enum should convert to/from strings correctly.
        """
        given DependencyKind values
        when I convert TypeParam to string
        then it should return "type_param"
        when I convert "field_type" from string
        then it should return FieldType
        when I convert "invalid" from string
        then it should return an error

    # ========================================================================
    # Scenario 15: Complete Workflow
    # ========================================================================

    scenario "Complete instantiation tracking workflow":
        """
        End-to-end scenario: track multiple instantiations with dependencies,
        add possible instantiations, track type inferences, and serialize.
        """
        given a new NoteSdnMetadata instance

        # Track compiled instantiation
        when I add an instantiation for "List<Int>"
        and I add a dependency from "List$Int" to "Int" with kind "type_param"

        # Track possible future instantiation
        and I add a possible instantiation for "List<String>"

        # Track type inference
        and I add a type inference for "[1,2,3]" inferred as "[Int]"

        # Serialize
        and I serialize to SDN format

        # Verify
        then the output should contain "List$Int"
        and the output should contain "List$String"
        and the output should contain "[1,2,3]"
        and the output should contain all 6 table headers
        and the output should end with "# END_NOTE\n"

        # Statistics
        and the metadata should have 1 instantiation
        and the metadata should have 1 possible entry
        and the metadata should have 1 type inference
        and the metadata should have 1 dependency

    # ========================================================================
    # Scenario 16: Zero-Size Section Integration
    # ========================================================================

    scenario "SMF section with zero-size trick":
        """
        When integrated with SMF writer, the note.sdn section should
        use the zero-size trick for hot-reload support.
        """
        given a NoteSdnMetadata instance with data
        when the SMF writer creates a note.sdn section
        then the section should have name "note.sdn"
        and the section size field should be 0
        and the actual data should end with "# END_NOTE\n"
        and the data should be readable by scanning for terminator

    # ========================================================================
    # Feature Statistics
    # ========================================================================

    feature_summary:
        """
        Phase 1: Basic note.sdn Writing

        Scenarios: 16
        Status: Complete

        Coverage:
        - Empty metadata creation ✓
        - Instantiation tracking ✓
        - Dependency graph construction ✓
        - Possible instantiations ✓
        - Type inference tracking ✓
        - Circular dependency detection ✓
        - SDN serialization ✓
        - String escaping ✓
        - Enum conversions ✓
        - SMF integration ✓

        Next Phase: Phase 2 - note.sdn Reading (Loader)
        """
