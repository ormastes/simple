"""
LSP References Handler Tests
Feature: Language Server Protocol Find All References
Category: LSP, Editor Integration
Status: Complete

Unit tests for LSP references handler that finds all references
to symbols across files including definitions and usages.
"""

import std.spec

# Mock LSP reference types
class Reference:
    uri: text
    line: i64
    column: i64

impl Reference:
    static fn new(uri: text, line: i64, column: i64) -> Reference:
        Reference(uri: uri, line: line, column: column)

class MockReferencesHandler:
    references_map: Dict<text, List<Reference>>

impl MockReferencesHandler:
    static fn new() -> MockReferencesHandler:
        MockReferencesHandler(references_map: {})

    me add_reference(symbol: text, ref_location: Reference):
        if not self.references_map.contains_key(symbol):
            self.references_map[symbol] = []
        self.references_map[symbol].push(ref_location)

    me find_references(symbol: text) -> List<Reference>:
        self.references_map.get(symbol).unwrap_or([])

describe "References Handler":
    """
    Tests for LSP references handler finding all symbol occurrences.
    """
    it "finds all variable references":
        val handler = MockReferencesHandler.new()
        handler.add_reference("my_var", Reference.new("file.spl", 5, 10))
        handler.add_reference("my_var", Reference.new("file.spl", 15, 20))
        val refs = handler.find_references("my_var")
        assert refs.len() == 2

    it "finds all function references":
        val handler = MockReferencesHandler.new()
        handler.add_reference("my_func", Reference.new("file.spl", 10, 5))
        handler.add_reference("my_func", Reference.new("file.spl", 30, 5))
        handler.add_reference("my_func", Reference.new("file.spl", 50, 5))
        val refs = handler.find_references("my_func")
        assert refs.len() == 3

    it "includes definition in references":
        val handler = MockReferencesHandler.new()
        handler.add_reference("item", Reference.new("file.spl", 1, 0))  # Definition
        handler.add_reference("item", Reference.new("file.spl", 10, 5)) # Reference
        val refs = handler.find_references("item")
        assert refs.len() >= 1

    it "handles no references":
        val handler = MockReferencesHandler.new()
        val refs = handler.find_references("undefined")
        assert refs.len() == 0

    it "finds cross-file references":
        val handler = MockReferencesHandler.new()
        handler.add_reference("shared", Reference.new("file1.spl", 10, 5))
        handler.add_reference("shared", Reference.new("file2.spl", 20, 5))
        handler.add_reference("shared", Reference.new("module/file3.spl", 30, 5))
        val refs = handler.find_references("shared")
        assert refs.len() == 3
