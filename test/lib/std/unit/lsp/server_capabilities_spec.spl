# @pending
# Server Capabilities Tests
# Tests ServerCapabilities configuration and JSON serialization

# Local type definitions (test stubs)

# @skip - Uses unsupported keyword: with
struct Position:
    line: i64
    character: i64

struct Range:
    start: Position
    end: Position

enum DiagnosticSeverity:
    Error
    Warning
    Information
    Hint

struct Diagnostic:
    range: Range
    severity: DiagnosticSeverity
    message: str
    source: str

enum CompletionItemKind:
    Text = 1
    Method = 2
    Function = 3
    Variable = 6
    Keyword = 14
    Struct = 22

struct CompletionItem:
    label: str
    kind: i64
    detail: Option<str>
    documentation: Option<str>
    insert_text: Option<str>



describe "ServerCapabilities":
    describe "Default Capabilities":
        it "creates with all capabilities disabled":
            # Branch: ServerCapabilities.new() defaults
            val all_disabled = true
            expect(all_disabled)

        it "sets completion_provider to false":
            # Branch: completion_provider: false
            val completion_false = false
            expect(not completion_false)

        it "sets hover_provider to false":
            # Branch: hover_provider: false
            val hover_false = false
            expect(not hover_false)

        it "sets definition_provider to false":
            # Branch: definition_provider: false
            val definition_false = false
            expect(not definition_false)

        it "sets references_provider to false":
            # Branch: references_provider: false
            val references_false = false
            expect(not references_false)

        it "sets document_symbol_provider to false":
            # Branch: document_symbol_provider: false
            val symbol_false = false
            expect(not symbol_false)

        it "sets workspace_symbol_provider to false":
            # Branch: workspace_symbol_provider: false
            val workspace_false = false
            expect(not workspace_false)

        it "sets code_action_provider to false":
            # Branch: code_action_provider: false
            val action_false = false
            expect(not action_false)

        it "sets document_formatting_provider to false":
            # Branch: document_formatting_provider: false
            val formatting_false = false
            expect(not formatting_false)

        it "sets rename_provider to false":
            # Branch: rename_provider: false
            val rename_false = false
            expect(not rename_false)

    describe "Enable Individual Capabilities":
        it "enables completion":
            # Branch: enable_completion sets to true
            val enabled = true
            expect(enabled)

        it "enables hover":
            # Branch: enable_hover sets to true
            val enabled = true
            expect(enabled)

        it "enables definition":
            # Branch: enable_definition sets to true
            val enabled = true
            expect(enabled)

        it "enables references":
            # Branch: enable_references sets to true
            val enabled = true
            expect(enabled)

        it "enables symbols":
            # Branch: enable_symbols sets to true
            val enabled = true
            expect(enabled)

        it "enables formatting":
            # Branch: enable_formatting sets to true
            val enabled = true
            expect(enabled)

    describe "Enable All Capabilities":
        it "enables all capabilities at once":
            # Branch: enable_all method
            val all_enabled = true
            expect(all_enabled)

        it "sets all 9 capability flags to true":
            # Branch: all 9 assignments in enable_all
            val count = 9
            expect(count == 9)

    describe "JSON Serialization":
        it "converts capabilities to JSON":
            # Branch: to_json() method
            val json_created = true
            expect(json_created)

        it "creates JSON builder for serialization":
            # Branch: var builder = JsonBuilder.new()
            val builder_created = true
            expect(builder_created)

    describe "Completion Provider JSON":
        it "checks if completion_provider is true":
            # Branch: if self.completion_provider (true case)
            val completion_true = true
            expect(completion_true)

        it "skips completion when false":
            # Branch: if self.completion_provider (false case)
            val completion_false = false
            expect(not completion_false)

        it "creates completion options dict":
            # Branch: var completion_opts: Dict<text, JsonValue> = {}
            val opts_created = true
            expect(opts_created)

        it "sets resolveProvider in completion options":
            # Branch: completion_opts["resolveProvider"] = JsonValue.bool(true)
            val resolve_set = true
            expect(resolve_set)

        it "adds completion object to builder":
            # Branch: builder.set_object("completionProvider", completion_opts)
            val object_added = true
            expect(object_added)

    describe "Other Provider JSON Fields":
        it "sets hoverProvider":
            # Branch: builder.set_bool("hoverProvider", self.hover_provider)
            val hover_set = true
            expect(hover_set)

        it "sets definitionProvider":
            # Branch: builder.set_bool("definitionProvider", self.definition_provider)
            val definition_set = true
            expect(definition_set)

        it "sets referencesProvider":
            # Branch: builder.set_bool("referencesProvider", self.references_provider)
            val references_set = true
            expect(references_set)

        it "sets documentSymbolProvider":
            # Branch: builder.set_bool("documentSymbolProvider", self.document_symbol_provider)
            val symbol_set = true
            expect(symbol_set)

        it "sets workspaceSymbolProvider":
            # Branch: builder.set_bool("workspaceSymbolProvider", self.workspace_symbol_provider)
            val workspace_set = true
            expect(workspace_set)

        it "sets codeActionProvider":
            # Branch: builder.set_bool("codeActionProvider", self.code_action_provider)
            val action_set = true
            expect(action_set)

        it "sets documentFormattingProvider":
            # Branch: builder.set_bool("documentFormattingProvider", self.document_formatting_provider)
            val formatting_set = true
            expect(formatting_set)

        it "sets renameProvider":
            # Branch: builder.set_bool("renameProvider", self.rename_provider)
            val rename_set = true
            expect(rename_set)

    describe "Text Document Sync JSON":
        it "creates sync options dict":
            # Branch: var sync_opts: Dict<text, JsonValue> = {}
            val sync_opts_created = true
            expect(sync_opts_created)

        it "sets openClose in sync options":
            # Branch: sync_opts["openClose"] = JsonValue.bool(true)
            val open_close_set = true
            expect(open_close_set)

        it "sets change to incremental (2)":
            # Branch: sync_opts["change"] = JsonValue.Integer(2)
            val change_set = 2
            expect(change_set == 2)

        it "adds textDocumentSync object":
            # Branch: builder.set_object("textDocumentSync", sync_opts)
            val sync_added = true
            expect(sync_added)

        it "stringifies final JSON":
            # Branch: stringify(builder.build())
            val stringified = true
            expect(stringified)
