# Comprehensive tests for given: (unnamed eager) and given_lazy
# Tests the BDD framework's given/given_lazy fixture features

import std.spec

describe "Given (Eager Fixtures)":
    describe "Unnamed eager - given:":
        context "with eager setup":
            var setup_ran = false

            given:
                setup_ran = true

            it "setup_ran is available":
                expect setup_ran == true

            it "setup_ran is true in second example too":
                expect setup_ran == true

    describe "Named eager - before_each:":
        context "with named eager setup":
            var counter = 0
            var processed = false

            before_each:
                counter = counter + 1
                processed = true

            it "counter is initialized":
                expect counter == 1

            it "processed is true":
                expect processed == true

            it "each example gets fresh state":
                # If fixtures are run freshly, counter should be 1 each time
                expect counter == 1

    describe "Combining unnamed given and before_each":
        context "with mixed eager fixtures":
            var given_ran = false
            var before_each_ran = false

            given:
                given_ran = true

            before_each:
                before_each_ran = true

            it "both hooks ran":
                expect given_ran == true
                expect before_each_ran == true

            it "second example sees both hooks ran":
                # Both should run again for each example
                expect given_ran == true
                expect before_each_ran == true

    describe "Given with lazy fixtures":
        context "mixing eager and lazy":
            var eager_run_count = 0

            given:
                eager_run_count = eager_run_count + 1

            given_lazy(:lazy_value, \: 42)

            it "eager runs before lazy":
                expect eager_run_count == 1
                expect get_let(:lazy_value) == 42

            it "lazy is memoized, eager runs again":
                # Eager should run again (count = 1), lazy should be fresh
                expect eager_run_count == 1
                expect get_let(:lazy_value) == 42

    describe "Given in nested contexts":
        context "outer context":
            var level = "outer"

            given:
                level = "outer_setup"

            context "inner context":
                var inner_level = "inner"

                given:
                    inner_level = "inner_setup"

                it "level is available in inner":
                    # Both outer and inner givens should run
                    expect level == "outer_setup"
                    expect inner_level == "inner_setup"

    describe "Given in context_def":
        context_def :with_setup:
            given_lazy(:ctx_value, \: 100)

        context :with_setup:
            it "context_def given works":
                expect get_let(:ctx_value) == 100

    describe "Real-world database simulation":
        context "with realistic setup":
            var connection = nil
            var tables = []
            var setup_count = 0

            given:
                setup_count = setup_count + 1
                connection = "db_connection_established"
                tables = ["users", "posts", "comments"]

            it "connection established":
                expect connection == "db_connection_established"

            it "tables created":
                expect len(tables) == 3

            it "users table exists":
                expect len(tables) > 0
                if len(tables) > 0:
                    expect tables[0] == "users"

            it "second test gets fresh setup":
                # setup_count should be 1 for each test (fresh state)
                expect setup_count == 1

    describe "Referencing context_def with given_lazy":
        context_def :with_database:
            given_lazy(:database, \: "db_connection")

        context_def :with_token:
            given_lazy(:token, \: "auth_token_123")

        context :with_database:
            it "has database from context_def":
                expect get_let(:database) == "db_connection"

        context :with_token:
            it "has token from context_def":
                expect get_let(:token) == "auth_token_123"

    describe "Context with additional given":
        context_def :with_base_value:
            given_lazy(:base, \: 10)

        context :with_base_value:
            var derived = 0

            given:
                derived = get_let(:base) * 2

            it "accesses fixture from context_def":
                expect get_let(:base) == 10

            it "uses derived variable from fixture":
                expect derived == 20

            it "combines context data with new variables":
                val combined = get_let(:base) + derived
                expect combined == 30

            it "each test gets fresh derived state":
                # derived should be recalculated for each test
                expect derived == 20
