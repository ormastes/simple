"""
File I/O Operations Test Suite
Feature: File I/O Module Operations
Category: Infrastructure, I/O
Status: Complete

Tests for file I/O operations including reading, writing, directory listing,
path manipulation (basename, dirname, extension), and error handling.
"""

use infra.{file_exist, read_file, write_file, list_dir, basename, dirname, extension, absolute_path}
use testing.{describe, it, expect}

describe "File I/O Operations":
    """
    Tests for file read/write, existence checks, and path operations.
    """

    it "should check file existence":
        # Create a test file
        val test_path = "/tmp/simple_test_file.txt"
        val write_result = write_file(test_path, "test content")
        expect(write_result.is_ok()).to_be(true)

        # Check existence
        expect(file_exist(test_path)).to_be(true)
        expect(file_exist("/tmp/nonexistent_file.txt")).to_be(false)

    it "should write and read files":
        val test_path = "/tmp/simple_test_rw.txt"
        val content = "Hello, Simple!"

        # Write file
        val write_result = write_file(test_path, content)
        expect(write_result.is_ok()).to_be(true)

        # Read file
        val read_result = read_file(test_path)
        expect(read_result.is_ok()).to_be(true)

        match read_result:
            Ok(text):
                expect(text).to_eq(content)
            Err(_):
                fail("Should have read file successfully")

    it "should handle read errors for non-existent files":
        val result = read_file("/tmp/definitely_does_not_exist_123456.txt")
        expect(result.is_err()).to_be(true)

        match result:
            Err(msg):
                expect(msg).to_contain("does not exist")
            Ok(_):
                fail("Should have failed to read non-existent file")

    it "should extract basename from path":
        expect(basename("/home/user/file.txt")).to_eq("file.txt")
        expect(basename("/path/to/dir/")).to_eq("dir")
        expect(basename("simple.spl")).to_eq("simple.spl")

    it "should extract dirname from path":
        expect(dirname("/home/user/file.txt")).to_eq("/home/user")
        expect(dirname("/path/to/dir/")).to_eq("/path/to")

    it "should extract file extension":
        expect(extension("/home/user/file.txt")).to_eq("txt")
        expect(extension("archive.tar.gz")).to_eq("gz")
        expect(extension("noext")).to_eq("")

    it "should list directory contents":
        # List /tmp directory (should exist on Unix systems)
        val result = list_dir("/tmp")
        expect(result.is_ok()).to_be(true)

        # List non-existent directory
        val err_result = list_dir("/nonexistent_dir_12345")
        expect(err_result.is_err()).to_be(true)
