"""
Feature: SDN Value Operations
Category: SDN Parser
Status: Complete
"""

# Tests for SdnValue operations using parse() to create values

import std.spec
use sdn.parser.parse

describe "SDN Value":
    """
    SdnValue type checking, conversions, and value accessor methods.
    """
    context "type checking":
        it "identifies null values":
            match parse("v: null"):
                case Ok(doc):
                    val v = doc.get("v").unwrap()
                    expect v.is_null()
                    expect not v.is_bool()
                case Err(e):
                    fail("Parse failed: ${e.to_string()}")

        it "identifies boolean values":
            match parse("v: true"):
                case Ok(doc):
                    val v = doc.get("v").unwrap()
                    expect v.is_bool()
                    expect not v.is_null()
                case Err(e):
                    fail("Parse failed: ${e.to_string()}")

        it "identifies integer values":
            match parse("v: 42"):
                case Ok(doc):
                    val v = doc.get("v").unwrap()
                    expect v.is_int()
                    expect v.is_number()
                case Err(e):
                    fail("Parse failed: ${e.to_string()}")

        it "identifies float values":
            match parse("v: 3.14"):
                case Ok(doc):
                    val v = doc.get("v").unwrap()
                    expect v.is_float()
                    expect v.is_number()
                case Err(e):
                    fail("Parse failed: ${e.to_string()}")

        it "identifies string values":
            match parse("v: \"hello\""):
                case Ok(doc):
                    val v = doc.get("v").unwrap()
                    expect v.is_string()
                case Err(e):
                    fail("Parse failed: ${e.to_string()}")

        it "identifies dict values":
            match parse("v:\n    a: 1"):
                case Ok(doc):
                    val v = doc.get("v").unwrap()
                    expect v.is_dict()
                case Err(e):
                    fail("Parse failed: ${e.to_string()}")

        it "identifies array values":
            match parse("v = [1, 2, 3]"):
                case Ok(doc):
                    val v = doc.get("v").unwrap()
                    expect v.is_array()
                case Err(e):
                    fail("Parse failed: ${e.to_string()}")

    context "type conversions":
        it "converts to bool":
            match parse("v: true"):
                case Ok(doc):
                    val v = doc.get("v").unwrap()
                    expect v.as_bool() == Some(true)
                case Err(e):
                    fail("Parse failed: ${e.to_string()}")

        it "converts to i64":
            match parse("v: 42"):
                case Ok(doc):
                    val v = doc.get("v").unwrap()
                    expect v.as_i64() == Some(42)
                case Err(e):
                    fail("Parse failed: ${e.to_string()}")

        it "converts to f64":
            match parse("v: 3.14"):
                case Ok(doc):
                    val v = doc.get("v").unwrap()
                    expect v.as_f64().is_some()
                case Err(e):
                    fail("Parse failed: ${e.to_string()}")

        it "converts to string":
            match parse("v: hello"):
                case Ok(doc):
                    val v = doc.get("v").unwrap()
                    expect v.as_str() == Some("hello")
                case Err(e):
                    fail("Parse failed: ${e.to_string()}")

        it "returns None for invalid conversions":
            match parse("v: null"):
                case Ok(doc):
                    val v = doc.get("v").unwrap()
                    expect v.as_bool() == None
                    expect v.as_i64() == None
                    expect v.as_str() == None
                case Err(e):
                    fail("Parse failed: ${e.to_string()}")

    context "value methods":
        it "checks null value":
            match parse("v: null"):
                case Ok(doc):
                    val v = doc.get("v").unwrap()
                    expect v.is_null()
                case Err(e):
                    fail("Parse failed: ${e.to_string()}")

        it "gets bool value":
            match parse("v: false"):
                case Ok(doc):
                    val v = doc.get("v").unwrap()
                    expect v.as_bool() == Some(false)
                case Err(e):
                    fail("Parse failed: ${e.to_string()}")

        it "gets int value":
            match parse("v: 100"):
                case Ok(doc):
                    val v = doc.get("v").unwrap()
                    expect v.as_i64() == Some(100)
                case Err(e):
                    fail("Parse failed: ${e.to_string()}")

        it "gets string value":
            match parse("v: test"):
                case Ok(doc):
                    val v = doc.get("v").unwrap()
                    expect v.as_str() == Some("test")
                case Err(e):
                    fail("Parse failed: ${e.to_string()}")
