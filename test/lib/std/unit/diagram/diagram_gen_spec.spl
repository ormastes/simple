# Diagram Generation Integration Tests
#
# Tests the diagram generation API with FFI tracing
"""
Diagram generation integration tests for mermaid output.
Validates sequence diagrams, class diagrams, and architecture diagrams
generated from FFI-traced method calls and architectural markers.
"""

use std.spec
use std.spec.diagram

describe "Diagram Generation":
    """
    Tests diagram generation API including FFI recording, sequence diagrams,
    class diagrams, and architecture diagrams from traced method calls.
    """
    context "FFI Recording":
        it "enables and disables recording":
            enable_ffi_recording()
            disable_ffi_recording()
            # No assertion needed - just verifies FFI calls work

        it "clears recorded events":
            enable_ffi_recording()
            trace_method("TestClass", "testMethod", [])
            clear_ffi_recording()
            disable_ffi_recording()

    context "Sequence Diagram":
        it "generates mermaid sequence diagram":
            clear_ffi_recording()
            enable_ffi_recording()

            # Trace some method calls
            trace_method("UserService", "authenticate", ["user", "pass"])
            trace_method("Database", "query", ["SELECT * FROM users"])
            trace_return(Some("user_record"))

            val diagram = generate_sequence_ffi()
            disable_ffi_recording()

            expect diagram.contains("sequenceDiagram")
            expect diagram.contains("UserService")
            expect diagram.contains("Database")

        it "captures method calls with arguments":
            clear_ffi_recording()
            enable_ffi_recording()

            trace_method("Calculator", "add", ["1", "2"])
            trace_method("Calculator", "multiply", ["3", "4"])

            val diagram = generate_sequence_ffi()
            disable_ffi_recording()

            expect diagram.contains("Calculator")
            expect diagram.contains("add")
            expect diagram.contains("multiply")

    context "Class Diagram":
        it "generates mermaid class diagram":
            clear_ffi_recording()
            enable_ffi_recording()

            trace_method("OrderService", "createOrder", [])
            trace_method("OrderService", "validateOrder", [])
            trace_method("PaymentGateway", "charge", [])

            val diagram = generate_class_ffi()
            disable_ffi_recording()

            expect diagram.contains("classDiagram")
            expect diagram.contains("class OrderService")
            expect diagram.contains("class PaymentGateway")

        it "extracts methods from calls":
            clear_ffi_recording()
            enable_ffi_recording()

            trace_method("User", "save", [])
            trace_method("User", "validate", [])
            trace_method("User", "notify", [])

            val diagram = generate_class_ffi()
            disable_ffi_recording()

            expect(diagram).to(include_string("+save()"))
            expect(diagram).to(include_string("+validate()"))
            expect(diagram).to(include_string("+notify()"))

    context "Architecture Diagram":
        it "generates flowchart for architectural entities":
            clear_ffi_recording()
            enable_ffi_recording()

            mark_architectural("Gateway")
            mark_architectural("Service")
            mark_architectural("Database")

            trace_method("Gateway", "receive", [])
            trace_method("Service", "process", [])
            trace_method("Database", "store", [])

            val diagram = generate_arch_ffi()
            disable_ffi_recording()

            expect diagram.contains("flowchart TD")
            expect diagram.contains("Gateway")
            expect diagram.contains("Service")
            expect diagram.contains("Database")

        it "shows connections between components":
            clear_ffi_recording()
            enable_ffi_recording()

            mark_architectural("API")
            mark_architectural("Cache")
            mark_architectural("DB")

            trace_method("API", "request", [])
            trace_method("Cache", "lookup", [])
            trace_method("DB", "query", [])

            val diagram = generate_arch_ffi()
            disable_ffi_recording()

            expect diagram.contains("-->")

    context "Real-World Example":
        it "traces authentication flow":
            clear_ffi_recording()
            enable_ffi_recording()

            # Simulate authentication flow
            trace_method("LoginController", "handleLogin", ["email", "password"])
            trace_method("AuthService", "authenticate", ["email", "password"])
            trace_method("UserRepository", "findByEmail", ["email"])
            trace_return(Some("User"))
            trace_method("PasswordHasher", "verify", ["password", "hash"])
            trace_return(Some("true"))
            trace_method("TokenService", "generateToken", ["userId"])
            trace_return(Some("jwt_token"))

            val seq_diagram = generate_sequence_ffi()
            val class_diagram = generate_class_ffi()

            disable_ffi_recording()

            # Verify sequence diagram
            expect seq_diagram.contains("LoginController")
            expect seq_diagram.contains("AuthService")
            expect seq_diagram.contains("UserRepository")

            # Verify class diagram
            expect class_diagram.contains("class LoginController")
            expect class_diagram.contains("class AuthService")
