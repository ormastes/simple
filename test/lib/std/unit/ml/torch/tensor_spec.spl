"""
ML Tensor Operations Tests
Feature: ML Tensor Types and Devices
Category: ML, Tensor
Status: Complete

Tests for ml.torch module including DType classification,
size information, and Device capabilities.
"""

import std.spec
import ml.torch.device.Device
import ml.torch.dtype.DType

describe "PyTorch DType":
    """
    Tests for DType enum including type classification and size information.
    """
    context "type classification":
        it "identifies float types":
            expect DType::Float32.is_float()
            expect DType::Float64.is_float()
            expect not DType::Int32.is_float()
            expect not DType::Int64.is_float()

        it "identifies int types":
            expect DType::Int32.is_int()
            expect DType::Int64.is_int()
            expect not DType::Float32.is_int()
            expect not DType::Float64.is_int()

        it "identifies 32-bit types":
            expect DType::Float32.is_32bit()
            expect DType::Int32.is_32bit()
            expect not DType::Float64.is_32bit()
            expect not DType::Int64.is_32bit()

        it "identifies 64-bit types":
            expect DType::Float64.is_64bit()
            expect DType::Int64.is_64bit()
            expect not DType::Float32.is_64bit()
            expect not DType::Int32.is_64bit()

    context "size information":
        it "returns correct byte size":
            expect DType::Float32.byte_size() == 4
            expect DType::Int32.byte_size() == 4
            expect DType::Float64.byte_size() == 8
            expect DType::Int64.byte_size() == 8

        it "returns correct bit size":
            expect DType::Float32.bit_size() == 32
            expect DType::Float64.bit_size() == 64

describe "PyTorch Device":
    context "device types":
        it "creates CPU device":
            val d = Device::CPU
            expect d.is_cpu()
            expect not d.is_cuda()

        it "creates CUDA device":
            val d = Device::CUDA(0)
            expect d.is_cuda()
            expect not d.is_cpu()

        it "gets CUDA device id":
            val d = Device::CUDA(2)
            expect d.cuda_id() == Some(2)

        it "returns None for CPU cuda_id":
            val d = Device::CPU
            expect d.cuda_id() == None

    context "device capabilities":
        it "reports CPU as not accelerated":
            val d = Device::CPU
            expect not d.is_accelerated()

        it "reports CUDA as accelerated":
            val d = Device::CUDA(0)
            expect d.is_accelerated()

        it "reports CPU FP16 support":
            val d = Device::CPU
            expect not d.supports_fp16()

        it "reports CUDA FP16 support":
            val d = Device::CUDA(0)
            expect d.supports_fp16()
