# Linear Algebra Operations Test Suite
# Tests for ml.torch.linalg module

import std.spec
import ml.torch as torch
import ml.torch.linalg as linalg
import ml.torch.ffi_helpers as helpers
import ml.torch.device.Device
import ml.torch.dtype.DType

class MockTensor:
    shape: [i64]

    fn new(shape: [i64]) -> MockTensor:
        MockTensor(shape)

class MockLinAlg:
    fn supports_eigenvalues() -> bool:
        return true

    fn supports_svd() -> bool:
        return true

describe "Linear Algebra":
    context "matrix operations":
        it "computes determinant":
            val device = Device::CUDA(1)
            val A = helpers.randn_2d(5, 5, device=device)
            val det = linalg.det(A)
            expect det.numel() == 1
            expect det.device().cuda_id() == Some(1)

        it "computes matrix inverse":
            val device = Device::CUDA(1)
            val A = helpers.randn_2d(4, 4, device=device)
            val A_inv = linalg.inv(A)
            expect A_inv.shape() == [4, 4]
            expect A_inv.device().cuda_id() == Some(1)

        it "solves linear system":
            val device = Device::CUDA(1)
            val A = helpers.randn_2d(6, 6, device=device)
            val b = helpers.randn_2d(6, 1, device=device)
            val x = linalg.solve(A, b)
            expect x.shape() == [6, 1]
            expect x.device().cuda_id() == Some(1)

    context "advanced operations":
        it "computes eigenvalues":
            val linalg = MockLinAlg()
            expect linalg.supports_eigenvalues()

        it "computes SVD":
            val linalg = MockLinAlg()
            expect linalg.supports_svd()
