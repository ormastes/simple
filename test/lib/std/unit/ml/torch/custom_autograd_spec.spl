"""
Custom Autograd Function Tests
Feature: ML Custom Autograd Functions
Category: ML, Autograd
Status: Complete

Tests for ml.torch custom autograd capabilities including gradient
context management with no_grad and enable_grad.
"""
# @skip

use ml.torch as torch
use ml.torch.autograd as autograd
use ml.torch.ffi_helpers as helpers
use ml.torch.device.Device
use ml.torch.dtype.DType

describe "Custom Autograd Functions":
    """
    Tests for custom autograd functions and context management.
    """
    context "autograd context":
        it "tracks gradients in computation":
            val device = Device.CUDA(1)
            val x = helpers.randn_1d(4, device=device)
            x.set_requires_grad(true)
            val y = x.mul_scalar(5.0)
            expect y.requires_grad()

        it "respects no_grad context":
            val device = Device.CUDA(1)
            val x = helpers.randn_1d(4, device=device)
            with autograd.no_grad():
                val y = x.mul_scalar(2.0)
                val has_grad = y.requires_grad()
                expect not has_grad

        it "respects enable_grad context":
            val device = Device.CUDA(1)
            val x = helpers.randn_1d(4, device=device)
            x.set_requires_grad(true)
            with autograd.no_grad():
                with autograd.enable_grad():
                    val y = x.mul_scalar(3.0)
                    expect y.requires_grad()
