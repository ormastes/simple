# Custom Autograd Function Tests
# Tests for ml.torch custom autograd capabilities

import std.spec
import ml.torch as torch
import ml.torch.autograd as autograd
import ml.torch.device.Device
import ml.torch.dtype.DType

describe "Custom Autograd Functions":
    context "autograd context":
        it "tracks gradients in computation":
            val device = Device::CUDA(1)
            val x = torch.randn([4], device=device)
            x.set_requires_grad(true)
            val y = x.mul_scalar(5.0)
            expect y.requires_grad()

        it "respects no_grad context":
            val device = Device::CUDA(1)
            val x = torch.randn([4], device=device)
            with autograd.no_grad():
                val y = x.mul_scalar(2.0)
                expect !y.requires_grad()

        it "respects enable_grad context":
            val device = Device::CUDA(1)
            val x = torch.randn([4], device=device)
            x.set_requires_grad(true)
            with autograd.no_grad():
                with autograd.enable_grad():
                    val y = x.mul_scalar(3.0)
                    expect y.requires_grad()
