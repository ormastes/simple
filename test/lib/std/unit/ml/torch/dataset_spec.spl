# PyTorch Dataset Tests
# Tests for ml.torch.data module

import std.spec
import ml.torch as torch
import ml.torch.data as data
import ml.torch.device.Device

describe "Dataset":
    context "custom dataset":
        it "creates custom dataset":
            class SimpleDataset(data.Dataset):
                size: i64

                fn __init__(size: i64):
                    self.size = size

                fn __len__() -> i64:
                    return self.size

                fn __getitem__(index: i64) -> i64:
                    return index

            val ds = SimpleDataset(100)
            expect ds.__len__() == 100

        it "implements __len__":
            class CustomDataset(data.Dataset):
                items: [i32]

                fn __init__():
                    self.items = [1, 2, 3, 4, 5]

                fn __len__() -> i64:
                    return self.items.len() as i64

                fn __getitem__(index: i64) -> i32:
                    return self.items[index as i32]

            val ds = CustomDataset()
            expect ds.__len__() == 5

        it "implements __getitem__":
            class IndexedDataset(data.Dataset):
                fn __init__():
                    pass

                fn __len__() -> i64:
                    return 10

                fn __getitem__(index: i64) -> i64:
                    return index * 2

            val ds = IndexedDataset()
            expect ds.__getitem__(5) == 10

describe "DataLoader":
    context "sampler":
        it "creates sequential sampler":
            val sampler = data.SequentialSampler(10)
            val indices = sampler.__iter__()
            expect indices.len() == 10

        it "creates random sampler":
            val sampler = data.RandomSampler(10)
            val indices = sampler.__iter__()
            expect indices.len() == 10

        it "batches data":
            class BatchDataset(data.Dataset):
                fn __len__() -> i64:
                    return 20

                fn __getitem__(index: i64) -> i64:
                    return index

            val ds = BatchDataset()
            expect ds.__len__() == 20
