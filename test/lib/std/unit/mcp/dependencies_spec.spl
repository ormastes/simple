"""
Feature: Simple Dependency Extraction
Category: MCP Integration
Status: In Progress

Tests for extracting and analyzing Symbol dependencies and circular dependencies
in Simple language modules using the MCP dependency extraction API.
"""

# @slow
# Performance note: ~1.4 seconds runtime. Exclude for quick dev cycles.

use mcp.simple_lang.dependencies

describe "Simple dependency extraction":
    it "tracks symbol usage across import styles":
        val source = """
module app.core:

use std.io as io
use std.math.{abs, max}
use foo.bar
from utils.helpers use trim, slug
pub use app.api

pub fn run():
    io.println("hi")
    val x = abs(-1)
    val y = trim("a")
    val z = foo.bar.baz()
    return max(x, 2)

pub fn helper():
    val v = slug("a")
    return v
"""

        val graph = extract_dependencies(source)

        expect graph.symbol_usage.contains_key("std.io")
        expect graph.symbol_usage.get("std.io").contains("run")

        expect graph.symbol_usage.contains_key("abs")
        expect graph.symbol_usage.get("abs").contains("run")
        expect graph.symbol_usage.contains_key("max")
        expect graph.symbol_usage.get("max").contains("run")

        expect graph.symbol_usage.contains_key("trim")
        expect graph.symbol_usage.get("trim").contains("run")
        expect graph.symbol_usage.contains_key("slug")
        expect graph.symbol_usage.get("slug").contains("helper")

        expect graph.symbol_usage.contains_key("foo.bar")
        expect graph.symbol_usage.get("foo.bar").contains("run")

        # Also test cycle detection
        val cycle_source = """
module core:
use core

pub fn run():
    return 1
"""

        val cycle_graph = extract_dependencies(cycle_source)
        val cycles = detect_circular_dependencies(cycle_graph)

        expect cycles.len() == 1
        expect cycles[0] == "core -> core"
