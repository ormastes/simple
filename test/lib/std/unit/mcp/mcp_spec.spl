"""
MCP Protocol Tests
Feature: Model Context Protocol Types
Category: MCP, Protocol
Status: Complete

Tests for the Model Context Protocol types including BlockMark,
Visibility, SymbolKind, Symbol, and MCP metadata types.
"""

# @slow
# Performance note: ~2 seconds runtime. Exclude for quick dev cycles.

use mcp.simple_lang.types

describe "BlockMark":
    """
    Tests for BlockMark enum representing collapsed/expanded code blocks.
    """
    it "creates block marks":
        val class_mark = BlockMark.ClassCollapsed
        val func_mark = BlockMark.FunctionExpanded
        expect(class_mark.is_class_collapsed())
        expect(func_mark.is_function_expanded())

    it "converts block marks to strings":
        expect(block_mark_to_string(BlockMark.ClassCollapsed) == "C>")
        expect(block_mark_to_string(BlockMark.ClassExpanded) == "C▼")
        expect(block_mark_to_string(BlockMark.FunctionCollapsed) == "F>")
        expect(block_mark_to_string(BlockMark.FunctionExpanded) == "F▼")
        expect(block_mark_to_string(BlockMark.TraitCollapsed) == "T>")
        expect(block_mark_to_string(BlockMark.VirtualInfo) == "V•")

    it "checks collapsed vs expanded":
        expect(BlockMark.ClassCollapsed.is_collapsed())
        expect(not BlockMark.ClassCollapsed.is_expanded())
        expect(BlockMark.FunctionExpanded.is_expanded())
        expect(not BlockMark.FunctionExpanded.is_collapsed())

    it "provides descriptions":
        expect(BlockMark.ClassCollapsed.description() == "Collapsed class definition")
        expect(BlockMark.FunctionExpanded.description() == "Expanded function")
        expect(BlockMark.VirtualInfo.description() == "Virtual method info")

describe "Visibility":
    it "converts to string":
        expect(Visibility.Public.to_string() == "public")
        expect(Visibility.Private.to_string() == "private")

    it "checks access":
        expect(Visibility.Public.is_public())
        expect(Visibility.Public.allows_external_access())
        expect(Visibility.Private.is_private())
        expect(not Visibility.Private.allows_external_access())

describe "SymbolKind":
    it "converts to string":
        expect(SymbolKind.Class.to_string() == "class")
        expect(SymbolKind.Function.to_string() == "function")
        expect(SymbolKind.Method.to_string() == "method")
        expect(SymbolKind.Trait.to_string() == "trait")

    it "checks type categories":
        expect(SymbolKind.Class.is_type_definition())
        expect(SymbolKind.Struct.is_type_definition())
        expect(SymbolKind.Trait.is_type_definition())
        expect(not SymbolKind.Function.is_type_definition())

    it "checks callables":
        expect(SymbolKind.Function.is_callable())
        expect(SymbolKind.Method.is_callable())
        expect(not SymbolKind.Class.is_callable())

describe "Symbol":
    it "creates new symbol":
        val sym = Symbol.new(SymbolKind.Function, "my_func", Visibility.Public)
        expect(sym.name == "my_func")
        expect(sym.kind.is_function())
        expect(sym.visibility.is_public())
        expect(sym.is_collapsed)

describe "McpMetadata":
    it "creates default metadata":
        val meta = McpMetadata.default()
        expect(meta.mode == "mcp")
        expect(meta.line_numbers == "plain")
        expect(not meta.show_coverage)
        expect(not meta.show_block_guides)

describe "McpOutput":
    it "creates output with text":
        val output = McpOutput.new("Hello MCP")
        expect(output.text == "Hello MCP")
        expect(output.meta == nil)
