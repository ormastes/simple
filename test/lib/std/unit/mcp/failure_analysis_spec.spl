"""
# MCP Failure Analysis Tools Specification

Tests the MCP database query tools that analyze test failures,
classify errors, extract needed features, and provide actionable insights.
"""

use mcp.simple_lang.db_tools.*
use mcp.core.*
use infra.file_io.{write_file, read_file}
use sdn.*


# ============================================================================
# Test Group 1: Error Classification
# ============================================================================

describe "Error Classification":
    """Tests the classify_error() function"""

    it "classifies explicit parse error":
        val error = "parse error: Unexpected token: expected Fn, found Static"
        val result = classify_error(error)
        expect(result).to(eq("parse_error"))

    it "classifies unexpected token error":
        val error = "Unexpected token: expected expression, found Default"
        val result = classify_error(error)
        expect(result).to(eq("parse_error"))

    it "classifies function not found error":
        val error = "compile failed: semantic: function `filter_internal_flags` not found"
        val result = classify_error(error)
        expect(result).to(eq("semantic_error"))

    it "classifies method not found error":
        val error = "compile failed: semantic: method `char_at` not found on type `array`"
        val result = classify_error(error)
        expect(result).to(eq("semantic_error"))

    it "classifies file not found error":
        val error = "failed to read /tmp/test_spec.spl: No such file or directory (os error 2)"
        val result = classify_error(error)
        expect(result).to(eq("file_not_found"))

    it "classifies timeout error":
        val error = "Test timed out after 30 seconds"
        val result = classify_error(error)
        expect(result).to(eq("timeout"))

    it "classifies UTF-8 error":
        val error = "failed to read test.spl: stream did not contain valid UTF-8"
        val result = classify_error(error)
        expect(result).to(eq("utf8_error"))

    it "classifies unknown error":
        val error = "Something completely unexpected happened"
        val result = classify_error(error)
        expect(result).to(eq("unknown_error"))


# ============================================================================
# Test Group 2: Feature Extraction
# ============================================================================

describe "Feature Extraction from Errors":
    """Tests the extract_needed_features() function"""

    it "extracts static fields feature":
        val error = "parse error: expected Fn, found Static"
        val features = extract_needed_features(error)
        expect(features).to(contain("static_fields"))

    it "extracts default parameters feature":
        val error = "parse error: expected expression, found Default"
        val features = extract_needed_features(error)
        expect(features).to(contain("default_parameters"))

    it "extracts implicit val/var feature":
        val error = "parse error: expected expression, found Assign"
        val features = extract_needed_features(error)
        expect(features).to(contain("implicit_val_var"))

    it "extracts matrix multiplication feature":
        val error = "compile failed: parse: Unexpected token: expected expression, found At"
        val features = extract_needed_features(error)
        expect(features).to(contain("matrix_multiplication"))

    it "extracts XOR keyword feature":
        val error = "compile failed: parse: Unexpected token: expected identifier, found Xor"
        val features = extract_needed_features(error)
        expect(features).to(contain("xor_keyword"))

    it "extracts dict literal syntax feature":
        val error = "compile failed: parse: Unexpected token: expected Comma, found Colon"
        val features = extract_needed_features(error)
        expect(features).to(contain("dict_literal_syntax"))

    it "extracts list comprehension feature":
        val error = "parse error: expected expression, found For"
        val features = extract_needed_features(error)
        expect(features).to(contain("list_comprehension"))

    it "extracts string method feature":
        val error = "compile failed: semantic: method `char_at` not found on type `array`"
        val features = extract_needed_features(error)
        expect(features).to(contain("string_char_at_method"))

    it "returns empty list for generic error":
        val error = "Something went wrong"
        val features = extract_needed_features(error)
        expect(features.len()).to(eq(0))


# ============================================================================
# Test Group 3: Text Truncation Helper
# ============================================================================

describe "Text Truncation":
    """Tests the truncate_text() helper"""

    it "keeps short text unchanged":
        val text = "Short text"
        val result = truncate_text(text, 100)
        expect(result).to(eq("Short text"))

    it "truncates long text and adds ellipsis":
        val text = "This is a very long text that should be truncated to a reasonable length for display purposes"
        val result = truncate_text(text, 20)
        expect(result.len()).to(eq(23))  # 20 + "..."
        expect(result).to(contain("..."))


# ============================================================================
# Test Group 4: Tool Integration
# ============================================================================

describe "MCP Tool Creation":
    """Tests that tools are created successfully"""

    it "creates all database query tools":
        val tools = create_db_query_tools()
        expect(tools.len()).to(eq(8))

    it "creates query_failed_test_details tool":
        val tool = create_query_failed_test_details_tool()
        expect(tool).not_to(be_nil())

    it "creates analyze_failures tool":
        val tool = create_analyze_failures_tool()
        expect(tool).not_to(be_nil())

    it "creates find_features_for_failed_tests tool":
        val tool = create_find_features_for_failed_tests_tool()
        expect(tool).not_to(be_nil())
