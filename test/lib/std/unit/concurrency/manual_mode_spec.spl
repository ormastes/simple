"""
Manual Mode Execution Tests

Tests for the embedded/manual execution mode for futures.
In manual mode, futures must be explicitly polled before they execute.
"""

# Manual mode tests - must set mode before any futures are created
# This file tests the embedded/manual execution mode for futures

# Set manual mode at module level before any futures
async_mode("manual")

describe "Manual Mode Execution":
    """
    Tests for manual async mode where futures require explicit polling.
    Covers polling behavior, auto-polling on await, and captures in manual mode.
    """
    it "is in manual mode":
        val mode = async_mode()
        expect mode == "manual"

    it "futures are pending until polled":
        val f = future(42)
        # In manual mode, future doesn't execute until polled
        val completed = poll_future(f)
        expect completed
        expect await f == 42

    it "polling multiple futures individually":
        val f1 = future(10)
        val f2 = future(20)
        # Poll each future
        poll_future(f1)
        poll_future(f2)
        expect await f1 == 10
        expect await f2 == 20

    it "await auto-polls in manual mode":
        val f = future(100)
        # await should auto-poll if needed
        expect await f == 100

    it "resolved futures work in manual mode":
        val f = resolved(42)
        expect is_ready(f)
        expect await f == 42

    it "futures with captures in manual mode":
        val base = 40
        val f = future(base + 2)
        poll_future(f)
        expect await f == 42

    it "computation in manual mode":
        val f = future(10 + 20 + 30)
        poll_future(f)
        expect await f == 60

    it "multiple captures in manual mode":
        val a = 10
        val b = 20
        val c = 12
        val f = future(a + b + c)
        poll_future(f)
        expect await f == 42
