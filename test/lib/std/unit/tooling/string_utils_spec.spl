"""
Feature: String Utilities
Category: Tooling
Status: Complete

Unit tests for string manipulation utilities including repeat, reverse,
whitespace detection, character search, string joining, and case-insensitive comparison.
"""

use std.spec

# =====================================
# String Utility Implementations
# =====================================

fn repeat_str(s: text, n: i64) -> text:
    if n <= 0: return ""
    var result = ""
    for _ in 0..n:
        result = result + s
    result

fn reverse_str(s: text) -> text:
    var result = ""
    val chars = s.chars()
    for i in 0..chars.len():
        result = chars[chars.len() - 1 - i].to_string() + result
    result

fn is_whitespace(s: text) -> bool:
    for c in s.chars():
        if c != ' ' and c != '\t' and c != '\n' and c != '\r':
            return false
    true

fn contains_char(s: text, c: char) -> bool:
    for ch in s.chars():
        if ch == c:
            return true
    false

fn count_char(s: text, c: char) -> i64:
    var count = 0
    for ch in s.chars():
        if ch == c:
            count = count + 1
    count

fn starts_with_char(s: text, c: char) -> bool:
    if s.len() == 0: return false
    s.chars()[0] == c

fn ends_with_char(s: text, c: char) -> bool:
    if s.len() == 0: return false
    val chars = s.chars()
    chars[chars.len() - 1] == c

fn index_of_char(s: text, c: char) -> Option<i64>:
    val chars = s.chars()
    for i in 0..chars.len():
        if chars[i] == c:
            return Some(i)
    nil

fn join_strs(list: [text], sep: text) -> text:
    if list.len() == 0: return ""
    var result = list[0]
    for i in 1..list.len():
        result = result + sep + list[i]
    result

fn compare_case_insensitive(a: text, b: text) -> bool:
    a.to_lowercase() == b.to_lowercase()

# =====================================
# BDD Tests
# =====================================

describe "String Utilities":
    """Tests for string manipulation and character searching operations."""

    describe "Repeat":
        it "repeats string n times":
            expect repeat_str("ab", 3) == "ababab"
            expect repeat_str("x", 5) == "xxxxx"

        it "returns empty for zero repeats":
            expect repeat_str("test", 0) == ""

        it "handles empty string":
            expect repeat_str("", 5) == ""

    describe "Reverse":
        it "reverses string":
            expect reverse_str("hello") == "olleh"
            expect reverse_str("12345") == "54321"

        it "handles empty string":
            expect reverse_str("") == ""

        it "handles single char":
            expect reverse_str("a") == "a"

    describe "Whitespace":
        it "detects all whitespace":
            expect is_whitespace("   ")
            expect is_whitespace("\t\n")

        it "detects non-whitespace":
            expect not is_whitespace("hello")

        it "handles empty string":
            expect is_whitespace("")

    describe "Character Search":
        it "contains_char finds char":
            expect contains_char("hello", 'e')
            expect not contains_char("hello", 'x')

        it "count_char counts occurrences":
            expect count_char("hello", 'l') == 2
            expect count_char("hello", 'e') == 1
            expect count_char("hello", 'x') == 0

        it "starts_with_char works":
            expect starts_with_char("hello", 'h')
            expect not starts_with_char("hello", 'w')

        it "ends_with_char works":
            expect ends_with_char("hello", 'o')
            expect not ends_with_char("hello", 'x')

        it "index_of_char finds index":
            match index_of_char("hello", 'e'):
                case Some(idx): expect idx == 1
                case nil: expect false

        it "index_of_char returns nil for missing":
            match index_of_char("hello", 'x'):
                case Some(_): expect false
                case nil: expect true

    describe "Join":
        it "joins strings with separator":
            expect join_strs(["a", "b", "c"], ",") == "a,b,c"
            expect join_strs(["hello", "world"], " ") == "hello world"

        it "handles empty list":
            val empty: [text] = []
            expect join_strs(empty, ",") == ""

        it "handles single element":
            expect join_strs(["single"], ",") == "single"

    describe "Case Insensitive Compare":
        it "compares ignoring case":
            expect compare_case_insensitive(a="Hello", b="hello")
            expect compare_case_insensitive(a="WORLD", b="world")
            expect not compare_case_insensitive(a="test", b="best")
