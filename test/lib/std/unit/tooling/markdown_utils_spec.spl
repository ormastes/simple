"""
Feature: Markdown Utilities
Category: Standard Library / Tooling
Status: Complete

Complete markdown generation utilities covering formatting, links, lists,
tables, code blocks, and document structure with full syntax support.
"""

use std.spec

# =====================================
# Markdown Utility Implementations
# =====================================

fn h1(txt: text) -> text: "# " + txt
fn h2(txt: text) -> text: "## " + txt
fn h3(txt: text) -> text: "### " + txt

fn heading(txt: text, level: i64) -> text:
    var prefix = ""
    for _ in 0..level:
        prefix = prefix + "#"
    prefix + " " + txt

fn bold(txt: text) -> text: "**" + txt + "**"
fn italic(txt: text) -> text: "*" + txt + "*"
fn bold_italic(txt: text) -> text: "***" + txt + "***"
fn code(txt: text) -> text: "`" + txt + "`"
fn strikethrough(txt: text) -> text: "~~" + txt + "~~"

fn link(txt: text, url: text) -> text:
    "[" + txt + "](" + url + ")"

fn image(alt: text, url: text) -> text:
    "![" + alt + "](" + url + ")"

fn link_with_title(txt: text, url: text, title_txt: text) -> text:
    "[" + txt + "](" + url + " \"" + title_txt + "\")"

fn reference_link(txt: text, ref: text) -> text:
    "[" + txt + "][" + ref + "]"

fn unordered_list(items: [text]) -> text:
    var lines: [text] = []
    for item in items:
        lines = lines + ["- " + item]
    lines.join("\n")

fn ordered_list(items: [text]) -> text:
    var lines: [text] = []
    for i in 0..items.len():
        lines = lines + [(i + 1).to_string() + ". " + items[i]]
    lines.join("\n")

fn checklist_item(txt: text, checked: bool) -> text:
    if checked:
        "- [x] " + txt
    else:
        "- [ ] " + txt

fn code_block(code_text: text, lang: text) -> text:
    "```" + lang + "\n" + code_text + "\n```"

fn code_block_plain(code_text: text) -> text:
    "```\n" + code_text + "\n```"

fn blockquote(txt: text) -> text: "> " + txt

fn blockquote_multi(lines: [text]) -> text:
    var result: [text] = []
    for line in lines:
        result = result + ["> " + line]
    result.join("\n")

fn horizontal_rule() -> text: "---"
fn hr() -> text: "---"

enum TableAlign:
    Left
    Center
    Right

fn table(headers: [text], rows: [[text]]) -> text:
    var result = "| " + headers.join(" | ") + " |\n"
    result = result + "|"
    for _ in headers:
        result = result + " --- |"
    result = result + "\n"
    for row in rows:
        result = result + "| " + row.join(" | ") + " |\n"
    result

fn table_with_align(headers: [text], rows: [[text]], alignments: [TableAlign]) -> text:
    var result = "| " + headers.join(" | ") + " |\n"
    result = result + "|"
    for align in alignments:
        match align:
            case TableAlign.Left: result = result + " :--- |"
            case TableAlign.Center: result = result + " :---: |"
            case TableAlign.Right: result = result + " ---: |"
    result = result + "\n"
    for row in rows:
        result = result + "| " + row.join(" | ") + " |\n"
    result

fn task_list(tasks: [(text, bool)]) -> text:
    var lines: [text] = []
    for task in tasks:
        lines = lines + [checklist_item(task.0, task.1)]
    lines.join("\n")

fn definition(term: text, def: text) -> text:
    term + "\n: " + def

fn footnote_ref(id: text) -> text:
    "[^" + id + "]"

fn footnote_def(id: text, content: text) -> text:
    "[^" + id + "]: " + content

fn front_matter(content: text) -> text:
    "---\n" + content + "\n---"

fn toc() -> text:
    "<!-- TOC -->"

fn escape_markdown(txt: text) -> text:
    var result = txt
    result = result.replace("*", "\\*")
    result = result.replace("#", "\\#")
    result = result.replace("[", "\\[")
    result = result.replace("]", "\\]")
    result

struct MarkdownSection:
    heading: text
    level: i64
    content: text

fn document(sections: [MarkdownSection]) -> text:
    var parts: [text] = []
    for section in sections:
        parts = parts + [heading(section.heading, section.level)]
        parts = parts + [section.content]
    parts.join("\n\n")

fn readme_template(name: text, description: text, installation: text, usage: text) -> text:
    var result = h1(name) + "\n\n"
    result = result + description + "\n\n"
    result = result + h2("Installation") + "\n\n"
    result = result + code_block(code_text=installation, lang="bash") + "\n\n"
    result = result + h2("Usage") + "\n\n"
    result = result + code_block(code_text=usage, lang="")
    result

fn badge(label: text, value: text, color: text) -> text:
    "![" + label + "](https://img.shields.io/badge/" + label + "-" + value + "-" + color + ")"

fn note(txt: text) -> text:
    "> **NOTE:** " + txt

fn warning(txt: text) -> text:
    "> **WARNING:** " + txt

fn important(txt: text) -> text:
    "> **IMPORTANT:** " + txt

# =====================================
# BDD Tests
# =====================================

describe "Markdown Utilities":
    """
    Tests for markdown generation utilities covering all major markdown
    syntax including formatting, links, lists, tables, and document structure.
    """

    describe "Headers":
        """Test markdown heading generation at various levels"""
        it "creates h1":
            expect h1("Title") == "# Title"

        it "creates h2":
            expect h2("Section") == "## Section"

        it "creates h3":
            expect h3("Subsection") == "### Subsection"

        it "creates heading with level":
            expect heading("Test", 4) == "#### Test"

    describe "Text Formatting":
        """Test text formatting operations including bold, italic, and code"""
        it "creates bold":
            expect bold("text") == "**text**"

        it "creates italic":
            expect italic("text") == "*text*"

        it "creates bold italic":
            expect bold_italic("text") == "***text***"

        it "creates inline code":
            expect code("variable") == "`variable`"

        it "creates strikethrough":
            expect strikethrough("old") == "~~old~~"

    describe "Links":
        """Test link and image generation"""
        it "creates link":
            val result = link(txt="Google", url="https://google.com")
            expect result == "[Google](https://google.com)"

        it "creates image":
            val result = image(alt="Alt text", url="/path/to/image.png")
            expect result == "![Alt text](/path/to/image.png)"

        it "creates link with title":
            val result = link_with_title(txt="Link", url="https://example.com", title_txt="Example")
            expect result.contains("[Link]")
            expect result.contains("Example")

        it "creates reference link":
            expect reference_link(txt="Text", ref="ref1") == "[Text][ref1]"

    describe "Lists":
        """Test list generation for unordered, ordered, and task lists"""
        it "creates unordered list":
            val result = unordered_list(["Apple", "Banana", "Cherry"])
            expect result.contains("- Apple")
            expect result.contains("- Banana")
            expect result.contains("- Cherry")

        it "creates ordered list":
            val result = ordered_list(["First", "Second", "Third"])
            expect result.contains("1. First")
            expect result.contains("2. Second")
            expect result.contains("3. Third")

        it "creates checklist items":
            val checked = checklist_item("Done task", true)
            expect checked.contains("[x]")

            val unchecked = checklist_item("Todo task", false)
            expect unchecked.contains("[ ]")

    describe "Code Blocks":
        """Test code block generation with language specification"""
        it "creates code block with language":
            val result = code_block(code_text="fn main():\n    pass", lang="simple")
            expect result.contains("```simple")
            expect result.contains("fn main()")
            expect result.contains("```")

        it "creates plain code block":
            val result = code_block_plain("some code")
            expect result.contains("```")
            expect result.contains("some code")

    describe "Blockquotes":
        """Test blockquote generation"""
        it "creates blockquote":
            expect blockquote("Quote") == "> Quote"

        it "creates multi-line blockquote":
            val result = blockquote_multi(["Line 1", "Line 2"])
            expect result.contains("> Line 1")
            expect result.contains("> Line 2")

    describe "Horizontal Rules":
        """Test horizontal rule generation"""
        it "creates horizontal rule":
            expect horizontal_rule() == "---"

        it "creates hr alias":
            expect hr() == "---"

    describe "Tables":
        """Test table generation with optional alignment"""
        it "creates table":
            val headers = ["Name", "Age"]
            val rows = [
                ["Alice", "30"],
                ["Bob", "25"]
            ]
            val result = table(headers, rows)
            expect result.contains("Name")
            expect result.contains("Age")
            expect result.contains("Alice")
            expect result.contains("---")
            expect result.contains("|")

        it "creates table with alignment":
            val headers = ["Left", "Center", "Right"]
            val rows = [["A", "B", "C"]]
            val alignments = [TableAlign.Left, TableAlign.Center, TableAlign.Right]
            val result = table_with_align(headers, rows, alignments)
            expect result.contains(":---")
            expect result.contains(":---:")
            expect result.contains("---:")

    describe "Task Lists":
        """Test task list generation"""
        it "creates task list":
            val tasks = [
                ("Complete task", true),
                ("Pending task", false)
            ]
            val result = task_list(tasks)
            expect result.contains("[x] Complete task")
            expect result.contains("[ ] Pending task")

    describe "Definitions":
        """Test definition list generation"""
        it "creates definition":
            val result = definition(term="Term", def="Definition text")
            expect result.contains("Term")
            expect result.contains(": Definition text")

    describe "Footnotes":
        """Test footnote generation"""
        it "creates footnote reference":
            expect footnote_ref("1") == "[^1]"

        it "creates footnote definition":
            val result = footnote_def(id="1", content="Footnote text")
            expect result.contains("[^1]:")
            expect result.contains("Footnote text")

    describe "Document Structure":
        """Test document-level markdown generation"""
        it "creates front matter":
            val result = front_matter("title: Test\nauthor: Me")
            expect result.contains("---")
            expect result.contains("title: Test")

        it "creates TOC placeholder":
            expect toc() == "<!-- TOC -->"

    describe "Helpers":
        """Test markdown character escaping and utilities"""
        it "escapes markdown characters":
            val escaped = escape_markdown("*test* #heading")
            expect escaped.contains("\\*")
            expect escaped.contains("\\#")

        it "creates document from sections":
            val sections = [
                MarkdownSection(heading: "Intro", level: 1, content: "Welcome"),
                MarkdownSection(heading: "Details", level: 2, content: "More info")
            ]
            val result = document(sections)
            expect result.contains("# Intro")
            expect result.contains("## Details")
            expect result.contains("Welcome")

    describe "Common Patterns":
        """Test common markdown document patterns"""
        it "creates README template":
            val result = readme_template(
                name="My Project",
                description="A cool project",
                installation="npm install my-project",
                usage="import my_project"
            )
            expect result.contains("# My Project")
            expect result.contains("## Installation")
            expect result.contains("## Usage")

        it "creates badge":
            val result = badge(label="build", value="passing", color="green")
            expect result.contains("build")
            expect result.contains("passing")
            expect result.contains("green")

        it "creates note":
            val result = note("Important information")
            expect result.contains("NOTE")
            expect result.contains("Important information")

        it "creates warning":
            val result = warning("Be careful")
            expect result.contains("WARNING")

        it "creates important":
            val result = important("Critical")
            expect result.contains("IMPORTANT")
