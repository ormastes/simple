# Tests for path utilities

use tooling.path_utils.*

# =====================================
# Filename Extraction Tests
# =====================================

fn test_get_filename_unix():
    assert(get_filename("/home/user/file.txt") == "file.txt")
    assert(get_filename("/home/user/") == "")
    assert(get_filename("file.txt") == "file.txt")

fn test_get_filename_windows():
    assert(get_filename("C:\\Users\\user\\file.txt") == "file.txt")
    assert(get_filename("C:\\Program Files\\app.exe") == "app.exe")

fn test_get_filename_edge_cases():
    assert(get_filename("") == "")
    assert(get_filename("/") == "")
    assert(get_filename("simple_file") == "simple_file")

# =====================================
# Directory Name Tests
# =====================================

fn test_get_dir_name():
    assert(get_dir_name("/home/user/documents") == "documents")
    assert(get_dir_name("/home/user/documents/") == "documents")
    assert(get_dir_name("C:\\Users\\user\\") == "user")

# =====================================
# Parent Directory Tests
# =====================================

fn test_get_parent_dir_unix():
    assert(get_parent_dir("/home/user/file.txt") == "/home/user")
    assert(get_parent_dir("/home/user/") == "/home")
    assert(get_parent_dir("/home") == "")

fn test_get_parent_dir_windows():
    assert(get_parent_dir("C:\\Users\\user\\file.txt") == "C:\\Users\\user")
    assert(get_parent_dir("C:\\Users\\") == "C:")

fn test_get_parent_dir_option():
    match get_parent_dir_option("/home/user/file.txt"):
        Some(parent) =>
            assert(parent == "/home/user")
        None =>
            assert(false)

fn test_get_parent_dir_option_none():
    match get_parent_dir_option("file.txt"):
        Some(_) =>
            assert(false)
        None =>
            assert(true)

# =====================================
# Path Joining Tests
# =====================================

fn test_join_path_unix():
    assert(join_path("/home/user", "file.txt") == "/home/user/file.txt")
    assert(join_path("/home/user/", "file.txt") == "/home/user/file.txt")

fn test_join_path_windows():
    assert(join_path("C:\\Users", "file.txt") == "C:\\Users\\file.txt")
    assert(join_path("C:\\Users\\", "file.txt") == "C:\\Users\\file.txt")

fn test_join_path_edge_cases():
    assert(join_path("", "file.txt") == "file.txt")
    assert(join_path("/home", "") == "/home")
    assert(join_path("", "") == "")

# =====================================
# Extension Tests
# =====================================

fn test_get_extension():
    assert(get_extension("file.txt") == "txt")
    assert(get_extension("archive.tar.gz") == "gz")
    assert(get_extension("/path/to/file.json") == "json")

fn test_get_extension_no_extension():
    assert(get_extension("README") == "")
    assert(get_extension("/path/to/file") == "")
    assert(get_extension("") == "")

fn test_get_extension_hidden_file():
    assert(get_extension(".gitignore") == "")
    assert(get_extension(".config.yml") == "yml")

# =====================================
# Stem Tests
# =====================================

fn test_get_stem():
    assert(get_stem("file.txt") == "file")
    assert(get_stem("archive.tar.gz") == "archive.tar")
    assert(get_stem("/path/to/document.pdf") == "document")

fn test_get_stem_no_extension():
    assert(get_stem("README") == "README")
    assert(get_stem("Makefile") == "Makefile")

# =====================================
# Has Extension Tests
# =====================================

fn test_has_extension():
    assert(has_extension("file.txt", "txt"))
    assert(has_extension("file.txt", ".txt"))
    assert(has_extension("archive.TAR", "tar"))  # Case insensitive

fn test_has_extension_false():
    assert(not has_extension("file.txt", "pdf"))
    assert(not has_extension("README", "txt"))

# =====================================
# Path Normalization Tests
# =====================================

fn test_normalize_path():
    assert(normalize_path("C:\\Users\\user\\file.txt") == "C:/Users/user/file.txt")
    assert(normalize_path("/home/user/file.txt") == "/home/user/file.txt")
    assert(normalize_path("path\\to\\file") == "path/to/file")

# =====================================
# Absolute Path Tests
# =====================================

fn test_is_absolute_path_unix():
    assert(is_absolute_path("/home/user/file.txt"))
    assert(is_absolute_path("/"))
    assert(not is_absolute_path("relative/path"))

fn test_is_absolute_path_windows():
    assert(is_absolute_path("C:\\Users\\user\\file.txt"))
    assert(is_absolute_path("D:/data/file.dat"))
    assert(not is_absolute_path("relative\\path"))

fn test_is_absolute_path_edge_cases():
    assert(not is_absolute_path(""))
    assert(not is_absolute_path("file.txt"))

# =====================================
# Make Relative Tests
# =====================================

fn test_make_relative():
    assert(make_relative("/home/user/docs/file.txt", "/home/user") == "docs/file.txt")
    assert(make_relative("/home/user/file.txt", "/home/user") == "file.txt")

fn test_make_relative_no_common_prefix():
    val result = make_relative("/var/log/file.txt", "/home/user")
    assert(result == "/var/log/file.txt")  # Returns original path

fn test_make_relative_windows():
    assert(make_relative("C:\\Users\\user\\docs\\file.txt", "C:\\Users\\user") == "docs/file.txt")

# =====================================
# Split Path Tests
# =====================================

fn test_split_path_unix():
    val parts = split_path("/home/user/documents/file.txt")
    assert(parts.len() == 4)
    assert(parts[0] == "home")
    assert(parts[1] == "user")
    assert(parts[2] == "documents")
    assert(parts[3] == "file.txt")

fn test_split_path_windows():
    val parts = split_path("C:\\Users\\user\\file.txt")
    assert(parts.len() == 4)
    assert(parts[0] == "C:")
    assert(parts[1] == "Users")
    assert(parts[2] == "user")
    assert(parts[3] == "file.txt")

fn test_split_path_relative():
    val parts = split_path("docs/file.txt")
    assert(parts.len() == 2)
    assert(parts[0] == "docs")
    assert(parts[1] == "file.txt")

fn test_split_path_empty():
    val parts = split_path("")
    assert(parts.is_empty())

# =====================================
# Complex Scenarios Tests
# =====================================

fn test_complex_path_manipulation():
    # Extract components from complex path
    val path = "/home/user/projects/simple/src/main.spl"

    assert(get_filename(path) == "main.spl")
    assert(get_extension(path) == "spl")
    assert(get_stem(path) == "main")
    assert(get_parent_dir(path) == "/home/user/projects/simple/src")

fn test_windows_path_components():
    val path = "C:\\Program Files\\Simple\\bin\\simple.exe"

    assert(get_filename(path) == "simple.exe")
    assert(get_extension(path) == "exe")
    assert(has_extension(path, "exe"))
    assert(is_absolute_path(path))

fn test_build_path_from_components():
    val base = "/home/user"
    val subdir = "projects"
    val filename = "main.spl"

    val step1 = join_path(base, subdir)
    val final_path = join_path(step1, filename)

    assert(final_path == "/home/user/projects/main.spl")

fn test_relative_path_conversion():
    val absolute = "/home/user/projects/simple/src/main.spl"
    val base = "/home/user/projects"

    val relative = make_relative(absolute, base)
    assert(relative == "simple/src/main.spl")

    val parts = split_path(relative)
    assert(parts.len() == 3)
