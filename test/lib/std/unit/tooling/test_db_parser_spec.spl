"""
# Test DB Parser Specification

**Feature IDs:** #DB-PARSER
**Category:** Tooling
**Status:** Implemented

## Overview

Tests SDN parser robustness: field parsing, table detection.
Note: Full parse_stable_db/parse_volatile_db are tested via integration
(the build system) due to interpreter limitations with StringInterner mutation.
"""

use std.spec.*
use app.test_runner_new.test_db_parser.{parse_fields, detect_table}

# ============================================================================
# Test Group 1: Field Parsing
# ============================================================================

describe "parse_fields":
    it "parses comma-separated values":
        val fields = parse_fields("  1, 2, 3  ")
        expect(fields.len()).to_equal(3))
        expect(fields[0]).to_equal("1"))
        expect(fields[1]).to_equal("2"))
        expect(fields[2]).to_equal("3"))

    it "handles quoted strings with commas":
        val fields = parse_fields("1, \"hello, world\", 3")
        expect(fields.len()).to_equal(3))
        expect(fields[1]).to_equal("hello, world"))

    it "handles escaped quotes inside strings":
        val fields = parse_fields("1, \"say \\\"hi\\\"\", 3")
        expect(fields.len()).to_equal(3))
        expect(fields[1]).to_equal("say \"hi\""))

    it "handles empty fields":
        val fields = parse_fields(",, ,")
        expect(fields.len()).to_equal(4))

    it "handles single field":
        val fields = parse_fields("hello")
        expect(fields.len()).to_equal(1))
        expect(fields[0]).to_equal("hello"))

    it "trims whitespace from fields":
        val fields = parse_fields("  a  ,  b  ,  c  ")
        expect(fields[0]).to_equal("a"))
        expect(fields[1]).to_equal("b"))
        expect(fields[2]).to_equal("c"))

    it "handles many fields":
        val fields = parse_fields("0, 10, 8, 2, 1, no_change, \"pass,fail\", 20.0")
        expect(fields.len()).to_equal(8))
        expect(fields[6]).to_equal("pass,fail"))

    it "handles empty string":
        val fields = parse_fields("")
        expect(fields.len()).to_equal(1))
        expect(fields[0]).to_equal(""))

    it "parses timing-like row with many float fields":
        val fields = parse_fields("0, 100.5, 95.0, 110.0, 120.0, 90.0, 130.0, 80.0, 140.0, 15.0, 98.0, 12.0, 12.2, 95.0, 10.0, 10.5, \"2026-01-01\", 10, initial")
        expect(fields.len()).to_equal(19))
        expect(fields[0]).to_equal("0"))
        expect(fields[16]).to_equal("2026-01-01"))
        expect(fields[18]).to_equal("initial"))

# ============================================================================
# Test Group 2: Table Detection
# ============================================================================

describe "detect_table":
    it "detects strings table":
        expect(detect_table("strings |id, value|")).to_equal("strings"))

    it "detects files table":
        expect(detect_table("files |file_id, path_str|")).to_equal("files"))

    it "detects suites table":
        expect(detect_table("suites |suite_id, file_id, name_str|")).to_equal("suites"))

    it "detects tests table":
        expect(detect_table("tests |test_id, suite_id|")).to_equal("tests"))

    it "detects counters table":
        expect(detect_table("counters |test_id|")).to_equal("counters"))

    it "detects timing table":
        expect(detect_table("timing |test_id|")).to_equal("timing"))

    it "detects timing_runs table":
        expect(detect_table("timing_runs |test_id|")).to_equal("timing_runs"))

    it "detects changes table":
        expect(detect_table("changes |test_id|")).to_equal("changes"))

    it "detects test_runs table":
        expect(detect_table("test_runs |run_id|")).to_equal("test_runs"))

    it "returns empty for non-table lines":
        expect(detect_table("just a comment")).to_equal(""))
        expect(detect_table("")).to_equal(""))

    it "returns empty for comments":
        expect(detect_table("# version: 3.0")).to_equal(""))

    it "handles indented table headers":
        expect(detect_table("  strings |id, value|")).to_equal("strings"))

# ============================================================================
# Test Group 3: Edge Cases & Error Recovery
# ============================================================================

describe "parse_fields edge cases":
    it "handles unclosed quote at end":
        val fields = parse_fields("a, \"unclosed")
        expect(fields.len()).to_equal(2))
        expect(fields[1]).to_equal("unclosed"))

    it "handles quote in middle of unquoted field":
        val fields = parse_fields("a, b\"c, d")
        # Quote starts quoted mode, so "c, d" is one field
        expect(fields.len()).to_equal(2))

    it "handles multiple consecutive commas":
        val fields = parse_fields("a,,,b")
        expect(fields.len()).to_equal(4))
        expect(fields[0]).to_equal("a"))
        expect(fields[3]).to_equal("b"))

    it "handles tab characters":
        val fields = parse_fields("a\t,\tb")
        expect(fields.len()).to_equal(2))

    it "handles newline in unquoted field":
        val fields = parse_fields("a,b")
        expect(fields.len()).to_equal(2))

    it "handles long unquoted field":
        val long_field = "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
        val fields = parse_fields(long_field)
        expect(fields.len()).to_equal(1))
        expect(fields[0].len()).to_equal(50))

    it "handles mixed quoted and unquoted":
        val fields = parse_fields("a, \"b\", c, \"d,e\", f")
        expect(fields.len()).to_equal(5))
        expect(fields[3]).to_equal("d,e"))

    it "handles escaped backslash":
        val fields = parse_fields("\"a\\\\b\"")
        expect(fields.len()).to_equal(1))
        expect(fields[0]).to_equal("a\\b"))

describe "detect_table edge cases":
    it "handles whitespace-only line":
        expect(detect_table("   ")).to_equal(""))

    it "handles table name without pipe":
        expect(detect_table("strings id value")).to_equal(""))

    it "handles partial table name":
        expect(detect_table("str |id|")).to_equal(""))

    it "case sensitive table names":
        expect(detect_table("STRINGS |id|")).to_equal(""))

    it "handles table with extra spaces":
        # Extra spaces break the pattern match "strings |"
        expect(detect_table("strings  |id|")).to_equal(""))

