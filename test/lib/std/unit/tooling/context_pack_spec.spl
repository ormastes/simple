"""
# Context Pack Specification

**Feature IDs:** Context Pack Generator
**Category:** Tooling
**Difficulty:** 2/5
**Status:** Implemented

## Overview

Unit tests for the context pack generator module. Validates creation, export formats,
and statistics calculation for context packs used in LLM-friendly code analysis.

## Key Features

- Context pack creation with target module names
- Markdown and plain text export formats
- Token savings calculations
- Context statistics and reduction percentages
- Function signature representation

## Related Specifications

- [LLM Features Architecture](../../../docs/design/llm_features.md)
"""

use std.spec
use tooling.context_pack.{ContextPack, ContextStats, FunctionParam, FunctionSignature}


# ============================================================================
# ContextPack: Core Functionality
# ============================================================================

describe "ContextPack":
    """
    ## ContextPack Creation and Export

    Validates creation of context packs with target modules and export to
    various formats (Markdown, plain text).
    """

    describe "new context pack":
        """
        ### Creating Empty Packs

        Tests basic context pack initialization with a target module name.
        """

        it "creates empty pack with target":
            val pack = ContextPack.new("my_module")
            expect pack.target == "my_module"
            expect pack.symbol_count == 0

    describe "to_markdown export":
        """
        ### Markdown Export Format

        Validates generation of Markdown output with proper headers, sections,
        and type listings.
        """

        it "generates markdown header":
            val pack = ContextPack.new("test_module")
            val md = pack.to_markdown()
            expect md.contains("# Context Pack: test_module")

        it "includes types section":
            var pack = ContextPack.new("test")
            pack.types = ["i64", "str"]
            pack.symbol_count = 2
            val md = pack.to_markdown()
            expect md.contains("## Types Used")
            expect md.contains("`i64`")
            expect md.contains("`str`")

    describe "to_text export":
        """
        ### Plain Text Export Format

        Validates generation of plain text output with type listings
        and context metadata.
        """

        it "generates plain text output":
            val pack = ContextPack.new("test")
            val text = pack.to_text()
            expect text.contains("Context for: test")

        it "includes type list":
            var pack = ContextPack.new("test")
            pack.types = ["User", "Product"]
            val text = pack.to_text()
            expect text.contains("Types:")
            expect text.contains("User")
            expect text.contains("Product")

    describe "token_savings calculation":
        """
        ### Token Savings Estimation

        Validates calculations for estimated token reduction when using
        context packs versus full context.
        """

        it "calculates 90% reduction":
            var pack = ContextPack.new("test")
            pack.symbol_count = 10
            val savings = pack.token_savings(100)
            expect savings == 90.0

        it "returns 0 for empty context":
            val pack = ContextPack.new("test")
            val savings = pack.token_savings(0)
            expect savings == 0.0


# ============================================================================
# ContextStats: Statistics and Reduction Metrics
# ============================================================================

describe "ContextStats":
    """
    ## Context Statistics

    Validates calculation of reduction percentages and token savings
    for context pack compression metrics.
    """

    describe "statistics calculation":
        """
        ### Reduction and Savings Metrics

        Tests computation of symbol count reduction and estimated token savings.
        """

        it "calculates reduction percentage":
            val stats = ContextStats.new(1000, 100)
            expect stats.full_symbol_count == 1000
            expect stats.extracted_symbol_count == 100
            expect stats.reduction_percentage == 90.0

        it "estimates tokens saved":
            val stats = ContextStats.new(1000, 100)
            expect stats.estimated_tokens_saved == 2700

        it "handles zero full count":
            val stats = ContextStats.new(0, 0)
            expect stats.reduction_percentage == 0.0


# ============================================================================
# FunctionSignature: Function Representation
# ============================================================================

describe "FunctionSignature":
    """
    ## Function Signature Representation

    Validates creation and representation of function signatures with
    parameters, return types, and metadata flags.
    """

    describe "basic signature":
        """
        ### Signature Construction

        Tests creation of function signatures with parameters and return types.
        """

        it "creates signature with params":
            val param1 = FunctionParam(name: "x", type_name: Some("i64"))
            val param2 = FunctionParam(name: "y", type_name: Some("i64"))
            val sig = FunctionSignature(
                name: "add",
                params: [param1, param2],
                return_type: Some("i64"),
                is_async: false,
                is_public: true
            )
            expect sig.name == "add"
            expect sig.params.len() == 2
