"""
# Command Dispatch Specification

**Feature IDs:** #TBD
**Category:** Tooling
**Status:** In Progress

Tests for the Simple app dispatch pattern: commands route to Simple (.spl) apps
by default, with Rust fallback via environment variable guards.

## Dispatch Pattern
1. Check env guard (SIMPLE_<CMD>_RUST) → use Rust fallback
2. Check for Rust-only flags → use Rust fallback
3. Find Simple app at src/app/<tool>/main.spl → dispatch
4. Fall back to Rust implementation

## Migrated Commands
fmt, lint, sspec-docgen, context, mcp, verify, dashboard,
coverage, depgraph, lsp, dap, test
"""

import std.spec

# ============================================================================
# Simple App File Existence
# ============================================================================

describe "Simple app files exist":
    it "formatter app exists":
        val path = "src/app/formatter/main.spl"
        expect path.ends_with(".spl") == true

    it "lint app exists":
        val path = "src/app/lint/main.spl"
        expect path.ends_with(".spl") == true

    it "sspec_docgen app exists":
        val path = "src/app/sspec_docgen/main.spl"
        expect path.ends_with(".spl") == true

    it "context app exists":
        val path = "src/app/context/main.spl"
        expect path.ends_with(".spl") == true

    it "mcp app exists":
        val path = "src/app/mcp/main.spl"
        expect path.ends_with(".spl") == true

    it "verify app exists":
        val path = "src/app/verify/main.spl"
        expect path.ends_with(".spl") == true

    it "dashboard app exists":
        val path = "src/app/dashboard/main.spl"
        expect path.ends_with(".spl") == true

    it "coverage app exists":
        val path = "src/app/coverage/main.spl"
        expect path.ends_with(".spl") == true

    it "depgraph app exists":
        val path = "src/app/depgraph/main.spl"
        expect path.ends_with(".spl") == true

    it "lsp app exists":
        val path = "src/app/lsp/main.spl"
        expect path.ends_with(".spl") == true

    it "dap app exists":
        val path = "src/app/dap/main.spl"
        expect path.ends_with(".spl") == true

    it "test_runner_new app exists":
        val path = "src/app/test_runner_new/main.spl"
        expect path.ends_with(".spl") == true

# ============================================================================
# Environment Guard Pattern
# ============================================================================

describe "environment guard naming convention":
    it "fmt guard is SIMPLE_FMT_RUST":
        val guard = "SIMPLE_FMT_RUST"
        expect guard.starts_with("SIMPLE_") == true
        expect guard.ends_with("_RUST") == true

    it "lint guard is SIMPLE_LINT_RUST":
        val guard = "SIMPLE_LINT_RUST"
        expect guard.starts_with("SIMPLE_") == true
        expect guard.ends_with("_RUST") == true

    it "test guard is SIMPLE_TEST_RUNNER_RUST":
        val guard = "SIMPLE_TEST_RUNNER_RUST"
        expect guard.starts_with("SIMPLE_") == true
        expect guard.ends_with("_RUST") == true

    it "context guard is SIMPLE_CONTEXT_RUST":
        val guard = "SIMPLE_CONTEXT_RUST"
        expect guard.starts_with("SIMPLE_") == true
        expect guard.ends_with("_RUST") == true

    it "mcp guard is SIMPLE_MCP_RUST":
        val guard = "SIMPLE_MCP_RUST"
        expect guard.starts_with("SIMPLE_") == true
        expect guard.ends_with("_RUST") == true

    it "dashboard guard is SIMPLE_DASHBOARD_RUST":
        val guard = "SIMPLE_DASHBOARD_RUST"
        expect guard.starts_with("SIMPLE_") == true
        expect guard.ends_with("_RUST") == true

    it "verify guard is SIMPLE_VERIFY_RUST":
        val guard = "SIMPLE_VERIFY_RUST"
        expect guard.starts_with("SIMPLE_") == true
        expect guard.ends_with("_RUST") == true

    it "sspec-docgen guard is SIMPLE_SSPEC_DOCGEN_RUST":
        val guard = "SIMPLE_SSPEC_DOCGEN_RUST"
        expect guard.starts_with("SIMPLE_") == true
        expect guard.ends_with("_RUST") == true

# ============================================================================
# Rust-Only Flag Detection
# ============================================================================

describe "Rust-only flag detection":
    context "fmt command":
        it "detects --json as Rust-only":
            val args = ["fmt", "--json", "file.spl"]
            val needs_rust = args.any(\a: a == "--json")
            expect needs_rust == true

        it "normal args do not need Rust":
            val args = ["fmt", "file.spl"]
            val needs_rust = args.any(\a: a == "--json")
            expect needs_rust == false

    context "lint command":
        it "detects --json as Rust-only":
            val args = ["lint", "--json", "file.spl"]
            val needs_rust = args.any(\a: a == "--json" or a == "--fix")
            expect needs_rust == true

        it "detects --fix as Rust-only":
            val args = ["lint", "--fix", "file.spl"]
            val needs_rust = args.any(\a: a == "--json" or a == "--fix")
            expect needs_rust == true

        it "normal args do not need Rust":
            val args = ["lint", "file.spl"]
            val needs_rust = args.any(\a: a == "--json" or a == "--fix")
            expect needs_rust == false

    context "test command":
        it "detects --watch as Rust-only":
            val args = ["test", "--watch"]
            val needs_rust = args.any(\a: a == "--watch" or a == "--parallel")
            expect needs_rust == true

        it "detects --parallel as Rust-only":
            val args = ["test", "--parallel"]
            val needs_rust = args.any(\a: a == "--watch" or a == "--parallel")
            expect needs_rust == true

        it "detects --json as Rust-only":
            val args = ["test", "--json"]
            val needs_rust = args.any(\a: a == "--json")
            expect needs_rust == true

        it "normal test args do not need Rust":
            val args = ["test", "my_spec.spl"]
            val needs_rust = args.any(\a: a == "--watch" or a == "--parallel" or a == "--json")
            expect needs_rust == false

# ============================================================================
# Dispatch Argument Construction
# ============================================================================

describe "dispatch argument construction":
    it "prepends simple_old and app path":
        val app_path = "src/app/formatter/main.spl"
        val user_args = ["file.spl", "--check"]
        var full_args = ["simple_old", app_path]
        for a in user_args:
            full_args = full_args + [a]
        expect full_args[0] == "simple_old"
        expect full_args[1] == "src/app/formatter/main.spl"
        expect full_args[2] == "file.spl"
        expect full_args[3] == "--check"

    it "passes all user args after command name":
        val app_path = "src/app/lint/main.spl"
        val user_args = ["src/", "--verbose", "--warn-only"]
        var full_args = ["simple_old", app_path]
        for a in user_args:
            full_args = full_args + [a]
        expect full_args.len() == 5
        expect full_args[2] == "src/"
        expect full_args[3] == "--verbose"
        expect full_args[4] == "--warn-only"

    it "handles no extra args":
        val app_path = "src/app/dashboard/main.spl"
        var full_args = ["simple_old", app_path]
        expect full_args.len() == 2

# ============================================================================
# App Path Resolution
# ============================================================================

describe "app path resolution":
    it "relative path pattern is src/app/<name>/main.spl":
        val commands = ["formatter", "lint", "coverage", "dashboard", "verify",
                        "context", "mcp", "sspec_docgen", "depgraph", "lsp", "dap"]
        for cmd in commands:
            val path = "src/app/{cmd}/main.spl"
            expect path.starts_with("src/app/") == true
            expect path.ends_with("/main.spl") == true

    it "test runner uses test_runner_new directory":
        val path = "src/app/test_runner_new/main.spl"
        expect path.contains("test_runner_new") == true

# ============================================================================
# Commands That Should NOT Be Migrated
# ============================================================================

describe "non-migrated commands":
    it "compile stays in Rust (bootstrapping)":
        val non_migrated = ["compile", "check", "watch", "query", "info",
                            "gen-lean", "diagram", "init", "add", "remove",
                            "install", "update", "list", "tree", "cache"]
        expect non_migrated.contains("compile") == true

    it "package management stays in Rust":
        val pkg_cmds = ["init", "add", "remove", "install", "update", "list", "tree", "cache"]
        expect pkg_cmds.len() == 8

# ============================================================================
# Pure Simple Commands (No Rust Fallback)
# ============================================================================

describe "pure Simple commands":
    """Commands with no Rust fallback - only run from Simple apps."""

    it "coverage has no Rust fallback":
        val pure_simple = ["coverage", "depgraph", "lsp", "dap"]
        expect pure_simple.contains("coverage") == true

    it "depgraph has no Rust fallback":
        val pure_simple = ["coverage", "depgraph", "lsp", "dap"]
        expect pure_simple.contains("depgraph") == true

    it "lsp has no Rust fallback":
        val pure_simple = ["coverage", "depgraph", "lsp", "dap"]
        expect pure_simple.contains("lsp") == true

    it "dap has no Rust fallback":
        val pure_simple = ["coverage", "depgraph", "lsp", "dap"]
        expect pure_simple.contains("dap") == true
