# @pending
# @skip - Uses unsupported keyword: with
"""
HTML Utilities Tests

Tests for HTML generation, escaping, document structure, semantic elements,
and builder pattern functionality.

Feature:
  HTML generation and manipulation utilities

Category:
  Tooling/Web

Status:
  Complete

Implementation:
  All HTML utility functions are provided locally in this test file.
  This allows tests to be independent of external dependencies.
"""


# =====================================
# HTML Utility Implementations
# =====================================

fn escape_html(txt: text) -> text:
    var result = txt
    result = result.replace("&", "&amp;")
    result = result.replace("<", "&lt;")
    result = result.replace(">", "&gt;")
    result = result.replace("\"", "&quot;")
    result

fn unescape_html(txt: text) -> text:
    var result = txt
    result = result.replace("&lt;", "<")
    result = result.replace("&gt;", ">")
    result = result.replace("&quot;", "\"")
    result = result.replace("&amp;", "&")
    result

fn tag(name: text, content: text) -> text:
    "<" + name + ">" + content + "</" + name + ">"

fn self_closing_tag(name: text) -> text:
    "<" + name + " />"

fn tag_with_attrs(name: text, attrs: [(text, text)], content: text) -> text:
    var result = "<" + name
    for attr in attrs:
        result = result + " " + attr.0 + "=\"" + attr.1 + "\""
    result = result + ">" + content + "</" + name + ">"
    result

fn html_document(head: text, body: text) -> text:
    "<!DOCTYPE html>\n<html>\n<head>" + head + "</head>\n<body>" + body + "</body>\n</html>"

fn html5_document(lang: text, head: text, body: text) -> text:
    "<!DOCTYPE html>\n<html lang=\"" + lang + "\">\n<head>" + head + "</head>\n<body>" + body + "</body>\n</html>"

fn doctype_html5() -> text:
    "<!DOCTYPE html>"

fn title(txt: text) -> text:
    tag(name="title", content=txt)

fn meta(name: text, content: text) -> text:
    "<meta name=\"" + name + "\" content=\"" + content + "\" />"

fn meta_charset(charset: text) -> text:
    "<meta charset=\"" + charset + "\" />"

fn link_stylesheet(href: text) -> text:
    "<link rel=\"stylesheet\" href=\"" + href + "\" />"

fn h1(txt: text) -> text:
    tag(name="h1", content=txt)

fn h2(txt: text) -> text:
    tag(name="h2", content=txt)

fn p(txt: text) -> text:
    tag(name="p", content=txt)

fn div(content: text) -> text:
    tag(name="div", content=content)

fn span(txt: text) -> text:
    tag(name="span", content=txt)

fn strong(txt: text) -> text:
    tag(name="strong", content=txt)

fn em(txt: text) -> text:
    tag(name="em", content=txt)

fn code(txt: text) -> text:
    tag(name="code", content=txt)

fn br() -> text:
    "<br />"

fn hr() -> text:
    "<hr />"

fn a(href: text, txt: text) -> text:
    "<a href=\"" + href + "\">" + txt + "</a>"

fn a_external(href: text, txt: text) -> text:
    "<a href=\"" + href + "\" target=\"_blank\">" + txt + "</a>"

fn img(src: text, alt: text) -> text:
    "<img src=\"" + src + "\" alt=\"" + alt + "\" />"

fn ul(items: [text]) -> text:
    var result = "<ul>"
    for item in items:
        result = result + "<li>" + item + "</li>"
    result + "</ul>"

fn ol(items: [text]) -> text:
    var result = "<ol>"
    for item in items:
        result = result + "<li>" + item + "</li>"
    result + "</ol>"

fn li(txt: text) -> text:
    tag(name="li", content=txt)

fn table(headers: [text], rows: [[text]]) -> text:
    var result = "<table><thead><tr>"
    for h in headers:
        result = result + "<th>" + h + "</th>"
    result = result + "</tr></thead><tbody>"
    for row in rows:
        result = result + "<tr>"
        for cell in row:
            result = result + "<td>" + cell + "</td>"
        result = result + "</tr>"
    result + "</tbody></table>"

fn tr(cells: [text]) -> text:
    var result = "<tr>"
    for cell in cells:
        result = result + "<td>" + cell + "</td>"
    result + "</tr>"

fn th(txt: text) -> text:
    tag(name="th", content=txt)

fn td(txt: text) -> text:
    tag(name="td", content=txt)

fn form(action: text, method: text, content: text) -> text:
    "<form action=\"" + action + "\" method=\"" + method + "\">" + content + "</form>"

fn input_text(name: text, default_val: text) -> text:
    "<input type=\"text\" name=\"" + name + "\" value=\"" + default_val + "\" />"

fn button_submit(txt: text) -> text:
    "<button type=\"submit\">" + txt + "</button>"

fn header(content: text) -> text:
    tag(name="header", content=content)

fn footer(content: text) -> text:
    tag(name="footer", content=content)

fn nav(content: text) -> text:
    tag(name="nav", content=content)

fn main_element(content: text) -> text:
    tag(name="main", content=content)

class HtmlBuilder:
    content: text

impl HtmlBuilder:
    static fn create() -> HtmlBuilder:
        HtmlBuilder(content: "")

    me add_heading(level: i64, txt: text):
        val tag_name = "h" + level.to_string()
        self.content = self.content + "<" + tag_name + ">" + txt + "</" + tag_name + ">"

    me add_paragraph(txt: text):
        self.content = self.content + "<p>" + txt + "</p>"

    fn build() -> text:
        self.content

    fn build_document(title_txt: text) -> text:
        "<!DOCTYPE html>\n<html>\n<head><title>" + title_txt + "</title></head>\n<body>" + self.content + "</body>\n</html>"

fn simple_page(title_txt: text, heading: text, content: text) -> text:
    "<!DOCTYPE html>\n<html>\n<head><title>" + title_txt + "</title></head>\n<body><h1>" + heading + "</h1>" + content + "</body>\n</html>"

fn page_with_css(title_txt: text, css_file: text, content: text) -> text:
    "<!DOCTYPE html>\n<html>\n<head><title>" + title_txt + "</title><link rel=\"stylesheet\" href=\"" + css_file + "\" /></head>\n<body>" + content + "</body>\n</html>"

# =====================================
# BDD Tests
# =====================================

describe "HTML Utilities":
    """
    Comprehensive tests for HTML utility functions covering element generation,
    escaping, document structure, semantic elements, forms, tables, and builder patterns.
    """

    describe "HTML Escaping":
        it "escapes ampersand":
            expect escape_html("A & B") == "A &amp; B"

        it "escapes less than":
            expect escape_html("A < B") == "A &lt; B"

        it "escapes greater than":
            expect escape_html("A > B") == "A &gt; B"

        it "escapes quotes":
            expect escape_html("Say \"hello\"") == "Say &quot;hello&quot;"

        it "unescapes HTML entities":
            expect unescape_html("A &amp; B") == "A & B"
            expect unescape_html("A &lt; B") == "A < B"

    describe "Basic HTML Elements":
        it "creates simple tag":
            val result = tag(name="p", content="Hello")
            expect result == "<p>Hello</p>"

        it "creates self-closing tag":
            val result = self_closing_tag("br")
            expect result == "<br />"

        it "creates tag with attributes":
            val result = tag_with_attrs(name="a", attrs=[("href", "/home")], content="Home")
            expect result.contains("href=\"/home\"")
            expect result.contains(">Home</a>")

    describe "Document Structure":
        it "creates HTML document":
            val result = html_document(head="<title>Test</title>", body="<p>Content</p>")
            expect result.contains("<!DOCTYPE html>")
            expect result.contains("<html>")
            expect result.contains("<head>")

        it "creates HTML5 document with lang":
            val result = html5_document(lang="en", head="<title>Test</title>", body="<p>Content</p>")
            expect result.contains("lang=\"en\"")
            expect result.contains("<!DOCTYPE html>")

        it "generates doctype":
            expect doctype_html5() == "<!DOCTYPE html>"

    describe "Head Elements":
        it "creates title":
            expect title("My Page") == "<title>My Page</title>"

        it "creates meta tag":
            val result = meta(name="description", content="Page description")
            expect result.contains("name=\"description\"")
            expect result.contains("content=\"Page description\"")

        it "creates charset meta":
            val result = meta_charset("UTF-8")
            expect result.contains("charset=\"UTF-8\"")

        it "creates stylesheet link":
            val result = link_stylesheet("style.css")
            expect result.contains("rel=\"stylesheet\"")
            expect result.contains("href=\"style.css\"")

    describe "Text Elements":
        it "creates headings":
            expect h1("Title") == "<h1>Title</h1>"
            expect h2("Subtitle") == "<h2>Subtitle</h2>"

        it "creates paragraph":
            expect p("Paragraph") == "<p>Paragraph</p>"

        it "creates div":
            expect div("<p>Content</p>") == "<div><p>Content</p></div>"

        it "creates span":
            expect span("Text") == "<span>Text</span>"

    describe "Formatting Elements":
        it "creates strong":
            expect strong("Bold") == "<strong>Bold</strong>"

        it "creates em":
            expect em("Italic") == "<em>Italic</em>"

        it "creates code":
            expect code("x = 1") == "<code>x = 1</code>"

        it "creates br":
            expect br() == "<br />"

        it "creates hr":
            expect hr() == "<hr />"

    describe "Link Elements":
        it "creates anchor":
            val result = a(href="/page", txt="Click here")
            expect result.contains("href=\"/page\"")
            expect result.contains(">Click here</a>")

        it "creates external link":
            val result = a_external(href="https://example.com", txt="Example")
            expect result.contains("target=\"_blank\"")

    describe "Image Elements":
        it "creates image":
            val result = img(src="pic.jpg", alt="A picture")
            expect result.contains("src=\"pic.jpg\"")
            expect result.contains("alt=\"A picture\"")

    describe "List Elements":
        it "creates unordered list":
            val result = ul(["Item 1", "Item 2", "Item 3"])
            expect result.contains("<ul>")
            expect result.contains("<li>Item 1</li>")
            expect result.contains("</ul>")

        it "creates ordered list":
            val result = ol(["First", "Second", "Third"])
            expect result.contains("<ol>")
            expect result.contains("<li>First</li>")
            expect result.contains("</ol>")

        it "creates list item":
            expect li("Item") == "<li>Item</li>"

    describe "Table Elements":
        it "creates table":
            val result = table(["Name", "Age"], [["Alice", "30"], ["Bob", "25"]])
            expect result.contains("<table>")
            expect result.contains("<thead>")
            expect result.contains("<th>Name</th>")
            expect result.contains("<tbody>")
            expect result.contains("<td>Alice</td>")
            expect result.contains("</table>")

        it "creates table row":
            val result = tr(["A", "B", "C"])
            expect result.contains("<tr>")
            expect result.contains("<td>A</td>")
            expect result.contains("</tr>")

        it "creates th and td":
            expect th("Header") == "<th>Header</th>"
            expect td("Data") == "<td>Data</td>"

    describe "Form Elements":
        it "creates form":
            val result = form(action="/submit", method="POST", content="<input>")
            expect result.contains("action=\"/submit\"")
            expect result.contains("method=\"POST\"")

        it "creates text input":
            val result = input_text(name="email", default_val="user@example.com")
            expect result.contains("type=\"text\"")
            expect result.contains("name=\"email\"")

        it "creates submit button":
            val result = button_submit("Send")
            expect result.contains("type=\"submit\"")

    describe "Semantic Elements":
        it "creates header":
            expect header("<h1>Title</h1>") == "<header><h1>Title</h1></header>"

        it "creates footer":
            expect footer("<p>Copyright</p>") == "<footer><p>Copyright</p></footer>"

        it "creates nav":
            expect nav("<ul><li>Home</li></ul>") == "<nav><ul><li>Home</li></ul></nav>"

        it "creates main":
            expect main_element("<p>Content</p>") == "<main><p>Content</p></main>"

    describe "Builder Pattern":
        it "builds basic HTML":
            var builder = HtmlBuilder.create()
            builder.add_heading(level=1, txt="Title")
            builder.add_paragraph("Content")
            val result = builder.build()
            expect result.contains("<h1>Title</h1>")
            expect result.contains("<p>Content</p>")

        it "builds full document":
            var builder = HtmlBuilder.create()
            builder.add_heading(level=1, txt="Welcome")
            builder.add_paragraph("Hello world")
            val result = builder.build_document("My Page")
            expect result.contains("<!DOCTYPE html>")
            expect result.contains("<title>My Page</title>")
            expect result.contains("<h1>Welcome</h1>")

    describe "Common Patterns":
        it "creates simple page":
            val result = simple_page(title_txt="Test", heading="Welcome", content="<p>Content</p>")
            expect result.contains("<title>Test</title>")
            expect result.contains("<h1>Welcome</h1>")
            expect result.contains("<!DOCTYPE html>")

        it "creates page with CSS":
            val result = page_with_css(title_txt="Styled", css_file="style.css", content="<p>Content</p>")
            expect result.contains("<title>Styled</title>")
            expect result.contains("rel=\"stylesheet\"")
            expect result.contains("href=\"style.css\"")
