# Tests for CSV utilities

use tooling.csv_utils.*

# =====================================
# CSV Parsing Tests
# =====================================

fn test_parse_csv_line_quoted_simple():
    val fields = parse_csv_line_quoted("apple,banana,cherry")
    assert(fields.len() == 3)
    assert(fields[0] == "apple")
    assert(fields[1] == "banana")
    assert(fields[2] == "cherry")

fn test_parse_csv_line_quoted_with_quotes():
    val fields = parse_csv_line_quoted("\"John Doe\",30,\"New York\"")
    assert(fields.len() == 3)
    assert(fields[0] == "John Doe")
    assert(fields[1] == "30")
    assert(fields[2] == "New York")

fn test_parse_csv_line_quoted_with_comma_in_field():
    val fields = parse_csv_line_quoted("\"Smith, John\",Engineer")
    assert(fields.len() == 2)
    assert(fields[0] == "Smith, John")

fn test_parse_csv_line_quoted_with_escaped_quotes():
    val fields = parse_csv_line_quoted("\"He said \"\"Hello\"\"\"")
    assert(fields.len() == 1)
    assert(fields[0].contains("Hello"))

fn test_parse_csv_multiple_rows():
    val text = "Name,Age\nAlice,30\nBob,25"
    val rows = parse_csv(text)

    assert(rows.len() == 3)
    assert(rows[0][0] == "Name")
    assert(rows[1][0] == "Alice")
    assert(rows[2][0] == "Bob")

fn test_parse_csv_with_headers():
    val text = "Name,Age,City\nAlice,30,NYC\nBob,25,LA"

    match parse_csv_with_headers(text):
        Some(data) =>
            assert(data.headers.len() == 3)
            assert(data.headers[0] == "Name")
            assert(data.rows.len() == 2)
            assert(data.rows[0][0] == "Alice")
        None =>
            assert(false)

# =====================================
# CSV Formatting Tests
# =====================================

fn test_format_csv_line_simple():
    val line = format_csv_line(["apple", "banana", "cherry"])
    assert(line == "apple,banana,cherry")

fn test_format_csv_line_with_special_chars():
    val line = format_csv_line(["Smith, John", "30"])
    assert(line.contains("\"Smith, John\""))

fn test_quote_csv_field_no_quotes_needed():
    assert(quote_csv_field("simple") == "simple")

fn test_quote_csv_field_with_comma():
    val quoted = quote_csv_field("Smith, John")
    assert(quoted.starts_with("\""))
    assert(quoted.ends_with("\""))

fn test_format_csv():
    val rows = [
        ["Name", "Age"],
        ["Alice", "30"],
        ["Bob", "25"]
    ]
    val csv = format_csv(rows)

    assert(csv.contains("Name,Age"))
    assert(csv.contains("Alice,30"))
    assert(csv.contains("Bob,25"))

# =====================================
# CSV Validation Tests
# =====================================

fn test_is_rectangular_csv_valid():
    val rows = [
        ["A", "B", "C"],
        ["1", "2", "3"],
        ["4", "5", "6"]
    ]
    assert(is_rectangular_csv(rows))

fn test_is_rectangular_csv_invalid():
    val rows = [
        ["A", "B", "C"],
        ["1", "2"],
        ["4", "5", "6"]
    ]
    assert(not is_rectangular_csv(rows))

fn test_get_column_count():
    val rows = [["A", "B", "C"]]
    assert(get_column_count(rows) == 3)

fn test_get_row_count():
    val rows = [["A"], ["B"], ["C"]]
    assert(get_row_count(rows) == 3)

# =====================================
# CSV Transformation Tests
# =====================================

fn test_get_column():
    val rows = [
        ["Name", "Age"],
        ["Alice", "30"],
        ["Bob", "25"]
    ]
    val names = get_column(rows, 0)

    assert(names.len() == 3)
    assert(names[0] == "Name")
    assert(names[1] == "Alice")
    assert(names[2] == "Bob")

fn test_get_column_by_name():
    val data = CsvData(
        headers: ["Name", "Age", "City"],
        rows: [
            ["Alice", "30", "NYC"],
            ["Bob", "25", "LA"]
        ]
    )

    match get_column_by_name(data, "Age"):
        Some(ages) =>
            assert(ages.len() == 2)
            assert(ages[0] == "30")
            assert(ages[1] == "25")
        None =>
            assert(false)

fn test_get_column_by_name_not_found():
    val data = CsvData(
        headers: ["Name", "Age"],
        rows: []
    )

    match get_column_by_name(data, "Country"):
        Some(_) =>
            assert(false)
        None =>
            assert(true)

fn test_transpose_csv():
    val rows = [
        ["A", "B"],
        ["1", "2"],
        ["3", "4"]
    ]
    val transposed = transpose_csv(rows)

    assert(transposed.len() == 2)
    assert(transposed[0] == ["A", "1", "3"])
    assert(transposed[1] == ["B", "2", "4"])

fn test_filter_rows():
    val data = CsvData(
        headers: ["Name", "Age"],
        rows: [
            ["Alice", "30"],
            ["Bob", "25"],
            ["Charlie", "35"]
        ]
    )

    val filtered = filter_rows(data, \row: row[0].starts_with("A"))
    assert(filtered.rows.len() == 1)
    assert(filtered.rows[0][0] == "Alice")

# =====================================
# CSV Statistics Tests
# =====================================

fn test_count_non_empty_cells():
    val rows = [
        ["A", "B", ""],
        ["1", "", "3"]
    ]
    val count = count_non_empty_cells(rows)
    assert(count == 4)

fn test_max_field_length():
    val rows = [
        ["Short", "Medium text", "X"],
        ["A", "Very long text here", "Y"]
    ]
    val max_len = max_field_length(rows)
    assert(max_len >= 20)

# =====================================
# Table Formatting Tests
# =====================================

fn test_format_csv_table():
    val rows = [
        ["Name", "Age"],
        ["Alice", "30"],
        ["Bob", "25"]
    ]
    val table = format_csv_table(rows)

    assert(table.contains("Name"))
    assert(table.contains("Alice"))
    assert(table.contains("|"))

fn test_format_csv_table_with_headers():
    val data = CsvData(
        headers: ["ID", "Name"],
        rows: [["1", "Alice"], ["2", "Bob"]]
    )

    val table = format_csv_table_with_headers(data)
    assert(table.contains("ID"))
    assert(table.contains("---"))
