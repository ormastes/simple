# Tests for Time and Duration utilities

use tooling.time_utils.*

# =====================================
# Duration Creation Tests
# =====================================

fn test_duration_from_millis():
    val duration = Duration.from_millis(5000)
    assert(duration.total_millis() == 5000)

fn test_duration_from_seconds():
    val duration = Duration.from_seconds(10)
    assert(duration.total_seconds() == 10)
    assert(duration.total_millis() == 10000)

fn test_duration_from_minutes():
    val duration = Duration.from_minutes(5)
    assert(duration.total_minutes() == 5)
    assert(duration.total_seconds() == 300)

fn test_duration_from_hours():
    val duration = Duration.from_hours(2)
    assert(duration.total_hours() == 2)
    assert(duration.total_minutes() == 120)

fn test_duration_from_days():
    val duration = Duration.from_days(3)
    assert(duration.total_days() == 3)
    assert(duration.total_hours() == 72)

# =====================================
# Duration Components Tests
# =====================================

fn test_duration_components_simple():
    val duration = Duration.from_seconds(90)
    val (days, hours, minutes, seconds, millis) = duration.components()

    assert(days == 0)
    assert(hours == 0)
    assert(minutes == 1)
    assert(seconds == 30)
    assert(millis == 0)

fn test_duration_components_complex():
    # 1 day + 2 hours + 30 minutes + 45 seconds
    val ms = (1 * 24 * 60 * 60 * 1000) + (2 * 60 * 60 * 1000) + (30 * 60 * 1000) + (45 * 1000)
    val duration = Duration.from_millis(ms)
    val (days, hours, minutes, seconds, millis) = duration.components()

    assert(days == 1)
    assert(hours == 2)
    assert(minutes == 30)
    assert(seconds == 45)

# =====================================
# Duration Arithmetic Tests
# =====================================

fn test_duration_add():
    val d1 = Duration.from_seconds(30)
    val d2 = Duration.from_seconds(15)
    val result = d1.add(d2)

    assert(result.total_seconds() == 45)

fn test_duration_subtract():
    val d1 = Duration.from_seconds(50)
    val d2 = Duration.from_seconds(20)
    val result = d1.subtract(d2)

    assert(result.total_seconds() == 30)

fn test_duration_multiply():
    val duration = Duration.from_seconds(10)
    val result = duration.multiply(3)

    assert(result.total_seconds() == 30)

fn test_duration_divide():
    val duration = Duration.from_seconds(60)
    val result = duration.divide(4)

    assert(result.total_seconds() == 15)

# =====================================
# Duration Parsing Tests
# =====================================

fn test_parse_duration_seconds():
    match parse_duration("45s"):
        Some(duration) => assert(duration.total_seconds() == 45)
        None => assert(false)

fn test_parse_duration_minutes():
    match parse_duration("5m"):
        Some(duration) => assert(duration.total_minutes() == 5)
        None => assert(false)

fn test_parse_duration_hours():
    match parse_duration("2h"):
        Some(duration) => assert(duration.total_hours() == 2)
        None => assert(false)

fn test_parse_duration_days():
    match parse_duration("3d"):
        Some(duration) => assert(duration.total_days() == 3)
        None => assert(false)

fn test_parse_duration_combined():
    match parse_duration("1h30m"):
        Some(duration) =>
            assert(duration.total_minutes() == 90)
        None => assert(false)

fn test_parse_duration_complex():
    match parse_duration("2d5h30m15s"):
        Some(duration) =>
            val (days, hours, minutes, seconds, _) = duration.components()
            assert(days == 2)
            assert(hours == 5)
            assert(minutes == 30)
            assert(seconds == 15)
        None => assert(false)

fn test_parse_duration_with_spaces():
    match parse_duration("1h 30m"):
        Some(duration) => assert(duration.total_minutes() == 90)
        None => assert(false)

fn test_parse_duration_number_only():
    match parse_duration("30"):
        Some(duration) => assert(duration.total_seconds() == 30)
        None => assert(false)

fn test_parse_duration_invalid():
    match parse_duration("invalid"):
        Some(_) => assert(false)
        None => assert(true)

fn test_parse_duration_empty():
    match parse_duration(""):
        Some(_) => assert(false)
        None => assert(true)

# =====================================
# Duration Formatting Tests
# =====================================

fn test_format_duration_seconds():
    val duration = Duration.from_seconds(45)
    val formatted = format_duration(duration)
    assert(formatted == "45s")

fn test_format_duration_minutes():
    val duration = Duration.from_minutes(5)
    val formatted = format_duration(duration)
    assert(formatted == "5m")

fn test_format_duration_hours():
    val duration = Duration.from_hours(2)
    val formatted = format_duration(duration)
    assert(formatted == "2h")

fn test_format_duration_combined():
    val duration = Duration.from_seconds(90)
    val formatted = format_duration(duration)
    assert(formatted.contains("1m"))
    assert(formatted.contains("30s"))

fn test_format_duration_zero():
    val duration = Duration.from_millis(0)
    val formatted = format_duration(duration)
    assert(formatted == "0s")

fn test_format_duration_compact():
    val duration = Duration.from_seconds(90)
    val formatted = format_duration_compact(duration)
    assert(formatted.contains("1m30s"))

fn test_format_as_seconds():
    val duration = Duration.from_seconds(123)
    val formatted = format_as_seconds(duration)
    assert(formatted.contains("123"))
    assert(formatted.contains("s"))

fn test_format_as_minutes():
    val duration = Duration.from_seconds(150)
    val formatted = format_as_minutes(duration)
    assert(formatted.contains("2m"))
    assert(formatted.contains("30s"))

fn test_format_as_hours():
    val duration = Duration.from_minutes(150)
    val formatted = format_as_hours(duration)
    assert(formatted.contains("2h"))
    assert(formatted.contains("30m"))

# =====================================
# Time Unit Conversion Tests
# =====================================

fn test_millis_to_seconds():
    assert(millis_to_seconds(5000) == 5)

fn test_seconds_to_millis():
    assert(seconds_to_millis(10) == 10000)

fn test_minutes_to_seconds():
    assert(minutes_to_seconds(5) == 300)

fn test_hours_to_minutes():
    assert(hours_to_minutes(2) == 120)

fn test_days_to_hours():
    assert(days_to_hours(3) == 72)

fn test_hours_to_seconds():
    assert(hours_to_seconds(1) == 3600)

fn test_days_to_seconds():
    assert(days_to_seconds(1) == 86400)

# =====================================
# Timestamp Tests
# =====================================

fn test_timestamp_from_seconds():
    val ts = Timestamp.from_seconds(1000000)
    assert(ts.get_seconds() == 1000000)

fn test_timestamp_add_duration():
    val ts = Timestamp.from_seconds(1000)
    val duration = Duration.from_seconds(500)
    val new_ts = ts.add_duration(duration)

    assert(new_ts.get_seconds() == 1500)

fn test_timestamp_subtract_duration():
    val ts = Timestamp.from_seconds(1000)
    val duration = Duration.from_seconds(200)
    val new_ts = ts.subtract_duration(duration)

    assert(new_ts.get_seconds() == 800)

fn test_timestamp_duration_since():
    val ts1 = Timestamp.from_seconds(2000)
    val ts2 = Timestamp.from_seconds(1000)
    val duration = ts1.duration_since(ts2)

    assert(duration.total_seconds() == 1000)

# =====================================
# Duration Comparison Tests
# =====================================

fn test_duration_equals():
    val d1 = Duration.from_seconds(60)
    val d2 = Duration.from_minutes(1)
    assert(duration_equals(d1, d2))

fn test_duration_greater_than():
    val d1 = Duration.from_seconds(100)
    val d2 = Duration.from_seconds(50)
    assert(duration_greater_than(d1, d2))

fn test_duration_less_than():
    val d1 = Duration.from_seconds(30)
    val d2 = Duration.from_seconds(60)
    assert(duration_less_than(d1, d2))

fn test_duration_max():
    val d1 = Duration.from_seconds(100)
    val d2 = Duration.from_seconds(50)
    val max_duration = duration_max(d1, d2)

    assert(max_duration.total_seconds() == 100)

fn test_duration_min():
    val d1 = Duration.from_seconds(100)
    val d2 = Duration.from_seconds(50)
    val min_duration = duration_min(d1, d2)

    assert(min_duration.total_seconds() == 50)

# =====================================
# Common Duration Tests
# =====================================

fn test_one_millisecond():
    val duration = one_millisecond()
    assert(duration.total_millis() == 1)

fn test_one_second():
    val duration = one_second()
    assert(duration.total_seconds() == 1)

fn test_one_minute():
    val duration = one_minute()
    assert(duration.total_minutes() == 1)

fn test_one_hour():
    val duration = one_hour()
    assert(duration.total_hours() == 1)

fn test_one_day():
    val duration = one_day()
    assert(duration.total_days() == 1)

# =====================================
# Duration Utility Tests
# =====================================

fn test_is_zero_duration():
    val duration = Duration.from_millis(0)
    assert(is_zero_duration(duration))

fn test_is_negative_duration():
    val duration = Duration.from_millis(-1000)
    assert(is_negative_duration(duration))

fn test_duration_abs_positive():
    val duration = Duration.from_seconds(100)
    val abs_duration = duration_abs(duration)
    assert(abs_duration.total_seconds() == 100)

fn test_duration_abs_negative():
    val duration = Duration.from_seconds(-100)
    val abs_duration = duration_abs(duration)
    assert(abs_duration.total_seconds() == 100)

fn test_duration_negate():
    val duration = Duration.from_seconds(100)
    val negated = duration_negate(duration)
    assert(negated.total_seconds() == -100)

fn test_sum_durations():
    val durations = [
        Duration.from_seconds(10),
        Duration.from_seconds(20),
        Duration.from_seconds(30)
    ]
    val sum = sum_durations(durations)
    assert(sum.total_seconds() == 60)

fn test_sum_durations_empty():
    val durations: List<Duration> = []
    val sum = sum_durations(durations)
    assert(sum.total_millis() == 0)

fn test_average_duration():
    val durations = [
        Duration.from_seconds(10),
        Duration.from_seconds(20),
        Duration.from_seconds(30)
    ]
    match average_duration(durations):
        Some(avg) => assert(avg.total_seconds() == 20)
        None => assert(false)

fn test_average_duration_empty():
    val durations: List<Duration> = []
    match average_duration(durations):
        Some(_) => assert(false)
        None => assert(true)

# =====================================
# Time Range Tests
# =====================================

fn test_time_range_duration():
    val start = Timestamp.from_seconds(1000)
    val end = Timestamp.from_seconds(2000)
    val range = TimeRange.new(start, end)
    val duration = range.duration()

    assert(duration.total_seconds() == 1000)

fn test_time_range_contains():
    val start = Timestamp.from_seconds(1000)
    val end = Timestamp.from_seconds(2000)
    val range = TimeRange.new(start, end)

    val ts_inside = Timestamp.from_seconds(1500)
    assert(range.contains(ts_inside))

    val ts_outside = Timestamp.from_seconds(3000)
    assert(not range.contains(ts_outside))

fn test_time_range_overlaps():
    val range1 = TimeRange.new(
        Timestamp.from_seconds(1000),
        Timestamp.from_seconds(2000)
    )
    val range2 = TimeRange.new(
        Timestamp.from_seconds(1500),
        Timestamp.from_seconds(2500)
    )

    assert(range1.overlaps(range2))
    assert(range2.overlaps(range1))

fn test_time_range_no_overlap():
    val range1 = TimeRange.new(
        Timestamp.from_seconds(1000),
        Timestamp.from_seconds(2000)
    )
    val range2 = TimeRange.new(
        Timestamp.from_seconds(3000),
        Timestamp.from_seconds(4000)
    )

    assert(not range1.overlaps(range2))

# =====================================
# Round-trip Tests
# =====================================

fn test_parse_format_roundtrip_simple():
    val original = "1h30m45s"
    match parse_duration(original):
        Some(duration) =>
            val formatted = format_duration_compact(duration)
            assert(formatted == "1h30m45s")
        None => assert(false)

fn test_parse_format_roundtrip_complex():
    val original = "2d5h"
    match parse_duration(original):
        Some(duration) =>
            val formatted = format_duration_compact(duration)
            assert(formatted.contains("2d"))
            assert(formatted.contains("5h"))
        None => assert(false)

# =====================================
# Edge Cases
# =====================================

fn test_duration_very_large():
    val duration = Duration.from_days(365)
    assert(duration.total_days() == 365)

fn test_duration_zero_operations():
    val zero = Duration.from_millis(0)
    val d = Duration.from_seconds(100)

    val added = d.add(zero)
    assert(added.total_seconds() == 100)

    val subtracted = d.subtract(zero)
    assert(subtracted.total_seconds() == 100)

fn test_timestamp_boundary():
    val ts = Timestamp.from_seconds(0)
    assert(ts.get_seconds() == 0)
