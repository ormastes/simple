# Effect System Tests
# Tests for async safety tracking and effect verification

import std.spec
import game_engine.effects.{GameEffect, EffectContext}

describe "GameEffect":
    it "creates RenderEffect":
        val effect = GameEffect::RenderEffect("draw_sprite")
        expect effect is GameEffect::RenderEffect(_)

    it "creates PhysicsEffect":
        val effect = GameEffect::PhysicsEffect("apply_force")
        expect effect is GameEffect::PhysicsEffect(_)

    it "creates AudioEffect":
        val effect = GameEffect::AudioEffect("play_sound")
        expect effect is GameEffect::AudioEffect(_)

    it "creates IOEffect":
        val effect = GameEffect::IOEffect("load_asset")
        expect effect is GameEffect::IOEffect(_)

    it "creates EngineSyncEffect":
        val effect = GameEffect::EngineSyncEffect("update_scene")
        expect effect is GameEffect::EngineSyncEffect(_)

describe "EffectContext":
    context "creation":
        it "creates empty context":
            val ctx = EffectContext::new()
            expect ctx.is_empty()
            expect ctx.effect_count() == 0

        it "starts as async safe":
            val ctx = EffectContext::new()
            expect ctx.is_async_safe()

    context "effect management":
        it "adds effects":
            var ctx = EffectContext::new()
            ctx.add_effect(GameEffect::RenderEffect("draw"))
            expect ctx.has_effects()
            expect ctx.effect_count() == 1

        it "checks for specific effect":
            var ctx = EffectContext::new()
            ctx.add_effect(GameEffect::PhysicsEffect("collision"))
            expect ctx.has_effect("collision")
            expect not ctx.has_effect("other")

    context "async safety":
        it "remains async safe with render effects":
            var ctx = EffectContext::new()
            ctx.add_effect(GameEffect::RenderEffect("draw"))
            expect ctx.is_async_safe()

        it "becomes unsafe with sync effects":
            var ctx = EffectContext::new()
            ctx.add_effect(GameEffect::EngineSyncEffect("main_thread_op"))
            expect not ctx.is_async_safe()

    context "summary":
        it "provides context summary":
            var ctx = EffectContext::new()
            ctx.add_effect(GameEffect::RenderEffect("draw"))
            val summary = ctx.summary()
            expect "1 effects" in summary or "1 effect" in summary
