"""
LMS Server Tests
Feature: Language Model Server Implementation
Category: LMS, Server
Status: Complete

Tests for the Language Model Server implementation including
server state management, error handling, and protocol types.
"""

use std.spec
use lms.server.{LmsServer, ServerState}
use lms.error.{LmsError, to_json_rpc_code, to_message, error_response, success_response}
use lms.protocol.{ServerInfo, ServerCapabilities, Tool, Resource}

describe "LmsServer":
    """
    Tests for LmsServer creation and state management.
    """
    it "should create a new server":
        val server = LmsServer.new()
        expect(server != nil)

    it "should start in Uninitialized state":
        val server = LmsServer.new()
        expect(server.state.is_uninitialized())

describe "ServerState":
    it "should convert to string":
        expect(ServerState.Uninitialized.to_string() == "uninitialized")
        expect(ServerState.Initialized.to_string() == "initialized")
        expect(ServerState.ShuttingDown.to_string() == "shutting-down")

    it "should provide descriptions":
        expect(ServerState.Uninitialized.description() == "Server not yet initialized")
        expect(ServerState.Initialized.description() == "Server initialized and running")

    it "should check state predicates":
        expect(ServerState.Uninitialized.is_uninitialized())
        expect(not ServerState.Uninitialized.is_initialized())
        expect(ServerState.Initialized.is_initialized())
        expect(ServerState.Initialized.can_accept_requests())
        expect(not ServerState.Uninitialized.can_accept_requests())

describe "LmsError":
    it "should convert errors to JSON-RPC codes":
        expect(to_json_rpc_code(LmsError.MethodNotFound("test")) == -32601)
        expect(to_json_rpc_code(LmsError.InvalidParams("bad")) == -32602)
        expect(to_json_rpc_code(LmsError.InternalError("oops")) == -32603)
        expect(to_json_rpc_code(LmsError.NotInitialized) == -32002)

    it "should create error messages":
        expect(to_message(LmsError.NotInitialized) == "Server not initialized")
        expect(to_message(LmsError.AlreadyInitialized) == "Server already initialized")
        expect(to_message(LmsError.MethodNotFound("foo")) == "Method not found: foo")
        expect(to_message(LmsError.FileNotFound("/tmp/x")) == "File not found: /tmp/x")

    it "should provide error details":
        val err = LmsError.FileNotFound("/path/to/file")
        expect(err.get_detail() == Some("/path/to/file"))
        expect(LmsError.NotInitialized.get_detail() == nil)

    it "should classify client vs server errors":
        expect(LmsError.InvalidRequest("bad").is_client_error())
        expect(LmsError.MethodNotFound("x").is_client_error())
        expect(LmsError.InternalError("crash").is_server_error())
        expect(LmsError.TransportError("io").is_server_error())

describe "Protocol types":
    it "should create server info":
        val server_info = ServerInfo { name: "test-server", version: "1.0.0" }
        expect(server_info.name == "test-server")
        expect(server_info.version == "1.0.0")

    it "should create error response dict":
        val err = LmsError.MethodNotFound("unknown")
        val response = error_response(42, err)
        expect(response["jsonrpc"] == "2.0")
        expect(response["id"] == 42)
        expect(response["error"]["code"] == -32601)

    it "should create success response dict":
        val data = {"result": "ok"}
        val response = success_response(1, data)
        expect(response["jsonrpc"] == "2.0")
        expect(response["id"] == 1)
        expect(response["result"]["result"] == "ok")
