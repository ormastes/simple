# Context Manager Tests
# Tests for the ContextManager trait and built-in context managers

import std.spec
import std.{Timer, Lock, TransactionContext, contextmanager, suppress}

describe "ContextManager trait":
    it "can be implemented by custom classes":
        # Test using Timer as an example ContextManager implementation
        val timer = Timer.new("test")

        # Test that it implements the trait methods
        val entered = timer.__enter__()
        expect entered != nil

        val suppressed = timer.__exit__(nil, nil, nil)
        expect suppressed == false

describe "Timer context manager":
    it "times code execution":
        val timer = Timer.new("test_operation")
        expect timer.is_running() == false

        timer.__enter__()
        expect timer.is_running() == true

        val elapsed = timer.get_elapsed()
        expect elapsed >= 0.0

        timer.__exit__(nil, nil, nil)

describe "Lock context manager":
    it "acquires and releases lock":
        val lock = Lock.new()
        expect lock.is_unlocked() == true

        lock.__enter__()
        expect lock.is_locked() == true

        lock.__exit__(nil, nil, nil)
        expect lock.is_unlocked() == true

describe "TransactionContext":
    it "commits on success":
        val tx = TransactionContext.new()
        expect tx.is_pending() == true

        tx.__enter__()
        tx.__exit__(nil, nil, nil)

        expect tx.is_committed() == true
        expect tx.is_completed() == true

    it "rolls back on manual rollback":
        val tx = TransactionContext.new()
        tx.__enter__()
        tx.rollback()
        tx.__exit__(nil, nil, nil)

        expect tx.is_rolled_back() == true
        expect tx.is_completed() == true

describe "contextmanager helper":
    it "creates context manager from functions":
        var entered = false
        var exited = false

        fn enter_fn():
            entered = true
            return "resource"

        fn exit_fn(exc_type, exc_value, tb):
            exited = true
            return false

        val cm = contextmanager(enter_fn, exit_fn)
        expect entered == false

        val resource = cm.__enter__()
        expect entered == true
        expect resource == "resource"

        cm.__exit__(nil, nil, nil)
        expect exited == true

describe "suppress context manager":
    it "suppresses specified exceptions":
        val ctx = suppress("ValueError", "KeyError")
        expect ctx != nil

        # Test that __exit__ returns true for suppression
        # In real usage, this would suppress ValueError
        val result = ctx.__exit__("ValueError", "test error", nil)
        expect result == true
