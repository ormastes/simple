#!/usr/bin/env simple
# Tests for skip/ignore decorators

use std.spec.*
use std.spec.decorators.*
use std.spec.env_detect.*

describe "Skip/Ignore Decorators":
    describe "skip decorator":
        it "creates skip decorator with all parameters":
            val decorator = skip(
                platforms: [],
                runtimes: [],
                profiles: [],
                architectures: [],
                features: [],
                version: "",
                hardware: [],
                requires: [],
                env_vars: {},
                fs_features: [],
                network: false,
                tags: [],
                reason: "test reason"
            )
            # Decorator should be a function
            check(decorator != nil)

        it "creates skip decorator with platforms only":
            val decorator = skip(
                platforms: ["windows"],
                runtimes: [],
                profiles: [],
                architectures: [],
                features: [],
                version: "",
                hardware: [],
                requires: [],
                env_vars: {},
                fs_features: [],
                network: false,
                tags: [],
                reason: "Windows not supported yet"
            )
            check(decorator != nil)

        it "skip decorator runs test when conditions don't match":
            var test_ran = false
            val decorator = skip(
                platforms: ["nonexistent_os_xyz"],
                runtimes: [],
                profiles: [],
                architectures: [],
                features: [],
                version: "",
                hardware: [],
                requires: [],
                env_vars: {},
                fs_features: [],
                network: false,
                tags: [],
                reason: "test"
            )
            # Note: This test is tricky because decorator expects rt_test_it
            # We can't easily test the actual behavior without runtime support
            check(true)

    describe "ignore decorator":
        it "creates ignore decorator with all parameters":
            val decorator = ignore(
                platforms: [],
                runtimes: [],
                profiles: [],
                architectures: [],
                features: [],
                version: "",
                hardware: [],
                requires: [],
                env_vars: {},
                fs_features: [],
                network: false,
                tags: [],
                reason: "test reason"
            )
            check(decorator != nil)

        it "creates ignore decorator with platforms only":
            val decorator = ignore(
                platforms: ["windows"],
                runtimes: [],
                profiles: [],
                architectures: [],
                features: [],
                version: "",
                hardware: [],
                requires: [],
                env_vars: {},
                fs_features: [],
                network: false,
                tags: [],
                reason: "Unix-only API"
            )
            check(decorator != nil)

    describe "only_on decorator":
        it "creates only_on decorator":
            val decorator = only_on(
                platforms: ["linux"],
                runtimes: [],
                profiles: [],
                architectures: [],
                features: [],
                version: "",
                hardware: [],
                requires: [],
                env_vars: {},
                fs_features: [],
                network: false,
                tags: []
            )
            check(decorator != nil)

        it "creates only_on decorator with multiple conditions":
            val decorator = only_on(
                platforms: ["linux", "macos"],
                runtimes: ["compiled"],
                profiles: [],
                architectures: [],
                features: [],
                version: "",
                hardware: [],
                requires: [],
                env_vars: {},
                fs_features: [],
                network: false,
                tags: []
            )
            check(decorator != nil)

    describe "skip_if decorator":
        it "creates skip_if decorator with condition":
            val decorator = skip_if(
                fn(): false,
                "Condition not met"
            )
            check(decorator != nil)

        it "creates skip_if with environment check":
            val decorator = skip_if(
                fn(): get_env("CI") == "",
                "CI environment required"
            )
            check(decorator != nil)

        it "creates skip_if with complex condition":
            val decorator = skip_if(
                fn():
                    val is_win = is_windows()
                    val is_interp = is_interpreter()
                    is_win and is_interp,
                "Not on Windows interpreter"
            )
            check(decorator != nil)

    describe "Simplified decorators":
        it "skip_on_windows creates decorator":
            val decorator = skip_on_windows("Not yet ported")
            check(decorator != nil)

        it "skip_on_linux creates decorator":
            val decorator = skip_on_linux("Not yet ported")
            check(decorator != nil)

        it "skip_on_interpreter creates decorator":
            val decorator = skip_on_interpreter("Requires compiled mode")
            check(decorator != nil)

        it "ignore_on_windows creates decorator":
            val decorator = ignore_on_windows("Unix-only API")
            check(decorator != nil)

    describe "Real-world usage patterns":
        it "creates platform-specific skip":
            val skip_win = skip(
                platforms: ["windows"],
                runtimes: [],
                profiles: [],
                architectures: [],
                features: [],
                version: "",
                hardware: [],
                requires: [],
                env_vars: {},
                fs_features: [],
                network: false,
                tags: [],
                reason: "File permissions not implemented"
            )
            check(skip_win != nil)

        it "creates runtime-specific skip":
            val skip_interp = skip(
                platforms: [],
                runtimes: ["interpreter"],
                profiles: [],
                architectures: [],
                features: [],
                version: "",
                hardware: [],
                requires: [],
                env_vars: {},
                fs_features: [],
                network: false,
                tags: [],
                reason: "Generics require compilation"
            )
            check(skip_interp != nil)

        it "creates hardware-specific skip":
            val skip_no_gpu = skip(
                platforms: [],
                runtimes: [],
                profiles: [],
                architectures: [],
                features: [],
                version: "",
                hardware: ["gpu"],
                requires: [],
                env_vars: {},
                fs_features: [],
                network: false,
                tags: [],
                reason: "GPU required for test"
            )
            check(skip_no_gpu != nil)

        it "creates complex multi-condition skip":
            val skip_complex = skip(
                platforms: ["windows"],
                runtimes: ["interpreter"],
                profiles: ["debug"],
                architectures: [],
                features: [],
                version: "",
                hardware: [],
                requires: [],
                env_vars: {},
                fs_features: [],
                network: false,
                tags: ["slow", "integration"],
                reason: "Complex test requiring specific environment"
            )
            check(skip_complex != nil)

        it "creates ignore for platform-specific API":
            val ignore_win = ignore(
                platforms: ["windows"],
                runtimes: [],
                profiles: [],
                architectures: [],
                features: [],
                version: "",
                hardware: [],
                requires: [],
                env_vars: {},
                fs_features: [],
                network: false,
                tags: [],
                reason: "Unix fork() API not available on Windows"
            )
            check(ignore_win != nil)

        it "creates ignore for architecture limitation":
            val ignore_32bit = ignore(
                platforms: [],
                runtimes: [],
                profiles: [],
                architectures: ["x86", "arm32"],
                features: [],
                version: "",
                hardware: [],
                requires: [],
                env_vars: {},
                fs_features: [],
                network: false,
                tags: [],
                reason: "64-bit pointers required"
            )
            check(ignore_32bit != nil)

    describe "Semantic distinction":
        it "skip represents TODO (will implement in future)":
            val skip_todo = skip(
                platforms: ["windows"],
                runtimes: [],
                profiles: [],
                architectures: [],
                features: [],
                version: "",
                hardware: [],
                requires: [],
                env_vars: {},
                fs_features: [],
                network: false,
                tags: [],
                reason: "Windows support planned for v1.0"
            )
            check(skip_todo != nil)

        it "ignore represents won't fix (fundamentally not supported)":
            val ignore_permanent = ignore(
                platforms: ["windows"],
                runtimes: [],
                profiles: [],
                architectures: [],
                features: [],
                version: "",
                hardware: [],
                requires: [],
                env_vars: {},
                fs_features: [],
                network: false,
                tags: [],
                reason: "Unix-specific syscall with no Windows equivalent"
            )
            check(ignore_permanent != nil)

    describe "Edge cases":
        it "handles empty reason":
            val decorator = skip(
                platforms: ["windows"],
                runtimes: [],
                profiles: [],
                architectures: [],
                features: [],
                version: "",
                hardware: [],
                requires: [],
                env_vars: {},
                fs_features: [],
                network: false,
                tags: [],
                reason: ""
            )
            check(decorator != nil)

        it "handles multiple platforms":
            val decorator = skip(
                platforms: ["windows", "macos", "freebsd"],
                runtimes: [],
                profiles: [],
                architectures: [],
                features: [],
                version: "",
                hardware: [],
                requires: [],
                env_vars: {},
                fs_features: [],
                network: false,
                tags: [],
                reason: "Linux-only test"
            )
            check(decorator != nil)

        it "handles multiple tags":
            val decorator = skip(
                platforms: [],
                runtimes: [],
                profiles: [],
                architectures: [],
                features: [],
                version: "",
                hardware: [],
                requires: [],
                env_vars: {},
                fs_features: [],
                network: false,
                tags: ["slow", "integration", "e2e", "network"],
                reason: "Tagged test"
            )
            check(decorator != nil)

        it "handles version constraints":
            val decorator = skip(
                platforms: [],
                runtimes: [],
                profiles: [],
                architectures: [],
                features: [],
                version: ">= 1.0.0",
                hardware: [],
                requires: [],
                env_vars: {},
                fs_features: [],
                network: false,
                tags: [],
                reason: "Requires v1.0.0+"
            )
            check(decorator != nil)
