# @skip - Module lib.database.feature not available in runtime
# Feature Database Tests

use lib.database.feature.*
use lib.database.feature_utils.{parse_sspec_metadata, SSpecItem}

describe "Feature Database":
    context "Basic Operations":
        it "creates empty feature database":
            val db = create_feature_database(":memory:")
            val features = db.all_features()
            expect features.len() == 0

        it "adds feature":
            var db = create_feature_database(":memory:")
            val feature = Feature(
                id: "test_1",
                category: "Testing",
                name: "Test Feature",
                description: "A test feature",
                spec_file: "test.spl",
                pure_status: FeatureStatus.Done,
                hybrid_status: FeatureStatus.InProgress,
                llvm_status: FeatureStatus.Planned,
                created_at: "2026-02-05",
                updated_at: "2026-02-05",
                valid: true
            )
            val added = db.add_feature(feature)
            expect added == true

            val features = db.all_features()
            expect features.len() == 1
            expect features[0].id == "test_1"

        it "updates feature":
            var db = create_feature_database(":memory:")
            val feature = Feature(
                id: "test_1",
                category: "Testing",
                name: "Original",
                description: "Original desc",
                spec_file: "test.spl",
                pure_status: FeatureStatus.Planned,
                hybrid_status: FeatureStatus.Planned,
                llvm_status: FeatureStatus.Planned,
                created_at: "2026-02-05",
                updated_at: "2026-02-05",
                valid: true
            )
            db.add_feature(feature)

            val updated = Feature(
                id: "test_1",
                category: "Testing",
                name: "Updated",
                description: "Updated desc",
                spec_file: "test.spl",
                pure_status: FeatureStatus.Done,
                hybrid_status: FeatureStatus.Done,
                llvm_status: FeatureStatus.Done,
                created_at: "2026-02-05",
                updated_at: "2026-02-06",
                valid: true
            )
            db.update_feature("test_1", updated)

            val retrieved = db.get_feature("test_1")
            expect retrieved.?
            expect retrieved?.name == "Updated"
            expect retrieved?.pure_status == FeatureStatus.Done

    context "Filtering and Queries":
        it "filters by category":
            var db = create_feature_database(":memory:")
            db.add_feature(Feature(
                id: "1", category: "Parser", name: "F1", description: "",
                spec_file: "", pure_status: FeatureStatus.Done,
                hybrid_status: FeatureStatus.Done, llvm_status: FeatureStatus.Done,
                created_at: "", updated_at: "", valid: true
            ))
            db.add_feature(Feature(
                id: "2", category: "Codegen", name: "F2", description: "",
                spec_file: "", pure_status: FeatureStatus.Done,
                hybrid_status: FeatureStatus.Done, llvm_status: FeatureStatus.Done,
                created_at: "", updated_at: "", valid: true
            ))
            db.add_feature(Feature(
                id: "3", category: "Parser", name: "F3", description: "",
                spec_file: "", pure_status: FeatureStatus.Done,
                hybrid_status: FeatureStatus.Done, llvm_status: FeatureStatus.Done,
                created_at: "", updated_at: "", valid: true
            ))

            val parser_features = db.features_by_category("Parser")
            expect parser_features.len() == 2

        it "filters by status":
            var db = create_feature_database(":memory:")
            db.add_feature(Feature(
                id: "1", category: "Test", name: "Done F", description: "",
                spec_file: "", pure_status: FeatureStatus.Done,
                hybrid_status: FeatureStatus.Done, llvm_status: FeatureStatus.Done,
                created_at: "", updated_at: "", valid: true
            ))
            db.add_feature(Feature(
                id: "2", category: "Test", name: "WIP F", description: "",
                spec_file: "", pure_status: FeatureStatus.InProgress,
                hybrid_status: FeatureStatus.InProgress, llvm_status: FeatureStatus.InProgress,
                created_at: "", updated_at: "", valid: true
            ))

            val done = db.features_by_status(FeatureStatus.Done)
            expect done.len() == 1
            expect done[0].id == "1"

        it "finds incomplete features":
            var db = create_feature_database(":memory:")
            db.add_feature(Feature(
                id: "1", category: "Test", name: "Complete", description: "",
                spec_file: "", pure_status: FeatureStatus.Done,
                hybrid_status: FeatureStatus.Done, llvm_status: FeatureStatus.Done,
                created_at: "", updated_at: "", valid: true
            ))
            db.add_feature(Feature(
                id: "2", category: "Test", name: "Incomplete", description: "",
                spec_file: "", pure_status: FeatureStatus.Done,
                hybrid_status: FeatureStatus.InProgress, llvm_status: FeatureStatus.Planned,
                created_at: "", updated_at: "", valid: true
            ))

            val incomplete = db.incomplete_features()
            expect incomplete.len() == 1
            expect incomplete[0].id == "2"

    context "Utility Methods":
        it "sorts features by ID":
            var db = create_feature_database(":memory:")
            db.add_feature(Feature(
                id: "1.10", category: "Test", name: "F1", description: "",
                spec_file: "", pure_status: FeatureStatus.Done,
                hybrid_status: FeatureStatus.Done, llvm_status: FeatureStatus.Done,
                created_at: "", updated_at: "", valid: true
            ))
            db.add_feature(Feature(
                id: "1.2", category: "Test", name: "F2", description: "",
                spec_file: "", pure_status: FeatureStatus.Done,
                hybrid_status: FeatureStatus.Done, llvm_status: FeatureStatus.Done,
                created_at: "", updated_at: "", valid: true
            ))
            db.add_feature(Feature(
                id: "1.3", category: "Test", name: "F3", description: "",
                spec_file: "", pure_status: FeatureStatus.Done,
                hybrid_status: FeatureStatus.Done, llvm_status: FeatureStatus.Done,
                created_at: "", updated_at: "", valid: true
            ))

            val sorted = db.sorted_features()
            expect sorted.len() == 3
            expect sorted[0].id == "1.2"
            expect sorted[1].id == "1.3"
            expect sorted[2].id == "1.10"

        it "finds duplicate IDs":
            var db = create_feature_database(":memory:")
            db.add_feature(Feature(
                id: "dup_1", category: "Test", name: "First", description: "",
                spec_file: "", pure_status: FeatureStatus.Done,
                hybrid_status: FeatureStatus.Done, llvm_status: FeatureStatus.Done,
                created_at: "", updated_at: "", valid: true
            ))
            db.add_feature(Feature(
                id: "unique_1", category: "Test", name: "Unique", description: "",
                spec_file: "", pure_status: FeatureStatus.Done,
                hybrid_status: FeatureStatus.Done, llvm_status: FeatureStatus.Done,
                created_at: "", updated_at: "", valid: true
            ))
            db.add_feature(Feature(
                id: "dup_1", category: "Test", name: "Second", description: "",
                spec_file: "", pure_status: FeatureStatus.Done,
                hybrid_status: FeatureStatus.Done, llvm_status: FeatureStatus.Done,
                created_at: "", updated_at: "", valid: true
            ))

            val dups = db.find_duplicates()
            expect dups.len() == 1
            expect dups[0] == "dup_1"

        it "updates feature status":
            var db = create_feature_database(":memory:")
            db.add_feature(Feature(
                id: "test_1", category: "Test", name: "Feature", description: "",
                spec_file: "", pure_status: FeatureStatus.Planned,
                hybrid_status: FeatureStatus.Planned, llvm_status: FeatureStatus.Planned,
                created_at: "2026-02-05", updated_at: "2026-02-05", valid: true
            ))

            val updated = db.update_feature_status("test_1", FeatureStatus.Done)
            expect updated == true

            val feature = db.get_feature("test_1")
            expect feature?.pure_status == FeatureStatus.Done

        it "counts features by status":
            var db = create_feature_database(":memory:")
            db.add_feature(Feature(
                id: "1", category: "Test", name: "F1", description: "",
                spec_file: "", pure_status: FeatureStatus.Done,
                hybrid_status: FeatureStatus.Done, llvm_status: FeatureStatus.Done,
                created_at: "", updated_at: "", valid: true
            ))
            db.add_feature(Feature(
                id: "2", category: "Test", name: "F2", description: "",
                spec_file: "", pure_status: FeatureStatus.Done,
                hybrid_status: FeatureStatus.Done, llvm_status: FeatureStatus.Done,
                created_at: "", updated_at: "", valid: true
            ))
            db.add_feature(Feature(
                id: "3", category: "Test", name: "F3", description: "",
                spec_file: "", pure_status: FeatureStatus.InProgress,
                hybrid_status: FeatureStatus.InProgress, llvm_status: FeatureStatus.InProgress,
                created_at: "", updated_at: "", valid: true
            ))

            val done_count = db.count_by_status(FeatureStatus.Done)
            expect done_count == 2

    context "Category Statistics":
        it "calculates category stats":
            var db = create_feature_database(":memory:")
            db.add_feature(Feature(
                id: "1", category: "Parser", name: "F1", description: "",
                spec_file: "", pure_status: FeatureStatus.Done,
                hybrid_status: FeatureStatus.Done, llvm_status: FeatureStatus.Done,
                created_at: "", updated_at: "", valid: true
            ))
            db.add_feature(Feature(
                id: "2", category: "Parser", name: "F2", description: "",
                spec_file: "", pure_status: FeatureStatus.InProgress,
                hybrid_status: FeatureStatus.InProgress, llvm_status: FeatureStatus.InProgress,
                created_at: "", updated_at: "", valid: true
            ))
            db.add_feature(Feature(
                id: "3", category: "Parser", name: "F3", description: "",
                spec_file: "", pure_status: FeatureStatus.Planned,
                hybrid_status: FeatureStatus.Planned, llvm_status: FeatureStatus.Planned,
                created_at: "", updated_at: "", valid: true
            ))

            val stats = db.category_stats("Parser")
            expect stats.total == 3
            expect stats.done == 1
            expect stats.in_progress == 1
            expect stats.planned == 1

        it "lists all categories":
            var db = create_feature_database(":memory:")
            db.add_feature(Feature(
                id: "1", category: "Parser", name: "F1", description: "",
                spec_file: "", pure_status: FeatureStatus.Done,
                hybrid_status: FeatureStatus.Done, llvm_status: FeatureStatus.Done,
                created_at: "", updated_at: "", valid: true
            ))
            db.add_feature(Feature(
                id: "2", category: "Codegen", name: "F2", description: "",
                spec_file: "", pure_status: FeatureStatus.Done,
                hybrid_status: FeatureStatus.Done, llvm_status: FeatureStatus.Done,
                created_at: "", updated_at: "", valid: true
            ))
            db.add_feature(Feature(
                id: "3", category: "Runtime", name: "F3", description: "",
                spec_file: "", pure_status: FeatureStatus.Done,
                hybrid_status: FeatureStatus.Done, llvm_status: FeatureStatus.Done,
                created_at: "", updated_at: "", valid: true
            ))

            val categories = db.all_categories()
            expect categories.len() == 3
            expect categories.contains("Parser")
            expect categories.contains("Codegen")
            expect categories.contains("Runtime")
