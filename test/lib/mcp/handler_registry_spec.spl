# MCP Library Handler Registry Tests

use std.mcp.core.{create_tool_handler, create_resource_handler}
use std.mcp.handler_registry.{register_tool_handler, register_resource_handler, find_tool_handler, find_resource_handler, get_tool_handler_count, get_resource_handler_count, clear_registries}
use std.sspec

describe("MCP Library - Handler Registry"):
    before_each():
        clear_registries()

    it("registers tool handlers"):
        val handler = create_tool_handler(
            "test_tool",
            "Test tool",
            "{}",
            "app.handlers",
            "handle_test"
        )
        register_tool_handler(handler)
        expect(get_tool_handler_count()).to_equal(1)

    it("finds registered tool handler"):
        val handler = create_tool_handler(
            "test_tool",
            "Test tool",
            "{}",
            "app.handlers",
            "handle_test"
        )
        register_tool_handler(handler)

        val found = find_tool_handler("test_tool")
        expect(found.name).to_equal("test_tool")
        expect(found.handler_module).to_equal("app.handlers")

    it("returns empty handler for unknown tool"):
        val found = find_tool_handler("unknown")
        expect(found.name).to_equal("")

    it("registers resource handlers"):
        val handler = create_resource_handler(
            "file://",
            "app.resources",
            "handle_file"
        )
        register_resource_handler(handler)
        expect(get_resource_handler_count()).to_equal(1)

    it("finds resource handler by URI pattern"):
        val handler = create_resource_handler(
            "file://",
            "app.resources",
            "handle_file"
        )
        register_resource_handler(handler)

        val found = find_resource_handler("file:///path/to/file")
        expect(found.uri_pattern).to_equal("file://")

    it("clears registries"):
        register_tool_handler(create_tool_handler("t1", "T1", "{}", "m", "f"))
        register_tool_handler(create_tool_handler("t2", "T2", "{}", "m", "f"))
        expect(get_tool_handler_count()).to_equal(2)

        clear_registries()
        expect(get_tool_handler_count()).to_equal(0)
