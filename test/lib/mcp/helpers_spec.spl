# MCP Library Helpers Tests

use mcp_lib.helpers.{LB, RB, Q, parse_int, min_int, jp, js, jo2, jo3, extract_json_string_v2, extract_json_value, make_result_response, make_error_response, make_tool_result}
use std.sspec

describe("MCP Library - Helpers"):
    it("provides brace helpers"):
        expect(LB()).to_equal("{")
        expect(RB()).to_equal("}")
        expect(Q()).to_equal("\"")

    it("parses integers"):
        expect(parse_int("123")).to_equal(123)
        expect(parse_int("0")).to_equal(0)
        expect(parse_int("999")).to_equal(999)

    it("calculates minimum"):
        expect(min_int(5, 10)).to_equal(5)
        expect(min_int(10, 5)).to_equal(5)
        expect(min_int(7, 7)).to_equal(7)

    it("builds JSON pairs"):
        expect(jp("key", "value")).to_equal("\"key\":value")
        expect(js("text")).to_equal("\"text\"")

    it("builds JSON objects"):
        val obj = jo2(jp("a", "1"), jp("b", "2"))
        expect(obj).to_equal("{\"a\":1,\"b\":2}")

    it("extracts JSON strings"):
        val json = """{"method":"initialize","id":1}"""
        expect(extract_json_string_v2(json, "method")).to_equal("initialize")

    it("extracts JSON values"):
        val json = """{"id":42,"name":"test"}"""
        expect(extract_json_value(json, "id")).to_equal("42")

    it("creates result responses"):
        val response = make_result_response("1", """{"status":"ok"}""")
        expect(response).to_contain("\"jsonrpc\":\"2.0\"")
        expect(response).to_contain("\"id\":1")
        expect(response).to_contain("\"result\":{\"status\":\"ok\"}")

    it("creates error responses"):
        val response = make_error_response("2", -32600, "Invalid request")
        expect(response).to_contain("\"jsonrpc\":\"2.0\"")
        expect(response).to_contain("\"id\":2")
        expect(response).to_contain("\"error\"")
        expect(response).to_contain("-32600")

    it("creates tool results"):
        val result = make_tool_result("42", "Output text")
        expect(result).to_contain("\"jsonrpc\":\"2.0\"")
        expect(result).to_contain("\"id\":42")
        expect(result).to_contain("\"type\":\"text\"")
        expect(result).to_contain("\"text\":\"Output text\"")

    it("extracts arguments from request body"):
        val body = """{"params":{"arguments":{"path":"test.spl","name":"value"}}}"""
        val path = extract_arg(body, "path")
        val name = extract_arg(body, "name")
        expect(path).to_equal("test.spl")
        expect(name).to_equal("value")

    it("returns empty string for missing arguments"):
        val body = """{"params":{"arguments":{"path":"test.spl"}}}"""
        val missing = extract_arg(body, "nonexistent")
        expect(missing).to_equal("")
