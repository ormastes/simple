# End-to-end test of optimized bootstrap components

use app.io.mod (get_args)
use app.mcp.session.{McpState}
use std.mcp.helpers.{LB, RB, jp, js, jo3, extract_json_string_v2, extract_json_value, extract_nested_string, make_error_response, make_result_response}
use std.mcp.schema.{get_all_tool_schemas, init_core_schemas}

fn main():
    print("Testing optimized bootstrap components...")

    # Test 1: Schema initialization
    init_core_schemas()
    val schemas = get_all_tool_schemas()
    if schemas.len() > 100:
        print("✓ Schema initialization works ({schemas.len()} chars)")
    else:
        print("✗ Schema initialization failed")

    # Test 2: McpState creation
    val state = McpState.create()
    print("✓ McpState creation works")

    # Test 3: JSON extraction
    val test_json = """{"jsonrpc":"2.0","id":"1","method":"initialize","params":{"protocolVersion":"2024-11-05"}}"""
    val method = extract_json_string_v2(test_json, "method")
    if method == "initialize":
        print("✓ extract_json_string_v2 works")
    else:
        print("✗ extract_json_string_v2 failed: got {method}")

    val id_val = extract_json_value(test_json, "id")
    if id_val.contains("1"):
        print("✓ extract_json_value works")
    else:
        print("✗ extract_json_value failed: got {id_val}")

    val protocol = extract_nested_string(test_json, "params", "protocolVersion")
    if protocol == "2024-11-05":
        print("✓ extract_nested_string works")
    else:
        print("✗ extract_nested_string failed: got {protocol}")

    # Test 4: Response builders
    val init_result = """{"protocolVersion":"2025-06-18","capabilities":{"tools":{}}}"""
    val response = jo3(jp("jsonrpc", js("2.0")), jp("id", "1"), jp("result", init_result))
    if response.contains("jsonrpc") and response.contains("protocolVersion"):
        print("✓ Response builders work")
    else:
        print("✗ Response builders failed")

    # Test 5: Error response
    val error_resp = make_error_response("1", -32601, "Method not found")
    if error_resp.contains("error") and error_resp.contains("-32601"):
        print("✓ Error response works")
    else:
        print("✗ Error response failed")

    # Test 6: Tool result response
    val tool_resp = make_result_response("1", LB() + jp("content", "[{\"type\":\"text\",\"text\":\"test\"}]") + RB())
    if tool_resp.contains("result") and tool_resp.contains("content"):
        print("✓ Tool result response works")
    else:
        print("✗ Tool result response failed")

    print("")
    print("All optimized bootstrap components working!")
    print("Phase 6 validation: READY FOR DEPLOYMENT")

main()
