# MCP Library Core Tests

use mcp_lib.core.{create_mcp_state, create_tool_handler, create_session_manager, add_session, remove_session, session_exists}
use std.sspec

describe("MCP Library - Core"):
    it("creates empty MCP state"):
        val state = create_mcp_state()
        expect(state.protocol_version).to_equal("")
        expect(state.initialized).to_equal(false)

    it("creates tool handler"):
        val handler = create_tool_handler(
            "test_tool",
            "Test description",
            """{"type":"object"}""",
            "app.mcp.handlers.test",
            "handle_test"
        )
        expect(handler.name).to_equal("test_tool")
        expect(handler.handler_module).to_equal("app.mcp.handlers.test")
        expect(handler.loaded).to_equal(false)

    it("creates session manager"):
        val sm = create_session_manager()
        expect(sm.next_id).to_equal(1)
        expect(sm.sessions.len()).to_equal(0)

    it("adds sessions"):
        var sm = create_session_manager()
        val id1 = sm.add_session()
        val id2 = sm.add_session()
        expect(id1).to_equal("session_1")
        expect(id2).to_equal("session_2")
        expect(sm.sessions.len()).to_equal(2)

    it("removes sessions"):
        var sm = create_session_manager()
        val id = sm.add_session()
        expect(session_exists(sm, id)).to_equal(true)
        sm.remove_session(id)
        expect(session_exists(sm, id)).to_equal(false)

    it("checks session existence"):
        var sm = create_session_manager()
        expect(session_exists(sm, "session_1")).to_equal(false)
        val id = sm.add_session()
        expect(session_exists(sm, id)).to_equal(true)
