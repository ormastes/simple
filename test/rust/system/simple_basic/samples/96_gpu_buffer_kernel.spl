# 96_gpu_buffer_kernel.spl - GPU Buffer/Kernel API Demo
#
# Demonstrates Vulkan GPU buffer operations

# FFI declarations
extern fn rt_vk_available() -> i32
extern fn rt_vk_device_create() -> u64
extern fn rt_vk_device_free(device_handle: u64) -> i32
extern fn rt_vk_device_sync(device_handle: u64) -> i32
extern fn rt_vk_buffer_alloc(device_handle: u64, size: u64) -> u64
extern fn rt_vk_buffer_free(buffer_handle: u64) -> i32

# Check Vulkan availability
available = rt_vk_available()
if available == 0:
    print "Vulkan not available, skipping GPU test"
    main = 0
else:
    print "Vulkan available, running GPU buffer test"

    # Create device
    device = rt_vk_device_create()
    if device == 0:
        print "Failed to create Vulkan device"
        main = 1
    else:
        print "Created Vulkan device: {device}"

        # Allocate buffer
        buffer = rt_vk_buffer_alloc(device, 256)
        if buffer == 0:
            print "Failed to allocate GPU buffer"
            rt_vk_device_free(device)
            main = 1
        else:
            print "Allocated GPU buffer: {buffer} (256 bytes)"

            # Sync device
            sync_result = rt_vk_device_sync(device)
            print "Device sync result: {sync_result}"

            # Cleanup
            rt_vk_buffer_free(buffer)
            print "Freed GPU buffer"

            rt_vk_device_free(device)
            print "Freed Vulkan device"

            print "GPU buffer test completed successfully"
            main = 0
