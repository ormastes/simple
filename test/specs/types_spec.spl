# @skip - type system syntax not fully implemented
# @pending
"""
# Simple Language Type System

# @skip

**Status:** Stable
**Feature IDs:** #20-29
**Keywords:** types, mutability, generics, type-inference
**Last Updated:** 2025-12-28
**Topics:** type-system
**Symbols:** Type, TypeVar, Mutability, Generic
**Module:** simple_type
**Migrated From:** doc/spec/types.md

## Overview

Complete specification of Simple's type system, including primitives, composites, generics, and mutability rules.

The type system provides:
- Strong static typing with inference
- Immutable-by-default data structures
- Generic types with constraints
- Unit types for dimensional analysis
- Semantic type checking

## Related Specifications

- **Syntax** - Type annotation syntax
- **Type Inference** - Hindley-Milner inference algorithm
- **Data Structures** - Composite types
- **Memory** - Ownership and reference types
"""
# @skip

# Test cases extracted from specification

## Test: Built-in Types

it "fetch_user":
    """
    Async functions return Promise types automatically.
    
    **Links:** Promise, Type::Function
    **Related:** mutability_rules_2
    """
    # Declared return type: User
    # Actual return type: Promise<User>
    fn fetch_user(id: UserId) -> User:
        val resp ~= http.get("/users/{id}")
        return parse(resp)

    # Using the promise
    val user ~= fetch_user(1_uid)      # user: User (awaited)
    val promise = fetch_user(1_uid)     # promise: Promise<User>
    pass

## Test: Mutability Rules

it "mutability_rules_2":
    """
    Immutable vs mutable struct declarations.
    
    **Links:** Mutability, Struct
    """
    struct Point:
        x: f64
        y: f64

    struct Cursor:
        x: f64
        y: f64
    pass

## Test: Mutability Rules

it "mutability_rules_3":
    """
    Mutability applies to fields and behavior.
    
    **Links:** Mutability, Class
    **Related:** mutability_rules_2
    """
    class Person:
        name: String
        age: i32

    immut class Color:
        red: u8
        green: u8
        blue: u8
    pass

## Test: Mutability Rules

it "mutability_rules_4":
    """
    Mutability Rules
    """
    x = 10            # mutable variable (val is optional)
    val y = 20        # also mutable (val is explicit but optional)
    x = 30            # ok, x is mutable
    y = 40            # ok, y is mutable

    const MAX = 100   # immutable constant
    MAX = 200         # compile error, const cannot be reassigned
    pass

## Test: Unit Types and Literal Suffixes

it "unit_types_and_literal_suffixes_5":
    """
    Unit Types and Literal Suffixes
    """
    # Syntax: unit name(base: BaseType): suffix = factor, ...
    unit length(base: f64):
        mm = 0.001        # 1 mm = 0.001 meters
        cm = 0.01         # 1 cm = 0.01 meters
        m = 1.0           # base unit
        km = 1000.0       # 1 km = 1000 meters
        inch = 0.0254
        ft = 0.3048
        mile = 1609.34

    unit time(base: f64):
        ns = 0.000000001
        us = 0.000001
        ms = 0.001
        s = 1.0           # base unit
        min = 60.0
        hr = 3600.0

    unit mass(base: f64):
        mg = 0.000001
        g = 0.001
        kg = 1.0          # base unit
        lb = 0.453592
    pass

## Test: Unit Types and Literal Suffixes

it "unit_types_and_literal_suffixes_6":
    """
    Unit Types and Literal Suffixes
    """
    val distance = 100_km         # length type, stored as 100000.0 (meters)
    val duration = 2_hr           # time type, stored as 7200.0 (seconds)
    val weight = 5_kg             # mass type, stored as 5.0 (kg)

    # Access value in specific unit
    distance.as_km()              # 100.0
    distance.as_m()               # 100000.0
    distance.as_mile()            # 62.137...

    # Operations within same family (auto-converts)
    val total = 1_km + 500_m      # 1500_m (stored as 1500.0)

    # Comparisons work across units
    1_km == 1000_m                # true
    pass

## Test: Unit Types and Literal Suffixes

it "unit_types_and_literal_suffixes_7":
    """
    Unit Types and Literal Suffixes
    """
    # @skip - unit syntax not implemented yet
    # unit velocity(base: f64) = length / time:
    #     mps = 1.0         # meters per second (base)
    #     kmph = 0.277778   # km/hr in m/s
    #     mph = 0.44704     # miles/hr in m/s
    # unit area(base: f64) = length * length:
    #     sqmm = 0.000001
    #     sqcm = 0.0001
    #     sqm = 1.0         # base
    #     sqkm = 1000000.0
    ()

    unit force(base: f64) = mass * acceleration:
        N = 1.0           # Newton (base)
        kN = 1000.0
    pass

## Test: Unit Types and Literal Suffixes

it "unit_types_and_literal_suffixes_8":
    """
    Unit Types and Literal Suffixes
    """
    val distance = 100_km
    val duration = 2_hr

    # Compiler infers: length / time = velocity
    val speed = distance / duration    # velocity type, 50_kmph

    # Compiler infers: velocity * time = length
    val new_dist = speed * 3_hr        # length type, 150_km
    pass

## Test: Unit Types and Literal Suffixes

it "unit_types_and_literal_suffixes_9":
    """
    Unit Types and Literal Suffixes
    """
    # Syntax: unit Name: BaseType as suffix [= factor]
    unit UserId: i64 as uid
    unit Percentage: f64 as pct = 0.01        # 50_pct = 0.5 internally
    unit Celsius: f64 as c
    unit Fahrenheit: f64 as f

    # Usage
    val user = 42_uid
    val discount = 20_pct                      # stored as 0.2
    val temp = 25_c
    pass

## Test: Unit Types and Literal Suffixes

it "unit_types_and_literal_suffixes_10":
    """
    Unit Types and Literal Suffixes
    """
    val distance = 100_km
    val duration = 2_hr

    # ERROR: different unit families
    val bad = distance + duration    # Compile error: length + time

    # OK: same family
    val ok = 1_km + 500_m            # OK: both length
    pass

## Test: Primitive Type Warnings (Public APIs)

# WARNING: Bare primitives in public API
pub fn get_user_id() -> i64:           # Warning: use unit type
    return 42

pub fn set_active(active: bool):       # Warning: use enum
    ...

pub class User:
    pub id: i64                        # Warning: use unit type
    pub age: i32                       # Warning: use unit type

# RECOMMENDED: Use semantic types (no warnings)
unit UserId: i64 as uid
unit Age: i32 as age

enum UserStatus:
    Active
    Inactive
    Suspended

pub fn get_user_id() -> UserId:        # OK - no warning
    return 42_uid

pub fn set_status(status: UserStatus): # OK - no warning
    ...

pub class User:
    pub id: UserId                     # OK
    pub name: str                      # OK (str is allowed)
    pub age: Age                       # OK
    pub status: UserStatus             # OK

## Test: Primitive Type Warnings (Public APIs)

# WARNING: What does true/false mean?
pub fn configure(enabled: bool, visible: bool):  # Warning
    ...

# GOOD: Clear meaning (no warning)
enum Enabled:
    Yes
    No

enum Visibility:
    Visible
    Hidden

pub fn configure(enabled: Enabled, visibility: Visibility):  # OK
    ...

# Call site is now self-documenting
configure(Enabled.Yes, Visibility.Hidden)

## Test: Primitive Type Warnings (Public APIs)

# ERROR: Implicit nullable return (always an error)
pub fn find_user(id: UserId) -> User:  # Compile ERROR if can return nil
    ...

# CORRECT: Explicit Option
pub fn find_user(id: UserId) -> Option<User>:
    match lookup(id):
        case found: Some(found)
        case _: None

## Test: Primitive Type Warnings (Public APIs)

# OK: private function - no warning
fn internal_calc(a: i64, b: i64) -> i64:
    return a + b

# Public wrapper uses semantic types
pub fn calculate_total(price: Price, quantity: Quantity) -> Total:
    val raw = internal_calc(price.raw(), quantity.raw())
    return Total.from_raw(raw)

## Test: Primitive Type Warnings (Public APIs)

# Directory-level (in __init__.spl)
#[deny(primitive_api)]
mod my_strict_module

# Item-level - suppress warning
#[allow(primitive_api)]
pub fn read_raw_bytes(count: i32) -> [u8]:
    ...

# Item-level - treat as error
#[deny(primitive_api)]
pub fn strict_function(id: i64):  # Now a compile ERROR
    ...

## Test: Primitive Type Warnings (Public APIs)

it "primitive_type_warnings_public_apis_16":
    """
    Primitive Type Warnings (Public APIs)
    """
    # std/__init__.spl
    #[deny(primitive_api)]
    mod std

    pub mod core
    pub mod collections
    # ... all child modules inherit the deny setting
    pass

## Test: Type Inference

it "type_inference_17":
    """
    Type Inference
    """
    # Type inferred as Point (immutable)
    val p = Point(3, 4)
    # p.x = 5          # Error: Point is immutable

    # Type inferred as Cursor (mutable)
    val cur = Cursor(0, 0)
    cur.x = 5           # OK: Cursor is mutable
    pass

