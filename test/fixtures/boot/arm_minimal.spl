# Minimal ARM Cortex-M Kernel for Testing
#
# This is a simple test kernel that:
# 1. Boots via reset handler
# 2. Writes "ARM started" to UART (QEMU serial)
# 3. Halts

use baremetal.arm.startup.{STACK_TOP, enable_interrupts}

# UART0 base address (LM3S6965)
val UART0_BASE: u32 = 0x4000C000

# UART registers
val UART_DR: u32 = UART0_BASE + 0x00    # Data Register
val UART_FR: u32 = UART0_BASE + 0x18    # Flag Register
val UART_FR_TXFF: u32 = 0x20            # Transmit FIFO Full

fn uart_putc(c: u8):
    # Write character to UART.
    unsafe:
        # Wait for transmit FIFO not full
        loop:
            val fr = @address(UART_FR as u64) @volatile val: u32
            if (fr & UART_FR_TXFF) == 0:
                break

        # Write character
        val dr = @address(UART_DR as u64) @volatile var: u32
        dr = c as u32

fn uart_puts(s: text):
    # Write string to UART.
    for c in s:
        uart_putc(c as u8)

fn halt():
    # Halt forever.
    loop:
        unsafe:
            asm volatile:
                "wfi"  # Wait for interrupt

# Main entry point (called by reset handler)
fn main():
    # Minimal test kernel.
    # UART is already initialized by QEMU

    # Write test message
    uart_puts("ARM started\r\n")

    # Halt
    halt()
