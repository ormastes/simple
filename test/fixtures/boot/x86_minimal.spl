# Minimal x86 Multiboot Kernel for Testing
#
# This is a simple test kernel that:
# 1. Boots via Multiboot
# 2. Writes "Hello x86!" to VGA buffer
# 3. Exits via QEMU debug-exit device

use baremetal.x86.boot_impl.{MULTIBOOT_MAGIC, STACK_SIZE, vga_write_string, vga_clear}

# QEMU debug-exit device (port 0xF4)
fn qemu_exit(code: u8):
    """Exit QEMU with status code."""
    unsafe:
        asm volatile:
            "out dx, al"
            in(dx) 0xF4 as u16
            in(al) code

fn halt():
    """Halt CPU forever."""
    unsafe:
        asm volatile:
            "cli"
            ".Lhalt:"
            "hlt"
            "jmp .Lhalt"

# Kernel entry point (called by boot code)
fn kernel_main():
    """Minimal test kernel."""
    # Clear screen
    vga_clear()

    # Write test message
    vga_write_string(0, 0, "Hello x86!", 0x0F)  # White on black

    # Exit successfully
    qemu_exit(0)  # Encoded as exit code 1

    # Should never reach here
    halt()
