# ExecutionManager SSpec Tests
#
# Tests the Simple-side ExecutionManager interface for JIT execution.

use compiler.execution.mod (LocalExecutionManager, set_jit_backend, get_jit_backend)

describe "ExecutionManager":

    describe "LocalExecutionManager":

        it "creates with auto backend":
            val em = LocalExecutionManager.auto()
            val name = em.backend_name()
            assert name == "cranelift-jit" or name == "llvm-jit",
                "Expected cranelift-jit or llvm-jit, got: {name}"
            em.cleanup()

        it "creates with cranelift backend":
            val em = LocalExecutionManager.cranelift()
            assert em.backend_name() == "cranelift-jit",
                "Expected cranelift-jit"
            em.cleanup()

        it "reports has_function correctly":
            val em = LocalExecutionManager.auto()
            # Before compiling anything, no functions should exist
            assert not em.has_function("nonexistent"),
                "Should not have nonexistent function"
            em.cleanup()

    describe "JIT Backend Control":

        it "gets default backend name":
            val name = get_jit_backend()
            # Should return a valid backend name
            assert name.len() > 0, "Backend name should not be empty"

        it "sets and gets backend":
            val original = get_jit_backend()
            set_jit_backend("cranelift")
            val current = get_jit_backend()
            assert current == "cranelift" or current == "cranelift-jit",
                "Expected cranelift after setting, got: {current}"
            # Restore
            set_jit_backend(original)

    describe "Backend switching":

        it "produces same results across backends":
            # Both Cranelift JIT should give consistent results
            val em1 = LocalExecutionManager.cranelift()
            val em2 = LocalExecutionManager.auto()

            val name1 = em1.backend_name()
            val name2 = em2.backend_name()

            # Both should be valid JIT backend names
            assert name1 == "cranelift-jit" or name1 == "llvm-jit",
                "em1 has invalid backend: {name1}"
            assert name2 == "cranelift-jit" or name2 == "llvm-jit",
                "em2 has invalid backend: {name2}"

            em1.cleanup()
            em2.cleanup()
