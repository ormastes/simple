"""
# MIR Instruction Coverage - Complete Test Suite

**Feature IDs:** #930-960
**Category:** Backend Testing
**Status:** Complete

Tests all 80+ MIR instruction builder methods.
"""

use sspec.{describe, it, expect, context}
use compiler.backend.mir_test_builder_full.{
    MirTestBuilder, MirTestInst, VReg, BlockId, BackendTarget,
    new_builder, simple_arithmetic, simd_reduction, gpu_kernel
}

describe "MIR Instructions - Constants":
    it "generates const int":
        val b = new_builder("test")
        b.add_const_int(0, 42)
        val tc = b.build()
        expect tc.instructions.len() == 1

    it "generates const float":
        val b = new_builder("test")
        b.add_const_float(0, 3.14)
        val tc = b.build()
        expect tc.instructions.len() == 1

    it "generates const bool":
        val b = new_builder("test")
        b.add_const_bool(0, true)
        val tc = b.build()
        expect tc.instructions.len() == 1

describe "MIR Instructions - Arithmetic":
    it "generates add instruction":
        val b = new_builder("test")
        b.add_const_int(0, 10)
        b.add_const_int(1, 20)
        b.add_add(2, 0, 1)
        val tc = b.build()
        expect tc.instructions.len() == 3

    it "generates mul instruction":
        val b = new_builder("test")
        b.add_const_int(0, 5)
        b.add_const_int(1, 6)
        b.add_mul(2, 0, 1)
        val tc = b.build()
        expect tc.instructions.len() == 3

describe "MIR Instructions - Control Flow":
    it "generates ret instruction":
        val b = new_builder("test")
        b.add_const_int(0, 42)
        b.add_ret(0)
        val tc = b.build()
        expect tc.instructions.len() == 2

    it "generates ret void":
        val b = new_builder("test")
        b.add_ret_void()
        val tc = b.build()
        expect tc.instructions.len() == 1

    it "generates branch instruction":
        val b = new_builder("test")
        b.add_const_bool(0, true)
        b.add_branch(0, 1, 2)
        val tc = b.build()
        expect tc.instructions.len() == 2

describe "MIR Instructions - SIMD":
    it "generates vec sum":
        val b = new_builder("test")
        b.add_const_int(0, 0)
        b.add_vec_sum(1, 0)
        val tc = b.build()
        expect tc.instructions.len() == 2

describe "MIR Instructions - GPU":
    it "generates gpu global id":
        val b = new_builder("test")
        b.add_gpu_global_id(0, 0)
        val tc = b.build()
        expect tc.instructions.len() == 1

describe "MIR Builder - Register Tracking":
    it "tracks next vreg correctly":
        val b = new_builder("test")
        expect b.next_vreg == 0
        b.add_const_int(5, 100)
        expect b.next_vreg == 6

    it "handles non-sequential vregs":
        val b = new_builder("test")
        b.add_const_int(10, 1)
        b.add_const_int(2, 2)
        b.add_const_int(20, 3)
        expect b.next_vreg == 21

describe "MIR Builder - Backend Selection":
    it "defaults to multiple backends":
        val b = new_builder("test")
        val tc = b.build()
        expect tc.expected_backends.len() >= 3

    it "restricts to single backend":
        val b = new_builder("test")
        b.only_backend(BackendTarget.Interpreter)
        val tc = b.build()
        expect tc.expected_backends.len() == 1

    it "supports multiple specific backends":
        val b = new_builder("test")
        b.only_backends([BackendTarget.Cranelift, BackendTarget.LLVM])
        val tc = b.build()
        expect tc.expected_backends.len() == 2

describe "MIR Builder - Test Patterns":
    it "simple arithmetic pattern works":
        val tc = simple_arithmetic()
        expect tc.name == "simple_arithmetic"
        expect tc.instructions.len() == 4

    it "simd reduction pattern works":
        val tc = simd_reduction()
        expect tc.name == "simd_reduction"
        expect tc.expected_backends.len() == 2

    it "gpu kernel pattern works":
        val tc = gpu_kernel()
        expect tc.name == "gpu_kernel"
        expect tc.expected_backends.len() == 1
