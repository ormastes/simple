# LLVM Backend Differential Testing
#
# Compares LLVM backend output with Cranelift and Interpreter.
# Ensures all backends produce the same results for identical inputs.

use std.spec

# ============================================================================
# Arithmetic Operation Tests
# ============================================================================

describe "Differential Testing - Arithmetic":
    context "integer addition":
        it "computes 2 + 3 correctly":
            val a = 2
            val b = 3
            val result = a + b
            expect(result).to_equal(5)

        it "computes large numbers":
            val a = 1000000
            val b = 2000000
            val result = a + b
            expect(result).to_equal(3000000)

        it "handles negative numbers":
            val a = -5
            val b = 3
            val result = a + b
            expect(result).to_equal(-2)

    context "integer subtraction":
        it "computes 10 - 4 correctly":
            val a = 10
            val b = 4
            val result = a - b
            expect(result).to_equal(6)

        it "handles negative results":
            val a = 3
            val b = 7
            val result = a - b
            expect(result).to_equal(-4)

    context "integer multiplication":
        it "computes 6 * 7 correctly":
            val a = 6
            val b = 7
            val result = a * b
            expect(result).to_equal(42)

        it "handles zero":
            val a = 100
            val b = 0
            val result = a * b
            expect(result).to_equal(0)

    context "integer division":
        it "computes 20 / 4 correctly":
            val a = 20
            val b = 4
            val result = a / b
            expect(result).to_equal(5)

        it "truncates toward zero":
            val a = 7
            val b = 2
            val result = a / b
            expect(result).to_equal(3)

    context "modulo operation":
        it "computes 10 % 3 correctly":
            val a = 10
            val b = 3
            val result = a % b
            expect(result).to_equal(1)

    context "negation":
        it "negates positive number":
            val a = 42
            val result = -a
            expect(result).to_equal(-42)

        it "negates negative number":
            val a = -17
            val result = -a
            expect(result).to_equal(17)

# ============================================================================
# Bitwise Operation Tests
# ============================================================================

describe "Differential Testing - Bitwise":
    context "bitwise AND":
        it "computes 12 & 10 correctly":
            val a = 12  # 1100
            val b = 10  # 1010
            val result = a & b  # 1000 = 8
            expect(result).to_equal(8)

    context "bitwise OR":
        it "computes 12 | 10 correctly":
            val a = 12  # 1100
            val b = 10  # 1010
            val result = a | b  # 1110 = 14
            expect(result).to_equal(14)

    context "bitwise XOR":
        it "computes 12 ^ 10 correctly":
            val a = 12  # 1100
            val b = 10  # 1010
            val result = a ^ b  # 0110 = 6
            expect(result).to_equal(6)

    context "left shift":
        it "computes 5 << 2 correctly":
            val a = 5  # 101
            val result = a << 2  # 10100 = 20
            expect(result).to_equal(20)

    context "right shift":
        it "computes 20 >> 2 correctly":
            val a = 20  # 10100
            val result = a >> 2  # 101 = 5
            expect(result).to_equal(5)

    context "bitwise NOT":
        it "computes ~0 correctly":
            val a = 0
            val result = ~a
            expect(result).to_equal(-1)

# ============================================================================
# Comparison Operation Tests
# ============================================================================

describe "Differential Testing - Comparisons":
    context "equality":
        it "compares equal numbers":
            val a = 42
            val b = 42
            val result = a == b
            expect(result).to_equal(true)

        it "compares unequal numbers":
            val a = 10
            val b = 20
            val result = a == b
            expect(result).to_equal(false)

    context "inequality":
        it "compares different numbers":
            val a = 5
            val b = 10
            val result = a != b
            expect(result).to_equal(true)

    context "less than":
        it "compares smaller to larger":
            val a = 5
            val b = 10
            val result = a < b
            expect(result).to_equal(true)

        it "compares larger to smaller":
            val a = 10
            val b = 5
            val result = a < b
            expect(result).to_equal(false)

    context "less than or equal":
        it "compares equal numbers":
            val a = 10
            val b = 10
            val result = a <= b
            expect(result).to_equal(true)

        it "compares smaller to larger":
            val a = 5
            val b = 10
            val result = a <= b
            expect(result).to_equal(true)

    context "greater than":
        it "compares larger to smaller":
            val a = 15
            val b = 10
            val result = a > b
            expect(result).to_equal(true)

    context "greater than or equal":
        it "compares equal numbers":
            val a = 10
            val b = 10
            val result = a >= b
            expect(result).to_equal(true)

# ============================================================================
# Control Flow Tests
# ============================================================================

describe "Differential Testing - Control Flow":
    context "if statements":
        it "executes then branch":
            var result = 0
            if 5 > 3:
                result = 1
            else:
                result = 2
            expect(result).to_equal(1)

        it "executes else branch":
            var result = 0
            if 3 > 5:
                result = 1
            else:
                result = 2
            expect(result).to_equal(2)

    context "loops":
        it "executes for loop":
            var sum = 0
            for i in 0..5:
                sum = sum + i
            expect(sum).to_equal(10)  # 0+1+2+3+4 = 10

        it "executes while loop":
            var count = 0
            var i = 0
            while i < 5:
                count = count + 1
                i = i + 1
            expect(count).to_equal(5)

# ============================================================================
# Function Call Tests
# ============================================================================

describe "Differential Testing - Functions":
    context "simple functions":
        it "calls function with no parameters":
            fn get_value() -> i64:
                42
            val result = get_value()
            expect(result).to_equal(42)

        it "calls function with parameters":
            fn add(a: i64, b: i64) -> i64:
                a + b
            val result = add(10, 20)
            expect(result).to_equal(30)

        it "calls function multiple times":
            fn square(x: i64) -> i64:
                x * x
            val r1 = square(3)
            val r2 = square(4)
            expect(r1).to_equal(9)
            expect(r2).to_equal(16)

    context "recursive functions":
        it "computes factorial":
            fn factorial(n: i64) -> i64:
                if n <= 1:
                    1
                else:
                    n * factorial(n - 1)
            val result = factorial(5)
            expect(result).to_equal(120)

# ============================================================================
# Variable and Assignment Tests
# ============================================================================

describe "Differential Testing - Variables":
    context "immutable variables":
        it "reads immutable variable":
            val x = 10
            val y = x + 5
            expect(y).to_equal(15)

    context "mutable variables":
        it "updates mutable variable":
            var x = 10
            x = x + 5
            expect(x).to_equal(15)

        it "updates multiple times":
            var x = 1
            x = x + 1
            x = x + 1
            x = x + 1
            expect(x).to_equal(4)

# ============================================================================
# Boolean Logic Tests
# ============================================================================

describe "Differential Testing - Boolean Logic":
    context "logical AND":
        it "computes true && true":
            val result = true and true
            expect(result).to_equal(true)

        it "computes true && false":
            val result = true and false
            expect(result).to_equal(false)

    context "logical OR":
        it "computes false || true":
            val result = false or true
            expect(result).to_equal(true)

        it "computes false || false":
            val result = false or false
            expect(result).to_equal(false)

    context "logical NOT":
        it "computes !true":
            val result = not true
            expect(result).to_equal(false)

        it "computes !false":
            val result = not false
            expect(result).to_equal(true)

# ============================================================================
# Complex Expression Tests
# ============================================================================

describe "Differential Testing - Complex Expressions":
    context "nested arithmetic":
        it "evaluates (2 + 3) * (4 + 5)":
            val result = (2 + 3) * (4 + 5)
            expect(result).to_equal(45)

        it "respects operator precedence":
            val result = 2 + 3 * 4
            expect(result).to_equal(14)

    context "mixed operations":
        it "combines arithmetic and bitwise":
            val result = (5 + 3) & 7
            expect(result).to_equal(0)

        it "combines comparisons and logic":
            val result = (5 > 3) and (10 < 20)
            expect(result).to_equal(true)

# ============================================================================
# Edge Case Tests
# ============================================================================

describe "Differential Testing - Edge Cases":
    context "zero values":
        it "handles zero in addition":
            val result = 0 + 0
            expect(result).to_equal(0)

        it "handles zero in multiplication":
            val result = 100 * 0
            expect(result).to_equal(0)

    context "boundary values":
        it "handles small positive number":
            val result = 1 + 1
            expect(result).to_equal(2)

        it "handles negative numbers":
            val result = -10 + 5
            expect(result).to_equal(-5)

# ============================================================================
# Type Conversion Tests
# ============================================================================

describe "Differential Testing - Type Conversions":
    context "integer types":
        it "works with i64":
            val x: i64 = 100
            val result = x + 50
            expect(result).to_equal(150)

# ============================================================================
# Aggregate Tests
# ============================================================================

describe "Differential Testing - Aggregates":
    context "tuples":
        it "creates and accesses tuple":
            val pair = (10, 20)
            val a = pair.0
            val b = pair.1
            expect(a).to_equal(10)
            expect(b).to_equal(20)

# ============================================================================
# String Tests (if supported)
# ============================================================================

describe "Differential Testing - Strings":
    context "string operations":
        it "works with string literals":
            val s = "hello"
            expect(s.len()).to_equal(5)

# ============================================================================
# Summary Test
# ============================================================================

describe "Differential Testing - Summary":
    context "comprehensive smoke test":
        it "runs comprehensive computation":
            # This test combines multiple operations
            var result = 0

            # Arithmetic
            result = result + (10 + 5)  # 15
            result = result * 2          # 30

            # Bitwise
            result = result | 1          # 31

            # Comparison and branching
            if result > 20:
                result = result - 1      # 30

            # Loop
            for i in 0..3:
                result = result + 1      # 33

            expect(result).to_equal(33)
