# @skip - demonstrates parser bug with inline match case arrays
# Parser Bug: Match case returning empty array []
#
# This test demonstrates a parser bug where match cases that return
# empty arrays directly cause a parse error during module loading.
#
# Error: "Unexpected token: expected identifier, found RBracket"
#
# Status: KNOWN BUG
# Impact: Blocks loop_opt.spl from loading (4 test failures)
# Workaround: Assign [] to variable first, then return variable

use std.test.{describe, it, expect}

# ============================================================================
# Bug Reproduction: Direct [] return in match
# ============================================================================

enum TestEnum:
    Empty
    Single(i64)
    Multiple(i64, i64)

describe "Match Empty Array Bug":
    it "reproduces parser error with direct [] return":
        # This pattern causes parse error during module loading:
        # fn get_items(value: TestEnum) -> [i64]:
        #     match value:
        #         case Empty: []        <- PARSE ERROR
        #         case Single(x): [x]
        #         case Multiple(x, y): [x, y]

        # Workaround: Assign to variable first
        fn get_items_workaround(value: TestEnum) -> [i64]:
            match value:
                case Empty:
                    val empty: [i64] = []
                    empty
                case Single(x):
                    [x]
                case Multiple(x, y):
                    [x, y]

        val result = get_items_workaround(TestEnum.Empty)
        expect result.len() == 0

    it "works with non-empty array literal":
        fn get_items(value: TestEnum) -> [i64]:
            match value:
                case Empty:
                    [0]        # Non-empty works fine
                case Single(x):
                    [x]
                case Multiple(x, y):
                    [x, y]

        val result = get_items(TestEnum.Empty)
        expect result.len() == 1

    it "works when assigning to variable first":
        fn get_items(value: TestEnum) -> [i64]:
            val result = match value:
                case Empty:
                    val empty: [i64] = []
                    empty
                case Single(x): [x]
                case Multiple(x, y): [x, y]
            result

        val items = get_items(TestEnum.Empty)
        expect items.len() == 0

# ============================================================================
# Similar Patterns That Might Fail
# ============================================================================

describe "Related Patterns":
    it "direct nil return works":
        fn get_optional(flag: bool) -> i64?:
            match flag:
                case true: Some(42)
                case false: nil    # nil works fine

        val result = get_optional(false)
        expect not result.?

    it "direct empty string works":
        fn get_text(flag: bool) -> text:
            match flag:
                case true: "hello"
                case false: ""     # Empty string works fine

        val result = get_text(false)
        expect result.len() == 0

    it "direct empty dict might fail":
        # This might also fail - needs testing
        fn get_dict(flag: bool) -> Dict<text, i64>:
            match flag:
                case true: {"key": 42}
                case false:
                    val empty: Dict<text, i64> = {}
                    empty  # Using workaround

        val result = get_dict(false)
        expect result.len() == 0

# ============================================================================
# Bug Impact Analysis
# ============================================================================

describe "Bug Impact":
    it "affects function returning arrays":
        # Pattern used in loop_opt.spl:142-160
        # fn get_successors(term: MirTerminator) -> [BlockId]:
        #     match term:
        #         case Return(_): []      <- BLOCKS MODULE LOADING
        #         case Unreachable: []    <- BLOCKS MODULE LOADING
        #         case _: []              <- BLOCKS MODULE LOADING

        expect true  # Documenting the issue

    it "workaround adds 2 extra lines per empty case":
        # Instead of:
        #   case Empty: []
        #
        # Need:
        #   case Empty:
        #       val empty: [T] = []
        #       empty

        expect true  # Documenting workaround cost

# ============================================================================
# Expected Behavior
# ============================================================================

describe "Expected Behavior":
    it "should allow direct [] return like other literals":
        # These all work:
        # case X: 42           # Direct integer literal
        # case X: "text"       # Direct string literal
        # case X: true         # Direct boolean literal
        # case X: [1, 2, 3]    # Non-empty array literal
        #
        # This should also work:
        # case X: []           # Empty array literal <- BUG

        expect true  # Documenting expected behavior

# ============================================================================
# Bug Report Summary
# ============================================================================
#
# Title: Parser fails on match case returning empty array literal []
#
# Description:
# When a match case directly returns an empty array literal [], the parser
# throws an error during module loading (not during direct file parsing).
#
# Error Message:
# "Unexpected token: expected identifier, found RBracket"
#
# Reproduction:
# fn foo(x: SomeEnum) -> [T]:
#     match x:
#         case Variant: []    # <- Parse error
#
# Workaround:
# fn foo(x: SomeEnum) -> [T]:
#     match x:
#         case Variant:
#             val empty: [T] = []
#             empty           # <- Works
#
# Impact:
# - Blocks loop_opt.spl module from loading (3 instances)
# - Causes 4 test failures in MIR optimization suite
# - Requires 2 extra lines per empty case (verbosity)
#
# Files Affected:
# - src/compiler/mir_opt/loop_opt.spl:145, 146, 160
#
# Related Patterns:
# - nil return: WORKS
# - "" return: WORKS
# - {} return: UNKNOWN (needs testing)
# - [] return: FAILS (this bug)
#
# Priority: HIGH (blocks production code)
# ============================================================================
