# DI Constructor Injection Validation Specification
#
# Tests for dependency injection validation rules

use compiler.di_validator.*

describe "Constructor Injection Validation":
    it "accepts all params with @inject":
        val ctor = ConstructorInfo.create(
            "UserService",
            has_sys_inject: false,
            params: [
                ParamInfo.create("db", "Database", true),
                ParamInfo.create("cache", "Cache", true)
            ]
        )
        val result = validate_constructor(ctor)
        expect result.is_ok()

    it "accepts no params with @inject":
        val ctor = ConstructorInfo.create(
            "Config",
            has_sys_inject: false,
            params: [
                ParamInfo.create("name", "text", false),
                ParamInfo.create("value", "i64", false)
            ]
        )
        val result = validate_constructor(ctor)
        expect result.is_ok()

    it "accepts @sys.inject on class":
        val ctor = ConstructorInfo.create(
            "OrderService",
            has_sys_inject: true,
            params: [
                ParamInfo.create("repo", "OrderRepository", false),
                ParamInfo.create("payment", "PaymentService", false)
            ]
        )
        val result = validate_constructor(ctor)
        expect result.is_ok()

    it "rejects mixed injection":
        val ctor = ConstructorInfo.create(
            "UserService",
            has_sys_inject: false,
            params: [
                ParamInfo.create("db", "Database", true),
                ParamInfo.create("config", "Config", false)
            ]
        )
        val result = validate_constructor(ctor)
        expect result.is_err()
        val error = result.unwrap_err()
        expect error.kind == DiErrorKind.MixedInjection

    it "rejects mixing @sys.inject with @inject":
        val ctor = ConstructorInfo.create(
            "PaymentService",
            has_sys_inject: true,
            params: [
                ParamInfo.create("gateway", "Gateway", true),
                ParamInfo.create("logger", "Logger", false)
            ]
        )
        val result = validate_constructor(ctor)
        expect result.is_err()
        val error = result.unwrap_err()
        expect error.kind == DiErrorKind.MixedAnnotations
