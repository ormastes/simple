# AOP Proceed Enforcement Specification
#
# Tests for around advice proceed() enforcement

use compiler.aop_proceed.*

describe "Proceed Enforcement":
    it "tracks initial state":
        val ctx = ProceedContext.create("test")
        expect not ctx.was_called()
        expect ctx.call_count() == 0
        expect not ctx.has_error

    it "tracks after proceed called":
        var ctx = ProceedContext.create("test")
        ctx.mark_proceed_called()
        expect ctx.was_called()
        expect ctx.call_count() == 1

    it "tracks multiple proceed calls":
        var ctx = ProceedContext.create("test")
        ctx.mark_proceed_called()
        ctx.mark_proceed_called()
        ctx.mark_proceed_called()
        expect ctx.call_count() == 3

    it "verifies single proceed call succeeds":
        var ctx = ProceedContext.create("test")
        ctx.mark_proceed_called()
        val result = ctx.verify()
        expect result.is_ok()

    it "verifies never called fails":
        val ctx = ProceedContext.create("test")
        val result = ctx.verify()
        expect result.is_err()

    it "verifies multiple calls fails":
        var ctx = ProceedContext.create("test")
        ctx.mark_proceed_called()
        ctx.mark_proceed_called()
        val result = ctx.verify()
        expect result.is_err()
