# Easy API Tests - Minimal Block Creation
#
# Tests for compiler.blocks.easy module
# Tier 1 API: block(), block_with_validation(), const_block()

use std.spec.*
use compiler.blocks.easy.{block, block_with_validation, const_block}
use compiler.blocks.value.{BlockValue}
use compiler.blocks.modes.{LexerMode}
use compiler.blocks.context.{BlockContext}
use compiler.blocks.registry.{register_block, unregister_block, with_block, is_block_registered}
use compiler.blocks.definition.{ConstValue}

describe "Easy API - block()":
    context "basic block creation":
        it "creates simple block with raw text mode":
            val heredoc = block("heredoc", LexerMode.Raw, \text:
                Ok(BlockValue.Raw(text.trim()))
            )

            # Test that block definition is created
            expect heredoc.kind() == "heredoc"
            expect heredoc.lexer_mode().is_raw()

describe "Easy API - block_with_validation()":
    context "validation hooks":
        it "creates block with validation hook":
            val validated = block_with_validation("validated", LexerMode.Raw,
                \text:
                    Ok(BlockValue.Custom("Number", 42))
                ,
                \value:
                    []
            )

            val ctx = BlockContext.test("")
            val valid = BlockValue.Custom("Number", 42)
            val errors1 = validated.validate(valid, ctx)
            expect errors1.len() == 0

describe "Easy API - const_block()":
    context "compile-time evaluation":
        it "creates block with compile-time evaluation":
            val const_re = const_block("const_re", LexerMode.Raw,
                \pattern:
                    Ok(BlockValue.Raw(pattern))
                ,
                \value:
                    Some(ConstValue.String("test"))
            )

            val result = const_re.eval_const(BlockValue.Raw("test"))
            expect result.?
