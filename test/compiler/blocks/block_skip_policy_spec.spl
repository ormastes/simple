import std.spec

describe "BlockSkipPolicy - TreeSitter Integration":
    context "fast_mode = true":
        it "skips Skippable blocks entirely":
            val ts = TreeSitter.with_fast_mode(true)
            val source = "val x = sh{ echo hello }"
            val ts2 = ts.with_source(source)
            val outline = ts2.parse_outline()
            val block = outline.inline_blocks[0]
            expect(block.outline_info.?).to(be_true())
            expect(block.outline_info.unwrap().is_opaque).to(be_true())

        it "runs treesitter_outline for OutlineRequired blocks":
            val ts = TreeSitter.with_fast_mode(true)
            val source = "val x = m{ x^2 + y^2 }"
            val ts2 = ts.with_source(source)
            val outline = ts2.parse_outline()
            val block = outline.inline_blocks[0]
            expect(block.outline_info.?).to(be_true())
            expect(block.outline_info.unwrap().is_opaque).to(be_false())
            expect(block.outline_info.unwrap().identifiers).to(contain("x"))

    context "fast_mode = false":
        it "runs treesitter_outline for all blocks":
            val ts = TreeSitter.with_fast_mode(false)
            val source = "val x = sql{ SELECT name FROM users }"
            val ts2 = ts.with_source(source)
            val outline = ts2.parse_outline()
            val block = outline.inline_blocks[0]
            # SQL block uses default treesitter_outline which returns opaque
            expect(block.outline_info.?).to(be_true())
