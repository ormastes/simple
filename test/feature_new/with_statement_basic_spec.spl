#!/usr/bin/env simple
# Test basic with statement functionality

use std.spec

describe "with statement":
    it "calls enter and cleanup on simple context manager":
        # Define a simple context manager
        class TestContext:
            entered: bool
            cleaned: bool

            fn enter() -> TestContext:
                self.entered = true
                self

            fn cleanup():
                self.cleaned = true

        # Create context manager
        val ctx = TestContext(entered: false, cleaned: false)

        # Use with statement
        with ctx as c:
            check c.entered

        # Check cleanup was called
        check ctx.cleaned

    it "calls cleanup even when block completes normally":
        var cleanup_called = false

        class TestContext:
            fn enter() -> TestContext:
                self

            fn cleanup():
                cleanup_called = true

        val ctx = TestContext()

        with ctx:
            val x = 42

        check cleanup_called

    it "supports variable binding with as clause":
        class ValueContext:
            value: text

            fn enter() -> text:
                self.value

            fn cleanup():
                ()

        val ctx = ValueContext(value: "hello")

        with ctx as val_:
            check val_ == "hello"

    it "supports with statement without variable binding":
        var enter_called = false
        var cleanup_called = false

        class NoBindContext:
            fn enter() -> NoBindContext:
                enter_called = true
                self

            fn cleanup():
                cleanup_called = true

        val ctx = NoBindContext()

        with ctx:
            check enter_called

        check cleanup_called
