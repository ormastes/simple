# Test Helpers for Database Synchronization Tests
#
# Utility functions for creating test data and file operations.

use db.records.*
use db.persistence.*

pub fn create_test_db(count: i64) -> TodoDb:
    """Create test TodoDb with N dummy records"""
    var db = TodoDb.new()
    for i in 0..count:
        val record = TodoRecord(
            id: "todo-{i}",
            keyword: "TODO",
            area: "test",
            priority: "P2",
            description: "Test item {i}",
            file: "test.spl",
            line: i,
            issue: nil,
            blocked: [],
            status: "open",
            valid: true
        )
        db.records[record.id] = record
    db

pub fn create_test_features(count: i64) -> FeatureDb:
    """Create test FeatureDb with N dummy records"""
    var db = FeatureDb.new()
    for i in 0..count:
        val record = FeatureRecord(
            id: "feat-{i}",
            category: "Test",
            name: "Test Feature {i}",
            description: "Test feature",
            status: "planned",
            valid: true
        )
        db.records[record.id] = record
    db

pub fn create_test_tasks(count: i64) -> TaskDb:
    """Create test TaskDb with N dummy records"""
    var db = TaskDb.new()
    for i in 0..count:
        val record = TaskRecord(
            id: "task-{i}",
            name: "Test Task {i}",
            description: "Test task",
            priority: "medium",
            status: "planned",
            valid: true
        )
        db.records[record.id] = record
    db

pub fn file_exist(path: text) -> bool:
    """Check if file exists"""
    rt_file_exists(path)

pub fn read_file(path: text) -> text:
    """Read file contents"""
    rt_file_read_text(path)

pub fn write_file(path: text, content: text) -> bool:
    """Write file contents atomically"""
    rt_file_atomic_write(path, content)

pub fn current_time_ms() -> i64:
    """Get current time in milliseconds"""
    rt_current_time_ms()

# ===== External FFI =====

extern fn rt_file_exists(path: text) -> bool
extern fn rt_file_read_text(path: text) -> text
extern fn rt_file_atomic_write(path: text, content: text) -> bool
extern fn rt_current_time_ms() -> i64
