# @deployment_coverage
# Module Loader Coverage Verification
#
# Verifies that module loader source files are exercised when the system
# tests run. The test runner executes this spec in 2 phases:
#   Phase 1 (load): registers this file as a coverage monitor
#   Phase 2 (verify): runs the it-blocks below with collected coverage data

use std.coverage.{check_coverage, CoverageResult}

describe "Module Loader Coverage":
    it "check_coverage API returns valid result for loader line coverage":
        val result = check_coverage("line", "src/core/interpreter/module_loader.spl", minimum: 0.0)
        expect(result.coverage_type).to_equal("line")
        print "  module_loader.spl line coverage: {result.actual}%  files_matched={result.files_matched}"

    it "check_coverage API returns valid result for loader branch coverage":
        val result = check_coverage("branch", "src/core/interpreter/module_loader.spl", minimum: 0.0)
        expect(result.coverage_type).to_equal("branch")
        print "  module_loader.spl branch coverage: {result.actual}%  files_matched={result.files_matched}"

    it "check_coverage API returns valid result for loader function coverage":
        val result = check_coverage("function", "src/core/interpreter/module_loader.spl", minimum: 0.0)
        expect(result.coverage_type).to_equal("function")
        print "  module_loader.spl function coverage: {result.actual}%  files_matched={result.files_matched}"

    it "check_coverage API returns valid result for wildcard loader pattern":
        val result = check_coverage("line", "src/core/interpreter/**", minimum: 0.0)
        expect(result.coverage_type).to_equal("line")
        print "  src/core/interpreter/** line coverage: {result.actual}%  files_matched={result.files_matched}"

    it "coverage_type field is preserved on error result":
        val result = check_coverage("branch", "src/core/interpreter/module_loader.spl", minimum: 0.0)
        expect(result.coverage_type).to_equal("branch")
        expect(result.pattern).to_equal("src/core/interpreter/module_loader.spl")

    it "minimum_check field is set correctly":
        val result = check_coverage("line", "src/core/interpreter/module_loader.spl", minimum: 0.0, minimum_check: true)
        expect(result.minimum_check).to_equal(true)
