# Unit tests for Optional Chaining Operators
# Tests: ?. (optional field/method access)

describe "Optional Chaining":
    context "optional field access":
        it "returns Some when value present":
            class Profile:
                bio: text

            class User:
                name: text
                profile: Option<Profile>

            val user = User(name: "Alice", profile: Some(Profile(bio: "Hello")))
            val result = user.profile?.bio
            expect result == Some("Hello")

        it "returns None when value absent":
            class Profile:
                bio: text

            class User:
                name: text
                profile: Option<Profile>

            val none_profile = None
            val user = User(name: "Bob", profile: none_profile)
            val result = user.profile?.bio
            val expected = None
            expect result == expected

    context "optional method calls":
        it "calls method when Some":
            class Container:
                value: i64

                fn get_doubled(): self.value * 2

            val opt = Some(Container(value: 21))
            val result = opt?.get_doubled()
            expect result == Some(42)

        it "returns None when None":
            class Container:
                value: i64

                fn get_doubled(): self.value * 2

            val opt = None
            val result = opt?.get_doubled()
            val expected = None
            expect result == expected

    context "combined with ??":
        it "provides fallback after optional chain":
            class Profile:
                bio: text

            class User:
                name: text
                profile: Option<Profile>

            val none_profile = None
            val user = User(name: "Bob", profile: none_profile)
            val result = user.profile?.bio ?? "No bio"
            expect result == "No bio"

        it "uses value when present":
            class Profile:
                bio: text

            class User:
                name: text
                profile: Option<Profile>

            val user = User(name: "Alice", profile: Some(Profile(bio: "Hello")))
            val result = user.profile?.bio ?? "No bio"
            expect result == "Hello"
