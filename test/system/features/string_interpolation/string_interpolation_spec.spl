"""
# String Interpolation Specification

**Feature IDs:** #INTERP-001 to #INTERP-020
**Category:** Language | Syntax
**Difficulty:** 2/5
**Status:** Implemented

## Overview

String interpolation allows embedding expressions directly in string literals
using curly braces. Simple treats interpolation as the default for regular
strings, with raw strings available when needed.

## Syntax

```simple
# Default interpolation (no special prefix needed)
val name = "Alice"
print "Hello, {name}!"          # Output: Hello, Alice!

# Expressions in braces
print "Result: {2 + 3}"         # Output: Result: 5
print "List: {[1, 2, 3]}"       # Output: List: [1, 2, 3]

# Method calls
print "Length: {text.len()}"    # Output: Length: 4

# Raw strings (no interpolation)
val regex = r"pattern: \d+"     # Backslashes not escaped, no interpolation
```

## Key Concepts

| Concept | Syntax | Escaping | Interpolation |
|---------|--------|----------|---------------|
| Default String | `"..."` | Standard | Yes |
| Raw String | `r"..."` | None | No |
| Expression | `{expr}` | Within braces | Yes |
| Escape Sequence | `\n, \t, \\` | Standard | Processed |

## Behavior

- Expressions in braces are evaluated at runtime
- Any expression can appear in braces, not just variables
- Nested braces require escaping (`{{` â†’ `{`)
- Raw strings skip interpolation and escape processing
- String interpolation produces a single string value

## Related Specifications

- [String Operations](string_operations_spec.spl) - String methods
- [Type Conversion](type_conversion_spec.spl) - Implicit to_string
"""

import std.spec


# ============================================================================
# Test Group 1: Basic String Interpolation
# ============================================================================

describe "Basic String Interpolation":
    """
    ## Basic String Interpolation

    Tests simple variable interpolation in strings.
    """

    it "interpolates variable in string":
        val name = "Alice"
        val result = "Hello, {name}!"
        expect(result).to(eq("Hello, Alice!"))

    it "interpolates multiple variables":
        val first = "John"
        val last = "Doe"
        val result = "{first} {last}"
        expect(result).to(eq("John Doe"))

    it "interpolates at start of string":
        val value = 42
        val result = "{value} is the answer"
        expect(result).to(eq("42 is the answer"))

    it "interpolates at end of string":
        val value = 42
        val result = "The answer is {value}"
        expect(result).to(eq("The answer is 42"))

    it "interpolates multiple occurrences":
        val x = 5
        val result = "{x} + {x} = {x + x}"
        expect(result).to(eq("5 + 5 = 10"))


# ============================================================================
# Test Group 2: Expression Interpolation
# ============================================================================

describe "Expression Interpolation":
    """
    ## Expression Interpolation

    Tests that arbitrary expressions can be interpolated.
    """

    it "interpolates arithmetic expression":
        val a = 10
        val b = 20
        val result = "Sum: {a + b}"
        expect(result).to(eq("Sum: 30"))

    it "interpolates multiplication expression":
        val x = 5
        val y = 3
        val result = "Product: {x * y}"
        expect(result).to(eq("Product: 15"))

    it "interpolates division expression":
        val result = "Half: {10 / 2}"
        expect(result).to(eq("Half: 5"))

    it "interpolates modulo expression":
        val result = "Remainder: {17 % 5}"
        expect(result).to(eq("Remainder: 2"))

    it "interpolates comparison expression":
        val a = 10
        val b = 20
        val result = "a < b: {a < b}"
        expect(result).to(eq("a < b: true"))

    it "interpolates boolean logic":
        val a = true
        val b = false
        val result = "a and b: {a and b}"
        expect(result).to(eq("a and b: false"))


# ============================================================================
# Test Group 3: Method Call Interpolation
# ============================================================================

describe "Method Call Interpolation":
    """
    ## Method Call Interpolation

    Tests method calls within interpolated expressions.
    """

    it "interpolates string method":
        val text = "hello"
        val result = "Upper: {text.upper()}"
        expect(result).to(eq("Upper: HELLO"))

    it "interpolates string length":
        val text = "test"
        val result = "Length: {text.len()}"
        expect(result).to(eq("Length: 4"))

    it "interpolates array length":
        val arr = [1, 2, 3, 4, 5]
        val result = "Size: {arr.len()}"
        expect(result).to(eq("Size: 5"))

    it "interpolates list method chain":
        val arr = [1, 2, 3]
        val result = "First: {arr.first()}"
        expect(result).to(eq("First: 1"))


# ============================================================================
# Test Group 4: Type Conversion in Interpolation
# ============================================================================

describe "Type Conversion in Interpolation":
    """
    ## Type Conversion in Interpolation

    Tests automatic type conversion for interpolated values.
    """

    it "converts integer to string":
        val num = 42
        val result = "Value: {num}"
        expect(result).to(eq("Value: 42"))

    it "converts boolean to string":
        val flag = true
        val result = "Flag: {flag}"
        expect(result).to(eq("Flag: true"))

    it "converts float to string":
        val pi = 3.14
        val result = "Pi: {pi}"
        expect(result).to(eq("Pi: 3.14"))

    it "converts array to string":
        val arr = [1, 2, 3]
        val result = "Array: {arr}"
        expect(result).to(eq("Array: [1, 2, 3]"))


# ============================================================================
# Test Group 5: Complex Expression Interpolation
# ============================================================================

describe "Complex Expression Interpolation":
    """
    ## Complex Expression Interpolation

    Tests complex expressions with parentheses and operators.
    """

    it "interpolates expression with parentheses":
        val a = 2
        val b = 3
        val result = "Result: {(a + b) * 2}"
        expect(result).to(eq("Result: 10"))

    it "interpolates nested arithmetic":
        val result = "Nested: {((5 + 3) * 2) - 1}"
        expect(result).to(eq("Nested: 15"))

    it "interpolates with function call and arithmetic":
        val arr = [1, 2, 3, 4, 5]
        val result = "Double length: {arr.len() * 2}"
        expect(result).to(eq("Double length: 10"))

    it "interpolates conditional expression":
        val age = 20
        val result = "Status: {if age >= 18: \"adult\" else: \"minor\"}"
        expect(result).to(eq("Status: adult"))


# ============================================================================
# Test Group 6: Raw String Literals
# ============================================================================

describe "Raw String Literals":
    """
    ## Raw String Literals

    Tests raw string syntax which skips interpolation and escape processing.
    """

    it "raw string does not interpolate variables":
        val name = "Alice"
        val result = r"Name: {name}"
        expect(result).to(eq("Name: {name}"))

    it "raw string preserves backslashes":
        val result = r"Path: C:\Users\test"
        expect(result).to(eq("Path: C:\\Users\\test"))

    it "raw string preserves escape sequences":
        val result = r"Escaped: \n \t \\"
        expect(result).to(eq("Escaped: \\n \\t \\\\"))

    it "raw string with regex pattern":
        val pattern = r"\d{3}-\d{3}-\d{4}"
        expect(pattern).to(eq("\\d{3}-\\d{3}-\\d{4}"))


# ============================================================================
# Test Group 7: Escape Sequences in Interpolation
# ============================================================================

describe "Escape Sequences in Interpolation":
    """
    ## Escape Sequences in Interpolation

    Tests escape sequences within interpolated strings.
    """

    it "handles newline escape":
        val result = "Line1\nLine2"
        expect(result).to(eq("Line1\nLine2"))

    it "handles tab escape":
        val result = "Col1\tCol2"
        expect(result).to(eq("Col1\tCol2"))

    it "handles backslash escape":
        val result = "Path: C:\\Users"
        expect(result).to(eq("Path: C:\\Users"))

    it "handles quote escape":
        val result = "Quote: \"Hello\""
        expect(result).to(eq("Quote: \"Hello\""))

    it "handles quote in interpolation":
        val text = "say"
        val result = "He said \"{text}\" clearly"
        expect(result).to(eq("He said \"say\" clearly"))


# ============================================================================
# Test Group 8: Nested Braces and Escaping
# ============================================================================

describe "Nested Braces and Escaping":
    """
    ## Nested Braces and Escaping

    Tests handling of literal braces in interpolated strings.
    """

    it "escapes literal opening brace":
        val result = "Set: {{1, 2, 3}}"
        expect(result).to(eq("Set: {1, 2, 3}"))

    it "escapes literal closing brace":
        val result = "Dict: {{{}}}"
        expect(result).to(eq("Dict: {{}}"))

    it "mixes escaped and interpolated braces":
        val count = 3
        val result = "Count: {count} items {{}}"
        expect(result).to(eq("Count: 3 items {}"))


# ============================================================================
# Test Group 9: Empty String Interpolation
# ============================================================================

describe "Empty String Interpolation":
    """
    ## Empty String Interpolation

    Tests edge cases with empty or minimal strings.
    """

    it "interpolates with empty string variable":
        val empty = ""
        val result = "Value: {empty}!"
        expect(result).to(eq("Value: !"))

    it "just interpolates one variable":
        val value = 42
        val result = "{value}"
        expect(result).to(eq("42"))

    it "interpolates expression in empty context":
        val result = "{42}"
        expect(result).to(eq("42"))


# ============================================================================
# Test Group 10: Collection Interpolation
# ============================================================================

describe "Collection Interpolation":
    """
    ## Collection Interpolation

    Tests interpolation of collections (arrays, dicts).
    """

    it "interpolates array":
        val arr = [1, 2, 3]
        val result = "Array: {arr}"
        expect(result).to(eq("Array: [1, 2, 3]"))

    it "interpolates dictionary":
        val dict = {"x": 1, "y": 2}
        val result = "Dict: {dict}"
        expect(result).to(eq("Dict: {\"x\": 1, \"y\": 2}") or eq("Dict: {\"y\": 2, \"x\": 1}"))

    it "interpolates array access":
        val arr = [10, 20, 30]
        val result = "First: {arr[0]}"
        expect(result).to(eq("First: 10"))

    it "interpolates dictionary access":
        val dict = {"name": "Alice", "age": 30}
        val result = "Name: {dict[\"name\"]}"
        expect(result).to(eq("Name: Alice"))


# ============================================================================
# Test Group 11: Optional and Null Values
# ============================================================================

describe "Optional Values in Interpolation":
    """
    ## Optional Values in Interpolation

    Tests interpolation with None/Some values.
    """

    it "interpolates Some value":
        val opt: i64? = 42
        val result = "Value: {opt}"
        expect(result).to(eq("Value: 42") or eq("Value: Some(42)"))

    it "interpolates None value":
        val opt: i64? = None
        val result = "Value: {opt}"
        expect(result).to(eq("Value: None"))


# ============================================================================
# Test Group 12: Whitespace in Expressions
# ============================================================================

describe "Whitespace in Expressions":
    """
    ## Whitespace in Expressions

    Tests that whitespace around expressions is handled correctly.
    """

    it "handles spaces in expression":
        val a = 5
        val b = 3
        val result = "Result: { a + b }"
        expect(result).to(eq("Result: 8"))

    it "handles newlines in expression":
        val a = 10
        val b = 20
        val result = "Sum: { a +
                        b }"
        expect(result).to(eq("Sum: 30"))


# ============================================================================
# Test Group 13: Format and Precision (Future)
# ============================================================================

describe "String Interpolation with Formatting":
    """
    ## String Interpolation with Formatting

    Tests format specifiers (future feature, currently basic).
    """

    it "basic float interpolation":
        val pi = 3.14159
        val result = "Pi: {pi}"
        expect(result).to(eq("Pi: 3.14159"))

    it "long decimal interpolation":
        val value = 0.123456789
        val result = "Value: {value}"
        expect(result).to(eq("Value: 0.123456789"))


# ============================================================================
# Test Group 14: Raw Strings with Interpolation Mix
# ============================================================================

describe "Raw and Interpolated Strings":
    """
    ## Raw and Interpolated Strings

    Tests switching between raw and interpolated strings.
    """

    it "interpolated string followed by raw":
        val name = "test"
        val result1 = "Name: {name}"
        val result2 = r"Pattern: \d+"
        expect(result1).to(eq("Name: test"))
        expect(result2).to(eq("Pattern: \\d+"))

    it "multiple raw strings":
        val r1 = r"Path: C:\data"
        val r2 = r"Regex: \w+\d+"
        expect(r1).to(eq("Path: C:\\data"))
        expect(r2).to(eq("Regex: \\w+\\d+"))


# ============================================================================
# Test Group 15: Practical Examples
# ============================================================================

describe "String Interpolation Practical Examples":
    """
    ## Practical Examples

    Real-world usage patterns.
    """

    it "builds user message":
        val user = "Alice"
        val count = 5
        val message = "{user} has {count} notifications"
        expect(message).to(eq("Alice has 5 notifications"))

    it "formats error message":
        val file = "config.json"
        val line = 42
        val error = "Error in {file} at line {line}"
        expect(error).to(eq("Error in config.json at line 42"))

    it "builds debug output":
        val obj_type = "Person"
        val id = 123
        val debug = "{obj_type}#{id}"
        expect(debug).to(eq("Person#123"))

    it "builds URL":
        val domain = "example.com"
        val path = "api/users"
        val url = "https://{domain}/{path}"
        expect(url).to(eq("https://example.com/api/users"))

    it "builds SQL-like query (concept)":
        val table = "users"
        val id = 42
        val query = "SELECT * FROM {table} WHERE id = {id}"
        expect(query).to(eq("SELECT * FROM users WHERE id = 42"))
