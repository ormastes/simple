"""
# TreeSitter Error Recovery Specification

**Feature IDs:** #TS-ERR-001 to #TS-ERR-020
**Category:** Infrastructure | Parser
**Status:** Implemented

Tests the error recovery system for the TreeSitter parser,
including recovery strategies, sync points, and error suppression.

## API

```simple
use std.parser.treesitter.error_recovery.{
    ErrorRecovery, RecoveryStrategy, SyncPoint, ErrorInfo
}

var recovery = ErrorRecovery.new()
val action = recover_from_error(recovery, tokens, pos, expected, context)
```
"""

use std.spec
use std.parser.treesitter.error_recovery.{
    ErrorRecovery, RecoveryStrategy, SyncPoint, ErrorInfo, ParserContext
}


# ============================================================================
# Test Group 1: ErrorRecovery Creation
# ============================================================================

describe "TreeSitter ErrorRecovery Creation":
    """
    ## Recovery State Initialization

    Tests creating and configuring error recovery state.
    """

    it "creates default error recovery":
        var recovery = ErrorRecovery.new()
        expect recovery.error_count == 0

    it "has default max errors":
        var recovery = ErrorRecovery.new()
        expect recovery.max_errors == 1000

    it "starts with empty recent errors":
        var recovery = ErrorRecovery.new()
        expect recovery.recent_errors.len() == 0

    it "starts with empty delimiter stack":
        var recovery = ErrorRecovery.new()
        expect recovery.delimiter_stack.len() == 0


# ============================================================================
# Test Group 2: Error Suppression
# ============================================================================

describe "TreeSitter Error Suppression":
    """
    ## Cascade Error Prevention

    Tests that errors close together are suppressed.
    """

    it "does not suppress first error":
        var recovery = ErrorRecovery.new()
        expect not recovery.should_suppress_error(0)

    it "suppresses error in suppression window":
        var recovery = ErrorRecovery.new()
        val error = ErrorInfo.new("test", 0, 1, 1, [], "x")
        recovery.record_error(error)
        # Error at position 5 is within window (default 10)
        expect recovery.should_suppress_error(5)

    it "does not suppress error outside window":
        var recovery = ErrorRecovery.new()
        val error = ErrorInfo.new("test", 0, 1, 1, [], "x")
        recovery.record_error(error)
        # Error at position 100 is outside window
        expect not recovery.should_suppress_error(100)


# ============================================================================
# Test Group 3: Error Recording
# ============================================================================

describe "TreeSitter Error Recording":
    """
    ## Error Tracking

    Tests recording errors for analysis and suppression.
    """

    it "records error":
        var recovery = ErrorRecovery.new()
        val error = ErrorInfo.new("Unexpected token", 10, 1, 11, [], "x")
        recovery.record_error(error)
        expect recovery.recent_errors.len() == 1

    it "increments error count":
        var recovery = ErrorRecovery.new()
        val error = ErrorInfo.new("test", 0, 1, 1, [], "x")
        recovery.record_error(error)
        expect recovery.error_count == 1

    it "tracks multiple errors":
        var recovery = ErrorRecovery.new()
        recovery.record_error(ErrorInfo.new("error1", 0, 1, 1, [], "a"))
        recovery.record_error(ErrorInfo.new("error2", 50, 2, 1, [], "b"))
        recovery.record_error(ErrorInfo.new("error3", 100, 3, 1, [], "c"))
        expect recovery.error_count == 3


# ============================================================================
# Test Group 4: Error Limit
# ============================================================================

describe "TreeSitter Error Limit":
    """
    ## Maximum Error Handling

    Tests that parsing stops after too many errors.
    """

    it "does not reach limit initially":
        var recovery = ErrorRecovery.new()
        expect not recovery.has_reached_error_limit()

    it "detects when limit reached":
        var recovery = ErrorRecovery.new()
        # Record max_errors errors
        for i in 0..1000:
            val error = ErrorInfo.new("error", i, 1, i, [], "x")
            recovery.record_error(error)
        expect recovery.has_reached_error_limit()


# ============================================================================
# Test Group 5: Delimiter Stack
# ============================================================================

describe "TreeSitter Delimiter Tracking":
    """
    ## Delimiter Balancing

    Tests tracking opening/closing delimiters.
    """

    it "pushes delimiter":
        var recovery = ErrorRecovery.new()
        recovery.push_delimiter(TokenKind.LParen)
        expect recovery.delimiter_stack.len() == 1

    it "pops delimiter":
        var recovery = ErrorRecovery.new()
        recovery.push_delimiter(TokenKind.LParen)
        val popped = recovery.pop_delimiter()
        expect popped.?

    it "returns None when stack empty":
        var recovery = ErrorRecovery.new()
        val popped = recovery.pop_delimiter()
        expect not popped.?

    it "gets expected closing delimiter":
        var recovery = ErrorRecovery.new()
        recovery.push_delimiter(TokenKind.LParen)
        val expected = recovery.expected_closing_delimiter()
        expect expected.?


# ============================================================================
# Test Group 6: Recovery Strategies
# ============================================================================

describe "TreeSitter Recovery Strategies":
    """
    ## Strategy Types

    Tests the different recovery strategy types.
    """

    context "SkipToken strategy":
        it "creates SkipToken":
            val strategy = RecoveryStrategy::SkipToken
            expect true

    context "InsertToken strategy":
        it "creates InsertToken":
            val strategy = RecoveryStrategy::InsertToken(TokenKind.Colon)
            expect true

    context "SyncToStatement strategy":
        it "creates SyncToStatement":
            val strategy = RecoveryStrategy::SyncToStatement
            expect true

    context "SyncToBlock strategy":
        it "creates SyncToBlock":
            val strategy = RecoveryStrategy::SyncToBlock
            expect true

    context "SyncToDeclaration strategy":
        it "creates SyncToDeclaration":
            val strategy = RecoveryStrategy::SyncToDeclaration
            expect true

    context "BalanceDelimiter strategy":
        it "creates BalanceDelimiter":
            val strategy = RecoveryStrategy::BalanceDelimiter(TokenKind.RParen)
            expect true

    context "PanicMode strategy":
        it "creates PanicMode":
            val strategy = RecoveryStrategy::PanicMode(SyncPoint.Newline)
            expect true


# ============================================================================
# Test Group 7: Sync Points
# ============================================================================

describe "TreeSitter Sync Points":
    """
    ## Synchronization Points

    Tests the different synchronization point types.
    """

    it "has Newline sync point":
        val sync = SyncPoint::Newline
        expect true

    it "has Indent sync point":
        val sync = SyncPoint::Indent
        expect true

    it "has Dedent sync point":
        val sync = SyncPoint::Dedent
        expect true

    it "has BlockStart sync point":
        val sync = SyncPoint::BlockStart
        expect true

    it "has BlockEnd sync point":
        val sync = SyncPoint::BlockEnd
        expect true

    it "has DeclKeyword sync point":
        val sync = SyncPoint::DeclKeyword
        expect true

    it "has CloseParen sync point":
        val sync = SyncPoint::CloseParen
        expect true

    it "has CloseBracket sync point":
        val sync = SyncPoint::CloseBracket
        expect true

    it "has CloseBrace sync point":
        val sync = SyncPoint::CloseBrace
        expect true

    it "has EndOfFile sync point":
        val sync = SyncPoint::EndOfFile
        expect true


# ============================================================================
# Test Group 8: Parser Context
# ============================================================================

describe "TreeSitter Parser Context":
    """
    ## Context Types

    Tests the different parser context types.
    """

    it "has TopLevel context":
        val ctx = ParserContext::TopLevel
        expect true

    it "has Declaration context":
        val ctx = ParserContext::Declaration
        expect true

    it "has Statement context":
        val ctx = ParserContext::Statement
        expect true

    it "has Expression context":
        val ctx = ParserContext::Expression
        expect true

    it "has Block context":
        val ctx = ParserContext::Block
        expect true

    it "has Type context":
        val ctx = ParserContext::Type
        expect true

    it "has Pattern context":
        val ctx = ParserContext::Pattern
        expect true


# ============================================================================
# Test Group 9: ErrorInfo Structure
# ============================================================================

describe "TreeSitter ErrorInfo":
    """
    ## Error Information

    Tests the error information structure.
    """

    it "creates ErrorInfo with message":
        val error = ErrorInfo.new("Unexpected token", 10, 1, 11, [], "x")
        expect error.message == "Unexpected token"

    it "creates ErrorInfo with position":
        val error = ErrorInfo.new("test", 42, 1, 1, [], "x")
        expect error.position == 42

    it "creates ErrorInfo with line":
        val error = ErrorInfo.new("test", 0, 5, 1, [], "x")
        expect error.line == 5

    it "creates ErrorInfo with column":
        val error = ErrorInfo.new("test", 0, 1, 12, [], "x")
        expect error.column == 12

    it "creates ErrorInfo with expected":
        val expected = ["identifier", "number"]
        val error = ErrorInfo.new("test", 0, 1, 1, expected, "x")
        expect error.expected.len() == 2

    it "creates ErrorInfo with found":
        val error = ErrorInfo.new("test", 0, 1, 1, [], "keyword")
        expect error.found == "keyword"


# ============================================================================
# Test Group 10: Error Node Creation
# ============================================================================

describe "TreeSitter Error Nodes":
    """
    ## ERROR Node Handling

    Tests that error nodes are created in the CST.
    """

    it "marks node as having error":
        var parser = TreeSitterParser.new("simple").unwrap()
        # Parse code that may have syntax issues
        val tree = parser.parse("val x = ").unwrap()
        val root = tree.root().unwrap()
        # Tree should still be valid (error recovery)
        expect true

    it "produces tree despite errors":
        var parser = TreeSitterParser.new("simple").unwrap()
        # Even malformed code should produce a tree
        val result = parser.parse("fn ()")
        # Should not crash
        expect true

