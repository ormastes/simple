# Unit tests for Safe Unwrap Operators
# Tests: unwrap or:, unwrap else:, unwrap or_return:

describe "Safe Unwrap Operators":
    context "unwrap or: (with default value)":
        it "returns value when Some":
            val opt = Some(42)
            val result = opt unwrap or: 0
            expect result == 42

        it "returns default when None":
            val opt = None
            val result = opt unwrap or: 0
            expect result == 0

        it "works with Result Ok":
            val res = Ok(42)
            val result = res unwrap or: 0
            expect result == 42

        it "returns default for Result Err":
            val res = Err("error")
            val result = res unwrap or: -1
            expect result == -1

        it "evaluates default expression":
            val opt = None
            val result = opt unwrap or: 10 + 5
            expect result == 15

    context "unwrap else: (with lazy default)":
        it "returns value when Some":
            val opt = Some(42)
            var called = false
            val result = opt unwrap else: \:
                called = true
                99
            expect result == 42
            expect called == false

        it "calls closure when None":
            val opt = None
            var called = false
            val result = opt unwrap else: \:
                called = true
                99
            expect result == 99
            expect called == true

        it "works with Result":
            val res = Err("error")
            val result = res unwrap else: \: 100
            expect result == 100

    context "unwrap or_return: (early return)":
        it "returns unwrapped value when Some":
            fn get_value(opt):
                val x = opt unwrap or_return:
                Some(x * 2)

            val result = get_value(Some(5))
            expect result.is_some()

        it "returns early when None":
            fn get_value_or_none(opt):
                val x = opt unwrap or_return:
                Some(x * 2)

            val none_val = None
            val result = get_value_or_none(none_val)
            expect result.is_none()

    context "null coalescing operator (??)":
        it "returns value when Some":
            val opt = Some(42)
            val result = opt ?? 0
            expect result == 42

        it "returns default when None":
            val opt = None
            val result = opt ?? 0
            expect result == 0

        it "chains multiple defaults":
            val a = None
            val b = None
            val c = Some(42)
            val result = a ?? (b ?? (c ?? 0))
            expect result == 42
