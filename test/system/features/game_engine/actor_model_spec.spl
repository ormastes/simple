# @pending
# @skip - Uses unsupported keyword: spawn
"""
# Game Engine Actor Model Specification

**Feature IDs:** #GE-003
**Category:** Stdlib
**Difficulty:** 2/5
**Status:** Implemented

## Overview
Actor model for game entities with Vec3 positions and message-passing.

## Key Concepts
| Concept | Description |
|---------|-------------|
| GameMessage | Enum of standard game messages |
| EntityActor | Actor wrapper for game entities |
| EntityManager | Manages collections of entity actors |

## Behavior
- GameMessage uses math.Vec3 for positions
- EntityActor tracks position, health, alive state
- EntityManager provides spawn, despawn, message dispatch
"""

import std.spec
use math
use game_engine.actor_model

# ============================================================================
# GameMessage
# ============================================================================

describe "GameMessage":
    it "creates spawn message with Vec3":
        val pos = math.Vec3(1.0, 2.0, 3.0)
        val msg = GameMessage.Spawn(pos)
        expect msg.is_spawn() == true

    it "creates set position message with Vec3":
        val pos = math.Vec3(10.0, 20.0, 30.0)
        val msg = GameMessage.SetPosition(pos)
        expect msg.is_set_position() == true

    it "provides message type checks":
        expect GameMessage.Update(0.016).is_update() == true
        expect GameMessage.Despawn.is_despawn() == true
        expect GameMessage.GetPosition.is_get_position() == true
        expect GameMessage.Damage(25).is_damage() == true
        expect GameMessage.Heal(10).is_heal() == true

    it "gets delta from update message":
        val msg = GameMessage.Update(0.016)
        expect msg.get_delta() == 0.016

    it "converts to string":
        val msg = GameMessage.Damage(50)
        expect msg.to_string() == "Damage(50)"

# ============================================================================
# EntityActor
# ============================================================================

describe "EntityActor":
    it "creates with default values":
        val ent = EntityActor.create(1)
        expect ent.get_entity_id() == 1
        expect ent.get_health() == 100
        expect ent.get_max_health() == 100
        expect ent.is_alive() == true
        expect ent.is_full_health() == true
        expect ent.is_dead() == false

    it "position is zero Vec3 by default":
        val ent = EntityActor.create(1)
        val pos = ent.get_position()
        expect pos.x == 0.0
        expect pos.y == 0.0
        expect pos.z == 0.0

    it "handles SetPosition message":
        var ent = EntityActor.create(1)
        val pos = math.Vec3(10.0, 20.0, 30.0)
        ent.handle_message(GameMessage.SetPosition(pos)
        val new_pos = ent.get_position()
        expect new_pos.x == 10.0
        expect new_pos.y == 20.0
        expect new_pos.z == 30.0

    it "handles Damage message":
        var ent = EntityActor.create(1)
        ent.handle_message(GameMessage.Damage(30)
        expect ent.get_health() == 70

    it "handles Heal message":
        var ent = EntityActor.create(1)
        ent.handle_message(GameMessage.Damage(50)
        ent.handle_message(GameMessage.Heal(20)
        expect ent.get_health() == 70

    it "dies when health reaches zero":
        var ent = EntityActor.create(1)
        ent.handle_message(GameMessage.Damage(100)
        expect ent.get_health() == 0
        expect ent.is_alive() == false
        expect ent.is_dead() == true

# ============================================================================
# EntityManager
# ============================================================================

describe "EntityManager":
    it "starts empty":
        val mgr = EntityManager.create()
        expect mgr.is_empty() == true
        expect mgr.entity_count() == 0
        expect mgr.get_next_id() == 1

    it "spawns entities with incrementing IDs":
        var mgr = EntityManager.create()
        val id1 = mgr.spawn_entity()
        val id2 = mgr.spawn_entity()
        expect id1 == 1
        expect id2 == 2
        expect mgr.entity_count() == 2
        expect mgr.has_entities() == true

    it "checks entity existence":
        var mgr = EntityManager.create()
        val id = mgr.spawn_entity()
        expect mgr.has_entity(id) == true
        expect mgr.has_entity(999) == false

    it "despawns entities":
        var mgr = EntityManager.create()
        val id = mgr.spawn_entity()
        mgr.despawn_entity(id)
        expect mgr.entity_count() == 0
        expect mgr.has_entity(id) == false

    it "provides summary":
        var mgr = EntityManager.create()
        mgr.spawn_entity()
        val s = mgr.summary()
        expect s == "EntityManager: 1 entities, next_id=2"
