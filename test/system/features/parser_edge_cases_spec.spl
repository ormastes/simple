"""
Parser Edge Cases Tests
Feature: Parser Edge Cases (Operators, Keywords, FFI)
Category: System, Parser
Status: Complete

Tests for parser edge cases including:
- Matrix multiplication (@) operator
- Bitwise XOR (xor) keyword
- super keyword
- FFI statement call handling
"""

describe "Parser Edge Cases":
    """
    Tests for parser edge cases and bug fixes.
    """

    context "Matrix Multiplication Operator":
        it "parses @ operator in expressions":
            val result = 3 @ 4
            expect result == 12

        it "parses @ operator with variables":
            val a = 2
            val b = 5
            val result = a @ b
            expect result == 10

        it "parses @ operator in function signatures":
            fn matrix_mul(a, b):
                return a @ b

            val result = matrix_mul(3, 7)
            expect result == 21

    context "Bitwise XOR Keyword":
        it "parses xor keyword in expressions":
            val result = 5 xor 3
            expect result == 6

        it "parses xor keyword with variables":
            val a = 12
            val b = 7
            val result = a xor b
            expect result == 11

        it "parses xor in complex expressions":
            val result = (5 xor 3) xor 1
            expect result == 7

    context "Super Keyword":
        it "parses super in method calls":
            class Base:
                fn greet():
                    return "Hello"

            class Derived(Base):
                fn greet():
                    return super.greet() + " World"

            val obj = Derived()
            expect obj.greet() == "Hello World"

        it "parses super in constructors":
            class Base:
                name: str

                fn __init__(n: str):
                    self.name = n

            class Derived(Base):
                age: i64

                fn __init__(n: str, a: i64):
                    super.__init__(n)
                    self.age = a

            val obj = Derived("Alice", 25)
            expect obj.name == "Alice"
            expect obj.age == 25

    context "FFI Statement Calls":
        it "parses FFI call assigned to variable":
            fn test_ffi():
                val result = @rt_test_function(42)
                return result

            # This should parse without errors
            expect test_ffi != None

        it "parses FFI call assigned to underscore":
            fn test_ffi_ignore():
                val _ = @rt_test_cleanup(123)
                return 99

            expect test_ffi_ignore() == 99

        it "parses multiline FFI call":
            fn test_multiline_ffi():
                var out = 0
                val _ = @rt_test_multiarg(
                    123,
                    456,
                    &out
                )
                return out

            # Should parse without errors
            expect test_multiline_ffi != None

    context "Array Type Syntax":
        it "parses array types with square brackets":
            fn takes_array(items: [i64]) -> [i64]:
                return items

            val nums = [1, 2, 3]
            val result = takes_array(nums)
            expect result == [1, 2, 3]

        it "parses nested array types":
            fn matrix(rows: [[i64]]) -> [[i64]]:
                return rows

            val data = [[1, 2], [3, 4]]
            val result = matrix(data)
            expect result == [[1, 2], [3, 4]]

    context "Generic Type Syntax":
        it "parses generic types with angle brackets":
            class Container<T>:
                value: T

                fn __init__(v: T):
                    self.value = v

                fn get() -> T:
                    return self.value

            val box = Container<i64>(42)
            expect box.get() == 42

        it "parses multiple generic parameters":
            class Pair<A, B>:
                first: A
                second: B

                fn __init__(a: A, b: B):
                    self.first = a
                    self.second = b

            val pair = Pair<i64, str>(123, "test")
            expect pair.first == 123
            expect pair.second == "test"
