"""
Mutable Collections by Default - Comprehensive SSpec Tests
Decision #3: Collections are mutable by default (like Python, JS, Java)

Category: Collections
Status: Implemented
"""

describe "Mutable Collections by Default":

    context "Array Mutability":
        it "allows push on default arrays":
            var arr = [1, 2, 3]
            arr.push(4)
            expect arr.len() == 4
            expect arr[3] == 4

        it "allows pop on default arrays":
            var arr = [1, 2, 3]
            val last = arr.pop()
            expect last == 3
            expect arr.len() == 2

        it "allows multiple pops":
            var arr = [1, 2, 3, 4, 5]
            arr.pop()
            arr.pop()
            expect arr.len() == 3
            expect arr[2] == 3

        it "allows insert on default arrays":
            var arr = [1, 3]
            arr.insert(1, 2)
            expect arr.len() == 3
            expect arr[1] == 2

        it "allows insert at beginning":
            var arr = [2, 3]
            arr.insert(0, 1)
            expect arr[0] == 1

        it "allows insert at end":
            var arr = [1, 2]
            arr.insert(2, 3)
            expect arr[2] == 3

        it "allows remove on default arrays":
            var arr = [1, 2, 3]
            val removed = arr.remove(1)
            expect removed == 2
            expect arr.len() == 2

        it "allows remove first element":
            var arr = [1, 2, 3]
            val removed = arr.remove(0)
            expect removed == 1
            expect arr[0] == 2

        it "allows remove last element":
            var arr = [1, 2, 3]
            val removed = arr.remove(2)
            expect removed == 3
            expect arr.len() == 2

        it "allows clear on default arrays":
            var arr = [1, 2, 3]
            arr.clear()
            expect arr.len() == 0

        it "allows indexing assignment":
            var arr = [1, 2, 3]
            arr[1] = 10
            expect arr[1] == 10

        it "allows indexing assignment at boundaries":
            var arr = [1, 2, 3]
            arr[0] = 10
            arr[2] = 30
            expect arr[0] == 10
            expect arr[2] == 30

    context "Dict Mutability":
        it "allows insert on default dicts":
            var dict = {"a": 1}
            dict["b"] = 2
            expect dict["b"] == 2

        it "allows update existing key":
            var dict = {"a": 1}
            dict["a"] = 10
            expect dict["a"] == 10

        it "allows remove on default dicts":
            var dict = {"a": 1, "b": 2}
            dict.remove("a")
            expect dict.len() == 1

        it "allows clear on default dicts":
            var dict = {"a": 1, "b": 2}
            dict.clear()
            expect dict.len() == 0

    context "val binding with mutable collection":
        it "allows mutation with val binding":
            val arr = [1, 2, 3]
            arr.push(4)
            expect arr.len() == 4
            expect arr[3] == 4

        it "allows pop with val binding":
            val arr = [1, 2, 3]
            arr.pop()
            expect arr.len() == 2

        it "works with dict and val binding":
            val dict = {"a": 1}
            dict["b"] = 2
            expect dict["b"] == 2

    context "Sequential operations":
        it "handles sequential borrows":
            var arr = [1, 2, 3]
            val len = arr.len()
            expect len == 3
            arr.push(4)
            expect arr.len() == 4

        it "allows read after write":
            var arr = [1, 2, 3]
            arr.push(4)
            val last = arr[3]
            expect last == 4

    context "Empty collection mutations":
        it "allows push to empty array":
            var arr = []
            arr.push(1)
            expect arr.len() == 1
            expect arr[0] == 1

        it "handles pop from singleton":
            var arr = [1]
            val elem = arr.pop()
            expect elem == 1
            expect arr.len() == 0

        it "allows insert into empty dict":
            var dict = {}
            dict["key"] = "value"
            expect dict["key"] == "value"
