# Mutable Collections by Default - Comprehensive SSpec Tests
# Decision #3: Collections are mutable by default (like Python, JS, Java)

describe "Mutable Collections by Default":

    context "Array Mutability":
        it "should allow push on default arrays":
            var arr = [1, 2, 3]
            arr.push(4)
            expect(arr).to_equal([1, 2, 3, 4])

        it "should allow pop on default arrays":
            var arr = [1, 2, 3]
            val last = arr.pop()
            expect(last).to_equal(3)
            expect(arr).to_equal([1, 2])

        it "should allow multiple pops":
            var arr = [1, 2, 3, 4, 5]
            arr.pop()
            arr.pop()
            expect(arr).to_equal([1, 2, 3])

        it "should allow insert on default arrays":
            var arr = [1, 3]
            arr.insert(1, 2)
            expect(arr).to_equal([1, 2, 3])

        it "should allow insert at beginning":
            var arr = [2, 3]
            arr.insert(0, 1)
            expect(arr).to_equal([1, 2, 3])

        it "should allow insert at end":
            var arr = [1, 2]
            arr.insert(2, 3)
            expect(arr).to_equal([1, 2, 3])

        it "should allow remove on default arrays":
            var arr = [1, 2, 3]
            val removed = arr.remove(1)
            expect(removed).to_equal(2)
            expect(arr).to_equal([1, 3])

        it "should allow remove first element":
            var arr = [1, 2, 3]
            val removed = arr.remove(0)
            expect(removed).to_equal(1)
            expect(arr).to_equal([2, 3])

        it "should allow remove last element":
            var arr = [1, 2, 3]
            val removed = arr.remove(2)
            expect(removed).to_equal(3)
            expect(arr).to_equal([1, 2])

        it "should allow clear on default arrays":
            var arr = [1, 2, 3]
            arr.clear()
            expect(arr).to_equal([])
            expect(arr.len()).to_equal(0)

        it "should allow indexing assignment":
            var arr = [1, 2, 3]
            arr[1] = 10
            expect(arr).to_equal([1, 10, 3])

        it "should allow indexing assignment at boundaries":
            var arr = [1, 2, 3]
            arr[0] = 10
            arr[2] = 30
            expect(arr).to_equal([10, 2, 30])

    context "Dict Mutability":
        it "should allow insert on default dicts":
            var dict = {"a": 1}
            dict["b"] = 2
            expect(dict).to_equal({"a": 1, "b": 2})

        it "should allow update existing key":
            var dict = {"a": 1}
            dict["a"] = 10
            expect(dict["a"]).to_equal(10)

        it "should allow remove on default dicts":
            var dict = {"a": 1, "b": 2}
            dict.remove("a")
            expect(dict).to_equal({"b": 2})

        it "should allow clear on default dicts":
            var dict = {"a": 1, "b": 2}
            dict.clear()
            expect(dict).to_equal({})

    context "val binding with mutable collection":
        it "should allow mutation but not reassignment":
            val arr = [1, 2, 3]
            arr.push(4)
            expect(arr).to_equal([1, 2, 3, 4])

        it "should allow pop with val binding":
            val arr = [1, 2, 3]
            arr.pop()
            expect(arr).to_equal([1, 2])

        it "should work with dict and val binding":
            val dict = {"a": 1}
            dict["b"] = 2
            expect(dict).to_equal({"a": 1, "b": 2})

        it "should work with class fields":
            class Container:
                items: [i64]

                me add(item: i64):
                    self.items.push(item)

            val c = Container(items: [1, 2])
            c.add(3)
            expect(c.items).to_equal([1, 2, 3])

    context "RefCell behavior":
        it "should handle sequential borrows":
            var arr = [1, 2, 3]
            val len = arr.len()
            expect(len).to_equal(3)
            arr.push(4)
            expect(arr.len()).to_equal(4)

        it "should allow read after write":
            var arr = [1, 2, 3]
            arr.push(4)
            val last = arr[3]
            expect(last).to_equal(4)

    context "Empty collection mutations":
        it "should allow push to empty array":
            var arr = []
            arr.push(1)
            expect(arr).to_equal([1])

        it "should handle pop from singleton":
            var arr = [1]
            val elem = arr.pop()
            expect(elem).to_equal(1)
            expect(arr).to_equal([])

        it "should allow insert into empty dict":
            var dict = {}
            dict["key"] = "value"
            expect(dict["key"]).to_equal("value")
