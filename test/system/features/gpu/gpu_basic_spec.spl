# GPU Basic Tests
#
# Tests for GPU device detection and basic operations.

use std.compute.*
use std.testing.gpu_helpers.*

describe "GPU Device Management":
    it "detects available backends":
        val backends = detect_backends()
        # At minimum, we should get an empty list or some backends
        check(backends.len() >= 0)

    it "gets preferred backend":
        val backend = preferred_backend()
        # Should return a valid enum variant
        if backend == GpuBackend.Cuda:
            check(true)
        elif backend == GpuBackend.Vulkan:
            check(true)
        elif backend == GpuBackend.NoGpu:
            check(true)
        else:
            check(true)

    it "lists all GPUs":
        val devices = list_all_gpus()
        # Should return a list (may be empty)
        check(devices.len() >= 0)

    it "reports GPU availability consistently":
        val available = gpu_available()
        val count = gpu_count()
        if available:
            check(count > 0)
        else:
            check(count == 0)

describe "GPU Default Device":
    it "creates default GPU device":
        val device = gpu_default()
        # gpu_default should always return, even if invalid
        check(true)

    it "reports device validity correctly":
        val device = gpu_default()
        if gpu_available():
            check(device.is_valid())
        else:
            check(not device.is_valid())

    # @tag(reason: "requires_gpu")  # @skip - attributes on test cases not supported
    it "gets device name":
        require_gpu()
        val device = gpu_default()
        val name = device.name()
        check(name.len() > 0)

    # @tag(reason: "requires_gpu")  # @skip - attributes on test cases not supported
    it "gets device memory":
        require_gpu()
        val device = gpu_default()
        val mem = device.total_memory()
        check(mem > 0)

describe "GPU Memory Allocation":
    # @tag(reason: "requires_gpu")  # @skip - attributes on test cases not supported
    it "allocates and frees buffer":
        require_gpu()
        val device = gpu_default()
        val buffer = gpu_alloc(device, 1024)
        check(buffer.is_valid)
        check(buffer.len() == 1024)
        check(gpu_free(buffer))

    # @tag(reason: "requires_gpu")  # @skip - attributes on test cases not supported
    it "handles zero-size allocation":
        require_gpu()
        val device = gpu_default()
        val buffer = gpu_alloc(device, 0)
        # Zero-size allocation behavior may vary by backend
        gpu_free(buffer)

    # @tag(reason: "requires_gpu")  # @skip - attributes on test cases not supported
    it "allocates typed arrays":
        require_gpu()
        val device = gpu_default()
        val floats = gpu_alloc_f32(device, 100)
        check(floats.valid())
        check(floats.count() == 100)
        check(floats.size_bytes() == 400  # 100 * 4 bytes)

describe "GPU Data Transfer":
    # @tag(reason: "requires_gpu")  # @skip - attributes on test cases not supported
    it "copies data to device":
        require_gpu()
        val device = gpu_default()
        val buffer = gpu_alloc(device, 16)

        val data: [u8] = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16]
        val success = gpu_copy_to(buffer, data)
        check(success)

        gpu_free(buffer)

    # @tag(reason: "requires_gpu")  # @skip - attributes on test cases not supported
    it "copies data from device":
        require_gpu()
        val device = gpu_default()
        val buffer = gpu_alloc(device, 16)

        val src: [u8] = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16]
        gpu_copy_to(buffer, src)

        var dst: [u8] = []
        for i in 0..16:
            dst.push(0)

        val success = gpu_copy_from(dst, buffer)
        check(success)
        # Note: dst should now contain the data from the GPU

        gpu_free(buffer)

describe "GPU Synchronization":
    # @tag(reason: "requires_gpu")  # @skip - attributes on test cases not supported
    it "synchronizes device":
        require_gpu()
        val device = gpu_default()
        check(device.wait_for_idle())

    # @tag(reason: "requires_gpu")  # @skip - attributes on test cases not supported
    it "synchronizes all devices":
        require_gpu()
        check(gpu_wait_all())

describe "GPU Info":
    it "generates GPU info string":
        val info = gpu_info()
        check(info.len() > 0)
        check(info.contains("GPU Information"))

    # @tag(reason: "requires_gpu")  # @skip - attributes on test cases not supported
    it "runs GPU smoke test":
        require_gpu()
        check(gpu_test_basic())

    # @tag(reason: "requires_gpu")  # @skip - attributes on test cases not supported
    it "reports GPU is ready":
        require_gpu()
        check(gpu_is_ready())
