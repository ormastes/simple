# @Feature 705.1: DAP server
# @Description: Test the Debug Adapter Protocol implementation

# NOTE: describe, it, expect are built-in - no imports needed

describe "DAP - initialization":
    it "handles initialize request":
        val adapter_id = "simple-dap"
        expect adapter_id == "simple-dap"

    it "responds with adapter capabilities":
        val capabilities = {
            "supportsConfigurationDoneRequest": true,
            "supportsBreakpointLocationsRequest": true,
            "supportsEvaluateForHovers": true
        }

        expect capabilities["supportsConfigurationDoneRequest"]

describe "DAP - breakpoints":
    it "sets line breakpoints":
        val breakpoint = {
            "source": {"path": "/test.spl"},
            "line": 10,
            "verified": true
        }

        expect breakpoint["verified"]
        expect breakpoint["line"] == 10

    it "sets conditional breakpoints":
        val breakpoint = {
            "source": {"path": "/test.spl"},
            "line": 15,
            "condition": "x > 10",
            "verified": true
        }

        expect breakpoint["condition"].contains(">")

    it "sets function breakpoints":
        val breakpoint = {
            "name": "my_function",
            "verified": true
        }

        expect breakpoint["name"] == "my_function"

describe "DAP - execution control":
    it "starts program execution":
        val status = "running"
        expect status == "running"

    it "handles continue request":
        val command = "continue"
        expect command == "continue"

    it "handles step over request":
        val command = "next"
        expect command == "next"

    it "handles step into request":
        val command = "stepIn"
        expect command == "stepIn"

    it "handles step out request":
        val command = "stepOut"
        expect command == "stepOut"

    it "handles pause request":
        val command = "pause"
        expect command == "pause"

describe "DAP - stack inspection":
    it "retrieves stack trace":
        val stack_frames = [
            {"id": 1, "name": "main", "line": 20},
            {"id": 2, "name": "helper", "line": 10}
        ]

        expect stack_frames.len() == 2
        expect stack_frames[0]["name"] == "main"

    it "retrieves scopes for frame":
        val scopes = [
            {"name": "Local", "variablesReference": 1},
            {"name": "Global", "variablesReference": 2}
        ]

        expect scopes.len() >= 1

    it "retrieves variables in scope":
        val variables = [
            {"name": "x", "value": "42", "type": "i64"},
            {"name": "y", "value": "hello", "type": "text"}
        ]

        expect variables[0]["name"] == "x"
        expect variables[0]["value"] == "42"

describe "DAP - expression evaluation":
    it "evaluates expressions in stopped context":
        # Evaluate "x + 1" when x = 42
        val result = {
            "result": "43",
            "type": "i64"
        }

        expect result["result"] == "43"

    it "evaluates watch expressions":
        val watch = {
            "expression": "x * 2",
            "value": "84"
        }

        expect watch["expression"].contains("*")

describe "DAP - events":
    it "sends stopped event on breakpoint hit":
        val event = {
            "reason": "breakpoint",
            "threadId": 1
        }

        expect event["reason"] == "breakpoint"

    it "sends output event for program output":
        val event = {
            "category": "stdout",
            "output": "Hello, world!\n"
        }

        expect event["category"] == "stdout"

    it "sends terminated event when program exits":
        val event = {
            "event": "terminated"
        }

        expect event["event"] == "terminated"
