#!/usr/bin/env simple
# Manual QEMU Test - Direct Execution
# Tests the unified execution system with QEMU x86_64

use lib.qemu.mod.{QemuInstance, QemuConfig, QemuArch}

# Process result structure
class ProcessResult:
    stdout: text
    stderr: text
    exit_code: i64

# Shell function
extern fn rt_process_run(cmd: text, args: [text]) -> (text, text, i64)

fn shell(cmd: text) -> ProcessResult:
    val (stdout, stderr, exit_code) = rt_process_run("/bin/sh", ["-c", cmd])
    ProcessResult(stdout: stdout, stderr: stderr, exit_code: exit_code)

fn main():
    print("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
    print("â•‘  QEMU Unified Execution - Manual Test     â•‘")
    print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")

    # Test 1: Basic QEMU startup
    print("Test 1: QEMU Instance Startup")
    print("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")

    val binary = "examples/baremetal/hello_x86_64.elf"

    # Check binary exists
    val check = shell("test -f {binary}")
    if check.exit_code != 0:
        print("âŒ Binary not found: {binary}")
        print("   Run: cd examples/baremetal && bash build.sh")
        return

    print("âœ“ Binary found: {binary}")

    # Create QEMU config with GDB stub
    val config = QemuConfig.for_remote_debug(
        QemuArch.X86_64,
        binary,
        1234
    )

    print("âœ“ Config created:")
    print("  - Architecture: x86_64")
    print("  - Binary: {binary}")
    print("  - GDB port: 1234")

    # Start QEMU
    print("\nâ³ Starting QEMU...")
    val result = QemuInstance.start(config)

    match result:
        Ok(instance):
            print("âœ“ QEMU started successfully!")
            print("  - PID: {instance.get_pid()}")
            print("  - GDB port: {instance.get_gdb_port()}")

            # Wait for GDB stub to initialize
            shell("sleep 1")

            # Check if QEMU is running
            if instance.is_running():
                print("âœ“ QEMU instance is running")
            else:
                print("âš  QEMU instance stopped unexpectedly")

            # Check GDB port
            print("\nâ³ Checking GDB stub...")
            val port_check = shell("ss -tlnp 2>/dev/null | grep ':1234' || true")
            if port_check.stdout.contains("1234"):
                print("âœ“ GDB stub is listening on port 1234")
            else:
                print("âš  GDB port check inconclusive (may need elevated permissions)")
                print("  You can verify manually: ss -tlnp | grep 1234")

            # Stop QEMU
            print("\nâ³ Stopping QEMU...")
            instance.stop()
            shell("sleep 0.5")

            if not instance.is_running():
                print("âœ“ QEMU stopped successfully")
            else:
                print("âš  QEMU may still be running")

            print("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
            print("â•‘  âœ“ Test PASSED                             â•‘")
            print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")

        Err(e):
            print("âŒ Failed to start QEMU")
            print("   Error: {e}")
            print("\n   Troubleshooting:")
            print("   1. Check QEMU is installed:")
            print("      qemu-system-x86_64 --version")
            print("   2. Check binary exists:")
            print("      ls -l {binary}")
            print("   3. Check for permission issues")
            print("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
            print("â•‘  âœ— Test FAILED                             â•‘")
            print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")

    # Test 2: Run to completion
    print("\nTest 2: Run Binary to Completion")
    print("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")

    # Create config for test execution
    val test_config = QemuConfig.for_test_runner(QemuArch.X86_64, binary)

    print("âœ“ Test config created (stdio output, debug exit)")

    print("\nâ³ Starting QEMU and running binary...")
    val test_result = QemuInstance.start(test_config)

    match test_result:
        Ok(instance):
            print("âœ“ QEMU started")

            # Wait for completion
            val exit_result = instance.wait_exit(timeout_ms: 10000)

            match exit_result:
                Ok(exit_code):
                    # Debug-exit device encoding: exit(0) -> QEMU exits with 1
                    if exit_code == 1:
                        print("âœ“ Binary executed successfully")
                        print("  - Exit code: {exit_code} (debug-exit encoding of 0)")
                    else:
                        print("âš  Binary exited with code: {exit_code}")

                    print("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
                    print("â•‘  âœ“ Test PASSED                             â•‘")
                    print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")

                Err(e):
                    instance.stop()
                    print("âŒ Execution failed: {e}")
                    print("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
                    print("â•‘  âœ— Test FAILED                             â•‘")
                    print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")

        Err(e):
            print("âŒ Failed to start QEMU: {e}")
            print("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
            print("â•‘  âœ— Test FAILED                             â•‘")
            print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")

    print("\nğŸ‰ Manual test completed!\n")
