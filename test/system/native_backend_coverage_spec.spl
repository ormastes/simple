# Native Backend Coverage Verification
#
# Uses std.coverage.check_coverage() to verify that native backend
# source files are exercised when system tests run.
#
# Coverage data is read from SIMPLE_COVERAGE_DATA env var or
# build/coverage/coverage.json (populated by --coverage test flag).

use std.coverage.{check_coverage, enable_coverage_tag, disable_coverage_tag, CoverageResult}

describe "Native Backend Coverage":
    it "check_coverage API returns valid result for native compile line coverage":
        enable_coverage_tag()
        val result = check_coverage("line", "src/app/compile/native.spl", minimum: 0.0)
        expect(result.coverage_type).to_equal("line")
        print "  native.spl line coverage: {result.actual}%  files_matched={result.files_matched}"
        disable_coverage_tag()

    it "check_coverage API returns valid result for native compile branch coverage":
        enable_coverage_tag()
        val result = check_coverage("branch", "src/app/compile/native.spl", minimum: 0.0)
        expect(result.coverage_type).to_equal("branch")
        print "  native.spl branch coverage: {result.actual}%  files_matched={result.files_matched}"
        disable_coverage_tag()

    it "check_coverage API returns valid result for llvm direct line coverage":
        enable_coverage_tag()
        val result = check_coverage("line", "src/app/compile/llvm_direct.spl", minimum: 0.0)
        expect(result.coverage_type).to_equal("line")
        print "  llvm_direct.spl line coverage: {result.actual}%  files_matched={result.files_matched}"
        disable_coverage_tag()

    it "check_coverage API returns valid result for wildcard compile pattern":
        enable_coverage_tag()
        val result = check_coverage("line", "src/app/compile/**", minimum: 0.0)
        expect(result.coverage_type).to_equal("line")
        print "  src/app/compile/** line coverage: {result.actual}%  files_matched={result.files_matched}"
        disable_coverage_tag()

    it "coverage_type and pattern are preserved on result":
        enable_coverage_tag()
        val result = check_coverage("function", "src/app/compile/native.spl", minimum: 0.0)
        expect(result.coverage_type).to_equal("function")
        expect(result.pattern).to_equal("src/app/compile/native.spl")
        disable_coverage_tag()
