# System Test - doc-coverage CLI command

use std.spec.{describe, slow_it, expect}
use app.io.mod (process_run)

fn run_simple(args: [text]) -> (text, text, i64):
    process_run("bin/simple", args)

describe "doc-coverage CLI - terminal mode":
    slow_it "doc-coverage exits with 0":
        val result = run_simple(["doc-coverage"])
        val exit_code = result.2
        expect(exit_code).to_equal(0)

    slow_it "doc-coverage shows coverage report header":
        val result = run_simple(["doc-coverage"])
        val stdout = result.0
        expect(stdout.contains("Coverage Report")).to_equal(true)

    slow_it "doc-coverage shows non-zero public function count":
        val result = run_simple(["doc-coverage"])
        val stdout = result.0
        expect(stdout.contains("Public Functions:")).to_equal(true)

    slow_it "doc-coverage shows per-scope breakdown":
        val result = run_simple(["doc-coverage"])
        val stdout = result.0
        expect(stdout.contains("Per-Scope Breakdown")).to_equal(true)

describe "doc-coverage CLI - JSON mode":
    slow_it "doc-coverage --format=json exits with 0":
        val result = run_simple(["doc-coverage", "--format=json"])
        val exit_code = result.2
        expect(exit_code).to_equal(0)

    slow_it "doc-coverage --format=json outputs JSON":
        val result = run_simple(["doc-coverage", "--format=json"])
        val stdout = result.0
        expect(stdout.starts_with("{")).to_equal(true)

    slow_it "doc-coverage --format=json has total_public field":
        val result = run_simple(["doc-coverage", "--format=json"])
        val stdout = result.0
        expect(stdout.contains("\"total_public\"")).to_equal(true)

    slow_it "doc-coverage --format=json has per_scope field":
        val result = run_simple(["doc-coverage", "--format=json"])
        val stdout = result.0
        expect(stdout.contains("\"per_scope\"")).to_equal(true)

    slow_it "doc-coverage --format=json total_public is non-zero":
        val result = run_simple(["doc-coverage", "--format=json"])
        val stdout = result.0
        val has_nonzero = not stdout.contains("\"total_public\": 0")
        expect(has_nonzero).to_equal(true)

describe "doc-coverage CLI - Markdown mode":
    slow_it "doc-coverage --format=md exits with 0":
        val result = run_simple(["doc-coverage", "--format=md"])
        val exit_code = result.2
        expect(exit_code).to_equal(0)

    slow_it "doc-coverage --format=md outputs markdown heading":
        val result = run_simple(["doc-coverage", "--format=md"])
        val stdout = result.0
        expect(stdout.contains("# Documentation Coverage Report")).to_equal(true)

    slow_it "doc-coverage --format=md contains table":
        val result = run_simple(["doc-coverage", "--format=md"])
        val stdout = result.0
        expect(stdout.contains("|")).to_equal(true)

describe "doc-coverage CLI - missing flag":
    slow_it "doc-coverage --missing exits with 0":
        val result = run_simple(["doc-coverage", "--missing"])
        val exit_code = result.2
        expect(exit_code).to_equal(0)

    slow_it "doc-coverage --missing shows undocumented header":
        val result = run_simple(["doc-coverage", "--missing"])
        val stdout = result.0
        expect(stdout.contains("Undocumented")).to_equal(true)

describe "doc-coverage CLI - path scoping":
    slow_it "doc-coverage src/core scopes to core":
        val result = run_simple(["doc-coverage", "src/core"])
        val stdout = result.0
        val exit_code = result.2
        expect(exit_code).to_equal(0)
        expect(stdout.contains("src/core")).to_equal(true)

    slow_it "doc-coverage src/std scopes to std":
        val result = run_simple(["doc-coverage", "src/std"])
        val stdout = result.0
        val exit_code = result.2
        expect(exit_code).to_equal(0)
        expect(stdout.contains("src/std")).to_equal(true)

describe "stats command coverage integration":
    slow_it "stats shows Coverage section with non-zero values":
        val result = run_simple(["stats"])
        val stdout = result.0
        val exit_code = result.2
        expect(exit_code).to_equal(0)
        expect(stdout.contains("Coverage:")).to_equal(true)

    slow_it "stats --json documentation total_public is non-zero":
        val result = run_simple(["stats", "--json"])
        val stdout = result.0
        val has_nonzero = not stdout.contains("\"total_public\": 0")
        expect(has_nonzero).to_equal(true)
