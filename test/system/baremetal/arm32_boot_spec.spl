# @platform: baremetal(arm32)
# ARM32 (Cortex-M) Bare-Metal Boot Tests
#
# Tests ARM Cortex-M bare-metal boot functionality:
# - Vector table generation
# - Reset handler
# - Stack pointer initialization
# - Startup code
#
# These tests verify the ARM32 boot infrastructure works correctly.
# Requires QEMU installation
#
# NOTE: Tests are skipped because the support modules don't exist yet:
#   - src.baremetal.arm.test_support
#   - src.lib.qemu.boot_runner

use std.spec
use std.spec.{check, check_msg}

# ===========================================================================
# Vector Table Tests
# ===========================================================================

describe "ARM32 Vector Table":
    skip_it "generates valid vector table":
        # Needs: create_vector_table, STACK_TOP from src.baremetal.arm.test_support
        # Initial SP should be at top of RAM
        # Reset handler should be in flash with Thumb bit set
        # Reserved entries should be zero
        check(true)

    skip_it "validates vector table successfully":
        # Needs: create_vector_table, validate_vector_table
        check(true)

    skip_it "includes all Cortex-M exceptions":
        # Needs: check_exception_count, ExceptionVector enum
        # Cortex-M has 16 exception vectors
        check(true)

    skip_it "places vector table at correct address":
        # Needs: check_vector_alignment
        # Flash base for STM32F4: 0x08000000
        # Vector table must be aligned to 128 bytes minimum
        check(true)

# ===========================================================================
# Reset Handler Tests
# ===========================================================================

describe "ARM32 Reset Handler":
    skip_it "initializes .data section":
        # Needs: check_data_init
        # Simulate .data section in RAM
        check(true)

    skip_it "zeros .bss section":
        # Needs: check_bss_init
        # Simulate .bss section in RAM
        check(true)

    skip_it "sets up stack pointer":
        # Needs: STACK_TOP, check_stack_alignment
        # Stack pointer should be at top of RAM
        # Stack must be 8-byte aligned (ARM AAPCS requirement)
        check(true)

    skip_it "calls main function":
        # Needs: create_vector_table
        # Reset handler should:
        # 1. Initialize data/BSS
        # 2. Set up stack
        # 3. Call main
        # 4. Loop forever if main returns
        check(true)

# ===========================================================================
# NVIC Tests
# ===========================================================================

describe "ARM32 NVIC (Nested Vectored Interrupt Controller)":
    skip_it "enables interrupts correctly":
        # TODO: Test interrupt enable
        # - NVIC_EnableIRQ
        # - Priority configuration
        check(true)

    skip_it "handles interrupt priorities":
        # TODO: Test priority levels
        # - Priority grouping
        # - Preemption vs sub-priority
        check(true)

# ===========================================================================
# QEMU Boot Tests
# ===========================================================================

describe "ARM32 QEMU Boot":
    skip_it "boots on LM3S6965 (Cortex-M3)":
        # Needs: run_arm_cortex_m_boot_test from src.lib.qemu.boot_runner
        # Test with blinky_stm32f4.spl example
        check(true)

    skip_it "handles SysTick interrupt":
        # TODO: Test SysTick
        # - Configure SysTick timer
        # - Enable SysTick interrupt
        # - Verify periodic handler calls
        # Requires test kernel with SysTick configured
        check(true)
