# SSpec: String Escape Processing
#
# Comprehensive behavioral specification for string_escape.spl
# Tests escape/unescape bijection, error handling, and edge cases

import sspec
import std_lib.tooling.compiler.string_escape

Feature "String Escape Processing":

    Scenario "Process newline escape":
        Given "the character 'n' after backslash"
        val c = 'n'
        When "processing the escape"
        val result = process_escape(c, allow_braces: false)
        Then "it should return newline character"
        match result:
            EscapeResult.Char(ch) -> sspec.expect(ch).to_equal('\n')
            _ -> sspec.fail("Expected Char result")

    Scenario "Process tab escape":
        Given "the character 't' after backslash"
        val c = 't'
        When "processing the escape"
        val result = process_escape(c, allow_braces: false)
        Then "it should return tab character"
        match result:
            EscapeResult.Char(ch) -> sspec.expect(ch).to_equal('\t')
            _ -> sspec.fail("Expected Char result")

    Scenario "Process carriage return escape":
        Given "the character 'r' after backslash"
        val c = 'r'
        When "processing the escape"
        val result = process_escape(c, allow_braces: false)
        Then "it should return carriage return character"
        match result:
            EscapeResult.Char(ch) -> sspec.expect(ch).to_equal('\r')
            _ -> sspec.fail("Expected Char result")

    Scenario "Process backslash escape":
        Given "the character '\\' after backslash"
        val c = '\\'
        When "processing the escape"
        val result = process_escape(c, allow_braces: false)
        Then "it should return backslash character"
        match result:
            EscapeResult.Char(ch) -> sspec.expect(ch).to_equal('\\')
            _ -> sspec.fail("Expected Char result")

    Scenario "Process quote escape":
        Given "the character '\"' after backslash"
        val c = '"'
        When "processing the escape"
        val result = process_escape(c, allow_braces: false)
        Then "it should return quote character"
        match result:
            EscapeResult.Char(ch) -> sspec.expect(ch).to_equal('"')
            _ -> sspec.fail("Expected Char result")

    Scenario "Process null escape":
        Given "the character '0' after backslash"
        val c = '0'
        When "processing the escape"
        val result = process_escape(c, allow_braces: false)
        Then "it should return null character"
        match result:
            EscapeResult.Char(ch) -> sspec.expect(ch).to_equal('\0')
            _ -> sspec.fail("Expected Char result")

    Scenario "Process brace escape when allowed":
        Given "the character '\{' after backslash"
        val c = '{'
        When "processing with allow_braces true"
        val result = process_escape(c, allow_braces: true)
        Then "it should return brace character"
        match result:
            EscapeResult.Char(ch) -> sspec.expect(ch).to_equal('{')
            _ -> sspec.fail("Expected Char result")

    Scenario "Reject brace escape when not allowed":
        Given "the character '\{' after backslash"
        val c = '{'
        When "processing with allow_braces false"
        val result = process_escape(c, allow_braces: false)
        Then "it should return error"
        match result:
            EscapeResult.Error(_) -> sspec.pass()
            _ -> sspec.fail("Expected Error result")

    Scenario "Process invalid escape":
        Given "an invalid character 'x' after backslash"
        val c = 'x'
        When "processing the escape"
        val result = process_escape(c, allow_braces: false)
        Then "it should return error"
        match result:
            EscapeResult.Error(msg) ->
                sspec.expect(msg).to_contain("Invalid escape sequence")
            _ -> sspec.fail("Expected Error result")

    Scenario "Escape string with newline":
        Given "a string with newline"
        val s = "hello\nworld"
        When "escaping the string"
        val escaped = escape_string(s)
        Then "it should convert newline to \\n"
        sspec.expect(escaped).to_equal("hello\\nworld")

    Scenario "Escape string with tab":
        Given "a string with tab"
        val s = "hello\tworld"
        When "escaping the string"
        val escaped = escape_string(s)
        Then "it should convert tab to \\t"
        sspec.expect(escaped).to_equal("hello\\tworld")

    Scenario "Escape string with backslash":
        Given "a string with backslash"
        val s = "hello\\world"
        When "escaping the string"
        val escaped = escape_string(s)
        Then "it should convert backslash to \\\\"
        sspec.expect(escaped).to_equal("hello\\\\world")

    Scenario "Escape string with quote":
        Given "a string with quote"
        val s = "hello\"world"
        When "escaping the string"
        val escaped = escape_string(s)
        Then "it should convert quote to \\\""
        sspec.expect(escaped).to_equal("hello\\\"world")

    Scenario "Escape empty string":
        Given "an empty string"
        val s = ""
        When "escaping the string"
        val escaped = escape_string(s)
        Then "it should return empty string"
        sspec.expect(escaped).to_equal("")

    Scenario "Escape string with no special characters":
        Given "a string with no special characters"
        val s = "hello world"
        When "escaping the string"
        val escaped = escape_string(s)
        Then "it should return the same string"
        sspec.expect(escaped).to_equal("hello world")

    Scenario "Unescape string with \\n":
        Given "a string with \\n escape"
        val s = "hello\\nworld"
        When "unescaping the string"
        val result = unescape_string(s)
        Then "it should convert to newline"
        sspec.expect(result.is_some()).to_be_true()
        sspec.expect(result.unwrap()).to_equal("hello\nworld")

    Scenario "Unescape string with \\t":
        Given "a string with \\t escape"
        val s = "hello\\tworld"
        When "unescaping the string"
        val result = unescape_string(s)
        Then "it should convert to tab"
        sspec.expect(result.is_some()).to_be_true()
        sspec.expect(result.unwrap()).to_equal("hello\tworld")

    Scenario "Unescape string with \\\\":
        Given "a string with \\\\ escape"
        val s = "hello\\\\world"
        When "unescaping the string"
        val result = unescape_string(s)
        Then "it should convert to backslash"
        sspec.expect(result.is_some()).to_be_true()
        sspec.expect(result.unwrap()).to_equal("hello\\world")

    Scenario "Unescape unterminated escape":
        Given "a string ending with backslash"
        val s = "hello\\"
        When "unescaping the string"
        val result = unescape_string(s)
        Then "it should return None"
        sspec.expect(result.is_none()).to_be_true()

    Scenario "Unescape invalid escape":
        Given "a string with invalid escape \\x"
        val s = "hello\\xworld"
        When "unescaping the string"
        val result = unescape_string(s)
        Then "it should return None"
        sspec.expect(result.is_none()).to_be_true()

    Scenario "Unescape empty string":
        Given "an empty string"
        val s = ""
        When "unescaping the string"
        val result = unescape_string(s)
        Then "it should return empty string"
        sspec.expect(result.is_some()).to_be_true()
        sspec.expect(result.unwrap()).to_equal("")

    Scenario "Round-trip escape and unescape":
        Given "a string with special characters"
        val original = "hello\nworld\ttab\\slash\"quote"
        When "escaping then unescaping"
        val escaped = escape_string(original)
        val unescaped = unescape_string(escaped)
        Then "it should return the original string"
        sspec.expect(unescaped.is_some()).to_be_true()
        sspec.expect(unescaped.unwrap()).to_equal(original)

    Scenario "Escape single character newline":
        Given "a newline character"
        val c = '\n'
        When "escaping the character"
        val escaped = escape_char(c)
        Then "it should return \\n"
        sspec.expect(escaped).to_equal("\\n")

    Scenario "Escape single character tab":
        Given "a tab character"
        val c = '\t'
        When "escaping the character"
        val escaped = escape_char(c)
        Then "it should return \\t"
        sspec.expect(escaped).to_equal("\\t")

    Scenario "Escape normal character":
        Given "a normal character 'a'"
        val c = 'a'
        When "escaping the character"
        val escaped = escape_char(c)
        Then "it should return 'a'"
        sspec.expect(escaped).to_equal("a")

    Scenario "Check if newline needs escape":
        Given "a newline character"
        val c = '\n'
        When "checking if it needs escape"
        val needs = needs_escape(c)
        Then "it should return true"
        sspec.expect(needs).to_be_true()

    Scenario "Check if normal character needs escape":
        Given "a normal character 'a'"
        val c = 'a'
        When "checking if it needs escape"
        val needs = needs_escape(c)
        Then "it should return false"
        sspec.expect(needs).to_be_false()

    Scenario "Count escapes in string":
        Given "a string with 3 special characters"
        val s = "hello\nworld\ttab"
        When "counting escapes"
        val count = count_escapes(s)
        Then "it should return 2"
        sspec.expect(count).to_equal(2)

    Scenario "Count escapes in empty string":
        Given "an empty string"
        val s = ""
        When "counting escapes"
        val count = count_escapes(s)
        Then "it should return 0"
        sspec.expect(count).to_equal(0)

    Scenario "Get escaped length":
        Given "a string with special characters"
        val s = "hello\nworld"  # 11 chars, but \n becomes 2 chars when escaped
        When "calculating escaped length"
        val length = escaped_length(s)
        Then "it should return 12"
        sspec.expect(length).to_equal(12)

    Scenario "Escaped length of empty string":
        Given "an empty string"
        val s = ""
        When "calculating escaped length"
        val length = escaped_length(s)
        Then "it should return 0"
        sspec.expect(length).to_equal(0)

    Scenario "Escaped length equals actual escaped string length":
        Given "a string with special characters"
        val s = "hello\n\t\r\\world"
        When "comparing calculated and actual escaped length"
        val predicted = escaped_length(s)
        val escaped = escape_string(s)
        val actual = escaped.length()
        Then "they should match"
        sspec.expect(predicted).to_equal(actual)
