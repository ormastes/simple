"""
Input Validation Security Specification

Security tests for input handling: very long strings, null-like patterns,
path traversal detection, and shell metacharacter awareness.

Feature: Input Validation and Security Patterns
Category: Security Testing
Status: Active
"""

# Inline LCG random number generator
var lcg_state = 31337

fn lcg_seed(s: i64):
    lcg_state = s

fn lcg_next() -> i64:
    lcg_state = (1103515245 * lcg_state + 12345) % 2147483647
    if lcg_state < 0: lcg_state = -lcg_state
    return lcg_state

fn lcg_range(lo: i64, hi: i64) -> i64:
    val raw = lcg_next()
    val range_size = hi - lo
    if range_size <= 0: return lo
    return lo + (raw % range_size)

# Helper: build a string of given length
fn build_string(ch: text, count: i64) -> text:
    var result = ""
    for i in 0..count:
        result = result + ch
    return result

# Helper: check if path contains traversal patterns
fn has_path_traversal(path: text) -> bool:
    if path.contains(".."):
        return true
    if path.contains("~"):
        return true
    return false

# Helper: check for common shell metacharacters
fn has_shell_metachar(input: text) -> bool:
    if input.contains(";"):
        return true
    if input.contains("|"):
        return true
    if input.contains("&"):
        return true
    if input.contains("`"):
        return true
    if input.contains("$"):
        return true
    return false

# Helper: basic input sanitizer (strips dangerous chars)
fn sanitize_input(input: text) -> text:
    var result = input
    result = result.replace(";", "")
    result = result.replace("|", "")
    result = result.replace("&", "")
    result = result.replace("`", "")
    result = result.replace("$", "")
    return result

describe "security: long string handling":
    it "very long string does not crash basic operations":
        val long_str = build_string("A", 5000)
        expect(long_str.len()).to_equal(5000)

    it "long string equality works":
        val s1 = build_string("B", 1000)
        val s2 = build_string("B", 1000)
        val equal = s1 == s2
        expect(equal).to_equal(true)

    it "long string inequality works":
        val s1 = build_string("C", 1000)
        val s2 = build_string("D", 1000)
        val not_equal = s1 != s2
        expect(not_equal).to_equal(true)

    it "long string concatenation produces correct length":
        val s1 = build_string("x", 2000)
        val s2 = build_string("y", 2000)
        val combined = s1 + s2
        expect(combined.len()).to_equal(4000)

    it "contains works on long strings":
        val haystack = build_string("a", 500) + "NEEDLE" + build_string("a", 500)
        val found = haystack.contains("NEEDLE")
        expect(found).to_equal(true)

    it "slicing long strings works":
        val long_str = build_string("z", 1000)
        val slice = long_str[100:200]
        expect(slice.len()).to_equal(100)

describe "security: null-like patterns":
    it "empty string is handled safely":
        val s = ""
        expect(s.len()).to_equal(0)
        val with_empty = "prefix" + s + "suffix"
        expect(with_empty).to_equal("prefixsuffix")

    it "string with 'null' text is just a string":
        val s = "null"
        expect(s.len()).to_equal(4)
        expect(s).to_equal("null")

    it "string with 'nil' text is just a string":
        val s = "nil"
        expect(s.len()).to_equal(3)
        expect(s).to_equal("nil")

    it "string with 'undefined' text is just a string":
        val s = "undefined"
        expect(s.len()).to_equal(9)
        val contains_undef = s.contains("undef")
        expect(contains_undef).to_equal(true)

    it "string with zeros is handled correctly":
        val s = "000"
        expect(s.len()).to_equal(3)
        val n = int(s)
        expect(n).to_equal(0)

describe "security: path traversal detection":
    it "detects double-dot traversal":
        val path = "../../../etc/passwd"
        val is_traversal = has_path_traversal(path)
        expect(is_traversal).to_equal(true)

    it "detects embedded traversal":
        val path = "/home/user/../../../etc/shadow"
        val is_traversal = has_path_traversal(path)
        expect(is_traversal).to_equal(true)

    it "allows normal paths":
        val path = "/home/user/documents/file.txt"
        val is_traversal = has_path_traversal(path)
        expect(is_traversal).to_equal(false)

    it "detects tilde expansion":
        val path = "~/secret_file"
        val is_traversal = has_path_traversal(path)
        expect(is_traversal).to_equal(true)

    it "handles path with many segments safely":
        val path = "/a/b/c/d/e/f/g/h/i/j/k/l/file.txt"
        val is_traversal = has_path_traversal(path)
        expect(is_traversal).to_equal(false)

describe "security: shell metacharacter awareness":
    it "detects semicolon injection":
        val input = "file.txt; rm -rf /"
        val is_dangerous = has_shell_metachar(input)
        expect(is_dangerous).to_equal(true)

    it "detects pipe injection":
        val input = "input | cat /etc/passwd"
        val is_dangerous = has_shell_metachar(input)
        expect(is_dangerous).to_equal(true)

    it "detects ampersand injection":
        val input = "cmd & evil_cmd"
        val is_dangerous = has_shell_metachar(input)
        expect(is_dangerous).to_equal(true)

    it "detects backtick injection":
        val input = "file_`whoami`.txt"
        val is_dangerous = has_shell_metachar(input)
        expect(is_dangerous).to_equal(true)

    it "detects dollar sign expansion":
        val input = "hello $USER"
        val is_dangerous = has_shell_metachar(input)
        expect(is_dangerous).to_equal(true)

    it "allows safe input":
        val input = "my_document_2026.txt"
        val is_dangerous = has_shell_metachar(input)
        expect(is_dangerous).to_equal(false)

    it "sanitizer removes dangerous characters":
        val input = "file;rm|cat&bg`cmd$var"
        val clean = sanitize_input(input)
        val still_dangerous = has_shell_metachar(clean)
        expect(still_dangerous).to_equal(false)

    it "sanitizer preserves safe content":
        val input = "hello_world_123.txt"
        val clean = sanitize_input(input)
        expect(clean).to_equal(input)

describe "security: random input fuzzing":
    it "random strings do not crash string operations":
        lcg_seed(50001)
        var failures = 0
        val chars = "abcdefghijklmnopqrstuvwxyz0123456789_-./;|&`$"
        for i in 0..100:
            var s = ""
            val slen = lcg_range(1, 30)
            for j in 0..slen:
                val idx = lcg_range(0, chars.len())
                s = s + chars[idx]
            # These operations should never crash
            val length = s.len()
            if length < 0:
                failures = failures + 1
            val contains_a = s.contains("a")
            val starts = s.starts_with("z")
            val ends = s.ends_with("q")
        expect(failures).to_equal(0)

    it "random path-like strings are correctly classified":
        lcg_seed(50002)
        var misclassified = 0
        for i in 0..50:
            val with_traversal = "/home/../etc/file_{i}"
            if has_path_traversal(with_traversal) != true:
                misclassified = misclassified + 1
            val safe_path = "/home/user/file_{i}.txt"
            if has_path_traversal(safe_path) != false:
                misclassified = misclassified + 1
        expect(misclassified).to_equal(0)
