# Semi-Host Reader Unit Tests
#
# Tests parse_serial_frame() and format_interned_string() directly
# without requiring QEMU or external binaries.

from app.semihost.reader import {parse_serial_frame, format_interned_string, SemihostFrame}

# Helper: build a valid binary frame as byte array
# Frame: MAGIC(1) + VERSION(1) + OP(4 LE) + LEN(4 LE) + PAYLOAD(N)
fn make_frame(op: i32, handle: i32) -> [u8]:
    var buf: [u8] = []
    # Magic
    buf.push(0xAB as u8)
    # Version
    buf.push(0x01 as u8)
    # OP as u32 little-endian
    buf.push((op & 0xFF) as u8)
    buf.push(((op >> 8) & 0xFF) as u8)
    buf.push(((op >> 16) & 0xFF) as u8)
    buf.push(((op >> 24) & 0xFF) as u8)
    # LEN = 4 (handle only, no params)
    buf.push(0x04 as u8)
    buf.push(0x00 as u8)
    buf.push(0x00 as u8)
    buf.push(0x00 as u8)
    # HANDLE as u32 little-endian
    buf.push((handle & 0xFF) as u8)
    buf.push(((handle >> 8) & 0xFF) as u8)
    buf.push(((handle >> 16) & 0xFF) as u8)
    buf.push(((handle >> 24) & 0xFF) as u8)
    buf

describe "parse_serial_frame":
    it "parses valid SYS_WRITE_HANDLE frame":
        val buf = make_frame(0x100, 1)
        val result = parse_serial_frame(buf)
        expect(result.is_ok()).to_equal(true)
        val (frame, consumed) = result.unwrap()
        expect(frame.op as i64).to_equal(256)
        expect(frame.handle as i64).to_equal(1)
        expect(consumed as i64).to_equal(14)

    it "parses frame with handle 2":
        val buf = make_frame(0x100, 2)
        val result = parse_serial_frame(buf)
        expect(result.is_ok()).to_equal(true)
        val (frame, consumed) = result.unwrap()
        expect(frame.handle as i64).to_equal(2)

    it "rejects buffer too small":
        var buf: [u8] = [0xAB as u8, 0x01 as u8, 0x00 as u8]
        val result = parse_serial_frame(buf)
        expect(result.is_ok()).to_equal(false)

    it "rejects invalid magic byte":
        var buf = make_frame(0x100, 1)
        buf[0] = 0x00 as u8
        val result = parse_serial_frame(buf)
        expect(result.is_ok()).to_equal(false)

    it "rejects unsupported version":
        var buf = make_frame(0x100, 1)
        buf[1] = 0xFF as u8
        val result = parse_serial_frame(buf)
        expect(result.is_ok()).to_equal(false)

describe "format_interned_string":
    it "formats string with no params":
        val result = format_interned_string("Hello, World!", [], [])
        expect(result).to_equal("Hello, World!")

    it "formats string with integer param (default type)":
        # When types array is empty but params exist, defaults to Int64
        val result = format_interned_string("Count: {}", [], [42])
        expect(result).to_equal("Count: 42")

    it "formats string with multiple params":
        val result = format_interned_string("{} + {} = result", [], [3, 7])
        expect(result).to_equal("3 + 7 = result")

    it "preserves text without placeholders":
        val result = format_interned_string("no placeholders here", [], [])
        expect(result).to_equal("no placeholders here")
