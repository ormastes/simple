# # Test DB Core Helpers Specification
#
# **Feature IDs:** #DB-CORE-HELPERS
# **Category:** Tooling
# **Status:** Implemented
#
# ## Overview
#
# Tests helper functions in test_db_core that don't require StringInterner mutation:
# - RFC3339 timestamp formatting and parsing
# - Run label appending with capping
# - Timing run collection and capping logic

use app.test_runner_new.test_db_core.{micros_to_rfc3339, parse_rfc3339_to_micros}
use app.test_runner_new.test_db_types.*

# ============================================================================
# Test Group 1: RFC3339 Timestamp Helpers
# ============================================================================

describe "micros_to_rfc3339":
    it "formats zero as 1970 epoch":
        val ts = micros_to_rfc3339(0)
        expect(ts.starts_with("1970-")).to_equal(true)
        expect(ts.ends_with("Z")).to_equal(true)

    it "produces valid RFC3339 format":
        val ts = micros_to_rfc3339(1000000)
        expect(ts.len()).to_equal(20)
        expect(ts[4:5]).to_equal("-")
        expect(ts[10:11]).to_equal("T")
        expect(ts[19:20]).to_equal("Z")

    it "handles large timestamp":
        val ts = micros_to_rfc3339(1700000000000000)
        expect(ts.starts_with("202")).to_equal(true)

    it "pads single digit month":
        val ts = micros_to_rfc3339(100000000)
        expect(ts[5:7]).to_equal("01")

    it "pads single digit day":
        val ts = micros_to_rfc3339(100000000)
        val day_part = ts[8:10]
        expect(day_part.len()).to_equal(2)

describe "parse_rfc3339_to_micros":
    it "returns 0 for too-short string":
        expect(parse_rfc3339_to_micros("short")).to_equal(0)

    it "returns 0 for empty string":
        expect(parse_rfc3339_to_micros("")).to_equal(0)

    # Note: Full parsing tests with valid timestamps are in test_db_compiled_spec
    # due to str/text type resolution limitations in interpreter

# ============================================================================
# Test Group 2: Edge Cases
# ============================================================================

describe "timestamp edge cases":
    it "handles negative microseconds":
        val ts = micros_to_rfc3339(-1000000)
        expect(ts.contains("T")).to_equal(true)

    it "handles very large year":
        val ts = micros_to_rfc3339(999999999999999)
        expect(ts.len()).to_equal(20)

    it "parse handles malformed timestamp":
        val micros = parse_rfc3339_to_micros("not-a-timestamp")
        expect(micros >= 0).to_equal(true)

    it "parse handles partial timestamp":
        val micros = parse_rfc3339_to_micros("2026-01-15")
        expect(micros).to_equal(0)

# ============================================================================
# Test Group 3: Timing Record Types
# ============================================================================

describe "TimingRun":
    it "can be created with all fields":
        val run = TimingRun(
            test_id: 42,
            timestamp: "2026-01-01T00:00:00Z",
            duration_ms: 123.45,
            outlier: false
        )
        expect(run.test_id).to_equal(42)
        expect(run.duration_ms).to_equal(123.45)
        expect(run.outlier).to_equal(false)

    it "can mark as outlier":
        val run = TimingRun(
            test_id: 1,
            timestamp: "",
            duration_ms: 9999.0,
            outlier: true
        )
        expect(run.outlier).to_equal(true)

describe "TimingSummary extended fields":
    it "has baseline fields":
        val summary = TimingSummary(
            test_id: 0, last_ms: 100.0, p50: 95.0, p90: 110.0,
            p95: 120.0, baseline_median: 90.0,
            p99: 130.0, min_time: 80.0, max_time: 140.0, iqr: 15.0,
            mean: 98.0, std_dev: 12.0, cv_pct: 12.2,
            baseline_mean: 95.0, baseline_std_dev: 10.0, baseline_cv_pct: 10.5,
            baseline_last_updated: "2026-01-01T00:00:00Z",
            baseline_run_count: 10, baseline_update_reason: "initial"
        )
        expect(summary.baseline_mean).to_equal(95.0)
        expect(summary.baseline_run_count).to_equal(10)
        expect(summary.baseline_update_reason).to_equal("initial")

# ============================================================================
# Test Group 4: RunRecord
# ============================================================================

describe "RunRecord":
    it "can be created with all fields":
        val run = RunRecord(
            run_id: "run_123",
            start_time: "2026-01-01T00:00:00Z",
            end_time: "2026-01-01T00:01:00Z",
            pid: 1234,
            hostname: "myhost",
            status: "completed",
            test_count: 50,
            passed: 48,
            failed: 2,
            crashed: 0,
            timed_out: 0
        )
        expect(run.run_id).to_equal("run_123")
        expect(run.status).to_equal("completed")
        expect(run.test_count).to_equal(50)

    it "tracks running status":
        val run = RunRecord(
            run_id: "run_456",
            start_time: "",
            end_time: "",
            pid: 0,
            hostname: "",
            status: "running",
            test_count: 0,
            passed: 0,
            failed: 0,
            crashed: 0,
            timed_out: 0
        )
        expect(run.status).to_equal("running")

    it "tracks crashed status":
        val run = RunRecord(
            run_id: "run_789",
            start_time: "",
            end_time: "",
            pid: 0,
            hostname: "",
            status: "crashed",
            test_count: 0,
            passed: 0,
            failed: 0,
            crashed: 0,
            timed_out: 0
        )
        expect(run.status).to_equal("crashed")

# ============================================================================
# Test Group 5: ChangeEvent
# ============================================================================

describe "ChangeEvent":
    it "records change type":
        val event = ChangeEvent(
            test_id: 42,
            change_type: "pass_to_fail",
            run_id: "run_123"
        )
        expect(event.change_type).to_equal("pass_to_fail")

    it "links to run":
        val event = ChangeEvent(
            test_id: 1,
            change_type: "fail_to_pass",
            run_id: "run_456"
        )
        expect(event.run_id).to_equal("run_456")

# ============================================================================
# Test Group 6: TimingConfig
# ============================================================================

describe "TimingConfig.defaults":
    it "has sensible max_runs_per_test":
        val config = TimingConfig__defaults()
        expect(config.max_runs_per_test).to_equal(10)

    it "has reasonable baseline threshold":
        val config = TimingConfig__defaults()
        expect(config.baseline_change_threshold).to_equal(0.10)

    it "has IQR multiplier":
        val config = TimingConfig__defaults()
        expect(config.outlier_iqr_multiplier).to_equal(1.5)
