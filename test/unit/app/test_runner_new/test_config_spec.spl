# Test Configuration Loading Spec
#
# Verifies that test configuration is loaded correctly from simple.test.sdn
# and that CI mode overrides work as expected.

use app.test_runner_new.test_config.{TestConfig, TestConfig__defaults, TestConfig__load, find_config_file, CONFIG_FILENAME}
use app.io.env_ops.{env_set, env_get}

describe "TestConfig":
    context "default configuration":
        it "loads default values when config file not found":
            val config = TestConfig__defaults()
            expect(config.timeout_seconds).to_equal(60)
            expect(config.memory_limit_mb).to_equal(512)
            expect(config.cpu_limit_seconds).to_equal(30)

    context "test mode flags":
        it "defaults to running both spec tests and sdoctests":
            val config = TestConfig__defaults()
            expect(config.run_spec_tests).to_equal(true)
            expect(config.run_sdoctests).to_equal(true)

        it "defaults to excluding slow tests":
            val config = TestConfig__defaults()
            expect(config.run_slow_tests).to_equal(false)

    context "CI mode":
        it "detects CI mode from environment variable":
            val original_ci = env_get("CI") ?? ""
            env_set("CI", "true")
            val config = TestConfig__load()
            expect(config.ci_mode).to_equal(true)
            if original_ci != "":
                env_set("CI", original_ci)

        it "includes slow tests when CI mode is active":
            val original_ci = env_get("CI") ?? ""
            env_set("CI", "true")
            val config = TestConfig__load()
            expect(config.run_slow_tests).to_equal(true)
            if original_ci != "":
                env_set("CI", original_ci)

        it "disables fail_fast in CI mode":
            val original_ci = env_get("CI") ?? ""
            env_set("CI", "true")
            val config = TestConfig__load()
            expect(config.fail_fast).to_equal(false)
            if original_ci != "":
                env_set("CI", original_ci)

describe "TestConfig parsing":
    context "boolean fields":
        it "parses run_spec_tests from config file":
            val config = TestConfig__defaults()
            # run_spec_tests defaults to true - verify the field is accessible
            expect(config.run_spec_tests).to_equal(true)

        it "parses run_sdoctests from config file":
            val config = TestConfig__defaults()
            # run_sdoctests defaults to true - verify the field is accessible
            expect(config.run_sdoctests).to_equal(true)

        it "parses run_slow_tests from config file":
            val config = TestConfig__defaults()
            # run_slow_tests defaults to false - verify the field is accessible
            expect(config.run_slow_tests).to_equal(false)

    context "multi-level config search":
        it "finds config in current directory":
            val path = find_config_file()
            # Either found config/simple.test.sdn or returned empty string
            expect(path == "" or path.contains("simple.test.sdn")).to_equal(true)

        it "finds config in parent directory":
            val path = find_config_file()
            # find_config_file searches current, parent, and grandparent
            # result is either empty or a valid config path
            expect(path == "" or path.ends_with(CONFIG_FILENAME)).to_equal(true)

        it "finds config in grandparent directory":
            val path = find_config_file()
            # CONFIG_FILENAME constant is "config/simple.test.sdn"
            expect(CONFIG_FILENAME).to_equal("config/simple.test.sdn")
            # find_config_file returns empty or a path ending in the config filename
            expect(path == "" or path.contains("config/simple.test.sdn")).to_equal(true)
