# Dev Tools CLI Commands - SSpec Tests
# Tests for: targets, diff, migrate, watch, brief

use std.spec.{check, check_msg}
use std.string.{NL}

extern fn rt_file_exists(path: text) -> bool

extern fn rt_file_read_text(path: text) -> text

extern fn rt_file_write_text(path: text, content: text) -> bool

extern fn rt_dir_create(path: text, recursive: bool) -> bool

extern fn rt_package_remove_dir_all(path: text) -> i32

val test_dir = "/tmp/simple-test-devtools-cli"

fn cleanup():
    rt_package_remove_dir_all(test_dir)

describe "Dev Tools CLI - targets command":
    it "lists tier 1 targets":
        # Should include x86_64 and aarch64
        check(true)

    it "supports --json output":
        check(true)

describe "Dev Tools CLI - diff command":
    before_each:
        cleanup()
        rt_dir_create(test_dir, true)

    after_each:
        cleanup()

    it "detects identical files":
        rt_file_write_text("{test_dir}/a.spl", "fn hello():{NL}    pass{NL}")
        rt_file_write_text("{test_dir}/b.spl", "fn hello():{NL}    pass{NL}")
        val a = rt_file_read_text("{test_dir}/a.spl") ?? ""
        val b = rt_file_read_text("{test_dir}/b.spl") ?? ""
        check(a == b)

    it "detects differences between files":
        rt_file_write_text("{test_dir}/a.spl", "fn hello():{NL}    pass{NL}")
        rt_file_write_text("{test_dir}/b.spl", "fn hello():{NL}    print \"hello\"{NL}")
        val a = rt_file_read_text("{test_dir}/a.spl") ?? ""
        val b = rt_file_read_text("{test_dir}/b.spl") ?? ""
        check(a != b)

describe "Dev Tools CLI - migrate command":
    before_each:
        cleanup()
        rt_dir_create(test_dir, true)

    after_each:
        cleanup()

    it "migrates if let to if val":
        val code = "fn test():{NL}    if let Some(x) = opt:{NL}        print x{NL}"
        rt_file_write_text("{test_dir}/test.spl", code)
        val content = rt_file_read_text("{test_dir}/test.spl") ?? ""
        check(content.contains("if let "))

    it "migrates [] generics to <> syntax":
        val code = "val opt: Option[Int] = Some(42){NL}"
        rt_file_write_text("{test_dir}/test.spl", code)
        val content = rt_file_read_text("{test_dir}/test.spl") ?? ""
        check(content.contains("Option["))

    it "supports --dry-run flag":
        check(true)

describe "Dev Tools CLI - brief command":
    before_each:
        cleanup()
        rt_dir_create("{test_dir}/src", true)
        rt_file_write_text("{test_dir}/simple.sdn", "package:{NL}  name: test{NL}  version: 0.1.0{NL}")
        rt_file_write_text("{test_dir}/src/main.spl", "fn main():{NL}    print \"hello\"{NL}")

    after_each:
        cleanup()

    it "reads project manifest":
        val manifest = rt_file_read_text("{test_dir}/simple.sdn") ?? ""
        expect manifest.contains("name: test")

    it "scans source files":
        expect rt_file_exists("{test_dir}/src/main.spl")

describe "Dev Tools CLI - watch command":
    it "requires a path argument":
        check(true)

    it "supports --interval flag":
        check(true)
