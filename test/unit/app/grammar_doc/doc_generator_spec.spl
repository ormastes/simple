# Tests for grammar doc generator module
#
# Tests the generation pipeline: SDN parsing, markdown output, treesitter cross-ref

extern fn rt_file_read_text(path: text) -> text
extern fn rt_file_exists(path: text) -> bool

describe "grammar_doc module structure":
    it "mod.spl exists":
        val exists = rt_file_exists("src/app/grammar_doc/mod.spl")
        expect(exists).to_equal(true)

    it "tier_check.spl exists":
        val exists = rt_file_exists("src/app/grammar_doc/tier_check.spl")
        expect(exists).to_equal(true)

    it "tier_check_cli.spl exists":
        val exists = rt_file_exists("src/app/grammar_doc/tier_check_cli.spl")
        expect(exists).to_equal(true)

describe "highlights.scm annotations":
    it "contains tier annotations":
        val content = rt_file_read_text("src/compiler/parser/treesitter/queries/highlights.scm")
        val text_content = content ?? ""
        expect(text_content.contains("; tier: seed")).to_equal(true)
        expect(text_content.contains("; tier: core")).to_equal(true)
        expect(text_content.contains("; tier: full")).to_equal(true)

    it "contains aspirational annotations":
        val content = rt_file_read_text("src/compiler/parser/treesitter/queries/highlights.scm")
        val text_content = content ?? ""
        expect(text_content.contains("; aspirational")).to_equal(true)

    it "has pass_todo keyword":
        val content = rt_file_read_text("src/compiler/parser/treesitter/queries/highlights.scm")
        val text_content = content ?? ""
        expect(text_content.contains("\"pass_todo\"")).to_equal(true)

    it "has pass_do_nothing keyword":
        val content = rt_file_read_text("src/compiler/parser/treesitter/queries/highlights.scm")
        val text_content = content ?? ""
        expect(text_content.contains("\"pass_do_nothing\"")).to_equal(true)

    it "has pass_dn keyword":
        val content = rt_file_read_text("src/compiler/parser/treesitter/queries/highlights.scm")
        val text_content = content ?? ""
        expect(text_content.contains("\"pass_dn\"")).to_equal(true)

    it "has implements keyword":
        val content = rt_file_read_text("src/compiler/parser/treesitter/queries/highlights.scm")
        val text_content = content ?? ""
        expect(text_content.contains("\"implements\"")).to_equal(true)

    it "references tier_keywords.sdn":
        val content = rt_file_read_text("src/compiler/parser/treesitter/queries/highlights.scm")
        val text_content = content ?? ""
        expect(text_content.contains("tier_keywords.sdn")).to_equal(true)

describe "tokens.spl tier annotations":
    it "has tier comments on keywords":
        val content = rt_file_read_text("src/core/tokens.spl")
        val text_content = content ?? ""
        expect(text_content.contains("# tier: seed")).to_equal(true)
        expect(text_content.contains("# tier: core")).to_equal(true)

    it "marks fn as seed tier":
        val content = rt_file_read_text("src/core/tokens.spl")
        val text_content = content ?? ""
        expect(text_content.contains("TOK_KW_FN = 20            # tier: seed")).to_equal(true)

    it "marks trait as core tier":
        val content = rt_file_read_text("src/core/tokens.spl")
        val text_content = content ?? ""
        expect(text_content.contains("TOK_KW_TRAIT = 33         # tier: core")).to_equal(true)

describe "lexer_types.spl tier annotations":
    it "has tier comments":
        val content = rt_file_read_text("src/compiler/lexer_types.spl")
        val text_content = content ?? ""
        expect(text_content.contains("# tier: seed")).to_equal(true)
        expect(text_content.contains("# tier: core")).to_equal(true)
        expect(text_content.contains("# tier: full")).to_equal(true)

    it "marks KwFn as seed":
        val content = rt_file_read_text("src/compiler/lexer_types.spl")
        val text_content = content ?? ""
        expect(text_content.contains("KwFn            # fn           # tier: seed")).to_equal(true)

    it "marks KwTrait as core":
        val content = rt_file_read_text("src/compiler/lexer_types.spl")
        val text_content = content ?? ""
        expect(text_content.contains("KwTrait         # trait        # tier: core")).to_equal(true)

    it "marks KwActor as full":
        val content = rt_file_read_text("src/compiler/lexer_types.spl")
        val text_content = content ?? ""
        expect(text_content.contains("KwActor         # actor        # tier: full")).to_equal(true)

describe "grammar doc CLI registration":
    it "grammar-doc case exists in main.spl":
        val content = rt_file_read_text("src/app/cli/main.spl")
        val text_content = content ?? ""
        expect(text_content.contains("case \"grammar-doc\":")).to_equal(true)

    it "check --tier routes to tier_check_cli":
        val content = rt_file_read_text("src/app/cli/main.spl")
        val text_content = content ?? ""
        expect(text_content.contains("tier_check_cli.spl")).to_equal(true)
