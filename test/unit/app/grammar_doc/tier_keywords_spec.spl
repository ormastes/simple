# Tests for tier_keywords.sdn structure and grammar_doc module
#
# Validates that the SDN source of truth is well-formed and
# the grammar doc generator produces correct output.

extern fn rt_file_read_text(path: text) -> text
extern fn rt_file_exists(path: text) -> bool

describe "tier_keywords.sdn":
    it "exists at expected path":
        val found = rt_file_exists("doc/spec/grammar/tier_keywords.sdn")
        expect(found).to_equal(true)

    it "is non-empty":
        val content = rt_file_read_text("doc/spec/grammar/tier_keywords.sdn")
        val text_content = content ?? ""
        expect(text_content.len() > 0).to_equal(true)

    it "contains keywords.declarations section":
        val content = rt_file_read_text("doc/spec/grammar/tier_keywords.sdn")
        val text_content = content ?? ""
        expect(text_content.contains("[keywords.declarations]")).to_equal(true)

    it "contains keywords.control_flow section":
        val content = rt_file_read_text("doc/spec/grammar/tier_keywords.sdn")
        val text_content = content ?? ""
        expect(text_content.contains("[keywords.control_flow]")).to_equal(true)

    it "contains keywords.expressions section":
        val content = rt_file_read_text("doc/spec/grammar/tier_keywords.sdn")
        val text_content = content ?? ""
        expect(text_content.contains("[keywords.expressions]")).to_equal(true)

    it "contains operators section":
        val content = rt_file_read_text("doc/spec/grammar/tier_keywords.sdn")
        val text_content = content ?? ""
        expect(text_content.contains("[operators]")).to_equal(true)

    it "contains constructs section":
        val content = rt_file_read_text("doc/spec/grammar/tier_keywords.sdn")
        val text_content = content ?? ""
        expect(text_content.contains("[constructs]")).to_equal(true)

    it "classifies fn as seed":
        val content = rt_file_read_text("doc/spec/grammar/tier_keywords.sdn")
        val text_content = content ?? ""
        expect(text_content.contains("fn = \"seed\"")).to_equal(true)

    it "classifies trait as core":
        val content = rt_file_read_text("doc/spec/grammar/tier_keywords.sdn")
        val text_content = content ?? ""
        expect(text_content.contains("trait = \"core\"")).to_equal(true)

    it "classifies actor as full":
        val content = rt_file_read_text("doc/spec/grammar/tier_keywords.sdn")
        val text_content = content ?? ""
        expect(text_content.contains("actor = \"full\"")).to_equal(true)

    it "classifies try as full":
        val content = rt_file_read_text("doc/spec/grammar/tier_keywords.sdn")
        val text_content = content ?? ""
        expect(text_content.contains("try = \"full\"")).to_equal(true)

    it "has treesitter_aspirational section":
        val content = rt_file_read_text("doc/spec/grammar/tier_keywords.sdn")
        val text_content = content ?? ""
        expect(text_content.contains("[treesitter_aspirational]")).to_equal(true)

describe "tier_keywords.sdn content validation":
    it "all seed keywords are present":
        val content = rt_file_read_text("doc/spec/grammar/tier_keywords.sdn")
        val text_content = content ?? ""
        # Check core seed keywords exist
        expect(text_content.contains("val = \"seed\"")).to_equal(true)
        expect(text_content.contains("var = \"seed\"")).to_equal(true)
        expect(text_content.contains("struct = \"seed\"")).to_equal(true)
        expect(text_content.contains("if = \"seed\"")).to_equal(true)
        expect(text_content.contains("for = \"seed\"")).to_equal(true)
        expect(text_content.contains("return = \"seed\"")).to_equal(true)

    it "all core keywords are present":
        val content = rt_file_read_text("doc/spec/grammar/tier_keywords.sdn")
        val text_content = content ?? ""
        expect(text_content.contains("loop = \"core\"")).to_equal(true)
        expect(text_content.contains("pass = \"core\"")).to_equal(true)
        expect(text_content.contains("self = \"core\"")).to_equal(true)
        expect(text_content.contains("async = \"core\"")).to_equal(true)

    it "contains all three tier values":
        val content = rt_file_read_text("doc/spec/grammar/tier_keywords.sdn")
        val text_content = content ?? ""
        # Verify that all three tier values appear in the file
        expect(text_content.contains("= \"seed\"")).to_equal(true)
        expect(text_content.contains("= \"core\"")).to_equal(true)
        expect(text_content.contains("= \"full\"")).to_equal(true)
