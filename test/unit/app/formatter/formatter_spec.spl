# @Feature 702.1: Simple formatter
# @Description: Test the Simple language canonical formatter

use app.formatter.main.FormatConfig
use std.string.{NL}
use app.formatter.main.Formatter

# ============================================================================
# FormatConfig
# ============================================================================

describe "FormatConfig":
    it "creates default configuration via static method":
        val config = FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8)
        expect config.indent_size == 4
        expect config.max_line_length == 100
        expect config.use_tabs == false
        expect config.blank_lines_between_items == 2
        expect config.continuation_indent == 8

    it "creates custom configuration":
        val config = FormatConfig(
            indent_size: 2,
            max_line_length: 80,
            use_tabs: true,
            blank_lines_between_items: 1,
            continuation_indent: 4
        )
        expect config.indent_size == 2
        expect config.max_line_length == 80
        expect config.use_tabs == true

# ============================================================================
# Formatter creation
# ============================================================================

describe "Formatter creation":
    it "creates with default config":
        val config = FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8)
        val formatter = Formatter(indent_level: 0, config: config)
        expect formatter.indent_level == 0

    it "creates via direct construction":
        val config = FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8)
        val formatter = Formatter(config: config, indent_level: 0)
        expect formatter.config.indent_size == 4

# ============================================================================
# Expression spacing
# ============================================================================

describe "add_expression_spacing":
    it "adds spaces around arithmetic operators":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        expect f.add_expression_spacing("x+y") == "x + y"
        expect f.add_expression_spacing("x-y") == "x - y"
        expect f.add_expression_spacing("x*y") == "x * y"
        expect f.add_expression_spacing("x/y") == "x / y"

    it "adds spaces around comparison operators":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        expect f.add_expression_spacing("x==y") == "x == y"
        expect f.add_expression_spacing("x!=y") == "x != y"
        expect f.add_expression_spacing("x<=y") == "x <= y"
        expect f.add_expression_spacing("x>=y") == "x >= y"

    it "preserves arrow operator":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.add_expression_spacing("fn()->i64")
        expect result.contains(" -> ")

    it "preserves fat arrow operator":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.add_expression_spacing("x=>y")
        expect result.contains(" => ")

    it "handles multiple operators":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.add_expression_spacing("x+y*z")
        expect result == "x + y * z"

    it "preserves already-spaced expressions":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        expect f.add_expression_spacing("x + y") == "x + y"

    it "cleans up parentheses spacing":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.add_expression_spacing("f(x,y)")
        expect result.contains("(")
        expect result.contains(")")

    it "removes spaces around dots":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.add_expression_spacing("obj . method()")
        expect not result.contains(" .")
        expect not result.contains(". ")

# ============================================================================
# Leading spaces / indentation
# ============================================================================

describe "count_leading_spaces":
    it "counts spaces correctly":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        expect f.count_leading_spaces("hello") == 0
        expect f.count_leading_spaces("    hello") == 4
        expect f.count_leading_spaces("        hello") == 8

    it "handles empty string":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        expect f.count_leading_spaces("") == 0

    it "handles all-spaces string":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        expect f.count_leading_spaces("    ") == 4

# ============================================================================
# Definition detection
# ============================================================================

describe "is_definition":
    it "detects all definition types":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        expect f.is_definition("fn foo():")
        expect f.is_definition("class Foo:")
        expect f.is_definition("struct Point:")
        expect f.is_definition("enum Color:")
        expect f.is_definition("trait Drawable:")
        expect f.is_definition("impl Point:")

    it "rejects non-definitions":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        expect not f.is_definition("val x = 5")
        expect not f.is_definition("return 42")
        expect not f.is_definition("if x > 0:")

# ============================================================================
# Indent/Dedent detection
# ============================================================================

describe "is_indent_line":
    it "detects lines ending with colon":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        expect f.is_indent_line("if x > 0:")
        expect f.is_indent_line("for item in items:")
        expect f.is_indent_line("while true:")
        expect f.is_indent_line("fn test():")
        expect f.is_indent_line("class Foo:")

    it "detects lines ending with open brackets":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        expect f.is_indent_line("val x = [")
        expect f.is_indent_line("fn test(")

    it "rejects non-indent lines":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        expect not f.is_indent_line("val x = 5")
        expect not f.is_indent_line("return 42")

describe "is_dedent_line":
    it "detects dedent keywords":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        expect f.is_dedent_line("else:")
        expect f.is_dedent_line("elif x > 5:")
        expect f.is_dedent_line("except:")
        expect f.is_dedent_line("finally:")

    it "detects closing brackets":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        expect f.is_dedent_line(")")
        expect f.is_dedent_line("]")

    it "rejects non-dedent lines":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        expect not f.is_dedent_line("val x = 5")
        expect not f.is_dedent_line("if x:")

# ============================================================================
# Method chain detection
# ============================================================================

describe "is_method_chain":
    it "detects chains with 2+ dots":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        expect f.is_method_chain("a.b.c")
        expect f.is_method_chain("obj.method1().method2()")

    it "rejects single dot or no dots":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        expect not f.is_method_chain("obj.method()")
        expect not f.is_method_chain("function()")
        expect not f.is_method_chain("val x = 5")

# ============================================================================
# Method chain breaking
# ============================================================================

describe "break_method_chain":
    it "breaks chain into multiple lines":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.break_method_chain("obj.method1().method2()", "", "    ")
        expect result.len() == 3

    it "first line has no dot":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.break_method_chain("obj.method1().method2()", "", "    ")
        expect result[0] == "obj"

    it "continuation lines start with dot":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.break_method_chain("obj.a().b()", "", "    ")
        expect result[1].contains(".")
        expect result[2].contains(".")

    it "applies indent to first line":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.break_method_chain("obj.a().b()", "  ", "      ")
        expect result[0].starts_with("  ")

# ============================================================================
# Trailing comma removal
# ============================================================================

describe "remove_trailing_comma":
    it "removes trailing comma from last line":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.remove_trailing_comma(["a,", "b,"])
        expect result[0] == "a,"
        expect result[1] == "b"

    it "preserves list without trailing comma":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.remove_trailing_comma(["a,", "b"])
        expect result[0] == "a,"
        expect result[1] == "b"

    it "handles single element":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.remove_trailing_comma(["a,"])
        # Single element list - len <= 1, so no change
        expect result[0] == "a,"

    it "handles empty list":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val lines: List<String> = []
        val result = f.remove_trailing_comma(lines)
        expect result.len() == 0

# ============================================================================
# Line breaking
# ============================================================================

describe "break_long_line":
    it "breaks method chains":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.break_long_line("obj.method1().method2().method3()", 0)
        expect result.len() > 1

    it "breaks function calls with parens":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.break_long_line("function(arg1, arg2, arg3)", 0)
        expect result.len() >= 1

    it "breaks at operators as fallback":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.break_long_line("a and b or c", 0)
        expect result.len() >= 1

    it "respects base indentation":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.break_long_line("obj.a().b()", 2)
        expect result[0].starts_with("        ")

describe "break_at_operators":
    it "breaks at logical operators":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.break_at_operators("x and y", "", "    ")
        expect result.len() == 2

    it "breaks at arithmetic operators":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.break_at_operators("a + b", "", "    ")
        expect result.len() == 2

    it "returns single line when no operator found":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.break_at_operators("simple_value", "", "    ")
        expect result.len() == 1

# ============================================================================
# format_line
# ============================================================================

describe "format_line":
    it "applies indentation":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.format_line("val x = 5", 1)
        expect result.len() == 1
        expect result[0].starts_with("    ")

    it "returns short line unchanged (with indent)":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.format_line("val x = 5", 0)
        expect result.len() == 1

# ============================================================================
# fix_indentation
# ============================================================================

describe "fix_indentation":
    it "normalizes indentation for flat code":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.fix_indentation("val x = 5")
        expect result.contains("val x = 5")

    it "preserves empty lines":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.fix_indentation("val x = 5{NL}{NL}val y = 10")
        expect result.contains("")

    it "indents after colon":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.fix_indentation("if true:{NL}    val x = 5")
        expect result.contains("    ")

# ============================================================================
# format_source integration
# ============================================================================

describe "format_source":
    it "formats simple code":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.format_source("val x=5")
        match result:
            Ok(formatted):
                expect formatted.len() > 0
            Err(e):
                expect false

    it "sorts imports alphabetically":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.format_source("import z{NL}import a{NL}import m")
        match result:
            Ok(formatted):
                val lines = formatted.split(NL)
                expect lines[0].contains("import a")
            Err(e):
                expect false

    it "handles empty source":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.format_source("")
        match result:
            Ok(formatted):
                expect formatted.len() >= 0
            Err(e):
                expect false

    it "handles code with no imports":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.format_source("val x = 5{NL}val y = 10")
        match result:
            Ok(formatted):
                expect formatted.contains("x")
            Err(e):
                expect false

    it "adds blank lines between imports and code":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.format_source("import a{NL}val x = 5")
        match result:
            Ok(formatted):
                expect formatted.contains("import a")
                expect formatted.contains("x")
            Err(e):
                expect false

# ============================================================================
# Comma fixing stubs (currently no-op, verify they don't break input)
# ============================================================================

describe "fix_missing_commas":
    it "preserves already-correct code":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.fix_missing_commas("[1, 2, 3]")
        expect result == "[1, 2, 3]"

    it "preserves correct function params":
        val f = Formatter(indent_level: 0, config: FormatConfig(indent_size: 4, max_line_length: 100, use_tabs: false, blank_lines_between_items: 2, continuation_indent: 8))
        val result = f.fix_missing_commas("fn test(a: Int, b: Int):")
        expect result == "fn test(a: Int, b: Int):"
