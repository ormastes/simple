# Project CLI Commands - SSpec Tests
# Tests for: init, env, query, qualify-ignore

use std.spec.{check, check_msg}
use std.string.{NL}

extern fn rt_file_exists(path: text) -> bool

extern fn rt_file_read_text(path: text) -> text

extern fn rt_file_write_text(path: text, content: text) -> bool

extern fn rt_dir_create(path: text, recursive: bool) -> bool

extern fn rt_package_remove_dir_all(path: text) -> i32

extern fn rt_package_is_dir(path: text) -> i32

val test_dir = "/tmp/simple-test-project-cli"

fn cleanup():
    rt_package_remove_dir_all(test_dir)

describe "Project CLI - init command":
    before_each:
        cleanup()
        rt_dir_create(test_dir, true)

    after_each:
        cleanup()

    it "creates simple.sdn manifest":
        # Init should create a manifest file
        val manifest = "package:{NL}  name: test-project{NL}  version: 0.1.0{NL}  license: MIT{NL}  main: src/main.spl{NL}"
        rt_file_write_text("{test_dir}/simple.sdn", manifest)
        expect rt_file_exists("{test_dir}/simple.sdn")

    it "creates src directory":
        rt_dir_create("{test_dir}/src", true)
        expect rt_package_is_dir("{test_dir}/src") == 1

    it "creates test directory":
        rt_dir_create("{test_dir}/test", true)
        expect rt_package_is_dir("{test_dir}/test") == 1

    it "refuses to init if simple.sdn exists":
        rt_file_write_text("{test_dir}/simple.sdn", "existing")
        expect rt_file_exists("{test_dir}/simple.sdn")

describe "Project CLI - env command":
    before_each:
        cleanup()
        rt_dir_create(test_dir, true)

    after_each:
        cleanup()

    it "creates environment directory structure":
        val env_dir = "{test_dir}/.simple-env"
        rt_dir_create("{env_dir}/lib", true)
        rt_dir_create("{env_dir}/bin", true)
        rt_dir_create("{env_dir}/simple_modules", true)
        expect rt_package_is_dir("{env_dir}/lib") == 1
        expect rt_package_is_dir("{env_dir}/bin") == 1

    it "creates activation scripts":
        val env_dir = "{test_dir}/.simple-env"
        rt_dir_create(env_dir, true)
        rt_file_write_text("{env_dir}/activate.sh", "export SIMPLE_ENV=test{NL}")
        expect rt_file_exists("{env_dir}/activate.sh")

describe "Project CLI - query command":
    before_each:
        cleanup()
        rt_dir_create("{test_dir}/src", true)
        rt_file_write_text("{test_dir}/src/example.spl", "fn hello():{NL}    print \"hello\"{NL}{NL}fn world():{NL}    # TODO: implement{NL}    pass{NL}")

    after_each:
        cleanup()

    it "finds patterns in source files":
        val content = rt_file_read_text("{test_dir}/src/example.spl") ?? ""
        expect content.contains("fn hello()")
        expect content.contains("TODO")

    it "supports --fn flag for function search":
        val content = rt_file_read_text("{test_dir}/src/example.spl") ?? ""
        # File contains two fn definitions: hello and world
        expect content.contains("fn hello()")
        expect content.contains("fn world()")

describe "Project CLI - qualify-ignore command":
    before_each:
        cleanup()
        rt_dir_create("{test_dir}/test", true)
        rt_file_write_text("{test_dir}/test/example_spec.spl", "describe \"example\":{NL}    #[ignore]{NL}    it \"should work\":{NL}        assert true{NL}{NL}    #[ignore = \"WIP\"]{NL}    it \"should also work\":{NL}        assert true{NL}")

    after_each:
        cleanup()

    it "detects unqualified #[ignore]":
        val content = rt_file_read_text("{test_dir}/test/example_spec.spl") ?? ""
        expect content.contains("#[ignore]")

    it "distinguishes qualified from unqualified":
        val content = rt_file_read_text("{test_dir}/test/example_spec.spl") ?? ""
        # Has both unqualified (#[ignore]) and qualified (#[ignore = "WIP"])
        expect content.contains("#[ignore]")
        expect content.contains("#[ignore = \"WIP\"]")
