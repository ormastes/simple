# Test Runner Argument Parsing Specification
#
# Tests for test_runner_args.spl:
# - parse_mode_str: converts mode string to TestExecutionMode
# - parse_test_args: parses CLI arguments into TestOptions

# =========================================================================
# Local type definitions (mirrors test_runner_types.spl)
# =========================================================================

enum TestExecutionMode:
    Interpreter
    Smf
    Native

enum TestLevel:
    All
    Unit
    Integration
    System

enum OutputFormat:
    Default
    Doc

# =========================================================================
# Local reimplementation of parse_mode_str (pure function)
# =========================================================================

fn parse_mode_str(m: text) -> TestExecutionMode:
    if m == "native" or m == "binary":
        return TestExecutionMode.Native
    if m == "smf" or m == "loader":
        return TestExecutionMode.Smf
    TestExecutionMode.Interpreter

# =========================================================================
# Local reimplementation of parse_test_args (pure function)
# =========================================================================

fn parse_test_args(args: [text]) -> dict:
    var path = ""
    var level = "all"
    var tag = ""
    var fail_fast = false
    var mode = "interpreter"
    var timeout = 120
    var list = false
    var list_ignored = false
    var only_slow = false
    var only_skipped = false
    var show_tags = false
    var gc_log = false
    var gc_off = false
    var seed = 0
    var has_seed = false
    var safe_mode = false
    var force_rebuild = false
    var keep_artifacts = false
    var run_all = false
    var format = "default"
    var list_skip_features = false
    var planned_only = false
    var no_limits = false
    var sdoctest = false
    var sdoctest_env = ""
    var sdoctest_force = false
    var no_db = false
    var verbose = false
    var coverage = false

    var i = 0
    while i < args.len():
        val arg = args[i]
        if arg == "--unit":
            level = "unit"
        elif arg == "--integration":
            level = "integration"
        elif arg == "--system":
            level = "system"
        elif arg == "--fail-fast":
            fail_fast = true
        elif arg == "--list":
            list = true
        elif arg == "--list-ignored":
            list = true
            list_ignored = true
        elif arg == "--only-slow":
            only_slow = true
        elif arg == "--only-skipped":
            only_skipped = true
        elif arg == "--show-tags":
            show_tags = true
        elif arg == "--gc-log":
            gc_log = true
        elif arg == "--gc=off" or arg == "--gc=OFF":
            gc_off = true
        elif arg == "--safe-mode" or arg == "--safe":
            safe_mode = true
        elif arg == "--force-rebuild":
            force_rebuild = true
        elif arg == "--keep-artifacts":
            keep_artifacts = true
        elif arg == "--all":
            run_all = true
        elif arg == "--list-skip-features" or arg == "--skip-features":
            list_skip_features = true
            only_skipped = true
            list = true
        elif arg == "--planned-only" or arg == "--pending":
            planned_only = true
        elif arg == "--no-limits":
            no_limits = true
        elif arg == "--no-db":
            no_db = true
        elif arg == "--verbose" or arg == "-v":
            verbose = true
        elif arg == "--quick" or arg == "-q":
            no_db = true
        elif arg == "--coverage":
            coverage = true
        elif arg == "--sdoctest":
            sdoctest = true
        elif arg == "--sdoctest-force":
            sdoctest_force = true
        elif arg.starts_with("--sdoctest-env="):
            sdoctest_env = arg[15:]
        elif arg == "--sdoctest-env":
            i = i + 1
            if i < args.len():
                sdoctest_env = args[i]
        elif arg == "--tag":
            i = i + 1
            if i < args.len():
                tag = args[i]
        elif arg == "--doc":
            format = "doc"
        elif arg == "--format":
            i = i + 1
            if i < args.len():
                if args[i] == "doc":
                    format = "doc"
        elif arg == "--mode":
            i = i + 1
            if i < args.len():
                mode = args[i]
        elif arg.starts_with("--mode="):
            mode = arg.replace("--mode=", "")
        elif arg == "--timeout":
            i = i + 1
            if i < args.len():
                timeout = int(args[i])
        elif arg == "--seed":
            i = i + 1
            if i < args.len():
                seed = int(args[i])
                has_seed = true
        elif not arg.starts_with("-"):
            if path == "":
                path = arg
        i = i + 1

    if path == "":
        path = "test/"

    var result = {}
    result["path"] = path
    result["level"] = level
    result["tag"] = tag
    result["fail_fast"] = fail_fast
    result["mode"] = mode
    result["timeout"] = timeout
    result["list"] = list
    result["list_ignored"] = list_ignored
    result["only_slow"] = only_slow
    result["only_skipped"] = only_skipped
    result["show_tags"] = show_tags
    result["gc_log"] = gc_log
    result["gc_off"] = gc_off
    result["seed"] = seed
    result["has_seed"] = has_seed
    result["safe_mode"] = safe_mode
    result["force_rebuild"] = force_rebuild
    result["keep_artifacts"] = keep_artifacts
    result["run_all"] = run_all
    result["format"] = format
    result["list_skip_features"] = list_skip_features
    result["planned_only"] = planned_only
    result["no_limits"] = no_limits
    result["sdoctest"] = sdoctest
    result["sdoctest_env"] = sdoctest_env
    result["sdoctest_force"] = sdoctest_force
    result["no_db"] = no_db
    result["verbose"] = verbose
    result["coverage"] = coverage
    result

# =========================================================================
# Tests
# =========================================================================

describe "parse_mode_str":
    it "parses native mode":
        val mode = parse_mode_str("native")
        expect(mode == TestExecutionMode.Native).to_equal(true)

    it "parses binary as native mode":
        val mode = parse_mode_str("binary")
        expect(mode == TestExecutionMode.Native).to_equal(true)

    it "parses smf mode":
        val mode = parse_mode_str("smf")
        expect(mode == TestExecutionMode.Smf).to_equal(true)

    it "parses loader as smf mode":
        val mode = parse_mode_str("loader")
        expect(mode == TestExecutionMode.Smf).to_equal(true)

    it "defaults to Interpreter for unknown string":
        val mode = parse_mode_str("unknown")
        expect(mode == TestExecutionMode.Interpreter).to_equal(true)

    it "defaults to Interpreter for empty string":
        val mode = parse_mode_str("")
        expect(mode == TestExecutionMode.Interpreter).to_equal(true)

    it "defaults to Interpreter for interpreter string":
        val mode = parse_mode_str("interpreter")
        expect(mode == TestExecutionMode.Interpreter).to_equal(true)

    it "is case-sensitive (NATIVE does not match)":
        val mode = parse_mode_str("NATIVE")
        expect(mode == TestExecutionMode.Interpreter).to_equal(true)

    it "is case-sensitive (Smf does not match)":
        val mode = parse_mode_str("Smf")
        expect(mode == TestExecutionMode.Interpreter).to_equal(true)

describe "parse_test_args":
    describe "default values":
        it "uses test/ as default path":
            val opts = parse_test_args([])
            expect(opts["path"]).to_equal("test/")

        it "defaults level to all":
            val opts = parse_test_args([])
            expect(opts["level"]).to_equal("all")

        it "defaults tag to empty":
            val opts = parse_test_args([])
            expect(opts["tag"]).to_equal("")

        it "defaults fail_fast to false":
            val opts = parse_test_args([])
            expect(opts["fail_fast"]).to_equal(false)

        it "defaults mode to interpreter":
            val opts = parse_test_args([])
            expect(opts["mode"]).to_equal("interpreter")

        it "defaults timeout to 120":
            val opts = parse_test_args([])
            expect(opts["timeout"]).to_equal(120)

        it "defaults list to false":
            val opts = parse_test_args([])
            expect(opts["list"]).to_equal(false)

        it "defaults verbose to false":
            val opts = parse_test_args([])
            expect(opts["verbose"]).to_equal(false)

        it "defaults coverage to false":
            val opts = parse_test_args([])
            expect(opts["coverage"]).to_equal(false)

        it "defaults no_db to false":
            val opts = parse_test_args([])
            expect(opts["no_db"]).to_equal(false)

    describe "path argument":
        it "accepts positional path argument":
            val opts = parse_test_args(["test/unit/"])
            expect(opts["path"]).to_equal("test/unit/")

        it "accepts file path as argument":
            val opts = parse_test_args(["test/my_spec.spl"])
            expect(opts["path"]).to_equal("test/my_spec.spl")

        it "ignores second positional argument":
            val opts = parse_test_args(["first/path", "second/path"])
            expect(opts["path"]).to_equal("first/path")

    describe "level flags":
        it "parses --unit flag":
            val opts = parse_test_args(["--unit"])
            expect(opts["level"]).to_equal("unit")

        it "parses --integration flag":
            val opts = parse_test_args(["--integration"])
            expect(opts["level"]).to_equal("integration")

        it "parses --system flag":
            val opts = parse_test_args(["--system"])
            expect(opts["level"]).to_equal("system")

    describe "boolean flags":
        it "parses --fail-fast":
            val opts = parse_test_args(["--fail-fast"])
            expect(opts["fail_fast"]).to_equal(true)

        it "parses --list":
            val opts = parse_test_args(["--list"])
            expect(opts["list"]).to_equal(true)

        it "parses --list-ignored sets both list and list_ignored":
            val opts = parse_test_args(["--list-ignored"])
            expect(opts["list"]).to_equal(true)
            expect(opts["list_ignored"]).to_equal(true)

        it "parses --only-slow":
            val opts = parse_test_args(["--only-slow"])
            expect(opts["only_slow"]).to_equal(true)

        it "parses --only-skipped":
            val opts = parse_test_args(["--only-skipped"])
            expect(opts["only_skipped"]).to_equal(true)

        it "parses --show-tags":
            val opts = parse_test_args(["--show-tags"])
            expect(opts["show_tags"]).to_equal(true)

        it "parses --gc-log":
            val opts = parse_test_args(["--gc-log"])
            expect(opts["gc_log"]).to_equal(true)

        it "parses --gc=off":
            val opts = parse_test_args(["--gc=off"])
            expect(opts["gc_off"]).to_equal(true)

        it "parses --gc=OFF":
            val opts = parse_test_args(["--gc=OFF"])
            expect(opts["gc_off"]).to_equal(true)

        it "parses --safe-mode":
            val opts = parse_test_args(["--safe-mode"])
            expect(opts["safe_mode"]).to_equal(true)

        it "parses --safe as alias for safe-mode":
            val opts = parse_test_args(["--safe"])
            expect(opts["safe_mode"]).to_equal(true)

        it "parses --force-rebuild":
            val opts = parse_test_args(["--force-rebuild"])
            expect(opts["force_rebuild"]).to_equal(true)

        it "parses --keep-artifacts":
            val opts = parse_test_args(["--keep-artifacts"])
            expect(opts["keep_artifacts"]).to_equal(true)

        it "parses --all":
            val opts = parse_test_args(["--all"])
            expect(opts["run_all"]).to_equal(true)

        it "parses --no-limits":
            val opts = parse_test_args(["--no-limits"])
            expect(opts["no_limits"]).to_equal(true)

        it "parses --no-db":
            val opts = parse_test_args(["--no-db"])
            expect(opts["no_db"]).to_equal(true)

        it "parses --verbose":
            val opts = parse_test_args(["--verbose"])
            expect(opts["verbose"]).to_equal(true)

        it "parses -v as alias for verbose":
            val opts = parse_test_args(["-v"])
            expect(opts["verbose"]).to_equal(true)

        it "parses --quick sets no_db":
            val opts = parse_test_args(["--quick"])
            expect(opts["no_db"]).to_equal(true)

        it "parses -q as alias for quick":
            val opts = parse_test_args(["-q"])
            expect(opts["no_db"]).to_equal(true)

        it "parses --coverage":
            val opts = parse_test_args(["--coverage"])
            expect(opts["coverage"]).to_equal(true)

    describe "sdoctest flags":
        it "parses --sdoctest":
            val opts = parse_test_args(["--sdoctest"])
            expect(opts["sdoctest"]).to_equal(true)

        it "parses --sdoctest-force":
            val opts = parse_test_args(["--sdoctest-force"])
            expect(opts["sdoctest_force"]).to_equal(true)

        it "parses --sdoctest-env= with equals syntax":
            val opts = parse_test_args(["--sdoctest-env=production"])
            expect(opts["sdoctest_env"]).to_equal("production")

        it "parses --sdoctest-env with next arg":
            val opts = parse_test_args(["--sdoctest-env", "staging"])
            expect(opts["sdoctest_env"]).to_equal("staging")

    describe "skip features flags":
        it "parses --list-skip-features sets list, only_skipped, and list_skip_features":
            val opts = parse_test_args(["--list-skip-features"])
            expect(opts["list_skip_features"]).to_equal(true)
            expect(opts["only_skipped"]).to_equal(true)
            expect(opts["list"]).to_equal(true)

        it "parses --skip-features as alias":
            val opts = parse_test_args(["--skip-features"])
            expect(opts["list_skip_features"]).to_equal(true)
            expect(opts["only_skipped"]).to_equal(true)
            expect(opts["list"]).to_equal(true)

    describe "planned/pending flags":
        it "parses --planned-only":
            val opts = parse_test_args(["--planned-only"])
            expect(opts["planned_only"]).to_equal(true)

        it "parses --pending as alias for planned-only":
            val opts = parse_test_args(["--pending"])
            expect(opts["planned_only"]).to_equal(true)

    describe "value arguments":
        it "parses --tag with next arg":
            val opts = parse_test_args(["--tag", "integration"])
            expect(opts["tag"]).to_equal("integration")

        it "parses --doc format":
            val opts = parse_test_args(["--doc"])
            expect(opts["format"]).to_equal("doc")

        it "parses --format doc":
            val opts = parse_test_args(["--format", "doc"])
            expect(opts["format"]).to_equal("doc")

        it "parses --mode with next arg":
            val opts = parse_test_args(["--mode", "native"])
            expect(opts["mode"]).to_equal("native")

        it "parses --mode= with equals syntax":
            val opts = parse_test_args(["--mode=smf"])
            expect(opts["mode"]).to_equal("smf")

        it "parses --timeout with next arg":
            val opts = parse_test_args(["--timeout", "300"])
            expect(opts["timeout"]).to_equal(300)

        it "parses --seed with next arg":
            val opts = parse_test_args(["--seed", "42"])
            expect(opts["seed"]).to_equal(42)
            expect(opts["has_seed"]).to_equal(true)

    describe "combined arguments":
        it "parses path with flags":
            val opts = parse_test_args(["test/unit/", "--fail-fast", "--verbose"])
            expect(opts["path"]).to_equal("test/unit/")
            expect(opts["fail_fast"]).to_equal(true)
            expect(opts["verbose"]).to_equal(true)

        it "parses flags before path":
            val opts = parse_test_args(["--fail-fast", "test/my_spec.spl"])
            expect(opts["path"]).to_equal("test/my_spec.spl")
            expect(opts["fail_fast"]).to_equal(true)

        it "parses multiple flags together":
            val opts = parse_test_args(["--unit", "--fail-fast", "--gc-log", "--verbose", "--coverage"])
            expect(opts["level"]).to_equal("unit")
            expect(opts["fail_fast"]).to_equal(true)
            expect(opts["gc_log"]).to_equal(true)
            expect(opts["verbose"]).to_equal(true)
            expect(opts["coverage"]).to_equal(true)

        it "parses sdoctest with env and force":
            val opts = parse_test_args(["--sdoctest", "--sdoctest-env=test", "--sdoctest-force"])
            expect(opts["sdoctest"]).to_equal(true)
            expect(opts["sdoctest_env"]).to_equal("test")
            expect(opts["sdoctest_force"]).to_equal(true)
