# MCP Analysis Tools (Tier 3) Specification
#
# **Feature IDs:** #MCP-ANALYSIS-001
# **Category:** Tooling
# **Difficulty:** 2/5
# **Status:** Implemented
#
# ## Overview
#
# Tests the 4 Tier 3 MCP analysis tool handlers:
# simple_dependencies, simple_api_diff, simple_context, simple_search
#
# ## Behavior
#
# - Dependencies shows imports and reverse deps for a file, or project summary
# - API diff compares public API against git revision
# - Context packs file info for AI consumption
# - Search provides language-aware grep with kind/scope filters

use std.spec

# ============================================================================
# Test Group 1: simple_dependencies tool
# ============================================================================

describe "simple_dependencies tool":
    it "builds import grep for specific file":
        val file = "src/app/cli/main.spl"
        var cmd = "grep -n '^use \\|^import ' " + file + " 2>/dev/null"
        expect(cmd).to_contain("grep")
        expect(cmd).to_contain(file)

    it "works without file for project summary":
        val file = ""
        var is_summary = file == ""
        expect(is_summary).to_equal(true)

# ============================================================================
# Test Group 2: simple_api_diff tool
# ============================================================================

describe "simple_api_diff tool":
    it "requires file parameter":
        val file = ""
        val has_error = file == ""
        expect(has_error).to_equal(true)

    it "defaults revision to HEAD":
        val revision = ""
        var rev = "HEAD"
        if revision != "":
            rev = revision
        expect(rev).to_equal("HEAD")

    it "uses custom revision":
        val revision = "main~5"
        var rev = "HEAD"
        if revision != "":
            rev = revision
        expect(rev).to_equal("main~5")

    it "builds git show command for previous API":
        val file = "src/app/cli/main.spl"
        val rev = "HEAD"
        var cmd = "git show " + rev + ":" + file + " 2>/dev/null | grep -n '^fn \\|^class \\|^struct \\|^enum \\|^export '"
        expect(cmd).to_contain("git show HEAD:")
        expect(cmd).to_contain(file)

# ============================================================================
# Test Group 3: simple_context tool
# ============================================================================

describe "simple_context tool":
    it "requires file parameter":
        val file = ""
        val has_error = file == ""
        expect(has_error).to_equal(true)

    it "includes source, imports, symbols, diagnostics":
        val sections = ["Source", "Imports", "Symbols", "Diagnostics"]
        expect(sections.len()).to_equal(4)

    it "adds target section when specified":
        val target = "main"
        val has_target = target != ""
        expect(has_target).to_equal(true)

# ============================================================================
# Test Group 4: simple_search tool
# ============================================================================

describe "simple_search tool":
    it "requires query parameter":
        val query = ""
        val has_error = query == ""
        expect(has_error).to_equal(true)

    it "builds general search command":
        val query = "fn main"
        val kind = ""
        val scope = ""
        var search_dir = "src/"
        var cmd = "grep -rn '" + query + "' " + search_dir + " --include='*.spl' 2>/dev/null | head -50"
        expect(cmd).to_contain(query)
        expect(cmd).to_contain("src/")

    it "builds function search":
        val query = "main"
        val kind = "fn"
        var cmd = ""
        if kind == "fn":
            cmd = "grep -rn '^fn " + query + "' src/ --include='*.spl' 2>/dev/null | head -50"
        expect(cmd).to_contain("^fn main")

    it "builds class search":
        val query = "Point"
        val kind = "class"
        var cmd = ""
        if kind == "class":
            cmd = "grep -rn '^class " + query + "' src/ --include='*.spl' 2>/dev/null | head -50"
        expect(cmd).to_contain("^class Point")

    it "maps scope to correct directory":
        val scope = "test"
        var search_dir = "src/"
        if scope == "test":
            search_dir = "test/"
        elif scope == "lib":
            search_dir = "src/lib/"
        elif scope == "compiler":
            search_dir = "src/compiler/"
        expect(search_dir).to_equal("test/")

    it "maps lib scope":
        val scope = "lib"
        var search_dir = "src/"
        if scope == "lib":
            search_dir = "src/lib/"
        expect(search_dir).to_equal("src/lib/")

    it "maps compiler scope":
        val scope = "compiler"
        var search_dir = "src/"
        if scope == "compiler":
            search_dir = "src/compiler/"
        expect(search_dir).to_equal("src/compiler/")

    it "restricts to specific file":
        val file = "src/app/cli/main.spl"
        val query = "fn main"
        var cmd = "grep -n '" + query + "' " + file + " 2>/dev/null | head -50"
        expect(cmd).to_contain(file)

    it "builds import search":
        val query = "std.spec"
        val kind = "import"
        var cmd = ""
        if kind == "import":
            cmd = "grep -rn 'use.*" + query + "' src/ --include='*.spl' 2>/dev/null | head -50"
        expect(cmd).to_contain("use.*std.spec")

    it "builds type search":
        val query = "Position"
        val kind = "type"
        var cmd = ""
        if kind == "type":
            cmd = "grep -rn '^type " + query + "' src/ --include='*.spl' 2>/dev/null | head -50"
        expect(cmd).to_contain("^type Position")
