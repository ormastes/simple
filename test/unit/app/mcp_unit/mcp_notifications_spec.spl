# MCP Notification Emission Specification
# Feature: MCP Server Notifications
# Category: MCP, Notifications
# Status: Complete

use std.spec
use std.nogc_async_mut.mcp.helpers.{LB, RB, jp, js, make_notification, make_notification_no_params, make_progress_notification, make_log_notification, make_tools_list_changed, make_resources_list_changed, make_prompts_list_changed, make_resource_updated_notification}

describe "MCP Progress Notifications":
    it "builds progress notification with token":
        val notif = make_progress_notification("tok-1", 50, 100, "Processing")
        expect(notif.contains("\"progressToken\":\"tok-1\"")).to_equal(true)
        expect(notif.contains("\"progress\":50")).to_equal(true)
        expect(notif.contains("\"total\":100")).to_equal(true)

    it "uses correct method":
        val notif = make_progress_notification("tok-1", 0, 10, "Starting")
        expect(notif.contains("notifications/progress")).to_equal(true)

describe "MCP Log Notifications":
    it "builds log notification with level and data":
        val notif = make_log_notification("info", "Server started", "mcp")
        expect(notif.contains("\"level\":\"info\"")).to_equal(true)
        expect(notif.contains("Server started")).to_equal(true)
        expect(notif.contains("\"logger\":\"mcp\"")).to_equal(true)

    it "uses correct method":
        val notif = make_log_notification("error", "fail", "")
        expect(notif.contains("notifications/message")).to_equal(true)

describe "MCP List Changed Notifications":
    it "builds tools list changed":
        val notif = make_tools_list_changed()
        expect(notif.contains("notifications/tools/list_changed")).to_equal(true)

    it "builds resources list changed":
        val notif = make_resources_list_changed()
        expect(notif.contains("notifications/resources/list_changed")).to_equal(true)

    it "builds prompts list changed":
        val notif = make_prompts_list_changed()
        expect(notif.contains("notifications/prompts/list_changed")).to_equal(true)

describe "MCP Resource Updated Notification":
    it "builds with URI":
        val notif = make_resource_updated_notification("file:///test.spl")
        expect(notif.contains("notifications/resources/updated")).to_equal(true)
        expect(notif.contains("file:///test.spl")).to_equal(true)

describe "MCP Generic Notification Building":
    it "builds notification with params":
        val params = LB() + jp("key", js("value")) + RB()
        val notif = make_notification("custom/method", params)
        expect(notif.contains("\"method\":\"custom/method\"")).to_equal(true)

    it "builds notification without params":
        val notif = make_notification_no_params("simple/notify")
        expect(notif.contains("\"method\":\"simple/notify\"")).to_equal(true)
