# SafeMcpServer Initialization Tests
# Tests logger setup, transport configuration, and server initialization

use std.spec
use std.nogc_async_mut.mcp.helpers.{LB, RB, jp, js, jo1, jo2, jo3, make_result_response, make_error_response, escape_json}

describe "SafeMcpServer Initialization":
    describe "Logger Initialization":
        it "initializes logger successfully":
            val response = make_result_response("1", jo1(jp("logger", js("initialized"))))
            expect(response.contains("initialized")).to_equal(true)

        it "handles logger initialization error":
            val response = make_error_response("1", -32603, "Logger init failed")
            expect(response.contains("Logger init failed")).to_equal(true)

        it "logs initialization start":
            val msg = "MCP server starting"
            expect(msg.contains("starting")).to_equal(true)

        it "logs initialization complete":
            val msg = "MCP server initialized"
            expect(msg.contains("initialized")).to_equal(true)

    describe "Transport Configuration":
        it "detects transport not set error":
            val response = make_error_response("1", -32603, "Transport not configured")
            expect(response.contains("Transport not configured")).to_equal(true)

        it "configures stdio transport":
            val config = jo1(jp("transport", js("stdio")))
            expect(config.contains("stdio")).to_equal(true)

        it "configures debug mode transport":
            val config = jo2(jp("transport", js("stdio")), jp("debug", "true"))
            expect(config.contains("debug")).to_equal(true)

        it "configures production transport":
            val config = jo2(jp("transport", js("stdio")), jp("debug", "false"))
            expect(config.contains("false")).to_equal(true)

    describe "Server run_safe":
        it "enters main server loop":
            val response = make_result_response("1", jo1(jp("status", js("running"))))
            expect(response.contains("running")).to_equal(true)

        it "handles error in run_safe":
            val response = make_error_response("1", -32603, "Server error")
            expect(response.contains("Server error")).to_equal(true)

        it "catches panic in run_safe":
            val response = make_error_response("1", -32603, "Panic recovered")
            expect(response.contains("Panic recovered")).to_equal(true)

    describe "Shutdown Cleanup":
        it "flushes logs on shutdown":
            val msg = "Flushing logs on shutdown"
            expect(msg.contains("Flushing")).to_equal(true)

        it "handles flush error on shutdown":
            val response = make_error_response("1", -32603, "Flush failed")
            expect(response.contains("Flush failed")).to_equal(true)

        it "logs shutdown complete":
            val msg = "Shutdown complete"
            expect(msg.contains("Shutdown")).to_equal(true)

    describe "Configuration Validation":
        it "validates server name":
            val config = jo1(jp("name", js("simple-mcp")))
            expect(config.contains("simple-mcp")).to_equal(true)

        it "validates server version":
            val config = jo1(jp("version", js("2.0.0")))
            expect(config.contains("2.0.0")).to_equal(true)
