# MCP Tools Specification
# Feature: MCP Tool Registry and Annotations
# Category: MCP, Tools
# Status: Complete

use std.spec
use std.nogc_async_mut.mcp.helpers.{LB, RB, Q, jp, js, jo1, jo2, jo3, register_tool, make_tool_schema_multi, detect_file_content_type, detect_mime_type}

describe "MCP Tool Registry":
    context "when building tool schemas":
        it "builds tool schema with name and description":
            val schema = register_tool("read_code", "Read a Simple language source file", ["path"], ["File path to read"], ["path"], true, false, true)
            expect(schema.contains("\"name\":\"read_code\"")).to_equal(true)
            expect(schema.contains("Read a Simple language source file")).to_equal(true)

        it "builds tool schema with required params":
            val schema = register_tool("search_code", "Search code", ["query"], ["Search query"], ["query"], true, false, true)
            expect(schema.contains("\"query\"")).to_equal(true)
            expect(schema.contains("\"required\"")).to_equal(true)

    context "when setting tool annotations":
        it "marks read-only tools":
            val schema = register_tool("read_code", "Read file", ["path"], ["Path"], ["path"], true, false, true)
            expect(schema.contains("\"readOnlyHint\":true")).to_equal(true)
            expect(schema.contains("\"destructiveHint\":false")).to_equal(true)

        it "marks idempotent tools":
            val schema = register_tool("file_info", "Get info", ["path"], ["Path"], ["path"], true, false, true)
            expect(schema.contains("\"idempotentHint\":true")).to_equal(true)

        it "marks writable tools":
            val schema = register_tool("bugdb_add", "Add bug", ["bug"], ["Bug data"], ["bug"], false, false, false)
            expect(schema.contains("\"readOnlyHint\":false")).to_equal(true)
            expect(schema.contains("\"idempotentHint\":false")).to_equal(true)

describe "Content Type Detection":
    context "when detecting file content type":
        it "detects images":
            expect(detect_file_content_type("photo.png")).to_equal("image")
            expect(detect_file_content_type("icon.jpg")).to_equal("image")
            expect(detect_file_content_type("icon.jpeg")).to_equal("image")
            expect(detect_file_content_type("anim.gif")).to_equal("image")
            expect(detect_file_content_type("logo.svg")).to_equal("image")

        it "detects audio":
            expect(detect_file_content_type("sound.wav")).to_equal("audio")
            expect(detect_file_content_type("music.mp3")).to_equal("audio")

        it "defaults to text":
            expect(detect_file_content_type("main.spl")).to_equal("text")
            expect(detect_file_content_type("README.md")).to_equal("text")
            expect(detect_file_content_type("data.json")).to_equal("text")

    context "when detecting MIME types":
        it "detects Simple source files":
            expect(detect_mime_type("test.spl")).to_equal("text/x-simple")

        it "detects JSON files":
            expect(detect_mime_type("data.json")).to_equal("application/json")

        it "detects markdown files":
            expect(detect_mime_type("README.md")).to_equal("text/markdown")

        it "detects image MIME types":
            expect(detect_mime_type("photo.png")).to_equal("image/png")
            expect(detect_mime_type("photo.jpg")).to_equal("image/jpeg")
            expect(detect_mime_type("anim.gif")).to_equal("image/gif")
            expect(detect_mime_type("logo.svg")).to_equal("image/svg+xml")

        it "detects audio MIME types":
            expect(detect_mime_type("sound.wav")).to_equal("audio/wav")
            expect(detect_mime_type("music.mp3")).to_equal("audio/mpeg")

        it "defaults to text/plain":
            expect(detect_mime_type("unknown.xyz")).to_equal("text/plain")

describe "Tool Input Schema Building":
    context "when building input schemas":
        it "builds schema with string property":
            val props = LB() + jp("path", jo2(jp("type", js("string")), jp("description", js("File path")))) + RB()
            expect(props.contains("\"path\"")).to_equal(true)
            expect(props.contains("\"type\":\"string\"")).to_equal(true)

        it "builds schema with required array":
            val req = "[" + js("path") + "]"
            expect(req).to_equal("[\"path\"]")
