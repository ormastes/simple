# Server Safe Operations Tests
# Tests safe_read_resource and safe_execute_tool error paths

use std.spec
use std.nogc_async_mut.mcp.helpers.{LB, RB, jp, js, jo1, jo2, extract_json_string, make_result_response, make_error_response, make_tool_result}
use std.nogc_async_mut.mcp.error_handler.{input_validator}

describe "Server Safe Operations":
    describe "safe_read_resource":
        it "handles validation error":
            val validator = input_validator()
            val result = validator.validate_uri("")
            match result:
                case nil: expect(false).to_equal(true)
                case err: expect(err.message.contains("empty")).to_equal(true)

        it "handles resource not found":
            val response = make_error_response("1", -32001, "Resource not found")
            expect(response.contains("Resource not found")).to_equal(true)

        it "successfully reads resource":
            val response = make_result_response("1", jo1(jp("content", js("file data"))))
            expect(response.contains("file data")).to_equal(true)

        it "extracts uri parameter":
            val params = jo1(jp("uri", js("file:///test.spl")))
            val uri = extract_json_string(params, "uri")
            expect(uri).to_equal("file:///test.spl")

        it "handles missing uri parameter":
            val params = jo1(jp("other", js("value")))
            val uri = extract_json_string(params, "uri")
            expect(uri).to_equal("")

    describe "safe_execute_tool":
        it "handles validation error":
            val validator = input_validator()
            val result = validator.validate_tool_name("")
            match result:
                case nil: expect(false).to_equal(true)
                case err: expect(err.message.contains("empty")).to_equal(true)

        it "handles execution error":
            val response = make_error_response("1", -32002, "Tool execution failed")
            expect(response.contains("Tool execution failed")).to_equal(true)

        it "successfully executes tool":
            val response = make_tool_result("1", "Tool output data")
            expect(response.contains("Tool output data")).to_equal(true)

        it "extracts name parameter":
            val params = jo1(jp("name", js("read_code")))
            val name = extract_json_string(params, "name")
            expect(name).to_equal("read_code")

        it "handles missing name parameter":
            val params = jo1(jp("other", js("value")))
            val name = extract_json_string(params, "name")
            expect(name).to_equal("")

        it "extracts arguments parameter":
            val params = jo2(jp("name", js("read_code")), jp("arguments", js("path=/test.spl")))
            val args = extract_json_string(params, "arguments")
            expect(args.contains("path")).to_equal(true)

        it "handles missing arguments parameter":
            val params = jo1(jp("name", js("read_code")))
            val args = extract_json_string(params, "arguments")
            expect(args).to_equal("")

    describe "Parameter Extraction":
        it "extracts all required parameters":
            val params = jo2(jp("name", js("read_code")), jp("uri", js("file:///test.spl")))
            val name = extract_json_string(params, "name")
            val uri = extract_json_string(params, "uri")
            expect(name).to_equal("read_code")
            expect(uri).to_equal("file:///test.spl")

        it "handles partial parameter set":
            val params = jo1(jp("name", js("read_code")))
            val name = extract_json_string(params, "name")
            val uri = extract_json_string(params, "uri")
            expect(name).to_equal("read_code")
            expect(uri).to_equal("")
