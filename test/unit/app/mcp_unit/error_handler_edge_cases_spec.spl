# MCP Error Handler Edge Cases Tests
# Feature: MCP Error Handling - Edge Cases and Tool Validation
# Category: MCP, Error Handling
# Status: Complete

use std.spec
use std.nogc_async_mut.mcp.error_handler.{ErrorCategory, McpError, ValidationLimits, InputValidator}
use std.nogc_async_mut.mcp.error_handler.{mcp_error, default_validation_limits, strict_validation_limits, input_validator}

describe "Error Handler Edge Cases":
    describe "Tool Name Validation":
        it "detects at sign in tool name":
            val validator = input_validator()
            val result = validator.validate_tool_name("tool@name")
            match result:
                case nil: expect(false).to_equal(true)
                case err: expect(err.message.contains("invalid character")).to_equal(true)

        it "detects exclamation mark in tool name":
            val validator = input_validator()
            val result = validator.validate_tool_name("tool!name")
            match result:
                case nil: expect(false).to_equal(true)
                case err: expect(err.message.contains("invalid character")).to_equal(true)

        it "detects hash in tool name":
            val validator = input_validator()
            val result = validator.validate_tool_name("tool#name")
            match result:
                case nil: expect(false).to_equal(true)
                case err: expect(err.message.contains("invalid character")).to_equal(true)

        it "detects dollar sign in tool name":
            val validator = input_validator()
            val result = validator.validate_tool_name("tool$name")
            match result:
                case nil: expect(false).to_equal(true)
                case err: expect(err.message.contains("invalid character")).to_equal(true)

        it "detects percent in tool name":
            val validator = input_validator()
            val result = validator.validate_tool_name("tool%name")
            match result:
                case nil: expect(false).to_equal(true)
                case err: expect(err.message.contains("invalid character")).to_equal(true)

        it "detects caret in tool name":
            val validator = input_validator()
            val result = validator.validate_tool_name("tool^name")
            match result:
                case nil: expect(false).to_equal(true)
                case err: expect(err.message.contains("invalid character")).to_equal(true)

        it "detects ampersand in tool name":
            val validator = input_validator()
            val result = validator.validate_tool_name("tool&name")
            match result:
                case nil: expect(false).to_equal(true)
                case err: expect(err.message.contains("invalid character")).to_equal(true)

        it "accepts valid tool name with underscores":
            val validator = input_validator()
            val result = validator.validate_tool_name("my_valid_tool")
            expect(result).to_be_nil()

        it "accepts valid tool name with hyphens":
            val validator = input_validator()
            val result = validator.validate_tool_name("my-valid-tool")
            expect(result).to_be_nil()

        it "accepts valid tool name with slashes":
            val validator = input_validator()
            val result = validator.validate_tool_name("tools/list")
            expect(result).to_be_nil()

    describe "Error Category JSON-RPC Codes":
        it "maps ParseError to -32700":
            expect(ErrorCategory.ParseError.to_json_rpc_code()).to_equal(-32700)

        it "maps InvalidRequest to -32600":
            expect(ErrorCategory.InvalidRequest.to_json_rpc_code()).to_equal(-32600)

        it "maps MethodNotFound to -32601":
            expect(ErrorCategory.MethodNotFound.to_json_rpc_code()).to_equal(-32601)

        it "maps InvalidParams to -32602":
            expect(ErrorCategory.InvalidParams.to_json_rpc_code()).to_equal(-32602)

        it "maps InternalError to -32603":
            expect(ErrorCategory.InternalError.to_json_rpc_code()).to_equal(-32603)

    describe "McpError Details and Recovery":
        it "creates error with details":
            val err = mcp_error(ErrorCategory.Validation, "Bad input")
            val detailed = err.with_details("Expected number, got string")
            expect(detailed.details).to_equal("Expected number, got string")
            expect(detailed.message).to_equal("Bad input")

        it "marks error as unrecoverable":
            val err = mcp_error(ErrorCategory.InternalError, "Fatal")
            expect(err.recoverable).to_equal(true)
            val fatal = err.as_unrecoverable()
            expect(fatal.recoverable).to_equal(false)

        it "converts to JSON-RPC with correct code":
            val err = mcp_error(ErrorCategory.ParseError, "Bad JSON")
            val json = err.to_json_rpc()
            expect(json.contains("-32700")).to_equal(true)
            expect(json.contains("Bad JSON")).to_equal(true)

    describe "Validation Limits Comparison":
        it "default limits are more permissive than strict":
            val default_limits = default_validation_limits()
            val strict = strict_validation_limits()
            expect(default_limits.max_content_length > strict.max_content_length).to_equal(true)
            expect(default_limits.max_string_length > strict.max_string_length).to_equal(true)

        it "strict limits enforce tighter bounds":
            val strict = strict_validation_limits()
            expect(strict.max_content_length).to_equal(524288)
            expect(strict.max_string_length).to_equal(32768)
            expect(strict.max_uri_length).to_equal(1024)
            expect(strict.max_tool_name_length).to_equal(128)
            expect(strict.max_array_length).to_equal(500)
