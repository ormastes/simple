# MCP Capability Negotiation Tests
# Feature: MCP Capability Negotiation
# Category: MCP, Protocol
# Status: Complete
#
# Tests for MCP capability helpers and response formatting used in
# capability negotiation between clients and servers.

use std.spec
use std.nogc_async_mut.mcp.helpers.{LB, RB, Q, jp, js, jo1, jo2, jo3, extract_json_string, extract_json_value, make_result_response, make_error_response, log_level_to_int, make_notification_no_params, make_tools_list_changed, make_resources_list_changed, make_prompts_list_changed}

describe "Capability response building":
    slow_it "creates initialize response with protocol version":
        val caps = jo3(
            jp("resources", jo1(jp("subscribe", "true"))),
            jp("tools", jo1(jp("listChanged", "true"))),
            jp("prompts", jo1(jp("listChanged", "true")))
        )
        val server_info = jo2(jp("name", js("simple-mcp")), jp("version", js("1.0.0")))
        val result = jo3(
            jp("protocolVersion", js("2024-11-05")),
            jp("capabilities", caps),
            jp("serverInfo", server_info)
        )
        val response = make_result_response("1", result)
        expect(response.contains("2024-11-05")).to_equal(true)
        expect(response.contains("simple-mcp")).to_equal(true)
        expect(response.contains("capabilities")).to_equal(true)

    slow_it "includes tools capability":
        val caps = jo1(jp("tools", jo1(jp("listChanged", "true"))))
        val result = jo2(jp("protocolVersion", js("2024-11-05")), jp("capabilities", caps))
        val response = make_result_response("1", result)
        expect(response.contains("tools")).to_equal(true)

    slow_it "includes resources capability":
        val caps = jo1(jp("resources", jo2(jp("subscribe", "true"), jp("listChanged", "true"))))
        val result = jo2(jp("protocolVersion", js("2024-11-05")), jp("capabilities", caps))
        val response = make_result_response("1", result)
        expect(response.contains("resources")).to_equal(true)
        expect(response.contains("subscribe")).to_equal(true)

    slow_it "includes prompts capability":
        val caps = jo1(jp("prompts", jo1(jp("listChanged", "true"))))
        val result = jo2(jp("protocolVersion", js("2024-11-05")), jp("capabilities", caps))
        val response = make_result_response("1", result)
        expect(response.contains("prompts")).to_equal(true)

    slow_it "includes logging capability":
        val caps = jo1(jp("logging", LB() + RB()))
        val result = jo2(jp("protocolVersion", js("2024-11-05")), jp("capabilities", caps))
        val response = make_result_response("1", result)
        expect(response.contains("logging")).to_equal(true)

describe "Capability negotiation - version handling":
    slow_it "supported version accepted":
        val version = "2024-11-05"
        expect(version).to_equal("2024-11-05")

    slow_it "latest version accepted":
        val version = "2025-11-25"
        expect(version).to_equal("2025-11-25")

    slow_it "rejects unsupported version by creating error response":
        val response = make_error_response("1", -32600, "Unsupported protocol version")
        expect(response.contains("Unsupported")).to_equal(true)
        expect(response.contains("-32600")).to_equal(true)

describe "Capability extraction":
    slow_it "extracts protocol version from response":
        val result = jo1(jp("protocolVersion", js("2024-11-05")))
        val response = make_result_response("1", result)
        expect(response.contains("2024-11-05")).to_equal(true)

    slow_it "extracts server name from response":
        val info = jo2(jp("name", js("test-server")), jp("version", js("2.0.0")))
        val result = jo1(jp("serverInfo", info))
        val response = make_result_response("1", result)
        expect(response.contains("test-server")).to_equal(true)

describe "List changed notifications":
    slow_it "tools list changed notification":
        val notif = make_tools_list_changed()
        expect(notif.contains("tools/list_changed")).to_equal(true)
        expect(notif.contains("jsonrpc")).to_equal(true)

    slow_it "resources list changed notification":
        val notif = make_resources_list_changed()
        expect(notif.contains("resources/list_changed")).to_equal(true)

    slow_it "prompts list changed notification":
        val notif = make_prompts_list_changed()
        expect(notif.contains("prompts/list_changed")).to_equal(true)

describe "Client capabilities parsing":
    slow_it "extracts roots capability":
        val client_caps = jo1(jp("roots", jo1(jp("listChanged", "true"))))
        val has_roots = extract_json_value(client_caps, "roots")
        expect(has_roots != "null").to_equal(true)

    slow_it "extracts sampling capability":
        val client_caps = jo1(jp("sampling", LB() + RB()))
        val has_sampling = extract_json_value(client_caps, "sampling")
        expect(has_sampling != "null").to_equal(true)

    slow_it "detects missing capability":
        val client_caps = jo1(jp("roots", LB() + RB()))
        val has_sampling = extract_json_value(client_caps, "sampling")
        expect(has_sampling).to_equal("null")

describe "Log level for capability negotiation":
    slow_it "info level for initialization":
        expect(log_level_to_int("info")).to_equal(1)

    slow_it "warning level for version mismatch":
        expect(log_level_to_int("warning")).to_equal(3)

    slow_it "error level for negotiation failure":
        expect(log_level_to_int("error")).to_equal(4)
