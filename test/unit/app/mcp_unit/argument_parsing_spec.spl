# Argument Parsing Tests
# Tests command-line argument parsing utilities

use std.spec
use std.nogc_async_mut.mcp.helpers.{LB, RB, jp, js, jo1, jo2, extract_json_string, extract_json_value}

describe "Argument Parsing":
    describe "get_arg_value":
        it "extracts value after flag":
            val args = jo2(jp("flag", js("--debug")), jp("value", js("true")))
            val value = extract_json_string(args, "value")
            expect(value).to_equal("true")

        it "extracts value from flag=value syntax":
            val input = "flag=value"
            val has_equals = input.contains("=")
            expect(has_equals).to_equal(true)

        it "handles missing value":
            val args = jo1(jp("flag", js("--debug")))
            val value = extract_json_string(args, "missing")
            expect(value).to_equal("")

        it "handles empty value":
            val args = jo1(jp("flag", js("")))
            val value = extract_json_string(args, "flag")
            expect(value).to_equal("")

    describe "has_flag":
        it "detects flag presence":
            val flags = "--debug --verbose"
            val has_debug = flags.contains("--debug")
            expect(has_debug).to_equal(true)

        it "detects flag absence":
            val flags = "--debug --verbose"
            val has_quiet = flags.contains("--quiet")
            expect(has_quiet).to_equal(false)

        it "handles flag with prefix":
            val flag = "--flag"
            val has_prefix = flag.starts_with("--")
            expect(has_prefix).to_equal(true)

    describe "Flag Parsing Edge Cases":
        it "handles flag at start of args":
            val args = "--first arg1 arg2"
            val starts_with_flag = args.starts_with("--")
            expect(starts_with_flag).to_equal(true)

        it "handles flag at end of args":
            val args = "arg1 arg2 --last"
            val ends_with_flag = args.ends_with("--last")
            expect(ends_with_flag).to_equal(true)

        it "handles flag in middle of args":
            val args = "arg1 --middle arg2"
            val has_middle = args.contains("--middle")
            expect(has_middle).to_equal(true)

        it "handles multiple flags":
            val args = "--flag1 --flag2 --flag3"
            expect(args.contains("--flag1")).to_equal(true)
            expect(args.contains("--flag2")).to_equal(true)
            expect(args.contains("--flag3")).to_equal(true)

    describe "Value Extraction":
        it "extracts string value":
            val obj = jo1(jp("key", js("string_value")))
            val value = extract_json_string(obj, "key")
            expect(value).to_equal("string_value")

        it "extracts numeric value":
            val obj = jo1(jp("count", "42"))
            val value = extract_json_value(obj, "count")
            expect(value).to_equal("42")

        it "extracts boolean flag":
            val obj = jo1(jp("verbose", "true"))
            val value = extract_json_value(obj, "verbose")
            expect(value).to_equal("true")

    describe "Special Characters":
        it "handles values with spaces":
            val value = "hello world"
            expect(value.contains(" ")).to_equal(true)

        it "handles values with special chars":
            val value = "path/to/file.spl"
            expect(value.contains("/")).to_equal(true)
