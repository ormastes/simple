# Tests for app.io.file_ops module
# Covers file read, write, copy, append, delete, exists, and size

use app.io.file_ops.{file_exists, file_read, file_write, file_copy, file_delete, file_append, file_size, file_size_raw}
use std.string.{NL}
use app.io.dir_ops.{dir_create_all, dir_remove_all}

# Use a unique temp directory base to avoid conflicts
var BASE = "/tmp/simple_test_file_ops_87432"

# Setup and cleanup helpers
fn setup():
    dir_create_all(BASE)

fn cleanup():
    dir_remove_all(BASE)

describe "app.io.file_ops":
    describe "file_write and file_read":
        it "writes and reads back content":
            setup()
            val path = BASE + "/hello.txt"
            val wrote = file_write(path, "Hello, Simple!")
            expect(wrote).to_equal(true)
            val content = file_read(path)
            expect(content).to_contain("Hello, Simple!")
            cleanup()

        it "writes multiline content":
            setup()
            val path = BASE + "/multi.txt"
            file_write(path, "line1{NL}line2{NL}line3")
            val content = file_read(path)
            expect(content).to_contain("line1")
            expect(content).to_contain("line2")
            expect(content).to_contain("line3")
            cleanup()

        it "overwrites existing file":
            setup()
            val path = BASE + "/overwrite.txt"
            file_write(path, "first")
            file_write(path, "second")
            val content = file_read(path)
            expect(content).to_contain("second")
            cleanup()

    describe "file_exists":
        it "returns true for existing file":
            setup()
            val path = BASE + "/exists.txt"
            file_write(path, "data")
            expect(file_exists(path)).to_equal(true)
            cleanup()

        it "returns false for non-existent file":
            expect(file_exists("/tmp/simple_test_no_such_file_99999.txt")).to_equal(false)

    describe "file_copy":
        it "copies a file":
            setup()
            val src = BASE + "/source.txt"
            val dst = BASE + "/dest.txt"
            file_write(src, "copy me")
            val result = file_copy(src, dst)
            expect(result).to_equal(true)
            expect(file_exists(dst)).to_equal(true)
            val content = file_read(dst)
            expect(content).to_contain("copy me")
            cleanup()

    describe "file_append":
        it "appends to an existing file":
            setup()
            val path = BASE + "/append.txt"
            file_write(path, "start")
            file_append(path, "{NL}appended")
            val content = file_read(path)
            expect(content).to_contain("start")
            expect(content).to_contain("appended")
            cleanup()

    describe "file_delete":
        it "deletes a file":
            setup()
            val path = BASE + "/deleteme.txt"
            file_write(path, "gone soon")
            expect(file_exists(path)).to_equal(true)
            val result = file_delete(path)
            expect(result).to_equal(true)
            expect(file_exists(path)).to_equal(false)
            cleanup()

    describe "file_size and file_size_raw":
        it "returns positive size for non-empty file":
            setup()
            val path = BASE + "/sized.txt"
            file_write(path, "some content here")
            val sz = file_size(path)
            expect(sz).to_be_greater_than(0)
            cleanup()

        it "file_size_raw matches file_size":
            setup()
            val path = BASE + "/rawsize.txt"
            file_write(path, "test data")
            val sz1 = file_size(path)
            val sz2 = file_size_raw(path)
            expect(sz1).to_equal(sz2)
            cleanup()

        it "returns -1 for non-existent file":
            val sz = file_size_raw("/tmp/simple_test_no_such_file_88888.txt")
            expect(sz).to_equal(-1)

    # Final cleanup
    describe "cleanup":
        it "removes test base dir":
            cleanup()
            val still_here = file_exists(BASE + "/anything.txt")
            expect(still_here).to_equal(false)
