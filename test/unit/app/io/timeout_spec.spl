# Process Timeout Tests
# Tests for process_run_timeout() on both Unix and Windows

use std.spec.{describe, it, expect}
use app.io.process_ops.{process_run_timeout}

describe "process_run_timeout":
    it "completes fast commands successfully":
        val (stdout, stderr, code) = process_run_timeout("echo", ["hello"], 5000)
        expect(code).to_equal(0)
        expect(stdout.trim()).to_contain("hello")

    it "enforces timeout on slow commands":
        val (stdout, stderr, code) = process_run_timeout("sleep", ["10"], 1000)
        expect(code).to_equal(-1)
        expect(stderr).to_contain("TIMEOUT")

    it "uses default timeout when timeout_ms <= 0":
        val (stdout, stderr, code) = process_run_timeout("echo", ["test"], 0)
        expect(code).to_equal(0)
        expect(stdout.trim()).to_contain("test")

    it "captures stdout correctly":
        val (stdout, stderr, code) = process_run_timeout("echo", ["output test"], 5000)
        expect(code).to_equal(0)
        expect(stdout).to_contain("output")

    it "captures stderr correctly on Unix":
        val (stdout, stderr, code) = process_run_timeout("sh", ["-c", "echo error >&2"], 5000)
        if code == 0:
            expect(stderr).to_contain("error")
