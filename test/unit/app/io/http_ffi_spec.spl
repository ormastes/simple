#!/usr/bin/env simple
# HTTP Client/Server SFFI Wrapper Tests
#
# Comprehensive test suite for HTTP functionality.
# Tests REST API client, HTTP server, and WebSocket support.

use app.io.http_ffi.{
    HttpMethod, method_to_string,
    HttpStatus, status_to_code, code_to_status,
    HttpResponse, HttpClient, HttpServer, WebSocket,
    http_get, http_post, http_post_form, http_put, http_delete, http_patch, http_head,
    http_request, http_download, http_upload,
    http_client_new, http_client_set_timeout, http_client_set_header,
    http_client_request, http_client_destroy,
    http_server_new, http_server_route, http_server_static,
    http_server_start, http_server_stop, http_server_destroy,
    ws_connect, ws_send, ws_receive, ws_close,
    url_encode, url_decode,
    http_get_json, http_post_json,
    http_is_success, http_is_redirect, http_is_client_error, http_is_server_error
}

describe "HTTP SFFI Wrapper":
    # ========================================================================
    # HTTP Method Tests
    # ========================================================================

    describe "HttpMethod enum":
        it "defines HTTP method variants":
            val get = HttpMethod.GET
            val post = HttpMethod.POST
            val put = HttpMethod.PUT
            val delete = HttpMethod.DELETE
            val patch = HttpMethod.PATCH
            val head = HttpMethod.HEAD
            # Enum variants exist

        it "converts method to string":
            expect(method_to_string(HttpMethod.GET)).to_equal("GET")
            expect(method_to_string(HttpMethod.POST)).to_equal("POST")
            expect(method_to_string(HttpMethod.PUT)).to_equal("PUT")
            expect(method_to_string(HttpMethod.DELETE)).to_equal("DELETE")
            expect(method_to_string(HttpMethod.PATCH)).to_equal("PATCH")
            expect(method_to_string(HttpMethod.HEAD)).to_equal("HEAD")

    # ========================================================================
    # HTTP Status Tests
    # ========================================================================

    describe "HttpStatus enum":
        it "defines common status codes":
            val ok = HttpStatus.OK
            val created = HttpStatus.Created
            val bad_request = HttpStatus.BadRequest
            val not_found = HttpStatus.NotFound
            val error = HttpStatus.InternalError
            # Enum variants exist

        it "converts status to code":
            expect(status_to_code(HttpStatus.OK)).to_equal(200)
            expect(status_to_code(HttpStatus.Created)).to_equal(201)
            expect(status_to_code(HttpStatus.BadRequest)).to_equal(400)
            expect(status_to_code(HttpStatus.NotFound)).to_equal(404)
            expect(status_to_code(HttpStatus.InternalError)).to_equal(500)

        it "converts code to status":
            expect(code_to_status(200)).to_equal(HttpStatus.OK)
            expect(code_to_status(201)).to_equal(HttpStatus.Created)
            expect(code_to_status(400)).to_equal(HttpStatus.BadRequest)
            expect(code_to_status(404)).to_equal(HttpStatus.NotFound)
            expect(code_to_status(500)).to_equal(HttpStatus.InternalError)

    # ========================================================================
    # HTTP Response Tests
    # ========================================================================

    describe "HttpResponse":
        it "has required fields":
            val response = HttpResponse(
                status_code: 200,
                status: HttpStatus.OK,
                body: "Hello",
                error: "",
                is_ok: true
            )
            expect(response.status_code).to_equal(200)
            expect(response.body).to_equal("Hello")
            expect(response.is_ok).to_equal(true)

        it "marks 2xx as ok":
            val response = HttpResponse(
                status_code: 200,
                status: HttpStatus.OK,
                body: "",
                error: "",
                is_ok: true
            )
            expect(response.is_ok).to_equal(true)

        it "marks 4xx as not ok":
            val response = HttpResponse(
                status_code: 404,
                status: HttpStatus.NotFound,
                body: "",
                error: "Not found",
                is_ok: false
            )
            expect(response.is_ok).to_equal(false)

    # ========================================================================
    # HTTP Client Tests (Simple Functions)
    # ========================================================================

    describe "http_get":
        it "performs GET request":
            val response = http_get("https://httpbin.org/get")
            # Will fail without runtime, but shouldn't crash
            val _ = response.status_code

        it "returns HttpResponse":
            val response = http_get("https://example.com")
            val _ = response.body
            val _ = response.error

    describe "http_post":
        it "performs POST request":
            val json = '{"test": "data"}'
            val response = http_post("https://httpbin.org/post", json)
            # Will fail without runtime

        it "returns HttpResponse":
            val response = http_post("https://example.com/api", "{}")
            val _ = response.status_code

    describe "http_post_form":
        it "performs POST with form data":
            val form = "name=test&value=123"
            val response = http_post_form("https://httpbin.org/post", form)
            # Will fail without runtime

    describe "http_put":
        it "performs PUT request":
            val response = http_put("https://httpbin.org/put", "{}")
            # Will fail without runtime

    describe "http_delete":
        it "performs DELETE request":
            val response = http_delete("https://httpbin.org/delete")
            # Will fail without runtime

    describe "http_patch":
        it "performs PATCH request":
            val response = http_patch("https://httpbin.org/patch", "{}")
            # Will fail without runtime

    describe "http_head":
        it "performs HEAD request":
            val response = http_head("https://httpbin.org/headers")
            # Will fail without runtime

    describe "http_request":
        it "performs custom request with headers":
            val headers = ["Authorization: Bearer token", "Accept: application/json"]
            val response = http_request(HttpMethod.GET, "https://api.example.com", headers, "")
            # Will fail without runtime

        it "supports all HTTP methods":
            http_request(HttpMethod.GET, "https://example.com", [], "")
            http_request(HttpMethod.POST, "https://example.com", [], "{}")
            http_request(HttpMethod.PUT, "https://example.com", [], "{}")
            http_request(HttpMethod.DELETE, "https://example.com", [], "")

    describe "http_download":
        it "downloads file":
            val response = http_download("https://example.com/file.txt", "/tmp/test.txt")
            # Will fail without runtime

    describe "http_upload":
        it "uploads file":
            val response = http_upload("https://httpbin.org/post", "/tmp/file.txt", "file")
            # Will fail without runtime

    # ========================================================================
    # HTTP Client (Advanced) Tests
    # ========================================================================

    describe "http_client_new":
        it "creates HTTP client":
            val client = http_client_new()
            expect(client.handle).to_equal(0)  # No runtime
            expect(client.is_valid).to_equal(false)
            http_client_destroy(client)

    describe "http_client_set_timeout":
        it "sets timeout":
            val client = HttpClient(handle: 0, is_valid: false)
            val result = http_client_set_timeout(client, 5000)
            expect(result).to_equal(false)  # Invalid client

    describe "http_client_set_header":
        it "sets default header":
            val client = HttpClient(handle: 0, is_valid: false)
            val result = http_client_set_header(client, "User-Agent", "Simple/1.0")
            expect(result).to_equal(false)

    describe "http_client_request":
        it "performs request with configured client":
            val client = HttpClient(handle: 0, is_valid: false)
            val response = http_client_request(client, HttpMethod.GET, "https://example.com", [], "")
            expect(response.is_ok).to_equal(false)
            expect(response.error).to_equal("Invalid HTTP client")

    describe "http_client_destroy":
        it "destroys invalid client safely":
            val client = HttpClient(handle: 0, is_valid: false)
            http_client_destroy(client)

    # ========================================================================
    # HTTP Server Tests
    # ========================================================================

    describe "http_server_new":
        it "creates HTTP server":
            val server = http_server_new(8080)
            expect(server.handle).to_equal(0)  # No runtime
            expect(server.is_valid).to_equal(false)
            expect(server.port).to_equal(8080)
            http_server_destroy(server)

    describe "http_server_route":
        it "registers route":
            val server = HttpServer(handle: 0, port: 8080, is_valid: false)
            val result = http_server_route(server, "GET", "/", "handle_index")
            expect(result).to_equal(false)  # Invalid server

    describe "http_server_static":
        it "serves static files":
            val server = HttpServer(handle: 0, port: 8080, is_valid: false)
            val result = http_server_static(server, "/static", "./public")
            expect(result).to_equal(false)

    describe "http_server_start":
        it "starts server":
            val server = HttpServer(handle: 0, port: 8080, is_valid: false)
            val result = http_server_start(server)
            expect(result).to_equal(false)

    describe "http_server_stop":
        it "stops invalid server safely":
            val server = HttpServer(handle: 0, port: 8080, is_valid: false)
            val result = http_server_stop(server)
            expect(result).to_equal(true)

    describe "http_server_destroy":
        it "destroys invalid server safely":
            val server = HttpServer(handle: 0, port: 8080, is_valid: false)
            http_server_destroy(server)

    # ========================================================================
    # WebSocket Tests
    # ========================================================================

    describe "ws_connect":
        it "connects to WebSocket":
            val ws = ws_connect("wss://example.com/ws")
            expect(ws.handle).to_equal(0)  # No runtime
            expect(ws.is_valid).to_equal(false)
            ws_close(ws)

    describe "ws_send":
        it "sends message":
            val ws = WebSocket(handle: 0, is_valid: false)
            val result = ws_send(ws, "Hello")
            expect(result).to_equal(false)

    describe "ws_receive":
        it "receives message":
            val ws = WebSocket(handle: 0, is_valid: false)
            val msg = ws_receive(ws)
            expect(msg).to_equal("")

    describe "ws_close":
        it "closes invalid WebSocket safely":
            val ws = WebSocket(handle: 0, is_valid: false)
            val result = ws_close(ws)
            expect(result).to_equal(true)

    # ========================================================================
    # Utility Tests
    # ========================================================================

    describe "url_encode":
        it "encodes URL":
            val encoded = url_encode("hello world")
            # Will be empty without runtime

    describe "url_decode":
        it "decodes URL":
            val decoded = url_decode("hello%20world")
            # Will be empty without runtime

    # ========================================================================
    # Helper Function Tests
    # ========================================================================

    describe "http_get_json":
        it "performs GET with JSON accept header":
            val response = http_get_json("https://api.example.com/data")
            # Will fail without runtime

    describe "http_post_json":
        it "performs POST with JSON content type":
            val response = http_post_json("https://api.example.com/data", "{}")
            # Will fail without runtime

    describe "http_is_success":
        it "returns true for 2xx":
            val response = HttpResponse(
                status_code: 200,
                status: HttpStatus.OK,
                body: "",
                error: "",
                is_ok: true
            )
            expect(http_is_success(response)).to_equal(true)

        it "returns false for 4xx":
            val response = HttpResponse(
                status_code: 404,
                status: HttpStatus.NotFound,
                body: "",
                error: "",
                is_ok: false
            )
            expect(http_is_success(response)).to_equal(false)

    describe "http_is_redirect":
        it "returns true for 3xx":
            val response = HttpResponse(
                status_code: 301,
                status: HttpStatus.Unknown,
                body: "",
                error: "",
                is_ok: false
            )
            expect(http_is_redirect(response)).to_equal(true)

    describe "http_is_client_error":
        it "returns true for 4xx":
            val response = HttpResponse(
                status_code: 404,
                status: HttpStatus.NotFound,
                body: "",
                error: "",
                is_ok: false
            )
            expect(http_is_client_error(response)).to_equal(true)

    describe "http_is_server_error":
        it "returns true for 5xx":
            val response = HttpResponse(
                status_code: 500,
                status: HttpStatus.InternalError,
                body: "",
                error: "",
                is_ok: false
            )
            expect(http_is_server_error(response)).to_equal(true)
