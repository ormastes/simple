# SDoctest Coverage Analysis Tests

use app.doc_coverage.analysis.sdoctest_coverage.*
use app.doc_coverage.types.doc_item.{DocItem, DocKind}

describe "SDoctest Coverage Analysis":
    it "validates tag format for stdlib category":
        val valid = validate_tag_format("stdlib:string")
        expect(valid).to_equal(true)

    it "validates tag format for core category":
        val valid = validate_tag_format("core:parser")
        expect(valid).to_equal(true)

    it "rejects invalid tag without colon":
        val valid = validate_tag_format("invalid_tag")
        expect(valid).to_equal(false)

    it "rejects invalid tag with uppercase":
        val valid = validate_tag_format("stdlib:String")
        expect(valid).to_equal(false)

    it "rejects invalid category":
        val valid = validate_tag_format("invalid:name")
        expect(valid).to_equal(false)

    it "suggests tags for stdlib module":
        val tags = suggest_missing_tags("src/std/string.spl")
        expect(tags.len()).to_equal(1)
        expect(tags[0]).to_equal("stdlib:string")

    it "suggests tags for core module":
        val tags = suggest_missing_tags("src/core/parser.spl")
        expect(tags.len()).to_equal(1)
        expect(tags[0]).to_equal("core:parser")

    it "suggests tags for app module":
        val tags = suggest_missing_tags("src/app/io/mod.spl")
        expect(tags.len()).to_equal(1)
        expect(tags[0]).to_equal("feature:io")

    it "extracts function name from code line":
        val code = "fn hello_world():"
        val names = extract_function_names_from_code(code)
        expect(names.len()).to_equal(1)
        expect(names[0]).to_equal("hello_world")

    it "extracts class name from code line":
        val code = "class Point:"
        val names = extract_function_names_from_code(code)
        expect(names.len()).to_equal(1)
        expect(names[0]).to_equal("Point")

    it "extracts enum name from code line":
        val code = "enum Status:"
        val names = extract_function_names_from_code(code)
        expect(names.len()).to_equal(1)
        expect(names[0]).to_equal("Status")

    it "matches functions to sdoctest blocks":
        var public_funcs: [text] = []
        public_funcs.push("hello_world")
        public_funcs.push("goodbye_world")

        var blocks: [text] = []
        blocks.push("fn hello_world():\n    print 'Hello'")

        val result = match_functions_to_sdoctest(public_funcs, blocks)
        val matched = result.0
        val missing = result.1

        expect(matched.len()).to_equal(1)
        expect(matched[0]).to_equal("hello_world")
        expect(missing.len()).to_equal(1)
        expect(missing[0]).to_equal("goodbye_world")
