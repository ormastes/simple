# Tag Validator Tests
# Tests for tag validation and normalization

use std.spec.{describe, it, expect}
use doc_coverage.tagging.tag_validator.{validate_tag, normalize_tag, is_valid_category, extract_category, extract_value, validate_tag_set, normalize_tag_set, remove_duplicate_tags}

# ============================================================================
# Tests for validate_tag
# ============================================================================

describe "validate_tag":
    it "validates correct coverage tag":
        val is_valid = validate_tag("coverage:excellent")
        expect(is_valid).to_equal(true)

    it "validates correct doc status tag":
        val is_valid = validate_tag("doc:missing_sdoctest")
        expect(is_valid).to_equal(true)

    it "validates correct scope tag":
        val is_valid = validate_tag("scope:stdlib")
        expect(is_valid).to_equal(true)

    it "validates correct api tag":
        val is_valid = validate_tag("api:public")
        expect(is_valid).to_equal(true)

    it "validates tag with numbers":
        val is_valid = validate_tag("version:v2_0")
        expect(is_valid).to_equal(true)

    it "rejects tag without colon":
        val is_valid = validate_tag("invalid_tag")
        expect(is_valid).to_equal(false)

    it "rejects tag with multiple colons":
        val is_valid = validate_tag("category:sub:value")
        expect(is_valid).to_equal(false)

    it "rejects tag with uppercase letters":
        val is_valid = validate_tag("Coverage:Excellent")
        expect(is_valid).to_equal(false)

    it "rejects tag with spaces":
        val is_valid = validate_tag("doc:missing sdoctest")
        expect(is_valid).to_equal(false)

    it "rejects tag with hyphens":
        val is_valid = validate_tag("doc:missing-sdoctest")
        expect(is_valid).to_equal(false)

    it "rejects empty category":
        val is_valid = validate_tag(":value")
        expect(is_valid).to_equal(false)

    it "rejects empty value":
        val is_valid = validate_tag("category:")
        expect(is_valid).to_equal(false)

    it "rejects tag with special characters":
        val is_valid = validate_tag("doc:missing@test")
        expect(is_valid).to_equal(false)

    it "validates tag with all valid characters":
        val is_valid = validate_tag("abc_123:xyz_789")
        expect(is_valid).to_equal(true)

# ============================================================================
# Tests for normalize_tag
# ============================================================================

describe "normalize_tag":
    it "converts uppercase to lowercase":
        val normalized = normalize_tag("Coverage:Excellent")
        expect(normalized).to_equal("coverage:excellent")

    it "converts spaces to underscores":
        val normalized = normalize_tag("doc:missing sdoctest")
        expect(normalized).to_equal("doc:missing_sdoctest")

    it "converts hyphens to underscores":
        val normalized = normalize_tag("doc:missing-sdoctest")
        expect(normalized).to_equal("doc:missing_sdoctest")

    it "removes special characters":
        val normalized = normalize_tag("doc:missing@test!")
        expect(normalized).to_equal("doc:missingtest")

    it "handles mixed case with spaces and hyphens":
        val normalized = normalize_tag("Doc Status:Missing-SDoc Test")
        expect(normalized).to_equal("docstatus:missing_sdoctest")

    it "preserves already valid tags":
        val normalized = normalize_tag("coverage:excellent")
        expect(normalized).to_equal("coverage:excellent")

    it "handles empty string":
        val normalized = normalize_tag("")
        expect(normalized).to_equal("")

    it "preserves numbers and underscores":
        val normalized = normalize_tag("version:v2_0")
        expect(normalized).to_equal("version:v2_0")

# ============================================================================
# Tests for is_valid_category
# ============================================================================

describe "is_valid_category":
    it "validates coverage category":
        val is_valid = is_valid_category("coverage")
        expect(is_valid).to_equal(true)

    it "validates doc category":
        val is_valid = is_valid_category("doc")
        expect(is_valid).to_equal(true)

    it "validates scope category":
        val is_valid = is_valid_category("scope")
        expect(is_valid).to_equal(true)

    it "validates api category":
        val is_valid = is_valid_category("api")
        expect(is_valid).to_equal(true)

    it "validates kind category":
        val is_valid = is_valid_category("kind")
        expect(is_valid).to_equal(true)

    it "validates group_comment category":
        val is_valid = is_valid_category("group_comment")
        expect(is_valid).to_equal(true)

    it "validates var_group category":
        val is_valid = is_valid_category("var_group")
        expect(is_valid).to_equal(true)

    it "rejects unknown category":
        val is_valid = is_valid_category("unknown")
        expect(is_valid).to_equal(false)

    it "rejects empty string":
        val is_valid = is_valid_category("")
        expect(is_valid).to_equal(false)

# ============================================================================
# Tests for extract_category
# ============================================================================

describe "extract_category":
    it "extracts category from valid tag":
        val category = extract_category("coverage:excellent")
        expect(category).to_equal("coverage")

    it "extracts category with underscores":
        val category = extract_category("group_comment:detected")
        expect(category).to_equal("group_comment")

    it "returns empty for tag without colon":
        val category = extract_category("invalid")
        expect(category).to_equal("")

    it "returns empty for empty string":
        val category = extract_category("")
        expect(category).to_equal("")

    it "handles tag with colon at end":
        val category = extract_category("category:")
        expect(category).to_equal("category")

# ============================================================================
# Tests for extract_value
# ============================================================================

describe "extract_value":
    it "extracts value from valid tag":
        val value = extract_value("coverage:excellent")
        expect(value).to_equal("excellent")

    it "extracts value with underscores":
        val value = extract_value("doc:missing_sdoctest")
        expect(value).to_equal("missing_sdoctest")

    it "returns empty for tag without colon":
        val value = extract_value("invalid")
        expect(value).to_equal("")

    it "returns empty for empty string":
        val value = extract_value("")
        expect(value).to_equal("")

    it "handles tag with colon at start":
        val value = extract_value(":value")
        expect(value).to_equal("value")

# ============================================================================
# Tests for validate_tag_set
# ============================================================================

describe "validate_tag_set":
    it "validates all valid tags":
        val tags: [text] = ["coverage:excellent", "doc:complete", "scope:stdlib"]
        val result = validate_tag_set(tags)
        val all_valid = result.0
        val invalid_tags = result.1

        expect(all_valid).to_equal(true)
        expect(invalid_tags.len()).to_equal(0)

    it "detects single invalid tag":
        val tags: [text] = ["coverage:excellent", "Invalid Tag", "scope:stdlib"]
        val result = validate_tag_set(tags)
        val all_valid = result.0
        val invalid_tags = result.1

        expect(all_valid).to_equal(false)
        expect(invalid_tags.len()).to_equal(1)
        expect(invalid_tags[0]).to_equal("Invalid Tag")

    it "detects multiple invalid tags":
        val tags: [text] = ["no-colon", "Invalid Tag", "valid:tag"]
        val result = validate_tag_set(tags)
        val all_valid = result.0
        val invalid_tags = result.1

        expect(all_valid).to_equal(false)
        expect(invalid_tags.len()).to_equal(2)

    it "handles empty tag set":
        val tags: [text] = []
        val result = validate_tag_set(tags)
        val all_valid = result.0
        val invalid_tags = result.1

        expect(all_valid).to_equal(true)
        expect(invalid_tags.len()).to_equal(0)

    it "detects tag without value":
        val tags: [text] = ["coverage:", "doc:complete"]
        val result = validate_tag_set(tags)
        val all_valid = result.0
        val invalid_tags = result.1

        expect(all_valid).to_equal(false)
        expect(invalid_tags.len()).to_equal(1)

# ============================================================================
# Tests for normalize_tag_set
# ============================================================================

describe "normalize_tag_set":
    it "normalizes all tags in set":
        val tags: [text] = ["Coverage:Excellent", "Doc:Complete", "Scope:StdLib"]
        val normalized = normalize_tag_set(tags)

        expect(normalized.len()).to_equal(3)
        expect(normalized[0]).to_equal("coverage:excellent")
        expect(normalized[1]).to_equal("doc:complete")
        expect(normalized[2]).to_equal("scope:stdlib")

    it "handles tags with spaces and hyphens":
        val tags: [text] = ["doc:missing sdoctest", "coverage:very-good"]
        val normalized = normalize_tag_set(tags)

        expect(normalized.len()).to_equal(2)
        expect(normalized[0]).to_equal("doc:missing_sdoctest")
        expect(normalized[1]).to_equal("coverage:very_good")

    it "preserves already normalized tags":
        val tags: [text] = ["coverage:excellent", "doc:complete"]
        val normalized = normalize_tag_set(tags)

        expect(normalized.len()).to_equal(2)
        expect(normalized[0]).to_equal("coverage:excellent")
        expect(normalized[1]).to_equal("doc:complete")

    it "handles empty tag set":
        val tags: [text] = []
        val normalized = normalize_tag_set(tags)

        expect(normalized.len()).to_equal(0)

# ============================================================================
# Tests for remove_duplicate_tags
# ============================================================================

describe "remove_duplicate_tags":
    it "removes duplicate tags":
        val tags: [text] = ["coverage:excellent", "doc:complete", "coverage:excellent"]
        val unique = remove_duplicate_tags(tags)

        expect(unique.len()).to_equal(2)

        var has_coverage = false
        var has_doc = false
        for tag in unique:
            if tag == "coverage:excellent":
                has_coverage = true
            if tag == "doc:complete":
                has_doc = true

        expect(has_coverage).to_equal(true)
        expect(has_doc).to_equal(true)

    it "preserves order of first occurrence":
        val tags: [text] = ["scope:stdlib", "doc:complete", "scope:stdlib", "doc:complete"]
        val unique = remove_duplicate_tags(tags)

        expect(unique.len()).to_equal(2)
        expect(unique[0]).to_equal("scope:stdlib")
        expect(unique[1]).to_equal("doc:complete")

    it "handles no duplicates":
        val tags: [text] = ["coverage:excellent", "doc:complete", "scope:stdlib"]
        val unique = remove_duplicate_tags(tags)

        expect(unique.len()).to_equal(3)

    it "handles all duplicates":
        val tags: [text] = ["same:tag", "same:tag", "same:tag"]
        val unique = remove_duplicate_tags(tags)

        expect(unique.len()).to_equal(1)
        expect(unique[0]).to_equal("same:tag")

    it "handles empty tag set":
        val tags: [text] = []
        val unique = remove_duplicate_tags(tags)

        expect(unique.len()).to_equal(0)

# ============================================================================
# Integration Tests
# ============================================================================

describe "tag validation integration":
    it "validates then normalizes invalid tags":
        val tag = "Doc Status:Missing-SDoc Test"
        val is_valid_before = validate_tag(tag)
        val normalized = normalize_tag(tag)
        val is_valid_after = validate_tag(normalized)

        expect(is_valid_before).to_equal(false)
        expect(is_valid_after).to_equal(true)

    it "processes tag set with normalization and deduplication":
        val tags: [text] = ["Coverage:Excellent", "doc:complete", "Coverage:Excellent"]
        val normalized = normalize_tag_set(tags)
        val unique = remove_duplicate_tags(normalized)

        expect(unique.len()).to_equal(2)
        expect(unique[0]).to_equal("coverage:excellent")
        expect(unique[1]).to_equal("doc:complete")

    it "validates category after extraction":
        val tag = "coverage:excellent"
        val category = extract_category(tag)
        val is_valid_cat = is_valid_category(category)

        expect(is_valid_cat).to_equal(true)
