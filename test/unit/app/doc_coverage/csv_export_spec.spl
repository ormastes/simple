# CSV Export Tests
# Tests for CSV export format generation

use std.spec.{describe, it, expect}
use doc_coverage.reporting.csv_exporter.{export_coverage_csv}
use doc_coverage.types.doc_item.{DocItem, DocKind}

# ============================================================================
# Helper Functions
# ============================================================================

fn create_test_item(name: text, file: text, line: i64, is_public: bool, has_sdoctest: bool) -> DocItem:
    var item = DocItem.create_function(name, file, line, 5, "pub", "fn {name}()")
    item.is_public = is_public
    item.has_sdoctest = has_sdoctest
    item.has_inline_comment = true
    item

# ============================================================================
# Tests for CSV structure
# ============================================================================

describe "export_coverage_csv header":
    it "includes CSV header row":
        val items: [DocItem] = []
        val csv = export_coverage_csv(items)

        val has_header = csv.starts_with("name,file,line,kind,is_public,has_sdoctest,has_inline_comment,tags")
        expect(has_header).to_equal(true)

    it "header has correct field names":
        val items: [DocItem] = []
        val csv = export_coverage_csv(items)

        val has_name = csv.contains("name")
        val has_file = csv.contains("file")
        val has_line = csv.contains("line")
        val has_kind = csv.contains("kind")
        val has_public = csv.contains("is_public")
        val has_sdoctest = csv.contains("has_sdoctest")
        val has_inline = csv.contains("has_inline_comment")
        val has_tags = csv.contains("tags")

        expect(has_name).to_equal(true)
        expect(has_file).to_equal(true)
        expect(has_line).to_equal(true)
        expect(has_kind).to_equal(true)
        expect(has_public).to_equal(true)
        expect(has_sdoctest).to_equal(true)
        expect(has_inline).to_equal(true)
        expect(has_tags).to_equal(true)

# ============================================================================
# Tests for CSV data rows
# ============================================================================

describe "export_coverage_csv data rows":
    it "exports single item":
        val item = create_test_item("test_fn", "/src/std/test.spl", 42, true, true)
        val items: [DocItem] = [item]
        val csv = export_coverage_csv(items)

        val lines = csv.split("\n")
        val expected_lines = 2
        val has_header_and_data = lines.len() >= expected_lines

        expect(has_header_and_data).to_equal(true)

    it "includes function name in row":
        val item = create_test_item("my_function", "/src/std/test.spl", 10, true, true)
        val items: [DocItem] = [item]
        val csv = export_coverage_csv(items)

        val has_name = csv.contains("my_function")
        expect(has_name).to_equal(true)

    it "includes file path in row":
        val item = create_test_item("test", "/src/std/math.spl", 10, true, true)
        val items: [DocItem] = [item]
        val csv = export_coverage_csv(items)

        val has_file = csv.contains("/src/std/math.spl")
        expect(has_file).to_equal(true)

    it "includes line number in row":
        val item = create_test_item("test", "/src/std/test.spl", 99, true, true)
        val items: [DocItem] = [item]
        val csv = export_coverage_csv(items)

        val has_line = csv.contains(",99,")
        expect(has_line).to_equal(true)

    it "includes kind in row":
        val item = create_test_item("test", "/src/std/test.spl", 10, true, true)
        val items: [DocItem] = [item]
        val csv = export_coverage_csv(items)

        val has_kind = csv.contains("function")
        expect(has_kind).to_equal(true)

    it "exports multiple items":
        val item1 = create_test_item("fn1", "/src/std/test.spl", 10, true, true)
        val item2 = create_test_item("fn2", "/src/std/test.spl", 20, false, false)
        val items: [DocItem] = [item1, item2]
        val csv = export_coverage_csv(items)

        val has_fn1 = csv.contains("fn1")
        val has_fn2 = csv.contains("fn2")

        expect(has_fn1).to_equal(true)
        expect(has_fn2).to_equal(true)

# ============================================================================
# Tests for boolean values
# ============================================================================

describe "export_coverage_csv boolean values":
    it "exports true as 'true'":
        val item = create_test_item("test", "/src/std/test.spl", 10, true, true)
        val items: [DocItem] = [item]
        val csv = export_coverage_csv(items)

        val has_true = csv.contains(",true,")
        expect(has_true).to_equal(true)

    it "exports false as 'false'":
        val item = create_test_item("test", "/src/std/test.spl", 10, false, false)
        val items: [DocItem] = [item]
        val csv = export_coverage_csv(items)

        val has_false = csv.contains(",false,")
        expect(has_false).to_equal(true)

    it "handles mixed boolean values":
        var item = create_test_item("test", "/src/std/test.spl", 10, true, false)
        item.has_inline_comment = true
        val items: [DocItem] = [item]
        val csv = export_coverage_csv(items)

        val lines = csv.split("\n")
        val has_both = lines.len() >= 2

        expect(has_both).to_equal(true)

# ============================================================================
# Tests for CSV escaping
# ============================================================================

describe "export_coverage_csv escaping":
    it "quotes field with comma":
        val item = create_test_item("test, with comma", "/src/std/test.spl", 10, true, true)
        val items: [DocItem] = [item]
        val csv = export_coverage_csv(items)

        val has_quoted = csv.contains("\"test, with comma\"")
        expect(has_quoted).to_equal(true)

    it "escapes quotes by doubling them":
        val item = create_test_item("test_fn", "/home/user/\"project\"/test.spl", 10, true, true)
        val items: [DocItem] = [item]
        val csv = export_coverage_csv(items)

        val has_doubled = csv.contains("\"\"")
        expect(has_doubled).to_equal(true)

    it "quotes field with newline":
        val item = create_test_item("test_fn", "/src/test\nfile.spl", 10, true, true)
        val items: [DocItem] = [item]
        val csv = export_coverage_csv(items)

        val has_quotes = csv.contains("\"")
        expect(has_quotes).to_equal(true)

    it "does not quote simple fields":
        val item = create_test_item("simple_name", "/src/std/test.spl", 10, true, true)
        val items: [DocItem] = [item]
        val csv = export_coverage_csv(items)

        val lines = csv.split("\n")
        val has_data = lines.len() >= 2

        expect(has_data).to_equal(true)

# ============================================================================
# Tests for tags export
# ============================================================================

describe "export_coverage_csv tags":
    it "exports empty tags as empty field":
        val item = create_test_item("test", "/src/std/test.spl", 10, true, true)
        val items: [DocItem] = [item]
        val csv = export_coverage_csv(items)

        val lines = csv.split("\n")
        val has_data = lines.len() >= 2

        expect(has_data).to_equal(true)

    it "exports single tag":
        var item = create_test_item("test", "/src/std/test.spl", 10, true, true)
        item.sdoctest_tags = ["coverage:excellent"]
        val items: [DocItem] = [item]
        val csv = export_coverage_csv(items)

        val has_tag = csv.contains("coverage:excellent")
        expect(has_tag).to_equal(true)

    it "exports multiple tags pipe-separated":
        var item = create_test_item("test", "/src/std/test.spl", 10, true, true)
        item.sdoctest_tags = ["coverage:excellent", "doc:complete"]
        val items: [DocItem] = [item]
        val csv = export_coverage_csv(items)

        val has_pipe = csv.contains("|")
        expect(has_pipe).to_equal(true)

    it "quotes tags field if contains comma":
        var item = create_test_item("test", "/src/std/test.spl", 10, true, true)
        item.sdoctest_tags = ["tag,with,comma"]
        val items: [DocItem] = [item]
        val csv = export_coverage_csv(items)

        val has_quotes = csv.contains("\"")
        expect(has_quotes).to_equal(true)

# ============================================================================
# Tests for different item types
# ============================================================================

describe "export_coverage_csv item types":
    it "exports function item":
        val item = DocItem.create_function("test", "/src/std/test.spl", 10, 5, "pub", "fn test()")
        val items: [DocItem] = [item]
        val csv = export_coverage_csv(items)

        val has_function = csv.contains("function")
        expect(has_function).to_equal(true)

    it "exports struct item":
        val item = DocItem.create_struct("Point", "/src/std/test.spl", 10, 5, "pub")
        val items: [DocItem] = [item]
        val csv = export_coverage_csv(items)

        val has_struct = csv.contains("struct")
        expect(has_struct).to_equal(true)

    it "exports class item":
        val item = DocItem.create_class("MyClass", "/src/std/test.spl", 10, 5, "pub")
        val items: [DocItem] = [item]
        val csv = export_coverage_csv(items)

        val has_class = csv.contains("class")
        expect(has_class).to_equal(true)

    it "exports enum item":
        val item = DocItem.create_enum("Status", "/src/std/test.spl", 10, 5, "pub")
        val items: [DocItem] = [item]
        val csv = export_coverage_csv(items)

        val has_enum = csv.contains("enum")
        expect(has_enum).to_equal(true)

# ============================================================================
# Tests for empty and edge cases
# ============================================================================

describe "export_coverage_csv edge cases":
    it "handles empty items array":
        val items: [DocItem] = []
        val csv = export_coverage_csv(items)

        val has_header = csv.contains("name,file,line")
        expect(has_header).to_equal(true)

    it "handles single item array":
        val item = create_test_item("only_one", "/src/std/test.spl", 10, true, true)
        val items: [DocItem] = [item]
        val csv = export_coverage_csv(items)

        val lines = csv.split("\n")
        val expected_lines = 2
        val has_correct_count = lines.len() >= expected_lines

        expect(has_correct_count).to_equal(true)

    it "handles many items":
        var items: [DocItem] = []
        var i = 0
        while i < 10:
            val item = create_test_item("fn{i}", "/src/std/test.spl", i, true, true)
            items.push(item)
            i = i + 1

        val csv = export_coverage_csv(items)

        val has_fn0 = csv.contains("fn0")
        val has_fn9 = csv.contains("fn9")

        expect(has_fn0).to_equal(true)
        expect(has_fn9).to_equal(true)

# ============================================================================
# Integration Tests
# ============================================================================

describe "export_coverage_csv integration":
    it "exports mixed item types with all fields":
        var func = DocItem.create_function("add", "/src/std/math.spl", 10, 5, "pub", "fn add(a: i64, b: i64) -> i64")
        func.is_public = true
        func.has_sdoctest = true
        func.has_inline_comment = true
        func.sdoctest_tags = ["coverage:excellent", "doc:complete"]

        var struct_item = DocItem.create_struct("Point", "/src/std/geometry.spl", 20, 5, "pub")
        struct_item.is_public = true
        struct_item.has_inline_comment = false

        val items: [DocItem] = [func, struct_item]
        val csv = export_coverage_csv(items)

        val has_header = csv.contains("name,file,line")
        val has_add = csv.contains("add")
        val has_point = csv.contains("Point")
        val has_math = csv.contains("math.spl")
        val has_geometry = csv.contains("geometry.spl")

        expect(has_header).to_equal(true)
        expect(has_add).to_equal(true)
        expect(has_point).to_equal(true)
        expect(has_math).to_equal(true)
        expect(has_geometry).to_equal(true)

    it "produces parseable CSV format":
        val item1 = create_test_item("fn1", "/src/std/test.spl", 10, true, true)
        val item2 = create_test_item("fn2", "/src/core/test.spl", 20, false, false)
        val items: [DocItem] = [item1, item2]
        val csv = export_coverage_csv(items)

        val lines = csv.split("\n")
        val has_header = lines.len() >= 1
        val has_data = lines.len() >= 3

        expect(has_header).to_equal(true)
        expect(has_data).to_equal(true)
