# JSON Export Tests
# Tests for JSON export format generation

use std.spec.{describe, it, expect}
use doc_coverage.reporting.json_exporter.{export_coverage_json}
use doc_coverage.types.coverage_result.{CoverageReport, FileCoverage}
use doc_coverage.types.doc_item.{DocItem, DocKind}

# ============================================================================
# Helper Functions
# ============================================================================

fn create_test_report() -> CoverageReport:
    var report = CoverageReport.create()
    report.total_items = 10
    report.documented_items = 7
    report.missing_docs = 3
    report.sdoctest_coverage = 5
    report.missing_sdoctest = 2
    report.timestamp = 1640000000
    report

fn create_test_file_coverage(path: text) -> FileCoverage:
    var file_cov = FileCoverage.create(path)
    file_cov.total_items = 3
    file_cov.documented_items = 2
    file_cov.missing_docs = 1
    file_cov.has_sdoctest = 1
    file_cov.missing_sdoctest = 1

    val item = DocItem.create_function("test_fn", path, 10, 5, "pub", "fn test_fn() -> i64")
    file_cov.items = [item]

    file_cov

# ============================================================================
# Tests for export_coverage_json structure
# ============================================================================

describe "export_coverage_json structure":
    it "generates valid JSON with summary section":
        val report = create_test_report()
        val json = export_coverage_json(report, false)

        val has_summary = json.contains("\"summary\":")
        expect(has_summary).to_equal(true)

    it "includes total_items in summary":
        val report = create_test_report()
        val json = export_coverage_json(report, false)

        val has_total = json.contains("\"total_items\": 10")
        expect(has_total).to_equal(true)

    it "includes documented_items in summary":
        val report = create_test_report()
        val json = export_coverage_json(report, false)

        val has_documented = json.contains("\"documented_items\": 7")
        expect(has_documented).to_equal(true)

    it "includes missing_docs in summary":
        val report = create_test_report()
        val json = export_coverage_json(report, false)

        val has_missing = json.contains("\"missing_docs\": 3")
        expect(has_missing).to_equal(true)

    it "includes sdoctest_coverage in summary":
        val report = create_test_report()
        val json = export_coverage_json(report, false)

        val has_sdoc = json.contains("\"sdoctest_coverage\": 5")
        expect(has_sdoc).to_equal(true)

    it "includes overall_percent in summary":
        val report = create_test_report()
        val json = export_coverage_json(report, false)

        val has_pct = json.contains("\"overall_percent\":")
        expect(has_pct).to_equal(true)

    it "includes timestamp in summary":
        val report = create_test_report()
        val json = export_coverage_json(report, false)

        val has_timestamp = json.contains("\"timestamp\": 1640000000")
        expect(has_timestamp).to_equal(true)

# ============================================================================
# Tests for files array
# ============================================================================

describe "export_coverage_json files array":
    it "includes files array":
        val report = create_test_report()
        val json = export_coverage_json(report, false)

        val has_files = json.contains("\"files\":")
        expect(has_files).to_equal(true)

    it "exports file coverage details":
        var report = create_test_report()
        val file_cov = create_test_file_coverage("/src/std/test.spl")
        report.files = [file_cov]

        val json = export_coverage_json(report, false)

        val has_file_path = json.contains("\"/src/std/test.spl\"")
        expect(has_file_path).to_equal(true)

    it "includes file total_items":
        var report = create_test_report()
        val file_cov = create_test_file_coverage("/src/std/test.spl")
        report.files = [file_cov]

        val json = export_coverage_json(report, false)

        val has_total = json.contains("\"total_items\": 3")
        expect(has_total).to_equal(true)

    it "handles multiple files":
        var report = create_test_report()
        val file1 = create_test_file_coverage("/src/std/test1.spl")
        val file2 = create_test_file_coverage("/src/std/test2.spl")
        report.files = [file1, file2]

        val json = export_coverage_json(report, false)

        val has_test1 = json.contains("test1.spl")
        val has_test2 = json.contains("test2.spl")

        expect(has_test1).to_equal(true)
        expect(has_test2).to_equal(true)

# ============================================================================
# Tests for item details
# ============================================================================

describe "export_coverage_json item details":
    it "includes item name":
        var report = create_test_report()
        var file_cov = create_test_file_coverage("/src/std/test.spl")

        var item = DocItem.create_function("my_function", "/src/std/test.spl", 10, 5, "pub", "fn my_function()")
        file_cov.items = [item]
        report.files = [file_cov]

        val json = export_coverage_json(report, false)

        val has_name = json.contains("\"name\": \"my_function\"")
        expect(has_name).to_equal(true)

    it "includes item kind":
        var report = create_test_report()
        var file_cov = create_test_file_coverage("/src/std/test.spl")

        var item = DocItem.create_function("test", "/src/std/test.spl", 10, 5, "pub", "fn test()")
        file_cov.items = [item]
        report.files = [file_cov]

        val json = export_coverage_json(report, false)

        val has_kind = json.contains("\"kind\": \"function\"")
        expect(has_kind).to_equal(true)

    it "includes line and column numbers":
        var report = create_test_report()
        var file_cov = create_test_file_coverage("/src/std/test.spl")

        var item = DocItem.create_function("test", "/src/std/test.spl", 42, 8, "pub", "fn test()")
        file_cov.items = [item]
        report.files = [file_cov]

        val json = export_coverage_json(report, false)

        val has_line = json.contains("\"line\": 42")
        val has_col = json.contains("\"col\": 8")

        expect(has_line).to_equal(true)
        expect(has_col).to_equal(true)

    it "includes boolean flags as JSON booleans":
        var report = create_test_report()
        var file_cov = create_test_file_coverage("/src/std/test.spl")

        var item = DocItem.create_function("test", "/src/std/test.spl", 10, 5, "pub", "fn test()")
        item.is_public = true
        item.has_inline_comment = false
        file_cov.items = [item]
        report.files = [file_cov]

        val json = export_coverage_json(report, false)

        val has_true = json.contains("\"is_public\": true")
        val has_false = json.contains("\"has_inline_comment\": false")

        expect(has_true).to_equal(true)
        expect(has_false).to_equal(true)

# ============================================================================
# Tests for tags inclusion
# ============================================================================

describe "export_coverage_json tags inclusion":
    it "excludes tags when include_tags is false":
        var report = create_test_report()
        var file_cov = create_test_file_coverage("/src/std/test.spl")

        var item = DocItem.create_function("test", "/src/std/test.spl", 10, 5, "pub", "fn test()")
        item.sdoctest_tags = ["tag1", "tag2"]
        file_cov.items = [item]
        report.files = [file_cov]

        val json = export_coverage_json(report, false)

        val has_tags = json.contains("\"tags\":")
        expect(has_tags).to_equal(false)

    it "includes tags when include_tags is true":
        var report = create_test_report()
        var file_cov = create_test_file_coverage("/src/std/test.spl")

        var item = DocItem.create_function("test", "/src/std/test.spl", 10, 5, "pub", "fn test()")
        item.sdoctest_tags = ["tag1", "tag2"]
        file_cov.items = [item]
        report.files = [file_cov]

        val json = export_coverage_json(report, true)

        val has_tags = json.contains("\"tags\":")
        expect(has_tags).to_equal(true)

    it "exports tag array correctly":
        var report = create_test_report()
        var file_cov = create_test_file_coverage("/src/std/test.spl")

        var item = DocItem.create_function("test", "/src/std/test.spl", 10, 5, "pub", "fn test()")
        item.sdoctest_tags = ["coverage:excellent", "doc:complete"]
        file_cov.items = [item]
        report.files = [file_cov]

        val json = export_coverage_json(report, true)

        val has_excellent = json.contains("\"coverage:excellent\"")
        val has_complete = json.contains("\"doc:complete\"")

        expect(has_excellent).to_equal(true)
        expect(has_complete).to_equal(true)

# ============================================================================
# Tests for JSON escaping
# ============================================================================

describe "export_coverage_json escaping":
    it "escapes quotes in strings":
        var report = create_test_report()
        var file_cov = create_test_file_coverage("/src/std/test.spl")

        var item = DocItem.create_function("test_\"quoted\"", "/src/std/test.spl", 10, 5, "pub", "fn test()")
        file_cov.items = [item]
        report.files = [file_cov]

        val json = export_coverage_json(report, false)

        val has_escaped = json.contains("\\\"")
        expect(has_escaped).to_equal(true)

    it "escapes backslashes in strings":
        var report = create_test_report()
        var file_cov = create_test_file_coverage("/home/user\\path/test.spl")
        report.files = [file_cov]

        val json = export_coverage_json(report, false)

        val has_escaped = json.contains("\\\\")
        expect(has_escaped).to_equal(true)

    it "handles newlines in signatures":
        var report = create_test_report()
        var file_cov = create_test_file_coverage("/src/std/test.spl")

        var item = DocItem.create_function("test", "/src/std/test.spl", 10, 5, "pub", "fn test()\n-> i64")
        file_cov.items = [item]
        report.files = [file_cov]

        val json = export_coverage_json(report, false)

        val has_escaped = json.contains("\\n")
        expect(has_escaped).to_equal(true)

# ============================================================================
# Tests for JSON validity
# ============================================================================

describe "export_coverage_json validity":
    it "starts with opening brace":
        val report = create_test_report()
        val json = export_coverage_json(report, false)

        val starts_correctly = json.starts_with("{")
        expect(starts_correctly).to_equal(true)

    it "ends with closing brace":
        val report = create_test_report()
        val json = export_coverage_json(report, false)

        val trimmed = json.trim()
        val ends_correctly = trimmed.ends_with("}")
        expect(ends_correctly).to_equal(true)

    it "contains proper JSON structure markers":
        val report = create_test_report()
        val json = export_coverage_json(report, false)

        val has_colons = json.contains(":")
        val has_commas = json.contains(",")
        val has_braces = json.contains("{") and json.contains("}")
        val has_brackets = json.contains("[") and json.contains("]")

        expect(has_colons).to_equal(true)
        expect(has_commas).to_equal(true)
        expect(has_braces).to_equal(true)
        expect(has_brackets).to_equal(true)

    it "handles empty files array":
        val report = create_test_report()
        val json = export_coverage_json(report, false)

        val has_files = json.contains("\"files\": [")
        expect(has_files).to_equal(true)

# ============================================================================
# Integration Tests
# ============================================================================

describe "export_coverage_json integration":
    it "exports complete report with all data":
        var report = create_test_report()
        var file_cov = create_test_file_coverage("/src/std/math.spl")

        var item1 = DocItem.create_function("add", "/src/std/math.spl", 10, 5, "pub", "fn add(a: i64, b: i64) -> i64")
        item1.is_public = true
        item1.has_inline_comment = true
        item1.has_sdoctest = true

        var item2 = DocItem.create_function("subtract", "/src/std/math.spl", 20, 5, "pub", "fn subtract(a: i64, b: i64) -> i64")
        item2.is_public = true
        item2.has_inline_comment = false
        item2.has_sdoctest = false

        file_cov.items = [item1, item2]
        report.files = [file_cov]

        val json = export_coverage_json(report, true)

        val has_summary = json.contains("\"summary\":")
        val has_files = json.contains("\"files\":")
        val has_add = json.contains("\"add\"")
        val has_subtract = json.contains("\"subtract\"")

        expect(has_summary).to_equal(true)
        expect(has_files).to_equal(true)
        expect(has_add).to_equal(true)
        expect(has_subtract).to_equal(true)
