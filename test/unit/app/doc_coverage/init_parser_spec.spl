# Init Parser Spec - Tests for __init__.spl comment-based parsing

use std.spec.{describe, it, expect}
use doc_coverage.analysis.init_parser.{parse_init_file, PublicApiGroup, PublicApiItem}
use app.io.mod (file_exists, cwd)

describe "InitParser - Comment-based API Documentation":
    it "parses real __init__.spl file from src/std/spec":
        val spec_init = cwd() + "/src/std/spec/__init__.spl"

        if file_exists(spec_init):
            val result = parse_init_file(spec_init)
            val groups = result.0
            val items = result.1

            # Should find at least one group or item
            val has_data = groups.len() > 0 or items.len() > 0
            expect(has_data).to_equal(true)

    it "detects group headers correctly":
        # Test the pattern matching for group headers
        val header1 = "# File operations"
        val header2 = "# - file_read"

        val has_cap1 = _contains_capital_in_text(header1)
        val has_cap2 = header2.contains(" - ")

        expect(has_cap1).to_equal(true)
        expect(has_cap2).to_equal(true)

    it "extracts item names from dash lines":
        # These patterns should be recognized as items
        val line1 = "#   - file_read"
        val line2 = "# - dir_create()"

        val has_dash1 = line1.contains(" - ")
        val has_dash2 = line2.contains(" - ")

        expect(has_dash1).to_equal(true)
        expect(has_dash2).to_equal(true)

    it "detects use statements for function extraction":
        val use_line = "use std.spec.{describe, it, expect}"
        val is_use = use_line.starts_with("use ")
        val has_braces = use_line.contains("{") and use_line.contains("}")

        expect(is_use).to_equal(true)
        expect(has_braces).to_equal(true)

    it "returns empty results for non-existent files":
        val fake_path = "/tmp/nonexistent_file.spl"
        val result = parse_init_file(fake_path)
        val groups = result.0
        val items = result.1

        expect(groups.len()).to_equal(0)
        expect(items.len()).to_equal(0)

# Helper function
fn _contains_capital_in_text(text: text) -> bool:
    var i = 0
    while i < text.len():
        val ch = text[i:i + 1]
        val is_cap = ch >= "A" and ch <= "Z"
        if is_cap:
            return true
        i = i + 1
    false
