# Markdown Report Tests
# Tests for markdown report generation

use std.spec.{describe, it, expect}
use doc_coverage.reporting.markdown_generator.{generate_coverage_markdown}
use doc_coverage.types.coverage_result.{CoverageReport, FileCoverage}
use doc_coverage.types.doc_item.{DocItem}

# ============================================================================
# Helper Functions
# ============================================================================

fn create_test_report_with_files() -> CoverageReport:
    var report = CoverageReport.create()
    report.total_items = 100
    report.documented_items = 75
    report.missing_docs = 25
    report.sdoctest_coverage = 50
    report.missing_sdoctest = 10
    report.timestamp = 1640000000

    # Add some test files
    var file1 = FileCoverage.create("src/std/string.spl")
    file1.total_items = 10
    file1.documented_items = 8
    file1.missing_docs = 2
    file1.has_sdoctest = 5
    file1.missing_sdoctest = 2

    var item1 = DocItem.create_function("trim", "src/std/string.spl", 10, 5, "pub", "fn trim(s: text) -> text")
    item1.is_public = true
    item1.has_sdoctest = false
    file1.items = [item1]

    var file2 = FileCoverage.create("src/core/parser.spl")
    file2.total_items = 20
    file2.documented_items = 10
    file2.missing_docs = 10
    file2.has_sdoctest = 3
    file2.missing_sdoctest = 5

    var item2 = DocItem.create_function("parse", "src/core/parser.spl", 20, 5, "pub", "fn parse(input: text) -> Ast")
    item2.is_public = true
    item2.has_sdoctest = false
    file2.items = [item2]

    report.files = [file1, file2]
    report

# ============================================================================
# Tests for markdown structure
# ============================================================================

describe "generate_coverage_markdown structure":
    it "includes title header":
        val report = create_test_report_with_files()
        val md = generate_coverage_markdown(report)

        val has_title = md.contains("# Documentation Coverage Report")
        expect(has_title).to_equal(true)

    it "includes summary section":
        val report = create_test_report_with_files()
        val md = generate_coverage_markdown(report)

        val has_summary = md.contains("## Summary")
        expect(has_summary).to_equal(true)

    it "includes coverage by scope section":
        val report = create_test_report_with_files()
        val md = generate_coverage_markdown(report)

        val has_scope = md.contains("## Coverage by Scope")
        expect(has_scope).to_equal(true)

    it "includes top files section":
        val report = create_test_report_with_files()
        val md = generate_coverage_markdown(report)

        val has_top_files = md.contains("## Top 10 Files Needing Documentation")
        expect(has_top_files).to_equal(true)

    it "includes missing sdoctests section":
        val report = create_test_report_with_files()
        val md = generate_coverage_markdown(report)

        val has_missing = md.contains("## Missing SDoctest Examples")
        expect(has_missing).to_equal(true)

# ============================================================================
# Tests for summary section
# ============================================================================

describe "generate_coverage_markdown summary":
    it "includes total items count":
        val report = create_test_report_with_files()
        val md = generate_coverage_markdown(report)

        val has_total = md.contains("**Total Items:** 100")
        expect(has_total).to_equal(true)

    it "includes documented count":
        val report = create_test_report_with_files()
        val md = generate_coverage_markdown(report)

        val has_documented = md.contains("**Documented:** 75")
        expect(has_documented).to_equal(true)

    it "includes missing docs count":
        val report = create_test_report_with_files()
        val md = generate_coverage_markdown(report)

        val has_missing = md.contains("**Missing Docs:** 25")
        expect(has_missing).to_equal(true)

    it "includes overall status indicator":
        val report = create_test_report_with_files()
        val md = generate_coverage_markdown(report)

        val has_status = md.contains("**Overall Status:**")
        expect(has_status).to_equal(true)

    it "includes sdoctest coverage":
        val report = create_test_report_with_files()
        val md = generate_coverage_markdown(report)

        val has_sdoctest = md.contains("**SDoctest Coverage:**")
        expect(has_sdoctest).to_equal(true)

# ============================================================================
# Tests for scope breakdown section
# ============================================================================

describe "generate_coverage_markdown scope breakdown":
    it "includes scope table":
        val report = create_test_report_with_files()
        val md = generate_coverage_markdown(report)

        val has_table = md.contains("| Scope | Files | Items | Documented | Coverage % |")
        expect(has_table).to_equal(true)

    it "includes table separator":
        val report = create_test_report_with_files()
        val md = generate_coverage_markdown(report)

        val has_separator = md.contains("|-------|-------|-------|------------|-----------|")
        expect(has_separator).to_equal(true)

    it "groups files by scope":
        val report = create_test_report_with_files()
        val md = generate_coverage_markdown(report)

        val has_std = md.contains("src/std")
        val has_core = md.contains("src/core")

        expect(has_std).to_equal(true)
        expect(has_core).to_equal(true)

# ============================================================================
# Tests for top files section
# ============================================================================

describe "generate_coverage_markdown top files":
    it "includes files table":
        val report = create_test_report_with_files()
        val md = generate_coverage_markdown(report)

        val has_table = md.contains("| File | Missing Docs | Total Items | Coverage % |")
        expect(has_table).to_equal(true)

    it "lists files with missing docs":
        val report = create_test_report_with_files()
        val md = generate_coverage_markdown(report)

        val has_parser = md.contains("parser.spl")
        expect(has_parser).to_equal(true)

    it "shows file paths in code blocks":
        val report = create_test_report_with_files()
        val md = generate_coverage_markdown(report)

        val has_code_block = md.contains("`")
        expect(has_code_block).to_equal(true)

# ============================================================================
# Tests for missing sdoctests section
# ============================================================================

describe "generate_coverage_markdown missing sdoctests":
    it "includes functions table":
        val report = create_test_report_with_files()
        val md = generate_coverage_markdown(report)

        val has_table = md.contains("| Function | File | Line |")
        expect(has_table).to_equal(true)

    it "lists functions without sdoctests":
        val report = create_test_report_with_files()
        val md = generate_coverage_markdown(report)

        val has_trim = md.contains("trim")
        val has_parse = md.contains("parse")

        expect(has_trim).to_equal(true)
        expect(has_parse).to_equal(true)

    it "shows line numbers":
        val report = create_test_report_with_files()
        val md = generate_coverage_markdown(report)

        val has_line_10 = md.contains("| 10 |") or md.contains(" 10 |")
        val has_line_20 = md.contains("| 20 |") or md.contains(" 20 |")

        expect(has_line_10).to_equal(true)
        expect(has_line_20).to_equal(true)

# ============================================================================
# Tests for markdown syntax validity
# ============================================================================

describe "generate_coverage_markdown syntax":
    it "uses proper header syntax":
        val report = create_test_report_with_files()
        val md = generate_coverage_markdown(report)

        val has_h1 = md.contains("# ")
        val has_h2 = md.contains("## ")

        expect(has_h1).to_equal(true)
        expect(has_h2).to_equal(true)

    it "uses proper table syntax":
        val report = create_test_report_with_files()
        val md = generate_coverage_markdown(report)

        val has_pipes = md.contains("|")
        expect(has_pipes).to_equal(true)

    it "uses proper bold syntax":
        val report = create_test_report_with_files()
        val md = generate_coverage_markdown(report)

        val has_bold = md.contains("**")
        expect(has_bold).to_equal(true)

    it "uses proper code block syntax":
        val report = create_test_report_with_files()
        val md = generate_coverage_markdown(report)

        val has_backticks = md.contains("`")
        expect(has_backticks).to_equal(true)

# ============================================================================
# Tests for status emojis
# ============================================================================

describe "generate_coverage_markdown status indicators":
    it "shows status emoji for overall coverage":
        val report = create_test_report_with_files()
        val md = generate_coverage_markdown(report)

        val has_emoji = md.contains("✅") or md.contains("⚠️") or md.contains("❌")
        expect(has_emoji).to_equal(true)

# ============================================================================
# Tests for empty cases
# ============================================================================

describe "generate_coverage_markdown empty cases":
    it "handles report with no files":
        var report = CoverageReport.create()
        report.total_items = 0
        report.documented_items = 0
        report.missing_docs = 0

        val md = generate_coverage_markdown(report)

        val has_summary = md.contains("## Summary")
        expect(has_summary).to_equal(true)

    it "handles files with no items":
        var report = CoverageReport.create()
        var file = FileCoverage.create("src/empty.spl")
        file.total_items = 0
        report.files = [file]

        val md = generate_coverage_markdown(report)

        val has_structure = md.contains("# Documentation Coverage Report")
        expect(has_structure).to_equal(true)

# ============================================================================
# Integration Tests
# ============================================================================

describe "generate_coverage_markdown integration":
    it "generates complete report with all sections":
        val report = create_test_report_with_files()
        val md = generate_coverage_markdown(report)

        val has_title = md.contains("# Documentation Coverage Report")
        val has_summary = md.contains("## Summary")
        val has_scope = md.contains("## Coverage by Scope")
        val has_top = md.contains("## Top 10 Files")
        val has_missing = md.contains("## Missing SDoctest")

        expect(has_title).to_equal(true)
        expect(has_summary).to_equal(true)
        expect(has_scope).to_equal(true)
        expect(has_top).to_equal(true)
        expect(has_missing).to_equal(true)

    it "formats numbers correctly":
        val report = create_test_report_with_files()
        val md = generate_coverage_markdown(report)

        val has_numbers = md.contains("100") and md.contains("75") and md.contains("25")
        expect(has_numbers).to_equal(true)

    it "produces valid markdown that could be rendered":
        val report = create_test_report_with_files()
        val md = generate_coverage_markdown(report)

        val has_newlines = md.contains("\n")
        val has_headers = md.contains("#")
        val has_tables = md.contains("|")

        expect(has_newlines).to_equal(true)
        expect(has_headers).to_equal(true)
        expect(has_tables).to_equal(true)
