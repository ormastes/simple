# LSP Message Dispatcher Tests
# Feature: Language Server Protocol Message Routing
# Category: LSP, Editor Integration
# Status: Complete
#
# Tests for LSP message dispatcher including request/notification routing,
# unknown method handling, and message type detection.

use app.lsp.server.{ServerState, LspServer}

# Local type definitions (test stubs)

struct Position:
    line: i64
    character: i64

struct Range:
    start: Position
    end: Position

enum DiagnosticSeverity:
    Error
    Warning
    Information
    Hint

struct Diagnostic:
    range: Range
    severity: DiagnosticSeverity
    message: str
    source: str

enum CompletionItemKind:
    Text = 1
    Method = 2
    Function = 3
    Variable = 6
    Keyword = 14
    Struct = 22

struct CompletionItem:
    label: str
    kind: i64
    detail: Option<str>
    documentation: Option<str>
    insert_text: Option<str>



describe "Request Dispatcher":
    # Tests for LSP request message routing.

    context "Known Methods":
        it "routes initialize request":
            val server = LspServer.new()
            val request = JsonRpcRequest(
                id: 1,
                method: "initialize",
                params: Some({})
            )

            val result = server.handle_request(request)
            expect result.is_ok()
            expect server.state == ServerState.Initialized

        it "routes shutdown request":
            var server = LspServer.new()
            server.state = ServerState.Initialized

            val request = JsonRpcRequest(
                id: 2,
                method: "shutdown",
                params: nil
            )

            val result = server.handle_request(request)
            expect result.is_ok()
            expect server.state == ServerState.ShuttingDown

        it "routes textDocument/semanticTokens/full request":
            var server = LspServer.new()
            server.state = ServerState.Initialized

            val request = JsonRpcRequest(
                id: 3,
                method: "textDocument/semanticTokens/full",
                params: Some({
                    "textDocument": {"uri": "file:///test.spl"}
                })
            )

            # Should route to handler (will return error for missing doc)
            val result = server.handle_request(request)
            # Either ok with error response, or err
            expect result.is_ok() or result.err.?

        it "routes textDocument/hover request":
            var server = LspServer.new()
            server.state = ServerState.Initialized

            val request = JsonRpcRequest(
                id: 4,
                method: "textDocument/hover",
                params: Some({
                    "textDocument": {"uri": "file:///test.spl"},
                    "position": {"line": 0, "character": 0}
                })
            )

            val result = server.handle_request(request)
            expect result.is_ok() or result.err.?

        it "routes textDocument/definition request":
            var server = LspServer.new()
            server.state = ServerState.Initialized

            val request = JsonRpcRequest(
                id: 5,
                method: "textDocument/definition",
                params: Some({
                    "textDocument": {"uri": "file:///test.spl"},
                    "position": {"line": 0, "character": 0}
                })
            )

            val result = server.handle_request(request)
            expect result.is_ok() or result.err.?

        it "routes textDocument/references request":
            var server = LspServer.new()
            server.state = ServerState.Initialized

            val request = JsonRpcRequest(
                id: 6,
                method: "textDocument/references",
                params: Some({
                    "textDocument": {"uri": "file:///test.spl"},
                    "position": {"line": 0, "character": 0}
                })
            )

            val result = server.handle_request(request)
            expect result.is_ok() or result.err.?

        it "routes textDocument/completion request":
            var server = LspServer.new()
            server.state = ServerState.Initialized

            val request = JsonRpcRequest(
                id: 7,
                method: "textDocument/completion",
                params: Some({
                    "textDocument": {"uri": "file:///test.spl"},
                    "position": {"line": 0, "character": 0}
                })
            )

            val result = server.handle_request(request)
            expect result.is_ok() or result.err.?

        it "routes simple/leanDefinition request":
            var server = LspServer.new()
            server.state = ServerState.Initialized

            val request = JsonRpcRequest(
                id: 8,
                method: "simple/leanDefinition",
                params: Some({
                    "textDocument": {"uri": "file:///test.spl"},
                    "position": {"line": 0, "character": 0}
                })
            )

            val result = server.handle_request(request)
            expect result.is_ok() or result.err.?

        it "routes simple/verificationSymbols request":
            var server = LspServer.new()
            server.state = ServerState.Initialized

            val request = JsonRpcRequest(
                id: 9,
                method: "simple/verificationSymbols",
                params: Some({
                    "textDocument": {"uri": "file:///test.spl"}
                })
            )

            val result = server.handle_request(request)
            expect result.is_ok() or result.err.?

    context "Unknown Methods":
        it "returns error for unknown method":
            var server = LspServer.new()
            server.state = ServerState.Initialized

            val request = JsonRpcRequest(
                id: 99,
                method: "unknown/method",
                params: nil
            )

            val result = server.handle_request(request)
            # Should return Ok (error sent via transport)
            expect result.is_ok()

        it "handles textDocument/codeAction (not implemented)":
            var server = LspServer.new()
            server.state = ServerState.Initialized

            val request = JsonRpcRequest(
                id: 100,
                method: "textDocument/codeAction",
                params: Some({
                    "textDocument": {"uri": "file:///test.spl"},
                    "range": {
                        "start": {"line": 0, "character": 0},
                        "end": {"line": 0, "character": 10}
                    }
                })
            )

            # Should return method not found error
            val result = server.handle_request(request)
            expect result.is_ok()

describe "Notification Dispatcher":
    # Tests for LSP notification message routing.

    context "Known Notifications":
        it "routes initialized notification":
            var server = LspServer.new()
            server.state = ServerState.Initialized

            val notification = JsonRpcNotification(
                method: "initialized",
                params: nil
            )

            val result = server.handle_notification(notification)
            expect result.is_ok()

        it "routes textDocument/didOpen notification":
            var server = LspServer.new()
            server.state = ServerState.Initialized

            val notification = JsonRpcNotification(
                method: "textDocument/didOpen",
                params: Some({
                    "textDocument": {
                        "uri": "file:///test.spl",
                        "languageId": "simple",
                        "version": 1,
                        "text": "fn main(): print(\"Hello\")"
                    }
                })
            )

            val result = server.handle_notification(notification)
            expect result.is_ok()

        it "routes textDocument/didChange notification":
            var server = LspServer.new()
            server.state = ServerState.Initialized

            # First open document
            val open_notif = JsonRpcNotification(
                method: "textDocument/didOpen",
                params: Some({
                    "textDocument": {
                        "uri": "file:///test.spl",
                        "languageId": "simple",
                        "version": 1,
                        "text": "fn main(): print(\"Hello\")"
                    }
                })
            )
            server.handle_notification(open_notif)

            # Then change it
            val change_notif = JsonRpcNotification(
                method: "textDocument/didChange",
                params: Some({
                    "textDocument": {
                        "uri": "file:///test.spl",
                        "version": 2
                    },
                    "contentChanges": [
                        {"text": "fn main(): print(\"World\")"}
                    ]
                })
            )

            val result = server.handle_notification(change_notif)
            expect result.is_ok()

        it "routes textDocument/didClose notification":
            var server = LspServer.new()
            server.state = ServerState.Initialized

            val notification = JsonRpcNotification(
                method: "textDocument/didClose",
                params: Some({
                    "textDocument": {"uri": "file:///test.spl"}
                })
            )

            val result = server.handle_notification(notification)
            expect result.is_ok()

    context "Unknown Notifications":
        it "ignores unknown notification":
            var server = LspServer.new()
            server.state = ServerState.Initialized

            val notification = JsonRpcNotification(
                method: "unknown/notification",
                params: nil
            )

            # Should succeed (LSP spec allows ignoring unknown notifications)
            val result = server.handle_notification(notification)
            expect result.is_ok()

        it "ignores window/logMessage":
            var server = LspServer.new()
            server.state = ServerState.Initialized

            val notification = JsonRpcNotification(
                method: "window/logMessage",
                params: Some({
                    "type": 3,
                    "message": "Test message"
                })
            )

            val result = server.handle_notification(notification)
            expect result.is_ok()

        it "ignores $/cancelRequest":
            var server = LspServer.new()
            server.state = ServerState.Initialized

            val notification = JsonRpcNotification(
                method: "$/cancelRequest",
                params: Some({"id": 123})
            )

            val result = server.handle_notification(notification)
            expect result.is_ok()

describe "Error Handling":
    # Tests for error path handling in dispatchers.

    context "Request Errors":
        it "handles missing params for completion":
            var server = LspServer.new()
            server.state = ServerState.Initialized

            val request = JsonRpcRequest(
                id: 10,
                method: "textDocument/completion",
                params: nil
            )

            val result = server.handle_request(request)
            expect result.err.?

        it "handles missing params for definition":
            var server = LspServer.new()
            server.state = ServerState.Initialized

            val request = JsonRpcRequest(
                id: 11,
                method: "textDocument/definition",
                params: nil
            )

            val result = server.handle_request(request)
            expect result.err.?

        it "handles missing params for hover":
            var server = LspServer.new()
            server.state = ServerState.Initialized

            val request = JsonRpcRequest(
                id: 12,
                method: "textDocument/hover",
                params: nil
            )

            val result = server.handle_request(request)
            expect result.err.?

        it "handles missing params for references":
            var server = LspServer.new()
            server.state = ServerState.Initialized

            val request = JsonRpcRequest(
                id: 13,
                method: "textDocument/references",
                params: nil
            )

            val result = server.handle_request(request)
            expect result.err.?

        it "handles missing params for semantic tokens":
            var server = LspServer.new()
            server.state = ServerState.Initialized

            val request = JsonRpcRequest(
                id: 14,
                method: "textDocument/semanticTokens/full",
                params: nil
            )

            val result = server.handle_request(request)
            expect result.err.?

    context "Document Not Found Errors":
        it "handles completion on missing document":
            var server = LspServer.new()
            server.state = ServerState.Initialized

            val request = JsonRpcRequest(
                id: 20,
                method: "textDocument/completion",
                params: Some({
                    "textDocument": {"uri": "file:///nonexistent.spl"},
                    "position": {"line": 0, "character": 0}
                })
            )

            # Should return error response via transport
            val result = server.handle_request(request)
            expect result.is_ok()

        it "handles definition on missing document":
            var server = LspServer.new()
            server.state = ServerState.Initialized

            val request = JsonRpcRequest(
                id: 21,
                method: "textDocument/definition",
                params: Some({
                    "textDocument": {"uri": "file:///nonexistent.spl"},
                    "position": {"line": 0, "character": 0}
                })
            )

            val result = server.handle_request(request)
            expect result.is_ok()

        it "handles hover on missing document":
            var server = LspServer.new()
            server.state = ServerState.Initialized

            val request = JsonRpcRequest(
                id: 22,
                method: "textDocument/hover",
                params: Some({
                    "textDocument": {"uri": "file:///nonexistent.spl"},
                    "position": {"line": 0, "character": 0}
                })
            )

            val result = server.handle_request(request)
            expect result.is_ok()

describe "Request ID Handling":
    # Tests for request ID preservation in responses.

    context "Response Correlation":
        it "preserves request ID in initialize response":
            val server = LspServer.new()
            val request = JsonRpcRequest(
                id: 42,
                method: "initialize",
                params: Some({})
            )

            val result = server.handle_request(request)
            expect result.is_ok()
            # Response should have id=42 (verified via transport)

        it "handles string request IDs":
            var server = LspServer.new()
            server.state = ServerState.Initialized

            # LSP allows string or number IDs
            # (In practice, this test would use a modified JsonRpcRequest
            #  that supports string IDs, or test at transport layer)

        it "handles sequential request IDs":
            var server = LspServer.new()
            server.state = ServerState.Initialized

            # Multiple requests with different IDs
            for i in 1..6:
                val request = JsonRpcRequest(
                    id: i,
                    method: "initialize",
                    params: Some({})
                )
                val result = server.handle_request(request)
                expect result.is_ok()
