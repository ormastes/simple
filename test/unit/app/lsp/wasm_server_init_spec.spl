# WASM Language Server Initialization Tests
#
# Tests ParserAdapter creation, backend selection, and WASI LSP helpers.
# Uses real imports from parser_adapter.spl.

use app.lsp.parser_adapter.{ParserBackend, ParseDiagnostic, ParseResult, ParserAdapter, ParserAdapter__create_core, ParserAdapter__create_treesitter}

describe "WASM LSP Server Initialization":

    context "ParserAdapter creation":
        it "creates core parser adapter":
            val adapter = ParserAdapter__create_core()
            expect(adapter.is_wasm_mode()).to_equal(true)

        it "creates treesitter adapter":
            val adapter = ParserAdapter__create_treesitter()
            expect(adapter.is_wasm_mode()).to_equal(false)

        it "core adapter uses CoreParser backend":
            val adapter = ParserAdapter__create_core()
            expect(adapter.backend).to_equal(ParserBackend.CoreParser)

        it "treesitter adapter uses TreeSitter backend":
            val adapter = ParserAdapter__create_treesitter()
            expect(adapter.backend).to_equal(ParserBackend.TreeSitter)

    context "ParserBackend enum":
        it "TreeSitter is distinct from CoreParser":
            val ts = ParserBackend.TreeSitter
            val core = ParserBackend.CoreParser
            expect(ts == core).to_equal(false)

    context "ParseDiagnostic":
        it "creates diagnostic with line and column":
            val diag = ParseDiagnostic(
                line: 5, column: 10,
                end_line: 5, end_column: 15,
                message: "Unexpected token",
                severity: 1
            )
            expect(diag.line).to_equal(5)
            expect(diag.column).to_equal(10)
            expect(diag.message).to_equal("Unexpected token")
            expect(diag.severity).to_equal(1)

        it "creates warning diagnostic":
            val diag = ParseDiagnostic(
                line: 1, column: 0,
                end_line: 1, end_column: 5,
                message: "Unused variable",
                severity: 2
            )
            expect(diag.severity).to_equal(2)

    context "ParseResult":
        it "creates successful result":
            val result = ParseResult(
                success: true,
                diagnostics: [],
                semantic_tokens: []
            )
            expect(result.success).to_equal(true)
            expect(result.diagnostics.len()).to_equal(0)

        it "creates result with diagnostics":
            val diag = ParseDiagnostic(
                line: 0, column: 0,
                end_line: 0, end_column: 1,
                message: "Error",
                severity: 1
            )
            val result = ParseResult(
                success: false,
                diagnostics: [diag],
                semantic_tokens: []
            )
            expect(result.success).to_equal(false)
            expect(result.diagnostics.len()).to_equal(1)

    context "Core parser parsing":
        it "parses valid Simple code":
            val adapter = ParserAdapter__create_core()
            val result = adapter.parse("val x = 42")
            expect(result.success).to_equal(true)
            expect(result.diagnostics.len()).to_equal(0)

        it "parses multi-line code":
            val adapter = ParserAdapter__create_core()
            val result = adapter.parse("fn foo():\n    val x = 1\n    x")
            expect(result.success).to_equal(true)

        it "detects unmatched closing paren":
            val adapter = ParserAdapter__create_core()
            val result = adapter.parse("val x = )")
            expect(result.success).to_equal(false)
            expect(result.diagnostics.len()).to_be_greater_than(0)
            expect(result.diagnostics[0].message).to_contain("parenthesis")

        it "detects unmatched closing bracket":
            val adapter = ParserAdapter__create_core()
            val result = adapter.parse("val x = ]")
            expect(result.success).to_equal(false)
            expect(result.diagnostics.len()).to_be_greater_than(0)
            expect(result.diagnostics[0].message).to_contain("bracket")

        it "parses empty source":
            val adapter = ParserAdapter__create_core()
            val result = adapter.parse("")
            expect(result.success).to_equal(true)

        it "parses comments only":
            val adapter = ParserAdapter__create_core()
            val result = adapter.parse("# This is a comment")
            expect(result.success).to_equal(true)

        it "parses balanced parentheses":
            val adapter = ParserAdapter__create_core()
            val result = adapter.parse("val x = (1 + (2 * 3))")
            expect(result.success).to_equal(true)
