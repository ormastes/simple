# MCP CLI Tools (Tier 1) Specification
#
# **Feature IDs:** #MCP-CLI-001
# **Category:** Tooling
# **Difficulty:** 2/5
# **Status:** Implemented
#
# ## Overview
#
# Tests the 6 Tier 1 MCP CLI tool handlers:
# simple_test, simple_build, simple_format, simple_lint, simple_fix, simple_doc_coverage
#
# ## Behavior
#
# - Each tool wraps a bin/simple CLI command via shell_cmd
# - Parameters are optional except simple_fix (path required)
# - Output includes exit code and command output

use std.spec

# ============================================================================
# Test Group 1: simple_test tool
# ============================================================================

describe "simple_test tool":
    it "builds test command with no args":
        var cmd = "timeout 120 bin/simple test"
        cmd = cmd + " 2>&1"
        expect(cmd).to_contain("bin/simple test")

    it "builds test command with path":
        val path = "test/unit/app/mcp/api_tool_spec.spl"
        var cmd = "timeout 120 bin/simple test"
        if path != "":
            cmd = cmd + " " + path
        cmd = cmd + " 2>&1"
        expect(cmd).to_contain(path)

    it "builds test command with filter":
        val filter_str = "symbol"
        var cmd = "timeout 120 bin/simple test"
        if filter_str != "":
            cmd = cmd + " --filter " + filter_str
        expect(cmd).to_contain("--filter symbol")

    it "builds test command with list flag":
        val list_flag = "true"
        var cmd = "timeout 120 bin/simple test"
        if list_flag == "true":
            cmd = cmd + " --list"
        expect(cmd).to_contain("--list")

    it "builds test command with only-slow flag":
        val only_slow = "true"
        var cmd = "timeout 120 bin/simple test"
        if only_slow == "true":
            cmd = cmd + " --only-slow"
        expect(cmd).to_contain("--only-slow")

# ============================================================================
# Test Group 2: simple_build tool
# ============================================================================

describe "simple_build tool":
    it "builds basic build command":
        var cmd = "timeout 300 bin/simple build"
        cmd = cmd + " 2>&1"
        expect(cmd).to_contain("bin/simple build")

    it "builds release build command":
        val release = "true"
        var cmd = "timeout 300 bin/simple build"
        if release == "true":
            cmd = cmd + " --release"
        expect(cmd).to_contain("--release")

    it "builds with target":
        val target = "aarch64"
        var cmd = "timeout 300 bin/simple build"
        if target != "":
            cmd = cmd + " --target " + target
        expect(cmd).to_contain("--target aarch64")

    it "builds with warn-docs":
        val warn_docs = "true"
        var cmd = "timeout 300 bin/simple build"
        if warn_docs == "true":
            cmd = cmd + " --warn-docs"
        expect(cmd).to_contain("--warn-docs")

# ============================================================================
# Test Group 3: simple_format tool
# ============================================================================

describe "simple_format tool":
    it "builds fmt command":
        var cmd = "timeout 60 bin/simple fmt"
        cmd = cmd + " 2>&1"
        expect(cmd).to_contain("bin/simple fmt")

    it "builds fmt command with check flag":
        val check = "true"
        var cmd = "timeout 60 bin/simple fmt"
        if check == "true":
            cmd = cmd + " --check"
        expect(cmd).to_contain("--check")

    it "builds fmt command with path":
        val path = "src/app/cli/main.spl"
        var cmd = "timeout 60 bin/simple fmt"
        if path != "":
            cmd = cmd + " " + path
        expect(cmd).to_contain(path)

# ============================================================================
# Test Group 4: simple_lint tool
# ============================================================================

describe "simple_lint tool":
    it "builds lint command":
        var cmd = "timeout 60 bin/simple lint"
        cmd = cmd + " 2>&1"
        expect(cmd).to_contain("bin/simple lint")

    it "builds lint command with path":
        val path = "src/lib/"
        var cmd = "timeout 60 bin/simple lint"
        if path != "":
            cmd = cmd + " " + path
        expect(cmd).to_contain("src/lib/")

# ============================================================================
# Test Group 5: simple_fix tool
# ============================================================================

describe "simple_fix tool":
    it "requires path parameter":
        val path = ""
        val has_error = path == ""
        expect(has_error).to_equal(true)

    it "builds fix command with path":
        val path = "src/app/cli/main.spl"
        var cmd = "timeout 60 bin/simple fix " + path
        cmd = cmd + " 2>&1"
        expect(cmd).to_contain("bin/simple fix")
        expect(cmd).to_contain(path)

    it "builds fix command with dry-run":
        val path = "src/app/cli/main.spl"
        val dry_run = "true"
        var cmd = "timeout 60 bin/simple fix " + path
        if dry_run == "true":
            cmd = cmd + " --dry-run"
        expect(cmd).to_contain("--dry-run")

# ============================================================================
# Test Group 6: simple_doc_coverage tool
# ============================================================================

describe "simple_doc_coverage tool":
    it "builds doc-coverage command":
        var cmd = "timeout 60 bin/simple doc-coverage"
        cmd = cmd + " 2>&1"
        expect(cmd).to_contain("bin/simple doc-coverage")

    it "builds doc-coverage with format":
        val format_str = "md"
        var cmd = "timeout 60 bin/simple doc-coverage"
        if format_str != "":
            cmd = cmd + " --format=" + format_str
        expect(cmd).to_contain("--format=md")

    it "builds doc-coverage with missing flag":
        val missing = "true"
        var cmd = "timeout 60 bin/simple doc-coverage"
        if missing == "true":
            cmd = cmd + " --missing"
        expect(cmd).to_contain("--missing")
