# Provider MIME Type Tests
# Tests BaseProvider, FileProvider, and MIME type detection

use std.spec
use app.mcp.helpers.{detect_file_content_type, detect_mime_type, LB, RB, jp, js, jo1, jo2, make_result_response, make_error_response}

describe "Provider MIME Type Detection":
    describe "BaseProvider":
        it "checks has_key for resource lookup":
            val params = jo1(jp("uri", js("file:///test.spl")))
            val has_resource = params.contains("uri")
            expect(has_resource).to_equal(true)

        it "handles missing key":
            val params = jo1(jp("other", js("value")))
            val has_resource = params.contains("uri")
            expect(has_resource).to_equal(false)

    describe "FileProvider MIME Detection":
        it "detects text/plain for .txt files":
            val mime = detect_mime_type("test.txt")
            expect(mime).to_equal("text/plain")

        it "detects application/json for .json files":
            val mime = detect_mime_type("config.json")
            expect(mime).to_equal("application/json")

        it "detects text/markdown for .md files":
            val mime = detect_mime_type("README.md")
            expect(mime).to_equal("text/markdown")

        it "defaults to text/plain for unknown":
            val mime = detect_mime_type("file.xyz")
            expect(mime).to_equal("text/plain")

        it "detects text/x-simple for .spl files":
            val mime = detect_mime_type("main.spl")
            expect(mime).to_equal("text/x-simple")

    describe "Content Type Categories":
        it "categorizes PNG as image":
            val content_type = detect_file_content_type("photo.png")
            expect(content_type).to_equal("image")

        it "categorizes JPEG as image":
            val content_type = detect_file_content_type("photo.jpg")
            expect(content_type).to_equal("image")

        it "categorizes GIF as image":
            val content_type = detect_file_content_type("anim.gif")
            expect(content_type).to_equal("image")

        it "categorizes SVG as image":
            val content_type = detect_file_content_type("icon.svg")
            expect(content_type).to_equal("image")

        it "categorizes WAV as audio":
            val content_type = detect_file_content_type("sound.wav")
            expect(content_type).to_equal("audio")

        it "categorizes MP3 as audio":
            val content_type = detect_file_content_type("song.mp3")
            expect(content_type).to_equal("audio")

        it "categorizes SPL as text":
            val content_type = detect_file_content_type("main.spl")
            expect(content_type).to_equal("text")

        it "defaults unknown to text":
            val content_type = detect_file_content_type("data.xyz")
            expect(content_type).to_equal("text")

    describe "Image MIME Types":
        it "PNG maps to image/png":
            expect(detect_mime_type("test.png")).to_equal("image/png")

        it "JPEG maps to image/jpeg":
            expect(detect_mime_type("test.jpg")).to_equal("image/jpeg")

        it "GIF maps to image/gif":
            expect(detect_mime_type("test.gif")).to_equal("image/gif")

        it "SVG maps to image/svg+xml":
            expect(detect_mime_type("test.svg")).to_equal("image/svg+xml")

        it "WebP maps to image/webp":
            expect(detect_mime_type("test.webp")).to_equal("image/webp")

    describe "Audio MIME Types":
        it "WAV maps to audio/wav":
            expect(detect_mime_type("sound.wav")).to_equal("audio/wav")

        it "MP3 maps to audio/mpeg":
            expect(detect_mime_type("song.mp3")).to_equal("audio/mpeg")

        it "OGG maps to audio/ogg":
            expect(detect_mime_type("clip.ogg")).to_equal("audio/ogg")

    describe "URI Validation":
        it "validates file:// URIs":
            val uri = "file:///home/user/test.spl"
            val is_file_uri = uri.starts_with("file://")
            expect(is_file_uri).to_equal(true)

        it "validates http:// URIs":
            val uri = "http://example.com/resource"
            val is_http_uri = uri.starts_with("http://")
            expect(is_http_uri).to_equal(true)

        it "rejects invalid URIs":
            val uri = "invalid://test"
            val is_valid_file = uri.starts_with("file://")
            val is_valid_http = uri.starts_with("http://")
            val is_valid = is_valid_file or is_valid_http
            expect(is_valid).to_equal(false)
