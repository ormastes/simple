"""
MCP Sampling Support Specification
Feature: MCP Sampling Requests
Category: MCP, Protocol
Status: Complete
"""

use std.spec
use app.mcp.helpers.{LB, RB, jp, js, jo2, make_sampling_request, make_server_request}

describe "MCP Sampling Request":
    it "builds sampling request with messages and max tokens":
        val messages = "[" + jo2(jp("role", js("user")), jp("content", js("Hello"))) + "]"
        val req = make_sampling_request("srv-1", messages, "", "", 1000)
        expect(req.contains("\"method\":\"sampling/createMessage\"")).to_equal(true)
        expect(req.contains("\"maxTokens\":1000")).to_equal(true)
        expect(req.contains("\"id\":srv-1")).to_equal(true)

    it "includes model preferences when provided":
        val messages = "[]"
        val prefs = jo2(jp("model", js("claude-3")), jp("temperature", "0.7"))
        val req = make_sampling_request("srv-1", messages, prefs, "", 500)
        expect(req.contains("\"modelPreferences\"")).to_equal(true)

    it "includes system prompt when provided":
        val messages = "[]"
        val req = make_sampling_request("srv-1", messages, "", "You are helpful", 500)
        expect(req.contains("You are helpful")).to_equal(true)

describe "MCP Server Request":
    it "builds server-to-client request":
        val params = LB() + jp("key", js("value")) + RB()
        val req = make_server_request("srv-1", "custom/method", params)
        expect(req.contains("\"method\":\"custom/method\"")).to_equal(true)
        expect(req.contains("\"id\":srv-1")).to_equal(true)
        expect(req.contains("\"jsonrpc\":\"2.0\"")).to_equal(true)
