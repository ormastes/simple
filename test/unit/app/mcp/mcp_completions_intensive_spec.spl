"""
# MCP Completions Intensive Specification

Covers completion handling branches in `src/app/mcp/completions.spl`.
"""

use app.mcp.completions.{handle_completion}
use app.mcp.resources
use app.mcp.prompts

describe "MCP Completions - Prompt Completions":
    it "completes prompt names when arg_name is empty":
        val prompt_mgr = PromptManager.create(".")
        val resource_mgr = ResourceManager.create(".")
        val resp = handle_completion("1", "ref/prompt", "", "", "refactor-", resource_mgr, prompt_mgr)
        expect(resp.contains("refactor-rename")).to_equal(true)
        expect(resp.contains("\"hasMore\":false")).to_equal(true)

    it "completes language argument":
        val prompt_mgr = PromptManager.create(".")
        val resource_mgr = ResourceManager.create(".")
        val resp = handle_completion("2", "ref/prompt", "", "language", "py", resource_mgr, prompt_mgr)
        expect(resp.contains("python")).to_equal(true)

    it "completes style argument":
        val prompt_mgr = PromptManager.create(".")
        val resource_mgr = ResourceManager.create(".")
        val resp = handle_completion("3", "ref/prompt", "", "style", "d", resource_mgr, prompt_mgr)
        expect(resp.contains("detailed")).to_equal(true)

    it "returns empty for unknown prompt arg":
        val prompt_mgr = PromptManager.create(".")
        val resource_mgr = ResourceManager.create(".")
        val resp = handle_completion("4", "ref/prompt", "", "unknown", "x", resource_mgr, prompt_mgr)
        expect(resp.contains("\"values\":[]")).to_equal(true)
        expect(resp.contains("\"total\":0")).to_equal(true)


describe "MCP Completions - Resource Completions":
    it "completes file resource prefixes":
        val prompt_mgr = PromptManager.create(".")
        val resource_mgr = ResourceManager.create(".")
        val resp = handle_completion("5", "ref/resource", "file:///*", "", "src", resource_mgr, prompt_mgr)
        expect(resp.contains("src/")).to_equal(true)

    it "completes bugdb queries":
        val prompt_mgr = PromptManager.create(".")
        val resource_mgr = ResourceManager.create(".")
        val resp = handle_completion("6", "ref/resource", "bugdb:///*", "", "c", resource_mgr, prompt_mgr)
        expect(resp.contains("critical")).to_equal(true)

    it "completes symbol and type names":
        val prompt_mgr = PromptManager.create(".")
        val resource_mgr = ResourceManager.create(".")
        val resp = handle_completion("7", "ref/resource", "symbol:///*", "", "S", resource_mgr, prompt_mgr)
        expect(resp.contains("String")).to_equal(true)
        val resp2 = handle_completion("8", "ref/resource", "type:///*", "", "B", resource_mgr, prompt_mgr)
        expect(resp2.contains("Bool")).to_equal(true)

    it "returns empty for unknown ref_type":
        val prompt_mgr = PromptManager.create(".")
        val resource_mgr = ResourceManager.create(".")
        val resp = handle_completion("9", "ref/unknown", "", "", "", resource_mgr, prompt_mgr)
        expect(resp.contains("\"values\":[]")).to_equal(true)
        expect(resp.contains("\"total\":0")).to_equal(true)
