# MCP Server End-to-End Integration Tests
# Feature: MCP Server E2E
# Category: MCP, Integration, E2E
# Status: In Progress
#
# End-to-end tests using real MCP helpers for JSON building and response formatting.

use std.spec
use std.text.{NL}
use app.mcp.helpers.{LB, RB, Q, jp, js, jo1, jo2, jo3, extract_json_string, extract_json_value, extract_nested_string, escape_json, make_result_response, make_error_response, make_tool_result, log_level_to_int, make_log_notification, make_notification, detect_mime_type, detect_file_content_type, make_image_content, make_resource_link_content}

# ----------- Tests -----------

describe "MCP E2E - extract_json_string round trip":
    it "extracts string from built JSON":
        val json = jo2(jp("method", js("initialize")), jp("id", "1"))
        val method = extract_json_string(json, "method")
        expect(method).to_equal("initialize")

    it "extracts nested string from built JSON":
        val params = jo1(jp("name", js("read_code")))
        val json = jo2(jp("method", js("tools/call")), jp("params", params))
        val name = extract_nested_string(json, "params", "name")
        expect(name).to_equal("read_code")

    it "handles missing keys gracefully":
        val json = jo1(jp("method", js("test")))
        val missing = extract_json_string(json, "nonexistent")
        expect(missing).to_equal("")

describe "MCP E2E - extract_json_value":
    it "extracts numeric value":
        val json = jo2(jp("id", "42"), jp("method", js("test")))
        expect(extract_json_value(json, "id")).to_equal("42")

    it "extracts boolean value":
        val json = jo1(jp("flag", "true"))
        expect(extract_json_value(json, "flag")).to_equal("true")

    it "returns null for missing key":
        val json = jo1(jp("a", "1"))
        expect(extract_json_value(json, "missing")).to_equal("null")

describe "MCP E2E - escape_json":
    it "escapes strings with special characters":
        val escaped = escape_json("line1{NL}line2")
        expect(escaped.contains(NL)).to_equal(false)

    it "handles empty string":
        expect(escape_json("")).to_equal("")

    it "preserves normal characters":
        expect(escape_json("hello")).to_equal("hello")

describe "MCP E2E - make_result_response":
    it "creates valid JSON-RPC response":
        val response = make_result_response("1", js("ok"))
        expect(response.contains("jsonrpc")).to_equal(true)
        expect(response.contains("2.0")).to_equal(true)
        expect(response.contains("result")).to_equal(true)

    it "includes specified id":
        val response = make_result_response("42", js("done"))
        expect(response.contains("42")).to_equal(true)

describe "MCP E2E - make_error_response":
    it "creates error response with code":
        val response = make_error_response("1", -32600, "Invalid request")
        expect(response.contains("-32600")).to_equal(true)
        expect(response.contains("Invalid request")).to_equal(true)

    it "includes error object":
        val response = make_error_response("1", -32601, "Method not found")
        expect(response.contains("error")).to_equal(true)

describe "MCP E2E - make_tool_result":
    it "creates tool result with content":
        val result = make_tool_result("1", "Hello world")
        expect(result.contains("content")).to_equal(true)
        expect(result.contains("text")).to_equal(true)

    it "includes jsonrpc version":
        val result = make_tool_result("1", "test")
        expect(result.contains("2.0")).to_equal(true)

describe "MCP E2E - log level ordering":
    it "debug is lowest priority":
        val debug_level = log_level_to_int("debug")
        val info_level = log_level_to_int("info")
        expect(debug_level < info_level).to_equal(true)

    it "emergency is highest priority":
        val emergency_level = log_level_to_int("emergency")
        val error_level = log_level_to_int("error")
        expect(emergency_level > error_level).to_equal(true)

    it "all levels are ordered":
        val d = log_level_to_int("debug")
        val i = log_level_to_int("info")
        val n = log_level_to_int("notice")
        val w = log_level_to_int("warning")
        val e = log_level_to_int("error")
        val c = log_level_to_int("critical")
        val a = log_level_to_int("alert")
        val em = log_level_to_int("emergency")
        expect(d < i).to_equal(true)
        expect(i < n).to_equal(true)
        expect(n < w).to_equal(true)
        expect(w < e).to_equal(true)
        expect(e < c).to_equal(true)
        expect(c < a).to_equal(true)
        expect(a < em).to_equal(true)

describe "MCP E2E - make_log_notification":
    it "includes method field":
        val notif = make_log_notification("info", "Server started", "mcp")
        expect(notif.contains("notifications/message")).to_equal(true)

    it "includes log level":
        val notif = make_log_notification("warning", "Low memory", "mcp")
        expect(notif.contains("warning")).to_equal(true)

    it "includes logger name":
        val notif = make_log_notification("info", "Test", "mcp.tools")
        expect(notif.contains("mcp.tools")).to_equal(true)

describe "MCP E2E - detect_mime_type":
    it "detects Simple language files":
        expect(detect_mime_type("test.spl")).to_equal("text/x-simple")

    it "detects JSON files":
        expect(detect_mime_type("config.json")).to_equal("application/json")

    it "detects markdown files":
        expect(detect_mime_type("README.md")).to_equal("text/markdown")

    it "detects PNG images":
        expect(detect_mime_type("logo.png")).to_equal("image/png")

    it "defaults to text/plain for unknown":
        expect(detect_mime_type("file.xyz")).to_equal("text/plain")

describe "MCP E2E - detect_file_content_type":
    it "detects image files":
        expect(detect_file_content_type("photo.jpg")).to_equal("image")

    it "detects audio files":
        expect(detect_file_content_type("song.mp3")).to_equal("audio")

    it "detects text files":
        expect(detect_file_content_type("code.spl")).to_equal("text")

describe "MCP E2E - make_image_content":
    it "creates image content object":
        val content = make_image_content("base64data", "image/png")
        expect(content.contains("image")).to_equal(true)
        expect(content.contains("base64data")).to_equal(true)
        expect(content.contains("image/png")).to_equal(true)

describe "MCP E2E - make_resource_link_content":
    it "creates resource link with uri and name":
        val content = make_resource_link_content("file:///test.spl", "test.spl")
        expect(content.contains("resource_link")).to_equal(true)
        expect(content.contains("test.spl")).to_equal(true)
