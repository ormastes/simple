# # MCP Debug Session Intensive Specification
#
# Covers session creation, lookup, state changes, and breakpoint management
# in `src/app/mcp/debug_session.spl`.

use std.spec
use app.mcp.debug_session.{SessionManager}

describe "MCP Debug Session Manager":
    it "creates and lists sessions":
        val mgr = SessionManager.empty()
        val s1 = mgr.create_session("prog1.spl", "interpreter")
        val s2 = mgr.create_session("prog2.spl", "smf")
        expect(s1.id).to_equal("session_1")
        expect(s2.id).to_equal("session_2")
        expect(mgr.list_sessions().len()).to_equal(2)

    it "finds and removes sessions":
        val mgr = SessionManager.empty()
        val s1 = mgr.create_session("prog.spl", "interpreter")
        expect(mgr.find_session(s1.id)).to_equal(0)
        expect(mgr.find_session("missing")).to_equal(-1)
        expect(mgr.remove_session("missing")).to_equal(false)
        expect(mgr.remove_session(s1.id)).to_equal(true)
        expect(mgr.list_sessions().len()).to_equal(0)

    it "adds and removes breakpoints":
        val mgr = SessionManager.empty()
        val s1 = mgr.create_session("prog.spl", "interpreter")
        val bp1 = mgr.add_breakpoint(s1.id, "file.spl", 10, "")
        val bp2 = mgr.add_breakpoint(s1.id, "file.spl", 20, "x > 0")
        expect(bp1).to_equal("1")
        expect(bp2).to_equal("2")
        val sessions = mgr.list_sessions()
        expect(sessions[0].breakpoints.len()).to_equal(2)
        expect(mgr.remove_breakpoint(s1.id, "1")).to_equal(true)
        expect(mgr.remove_breakpoint(s1.id, "bad")).to_equal(false)
        expect(mgr.remove_breakpoint("missing", "1")).to_equal(false)
        val after = mgr.list_sessions()
        expect(after[0].breakpoints.len()).to_equal(1)

    it "handles missing sessions for add_breakpoint":
        val mgr = SessionManager.empty()
        val bp = mgr.add_breakpoint("missing", "file.spl", 1, "")
        expect(bp).to_equal("")

    it "updates session state":
        val mgr = SessionManager.empty()
        val s1 = mgr.create_session("prog.spl", "interpreter")
        expect(mgr.set_state("missing", "running")).to_equal(false)
        expect(mgr.set_state(s1.id, "running")).to_equal(true)
        val sessions = mgr.list_sessions()
        expect(sessions[0].state).to_equal("running")

    it "adds and removes data breakpoints":
        val mgr = SessionManager.empty()
        val s1 = mgr.create_session("prog.spl", "interpreter")
        val dbp1 = mgr.add_data_breakpoint(s1.id, "counter", "write", "")
        val dbp2 = mgr.add_data_breakpoint(s1.id, "total", "readWrite", "total > 10")
        expect(dbp1).to_equal("1")
        expect(dbp2).to_equal("2")
        val sessions = mgr.list_sessions()
        expect(sessions[0].data_breakpoints.len()).to_equal(2)
        expect(mgr.remove_data_breakpoint(s1.id, "1")).to_equal(true)
        expect(mgr.remove_data_breakpoint(s1.id, "bad")).to_equal(false)
        expect(mgr.remove_data_breakpoint("missing", "1")).to_equal(false)
        val after = mgr.list_sessions()
        expect(after[0].data_breakpoints.len()).to_equal(1)

    it "handles missing sessions for data breakpoints":
        val mgr = SessionManager.empty()
        val dbp = mgr.add_data_breakpoint("missing", "x", "write", "")
        expect(dbp).to_equal("")
