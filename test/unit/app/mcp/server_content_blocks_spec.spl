# Server Content Block Tests
# Tests ContentBlock variant handling in responses

use std.spec
use app.mcp.helpers.{LB, RB, Q, jp, js, jo1, jo2, make_result_response, make_image_content, make_tool_result, escape_json}

describe "Server Content Blocks":
    describe "ContentBlock Types":
        it "handles Text content block":
            val block = jo2(jp("type", js("text")), jp("text", js("hello")))
            expect(block.contains("text")).to_equal(true)

        it "handles Image content block":
            val block = make_image_content("base64data", "image/png")
            expect(block.contains("image")).to_equal(true)

        it "handles Resource content block":
            val block = jo2(jp("type", js("resource")), jp("uri", js("file:///test.spl")))
            expect(block.contains("resource")).to_equal(true)

    describe "Content Block Serialization":
        it "serializes text block to JSON":
            val block = jo2(jp("type", js("text")), jp("text", js("content")))
            expect(block.contains("text")).to_equal(true)
            expect(block.contains("content")).to_equal(true)

        it "serializes image block to JSON":
            val block = make_image_content("ABCD==", "image/jpeg")
            expect(block.contains("ABCD==")).to_equal(true)
            expect(block.contains("image/jpeg")).to_equal(true)

        it "serializes resource block to JSON":
            val block = jo2(jp("type", js("resource")), jp("uri", js("file:///test.spl")))
            expect(block.contains("resource")).to_equal(true)
            expect(block.contains("file:///test.spl")).to_equal(true)

    describe "Content Block Lists":
        it "handles empty content list":
            val content = LB() + RB()
            val response = make_result_response("1", jo1(jp("content", content)))
            expect(response.contains("content")).to_equal(true)

        it "handles single content block":
            val block = jo1(jp("type", js("text")))
            val content = "[" + block + "]"
            expect(content.contains("text")).to_equal(true)

        it "handles multiple content blocks":
            val b1 = jo1(jp("type", js("text")))
            val b2 = jo1(jp("type", js("image")))
            val b3 = jo1(jp("type", js("resource")))
            val content = "[" + b1 + "," + b2 + "," + b3 + "]"
            expect(content.contains("text")).to_equal(true)
            expect(content.contains("image")).to_equal(true)
            expect(content.contains("resource")).to_equal(true)

    describe "Content Block Validation":
        it "validates text block has text field":
            val block = jo2(jp("type", js("text")), jp("text", js("hello")))
            expect(block.contains("text")).to_equal(true)

        it "validates image block has data and mimeType":
            val block = make_image_content("data==", "image/png")
            expect(block.contains("data")).to_equal(true)
            expect(block.contains("image/png")).to_equal(true)

        it "validates resource block has uri":
            val block = jo2(jp("type", js("resource")), jp("uri", js("file:///test.spl")))
            expect(block.contains("uri")).to_equal(true)
