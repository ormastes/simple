# JSON Conversion Tests
# Tests any_to_json and json_value_to_any conversions

use std.spec
use app.mcp.helpers.{LB, RB, Q, jp, js, jo1, jo2, jo3, extract_json_string, extract_json_value, escape_json}

describe "JSON Conversion":
    describe "any_to_json Type Branches":
        it "converts bool to JSON":
            val json = "true"
            expect(json).to_equal("true")

        it "converts i64 to JSON":
            val json = "42"
            expect(json).to_equal("42")

        it "converts f64 to JSON":
            val json = "3.14"
            expect(json.contains("3.14")).to_equal(true)

        it "converts text to JSON":
            val json = js("hello")
            expect(json.contains("hello")).to_equal(true)

        it "converts list to JSON array":
            val json = "[1,2,3]"
            expect(json.starts_with("[")).to_equal(true)
            expect(json.ends_with("]")).to_equal(true)

        it "converts dict to JSON object":
            val json = jo1(jp("key", js("value")))
            expect(json.contains("key")).to_equal(true)

        it "handles nil conversion":
            val json = "null"
            expect(json).to_equal("null")

        it "uses fallback for unknown types":
            val json = js("unknown")
            expect(json.contains("unknown")).to_equal(true)

    describe "json_value_to_any Type Branches":
        it "converts JSON bool to any":
            val value = extract_json_value(jo1(jp("v", "true")), "v")
            expect(value).to_equal("true")

        it "converts JSON number to any":
            val value = extract_json_value(jo1(jp("v", "42")), "v")
            expect(value).to_equal("42")

        it "converts JSON string to any":
            val value = extract_json_string(jo1(jp("v", js("text"))), "v")
            expect(value).to_equal("text")

        it "converts JSON array to any":
            val json = jo1(jp("v", "[1,2,3]"))
            val value = extract_json_value(json, "v")
            expect(value.starts_with("[")).to_equal(true)

        it "converts JSON object to any":
            val inner = jo1(jp("a", "1"))
            val json = jo1(jp("v", inner))
            val value = extract_json_value(json, "v")
            expect(value.contains("a")).to_equal(true)

        it "converts JSON null to any":
            val json = jo1(jp("v", "null"))
            val value = extract_json_value(json, "v")
            expect(value).to_equal("null")

    describe "Edge Cases":
        it "handles empty list":
            val json = LB() + RB()
            expect(json.len() > 0).to_equal(true)

        it "handles empty dict":
            val json = LB() + RB()
            expect(json.len() > 0).to_equal(true)

        it "handles nested structures":
            val inner = jo1(jp("nested", js("value")))
            val outer = jo1(jp("outer", inner))
            expect(outer.contains("nested")).to_equal(true)
            expect(outer.contains("value")).to_equal(true)

        it "handles special characters in strings":
            val escaped = escape_json("hello \"world\"")
            expect(escaped.contains("world")).to_equal(true)

    describe "Round-Trip Conversion":
        it "preserves bool through conversion":
            val original = "true"
            val json = jo1(jp("v", original))
            val extracted = extract_json_value(json, "v")
            expect(extracted).to_equal(original)

        it "preserves number through conversion":
            val original = "42"
            val json = jo1(jp("v", original))
            val extracted = extract_json_value(json, "v")
            expect(extracted).to_equal(original)

        it "preserves string through conversion":
            val original = "hello"
            val json = jo1(jp("v", js(original)))
            val extracted = extract_json_string(json, "v")
            expect(extracted).to_equal(original)

        it "preserves nested structure through conversion":
            val inner = jo1(jp("key", js("val")))
            val outer = jo1(jp("data", inner))
            val extracted = extract_json_value(outer, "data")
            expect(extracted.contains("key")).to_equal(true)
