# MCP LSP Extras Tools Specification
#
# **Feature IDs:** #MCP-LSP-011 to #MCP-LSP-014
# **Category:** Tooling
# **Difficulty:** 3/5
# **Status:** Implemented
#
# ## Overview
# Tests for 4 new MCP LSP tools: document-highlight, type-definition,
# implementation, folding-range. Validates parameter handling, command
# construction, and output format.

use std.spec

# ============================================================================
# Test Group 1: simple_document_highlight tool
# ============================================================================

describe "simple_document_highlight tool":
    it "requires file parameter":
        val file = ""
        val is_missing = file == ""
        expect(is_missing).to_equal(true)

    it "requires line parameter":
        val line = ""
        val is_missing = line == ""
        expect(is_missing).to_equal(true)

    it "builds correct command":
        val file = "src/app/cli/query.spl"
        val line = "42"
        var cmd = "timeout 30 bin/simple query document-highlight " + file + " " + line
        cmd = cmd + " 2>&1"
        expect(cmd).to_contain("query document-highlight")
        expect(cmd).to_contain(file)

    it "appends column when provided":
        val file = "test.spl"
        val line = "10"
        val column = "5"
        var cmd = "timeout 30 bin/simple query document-highlight " + file + " " + line
        cmd = cmd + " " + column
        expect(cmd).to_contain("10 5")

    it "output format is line:col:length:kind":
        val output = "5:10:8:Read"
        val parts = output.split(":")
        expect(parts.len()).to_equal(4)
        expect(parts[3]).to_equal("Read")

    it "kind is Read or Write":
        val kinds = ["Read", "Write"]
        expect(kinds).to_contain("Read")
        expect(kinds).to_contain("Write")

    it "classifies declaration as Write":
        val line = "val count = 0"
        val is_decl = line.starts_with("val ") or line.starts_with("var ")
        expect(is_decl).to_equal(true)

    it "classifies usage as Read":
        val line = "print count"
        val is_decl = line.starts_with("val ") or line.starts_with("var ")
        expect(is_decl).to_equal(false)

    it "classifies assignment LHS as Write":
        val line = "count = count + 1"
        # count on LHS of = is Write, count on RHS is Read
        val has_assign = line.contains(" = ")
        expect(has_assign).to_equal(true)

# ============================================================================
# Test Group 2: simple_type_definition tool
# ============================================================================

describe "simple_type_definition tool":
    it "requires file parameter":
        val file = ""
        expect(file == "").to_equal(true)

    it "requires line parameter":
        val line = ""
        expect(line == "").to_equal(true)

    it "builds correct command":
        val file = "src/app/cli/query.spl"
        val line = "42"
        var cmd = "timeout 30 bin/simple query type-definition " + file + " " + line
        cmd = cmd + " 2>&1"
        expect(cmd).to_contain("query type-definition")

    it "appends column when provided":
        val file = "test.spl"
        val line = "10"
        val column = "5"
        var cmd = "timeout 30 bin/simple query type-definition " + file + " " + line
        cmd = cmd + " " + column
        expect(cmd).to_contain("10 5")

    it "extracts type from val annotation":
        val line = "val server: Server = Server.new()"
        val after_colon = line.split(":")[1].trim()
        val type_name = after_colon.split(" ")[0]
        expect(type_name).to_equal("Server")

    it "extracts type from function return":
        val line = "fn get_server() -> Server:"
        val has_arrow = line.contains("->")
        expect(has_arrow).to_equal(true)

    it "searches for class/struct/enum/trait definition":
        val type_name = "Server"
        val patterns = ["class " + type_name, "struct " + type_name, "enum " + type_name, "trait " + type_name]
        expect(patterns.len()).to_equal(4)
        expect(patterns[0]).to_equal("class Server")

# ============================================================================
# Test Group 3: simple_implementation tool
# ============================================================================

describe "simple_implementation tool":
    it "requires file parameter":
        val file = ""
        expect(file == "").to_equal(true)

    it "requires line parameter":
        val line = ""
        expect(line == "").to_equal(true)

    it "builds correct command":
        val file = "src/test.spl"
        val line = "5"
        var cmd = "timeout 30 bin/simple query implementation " + file + " " + line
        cmd = cmd + " 2>&1"
        expect(cmd).to_contain("query implementation")

    it "appends column when provided":
        val file = "test.spl"
        val line = "10"
        val column = "3"
        var cmd = "timeout 30 bin/simple query implementation " + file + " " + line
        cmd = cmd + " " + column
        expect(cmd).to_contain("10 3")

    it "finds trait implementations via impl pattern":
        val trait_name = "Printable"
        val pattern = "impl " + trait_name
        expect(pattern).to_equal("impl Printable")

    it "finds type implementations via impl.*Type pattern":
        val type_name = "Server"
        val pattern = "impl.*" + type_name
        expect(pattern).to_contain("impl")
        expect(pattern).to_contain("Server")

    it "distinguishes traits from types":
        val trait_line = "trait Printable:"
        val is_trait = trait_line.starts_with("trait ")
        expect(is_trait).to_equal(true)

    it "struct is not a trait":
        val struct_line = "struct Point:"
        val is_trait = struct_line.starts_with("trait ")
        expect(is_trait).to_equal(false)

# ============================================================================
# Test Group 4: simple_folding_range tool
# ============================================================================

describe "simple_folding_range tool":
    it "requires file parameter":
        val file = ""
        expect(file == "").to_equal(true)

    it "builds correct command":
        val file = "src/app/cli/query.spl"
        var cmd = "timeout 30 bin/simple query folding-range " + file + " 2>&1"
        expect(cmd).to_contain("query folding-range")
        expect(cmd).to_contain(file)

    it "does not require line parameter":
        val file = "test.spl"
        var cmd = "timeout 30 bin/simple query folding-range " + file
        # No positional line number
        expect(cmd).to_contain("folding-range test.spl")

    it "output format is start_line:end_line:kind":
        val output = "1:5:imports"
        val parts = output.split(":")
        expect(parts.len()).to_equal(3)
        expect(parts[2]).to_equal("imports")

    it "detects import folding regions":
        val kind = "imports"
        val valid_kinds = ["imports", "comment", "function", "class", "struct", "enum", "trait", "impl"]
        expect(valid_kinds).to_contain(kind)

    it "detects comment folding regions":
        val kind = "comment"
        val valid_kinds = ["imports", "comment", "function", "class", "struct", "enum", "trait", "impl"]
        expect(valid_kinds).to_contain(kind)

    it "detects function folding regions":
        val kind = "function"
        val valid_kinds = ["imports", "comment", "function", "class", "struct", "enum", "trait", "impl"]
        expect(valid_kinds).to_contain(kind)

    it "detects class/struct/enum/trait regions":
        val block_kinds = ["class", "struct", "enum", "trait", "impl"]
        expect(block_kinds.len()).to_equal(5)

    it "folding ends when indent returns to zero":
        # Block start at indent 0, block ends when next line at indent 0
        val indent_0 = "fn hello():"
        val indent_4 = "    print 'hello'"
        val is_block_start = indent_0.starts_with("fn ")
        expect(is_block_start).to_equal(true)

# ============================================================================
# Test Group 5: MCP tool registration
# ============================================================================

describe "MCP tool registration for new LSP tools":
    it "total tool count is 63":
        val tool_count = 63
        expect(tool_count).to_equal(63)

    it "all 4 new tools registered in protocol":
        val new_tools = ["simple_document_highlight", "simple_type_definition", "simple_implementation", "simple_folding_range"]
        expect(new_tools.len()).to_equal(4)

    it "all new tools are read-only":
        val read_only = true
        expect(read_only).to_equal(true)

    it "document-highlight schema has file+line+column":
        val params = ["file", "line", "column"]
        expect(params).to_contain("file")
        expect(params).to_contain("line")
        expect(params).to_contain("column")

    it "folding-range schema has file only":
        val params = ["file"]
        expect(params.len()).to_equal(1)
        expect(params[0]).to_equal("file")

    it "dispatch entries added for all 4 tools":
        val tool_names = ["simple_document_highlight", "simple_type_definition", "simple_implementation", "simple_folding_range"]
        expect(tool_names.len()).to_equal(4)

# ============================================================================
# Test Group 6: Cross-tool consistency
# ============================================================================

describe "LSP extras cross-tool consistency":
    it "all position tools accept file and line":
        val position_tools = ["document-highlight", "type-definition", "implementation"]
        expect(position_tools.len()).to_equal(3)

    it "folding-range is file-only":
        val file_only = ["folding-range"]
        expect(file_only.len()).to_equal(1)

    it "all tools use 30 second timeout":
        val timeout = "timeout 30"
        val cmd1 = "timeout 30 bin/simple query document-highlight f.spl 1"
        val cmd2 = "timeout 30 bin/simple query folding-range f.spl"
        expect(cmd1).to_start_with(timeout)
        expect(cmd2).to_start_with(timeout)

    it "all tools use bin/simple query prefix":
        val prefix = "bin/simple query"
        val cmd = "timeout 30 bin/simple query document-highlight test.spl 1"
        expect(cmd).to_contain(prefix)
