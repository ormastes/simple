"""
MCP Logger Tests
Feature: MCP Logging Utilities
Category: MCP, Logging
Status: Complete

Tests for MCP log level conversion and log notification building.
"""

use std.spec
use app.mcp.helpers.{log_level_to_int, make_log_notification, make_notification, make_notification_no_params, LB, RB, Q, jp, js, jo1, escape_json}

describe "log_level_to_int":
    it "converts debug to 0":
        expect(log_level_to_int("debug")).to_equal(0)

    it "converts info to 1":
        expect(log_level_to_int("info")).to_equal(1)

    it "converts notice to 2":
        expect(log_level_to_int("notice")).to_equal(2)

    it "converts warning to 3":
        expect(log_level_to_int("warning")).to_equal(3)

    it "converts error to 4":
        expect(log_level_to_int("error")).to_equal(4)

    it "converts critical to 5":
        expect(log_level_to_int("critical")).to_equal(5)

    it "converts alert to 6":
        expect(log_level_to_int("alert")).to_equal(6)

    it "converts emergency to 7":
        expect(log_level_to_int("emergency")).to_equal(7)

    it "returns -1 for unknown level":
        expect(log_level_to_int("unknown")).to_equal(-1)

    it "returns -1 for empty string":
        expect(log_level_to_int("")).to_equal(-1)

describe "log_level_to_int - ordering":
    it "debug is lower than info":
        val debug_level = log_level_to_int("debug")
        val info_level = log_level_to_int("info")
        expect(debug_level < info_level).to_equal(true)

    it "info is lower than notice":
        expect(log_level_to_int("info") < log_level_to_int("notice")).to_equal(true)

    it "notice is lower than warning":
        expect(log_level_to_int("notice") < log_level_to_int("warning")).to_equal(true)

    it "warning is lower than error":
        expect(log_level_to_int("warning") < log_level_to_int("error")).to_equal(true)

    it "error is lower than critical":
        expect(log_level_to_int("error") < log_level_to_int("critical")).to_equal(true)

    it "critical is lower than alert":
        expect(log_level_to_int("critical") < log_level_to_int("alert")).to_equal(true)

    it "alert is lower than emergency":
        expect(log_level_to_int("alert") < log_level_to_int("emergency")).to_equal(true)

describe "log_level_to_int - filtering logic":
    it "message at min level should emit":
        val min_level = log_level_to_int("warning")
        val msg_level = log_level_to_int("warning")
        expect(msg_level >= min_level).to_equal(true)

    it "message above min level should emit":
        val min_level = log_level_to_int("warning")
        val msg_level = log_level_to_int("error")
        expect(msg_level >= min_level).to_equal(true)

    it "message below min level should not emit":
        val min_level = log_level_to_int("warning")
        val msg_level = log_level_to_int("info")
        expect(msg_level >= min_level).to_equal(false)

    it "debug messages suppressed at info level":
        val min_level = log_level_to_int("info")
        val msg_level = log_level_to_int("debug")
        expect(msg_level >= min_level).to_equal(false)

    it "emergency always passes any valid level":
        val min_level = log_level_to_int("emergency")
        val msg_level = log_level_to_int("emergency")
        expect(msg_level >= min_level).to_equal(true)

describe "make_log_notification":
    it "includes notifications/message method":
        val notif = make_log_notification("info", "Server started", "mcp")
        expect(notif.contains("notifications/message")).to_equal(true)

    it "includes log level":
        val notif = make_log_notification("warning", "Low memory", "mcp")
        expect(notif.contains("warning")).to_equal(true)

    it "includes log data":
        val notif = make_log_notification("error", "Connection failed", "mcp")
        expect(notif.contains("Connection failed")).to_equal(true)

    it "includes logger name when provided":
        val notif = make_log_notification("info", "Test message", "mcp.tools")
        expect(notif.contains("mcp.tools")).to_equal(true)

    it "includes jsonrpc version":
        val notif = make_log_notification("debug", "Debug data", "")
        expect(notif.contains("2.0")).to_equal(true)

    it "handles empty logger name":
        val notif = make_log_notification("info", "Test", "")
        expect(notif.contains("notifications/message")).to_equal(true)

    it "handles special characters in data":
        val notif = make_log_notification("info", "line1\nline2", "mcp")
        expect(notif.contains("notifications/message")).to_equal(true)

describe "make_notification":
    it "creates notification with method and params":
        val params = jo1(jp("level", js("info")))
        val notif = make_notification("test/method", params)
        expect(notif.contains("test/method")).to_equal(true)
        expect(notif.contains("params")).to_equal(true)

    it "includes jsonrpc version":
        val notif = make_notification("test/method", LB() + RB())
        expect(notif.contains("2.0")).to_equal(true)

describe "make_notification_no_params":
    it "creates notification without params":
        val notif = make_notification_no_params("notifications/initialized")
        expect(notif.contains("notifications/initialized")).to_equal(true)

    it "does not include params":
        val notif = make_notification_no_params("test/method")
        expect(notif.contains("params")).to_equal(false)
