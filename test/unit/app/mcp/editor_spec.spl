"""
# MCP Editor Intensive Specification

Covers document load/save and edit operations
in `src/app/mcp/editor.spl`.
"""

use std.spec
import app.mcp.editor

extern fn rt_file_write_text(path: text, content: text) -> bool
extern fn rt_file_read_text(path: text) -> text

fn read_text(path: text) -> text:
    rt_file_read_text(path) ?? ""


describe "MCP Editor - ManagedDocument":
    it "loads documents from disk":
        val path = "/tmp/mcp_editor_load.txt"
        rt_file_write_text(path, "line1\nline2")
        match ManagedDocument.load(path):
            case Ok(doc):
                expect(doc.lines.len()).to_equal(2)
                expect(doc.version).to_equal(1)
                expect(doc.dirty).to_equal(false)
            case Err(_):
                expect(false).to_equal(true)

    it "fails to load missing documents":
        match ManagedDocument.load("/tmp/mcp_editor_missing.txt"):
            case Ok(_):
                expect(false).to_equal(true)
            case Err(e):
                expect(e.contains("Failed to load")).to_equal(true)

    it "rebuilds content and marks dirty":
        var doc = ManagedDocument(
            path: "/tmp/mcp_editor_rebuild.txt",
            content: "a",
            lines: ["a"],
            version: 1,
            dirty: false
        )
        doc.lines.push("b")
        doc.rebuild()
        expect(doc.content.contains("a\nb")).to_equal(true)
        expect(doc.version).to_equal(2)
        expect(doc.dirty).to_equal(true)

    it "saves documents to disk":
        val path = "/tmp/mcp_editor_save.txt"
        var doc = ManagedDocument(
            path: path,
            content: "save1\nsave2",
            lines: ["save1", "save2"],
            version: 1,
            dirty: true
        )
        match doc.save():
            case Ok(_):
                expect(doc.dirty).to_equal(false)
                expect(read_text(path).contains("save1")).to_equal(true)
            case Err(_):
                expect(false).to_equal(true)

    it "reports save errors":
        var doc = ManagedDocument(
            path: "/tmp",
            content: "x",
            lines: ["x"],
            version: 1,
            dirty: true
        )
        match doc.save():
            case Ok(_):
                expect(false).to_equal(true)
            case Err(e):
                expect(e.contains("Failed to save")).to_equal(true)


describe "MCP Editor - DocumentManager":
    it "opens existing and new documents":
        val path = "/tmp/mcp_editor_open.txt"
        rt_file_write_text(path, "one")
        var mgr = DocumentManager.empty()
        match mgr.open(path):
            case Ok(doc):
                expect(doc.path).to_equal(path)
            case Err(_):
                expect(false).to_equal(true)
        # existing doc branch
        match mgr.open(path):
            case Ok(doc2):
                expect(doc2.path).to_equal(path)
            case Err(_):
                expect(false).to_equal(true)

    it "inserts, deletes, replaces, and copies":
        val path = "/tmp/mcp_editor_ops.txt"
        var doc = ManagedDocument(
            path: path,
            content: "a\nb\nc",
            lines: ["a", "b", "c"],
            version: 1,
            dirty: false
        )
        var mgr = DocumentManager.empty()
        mgr.documents[path] = doc

        val ins = mgr.insert(path, 2, "x\ny")
        expect(ins.success).to_equal(true)
        expect(mgr.documents[path].lines.len()).to_equal(5)

        val del_err = mgr.delete(path, 5, 4)
        expect(del_err.success).to_equal(false)

        val del_ok = mgr.delete(path, 2, 3)
        expect(del_ok.success).to_equal(true)

        val rep = mgr.replace(path, 2, 2, "z")
        expect(rep.success).to_equal(true)

        match mgr.copy(path, 1, 2):
            case Ok(text):
                expect(text.contains("1:")).to_equal(true)
            case Err(_):
                expect(false).to_equal(true)

    it "saves documents via manager":
        val path = "/tmp/mcp_editor_mgr_save.txt"
        var doc = ManagedDocument(
            path: path,
            content: "save",
            lines: ["save"],
            version: 1,
            dirty: true
        )
        var mgr = DocumentManager.empty()
        mgr.documents[path] = doc
        val ok = mgr.save(path)
        expect(ok.success).to_equal(true)
        val missing = mgr.save("/tmp/mcp_editor_missing_doc.txt")
        expect(missing.success).to_equal(false)
