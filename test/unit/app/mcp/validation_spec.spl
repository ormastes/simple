# MCP Input Validation Tests
# Feature: MCP Input Validation and Bounds Checking
# Category: MCP, Validation, Security
# Status: Complete

use std.spec
use app.mcp.{ErrorCategory, McpError, ValidationLimits, InputValidator}
use app.mcp.{mcp_error, default_validation_limits, strict_validation_limits, input_validator}

describe "Content length validation":
    it "accepts zero length":
        val validator = input_validator()
        val result = validator.validate_content_length(0)
        expect(result).to_be_nil()

    it "accepts normal length":
        val validator = input_validator()
        val result = validator.validate_content_length(1000)
        expect(result).to_be_nil()

    it "rejects negative length":
        val validator = input_validator()
        val result = validator.validate_content_length(-100)
        match result:
            case nil: expect(false).to_equal(true)
            case err: expect(err.message.contains("negative")).to_equal(true)

    it "rejects excessive length":
        val validator = input_validator()
        val result = validator.validate_content_length(2000000)
        match result:
            case nil: expect(false).to_equal(true)
            case err: expect(err.message.contains("exceeds")).to_equal(true)

    it "accepts at exact limit":
        val validator = input_validator()
        val limits = default_validation_limits()
        val result = validator.validate_content_length(limits.max_content_length)
        expect(result).to_be_nil()

describe "String length validation":
    it "accepts empty string":
        val validator = input_validator()
        val result = validator.validate_string("")
        expect(result).to_be_nil()

    it "accepts normal string":
        val validator = input_validator()
        val result = validator.validate_string("hello world")
        expect(result).to_be_nil()

describe "URI scheme validation":
    it "accepts file URI":
        val validator = input_validator()
        val result = validator.validate_uri("file:///home/user/test.spl")
        expect(result).to_be_nil()

    it "accepts symbol URI":
        val validator = input_validator()
        val result = validator.validate_uri("symbol://project/MyClass")
        expect(result).to_be_nil()

    it "accepts project URI":
        val validator = input_validator()
        val result = validator.validate_uri("project://myproject/src")
        expect(result).to_be_nil()

    it "accepts http URI":
        val validator = input_validator()
        val result = validator.validate_uri("http://example.com/resource")
        expect(result).to_be_nil()

    it "accepts https URI":
        val validator = input_validator()
        val result = validator.validate_uri("https://example.com/resource")
        expect(result).to_be_nil()

    it "rejects ftp URI":
        val validator = input_validator()
        val result = validator.validate_uri("ftp://example.com/file")
        match result:
            case nil: expect(false).to_equal(true)
            case err: expect(err.message.contains("scheme")).to_equal(true)

    it "rejects invalid scheme":
        val validator = input_validator()
        val result = validator.validate_uri("invalid://test")
        match result:
            case nil: expect(false).to_equal(true)
            case err: expect(err.message.contains("scheme")).to_equal(true)

describe "URI emptiness validation":
    it "rejects empty URI":
        val validator = input_validator()
        val result = validator.validate_uri("")
        match result:
            case nil: expect(false).to_equal(true)
            case err: expect(err.message.contains("empty")).to_equal(true)

describe "Tool name validation":
    it "accepts simple name":
        val validator = input_validator()
        val result = validator.validate_tool_name("read_code")
        expect(result).to_be_nil()

    it "accepts name with hyphens":
        val validator = input_validator()
        val result = validator.validate_tool_name("read-code")
        expect(result).to_be_nil()

    it "accepts name with slashes":
        val validator = input_validator()
        val result = validator.validate_tool_name("tools/list")
        expect(result).to_be_nil()

    it "rejects empty name":
        val validator = input_validator()
        val result = validator.validate_tool_name("")
        match result:
            case nil: expect(false).to_equal(true)
            case err: expect(err.message.contains("empty")).to_equal(true)

describe "Array size validation":
    it "accepts zero size":
        val validator = input_validator()
        val result = validator.validate_array_length(0)
        expect(result).to_be_nil()

    it "accepts normal size":
        val validator = input_validator()
        val result = validator.validate_array_length(100)
        expect(result).to_be_nil()

    it "rejects negative size":
        val validator = input_validator()
        val result = validator.validate_array_length(-10)
        match result:
            case nil: expect(false).to_equal(true)
            case err: expect(err.message.contains("negative")).to_equal(true)

    it "rejects excessive size":
        val validator = input_validator()
        val result = validator.validate_array_length(2000)
        match result:
            case nil: expect(false).to_equal(true)
            case err: expect(err.message.contains("exceeds")).to_equal(true)

describe "Validation limits constants":
    it "has correct default content limit":
        val limits = default_validation_limits()
        expect(limits.max_content_length).to_equal(1048576)

    it "has correct strict content limit":
        val limits = strict_validation_limits()
        expect(limits.max_content_length).to_equal(524288)

    it "has correct default string limit":
        val limits = default_validation_limits()
        expect(limits.max_string_length).to_equal(65536)

    it "has correct strict string limit":
        val limits = strict_validation_limits()
        expect(limits.max_string_length).to_equal(32768)

    it "has correct default array limit":
        val limits = default_validation_limits()
        expect(limits.max_array_length).to_equal(1000)

    it "has correct strict array limit":
        val limits = strict_validation_limits()
        expect(limits.max_array_length).to_equal(500)

    it "default is more permissive than strict":
        val d = default_validation_limits()
        val s = strict_validation_limits()
        expect(d.max_content_length > s.max_content_length).to_equal(true)
        expect(d.max_string_length > s.max_string_length).to_equal(true)
        expect(d.max_array_length > s.max_array_length).to_equal(true)
