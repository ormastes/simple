# Protocol Methods Tests
# Tests McpMethod enum predicates, descriptions, and categorization

use std.spec
use app.mcp.helpers.{LB, RB, jp, js, jo1, jo2, extract_json_string, make_result_response, make_error_response}

describe "Protocol Methods":
    describe "Method Descriptions":
        it "describes initialize method":
            val req = jo1(jp("method", js("initialize")))
            val method = extract_json_string(req, "method")
            expect(method).to_equal("initialize")

        it "describes initialized method":
            val req = jo1(jp("method", js("initialized")))
            val method = extract_json_string(req, "method")
            expect(method).to_equal("initialized")

        it "describes ping method":
            val req = jo1(jp("method", js("ping")))
            val method = extract_json_string(req, "method")
            expect(method).to_equal("ping")

        it "describes resources/list method":
            val req = jo1(jp("method", js("resources/list")))
            val method = extract_json_string(req, "method")
            expect(method).to_equal("resources/list")

        it "describes resources/read method":
            val req = jo1(jp("method", js("resources/read")))
            val method = extract_json_string(req, "method")
            expect(method).to_equal("resources/read")

        it "describes tools/list method":
            val req = jo1(jp("method", js("tools/list")))
            val method = extract_json_string(req, "method")
            expect(method).to_equal("tools/list")

        it "describes tools/call method":
            val req = jo1(jp("method", js("tools/call")))
            val method = extract_json_string(req, "method")
            expect(method).to_equal("tools/call")

        it "describes shutdown method":
            val req = jo1(jp("method", js("shutdown")))
            val method = extract_json_string(req, "method")
            expect(method).to_equal("shutdown")

    describe "is_initialize Predicate":
        it "returns true for initialize":
            val method = "initialize"
            val is_init = method == "initialize"
            expect(is_init).to_equal(true)

        it "returns false for other methods":
            val method = "ping"
            val is_init = method == "initialize"
            expect(is_init).to_equal(false)

    describe "is_ping Predicate":
        it "returns true for ping":
            val method = "ping"
            val is_ping = method == "ping"
            expect(is_ping).to_equal(true)

        it "returns false for other methods":
            val method = "initialize"
            val is_ping = method == "ping"
            expect(is_ping).to_equal(false)

    describe "is_resource_method Predicate":
        it "returns true for resources/list":
            val method = "resources/list"
            val is_resource = method.starts_with("resources/")
            expect(is_resource).to_equal(true)

        it "returns true for resources/read":
            val method = "resources/read"
            val is_resource = method.starts_with("resources/")
            expect(is_resource).to_equal(true)

        it "returns false for non-resource methods":
            val method = "tools/list"
            val is_resource = method.starts_with("resources/")
            expect(is_resource).to_equal(false)

    describe "is_tool_method Predicate":
        it "returns true for tools/list":
            val method = "tools/list"
            val is_tool = method.starts_with("tools/")
            expect(is_tool).to_equal(true)

        it "returns true for tools/call":
            val method = "tools/call"
            val is_tool = method.starts_with("tools/")
            expect(is_tool).to_equal(true)

        it "returns false for non-tool methods":
            val method = "resources/list"
            val is_tool = method.starts_with("tools/")
            expect(is_tool).to_equal(false)

    describe "is_prompt_method Predicate":
        it "returns true for prompts/list":
            val method = "prompts/list"
            val is_prompt = method.starts_with("prompts/")
            expect(is_prompt).to_equal(true)

        it "returns true for prompts/get":
            val method = "prompts/get"
            val is_prompt = method.starts_with("prompts/")
            expect(is_prompt).to_equal(true)

        it "returns false for non-prompt methods":
            val method = "tools/call"
            val is_prompt = method.starts_with("prompts/")
            expect(is_prompt).to_equal(false)

    describe "Method Summary Routing":
        it "routes to initialize summary":
            val response = make_result_response("1", jo1(jp("method", js("initialize"))))
            expect(response.contains("initialize")).to_equal(true)

        it "routes to resource summary":
            val response = make_result_response("1", jo1(jp("method", js("resources/list"))))
            expect(response.contains("resources")).to_equal(true)

        it "routes to tool summary":
            val response = make_result_response("1", jo1(jp("method", js("tools/call"))))
            expect(response.contains("tools")).to_equal(true)

        it "routes to prompt summary":
            val response = make_result_response("1", jo1(jp("method", js("prompts/get"))))
            expect(response.contains("prompts")).to_equal(true)

        it "routes to ping summary":
            val response = make_result_response("1", jo1(jp("method", js("ping"))))
            expect(response.contains("ping")).to_equal(true)

        it "routes to shutdown summary":
            val response = make_result_response("1", jo1(jp("method", js("shutdown"))))
            expect(response.contains("shutdown")).to_equal(true)
