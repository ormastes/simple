"""
MCP Protocol Specification
Feature: MCP Protocol Compliance
Category: MCP, Protocol
Status: Complete
"""

use std.spec
use app.mcp.helpers.{LB, RB, Q, jp, js, jo1, jo2, jo3, extract_json_string, extract_json_value, make_result_response, make_error_response, make_tool_result, log_level_to_int}

describe "MCP JSON-RPC 2.0 Protocol":
    context "when handling initialize request":
        it "builds response with protocol version":
            val proto = "2025-06-18"
            val result = jo1(jp("protocolVersion", js(proto)))
            val response = make_result_response("1", result)
            expect(response.contains("protocolVersion")).to_equal(true)
            expect(response.contains("2025-06-18")).to_equal(true)

        it "builds response with server information":
            val server_info = jo2(jp("name", js("simple-mcp")), jp("version", js("2.0.0")))
            expect(server_info.contains("simple-mcp")).to_equal(true)
            expect(server_info.contains("2.0.0")).to_equal(true)

    context "when handling tools/list request":
        it "builds tool list response":
            val tool = jo2(jp("name", js("read_code")), jp("description", js("Read file")))
            val tools = "[" + tool + "]"
            val result = jo1(jp("tools", tools))
            expect(result.contains("read_code")).to_equal(true)

    context "when handling errors":
        it "builds method not found error":
            val response = make_error_response("1", -32601, "Method not found")
            expect(response.contains("-32601")).to_equal(true)
            expect(response.contains("Method not found")).to_equal(true)

        it "builds invalid params error":
            val response = make_error_response("1", -32602, "Invalid params")
            expect(response.contains("-32602")).to_equal(true)

describe "MCP Message Format":
    context "when formatting responses":
        it "builds valid JSON response":
            val response = make_result_response("1", LB() + RB())
            expect(response.starts_with(LB())).to_equal(true)
            expect(response.ends_with(RB())).to_equal(true)

        it "includes jsonrpc version in result response":
            val response = make_result_response("1", "null")
            expect(response.contains("\"jsonrpc\":\"2.0\"")).to_equal(true)

        it "includes jsonrpc version in error response":
            val response = make_error_response("1", -32600, "Bad request")
            expect(response.contains("\"jsonrpc\":\"2.0\"")).to_equal(true)

describe "MCP Capability Negotiation":
    context "when server declares capabilities":
        it "builds capabilities JSON":
            val tools_cap = jo1("")
            val resources_cap = jo1("")
            val prompts_cap = jo1("")
            val caps = jo3(jp("tools", tools_cap), jp("resources", resources_cap), jp("prompts", prompts_cap))
            expect(caps.contains("\"tools\"")).to_equal(true)
            expect(caps.contains("\"resources\"")).to_equal(true)
            expect(caps.contains("\"prompts\"")).to_equal(true)

describe "MCP Request ID Handling":
    context "when request has string ID":
        it "preserves string ID in response":
            val response = make_result_response("\"test-123\"", "null")
            expect(response.contains("\"id\":\"test-123\"")).to_equal(true)

    context "when request has numeric ID":
        it "preserves numeric ID in response":
            val response = make_result_response("42", "null")
            expect(response.contains("\"id\":42")).to_equal(true)

describe "MCP Method Routing":
    context "when extracting method from request":
        it "extracts method field":
            val req = jo2(jp("method", js("initialize")), jp("id", "1"))
            val method = extract_json_string(req, "method")
            expect(method).to_equal("initialize")

        it "extracts tools/list method":
            val req = jo2(jp("method", js("tools/list")), jp("id", "2"))
            val method = extract_json_string(req, "method")
            expect(method).to_equal("tools/list")

        it "extracts tools/call method":
            val req = jo2(jp("method", js("tools/call")), jp("id", "3"))
            val method = extract_json_string(req, "method")
            expect(method).to_equal("tools/call")

describe "Log Level Utilities":
    it "maps debug to 0":
        expect(log_level_to_int("debug")).to_equal(0)

    it "maps info to 1":
        expect(log_level_to_int("info")).to_equal(1)

    it "maps warning to 3":
        expect(log_level_to_int("warning")).to_equal(3)

    it "maps error to 4":
        expect(log_level_to_int("error")).to_equal(4)

    it "maps emergency to 7":
        expect(log_level_to_int("emergency")).to_equal(7)

    it "returns -1 for unknown level":
        expect(log_level_to_int("unknown")).to_equal(-1)
