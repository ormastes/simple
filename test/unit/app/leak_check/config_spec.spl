# Config spec for leak_check/config.spl
#
# Tests parse_leak_check_args with various flag combinations.

use app.leak_check.config.{parse_leak_check_args}

describe "parse_leak_check_args":
    it "parses source file as positional argument":
        fn run():
            val cfg = parse_leak_check_args(["test.spl"])
            expect(cfg.source_file).to_equal("test.spl")
        run()

    it "parses --verbose flag":
        fn run():
            val cfg = parse_leak_check_args(["--verbose", "test.spl"])
            expect(cfg.verbose).to_equal(true)
            expect(cfg.source_file).to_equal("test.spl")
        run()

    it "parses --mode=external":
        fn run():
            val cfg = parse_leak_check_args(["--mode=external", "test.spl"])
            expect(cfg.source_file).to_equal("test.spl")
        run()

    it "parses --timeout=20":
        fn run():
            val cfg = parse_leak_check_args(["--timeout=20", "test.spl"])
            expect(cfg.timeout_seconds).to_equal(20)
            expect(cfg.source_file).to_equal("test.spl")
        run()

    it "uses default timeout of 10":
        fn run():
            val cfg = parse_leak_check_args(["test.spl"])
            expect(cfg.timeout_seconds).to_equal(10)
        run()

    it "parses --help and returns empty source":
        fn run():
            val cfg = parse_leak_check_args(["--help"])
            expect(cfg.source_file).to_equal("")
        run()

    it "parses multiple flags together":
        fn run():
            val cfg = parse_leak_check_args(["--verbose", "--timeout=15", "--gc-window=5", "my_file.spl"])
            expect(cfg.verbose).to_equal(true)
            expect(cfg.timeout_seconds).to_equal(15)
            expect(cfg.gc_leak_window).to_equal(5)
            expect(cfg.source_file).to_equal("my_file.spl")
        run()
