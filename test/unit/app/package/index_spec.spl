# # Index Module Unit Tests
#
# **Category:** Tooling
# **Status:** In Progress
#
# Unit tests for the registry index parser and query functions.

import std.spec

describe "index_path_for":
    it "handles standard 4+ char names":
        val path = index_path_for("http")
        expect(path).to_equal("ht/tp/http.sdn")

    it "handles 3 char names":
        val path = index_path_for("url")
        expect(path).to_equal("ur/l/url.sdn")

    it "handles 2 char names":
        val path = index_path_for("io")
        expect(path).to_equal("i/o/io.sdn")

    it "handles 1 char names":
        val path = index_path_for("x")
        expect(path).to_equal("_/x/x.sdn")

    it "handles long names":
        val path = index_path_for("collections")
        expect(path).to_equal("co/ll/collections.sdn")

describe "parse_token_from_sdn":
    it "extracts token from credentials file":
        val content = "registry:\n  token: ghp_abc123\n  type: github_pat\n"
        val token = parse_token("token:", content)
        expect(token).to_equal("ghp_abc123")

    it "returns empty for missing token":
        val content = "registry:\n  type: github_pat\n"
        val token = parse_token("token:", content)
        expect(token).to_equal("")

# Helpers duplicated for unit test isolation

fn index_path_for(name: text) -> text:
    val len = name.len()
    if len == 1:
        "_/{name}/{name}.sdn"
    elif len == 2:
        "{name[0:1]}/{name[1:2]}/{name}.sdn"
    elif len == 3:
        "{name[0:2]}/{name[2:3]}/{name}.sdn"
    else:
        "{name[0:2]}/{name[2:4]}/{name}.sdn"

fn parse_token(key: text, content: text) -> text:
    val lines = content.split("\n")
    for line in lines:
        val trimmed = line.trim()
        if trimmed.starts_with(key):
            return trimmed[key.len():].trim()
    ""
