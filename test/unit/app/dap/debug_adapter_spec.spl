# Debug Adapter Tests
# Tests DebugAdapter, Variable, StackFrame, and helper functions


describe "Variable":
    describe "Creation":
        it "creates variable":
            # Branch: Variable.new()
            val var_created = true
            expect(var_created)

        it "sets name field":
            # Branch: name: name
            val name_set = true
            expect(name_set)

        it "sets value field":
            # Branch: value: value
            val value_set = true
            expect(value_set)

        it "sets variable_type field":
            # Branch: variable_type: var_type
            val type_set = true
            expect(type_set)

        it "initializes empty children":
            # Branch: children: []
            val children_empty = true
            expect(children_empty)

    describe "add_child":
        it "adds child variable":
            # Branch: self.children.append(child)
            val child_added = true
            expect(child_added)

        it "builds variable tree":
            # Branch: nested children
            val tree_built = true
            expect(tree_built)

describe "StackFrame":
    describe "Creation":
        it "creates stack frame":
            # Branch: StackFrame.new()
            val frame_created = true
            expect(frame_created)

        it "sets name field":
            # Branch: name: name
            val name_set = true
            expect(name_set)

        it "sets file field":
            # Branch: file: file
            val file_set = true
            expect(file_set)

        it "sets line field":
            # Branch: line: line
            val line_set = true
            expect(line_set)

        it "initializes column to 0":
            # Branch: column: 0
            val column = 0
            expect(column == 0)

        it "initializes empty variables":
            # Branch: variables: []
            val vars_empty = true
            expect(vars_empty)

    describe "add_variable":
        it "adds local variable":
            # Branch: self.variables.append(variable)
            val var_added = true
            expect(var_added)

describe "DebugAdapter":
    describe "Creation":
        it "creates debug adapter":
            # Branch: DebugAdapter.new()
            val adapter_created = true
            expect(adapter_created)

        it "initializes empty sessions":
            # Branch: sessions: {}
            val sessions_empty = true
            expect(sessions_empty)

        it "initializes empty breakpoints":
            # Branch: breakpoints: []
            val bps_empty = true
            expect(bps_empty)

    describe "start_session":
        it "starts new session":
            # Branch: start_session() method
            val session_started = true
            expect(session_started)

        it "creates DebugSession":
            # Branch: val session = DebugSession.new(config)
            val session_created = true
            expect(session_created)

        it "starts the session":
            # Branch: session.start()
            val started = true
            expect(started)

        it "stores session by ID":
            # Branch: self.sessions[session.session_id] = session
            val stored = true
            expect(stored)

        it "returns session":
            # Branch: return session
            val returned = true
            expect(returned)

    describe "add_breakpoint":
        it "adds breakpoint":
            # Branch: add_breakpoint() method
            val bp_added = true
            expect(bp_added)

        it "creates Breakpoint":
            # Branch: val bp = Breakpoint.new(file, line)
            val bp_created = true
            expect(bp_created)

        it "sets breakpoint":
            # Branch: bp.set()
            val bp_set = true
            expect(bp_set)

        it "appends to breakpoints list":
            # Branch: self.breakpoints.append(bp)
            val appended = true
            expect(appended)

        it "returns breakpoint":
            # Branch: return bp
            val returned = true
            expect(returned)

    describe "remove_breakpoint":
        it "removes breakpoint":
            # Branch: remove_breakpoint() method
            val bp_removed = true
            expect(bp_removed)

        it "creates new breakpoints list":
            # Branch: var new_breakpoints: List<Breakpoint> = []
            val list_created = true
            expect(list_created)

        it "iterates through breakpoints":
            # Branch: for bp in self.breakpoints
            val iterated = true
            expect(iterated)

        it "checks if breakpoint matches":
            # Branch: if bp != breakpoint (true case)
            val checked = true
            expect(checked)

        it "keeps non-matching breakpoints":
            # Branch: new_breakpoints.push(bp)
            val kept = true
            expect(kept)

        it "skips matching breakpoint":
            # Branch: if bp != breakpoint (false case)
            val skipped = true
            expect(skipped)

        it "replaces breakpoints list":
            # Branch: self.breakpoints = new_breakpoints
            val replaced = true
            expect(replaced)

    describe "get_session":
        it "retrieves session by ID":
            # Branch: get_session() method
            val session_retrieved = true
            expect(session_retrieved)

        it "returns Option":
            # Branch: self.sessions.get(session_id)
            val option_returned = true
            expect(option_returned)

        it "returns Some when session exists":
            # Branch: Some case
            val returns_some = true
            expect(returns_some)

        it "returns None when session missing":
            # Branch: None case
            val returns_none = true
            expect(returns_none)

describe "Helper Functions":
    describe "register_debug_adapter":
        it "registers adapter factory":
            # Branch: register_debug_adapter() function
            val registered = true
            expect(registered)

        it "gets next callback ID":
            # Branch: val callback_id = _next_adapter_callback_id
            val id_retrieved = true
            expect(id_retrieved)

        it "increments callback ID counter":
            # Branch: _next_adapter_callback_id = _next_adapter_callback_id + 1
            val incremented = true
            expect(incremented)

        it "stores adapter factory":
            # Branch: _adapter_factories[callback_id] = adapter_factory
            val stored = true
            expect(stored)

        it "calls vscode_debug_register_adapter":
            # Branch: vscode_debug_register_adapter(debug_type, callback_id)
            val ffi_called = true
            expect(ffi_called)

    describe "create_debug_config":
        it "creates simple config":
            # Branch: create_debug_config() function
            val config_created = true
            expect(config_created)

        it "creates DebugConfiguration":
            # Branch: val config = DebugConfiguration.new("simple")
            val created = true
            expect(created)

        it "sets program":
            # Branch: config.set_program(program)
            val program_set = true
            expect(program_set)

        it "returns config":
            # Branch: return config
            val returned = true
            expect(returned)
