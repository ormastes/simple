# # Experiment Artifact Specification
#
# **Feature IDs:** #exp-artifact
# **Category:** Stdlib
# **Status:** In Progress
#
# ## Overview
#
# Tests for content-addressed artifact store, checkpoint registration,
# and garbage collection.

use std.exp.artifact.*
use std.exp.storage.*
use std.exp.run.*
use std.exp.config.*

# ============================================================================
# Artifact Entry
# ============================================================================

describe "ArtifactEntry":
    it "serializes to SDN line":
        val entry = ArtifactEntry(
            name: "model.pt",
            blob_hash: "abc123",
            kind: "checkpoint",
            metadata: {},
            timestamp: "2026-01-15T10:00:00Z"
        )
        val line = entry.to_sdn_line()
        expect line.contains("model.pt")
        expect line.contains("abc123")
        expect line.contains("checkpoint")

# ============================================================================
# Artifact Store
# ============================================================================

describe "ArtifactStore":
    context "registration":
        it "registers inline data":
            val config = ExpConfig__empty()
            val run = start_run(config, [])
            var store = ArtifactStore__for_run(run.run_id)
            val hash = store.register_data("metrics.json", "{\"loss\": 0.1}", {})
            expect hash.?
            expect store.entries.len() == 1

        it "retrieves artifact by name":
            val config = ExpConfig__empty()
            val run = start_run(config, [])
            var store = ArtifactStore__for_run(run.run_id)
            store.register_data("output.txt", "hello", {})
            val entry = store.get_artifact("output.txt")
            expect entry.?
            expect entry.unwrap().kind == "data"

        it "returns nil for missing artifact":
            val config = ExpConfig__empty()
            val run = start_run(config, [])
            val store = ArtifactStore__for_run(run.run_id)
            expect store.get_artifact("nonexistent") == nil

    context "referenced hashes":
        it "collects all blob hashes":
            val config = ExpConfig__empty()
            val run = start_run(config, [])
            var store = ArtifactStore__for_run(run.run_id)
            store.register_data("a.txt", "aaa", {})
            store.register_data("b.txt", "bbb", {})
            val hashes = store.referenced_hashes()
            expect hashes.len() == 2

# ============================================================================
# Garbage Collection
# ============================================================================

describe "Artifact GC":
    it "reports deletion count":
        val deleted = gc_artifacts()
        expect deleted >= 0
