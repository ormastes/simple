# test/unit/std/mapped_spec.spl
# Unit tests for the mapped types library (src/std/types/mapped.spl).

use std.spec.{describe, it, expect}
use std.mapped.{partial, readonly_type, stringify_type, pick_type, omit_type, required_type}
use std.mapped.{field_names_csv, has_field_check, make_optional_field, make_required_field}
use std.mapped.{is_mapped_result, mapped_result_get_type}

describe "Mapped Types":

    describe "partial":
        it "wraps type in Partial<>":
            expect(partial("User")).to_equal("Partial<User>")

        it "works with any type name":
            expect(partial("Config")).to_equal("Partial<Config>")

    describe "readonly_type":
        it "wraps type in Readonly<>":
            expect(readonly_type("Config")).to_equal("Readonly<Config>")

        it "works with any type name":
            expect(readonly_type("Point")).to_equal("Readonly<Point>")

    describe "stringify_type":
        it "wraps type in Stringify<>":
            expect(stringify_type("User")).to_equal("Stringify<User>")

    describe "pick_type":
        it "formats Pick<T, Keys>":
            expect(pick_type("User", "name,age")).to_equal("Pick<User, name,age>")

        it "single key":
            expect(pick_type("Config", "host")).to_equal("Pick<Config, host>")

    describe "omit_type":
        it "formats Omit<T, Keys>":
            expect(omit_type("User", "password")).to_equal("Omit<User, password>")

        it "multiple keys":
            expect(omit_type("Config", "secret,token")).to_equal("Omit<Config, secret,token>")

    describe "required_type":
        it "wraps type in Required<>":
            expect(required_type("User")).to_equal("Required<User>")

    describe "field_names_csv":
        it "returns @traits stub message":
            val result = field_names_csv("Point")
            expect(result).to_equal("use @traits(fields, Point)")

    describe "has_field_check":
        it "returns false (stub)":
            val result = has_field_check("User", "name")
            expect(result).to_equal(false)

        it "returns false for unknown fields":
            val result = has_field_check("Config", "missing")
            expect(result).to_equal(false)

    describe "make_optional_field":
        it "appends ? to field name":
            expect(make_optional_field("age")).to_equal("age?")

        it "works with any field name":
            expect(make_optional_field("name")).to_equal("name?")

    describe "make_required_field":
        it "appends ! to field name":
            expect(make_required_field("age")).to_equal("age!")

        it "works with any field name":
            expect(make_required_field("email")).to_equal("email!")

    describe "is_mapped_result":
        it "returns false (stub)":
            val result = is_mapped_result(0)
            expect(result).to_equal(false)

    describe "mapped_result_get_type":
        it "formats transform<name>":
            expect(mapped_result_get_type("User", "Partial")).to_equal("Partial<User>")

        it "works with Readonly transform":
            expect(mapped_result_get_type("Config", "Readonly")).to_equal("Readonly<Config>")
