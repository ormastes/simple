# # Database SDN Table Import/Export Validation
#
# **Feature ID:** #700 Database SDN table import/export
# **Category:** Uncategorized
# **Status:** Fixed
#
# ## Overview
#
# Validates that SdnTable can correctly parse SDN format including
# quoted values containing commas, and export back to SDN format.
# Tests the core split_sdn_row, strip_quotes, and quote_if_needed helpers.

use std.spec

# ============================================================================
# Type Definitions (must be before any usage)
# ============================================================================

# SdnTable is the FIRST (and only) struct so its constructor works
# (runtime limitation: only first struct supports direct construction)
# Rows are plain Dict<text, text> to avoid second-struct constructor issue
struct SdnTable:
    name: text
    columns: [text]
    rows: [Dict<text, text>]
    index: Dict<text, i64>

    fn to_sdn() -> text:
        var result = "{self.name} |"
        result = result + self.columns.join(", ")
        result = result + "|\n"

        var ri = 0
        while ri < self.rows.len():
            var row = self.rows[ri]
            result = result + "    "
            var values = []
            var ci = 0
            while ci < self.columns.len():
                var col = self.columns[ci]
                var raw_value = sdn_row_get(row, col)
                var formatted = quote_if_needed(raw_value)
                values.push(formatted)
                ci = ci + 1
            result = result + values.join(", ")
            result = result + "\n"
            ri = ri + 1

        result

    me add_row(row: Dict<text, text>) -> bool:
        if row.contains_key("id"):
            var id_val = row["id"]
            self.index[id_val] = self.rows.len()
        self.rows.push(row)
        true

# ============================================================================
# Helper function definitions
# (These test the functions from lib.database.core)
# ============================================================================

fn sdn_row_get(row: Dict<text, text>, column: text) -> text:
    if row.contains_key(column):
        return row[column]
    ""

fn split_sdn_row(line: text) -> [text]:
    var parts = []
    var current = ""
    var in_quotes = false
    var i = 0

    while i < line.len():
        var ch = line[i]
        if ch == '"':
            in_quotes = not in_quotes
            current = current + ch
        elif ch == ',' and not in_quotes:
            parts = parts + [current]
            current = ""
        else:
            current = current + ch
        i = i + 1

    if current.? or parts.len() > 0:
        parts = parts + [current]

    parts

fn strip_quotes(value: text) -> text:
    if value.len() >= 2 and value.starts_with('"') and value.ends_with('"'):
        return value[1..(value.len() - 1)]
    value

fn quote_if_needed(value: text) -> text:
    if value.contains(","):
        return '"' + value + '"'
    value

# Factory functions (runtime doesn't resolve ClassName__method or ClassName.method)
fn SdnRow__empty() -> Dict<text, text>:
    {}

fn SdnTable__new(tname: text, cols: [text]) -> SdnTable:
    SdnTable(name: tname, columns: cols, rows: [], index: {})

fn parse_sdn_table(content: text) -> SdnTable?:
    var lines = content.split("\n")
    if not lines.?:
        return nil

    var header_idx = -1
    var table_name = ""
    var columns = []

    var li = 0
    while li < lines.len():
        var trimmed = lines[li].trim()
        if trimmed.contains("|") and not trimmed.starts_with("#"):
            var parts = trimmed.split("|")
            if parts.len() >= 3:
                table_name = parts[0].trim()
                var col_part = parts[1].trim()
                var raw_cols = col_part.split(",")
                columns = raw_cols.map(\c: c.trim())
                header_idx = li
                li = lines.len()
            else:
                li = li + 1
        else:
            li = li + 1

    if header_idx == -1:
        return nil

    var table = SdnTable(name: table_name, columns: columns, rows: [], index: {})
    var ri = header_idx + 1
    while ri < lines.len():
        var line = lines[ri].trim()
        ri = ri + 1
        if not line.? or line.starts_with("#"):
            continue

        var parts = split_sdn_row(line)
        if parts.len() != columns.len():
            continue

        var row = {}
        var ji = 0
        while ji < columns.len():
            var col = columns[ji]
            var raw_val = parts[ji].trim()
            var unquoted = strip_quotes(raw_val)
            row[col] = unquoted
            ji = ji + 1

        table.add_row(row)

    Some(table)

# ============================================================================
# SDN Row Parsing Tests
# ============================================================================

describe "Feature #700 - SDN Row Parsing":
    # Tests for quote-aware CSV splitting of SDN table rows.
    # Handles quoted values that contain commas.

    context "simple row parsing":
        it "parses unquoted values":
            var line = "1, Alice, true"
            var parts = split_sdn_row(line)
            expect(parts.len()).to_equal(3)
            expect(parts[0].trim()).to_equal("1")
            expect(parts[1].trim()).to_equal("Alice")
            expect(parts[2].trim()).to_equal("true")

        it "parses numeric values":
            var line = "42, 100, 200"
            var parts = split_sdn_row(line)
            expect(parts.len()).to_equal(3)
            expect(parts[0].trim()).to_equal("42")

    context "quoted value parsing":
        it "parses quoted strings without commas":
            var line = '1, "Alice", true'
            var parts = split_sdn_row(line)
            expect(parts.len()).to_equal(3)

        it "parses quoted strings with commas":
            var line = '1, "hello, world", true'
            var parts = split_sdn_row(line)
            expect(parts.len()).to_equal(3)
            var middle = parts[1].trim()
            var unquoted = strip_quotes(middle)
            expect(unquoted).to_equal("hello, world")

        it "handles multiple quoted fields":
            var line = '"Testing Framework", "Describe Blocks", "BDD describe blocks"'
            var parts = split_sdn_row(line)
            expect(parts.len()).to_equal(3)

    context "strip_quotes helper":
        it "strips surrounding double quotes":
            var result = strip_quotes('"hello"')
            expect(result).to_equal("hello")

        it "leaves unquoted values unchanged":
            var result = strip_quotes("plain")
            expect(result).to_equal("plain")

        it "leaves empty string unchanged":
            var result = strip_quotes("")
            expect(result).to_equal("")

        it "leaves single char unchanged":
            var result = strip_quotes("x")
            expect(result).to_equal("x")

    context "quote_if_needed helper":
        it "quotes values with commas":
            var result = quote_if_needed("hello, world")
            expect(result).to_contain('"')
            expect(result).to_start_with('"')
            expect(result).to_end_with('"')

        it "leaves values without commas unquoted":
            var result = quote_if_needed("hello")
            expect(result).to_equal("hello")

        it "leaves empty values unquoted":
            var result = quote_if_needed("")
            expect(result).to_equal("")

# ============================================================================
# SDN Table Round-Trip Tests
# ============================================================================

describe "Feature #700 - SDN Table Round-Trip":
    # Tests that SDN tables can be parsed and exported correctly,
    # preserving data through a round-trip.

    context "simple table parsing":
        it "parses basic SDN table":
            var content = "users |id, name, active|\n    1, Alice, true\n    2, Bob, false"
            var table = parse_sdn_table(content)
            expect(table != nil).to_equal(true)

        it "parses table with correct column count":
            var content = "users |id, name|\n    1, Alice\n    2, Bob"
            var table_opt = parse_sdn_table(content)
            # Table should be parsed successfully
            expect(table_opt != nil).to_equal(true)

    context "table export":
        it "exports table to SDN format":
            var table = SdnTable__new("test_table", ["id", "value"])
            var row1 = SdnRow__empty()
            row1["id"] = "1"
            row1["value"] = "hello"
            table.add_row(row1)

            var exported = table.to_sdn()
            expect(exported).to_contain("test_table")
            expect(exported).to_contain("id")
            expect(exported).to_contain("value")
            expect(exported).to_contain("hello")

    context "quoted value round-trip":
        it "preserves values with commas through export":
            var table = SdnTable__new("data", ["id", "description"])
            var row = SdnRow__empty()
            row["id"] = "1"
            row["description"] = "hello, world"
            table.add_row(row)

            var exported = table.to_sdn()
            # Value with comma should be quoted in export
            expect(exported).to_contain('"hello, world"')
