# generator stdlib spec
#
# Tests for src/std/generator.spl

use std.generator.{generator, generate_range, generate_repeat, take}

describe "generator stdlib":
    describe "generator â€” state machine":
        it "yields values from step function":
            val naturals = generator(0, fn(n): (n + 1, true))
            val result = take(naturals, 5)
            expect(result.len()).to_equal(5)

        it "first value is the initial state":
            val naturals = generator(0, fn(n): (n + 1, true))
            val result = take(naturals, 1)
            expect(result[0]).to_equal(0)

        it "stops when step function returns false":
            val up_to_3 = generator(0, fn(n): (n + 1, n < 3))
            val result = take(up_to_3, 100)
            expect(result.len()).to_equal(4)

    describe "generate_range":
        it "generates integers from start to end (exclusive)":
            val r = generate_range(0, 5)
            val result = take(r, 10)
            expect(result[0]).to_equal(0)
            expect(result[4]).to_equal(4)

        it "generates the correct number of elements":
            val r = generate_range(3, 8)
            val result = take(r, 10)
            expect(result.len()).to_equal(5)

        it "generates single element for range of 1":
            val r = generate_range(7, 8)
            val result = take(r, 10)
            expect(result.len()).to_equal(1)
            expect(result[0]).to_equal(7)

    describe "generate_repeat":
        it "always yields the same value":
            val rep = generate_repeat(42)
            val result = take(rep, 4)
            expect(result[0]).to_equal(42)
            expect(result[3]).to_equal(42)

        it "yields requested count":
            val rep = generate_repeat("x")
            val result = take(rep, 3)
            expect(result.len()).to_equal(3)

    describe "take":
        it "collects n elements into array":
            val naturals = generator(1, fn(n): (n + 1, true))
            val result = take(naturals, 3)
            expect(result.len()).to_equal(3)

        it "take 0 returns empty array":
            val naturals = generator(0, fn(n): (n + 1, true))
            val result = take(naturals, 0)
            expect(result.len()).to_equal(0)
