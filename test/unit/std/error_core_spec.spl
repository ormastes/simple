# Error Core Spec - Tests for error_core.spl
#
# Tests the base error handling primitives.

use std.error_core.{ErrorBase, error_new, error_with_file, error_with_kind, error_with_cause, error_simple}
use std.error_core.{error_message, error_location, error_file, error_kind, error_has_cause, error_get_cause}

describe "ErrorBase":
    it "creates basic error with location":
        val error = error_new("Test error", 42, 10)
        expect(error_message(error)).to_equal("Test error")
        val (line, col) = error_location(error)
        expect(line).to_equal(42)
        expect(col).to_equal(10)

    it "creates error with file":
        val error = error_with_file("File error", 10, 5, "test.spl")
        expect(error_file(error)).to_equal("test.spl")
        expect(error_message(error)).to_equal("File error")

    it "creates error with kind":
        val error = error_with_kind("Parse error", 1, 1, "parse")
        expect(error_kind(error)).to_equal("parse")

    it "creates simple error without location":
        val error = error_simple("Simple error")
        expect(error_message(error)).to_equal("Simple error")
        val (line, col) = error_location(error)
        expect(line).to_equal(0)
        expect(col).to_equal(0)

describe "Error Cause":
    it "adds cause to error":
        val base = error_new("Operation failed", 0, 0)
        val with_cause = error_with_cause(base, "Permission denied")
        expect(error_has_cause(with_cause)).to_equal(true)
        expect(error_get_cause(with_cause)).to_equal("Permission denied")

    it "detects no cause":
        val error = error_new("No cause", 0, 0)
        expect(error_has_cause(error)).to_equal(false)
        expect(error_get_cause(error)).to_equal("")

describe "Error Accessors":
    it "gets error message":
        val error = error_new("Test message", 0, 0)
        expect(error_message(error)).to_equal("Test message")

    it "gets error location":
        val error = error_new("Test", 100, 50)
        val (line, col) = error_location(error)
        expect(line).to_equal(100)
        expect(col).to_equal(50)

    it "gets error file":
        val error = error_with_file("Test", 0, 0, "main.spl")
        expect(error_file(error)).to_equal("main.spl")

    it "gets error kind":
        val error = error_with_kind("Test", 0, 0, "type")
        expect(error_kind(error)).to_equal("type")

describe "Error Structure":
    it "preserves all fields":
        val error = ErrorBase(
            message: "Full error",
            line: 42,
            col: 15,
            file: "test.spl",
            kind: "runtime",
            cause: "Underlying issue"
        )
        expect(error.message).to_equal("Full error")
        expect(error.line).to_equal(42)
        expect(error.col).to_equal(15)
        expect(error.file).to_equal("test.spl")
        expect(error.kind).to_equal("runtime")
        if error.cause:
            expect(error.cause).to_equal("Underlying issue")
