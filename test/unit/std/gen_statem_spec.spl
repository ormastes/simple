# GenStatem spec
#
# Tests for src/std/gen_statem.spl

use std.gen_statem.{
    GenStatem, GenStatemRunner,
    CALLBACK_STATE_FUNCTIONS, CALLBACK_HANDLE_EVENT,
    gen_statem_runner, gen_statem_start, gen_statem_stop,
    gen_statem_is_running, gen_statem_current_state,
    gen_statem_send_event
}

describe "GenStatem stdlib":
    describe "constants":
        it "CALLBACK_HANDLE_EVENT is defined":
            expect(CALLBACK_HANDLE_EVENT).to_equal("handle_event")

        it "CALLBACK_STATE_FUNCTIONS is defined":
            expect(CALLBACK_STATE_FUNCTIONS).to_equal("state_functions")

    describe "gen_statem_runner":
        it "creates runner with initial state":
            val runner = gen_statem_runner("light", "red", "")
            expect(runner.state_name).to_equal("red")
            expect(runner.name).to_equal("light")
            expect(runner.running).to_equal(false)

    describe "lifecycle":
        it "starts the runner":
            val runner = gen_statem_runner("fsm", "idle", "")
            gen_statem_start(runner)
            expect(gen_statem_is_running(runner)).to_equal(true)

        it "stops the runner":
            val runner = gen_statem_runner("fsm", "idle", "")
            gen_statem_start(runner)
            gen_statem_stop(runner)
            expect(gen_statem_is_running(runner)).to_equal(false)

    describe "gen_statem_send_event":
        it "transitions state via handler":
            val runner = gen_statem_runner("light", "red", "")
            gen_statem_send_event(runner, "timeout", "", fn(et, ev, sn, data):
                if sn == "red": "green"
                else: "red"
            )
            expect(gen_statem_current_state(runner)).to_equal("green")

        it "multiple transitions":
            val runner = gen_statem_runner("light", "red", "")
            gen_statem_send_event(runner, "t", "", fn(et, ev, sn, d):
                if sn == "red": "green"
                elif sn == "green": "yellow"
                else: "red"
            )
            gen_statem_send_event(runner, "t", "", fn(et, ev, sn, d):
                if sn == "red": "green"
                elif sn == "green": "yellow"
                else: "red"
            )
            expect(gen_statem_current_state(runner)).to_equal("yellow")
