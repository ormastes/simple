# Tests for src/std/phantom.spl â€” Phantom Type Markers
# Also tests @phantom annotation support in eval (phantom_struct_register / is_phantom)
use std.phantom.{owned, borrowed, read_only, write_only, read_write, connected, disconnected, validated, unvalidated, configured, unconfigured, locked, unlocked}
use compiler.core.interpreter.eval.{phantom_struct_register, phantom_struct_is_registered, phantom_reg_reset}

describe "std.phantom":
    describe "Ownership markers":
        it "owned() returns a struct with _phantom == 0":
            val o = owned()
            expect(o._phantom).to_equal(0)

        it "borrowed() returns a struct with _phantom == 0":
            val b = borrowed()
            expect(b._phantom).to_equal(0)

        it "owned() is non-nil":
            val o = owned()
            expect(o).to_equal(o)

    describe "Access mode markers":
        it "read_only() returns struct with _phantom == 0":
            val r = read_only()
            expect(r._phantom).to_equal(0)

        it "write_only() returns struct with _phantom == 0":
            val w = write_only()
            expect(w._phantom).to_equal(0)

        it "read_write() returns struct with _phantom == 0":
            val rw = read_write()
            expect(rw._phantom).to_equal(0)

    describe "Connection state markers":
        it "connected() returns struct with _phantom == 0":
            val c = connected()
            expect(c._phantom).to_equal(0)

        it "disconnected() returns struct with _phantom == 0":
            val d = disconnected()
            expect(d._phantom).to_equal(0)

    describe "Validation state markers":
        it "validated() returns struct with _phantom == 0":
            val v = validated()
            expect(v._phantom).to_equal(0)

        it "unvalidated() returns struct with _phantom == 0":
            val u = unvalidated()
            expect(u._phantom).to_equal(0)

    describe "Builder pattern markers":
        it "configured() returns struct with _phantom == 0":
            val c = configured()
            expect(c._phantom).to_equal(0)

        it "unconfigured() returns struct with _phantom == 0":
            val u = unconfigured()
            expect(u._phantom).to_equal(0)

    describe "Lock state markers":
        it "locked() returns struct with _phantom == 0":
            val l = locked()
            expect(l._phantom).to_equal(0)

        it "unlocked() returns struct with _phantom == 0":
            val u = unlocked()
            expect(u._phantom).to_equal(0)

describe "@phantom annotation eval support":
    it "phantom_struct_register marks a type name as phantom":
        phantom_reg_reset()
        phantom_struct_register("MyMarker")
        val result = phantom_struct_is_registered("MyMarker")
        expect(result).to_equal(true)

    it "phantom_struct_is_registered returns false for unknown type":
        phantom_reg_reset()
        val result = phantom_struct_is_registered("NotAPhantom")
        expect(result).to_equal(false)

    it "phantom_struct_register is idempotent (double registration)":
        phantom_reg_reset()
        phantom_struct_register("Marker")
        phantom_struct_register("Marker")
        val result = phantom_struct_is_registered("Marker")
        expect(result).to_equal(true)

    it "phantom_reg_reset clears all registered phantom types":
        phantom_struct_register("Temp1")
        phantom_struct_register("Temp2")
        phantom_reg_reset()
        val r1 = phantom_struct_is_registered("Temp1")
        val r2 = phantom_struct_is_registered("Temp2")
        expect(r1).to_equal(false)
        expect(r2).to_equal(false)

    it "@traits is_phantom returns true for registered phantom struct":
        phantom_reg_reset()
        phantom_struct_register("Connected")
        val result = __traits("is_phantom", "Connected")
        expect(result).to_equal(true)

    it "@traits is_phantom returns false for non-phantom struct":
        phantom_reg_reset()
        val result = __traits("is_phantom", "SomeOtherType")
        expect(result).to_equal(false)
