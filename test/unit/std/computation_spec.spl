# Computation Expression protocol spec
#
# Tests for src/std/computation.spl
# Base CE builder name constants and protocol helper functions.

use std.computation.{
    CE_BUILDER_RESULT, CE_BUILDER_OPTION, CE_BUILDER_SEQ,
    ce_builder_known, ce_bind_fn_name, ce_return_fn_name, ce_zero_fn_name
}

describe "Computation Expression protocol":
    describe "CE builder name constants":
        it "CE_BUILDER_RESULT is result_ce":
            expect(CE_BUILDER_RESULT).to_equal("result_ce")

        it "CE_BUILDER_OPTION is option_ce":
            expect(CE_BUILDER_OPTION).to_equal("option_ce")

        it "CE_BUILDER_SEQ is seq_ce":
            expect(CE_BUILDER_SEQ).to_equal("seq_ce")

    describe "ce_builder_known":
        it "recognizes result_ce builder":
            expect(ce_builder_known("result_ce")).to_equal(true)

        it "recognizes option_ce builder":
            expect(ce_builder_known("option_ce")).to_equal(true)

        it "recognizes seq_ce builder":
            expect(ce_builder_known("seq_ce")).to_equal(true)

        it "does not recognize unknown builder name":
            expect(ce_builder_known("unknown_ce")).to_equal(false)

        it "does not recognize empty string":
            expect(ce_builder_known("")).to_equal(false)

        it "recognizes CE_BUILDER_RESULT constant":
            expect(ce_builder_known(CE_BUILDER_RESULT)).to_equal(true)

        it "recognizes CE_BUILDER_OPTION constant":
            expect(ce_builder_known(CE_BUILDER_OPTION)).to_equal(true)

        it "recognizes CE_BUILDER_SEQ constant":
            expect(ce_builder_known(CE_BUILDER_SEQ)).to_equal(true)

        it "does not recognize partial name":
            expect(ce_builder_known("result")).to_equal(false)

        it "is case sensitive for unknown names":
            expect(ce_builder_known("Result_ce")).to_equal(false)

    describe "ce_bind_fn_name":
        it "returns bind name for result_ce":
            expect(ce_bind_fn_name("result_ce")).to_equal("result_ce_bind")

        it "returns bind name for option_ce":
            expect(ce_bind_fn_name("option_ce")).to_equal("option_ce_bind")

        it "returns bind name for seq_ce":
            expect(ce_bind_fn_name("seq_ce")).to_equal("seq_ce_bind")

        it "returns bind name for arbitrary builder":
            expect(ce_bind_fn_name("my_ce")).to_equal("my_ce_bind")

        it "bind name uses builder_bind pattern":
            val name = ce_bind_fn_name("foo_ce")
            expect(name).to_end_with("_bind")

        it "bind name starts with builder name":
            val name = ce_bind_fn_name("foo_ce")
            expect(name).to_start_with("foo_ce")

    describe "ce_return_fn_name":
        it "returns return name for result_ce":
            expect(ce_return_fn_name("result_ce")).to_equal("result_ce_return")

        it "returns return name for option_ce":
            expect(ce_return_fn_name("option_ce")).to_equal("option_ce_return")

        it "returns return name for seq_ce":
            expect(ce_return_fn_name("seq_ce")).to_equal("seq_ce_return")

        it "returns return name for arbitrary builder":
            expect(ce_return_fn_name("my_ce")).to_equal("my_ce_return")

        it "return name ends with _return":
            val name = ce_return_fn_name("foo_ce")
            expect(name).to_end_with("_return")

        it "return name starts with builder name":
            val name = ce_return_fn_name("foo_ce")
            expect(name).to_start_with("foo_ce")

    describe "ce_zero_fn_name":
        it "returns zero name for result_ce":
            expect(ce_zero_fn_name("result_ce")).to_equal("result_ce_zero")

        it "returns zero name for option_ce":
            expect(ce_zero_fn_name("option_ce")).to_equal("option_ce_zero")

        it "returns zero name for seq_ce":
            expect(ce_zero_fn_name("seq_ce")).to_equal("seq_ce_zero")

        it "returns zero name for arbitrary builder":
            expect(ce_zero_fn_name("my_ce")).to_equal("my_ce_zero")

        it "zero name ends with _zero":
            val name = ce_zero_fn_name("foo_ce")
            expect(name).to_end_with("_zero")

        it "zero name starts with builder name":
            val name = ce_zero_fn_name("foo_ce")
            expect(name).to_start_with("foo_ce")

    describe "naming convention consistency":
        it "all three names use the same prefix":
            val builder = "test_ce"
            val bind_name = ce_bind_fn_name(builder)
            val return_name = ce_return_fn_name(builder)
            val zero_name = ce_zero_fn_name(builder)
            expect(bind_name).to_start_with("test_ce")

        it "bind and return names share builder prefix":
            val builder = "state_ce"
            val bind_name = ce_bind_fn_name(builder)
            val return_name = ce_return_fn_name(builder)
            expect(bind_name).to_start_with("state_ce")

        it "bind and zero names share builder prefix":
            val builder = "async_ce"
            val bind_name = ce_bind_fn_name(builder)
            val zero_name = ce_zero_fn_name(builder)
            expect(zero_name).to_start_with("async_ce")
