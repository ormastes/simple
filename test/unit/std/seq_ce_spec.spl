# SeqCE builder spec
#
# Tests for src/std/seq_ce.spl
# Sequence computation expression builder - collect yielded values into arrays.

use std.seq_ce.{
    seq_ce_begin, seq_ce_yield_int, seq_ce_yield_text,
    seq_ce_end_int, seq_ce_end_text,
    seq_ce_bind_array, seq_ce_return, seq_ce_zero,
    seq_ce_run_int, seq_ce_run_text
}

describe "SeqCE builder":
    describe "seq_ce_zero":
        it "returns empty array":
            val result = seq_ce_zero()
            expect(result.len()).to_equal(0)

    describe "seq_ce_return":
        it "returns integer value unchanged":
            expect(seq_ce_return(42)).to_equal(42)

        it "returns text value unchanged":
            expect(seq_ce_return("hello")).to_equal("hello")

    describe "seq_ce_begin and seq_ce_end_int":
        it "empty sequence yields no integers":
            seq_ce_begin()
            val result = seq_ce_end_int()
            expect(result.len()).to_equal(0)

        it "yields one integer":
            seq_ce_begin()
            seq_ce_yield_int(10)
            val result = seq_ce_end_int()
            expect(result.len()).to_equal(1)

        it "yielded integer has correct value":
            seq_ce_begin()
            seq_ce_yield_int(42)
            val result = seq_ce_end_int()
            expect(result[0]).to_equal(42)

        it "yields multiple integers in order":
            seq_ce_begin()
            seq_ce_yield_int(1)
            seq_ce_yield_int(2)
            seq_ce_yield_int(3)
            val result = seq_ce_end_int()
            expect(result.len()).to_equal(3)

        it "first integer is correct":
            seq_ce_begin()
            seq_ce_yield_int(10)
            seq_ce_yield_int(20)
            seq_ce_yield_int(30)
            val result = seq_ce_end_int()
            expect(result[0]).to_equal(10)

        it "second integer is correct":
            seq_ce_begin()
            seq_ce_yield_int(10)
            seq_ce_yield_int(20)
            seq_ce_yield_int(30)
            val result = seq_ce_end_int()
            expect(result[1]).to_equal(20)

        it "third integer is correct":
            seq_ce_begin()
            seq_ce_yield_int(10)
            seq_ce_yield_int(20)
            seq_ce_yield_int(30)
            val result = seq_ce_end_int()
            expect(result[2]).to_equal(30)

        it "begin clears previous integers":
            seq_ce_begin()
            seq_ce_yield_int(99)
            seq_ce_begin()
            val result = seq_ce_end_int()
            expect(result.len()).to_equal(0)

    describe "seq_ce_begin and seq_ce_end_text":
        it "empty sequence yields no text":
            seq_ce_begin()
            val result = seq_ce_end_text()
            expect(result.len()).to_equal(0)

        it "yields one text value":
            seq_ce_begin()
            seq_ce_yield_text("hello")
            val result = seq_ce_end_text()
            expect(result.len()).to_equal(1)

        it "yielded text has correct value":
            seq_ce_begin()
            seq_ce_yield_text("world")
            val result = seq_ce_end_text()
            expect(result[0]).to_equal("world")

        it "yields multiple text values in order":
            seq_ce_begin()
            seq_ce_yield_text("a")
            seq_ce_yield_text("b")
            seq_ce_yield_text("c")
            val result = seq_ce_end_text()
            expect(result.len()).to_equal(3)

        it "first text value is correct":
            seq_ce_begin()
            seq_ce_yield_text("first")
            seq_ce_yield_text("second")
            val result = seq_ce_end_text()
            expect(result[0]).to_equal("first")

        it "second text value is correct":
            seq_ce_begin()
            seq_ce_yield_text("first")
            seq_ce_yield_text("second")
            val result = seq_ce_end_text()
            expect(result[1]).to_equal("second")

        it "begin clears previous text values":
            seq_ce_begin()
            seq_ce_yield_text("old")
            seq_ce_begin()
            val result = seq_ce_end_text()
            expect(result.len()).to_equal(0)

    describe "seq_ce_run_int":
        it "collects no integers from empty producer":
            val result = seq_ce_run_int(fn():
                0
            )
            expect(result.len()).to_equal(0)

        it "collects single yielded integer":
            val result = seq_ce_run_int(fn():
                seq_ce_yield_int(7)
            )
            expect(result.len()).to_equal(1)

        it "collected integer has correct value":
            val result = seq_ce_run_int(fn():
                seq_ce_yield_int(7)
            )
            expect(result[0]).to_equal(7)

        it "collects multiple yielded integers":
            val result = seq_ce_run_int(fn():
                seq_ce_yield_int(1)
                seq_ce_yield_int(2)
                seq_ce_yield_int(3)
            )
            expect(result.len()).to_equal(3)

        it "integers are in yield order":
            val result = seq_ce_run_int(fn():
                seq_ce_yield_int(100)
                seq_ce_yield_int(200)
            )
            expect(result[0]).to_equal(100)

        it "second integer is in correct position":
            val result = seq_ce_run_int(fn():
                seq_ce_yield_int(100)
                seq_ce_yield_int(200)
            )
            expect(result[1]).to_equal(200)

        it "consecutive runs are independent":
            val first = seq_ce_run_int(fn():
                seq_ce_yield_int(1)
            )
            val second = seq_ce_run_int(fn():
                seq_ce_yield_int(99)
            )
            expect(second.len()).to_equal(1)

        it "second run does not include first run values":
            val first = seq_ce_run_int(fn():
                seq_ce_yield_int(1)
            )
            val second = seq_ce_run_int(fn():
                seq_ce_yield_int(99)
            )
            expect(second[0]).to_equal(99)

    describe "seq_ce_run_text":
        it "collects no text from empty producer":
            val result = seq_ce_run_text(fn():
                0
            )
            expect(result.len()).to_equal(0)

        it "collects single yielded text":
            val result = seq_ce_run_text(fn():
                seq_ce_yield_text("hello")
            )
            expect(result.len()).to_equal(1)

        it "collected text has correct value":
            val result = seq_ce_run_text(fn():
                seq_ce_yield_text("hello")
            )
            expect(result[0]).to_equal("hello")

        it "collects multiple yielded text values":
            val result = seq_ce_run_text(fn():
                seq_ce_yield_text("a")
                seq_ce_yield_text("b")
                seq_ce_yield_text("c")
            )
            expect(result.len()).to_equal(3)

        it "text values are in yield order":
            val result = seq_ce_run_text(fn():
                seq_ce_yield_text("first")
                seq_ce_yield_text("second")
            )
            expect(result[0]).to_equal("first")

        it "second text is in correct position":
            val result = seq_ce_run_text(fn():
                seq_ce_yield_text("first")
                seq_ce_yield_text("second")
            )
            expect(result[1]).to_equal("second")

    describe "seq_ce_bind_array":
        it "iterates over each item in array":
            seq_ce_begin()
            seq_ce_bind_array(["a", "b", "c"], fn(item):
                seq_ce_yield_text(item)
            )
            val result = seq_ce_end_text()
            expect(result.len()).to_equal(3)

        it "first bound item is correct":
            seq_ce_begin()
            seq_ce_bind_array(["x", "y", "z"], fn(item):
                seq_ce_yield_text(item)
            )
            val result = seq_ce_end_text()
            expect(result[0]).to_equal("x")

        it "second bound item is correct":
            seq_ce_begin()
            seq_ce_bind_array(["x", "y", "z"], fn(item):
                seq_ce_yield_text(item)
            )
            val result = seq_ce_end_text()
            expect(result[1]).to_equal("y")

        it "iterates empty array without error":
            seq_ce_begin()
            seq_ce_bind_array([], fn(item):
                seq_ce_yield_text(item)
            )
            val result = seq_ce_end_text()
            expect(result.len()).to_equal(0)

        it "body can transform values":
            seq_ce_begin()
            seq_ce_bind_array(["hello", "world"], fn(item):
                seq_ce_yield_text("prefix_{item}")
            )
            val result = seq_ce_end_text()
            expect(result[0]).to_equal("prefix_hello")
