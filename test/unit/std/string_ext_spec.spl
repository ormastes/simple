# Tests for std.string module
# Covers all exported functions from src/std/string.spl

use std.string.{char_code, text_hash, text_trim_start_matches, text_trim_end_matches}
use std.string.{NL}
use std.string.{text_contains_char, text_index_of_char, text_repeat, text_pad_left, text_pad_right}
use std.string.{text_is_digit, text_is_alpha, text_is_alphanumeric}
use std.string.{repeat_str, reverse_str, join_strs}
use std.string.{contains_char, count_char, index_of_char, last_index_of_char}
use std.string.{starts_with_char, ends_with_char, char_at}
use std.string.{is_whitespace, is_empty, is_blank}
use std.string.{compare_case_insensitive, to_lowercase_str, to_uppercase_str, capitalize_first}
use std.string.{split_on_char, str_lines, str_words}
use std.string.{char_from_code, parse_i64_safe, char_to_digit}
use std.string.{parse_i64, to_int_or, split_lines, string_hash}
use std.string.{string_to_lowercase, string_to_uppercase, string_trim, string_split}

describe "std.string":
    describe "char_code":
        it "returns ASCII code for letters":
            expect(char_code("A")).to_equal(65)
            expect(char_code("Z")).to_equal(90)
            expect(char_code("a")).to_equal(97)
            expect(char_code("z")).to_equal(122)

        it "returns ASCII code for digits":
            expect(char_code("0")).to_equal(48)
            expect(char_code("9")).to_equal(57)

        it "returns ASCII code for special chars":
            expect(char_code(" ")).to_equal(32)
            expect(char_code("!")).to_equal(33)
            expect(char_code("@")).to_equal(64)

    describe "text_hash":
        it "returns consistent hash for same string":
            val h1 = text_hash("hello")
            val h2 = text_hash("hello")
            expect(h1).to_equal(h2)

        it "returns different hashes for different strings":
            val h1 = text_hash("hello")
            val h2 = text_hash("world")
            expect(h1 != h2).to_equal(true)

        it "handles empty string":
            val h = text_hash("")
            expect(h != 0).to_equal(true)

    describe "text_trim_start_matches":
        it "removes prefix pattern":
            expect(text_trim_start_matches("///path", "/")).to_equal("path")

        it "leaves string unchanged if no match":
            expect(text_trim_start_matches("hello", "x")).to_equal("hello")

        it "handles empty string":
            expect(text_trim_start_matches("", "/")).to_equal("")

    describe "text_trim_end_matches":
        it "removes suffix pattern":
            expect(text_trim_end_matches("path///", "/")).to_equal("path")

        it "leaves string unchanged if no match":
            expect(text_trim_end_matches("hello", "x")).to_equal("hello")

    describe "text_contains_char":
        it "finds character in string":
            expect(text_contains_char("hello", "e")).to_equal(true)

        it "returns false for missing character":
            expect(text_contains_char("hello", "x")).to_equal(false)

    describe "text_index_of_char":
        it "returns index of character":
            expect(text_index_of_char("hello", "e")).to_equal(1)

        it "returns -1 for missing character":
            expect(text_index_of_char("hello", "x")).to_equal(-1)

    describe "text_repeat":
        it "repeats string n times":
            expect(text_repeat("ab", 3)).to_equal("ababab")

        it "returns empty for zero count":
            expect(text_repeat("x", 0)).to_equal("")

    describe "text_pad_left":
        it "pads string to desired width":
            expect(text_pad_left("42", 5, "0")).to_equal("00042")

        it "leaves string unchanged if already wide enough":
            expect(text_pad_left("hello", 3, " ")).to_equal("hello")

    describe "text_pad_right":
        it "pads string to desired width":
            expect(text_pad_right("42", 5, "0")).to_equal("42000")

        it "leaves string unchanged if already wide enough":
            expect(text_pad_right("hello", 3, " ")).to_equal("hello")

    describe "text_is_digit":
        it "returns true for digit characters":
            expect(text_is_digit("0")).to_equal(true)
            expect(text_is_digit("5")).to_equal(true)
            expect(text_is_digit("9")).to_equal(true)

        it "returns false for non-digits":
            expect(text_is_digit("a")).to_equal(false)
            expect(text_is_digit(" ")).to_equal(false)

    describe "text_is_alpha":
        it "returns true for letter characters":
            expect(text_is_alpha("a")).to_equal(true)
            expect(text_is_alpha("Z")).to_equal(true)

        it "returns false for non-letters":
            expect(text_is_alpha("5")).to_equal(false)
            expect(text_is_alpha(" ")).to_equal(false)

    describe "text_is_alphanumeric":
        it "returns true for letters and digits":
            expect(text_is_alphanumeric("a")).to_equal(true)
            expect(text_is_alphanumeric("5")).to_equal(true)

        it "returns false for special chars":
            expect(text_is_alphanumeric(" ")).to_equal(false)
            expect(text_is_alphanumeric("!")).to_equal(false)

    describe "repeat_str":
        it "repeats string":
            expect(repeat_str("ab", 3)).to_equal("ababab")

        it "handles zero":
            expect(repeat_str("x", 0)).to_equal("")

        it "handles empty":
            expect(repeat_str("", 5)).to_equal("")

    describe "reverse_str":
        it "reverses string":
            expect(reverse_str("hello")).to_equal("olleh")

        it "handles empty":
            expect(reverse_str("")).to_equal("")

        it "handles single char":
            expect(reverse_str("x")).to_equal("x")

    describe "join_strs":
        it "joins with separator":
            expect(join_strs(["a", "b", "c"], ", ")).to_equal("a, b, c")

        it "handles empty list":
            expect(join_strs([], ", ")).to_equal("")

        it "handles single element":
            expect(join_strs(["hello"], "-")).to_equal("hello")

    describe "contains_char":
        it "finds character":
            expect(contains_char("hello", "e")).to_equal(true)

        it "misses character":
            expect(contains_char("hello", "x")).to_equal(false)

    describe "count_char":
        it "counts occurrences":
            expect(count_char("hello", "l")).to_equal(2)
            expect(count_char("hello", "x")).to_equal(0)

    describe "index_of_char":
        it "finds first index":
            val idx = index_of_char("hello", "l")
            expect(idx.?).to_equal(true)

        it "returns nil for missing":
            val idx = index_of_char("hello", "x")
            expect(idx.?).to_equal(false)

    describe "last_index_of_char":
        it "finds last index":
            val idx = last_index_of_char("hello", "l")
            expect(idx.?).to_equal(true)

    describe "starts_with_char":
        it "checks first character":
            expect(starts_with_char("hello", "h")).to_equal(true)
            expect(starts_with_char("hello", "x")).to_equal(false)

    describe "ends_with_char":
        it "checks last character":
            expect(ends_with_char("hello", "o")).to_equal(true)
            expect(ends_with_char("hello", "x")).to_equal(false)

    describe "char_at":
        it "returns character at index":
            expect(char_at("hello", 0)).to_equal("h")
            expect(char_at("hello", 4)).to_equal("o")

    describe "is_whitespace":
        it "detects whitespace strings":
            expect(is_whitespace("   ")).to_equal(true)
            expect(is_whitespace("")).to_equal(true)

        it "rejects non-whitespace":
            expect(is_whitespace("hello")).to_equal(false)

    describe "is_empty":
        it "detects empty string":
            expect(is_empty("")).to_equal(true)
            expect(is_empty("x")).to_equal(false)

    describe "is_blank":
        it "detects blank strings":
            expect(is_blank("")).to_equal(true)
            expect(is_blank("   ")).to_equal(true)
            expect(is_blank("hello")).to_equal(false)

    describe "compare_case_insensitive":
        it "compares ignoring case":
            expect(compare_case_insensitive("Hello", "hello")).to_equal(true)
            expect(compare_case_insensitive("ABC", "abc")).to_equal(true)
            expect(compare_case_insensitive("abc", "xyz")).to_equal(false)

    describe "to_lowercase_str":
        it "converts to lowercase":
            expect(to_lowercase_str("HELLO")).to_equal("hello")
            expect(to_lowercase_str("Hello")).to_equal("hello")

    describe "to_uppercase_str":
        it "converts to uppercase":
            expect(to_uppercase_str("hello")).to_equal("HELLO")

    describe "capitalize_first":
        it "capitalizes first letter":
            expect(capitalize_first("hello")).to_equal("Hello")

        it "handles empty string":
            expect(capitalize_first("")).to_equal("")

    describe "split_on_char":
        it "splits string by character":
            val parts = split_on_char("a,b,c", ",")
            expect(parts.len()).to_equal(3)
            expect(parts[0]).to_equal("a")
            expect(parts[2]).to_equal("c")

    describe "str_lines":
        it "splits into lines":
            val lines = str_lines("a{NL}b{NL}c")
            expect(lines.len()).to_equal(3)

    describe "str_words":
        it "splits into words":
            val words = str_words("hello world foo")
            expect(words.len()).to_equal(3)
            expect(words[0]).to_equal("hello")

    describe "char_from_code":
        it "converts code to character":
            expect(char_from_code(65)).to_equal("A")
            expect(char_from_code(97)).to_equal("a")
            expect(char_from_code(48)).to_equal("0")

    describe "parse_i64_safe":
        it "parses valid integers":
            expect(parse_i64_safe("42")).to_equal(42)
            expect(parse_i64_safe("0")).to_equal(0)

        it "returns 0 for invalid":
            expect(parse_i64_safe("abc")).to_equal(0)

    describe "char_to_digit":
        it "converts digit chars to values":
            expect(char_to_digit("0")).to_equal(0)
            expect(char_to_digit("9")).to_equal(9)

        it "returns 0 for non-digits":
            expect(char_to_digit("a")).to_equal(0)

    describe "parse_i64":
        it "parses integers":
            expect(parse_i64("42")).to_equal(42)

    describe "to_int_or":
        it "parses valid integers":
            expect(to_int_or("42", -1)).to_equal(42)

        it "returns default for empty string":
            expect(to_int_or("", -1)).to_equal(-1)

        it "returns 0 for unparseable non-empty":
            expect(to_int_or("abc", -1)).to_equal(0)

    describe "split_lines":
        it "splits by newline":
            val lines = split_lines("a{NL}b{NL}c")
            expect(lines.len()).to_equal(3)

    describe "string_hash":
        it "returns consistent hash":
            val h1 = string_hash("test")
            val h2 = string_hash("test")
            expect(h1).to_equal(h2)

    describe "string_to_lowercase":
        it "converts to lowercase":
            expect(string_to_lowercase("HELLO")).to_equal("hello")

    describe "string_to_uppercase":
        it "converts to uppercase":
            expect(string_to_uppercase("hello")).to_equal("HELLO")

    describe "string_trim":
        it "trims whitespace":
            expect(string_trim("  hello  ")).to_equal("hello")

    describe "string_split":
        it "splits by delimiter":
            val parts = string_split("a,b,c", ",")
            expect(parts.len()).to_equal(3)
