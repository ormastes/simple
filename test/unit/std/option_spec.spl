# Option chaining methods spec
#
# Tests for src/std/option.spl

use std.option.{
    option_is_some, option_is_none,
    option_map, option_filter, option_flat_map,
    option_or_else, option_unwrap_or, option_unwrap_or_else,
    option_zip, option_to_result, option_inspect
}

describe "Option stdlib":
    describe "option_is_some and option_is_none":
        it "is_some returns true for non-nil":
            expect(option_is_some(42)).to_equal(true)

        it "is_some returns false for nil":
            expect(option_is_some(nil)).to_equal(false)

        it "is_none returns true for nil":
            expect(option_is_none(nil)).to_equal(true)

        it "is_none returns false for non-nil":
            expect(option_is_none("hello")).to_equal(false)

    describe "option_unwrap_or":
        it "returns value when some":
            expect(option_unwrap_or(10, 99)).to_equal(10)

        it "returns default when nil":
            expect(option_unwrap_or(nil, 99)).to_equal(99)

    describe "option_map":
        it "maps some value":
            val result = option_map(5, fn(x): x * 2)
            expect(result).to_equal(10)

        it "returns nil for nil":
            val result = option_map(nil, fn(x): x * 2)
            expect(result).to_be_nil()

    describe "option_filter":
        it "returns value when predicate true":
            val result = option_filter(10, fn(x): x > 5)
            expect(result).to_equal(10)

        it "returns nil when predicate false":
            val result = option_filter(3, fn(x): x > 5)
            expect(result).to_be_nil()

        it "returns nil for nil input":
            val result = option_filter(nil, fn(x): x > 5)
            expect(result).to_be_nil()

    describe "option_flat_map":
        it "chains some to some":
            val result = option_flat_map(5, fn(x): x * 3)
            expect(result).to_equal(15)

        it "returns nil for nil input":
            val result = option_flat_map(nil, fn(x): x * 3)
            expect(result).to_be_nil()

    describe "option_or_else":
        it "returns original when some":
            val result = option_or_else(42, fn(): 99)
            expect(result).to_equal(42)

        it "calls alternative when nil":
            val result = option_or_else(nil, fn(): 99)
            expect(result).to_equal(99)

    describe "option_zip":
        it "zips two some values":
            val result = option_zip(1, 2)
            expect(result).to_equal([1, 2])

        it "returns nil when first is nil":
            val result = option_zip(nil, 2)
            expect(result).to_be_nil()

        it "returns nil when second is nil":
            val result = option_zip(1, nil)
            expect(result).to_be_nil()

    describe "option_inspect":
        it "does not error on some":
            # option_inspect applies side effect; we verify it returns the value
            val result = option_inspect(42, fn(x): x + 0)
            expect(result).to_equal(42)

        it "does not error on nil":
            val result = option_inspect(nil, fn(x): x + 0)
            expect(result).to_be_nil()
