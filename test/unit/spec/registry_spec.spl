"""
Unit tests for the BDD Registry module.

This test file verifies the core components of the BDD test registry system:
- Example: Test case representation with skip, slow, timeout, and tag support
- ExampleGroup: Hierarchical grouping of test cases with hooks
- Registry functions: Global registration and retrieval of test groups

Uses mock implementations to isolate registry logic from the actual test framework.
"""
# Unit tests for BDD Registry module
# Tests ExampleGroup, Example, Hook, and registry functions
# NOTE: Using mock implementations

# Mock Example class
class Example:
    description: text
    is_skipped: bool
    tags: [text]
    timeout_seconds: Option<i64>

    static fn create(desc: text, block: fn()) -> Example:
        Example(description: desc, is_skipped: false, tags: [], timeout_seconds: nil)

    fn skip() -> Example:
        Example(description: self.description, is_skipped: true, tags: self.tags, timeout_seconds: self.timeout_seconds)

    fn slow() -> Example:
        Example(description: self.description, is_skipped: self.is_skipped, tags: self.tags + ["slow"], timeout_seconds: self.timeout_seconds)

    fn with_timeout(seconds: i64) -> Example:
        Example(description: self.description, is_skipped: self.is_skipped, tags: self.tags, timeout_seconds: Some(seconds))

    fn with_tag(tag: text) -> Example:
        Example(description: self.description, is_skipped: self.is_skipped, tags: self.tags + [tag], timeout_seconds: self.timeout_seconds)

    fn has_tag(tag: text) -> bool:
        self.tags.contains(tag)

    fn is_pending() -> bool:
        self.is_skipped

    fn should_run(run_slow: bool) -> bool:
        if self.is_skipped:
            false
        else:
            if self.has_tag("slow") and not run_slow:
                false
            else:
                true

# Mock ExampleGroup class
class ExampleGroup:
    description: text
    parent: Option<ExampleGroup>
    children: [ExampleGroup]
    test_examples: [Example]
    hooks: [text]

    static fn create(desc: text, parent: Option<ExampleGroup>) -> ExampleGroup:
        ExampleGroup(description: desc, parent: parent, children: [], test_examples: [], hooks: [])

    me add_child(child: ExampleGroup):
        self.children = self.children + [child]

    me add_example(ex: Example):
        self.test_examples = self.test_examples + [ex]

    me add_hook(hook: text):
        self.hooks = self.hooks + [hook]

    fn full_description() -> text:
        match self.parent:
            case Some(p): "{p.full_description()} {self.description}"
            case nil: self.description

    fn example_count() -> i64:
        var count = self.test_examples.len()
        for child in self.children:
            count = count + child.example_count()
        count

# Mock registry state
var registered_groups: [ExampleGroup] = []

fn register_group(g: ExampleGroup):
    registered_groups = registered_groups + [g]

fn get_all_groups() -> [ExampleGroup]:
    registered_groups

fn clear_groups():
    registered_groups = []

fn reset_registry():
    clear_groups()

describe "BDD Registry":
    """
    Tests for the BDD Registry system that manages test examples and groups.

    Covers Example creation and configuration, ExampleGroup hierarchy,
    and registry operations for registering and retrieving test groups.
    """
    context "Example":
        it "creates a new example with description and block":
            val example = Example.create("test description", \: ())
            expect example.description == "test description"
            expect example.is_skipped == false
            expect example.tags.len() == 0

        it "can be marked as skipped":
            val example = Example.create("test", \: ()).skip()
            expect example.is_skipped == true
            expect example.is_pending() == true

        it "can be marked as slow":
            val example = Example.create("test", \: ()).slow()
            expect example.has_tag("slow") == true

        it "can have a timeout set":
            val example = Example.create("test", \: ()).with_timeout(30)
            match example.timeout_seconds:
                case Some(timeout): expect timeout == 30
                case nil: expect false

        it "can have tags added":
            val example = Example.create("test", \: ()).with_tag("integration").with_tag("database")
            expect example.has_tag("integration") == true
            expect example.has_tag("database") == true
            expect example.has_tag("nonexistent") == false

        it "should_run returns false for skipped examples":
            val example = Example.create("test", \: ()).skip()
            expect example.should_run(true) == false

        it "should_run returns false for slow examples when run_slow is false":
            val example = Example.create("test", \: ()).slow()
            expect example.should_run(false) == false

        it "should_run returns true for slow examples when run_slow is true":
            val example = Example.create("test", \: ()).slow()
            expect example.should_run(true) == true

    context "ExampleGroup":
        it "creates a new group with description":
            val group = ExampleGroup.create("MyClass", nil)
            expect group.description == "MyClass"
            expect group.children.len() == 0
            expect group.test_examples.len() == 0

        it "can add examples":
            val group = ExampleGroup.create("Test", nil)
            val example = Example.create("does something", \: ())
            group.add_example(example)
            expect group.test_examples.len() == 1
            expect group.test_examples[0].description == "does something"

        it "full_description returns description for top-level group":
            val group = ExampleGroup.create("Calculator", nil)
            expect group.full_description() == "Calculator"

        it "example_count returns count of direct examples":
            val group = ExampleGroup.create("Test", nil)
            group.add_example(Example.create("test 1", \: ()))
            group.add_example(Example.create("test 2", \: ()))
            expect group.example_count() == 2

    context "Registry - Groups":
        it "can register example groups":
            reset_registry()
            val group = ExampleGroup.create("Test", nil)
            register_group(group)
            val groups = get_all_groups()
            expect groups.len() == 1
            expect groups[0].description == "Test"

        it "can clear all groups":
            reset_registry()
            register_group(ExampleGroup.create("Test", nil))
            clear_groups()
            expect get_all_groups().len() == 0
