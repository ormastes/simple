# Type Substitution Tests
#
# Tests for type parameter substitution during monomorphization.

use compiler_core.types.{TYPE_I64, TYPE_F64, TYPE_TEXT, TYPE_BOOL}
use compiler_core.type_subst.{type_subst_reset, type_subst_add, type_subst_lookup}

describe "Substitution State Management":
    it "resets substitution state":
        type_subst_add("T", TYPE_I64)
        type_subst_add("U", TYPE_TEXT)

        type_subst_reset()

        val t_type = type_subst_lookup("T")
        expect(t_type).to_equal(-1)

    it "adds type parameter mapping":
        type_subst_reset()
        type_subst_add("T", TYPE_I64)

        val result = type_subst_lookup("T")
        expect(result).to_equal(TYPE_I64)

    it "adds multiple type parameters":
        type_subst_reset()
        type_subst_add("T", TYPE_I64)
        type_subst_add("U", TYPE_TEXT)
        type_subst_add("V", TYPE_F64)

        expect(type_subst_lookup("T")).to_equal(TYPE_I64)
        expect(type_subst_lookup("U")).to_equal(TYPE_TEXT)
        expect(type_subst_lookup("V")).to_equal(TYPE_F64)

describe "Type Lookup":
    it "looks up registered type parameter":
        type_subst_reset()
        type_subst_add("Result", TYPE_BOOL)

        val result = type_subst_lookup("Result")
        expect(result).to_equal(TYPE_BOOL)

    it "returns -1 for unregistered parameter":
        type_subst_reset()

        val result = type_subst_lookup("NonExistent")
        expect(result).to_equal(-1)

    it "distinguishes between different parameter names":
        type_subst_reset()
        type_subst_add("T", TYPE_I64)
        type_subst_add("U", TYPE_TEXT)

        val t_result = type_subst_lookup("T")
        val u_result = type_subst_lookup("U")

        expect(t_result).to_equal(TYPE_I64)
        expect(u_result).to_equal(TYPE_TEXT)

describe "Order Independence":
    it "preserves order of additions":
        type_subst_reset()
        type_subst_add("First", TYPE_I64)
        type_subst_add("Second", TYPE_TEXT)
        type_subst_add("Third", TYPE_F64)

        expect(type_subst_lookup("First")).to_equal(TYPE_I64)
        expect(type_subst_lookup("Second")).to_equal(TYPE_TEXT)
        expect(type_subst_lookup("Third")).to_equal(TYPE_F64)

    it "handles repeated lookups":
        type_subst_reset()
        type_subst_add("Cached", TYPE_BOOL)

        val r1 = type_subst_lookup("Cached")
        val r2 = type_subst_lookup("Cached")
        val r3 = type_subst_lookup("Cached")

        expect(r1).to_equal(TYPE_BOOL)
        expect(r2).to_equal(TYPE_BOOL)
        expect(r3).to_equal(TYPE_BOOL)

describe "Edge Cases":
    it "handles empty parameter name":
        type_subst_reset()
        type_subst_add("", TYPE_I64)

        val result = type_subst_lookup("")
        expect(result).to_equal(TYPE_I64)

    it "handles single-character parameter names":
        type_subst_reset()
        type_subst_add("T", TYPE_I64)
        type_subst_add("U", TYPE_TEXT)

        expect(type_subst_lookup("T")).to_equal(TYPE_I64)
        expect(type_subst_lookup("U")).to_equal(TYPE_TEXT)

    it "handles long parameter names":
        type_subst_reset()
        type_subst_add("VeryLongTypeParameterName", TYPE_F64)

        val result = type_subst_lookup("VeryLongTypeParameterName")
        expect(result).to_equal(TYPE_F64)

describe "Multiple Reset Cycles":
    it "can reset and rebuild state multiple times":
        # First cycle
        type_subst_reset()
        type_subst_add("T", TYPE_I64)
        expect(type_subst_lookup("T")).to_equal(TYPE_I64)

        # Second cycle
        type_subst_reset()
        type_subst_add("T", TYPE_TEXT)
        expect(type_subst_lookup("T")).to_equal(TYPE_TEXT)

        # Third cycle
        type_subst_reset()
        type_subst_add("T", TYPE_F64)
        expect(type_subst_lookup("T")).to_equal(TYPE_F64)

    it "isolates cycles from each other":
        # First cycle
        type_subst_reset()
        type_subst_add("X", TYPE_I64)

        # Second cycle
        type_subst_reset()
        type_subst_add("Y", TYPE_TEXT)

        # X should not be found
        expect(type_subst_lookup("X")).to_equal(-1)
        expect(type_subst_lookup("Y")).to_equal(TYPE_TEXT)
