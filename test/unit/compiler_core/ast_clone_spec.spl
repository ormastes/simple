# AST Cloning Tests
#
# Tests for deep cloning of AST nodes for generic monomorphization.

use compiler_core.ast.{expr_alloc, expr_get, stmt_alloc, stmt_get, decl_alloc, decl_get}
use compiler_core.ast.{EXPR_INT_LIT, EXPR_BINARY, STMT_VAL_BINDING, DECL_FN}
use compiler_core.ast_clone.{ast_clone_expr, ast_clone_stmt, ast_clone_decl}
use compiler_core.ast_clone.{ast_clone_is_generic, ast_clone_get_type_params}

describe "Expression Cloning":
    it "clones integer literal":
        val orig_eid = expr_alloc(EXPR_INT_LIT, 0)
        val orig = expr_get(orig_eid)
        orig.i_val = 42

        val clone_eid = ast_clone_expr(orig_eid)
        val clone = expr_get(clone_eid)

        expect(clone.i_val).to_equal(42)
        expect(clone_eid).to_be_greater_than(orig_eid)

    it "clones binary expression with children":
        # Create: 1 + 2
        val left_eid = expr_alloc(EXPR_INT_LIT, 0)
        val left = expr_get(left_eid)
        left.i_val = 1

        val right_eid = expr_alloc(EXPR_INT_LIT, 0)
        val right = expr_get(right_eid)
        right.i_val = 2

        val bin_eid = expr_alloc(EXPR_BINARY, 0)
        val bin = expr_get(bin_eid)
        bin.s_val = "+"
        bin.left = left_eid
        bin.right = right_eid

        # Clone it
        val clone_eid = ast_clone_expr(bin_eid)
        val clone = expr_get(clone_eid)
        val clone_left = expr_get(clone.left)
        val clone_right = expr_get(clone.right)

        expect(clone.s_val).to_equal("+")
        expect(clone_left.i_val).to_equal(1)
        expect(clone_right.i_val).to_equal(2)

    it "handles negative expression IDs":
        val result = ast_clone_expr(-1)
        expect(result).to_equal(-1)

describe "Statement Cloning":
    it "clones val binding statement":
        val val_eid = expr_alloc(EXPR_INT_LIT, 0)
        val val_expr = expr_get(val_eid)
        val_expr.i_val = 100

        val stmt_id = stmt_alloc(STMT_VAL_BINDING, 0)
        val stmt = stmt_get(stmt_id)
        stmt.name = "x"
        stmt.value = val_eid

        val clone_id = ast_clone_stmt(stmt_id)
        val clone = stmt_get(clone_id)
        val clone_val = expr_get(clone.value)

        expect(clone.name).to_equal("x")
        expect(clone_val.i_val).to_equal(100)

    it "handles negative statement IDs":
        val result = ast_clone_stmt(-1)
        expect(result).to_equal(-1)

describe "Declaration Cloning":
    it "clones function declaration":
        val body_stmt = stmt_alloc(STMT_VAL_BINDING, 0)
        val body = stmt_get(body_stmt)
        body.name = "result"

        val decl_id = decl_alloc(DECL_FN, 0)
        val decl = decl_get(decl_id)
        decl.name = "test_fn"
        decl.param_names = ["x", "y"]
        decl.body_stmts = [body_stmt]

        val clone_id = ast_clone_decl(decl_id)
        val clone = decl_get(clone_id)

        expect(clone.name).to_equal("test_fn")
        expect(clone.param_names.len()).to_equal(2)
        expect(clone.param_names[0]).to_equal("x")
        expect(clone.body_stmts.len()).to_equal(1)

    it "clears type params in cloned declaration":
        val decl_id = decl_alloc(DECL_FN, 0)
        val decl = decl_get(decl_id)
        decl.name = "generic_fn"
        decl.type_params = ["T", "U"]

        val clone_id = ast_clone_decl(decl_id)
        val clone = decl_get(clone_id)

        # Original has type params
        expect(decl.type_params.len()).to_equal(2)
        # Clone should have them cleared (for specialization)
        expect(clone.type_params.len()).to_equal(0)

    it "handles negative declaration IDs":
        val result = ast_clone_decl(-1)
        expect(result).to_equal(-1)

describe "Generic Detection":
    it "detects generic functions":
        val decl_id = decl_alloc(DECL_FN, 0)
        val decl = decl_get(decl_id)
        decl.name = "identity"
        decl.type_params = ["T"]

        val is_gen = ast_clone_is_generic(decl_id)
        expect(is_gen).to_equal(true)

    it "detects non-generic functions":
        val decl_id = decl_alloc(DECL_FN, 0)
        val decl = decl_get(decl_id)
        decl.name = "regular"
        decl.type_params = []

        val is_gen = ast_clone_is_generic(decl_id)
        expect(is_gen).to_equal(false)

    it "gets type parameters":
        val decl_id = decl_alloc(DECL_FN, 0)
        val decl = decl_get(decl_id)
        decl.type_params = ["A", "B", "C"]

        val params = ast_clone_get_type_params(decl_id)
        expect(params.len()).to_equal(3)
        expect(params[0]).to_equal("A")
        expect(params[1]).to_equal("B")
        expect(params[2]).to_equal("C")
