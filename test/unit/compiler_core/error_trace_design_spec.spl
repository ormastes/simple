# Error Propagation Trace — Design Specification
#
# This is a TDD spec file documenting expected behavior for ? error traces.
# No actual error trace implementation exists yet — this spec describes the design.
#
# The ? operator should propagate nil/error values up the call stack,
# and optionally record a trace of source locations for debugging.

describe "error propagation trace design":
    it "? operator propagates nil from a function":
        # When a value is nil, ? should propagate it (simulate nil propagation)
        val nil_val = nil
        val propagated = nil_val  # simulates ? propagation
        expect(propagated).to_be_nil()

    it "trace buffer records source location as text":
        # Expected: each ? site records file:line info as a text entry
        val trace_entry = "file.spl:42"
        expect(trace_entry.len() > 0).to_equal(true)

    it "trace entry contains filename":
        val trace_entry = "parser.spl:100"
        val has_spl = trace_entry.contains(".spl")
        expect(has_spl).to_equal(true)

    it "trace entry contains line number":
        val trace_entry = "eval.spl:512"
        val has_colon = trace_entry.contains(":")
        expect(has_colon).to_equal(true)

    it "multiple ? sites produce multiple trace entries":
        # Simulated trace buffer (future: populated by ? operator)
        var trace_buf: [text] = []
        trace_buf.push("a.spl:10")
        trace_buf.push("b.spl:20")
        trace_buf.push("c.spl:30")
        expect(trace_buf.len()).to_equal(3)

    it "trace is empty when no errors propagated":
        var empty_trace: [text] = []
        expect(empty_trace.len()).to_equal(0)

    it "propagation stops at top-level handler":
        # The outermost caller receives the nil value
        fn maybe_fail(should_fail: bool) -> i64:
            if should_fail:
                return 0  # represents error case
            42
        val result = maybe_fail(false)
        expect(result).to_equal(42)

    it "nil propagation preserves the nil value":
        val original = nil
        var captured = original
        expect(captured).to_be_nil()

    it "trace format is colon-separated file and line":
        # Expected trace format: "filename.spl:linenum"
        val expected_format = "module.spl:1"
        val parts_check = expected_format.contains(".spl:")
        expect(parts_check).to_equal(true)

    it "error message is preserved through propagation":
        # When an error carries a message, ? should not discard it
        val error_msg = "connection refused"
        val preserved = error_msg
        expect(preserved).to_equal("connection refused")
