# Core Simple â€” MIR Tests
use compiler.core.mir.*
use compiler.core.types.{TYPE_I64}


describe "core.mir":
    before_each:
        mir_reset()

    describe "instruction kinds":
        it "maps kind names":
            expect(mir_inst_kind_name(MIR_CONST_INT)).to_equal("ConstInt")
            expect(mir_inst_kind_name(MIR_ADD)).to_equal("Add")
            expect(mir_inst_kind_name(MIR_DIV)).to_equal("Div")
            expect(mir_inst_kind_name(MIR_POW)).to_equal("Pow")
            expect(mir_inst_kind_name(MIR_STR_CONCAT)).to_equal("StrConcat")
            expect(mir_inst_kind_name(MIR_CALL_EXTERN)).to_equal("CallExtern")
            expect(mir_inst_kind_name(999)).to_equal("Unknown")

    describe "instruction pool":
        it "allocates const and binop instructions":
            val v0 = mir_var_new("x", TYPE_I64)
            val v1 = mir_var_new("y", TYPE_I64)
            val i0 = mir_const_int(v0, 42)
            val i1 = mir_binop(MIR_ADD, v1, v0, v0)
            expect(inst_count()).to_equal(2)
            expect(inst_get_kind(i0)).to_equal(MIR_CONST_INT)
            expect(inst_get_dest(i0)).to_equal(v0)
            expect(inst_get_int(i0)).to_equal(42)
            expect(inst_get_kind(i1)).to_equal(MIR_ADD)
            expect(inst_get_dest(i1)).to_equal(v1)
            expect(inst_get_src1(i1)).to_equal(v0)
            expect(inst_get_src2(i1)).to_equal(v0)

        it "allocates call and aggregate instructions":
            val v0 = mir_var_new("x", TYPE_I64)
            val i0 = mir_call(v0, "foo", [v0])
            val i1 = mir_aggregate(v0, AGG_ARRAY, "", [v0])
            expect(inst_get_kind(i0)).to_equal(MIR_CALL)
            expect(inst_get_args(i0).len()).to_equal(1)
            expect(inst_get_kind(i1)).to_equal(MIR_AGGREGATE)
            expect(inst_get_args(i1).len()).to_equal(1)

    describe "terminators":
        it "allocates terminators":
            val t0 = term_goto(1)
            val t1 = term_return(2)
            val t2 = term_return_void()
            val t3 = term_if_branch(3, 4, 5)
            val t4 = term_switch(6, [1, 2], [10, 11], 12)
            val t5 = term_unreachable()
            expect(term_count()).to_equal(6)
            expect(term_get_kind(t0)).to_equal(TERM_GOTO)
            expect(term_get_target1(t0)).to_equal(1)
            expect(term_get_kind(t1)).to_equal(TERM_RETURN)
            expect(term_get_value(t1)).to_equal(2)
            expect(term_get_kind(t2)).to_equal(TERM_RETURN_VOID)
            expect(term_get_kind(t3)).to_equal(TERM_IF)
            expect(term_get_cond(t3)).to_equal(3)
            expect(term_get_target1(t3)).to_equal(4)
            expect(term_get_target2(t3)).to_equal(5)
            expect(term_get_kind(t4)).to_equal(TERM_SWITCH)
            expect(term_get_values(t4).len()).to_equal(2)
            expect(term_get_targets(t4).len()).to_equal(2)
            expect(term_get_target1(t4)).to_equal(12)
            expect(term_get_kind(t5)).to_equal(TERM_UNREACHABLE)

    describe "basic blocks":
        it "stores instructions and terminators":
            val b0 = bb_new("entry")
            val v0 = mir_var_new("x", TYPE_I64)
            val i0 = mir_const_int(v0, 1)
            val t0 = term_return(v0)
            bb_add_inst(b0, i0)
            bb_set_terminator(b0, t0)
            expect(bb_get_label(b0)).to_equal("entry")
            expect(bb_get_instructions(b0).len()).to_equal(1)
            expect(bb_get_terminator(b0)).to_equal(t0)

    describe "functions and module":
        it "creates functions and module structs":
            val fn_id = mir_fn_new("main", [], [], TYPE_I64, 0)
            val b0 = bb_new("entry")
            mir_fn_add_bb(fn_id, b0)
            val v0 = mir_var_new("x", TYPE_I64)
            mir_fn_add_var(fn_id, v0)
            expect(mir_fn_count()).to_equal(1)
            expect(mir_fn_get_name(fn_id)).to_equal("main")
            expect(mir_fn_get_bbs(fn_id).len()).to_equal(1)
            expect(mir_fn_get_vars(fn_id).len()).to_equal(1)
            expect(mir_fn_is_extern_fn(fn_id)).to_equal(false)

            mir_module_add_fn(fn_id)
            mir_module_add_struct("Point", ["x"], [TYPE_I64])
            expect(mir_module_get_fns().len()).to_equal(1)
            expect(mir_module_get_structs().len()).to_equal(1)
            expect(mir_module_get_struct_fields(0).len()).to_equal(1)
            expect(mir_module_get_struct_types(0)[0]).to_equal(TYPE_I64)
