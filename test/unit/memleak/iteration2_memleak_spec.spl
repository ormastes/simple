# Memory Leak Measurement Spec - Iteration 2
#
# Second of 3 sequential test files to measure parent-process memdiff.
# Run all 3 together: bin/simple test --mem-check test/unit/memleak/

extern fn rt_file_read_text(path: text) -> text

describe "Memleak iteration 2":
    it "performs typical test workload":
        # Note: nested fn can't mutate outer closure vars, so we return the array
        fn do_work() -> [text]:
            var out: [text] = []
            var k = 0
            while k < 10:
                out.push("iteration2_string_{k}_with_padding")
                k = k + 1
            out
        val data = do_work()
        expect(data.len()).to_equal(10)

    it "reads RSS for comparison":
        val status = rt_file_read_text("/proc/self/status") ?? ""
        var rss_line = ""
        if status != "":
            val lines = status.split("\n")
            for line in lines:
                if line.starts_with("VmRSS:"):
                    rss_line = line
        if rss_line != "":
            print "  [RSS] {rss_line}"
        expect(1).to_equal(1)
