# Allocation Listener Callback Tests (WI-2)
#
# Verifies the allocation listener API exists in the runtime headers
# and implementation files.

extern fn rt_file_read_text(path: text) -> text

describe "WI-2: Allocation listener types in header":
    it "SplAllocEventKind enum defined":
        val content = rt_file_read_text("src/runtime/runtime_memtrack.h") ?? ""
        expect(content.contains("SplAllocEventKind")).to_equal(true)

    it "SPL_ALLOC_MALLOC defined":
        val content = rt_file_read_text("src/runtime/runtime_memtrack.h") ?? ""
        expect(content.contains("SPL_ALLOC_MALLOC")).to_equal(true)

    it "SPL_ALLOC_FREE defined":
        val content = rt_file_read_text("src/runtime/runtime_memtrack.h") ?? ""
        expect(content.contains("SPL_ALLOC_FREE")).to_equal(true)

    it "SplAllocEvent struct defined":
        val content = rt_file_read_text("src/runtime/runtime_memtrack.h") ?? ""
        expect(content.contains("SplAllocEvent")).to_equal(true)

    it "SplAllocEvent has kind field":
        val content = rt_file_read_text("src/runtime/runtime_memtrack.h") ?? ""
        expect(content.contains("SplAllocEventKind kind")).to_equal(true)

    it "SplAllocEvent has ptr field":
        val content = rt_file_read_text("src/runtime/runtime_memtrack.h") ?? ""
        expect(content.contains("void*       ptr")).to_equal(true)

    it "SplAllocEvent has alloc_id field":
        val content = rt_file_read_text("src/runtime/runtime_memtrack.h") ?? ""
        expect(content.contains("int64_t     alloc_id")).to_equal(true)

describe "WI-2: Listener callback typedef":
    it "spl_alloc_listener_fn typedef defined":
        val content = rt_file_read_text("src/runtime/runtime_memtrack.h") ?? ""
        expect(content.contains("spl_alloc_listener_fn")).to_equal(true)

    it "set_listener function declared":
        val content = rt_file_read_text("src/runtime/runtime_memtrack.h") ?? ""
        expect(content.contains("spl_memtrack_set_listener")).to_equal(true)

    it "clear_listener function declared":
        val content = rt_file_read_text("src/runtime/runtime_memtrack.h") ?? ""
        expect(content.contains("spl_memtrack_clear_listener")).to_equal(true)

describe "WI-2: Listener implementation":
    it "g_listener_fn static variable exists":
        val content = rt_file_read_text("src/runtime/runtime_memtrack.c") ?? ""
        expect(content.contains("g_listener_fn")).to_equal(true)

    it "g_listener_data static variable exists":
        val content = rt_file_read_text("src/runtime/runtime_memtrack.c") ?? ""
        expect(content.contains("g_listener_data")).to_equal(true)

    it "record() dispatches to listener":
        val content = rt_file_read_text("src/runtime/runtime_memtrack.c") ?? ""
        # spl_memtrack_record should call g_listener_fn when set
        expect(content.contains("g_listener_fn(&ev, g_listener_data)")).to_equal(true)

    it "unrecord() dispatches to listener before removing":
        val content = rt_file_read_text("src/runtime/runtime_memtrack.c") ?? ""
        # spl_memtrack_unrecord should notify listener with SPL_ALLOC_FREE
        expect(content.contains("ev.kind     = SPL_ALLOC_FREE")).to_equal(true)

    it "set_listener implementation exists":
        val content = rt_file_read_text("src/runtime/runtime_memtrack.c") ?? ""
        expect(content.contains("void spl_memtrack_set_listener")).to_equal(true)

    it "clear_listener sets to NULL":
        val content = rt_file_read_text("src/runtime/runtime_memtrack.c") ?? ""
        expect(content.contains("void spl_memtrack_clear_listener")).to_equal(true)

describe "WI-2: Simple FFI wrappers":
    it "mem_tracker/mod.spl exports listener functions":
        val content = rt_file_read_text("src/lib/nogc_sync_mut/mem_tracker/mod.spl") ?? ""
        expect(content.contains("mem_set_listener")).to_equal(true)
        expect(content.contains("mem_clear_listener")).to_equal(true)

    it "extern declaration for set_listener":
        val content = rt_file_read_text("src/lib/nogc_sync_mut/mem_tracker/mod.spl") ?? ""
        expect(content.contains("extern fn spl_memtrack_set_listener")).to_equal(true)

    it "extern declaration for clear_listener":
        val content = rt_file_read_text("src/lib/nogc_sync_mut/mem_tracker/mod.spl") ?? ""
        expect(content.contains("extern fn spl_memtrack_clear_listener")).to_equal(true)
