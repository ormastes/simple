# NoGC CUDA Module Tests
#
# Tests verify the NoGC CUDA module structural patterns:
#   - No owns_handle field in wrapper classes
#   - Unconditional drop() (no conditional guard)
#   - Identical API surface to gc_async_mut/cuda version

# ============================================================================
# Mock FFI (replaces actual CUDA FFI for unit testing)
# ============================================================================

var mock_handles: i64 = 1000

fn mock_rt_cuda_available() -> bool:
    true

fn mock_rt_cuda_stream_create() -> i64:
    mock_handles = mock_handles + 1
    mock_handles

fn mock_rt_cuda_event_create() -> i64:
    mock_handles = mock_handles + 1
    mock_handles

fn mock_rt_cuda_malloc(size_bytes: i64) -> i64:
    mock_handles = mock_handles + 1
    mock_handles

fn mock_rt_cuda_stream_destroy(handle: i64):
    0

fn mock_rt_cuda_event_destroy(handle: i64):
    0

fn mock_rt_cuda_free(handle: i64):
    0

fn mock_rt_cuda_cudastream_synchronize(handle: i64) -> bool:
    true

fn mock_rt_cuda_cudastream_query(handle: i64) -> bool:
    true

fn mock_rt_cuda_cudaevent_synchronize(handle: i64) -> bool:
    true

fn mock_rt_cuda_cudaevent_query(handle: i64) -> bool:
    true

fn mock_rt_cuda_cudadevicemem_is_null(handle: i64) -> bool:
    false

# ============================================================================
# Mock NoGC wrapper classes (mirrors nogc_sync_mut/cuda/mod.spl pattern)
# No owns_handle field — unique ownership always owns
# ============================================================================

class MockCudaStream:
    # NoGC CUDA stream — no owns_handle.
    handle: i64

    static fn create() -> MockCudaStream:
        val handle = mock_rt_cuda_stream_create()
        MockCudaStream(handle: handle)

    fn drop():
        # Unconditional — no owns_handle guard
        mock_rt_cuda_stream_destroy(self.handle)

    fn synchronize() -> bool:
        mock_rt_cuda_cudastream_synchronize(self.handle)

    fn query() -> bool:
        mock_rt_cuda_cudastream_query(self.handle)


class MockCudaEvent:
    # NoGC CUDA event — no owns_handle.
    handle: i64

    static fn create() -> MockCudaEvent:
        val handle = mock_rt_cuda_event_create()
        MockCudaEvent(handle: handle)

    fn drop():
        # Unconditional — no owns_handle guard
        mock_rt_cuda_event_destroy(self.handle)

    fn synchronize() -> bool:
        mock_rt_cuda_cudaevent_synchronize(self.handle)

    fn query() -> bool:
        mock_rt_cuda_cudaevent_query(self.handle)


class MockCudaDeviceMem:
    # NoGC CUDA device memory — no owns_handle.
    handle: i64

    static fn alloc(size_bytes: i64) -> MockCudaDeviceMem:
        val handle = mock_rt_cuda_malloc(size_bytes)
        MockCudaDeviceMem(handle: handle)

    fn drop():
        # Unconditional — no owns_handle guard
        mock_rt_cuda_free(self.handle)

    fn is_null() -> bool:
        mock_rt_cuda_cudadevicemem_is_null(self.handle)

# ============================================================================
# Tests
# ============================================================================

describe "NoGC CUDA module patterns":

    it "MockCudaStream has no owns_handle (NoGC pattern)":
        val stream = MockCudaStream.create()
        # No owns_handle field — this is the NoGC invariant
        expect(stream.handle).to_be_greater_than(0)

    it "MockCudaStream.synchronize() returns bool":
        val stream = MockCudaStream.create()
        val result = stream.synchronize()
        expect(result).to_equal(true)

    it "MockCudaStream.query() returns bool":
        val stream = MockCudaStream.create()
        val result = stream.query()
        expect(result).to_equal(true)

    it "MockCudaEvent has no owns_handle (NoGC pattern)":
        val event = MockCudaEvent.create()
        expect(event.handle).to_be_greater_than(0)

    it "MockCudaEvent.synchronize() returns bool":
        val event = MockCudaEvent.create()
        val result = event.synchronize()
        expect(result).to_equal(true)

    it "MockCudaDeviceMem has no owns_handle (NoGC pattern)":
        val mem = MockCudaDeviceMem.alloc(1024)
        expect(mem.handle).to_be_greater_than(0)

    it "MockCudaDeviceMem.is_null() returns bool":
        val mem = MockCudaDeviceMem.alloc(1024)
        val result = mem.is_null()
        expect(result).to_equal(false)

    it "cuda_available mock returns true":
        val available = mock_rt_cuda_available()
        expect(available).to_equal(true)

    it "handles are unique per allocation":
        val h1 = mock_rt_cuda_stream_create()
        val h2 = mock_rt_cuda_event_create()
        expect(h1).to_be_less_than(h2)
