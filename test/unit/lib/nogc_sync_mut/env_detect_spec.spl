#!/usr/bin/env simple
# Tests for comprehensive environment detection system

use std.spec.env_detect.*

describe "Environment Detection":
    describe "Platform Detection":
        it "detects platform OS":
            val os = get_platform_os()
            check(os != "")
            check(os == "linux" or os == "windows" or os == "macos" or os == "freebsd" or os == "openbsd" or os == "netbsd")

        it "is_windows checks Windows":
            val result = is_windows()
            check(result == true or result == false)

        it "is_linux checks Linux":
            val result = is_linux()
            check(result == true or result == false)

        it "is_macos checks macOS":
            val result = is_macos()
            check(result == true or result == false)

        it "is_unix checks Unix-like systems":
            val result = is_unix()
            check(result == true or result == false)
            # Unix is opposite of Windows
            if is_windows():
                check(is_unix() == false)
            else:
                check(is_unix() == true)

        it "is_bsd checks BSD variants":
            val result = is_bsd()
            check(result == true or result == false)
            # If BSD, must be Unix
            if is_bsd():
                check(is_unix() == true)

        it "platform detection is consistent":
            val os1 = get_platform_os()
            val os2 = get_platform_os()
            check(os1 == os2)

    describe "Runtime Mode Detection":
        it "detects runtime mode":
            val mode = get_runtime_mode()
            check(mode != "")
            check(mode == "interpreter" or mode == "compiled" or mode == "jit" or mode == "aot")

        it "is_interpreter checks interpreter mode":
            val result = is_interpreter()
            check(result == true or result == false)

        it "is_compiled checks compiled mode":
            val result = is_compiled()
            check(result == true or result == false)

        it "is_jit checks JIT mode":
            val result = is_jit()
            check(result == true or result == false)

        it "runtime detection is consistent":
            val mode1 = get_runtime_mode()
            val mode2 = get_runtime_mode()
            check(mode1 == mode2)

    describe "Build Profile Detection":
        it "detects build profile":
            val profile = get_build_profile()
            check(profile != "")
            check(profile == "debug" or profile == "release" or profile == "bootstrap" or profile == "test")

        it "is_debug checks debug build":
            val result = is_debug()
            check(result == true or result == false)

        it "is_release checks release build":
            val result = is_release()
            check(result == true or result == false)

        it "is_bootstrap checks bootstrap build":
            val result = is_bootstrap()
            check(result == true or result == false)

        it "profile detection is consistent":
            val profile1 = get_build_profile()
            val profile2 = get_build_profile()
            check(profile1 == profile2)

    describe "Architecture Detection":
        it "detects CPU architecture":
            val arch = get_architecture()
            check(arch != "")

        it "detects pointer size":
            val size = get_pointer_size()
            check(size == 32 or size == 64)

        it "is_x86_64 checks x86_64":
            val result = is_x86_64()
            check(result == true or result == false)

        it "is_aarch64 checks aarch64/arm64":
            val result = is_aarch64()
            check(result == true or result == false)

        it "is_64bit checks 64-bit":
            val result = is_64bit()
            check(result == true or result == false)

        it "is_32bit checks 32-bit":
            val result = is_32bit()
            check(result == true or result == false)

        it "bit size functions are mutually exclusive":
            val is_64 = is_64bit()
            val is_32 = is_32bit()
            check(is_64 != is_32)

        it "architecture detection is consistent":
            val arch1 = get_architecture()
            val arch2 = get_architecture()
            check(arch1 == arch2)

    describe "Feature Flag Detection":
        it "has_feature checks feature by name":
            # Test with a feature that likely doesn't exist
            val result = has_feature("nonexistent_feature_xyz")
            check(result == false)

        it "has_generics checks generics support":
            val result = has_generics()
            check(result == true or result == false)

        it "has_async checks async support":
            val result = has_async()
            check(result == true or result == false)

        it "has_macros checks macro support":
            val result = has_macros()
            check(result == true or result == false)

        it "has_effects checks effects support":
            val result = has_effects()
            check(result == true or result == false)

        it "has_inline_asm checks inline assembly":
            val result = has_inline_asm()
            check(result == true or result == false)

    describe "Hardware Capability Detection":
        it "has_gpu checks GPU availability":
            val result = has_gpu()
            check(result == true or result == false)

        it "has_cuda checks CUDA availability":
            val result = has_cuda()
            check(result == true or result == false)
            # If CUDA available, GPU must be available
            if has_cuda():
                check(has_gpu() == true)

        it "has_simd checks SIMD support":
            val result = has_simd()
            check(result == true or result == false)

        it "has_avx2 checks AVX2 support":
            val result = has_avx2()
            check(result == true or result == false)
            # AVX2 only on x86_64
            if has_avx2():
                check(is_x86_64() == true)

        it "has_neon checks NEON support":
            val result = has_neon()
            check(result == true or result == false)
            # NEON only on ARM
            if has_neon():
                check(is_aarch64() == true)

        it "get_cpu_cores returns positive number":
            val cores = get_cpu_cores()
            check(cores > 0)

        it "is_multi_core checks multiple cores":
            val result = is_multi_core()
            check(result == true or result == false)
            val cores = get_cpu_cores()
            if cores > 1:
                check(is_multi_core() == true)
            else:
                check(is_multi_core() == false)

    describe "Dependency Detection":
        it "has_module checks module availability":
            val result = has_module("nonexistent_module_xyz")
            check(result == false)

        it "has_library checks library availability":
            val result = has_library("nonexistent_lib_xyz")
            check(result == false)

    describe "Environment Variable Detection":
        it "has_env checks if variable is set":
            val result = has_env("PATH")
            check(result == true)

        it "has_env returns false for nonexistent var":
            val result = has_env("NONEXISTENT_VAR_XYZ_12345")
            check(result == false)

        it "get_env returns empty string for nonexistent var":
            val result = get_env("NONEXISTENT_VAR_XYZ_12345")
            check(result == "")

        it "get_env returns value for existing var":
            val path = get_env("PATH")
            check(path != "")

        it "is_ci checks CI environment":
            val result = is_ci()
            check(result == true or result == false)

    describe "File System Feature Detection":
        it "has_symlinks checks symlink support":
            val result = has_symlinks()
            check(result == true or result == false)
            # Unix always has symlinks
            if is_unix():
                check(has_symlinks() == true)

        it "has_permissions checks permission support":
            val result = has_permissions()
            check(result == true or result == false)
            # Unix always has permissions
            if is_unix():
                check(has_permissions() == true)

        it "is_case_sensitive checks case sensitivity":
            val result = is_case_sensitive()
            check(result == true or result == false)
            # Windows is always case-insensitive
            if is_windows():
                check(is_case_sensitive() == false)

        it "has_xattr checks extended attributes":
            val result = has_xattr()
            check(result == true or result == false)

    describe "Network Detection":
        it "has_network checks network availability":
            val result = has_network()
            check(result == true or result == false)

        it "can_reach checks host reachability":
            val result = can_reach("localhost")
            check(result == true or result == false)

    describe "Version Detection":
        it "get_compiler_version returns version string":
            val version = get_compiler_version()
            check(version != "")

        it "check_version_constraint with >= operator":
            val result = check_version_constraint(">= 0.0.0")
            check(result == true)

        it "check_version_constraint with < operator":
            val result = check_version_constraint("< 999.0.0")
            check(result == true)

        it "check_version_constraint with exact match":
            val version = get_compiler_version()
            val result = check_version_constraint(version)
            check(result == true)

    describe "Performance":
        it "platform detection is fast":
            val start = 0
            var i = 0
            while i < 10:
                val os = get_platform_os()
                i = i + 1
            # Should complete quickly (OS caches uname)
            check(true)

        it "all detections complete within reasonable time":
            get_platform_os()
            get_runtime_mode()
            get_build_profile()
            get_architecture()
            get_pointer_size()
            check(true)
