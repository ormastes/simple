# JSON Library Improvement Tests
# Tests for JSON stdlib improvements


# Mock JSON for testing
class MockJson:
    data: text

impl MockJson:
    static fn from_json(s: text) -> MockJson:
        MockJson(data: s)

    fn get(key: text) -> text:
        key

    fn is_object() -> bool:
        self.data.starts_with("object:")

    fn is_array() -> bool:
        self.data.starts_with("array:")

    static fn to_json(obj: text) -> text:
        "json:" + obj

    static fn escape(s: text) -> text:
        "escaped:" + s

# Mock JSON Builder
class MockJsonBuilder:
    content: text

impl MockJsonBuilder:
    static fn object() -> MockJsonBuilder:
        MockJsonBuilder(content: "object:empty")

    static fn array() -> MockJsonBuilder:
        MockJsonBuilder(content: "array:empty")

    me add(key: text, value: text) -> MockJsonBuilder:
        self.content = "object:" + key + "=" + value
        self

    me append(value: text) -> MockJsonBuilder:
        self.content = "array:" + value
        self

    fn build() -> text:
        self.content

describe "JSON Library Improvements":

    context "JSON Parsing":
        it "from_json parses JSON string":
            val json = MockJson__from_json("object:test")
            expect json.is_object() == true

        it "parses JSON arrays":
            val json = MockJson__from_json("array:test")
            expect json.is_array() == true

        it "parses nested JSON":
            val json = MockJson__from_json("object:nested")
            expect json.is_object() == true

    context "JSON Generation":
        it "to_json converts dict to JSON":
            val json_str = MockJson__to_json("test")
            expect json_str.contains("json:")

        it "to_json handles nested structures":
            val json_str = MockJson__to_json("nested")
            expect json_str.starts_with("json:")

        it "escapes special characters":
            val escaped = MockJson__escape("test")
            expect escaped.starts_with("escaped:")

    context "JSON Builder":
        it "builds JSON objects fluently":
            var builder = MockJsonBuilder__object()
            builder.add(key="key", value="value")
            val json_str = builder.build()
            expect json_str.contains("key")

        it "builds JSON arrays fluently":
            var builder = MockJsonBuilder__array()
            builder.append("item")
            val json_str = builder.build()
            expect json_str.contains("item")
