# Log Module Tests
#
# Tests for simple/std_lib/src/log.spl
# Uses FFI to log_ffi.rs in simple-runtime

import std_lib.src.log as log

describe "Log Levels":
    it "has correct level constants":
        expect log.LOG_OFF == 0
        expect log.LOG_FATAL == 1
        expect log.LOG_ERROR == 2
        expect log.LOG_WARN == 3
        expect log.LOG_INFO == 4
        expect log.LOG_DEBUG == 5
        expect log.LOG_TRACE == 6
        expect log.LOG_VERBOSE == 7
        expect log.LOG_ALL == 10

describe "LogLevel enum":
    it "Off converts to string":
        expect log.LogLevel.Off.to_string() == "off"

    it "Fatal converts to string":
        expect log.LogLevel.Fatal.to_string() == "fatal"

    it "Error converts to string":
        expect log.LogLevel.Error.to_string() == "error"

    it "Warn converts to string":
        expect log.LogLevel.Warn.to_string() == "warn"

    it "Info converts to string":
        expect log.LogLevel.Info.to_string() == "info"

    it "Debug converts to string":
        expect log.LogLevel.Debug.to_string() == "debug"

    it "Trace converts to string":
        expect log.LogLevel.Trace.to_string() == "trace"

    it "Verbose converts to string":
        expect log.LogLevel.Verbose.to_string() == "verbose"

    it "All converts to string":
        expect log.LogLevel.All.to_string() == "all"

describe "level_name":
    it "returns off for Off":
        expect log.level_name(log.LogLevel.Off) == "off"

    it "returns fatal for Fatal":
        expect log.level_name(log.LogLevel.Fatal) == "fatal"

    it "returns error for Error":
        expect log.level_name(log.LogLevel.Error) == "error"

    it "returns warn for Warn":
        expect log.level_name(log.LogLevel.Warn) == "warn"

    it "returns info for Info":
        expect log.level_name(log.LogLevel.Info) == "info"

    it "returns debug for Debug":
        expect log.level_name(log.LogLevel.Debug) == "debug"

    it "returns trace for Trace":
        expect log.level_name(log.LogLevel.Trace) == "trace"

    it "returns verbose for Verbose":
        expect log.level_name(log.LogLevel.Verbose) == "verbose"

    it "returns all for All":
        expect log.level_name(log.LogLevel.All) == "all"

describe "parse_level":
    it "parses off":
        expect log.parse_level("off").to_string() == "off"

    it "parses fatal":
        expect log.parse_level("fatal").to_string() == "fatal"

    it "parses error":
        expect log.parse_level("error").to_string() == "error"

    it "parses warn":
        expect log.parse_level("warn").to_string() == "warn"

    it "parses info":
        expect log.parse_level("info").to_string() == "info"

    it "parses debug":
        expect log.parse_level("debug").to_string() == "debug"

    it "parses trace":
        expect log.parse_level("trace").to_string() == "trace"

    it "parses verbose":
        expect log.parse_level("verbose").to_string() == "verbose"

    it "parses all":
        expect log.parse_level("all").to_string() == "all"

    it "defaults to INFO for unknown":
        expect log.parse_level("unknown").to_string() == "info"

describe "Level Configuration":
    describe "set_level":
        it "sets global log level":
            log.set_level(log.LogLevel.Debug)
            expect log.get_global_level().to_string() == "debug"

            # Reset to default
            log.set_level(log.LogLevel.Info)

    describe "set_scope_level":
        it "sets level for specific scope":
            log.set_scope_level("parser", log.LogLevel.Trace)
            expect log.get_level("parser").to_string() == "trace"

            # Clean up
            log.clear_scopes()

    describe "get_level":
        it "returns scope level if set":
            log.set_scope_level("test", log.LogLevel.Warn)
            expect log.get_level("test").to_string() == "warn"
            log.clear_scopes()

        it "returns global level if scope not set":
            log.clear_scopes()
            log.set_level(log.LogLevel.Info)
            expect log.get_level("unset_scope").to_string() == "info"

describe "is_enabled":
    it "returns true when level is less than or equal to current":
        log.set_level(log.LogLevel.Info)
        expect log.is_enabled(log.LogLevel.Error, "test") == true
        expect log.is_enabled(log.LogLevel.Warn, "test") == true
        expect log.is_enabled(log.LogLevel.Info, "test") == true

    it "returns false when level is greater than current":
        log.set_level(log.LogLevel.Info)
        expect log.is_enabled(log.LogLevel.Debug, "test") == false
        expect log.is_enabled(log.LogLevel.Trace, "test") == false

    it "respects scope-specific levels":
        log.set_level(log.LogLevel.Warn)
        log.set_scope_level("verbose_scope", log.LogLevel.Verbose)

        expect log.is_enabled(log.LogLevel.Debug, "verbose_scope") == true
        expect log.is_enabled(log.LogLevel.Debug, "normal_scope") == false

        log.clear_scopes()

describe "Logging Functions":
    # These tests just verify the functions don't crash
    # Actual output verification would require capturing stderr

    it "fatal logs at level 1":
        log.set_level(log.LogLevel.All)
        log.fatal("test", "fatal message")

    it "error logs at level 2":
        log.set_level(log.LogLevel.All)
        log.error("test", "error message")

    it "warn logs at level 3":
        log.set_level(log.LogLevel.All)
        log.warn("test", "warning message")

    it "info logs at level 4":
        log.set_level(log.LogLevel.All)
        log.info("test", "info message")

    it "debug logs at level 5":
        log.set_level(log.LogLevel.All)
        log.debug("test", "debug message")

    it "trace logs at level 6":
        log.set_level(log.LogLevel.All)
        log.trace("test", "trace message")

    it "verbose logs at level 7":
        log.set_level(log.LogLevel.All)
        log.verbose("test", "verbose message")

describe "Convenience Functions":
    it "log_info uses default scope":
        log.set_level(log.LogLevel.All)
        log.log_info("test message")

    it "log_error uses default scope":
        log.set_level(log.LogLevel.All)
        log.log_error("error message")

    it "log_debug uses default scope":
        log.set_level(log.LogLevel.All)
        log.log_debug("debug message")

    it "log_verbose uses default scope":
        log.set_level(log.LogLevel.All)
        log.log_verbose("verbose message")
