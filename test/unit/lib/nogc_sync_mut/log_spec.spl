# Log Module Tests
#
# Tests for simple/std_lib/src/log.spl
# Uses FFI to log_ffi.rs in simple-runtime

import std_lib.src.log as log

describe "Log Levels":
    it "has correct level constants":
        expect log.LOG_OFF == 0
        expect log.LOG_FATAL == 1
        expect log.LOG_ERROR == 2
        expect log.LOG_WARN == 3
        expect log.LOG_INFO == 4
        expect log.LOG_DEBUG == 5
        expect log.LOG_TRACE == 6
        expect log.LOG_VERBOSE == 7
        expect log.LOG_ALL == 10

describe "level_name":
    it "returns off for 0":
        expect log.level_name(0) == "off"

    it "returns fatal for 1":
        expect log.level_name(1) == "fatal"

    it "returns error for 2":
        expect log.level_name(2) == "error"

    it "returns warn for 3":
        expect log.level_name(3) == "warn"

    it "returns info for 4":
        expect log.level_name(4) == "info"

    it "returns debug for 5":
        expect log.level_name(5) == "debug"

    it "returns trace for 6":
        expect log.level_name(6) == "trace"

    it "returns verbose for 7":
        expect log.level_name(7) == "verbose"

    it "returns all for 10":
        expect log.level_name(10) == "all"

    it "returns unknown for other values":
        expect log.level_name(8) == "unknown"
        expect log.level_name(99) == "unknown"

describe "parse_level":
    it "parses off":
        expect log.parse_level("off") == log.LOG_OFF

    it "parses fatal":
        expect log.parse_level("fatal") == log.LOG_FATAL

    it "parses error":
        expect log.parse_level("error") == log.LOG_ERROR

    it "parses warn":
        expect log.parse_level("warn") == log.LOG_WARN

    it "parses info":
        expect log.parse_level("info") == log.LOG_INFO

    it "parses debug":
        expect log.parse_level("debug") == log.LOG_DEBUG

    it "parses trace":
        expect log.parse_level("trace") == log.LOG_TRACE

    it "parses verbose":
        expect log.parse_level("verbose") == log.LOG_VERBOSE

    it "parses all":
        expect log.parse_level("all") == log.LOG_ALL

    it "defaults to INFO for unknown":
        expect log.parse_level("unknown") == log.LOG_INFO

describe "Level Configuration":
    describe "set_level":
        it "sets global log level":
            log.set_level(log.LOG_DEBUG)
            expect log.get_global_level() == log.LOG_DEBUG

            # Reset to default
            log.set_level(log.LOG_INFO)

    describe "set_scope_level":
        it "sets level for specific scope":
            log.set_scope_level("parser", log.LOG_TRACE)
            expect log.get_level("parser") == log.LOG_TRACE

            # Clean up
            log.clear_scopes()

    describe "get_level":
        it "returns scope level if set":
            log.set_scope_level("test", log.LOG_WARN)
            expect log.get_level("test") == log.LOG_WARN
            log.clear_scopes()

        it "returns global level if scope not set":
            log.clear_scopes()
            log.set_level(log.LOG_INFO)
            expect log.get_level("unset_scope") == log.LOG_INFO

describe "is_enabled":
    it "returns true when level is less than or equal to current":
        log.set_level(log.LOG_INFO)
        expect log.is_enabled(log.LOG_ERROR, "test") == true
        expect log.is_enabled(log.LOG_WARN, "test") == true
        expect log.is_enabled(log.LOG_INFO, "test") == true

    it "returns false when level is greater than current":
        log.set_level(log.LOG_INFO)
        expect log.is_enabled(log.LOG_DEBUG, "test") == false
        expect log.is_enabled(log.LOG_TRACE, "test") == false

    it "respects scope-specific levels":
        log.set_level(log.LOG_WARN)
        log.set_scope_level("verbose_scope", log.LOG_VERBOSE)

        expect log.is_enabled(log.LOG_DEBUG, "verbose_scope") == true
        expect log.is_enabled(log.LOG_DEBUG, "normal_scope") == false

        log.clear_scopes()

describe "Logging Functions":
    # These tests just verify the functions don't crash
    # Actual output verification would require capturing stderr

    it "fatal logs at level 1":
        log.set_level(log.LOG_ALL)
        log.fatal("test", "fatal message")

    it "error logs at level 2":
        log.set_level(log.LOG_ALL)
        log.error("test", "error message")

    it "warn logs at level 3":
        log.set_level(log.LOG_ALL)
        log.warn("test", "warning message")

    it "info logs at level 4":
        log.set_level(log.LOG_ALL)
        log.info("test", "info message")

    it "debug logs at level 5":
        log.set_level(log.LOG_ALL)
        log.debug("test", "debug message")

    it "trace logs at level 6":
        log.set_level(log.LOG_ALL)
        log.trace("test", "trace message")

    it "verbose logs at level 7":
        log.set_level(log.LOG_ALL)
        log.verbose("test", "verbose message")

describe "Convenience Functions":
    it "log_info uses default scope":
        log.set_level(log.LOG_ALL)
        log.log_info("test message")

    it "log_error uses default scope":
        log.set_level(log.LOG_ALL)
        log.log_error("error message")

    it "log_debug uses default scope":
        log.set_level(log.LOG_ALL)
        log.log_debug("debug message")

    it "log_verbose uses default scope":
        log.set_level(log.LOG_ALL)
        log.log_verbose("verbose message")
