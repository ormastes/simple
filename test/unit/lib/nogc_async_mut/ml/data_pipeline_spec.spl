# Tests for async data pipeline utilities

use std.nogc_async_mut.ml.data_pipeline.{prefetch_batches, shuffle_indices}
use std.pure.data.dataset.{ArrayDataset}

describe "Data Pipeline":
    describe "prefetch_batches":
        it "prefetches correct number of batches":
            val data = [[1.0], [2.0], [3.0], [4.0]]
            val ds = ArrayDataset(data: data)
            val batches = prefetch_batches(ds, 2, 2)
            expect(batches.len()).to_equal(2)

        it "handles fewer data than requested batches":
            val data = [[1.0], [2.0]]
            val ds = ArrayDataset(data: data)
            val batches = prefetch_batches(ds, 2, 5)
            expect(batches.len()).to_equal(1)

        it "returns empty for empty dataset":
            val data: [[f64]] = []
            val ds = ArrayDataset(data: data)
            val batches = prefetch_batches(ds, 2, 3)
            expect(batches.len()).to_equal(0)

    describe "shuffle_indices":
        it "returns correct number of indices":
            val indices = shuffle_indices(10, 42)
            expect(indices.len()).to_equal(10)

        it "contains all indices":
            val indices = shuffle_indices(5, 42)
            # Sort and verify all present
            var found = [false, false, false, false, false]
            var i = 0
            while i < 5:
                val idx = indices[i]
                found[idx] = true
                i = i + 1
            expect(found[0]).to_equal(true)
            expect(found[1]).to_equal(true)
            expect(found[2]).to_equal(true)
            expect(found[3]).to_equal(true)
            expect(found[4]).to_equal(true)

        it "is deterministic with same seed":
            val a = shuffle_indices(10, 123)
            val b = shuffle_indices(10, 123)
            var same = true
            var i = 0
            while i < 10:
                if a[i] != b[i]:
                    same = false
                i = i + 1
            expect(same).to_equal(true)

        it "returns single element for length 1":
            val indices = shuffle_indices(1, 42)
            expect(indices.len()).to_equal(1)
            expect(indices[0]).to_equal(0)
