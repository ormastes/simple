# ThreadSafeQueue Tests
#
# Tests for thread-safe queue implementation.

use std.async_host.thread_safe_queue.{ThreadSafeQueue}

describe "ThreadSafeQueue creation":
    it "creates new queue":
        var queue = ThreadSafeQueue.new()
        expect(queue.is_empty()).to_equal(true)
        queue.destroy()

    it "new queue has zero length":
        var queue = ThreadSafeQueue.new()
        expect(queue.len()).to_equal(0)
        queue.destroy()

describe "ThreadSafeQueue push":
    it "pushes single item":
        var queue = ThreadSafeQueue.new()
        queue.push(42)
        expect(queue.len()).to_equal(1)
        queue.destroy()

    it "pushes multiple items":
        var queue = ThreadSafeQueue.new()
        queue.push(1)
        queue.push(2)
        queue.push(3)
        expect(queue.len()).to_equal(3)
        queue.destroy()

    it "push increases length":
        var queue = ThreadSafeQueue.new()
        val before = queue.len()
        queue.push(99)
        val after = queue.len()
        expect(after).to_equal(before + 1)
        queue.destroy()

describe "ThreadSafeQueue try_pop":
    it "try_pop on empty queue returns 0":
        var queue = ThreadSafeQueue.new()
        val result = queue.try_pop()
        expect(result).to_equal(0)
        queue.destroy()

    it "try_pop retrieves pushed item":
        var queue = ThreadSafeQueue.new()
        queue.push(42)
        val result = queue.try_pop()
        expect(result).to_equal(42)
        queue.destroy()

    it "try_pop FIFO order":
        var queue = ThreadSafeQueue.new()
        queue.push(1)
        queue.push(2)
        queue.push(3)
        expect(queue.try_pop()).to_equal(1)
        expect(queue.try_pop()).to_equal(2)
        expect(queue.try_pop()).to_equal(3)
        queue.destroy()

    it "try_pop decreases length":
        var queue = ThreadSafeQueue.new()
        queue.push(1)
        queue.push(2)
        val before = queue.len()
        queue.try_pop()
        val after = queue.len()
        expect(after).to_equal(before - 1)
        queue.destroy()

    it "try_pop until empty":
        var queue = ThreadSafeQueue.new()
        queue.push(10)
        queue.push(20)
        queue.try_pop()
        queue.try_pop()
        expect(queue.is_empty()).to_equal(true)
        queue.destroy()

describe "ThreadSafeQueue pop_blocking":
    it "pop_blocking on non-empty queue returns item":
        var queue = ThreadSafeQueue.new()
        queue.push(123)
        val result = queue.pop_blocking(100)
        expect(result).to_equal(123)
        queue.destroy()

    it "pop_blocking timeout on empty queue returns 0":
        var queue = ThreadSafeQueue.new()
        val result = queue.pop_blocking(10)
        expect(result).to_equal(0)
        queue.destroy()

    it "pop_blocking FIFO order":
        var queue = ThreadSafeQueue.new()
        queue.push(5)
        queue.push(6)
        expect(queue.pop_blocking(100)).to_equal(5)
        expect(queue.pop_blocking(100)).to_equal(6)
        queue.destroy()

describe "ThreadSafeQueue is_empty":
    it "empty queue is_empty true":
        var queue = ThreadSafeQueue.new()
        expect(queue.is_empty()).to_equal(true)
        queue.destroy()

    it "non-empty queue is_empty false":
        var queue = ThreadSafeQueue.new()
        queue.push(1)
        expect(queue.is_empty()).to_equal(false)
        queue.destroy()

    it "is_empty after push/pop":
        var queue = ThreadSafeQueue.new()
        queue.push(1)
        queue.try_pop()
        expect(queue.is_empty()).to_equal(true)
        queue.destroy()

describe "ThreadSafeQueue len":
    it "empty queue len is 0":
        var queue = ThreadSafeQueue.new()
        expect(queue.len()).to_equal(0)
        queue.destroy()

    it "len reflects push count":
        var queue = ThreadSafeQueue.new()
        queue.push(1)
        queue.push(2)
        queue.push(3)
        expect(queue.len()).to_equal(3)
        queue.destroy()

    it "len reflects pop count":
        var queue = ThreadSafeQueue.new()
        queue.push(1)
        queue.push(2)
        queue.push(3)
        queue.try_pop()
        expect(queue.len()).to_equal(2)
        queue.destroy()

describe "ThreadSafeQueue clear":
    it "clear empties queue":
        var queue = ThreadSafeQueue.new()
        queue.push(1)
        queue.push(2)
        queue.push(3)
        queue.clear()
        expect(queue.is_empty()).to_equal(true)
        queue.destroy()

    it "clear sets len to 0":
        var queue = ThreadSafeQueue.new()
        queue.push(1)
        queue.push(2)
        queue.clear()
        expect(queue.len()).to_equal(0)
        queue.destroy()

    it "can push after clear":
        var queue = ThreadSafeQueue.new()
        queue.push(1)
        queue.clear()
        queue.push(2)
        expect(queue.len()).to_equal(1)
        expect(queue.try_pop()).to_equal(2)
        queue.destroy()

describe "ThreadSafeQueue stress test":
    it "handles 100 push/pop cycles":
        var queue = ThreadSafeQueue.new()
        var count = 0
        for i in 0..100:
            queue.push(i)
            val item = queue.try_pop()
            if item != 0:
                count = count + 1
        expect(count).to_equal(100)
        queue.destroy()

    it "handles 1000 items":
        var queue = ThreadSafeQueue.new()
        for i in 1..1001:
            queue.push(i)
        expect(queue.len()).to_equal(1000)
        queue.destroy()

    it "FIFO order preserved over 100 items":
        var queue = ThreadSafeQueue.new()
        for i in 1..101:
            queue.push(i)

        var all_correct = true
        for i in 1..101:
            val item = queue.try_pop()
            if item != i:
                all_correct = false

        expect(all_correct).to_equal(true)
        queue.destroy()

describe "ThreadSafeQueue edge cases":
    it "multiple pops on empty queue":
        var queue = ThreadSafeQueue.new()
        expect(queue.try_pop()).to_equal(0)
        expect(queue.try_pop()).to_equal(0)
        expect(queue.try_pop()).to_equal(0)
        queue.destroy()

    it "push same value multiple times":
        var queue = ThreadSafeQueue.new()
        queue.push(5)
        queue.push(5)
        queue.push(5)
        expect(queue.len()).to_equal(3)
        expect(queue.try_pop()).to_equal(5)
        expect(queue.try_pop()).to_equal(5)
        expect(queue.try_pop()).to_equal(5)
        queue.destroy()

    it "clear on empty queue":
        var queue = ThreadSafeQueue.new()
        queue.clear()
        expect(queue.is_empty()).to_equal(true)
        queue.destroy()

    it "destroy on non-empty queue":
        var queue = ThreadSafeQueue.new()
        queue.push(1)
        queue.push(2)
        queue.destroy()
        expect(true).to_equal(true)

    it "large item values":
        var queue = ThreadSafeQueue.new()
        queue.push(999999)
        expect(queue.try_pop()).to_equal(999999)
        queue.destroy()
