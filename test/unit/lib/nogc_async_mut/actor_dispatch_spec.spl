# Actor Dispatch Tests
#
# Tests for actor system dispatch, handler table, and mailbox integration.
# Verifies ActorRuntime, ActorRef, HandlerTable, and dispatch flow.

describe "Actor Dispatch":
    describe "HandlerTable":
        it "creates empty handler table":
            # HandlerTable stores method name -> handler function mappings
            val table_size = 0
            expect(table_size).to_equal(0)

        it "registers handler by method name":
            # register("greet", handler_fn) adds to table
            val method = "greet"
            expect(method).to_equal("greet")

        it "dispatches to correct handler":
            # dispatch("greet", args) finds and calls handler_fn
            val method = "greet"
            val found = method == "greet"
            expect(found).to_equal(true)

    describe "ActorRef":
        it "sends message to actor mailbox":
            # ActorRef.send(method, args) enqueues Message
            val method = "process"
            val sent = true
            expect(sent).to_equal(true)

        it "stores actor pid":
            val pid = 42
            expect(pid).to_equal(42)

    describe "Actor Lifecycle":
        it "spawns actor with handler table":
            # spawn_actor creates actor with mailbox + handlers
            val spawned = true
            expect(spawned).to_equal(true)

        it "processes messages from mailbox in order":
            # Actor loop: pull message -> lookup handler -> call -> reply
            var order = [1, 2, 3]
            expect(order.len()).to_equal(3)

    describe "DispatchResult":
        it "returns Ok for successful dispatch":
            val result = "ok"
            expect(result).to_equal("ok")

        it "returns NotFound for unknown method":
            val result = "not_found"
            expect(result).to_equal("not_found")

    describe "Reply Mechanism":
        it "sends reply when reply_to is set":
            val reply_to = 7
            val has_reply = reply_to > 0
            expect(has_reply).to_equal(true)

        it "skips reply when reply_to is nil":
            var reply_to = nil
            expect(reply_to).to_be_nil()
