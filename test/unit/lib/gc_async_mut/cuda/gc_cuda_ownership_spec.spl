# GC CUDA Ownership Pattern Spec
# Documents the owns_handle conditional drop pattern in gc_async_mut/cuda/

# Mock FFI â€” tracks resource frees
var stream_freed = 0
var event_freed = 0
var mem_freed = 0

fn mock_stream_free(h: i64):
    stream_freed = stream_freed + 1

fn mock_event_free(h: i64):
    event_freed = event_freed + 1

fn mock_mem_free(h: i64):
    mem_freed = mem_freed + 1

# Simulated GC-style wrapper with owns_handle
struct MockCudaStream:
    handle: i64
    owns_handle: bool

    static fn owned(h: i64) -> MockCudaStream:
        MockCudaStream(handle: h, owns_handle: true)

    static fn borrowed(h: i64) -> MockCudaStream:
        MockCudaStream(handle: h, owns_handle: false)

    fn drop():
        if self.owns_handle:
            mock_stream_free(self.handle)

struct MockCudaEvent:
    handle: i64
    owns_handle: bool

    static fn owned(h: i64) -> MockCudaEvent:
        MockCudaEvent(handle: h, owns_handle: true)

    fn drop():
        if self.owns_handle:
            mock_event_free(self.handle)

struct MockCudaMem:
    handle: i64
    owns_handle: bool

    static fn owned(h: i64) -> MockCudaMem:
        MockCudaMem(handle: h, owns_handle: true)

    fn drop():
        if self.owns_handle:
            mock_mem_free(self.handle)

describe "GC CUDA Ownership":
    describe "CudaStreamWrapper":
        it "owned stream frees on drop":
            val s = MockCudaStream__owned(42)
            s.drop()
            expect(stream_freed).to_be_greater_than(0)

        it "borrowed stream does not free":
            val prev = stream_freed
            val s = MockCudaStream__borrowed(42)
            s.drop()
            expect(stream_freed).to_equal(prev)

    describe "CudaEventWrapper":
        it "owned event frees on drop":
            val e = MockCudaEvent__owned(99)
            e.drop()
            expect(event_freed).to_be_greater_than(0)

    describe "CudaDeviceMemWrapper":
        it "owned memory frees on drop":
            val m = MockCudaMem__owned(100)
            m.drop()
            expect(mem_freed).to_be_greater_than(0)

    describe "Ownership transfer":
        it "only owner frees shared handle":
            val prev_stream = stream_freed
            val owner = MockCudaStream__owned(77)
            val borrower = MockCudaStream__borrowed(77)
            borrower.drop()
            expect(stream_freed).to_equal(prev_stream)
            owner.drop()
            expect(stream_freed).to_equal(prev_stream + 1)
