# GC Stream Ownership Pattern Spec
# Documents the 3-field Stream pattern in gc_async_mut/torch/torch_training.spl

class MockStream:
    handle: i64
    owns_handle: bool
    device_id: i64

    fn device() -> i64:
        self.device_id

    fn should_free() -> bool:
        self.owns_handle

fn create_stream(h: i64, device: i64) -> MockStream:
    MockStream(handle: h, owns_handle: true, device_id: device)

describe "GC Stream Ownership":
    describe "3-field Stream pattern":
        it "stream has handle, owns_handle, and device_id":
            val s = create_stream(1, 0)
            expect(s.handle).to_equal(1)
            expect(s.owns_handle).to_equal(true)
            expect(s.device_id).to_equal(0)

        it "owned stream frees on drop":
            val s = create_stream(2, 0)
            # Verify the stream would free (owns_handle is true)
            expect(s.should_free()).to_equal(true)

        it "borrowed stream does not free":
            val s = MockStream(handle: 3, owns_handle: false, device_id: 0)
            # Verify the stream would NOT free (owns_handle is false)
            expect(s.should_free()).to_equal(false)

        it "device id preserved across ownership":
            val s = create_stream(4, 1)
            expect(s.device()).to_equal(1)
