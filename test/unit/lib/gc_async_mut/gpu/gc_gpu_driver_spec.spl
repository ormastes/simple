# GC GPU Driver Pattern Spec
# Documents that gc_async_mut/gpu.spl uses explicit lifecycle, NOT owns_handle

class MockGpuPtr:
    device_ptr: i64
    size: i64
    is_valid: bool

    static fn null() -> MockGpuPtr:
        MockGpuPtr(device_ptr: 0, size: 0, is_valid: false)

    fn is_null() -> bool:
        self.device_ptr == 0 or not self.is_valid

fn mock_gpu_alloc(size: i64) -> MockGpuPtr:
    MockGpuPtr(device_ptr: 1, size: size, is_valid: true)

fn mock_gpu_free_returns(ptr: MockGpuPtr) -> bool:
    # Returns true for non-null, false for null (simulating whether free happened)
    if ptr.is_null():
        return false
    true

describe "GPU Driver Explicit Lifecycle":
    describe "No owns_handle":
        it "GpuPtr has no owns_handle field":
            val ptr = MockGpuPtr(device_ptr: 1, size: 1024, is_valid: true)
            # Only 3 fields: device_ptr, size, is_valid
            # No owns_handle -- explicit lifecycle
            expect(ptr.device_ptr).to_equal(1)
            expect(ptr.size).to_equal(1024)
            expect(ptr.is_valid).to_equal(true)

        it "null pointer is invalid":
            val ptr = MockGpuPtr(device_ptr: 0, size: 0, is_valid: false)
            expect(ptr.is_null()).to_equal(true)

    describe "Explicit alloc/free":
        it "alloc creates valid pointer":
            val ptr = mock_gpu_alloc(2048)
            expect(ptr.is_valid).to_equal(true)
            expect(ptr.size).to_equal(2048)
            expect(ptr.is_null()).to_equal(false)

        it "free decrements resources":
            val ptr = mock_gpu_alloc(512)
            val freed = mock_gpu_free_returns(ptr)
            expect(freed).to_equal(true)

        it "free on null is safe":
            val null_ptr = MockGpuPtr(device_ptr: 0, size: 0, is_valid: false)
            val freed = mock_gpu_free_returns(null_ptr)
            expect(freed).to_equal(false)

    describe "Migration to NoGC":
        it "explicit lifecycle needs no owns_handle removal":
            # gc_async_mut/gpu.spl already uses explicit lifecycle
            # Migration = copy + replace cuda_ffi import with local extern fn
            val ptr = mock_gpu_alloc(1024)
            val freed = mock_gpu_free_returns(ptr)
            expect(freed).to_equal(true)
