# # DL Config Specification
#
# **Feature:** DL Config Device Helpers & Shorthand Functions
# **Category:** Stdlib
# **Status:** Complete
#
# Tests for device helper functions and shorthand configuration functions
# exported from std.src.dl.config.

use std.src.dl.config.{
    DLConfig, Device, DType, Backend, dl,
    cuda, cpu, default_gpu,
    use_gpu, use_cpu, use_f16, use_f32, use_f64, use_bf16,
    use_native, use_torch
}

# ============================================================================
# Test Group 1: Device Helper Functions
# ============================================================================

describe "DL Config - Device Helpers":
    # ## Device Constructor Helpers
    #
    # cuda(), cpu(), and default_gpu() create Device values.

    context "cuda":
        it "creates CUDA device with id 0":
            val dev = cuda(0)
            expect dev == Device.CUDA(0)

        it "creates CUDA device with id 1":
            val dev = cuda(1)
            expect dev == Device.CUDA(1)

        it "creates CUDA device with id 3":
            val dev = cuda(3)
            expect dev == Device.CUDA(3)

        it "returns a GPU device":
            val dev = cuda(0)
            expect dev.is_gpu() == true

        it "is not CPU":
            val dev = cuda(0)
            expect dev.is_cpu() == false

    context "cpu":
        it "creates CPU device":
            val dev = cpu()
            expect dev == Device.CPU

        it "returns a CPU device":
            val dev = cpu()
            expect dev.is_cpu() == true

        it "is not GPU":
            val dev = cpu()
            expect dev.is_gpu() == false

    context "default_gpu":
        it "creates CUDA(0) device":
            val dev = default_gpu()
            expect dev == Device.CUDA(0)

        it "returns a GPU device":
            val dev = default_gpu()
            expect dev.is_gpu() == true

        it "is not CPU":
            val dev = default_gpu()
            expect dev.is_cpu() == false

        it "has cuda_id 0":
            val dev = default_gpu()
            expect dev.cuda_id() == Some(0)

# ============================================================================
# Test Group 2: Shorthand Configuration Functions
# ============================================================================

describe "DL Config - Shorthand Functions":
    # ## Shorthand Functions
    #
    # use_gpu(), use_cpu(), use_f16(), etc. modify the global dl instance.

    context "device shorthands":
        it "use_gpu sets device to CUDA(0)":
            dl.default_device = Device.CPU
            use_gpu()
            expect dl.default_device == Device.CUDA(0)

        it "use_cpu sets device to CPU":
            dl.default_device = Device.CUDA(1)
            use_cpu()
            expect dl.default_device == Device.CPU

    context "dtype shorthands":
        it "use_f16 sets dtype to F16":
            dl.default_dtype = DType.F32
            use_f16()
            expect dl.default_dtype == DType.F16

        it "use_f32 sets dtype to F32":
            dl.default_dtype = DType.F64
            use_f32()
            expect dl.default_dtype == DType.F32

        it "use_f64 sets dtype to F64":
            dl.default_dtype = DType.F32
            use_f64()
            expect dl.default_dtype == DType.F64

        it "use_bf16 sets dtype to BF16":
            dl.default_dtype = DType.F32
            use_bf16()
            expect dl.default_dtype == DType.BF16

    context "backend shorthands":
        it "use_native sets backend to Native":
            dl.default_backend = Backend.PyTorch
            use_native()
            expect dl.default_backend == Backend.Native

        it "use_torch sets backend to PyTorch":
            dl.default_backend = Backend.Native
            use_torch()
            expect dl.default_backend == Backend.PyTorch
