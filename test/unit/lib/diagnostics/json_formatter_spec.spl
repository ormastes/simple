# SSpec Tests for JsonFormatter
#
# Tests structured JSON output for IDE/tool integration.

use std.diagnostics.{Diagnostic, Severity, Span, Label, JsonFormatter}
use std.text.{NL}

describe "JsonFormatter Creation":
    it "creates formatter with compact mode":
        val formatter = JsonFormatter.new()

        expect formatter.pretty == false

    it "creates formatter with pretty mode":
        val formatter = JsonFormatter.pretty()

        expect formatter.pretty == true

describe "JsonFormatter Basic Structure":
    it "produces valid JSON":
        val diag = Diagnostic.error("test")
        val formatter = JsonFormatter.new()

        val json = formatter.format(diag)

        expect json.starts_with("{")
        expect json.ends_with("}")

    it "includes severity field":
        val diag = Diagnostic.error("test")
        val formatter = JsonFormatter.new()

        val json = formatter.format(diag)

        expect json.contains("\"severity\"")
        expect json.contains("\"error\"")

    it "includes message field":
        val diag = Diagnostic.error("test message")
        val formatter = JsonFormatter.new()

        val json = formatter.format(diag)

        expect json.contains("\"message\"")
        expect json.contains("\"test message\"")

describe "JsonFormatter Optional Fields":
    it "includes code field when present":
        val diag = Diagnostic.error("test").with_code("E0001")
        val formatter = JsonFormatter.new()

        val json = formatter.format(diag)

        expect json.contains("\"code\"")
        expect json.contains("\"E0001\"")

    it "excludes code field when absent":
        val diag = Diagnostic.error("test")
        val formatter = JsonFormatter.new()

        val json = formatter.format(diag)

        # Code field should not be present
        expect not json.contains("\"code\"") or json.contains("null")

    it "includes span when present":
        val span = Span.new(10, 20, 5, 3)
        val diag = Diagnostic.error("test").with_span(span)
        val formatter = JsonFormatter.new()

        val json = formatter.format(diag)

        expect json.contains("\"span\"")
        expect json.contains("\"start\":10")
        expect json.contains("\"end\":20")
        expect json.contains("\"line\":5")
        expect json.contains("\"column\":3")

describe "JsonFormatter Labels":
    it "includes labels array":
        val span = Span.new(10, 20, 5, 3)
        val diag = Diagnostic.error("test")
            .with_label(span, "error here")

        val formatter = JsonFormatter.new()
        val json = formatter.format(diag)

        expect json.contains("\"labels\"")
        expect json.contains("\"error here\"")

    it "formats multiple labels":
        val span1 = Span.new(0, 5, 1, 1)
        val span2 = Span.new(10, 15, 2, 1)

        val diag = Diagnostic.error("test")
            .with_label(span1, "first error")
            .with_label(span2, "second error")

        val formatter = JsonFormatter.new()
        val json = formatter.format(diag)

        expect json.contains("\"first error\"")
        expect json.contains("\"second error\"")

describe "JsonFormatter Notes":
    it "includes notes array":
        val diag = Diagnostic.error("test")
            .with_note("note 1")
            .with_note("note 2")

        val formatter = JsonFormatter.new()
        val json = formatter.format(diag)

        expect json.contains("\"notes\"")
        expect json.contains("\"note 1\"")
        expect json.contains("\"note 2\"")

describe "JsonFormatter Help":
    it "includes help field":
        val diag = Diagnostic.error("test")
            .with_help("try this")

        val formatter = JsonFormatter.new()
        val json = formatter.format(diag)

        expect json.contains("\"help\"")
        expect json.contains("\"try this\"")

describe "JsonFormatter Pretty Printing":
    it "formats with indentation in pretty mode":
        val diag = Diagnostic.error("test")
        val formatter = JsonFormatter.pretty()

        val json = formatter.format(diag)

        # Pretty mode should have newlines and indentation
        expect json.contains(NL)
        expect json.contains("  ")

    it "formats compact in non-pretty mode":
        val diag = Diagnostic.error("test")
        val formatter = JsonFormatter.new()

        val json = formatter.format(diag)

        # Compact mode should have minimal whitespace
        expect not json.contains("{NL}  ")

describe "JsonFormatter String Escaping":
    it "escapes special characters in messages":
        val diag = Diagnostic.error("test with \"quotes\"")
        val formatter = JsonFormatter.new()

        val json = formatter.format(diag)

        # Quotes should be escaped
        expect json.contains("\\\"")

    it "escapes newlines in messages":
        val diag = Diagnostic.error("test{NL}with{NL}newlines")
        val formatter = JsonFormatter.new()

        val json = formatter.format(diag)

        # Newlines should be escaped
        expect json.contains("\{NL}")

describe "JsonFormatter Multiple Diagnostics":
    it "formats diagnostic array":
        val diags = [
            Diagnostic.error("error 1"),
            Diagnostic.warning("warning 1"),
            Diagnostic.note("note 1")
        ]

        val formatter = JsonFormatter.new()
        val json = formatter.format_multiple(diags)

        expect json.starts_with("[")
        expect json.ends_with("]")
        expect json.contains("error 1")
        expect json.contains("warning 1")
        expect json.contains("note 1")

    it "formats empty array":
        val diags: List<Diagnostic> = []

        val formatter = JsonFormatter.new()
        val json = formatter.format_multiple(diags)

        expect json == "[]"
