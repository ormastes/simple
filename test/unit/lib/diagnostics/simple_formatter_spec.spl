# SSpec Tests for SimpleFormatter
#
# Tests Simple language syntax output for specs and tests.

use std.diagnostics.{Diagnostic, Severity, Span, SimpleFormatter, escape_string}

describe "SimpleFormatter Creation":
    it "creates formatter with Simple syntax":
        val formatter = SimpleFormatter__new()

        expect formatter.simple_syntax == true

    it "creates formatter with plain text":
        val formatter = SimpleFormatter__plain()

        expect formatter.simple_syntax == false

describe "SimpleFormatter Simple Syntax":
    it "formats basic diagnostic":
        val diag = Diagnostic__error("test message")
        val formatter = SimpleFormatter__new()

        val output = formatter.format(diag)

        expect output.contains("Diagnostic(")
        expect output.contains("severity: Severity.Error")
        expect output.contains("message: \"test message\"")
        expect output.contains(")")

    it "includes severity variant":
        val diag = Diagnostic__warning("test")
        val formatter = SimpleFormatter__new()

        val output = formatter.format(diag)

        expect output.contains("Severity.Warning")

    it "includes code when present":
        val diag = Diagnostic__error("test").with_code("E0001")
        val formatter = SimpleFormatter__new()

        val output = formatter.format(diag)

        expect output.contains("code: \"E0001\"")

describe "SimpleFormatter Span Formatting":
    it "formats span with all fields":
        val span = Span__new(10, 20, 5, 3)
        val diag = Diagnostic__error("test").with_span(span)
        val formatter = SimpleFormatter__new()

        val output = formatter.format(diag)

        expect output.contains("span: Span(")
        expect output.contains("start: 10")
        expect output.contains("end: 20")
        expect output.contains("line: 5")
        expect output.contains("column: 3")

describe "SimpleFormatter Labels":
    it "formats labels array":
        val span = Span__new(10, 20, 5, 3)
        val diag = Diagnostic__error("test")
            .with_label(span, "error here")

        val formatter = SimpleFormatter__new()
        val output = formatter.format(diag)

        expect output.contains("labels: [")
        expect output.contains("Label(")
        expect output.contains("message: \"error here\"")
        expect output.contains("]")

    it "formats multiple labels":
        val span1 = Span__new(0, 5, 1, 1)
        val span2 = Span__new(10, 15, 2, 1)

        val diag = Diagnostic__error("test")
            .with_label(span1, "first")
            .with_label(span2, "second")

        val formatter = SimpleFormatter__new()
        val output = formatter.format(diag)

        expect output.contains("\"first\"")
        expect output.contains("\"second\"")

describe "SimpleFormatter Notes":
    it "formats notes array":
        val diag = Diagnostic__error("test")
            .with_note("note 1")
            .with_note("note 2")

        val formatter = SimpleFormatter__new()
        val output = formatter.format(diag)

        expect output.contains("notes: [")
        expect output.contains("\"note 1\"")
        expect output.contains("\"note 2\"")
        expect output.contains("]")

describe "SimpleFormatter Help":
    it "includes help field":
        val diag = Diagnostic__error("test")
            .with_help("try this")

        val formatter = SimpleFormatter__new()
        val output = formatter.format(diag)

        expect output.contains("help: \"try this\"")

describe "SimpleFormatter Plain Text":
    it "formats as plain text":
        val diag = Diagnostic__error("test message")
        val formatter = SimpleFormatter__plain()

        val output = formatter.format(diag)

        expect output.contains("error")
        expect output.contains("test message")
        expect not output.contains("Diagnostic(")

    it "includes span info in plain text":
        val span = Span__new(10, 20, 5, 3)
        val diag = Diagnostic__error("test").with_span(span)
        val formatter = SimpleFormatter__plain()

        val output = formatter.format(diag)

        expect output.contains("line 5")
        expect output.contains("column 3")

describe "String Escaping":
    it "escapes backslashes":
        val result = escape_string("test\\path")

        expect result == "test\\\\path"

    it "escapes double quotes":
        val result = escape_string("test\"quoted\"")

        expect result == "test\\\"quoted\\\""

    it "escapes newlines":
        val result = escape_string("test\nline")

        expect result == "test\\nline"

    it "escapes carriage returns":
        val result = escape_string("test\rline")

        expect result == "test\\rline"

    it "escapes tabs":
        val result = escape_string("test\tindent")

        expect result == "test\\tindent"

    it "handles multiple special characters":
        val result = escape_string("test\n\"quote\"\ttab\\path")

        expect result.contains("\\n")
        expect result.contains("\\\"")
        expect result.contains("\\t")
        expect result.contains("\\\\")

describe "SimpleFormatter Round Trip":
    it "produces parseable Simple syntax":
        val span = Span__new(10, 20, 5, 3)
        val diag = Diagnostic__error("test message")
            .with_code("E0001")
            .with_span(span)
            .with_label(span, "error here")
            .with_note("consider this")
            .with_help("try this")

        val formatter = SimpleFormatter__new()
        val output = formatter.format(diag)

        # Output should be valid Simple syntax (not testing parsing, just structure)
        expect output.starts_with("Diagnostic(")
        expect output.ends_with(")")
        expect output.contains("severity:")
        expect output.contains("message:")
