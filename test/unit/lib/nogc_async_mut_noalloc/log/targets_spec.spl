# Log Targets - Output Destination Tests

describe "Log Targets":

    describe "target constants":
        it "defines non-overlapping bitmask values":
            expect(TARGET_DEVICE).to_equal(1)
            expect(TARGET_SEMIHOST).to_equal(2)
            expect(TARGET_HOST_FILE).to_equal(4)
            # No overlap
            expect(TARGET_DEVICE & TARGET_SEMIHOST).to_equal(0)
            expect(TARGET_DEVICE & TARGET_HOST_FILE).to_equal(0)
            expect(TARGET_SEMIHOST & TARGET_HOST_FILE).to_equal(0)

    describe "device target":
        it "writes to device serial":
            target_device_write("test message")
            # In interpreter mode, this falls back to print

    describe "semihost target":
        it "writes text to semihost":
            target_semihost_write("test message")

        it "writes interned handle":
            target_semihost_write_h(42)

        it "writes handle with 1 param":
            target_semihost_write_h1(42, 100)

        it "writes handle with 2 params":
            target_semihost_write_h2(42, 100, 200)

    describe "file target":
        it "opens and closes log file":
            val opened = target_file_open("/tmp/test.log")
            expect(opened).to_equal(true)
            target_file_close()

        it "writes to file":
            target_file_open("/tmp/test.log")
            target_file_write("log line")
            target_file_close()

    describe "log format":
        it "formats message with level prefix":
            val msg = log_format(LOG_INFO, "hello")
            expect(msg).to_start_with("[INFO]")
            expect(msg).to_contain("hello")

        it "formats with handle":
            val msg = log_format_h(LOG_WARN, 42)
            expect(msg).to_start_with("[WARN]")

    describe "log buffer":
        it "buffers and flushes entries":
            expect(log_buffer_push(LOG_INFO, 10)).to_equal(true)
            expect(log_buffer_push(LOG_WARN, 20)).to_equal(true)
            expect(log_buffer_count()).to_be_greater_than(0)
            log_buffer_flush()
            expect(log_buffer_count()).to_equal(0)
