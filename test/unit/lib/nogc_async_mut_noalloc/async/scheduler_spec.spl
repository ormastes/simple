# NoallocScheduler - Cooperative Scheduler Tests

describe "NoallocScheduler":

    describe "construction":
        it "creates idle scheduler with no tasks":
            val sched = NoallocScheduler.new()
            expect(sched.is_idle()).to_equal(true)
            expect(sched.task_count()).to_equal(0)

    describe "spawn_task":
        it "spawns a task and returns task ID":
            val sched = NoallocScheduler.new()
            val id = sched.spawn_task(100, 0)
            expect(id).to_equal(0)
            expect(sched.task_count()).to_equal(1)
            expect(sched.is_idle()).to_equal(false)

        it "spawns multiple tasks":
            val sched = NoallocScheduler.new()
            val id0 = sched.spawn_task(100, 0)
            val id1 = sched.spawn_task(200, 1)
            val id2 = sched.spawn_task(300, 2)
            expect(id0).to_equal(0)
            expect(id1).to_equal(1)
            expect(id2).to_equal(2)
            expect(sched.task_count()).to_equal(3)

        it "returns -1 when all slots full":
            val sched = NoallocScheduler.new()
            var i = 0
            while i < MAX_TASKS:
                sched.spawn_task(i + 1, 0)
                i = i + 1
            val overflow = sched.spawn_task(999, 0)
            expect(overflow).to_equal(-1)

    describe "task completion":
        it "marks task as complete":
            val sched = NoallocScheduler.new()
            val id = sched.spawn_task(100, 0)
            sched.complete_task(id, 42)
            expect(sched.is_task_complete(id)).to_equal(true)
            expect(sched.task_result(id)).to_equal(42)

        it "returns 0 for incomplete task result":
            val sched = NoallocScheduler.new()
            val id = sched.spawn_task(100, 0)
            expect(sched.task_result(id)).to_equal(0)

    describe "cancel":
        it "cancels a task and frees slot":
            val sched = NoallocScheduler.new()
            val id = sched.spawn_task(100, 0)
            sched.cancel(id)
            expect(sched.task_count()).to_equal(0)
            expect(sched.is_idle()).to_equal(true)

        it "ignores cancel on invalid task ID":
            val sched = NoallocScheduler.new()
            sched.cancel(-1)
            sched.cancel(99)
            expect(sched.is_idle()).to_equal(true)

    describe "has_active_incomplete":
        it "returns true when tasks pending":
            val sched = NoallocScheduler.new()
            sched.spawn_task(100, 0)
            expect(sched.has_active_incomplete()).to_equal(true)

        it "returns false when all complete":
            val sched = NoallocScheduler.new()
            val id = sched.spawn_task(100, 0)
            sched.complete_task(id, 0)
            expect(sched.has_active_incomplete()).to_equal(false)

    describe "count_completed":
        it "counts completed tasks":
            val sched = NoallocScheduler.new()
            val id0 = sched.spawn_task(100, 0)
            val id1 = sched.spawn_task(200, 0)
            val id2 = sched.spawn_task(300, 0)
            sched.complete_task(id0, 10)
            sched.complete_task(id2, 30)
            expect(sched.count_completed()).to_equal(2)

    describe "cleanup_completed":
        it "frees completed task slots":
            val sched = NoallocScheduler.new()
            val id0 = sched.spawn_task(100, 0)
            val id1 = sched.spawn_task(200, 0)
            sched.complete_task(id0, 10)
            sched.complete_task(id1, 20)
            sched.cleanup_completed()
            expect(sched.task_count()).to_equal(0)
            expect(sched.is_idle()).to_equal(true)

    describe "slot reuse":
        it "reuses freed slots":
            val sched = NoallocScheduler.new()
            val id0 = sched.spawn_task(100, 0)
            sched.cancel(id0)
            val id1 = sched.spawn_task(200, 0)
            expect(id1).to_equal(0)

    describe "MAX_TASKS constant":
        it "equals 16":
            expect(MAX_TASKS).to_equal(16)
