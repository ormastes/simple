# Tests for Embedding backward pass (scatter-add gradient)

use std.pure.tensor_f64.{from_data}
use std.pure.autograd.{Tensor, tensor_from_value}
use std.pure.nn.embedding.{Embedding}

describe "Embedding Backward":
    it "creates embedding with correct dimensions":
        val emb = Embedding__create(num_embeddings: 5, embedding_dim: 3)
        expect(emb.num_embeddings).to_equal(5)
        expect(emb.embedding_dim).to_equal(3)
        expect(emb.last_indices.len()).to_equal(0)

    it "forward stores indices for backward":
        val emb = Embedding__create(num_embeddings: 5, embedding_dim: 3)
        val indices_data = from_data([0.0, 2.0, 4.0], [3])
        val indices = tensor_from_value(indices_data, requires_grad: false)
        val output = emb.forward(indices)
        expect(emb.last_indices.len()).to_equal(3)

    it "forward handles out-of-bounds with -1 sentinel":
        val emb = Embedding__create(num_embeddings: 3, embedding_dim: 2)
        val indices_data = from_data([-1.0, 1.0, 5.0], [3])
        val indices = tensor_from_value(indices_data, requires_grad: false)
        val output = emb.forward(indices)
        # Out-of-bounds indices stored as -1
        expect(emb.last_indices.len()).to_equal(3)

    it "backward produces weight gradient":
        val emb = Embedding__create(num_embeddings: 4, embedding_dim: 2)
        # Forward pass to store indices
        val indices_data = from_data([0.0, 2.0], [2])
        val indices = tensor_from_value(indices_data, requires_grad: false)
        val output = emb.forward(indices)

        # Create gradient matching output shape [2, 2]
        val grad_data = from_data([1.0, 1.0, 2.0, 2.0], [2, 2])
        val grad = tensor_from_value(grad_data, requires_grad: false)
        emb.backward(grad)

        # Weight should now have a gradient set
        expect(emb.weight.grad.?).to_equal(true)

    it "parameters returns weight tensor":
        val emb = Embedding__create(num_embeddings: 3, embedding_dim: 2)
        val params = emb.parameters()
        expect(params.len()).to_equal(1)
