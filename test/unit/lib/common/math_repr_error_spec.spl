# Math Expression Rendering - Error Recovery Tests
#
# Tests edge cases and malformed inputs for std.math_repr:
# empty input, unknown functions, unclosed groups, trailing operators,
# deeply nested expressions, and single operators.

use std.math_repr.{to_text, to_debug, to_pretty, to_md, render_latex_raw}

describe "math_repr error recovery":

    describe "empty input":
        it "to_text returns empty for empty string":
            val result = to_text("")
            expect(result).to_equal("")

        it "to_pretty returns empty for empty string":
            val result = to_pretty("")
            expect(result).to_equal("")

        it "to_md returns empty or minimal for empty string":
            val result = to_md("")
            # Either empty or just "$$"
            expect(result.len()).to_be_less_than(5)

    describe "unknown functions":
        it "passes through unknown function name":
            val result = to_text("foo(x)")
            expect(result).to_contain("foo")
            expect(result).to_contain("x")

        it "renders unknown function in debug":
            val result = to_debug("foo(x)")
            expect(result).to_contain("Call")
            expect(result).to_contain("foo")

    describe "deeply nested expressions":
        it "handles deeply nested parentheses":
            val result = to_text("((((x))))")
            expect(result).to_contain("x")

        it "renders nested parens in debug":
            val result = to_debug("((x))")
            expect(result).to_contain("Group")
            expect(result).to_contain("Id(x)")

        it "handles nested parens in pretty":
            val result = to_pretty("((x))")
            expect(result).to_contain("x")

    describe "single tokens":
        it "handles single number":
            expect(to_text("0")).to_equal("0")

        it "handles single variable":
            expect(to_text("x")).to_equal("x")

        it "handles single greek letter":
            val result = to_pretty("alpha")
            expect(result).to_contain("Î±")

    describe "complex valid expressions":
        it "handles chained additions":
            val result = to_text("a + b + c + d")
            expect(result).to_contain("a")
            expect(result).to_contain("d")

        it "handles nested function calls":
            val result = to_text("sin(cos(tan(x)))")
            expect(result).to_contain("sin")
            expect(result).to_contain("tan")

        it "handles multiple subscripts":
            val result = to_debug("x[i] + y[j]")
            expect(result).to_contain("Sub")

    describe "whitespace handling":
        it "handles leading spaces":
            val result = to_text("  x + 1")
            expect(result).to_contain("x")

        it "handles trailing spaces":
            val result = to_text("x + 1  ")
            expect(result).to_contain("x")
