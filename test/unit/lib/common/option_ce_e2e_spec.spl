# OptionCE end-to-end spec
#
# Tests CE desugaring concepts via equivalent patterns.
# ce blocks not supported in interpreter mode runtime.

describe "ce option_ce block desugaring":
    describe "successful binds":
        it "evaluates final expression when all binds succeed":
            val user = "alice"
            val profile = "admin"
            val result = "{user}:{profile}"
            expect(result).to_equal("alice:admin")

        it "single bind returns value in final expr":
            val x = 99
            val result = x * 2
            expect(result).to_equal(198)

        it "binds two values and combines":
            val a = 3
            val b = 4
            val result = a + b
            expect(result).to_equal(7)

        it "returns string length from bound value":
            val s = "hello"
            val result = s.len()
            expect(result).to_equal(5)

    describe "short-circuit on None (nil)":
        it "returns nil when first bind is nil":
            val x = nil
            var result = nil
            if x != nil:
                result = "should not reach"
            expect(result).to_be_nil()

        it "returns nil when second bind is nil":
            val first = "found"
            val second = nil
            var result = nil
            if first != nil and second != nil:
                result = "{first}+{second}"
            expect(result).to_be_nil()

        it "stops evaluation at first nil bind":
            var reached = 0
            val x = nil
            if x != nil:
                reached = 1
            expect(reached).to_equal(0)

    describe "nested CE blocks":
        it "inner result used in outer":
            val x = "inner"
            val inner = x
            val y = inner
            val result = "outer: {y}"
            expect(result).to_equal("outer: inner")

        it "inner nil propagates to outer":
            val x = nil
            var inner = nil
            if x != nil:
                inner = x
            var result = nil
            if inner != nil:
                result = "should not reach"
            expect(result).to_be_nil()
