# Color Utilities Module Extended Specification
#
# Comprehensive tests for std.color_utils module functions.
# Tests RGB/HSL conversions, color manipulation, schemes, WCAG accessibility,
# and utility functions.

use std.color_utils.{RGB, HSL}
use std.color_utils.{rgb_to_hsl, hsl_to_rgb}
use std.color_utils.{lighten, darken, saturate, desaturate}
use std.color_utils.{complementary_scheme, triadic_scheme}
use std.color_utils.{relative_luminance, contrast_ratio}
use std.color_utils.{meets_wcag_aa, meets_wcag_aaa}
use std.color_utils.{named_color, invert, grayscale}

# ============================================================================
# RGB Construction
# ============================================================================

describe "RGB construction":

    it "creates RGB with specified values":
        val c = RGB(r: 128, g: 64, b: 32)
        expect(c.r).to_equal(128)
        expect(c.g).to_equal(64)
        expect(c.b).to_equal(32)

    it "creates black RGB":
        val c = RGB(r: 0, g: 0, b: 0)
        expect(c.r).to_equal(0)
        expect(c.g).to_equal(0)
        expect(c.b).to_equal(0)

    it "creates white RGB":
        val c = RGB(r: 255, g: 255, b: 255)
        expect(c.r).to_equal(255)
        expect(c.g).to_equal(255)
        expect(c.b).to_equal(255)

# ============================================================================
# HSL Construction
# ============================================================================

describe "HSL construction":

    it "creates HSL with specified values":
        val c = HSL(h: 180.0, s: 50.0, l: 75.0)
        expect(c.h).to_equal(180.0)
        expect(c.s).to_equal(50.0)
        expect(c.l).to_equal(75.0)

# ============================================================================
# RGB to HSL Conversion
# ============================================================================

describe "rgb_to_hsl":

    it "converts pure red to HSL":
        val rgb = RGB(r: 255, g: 0, b: 0)
        val hsl = rgb_to_hsl(rgb)
        expect(hsl.h).to_equal(0.0)
        expect(hsl.l).to_equal(50.0)

    it "converts black to HSL with zero saturation":
        val rgb = RGB(r: 0, g: 0, b: 0)
        val hsl = rgb_to_hsl(rgb)
        expect(hsl.h).to_equal(0.0)
        expect(hsl.s).to_equal(0.0)
        expect(hsl.l).to_equal(0.0)

    it "converts white to HSL with zero saturation":
        val rgb = RGB(r: 255, g: 255, b: 255)
        val hsl = rgb_to_hsl(rgb)
        expect(hsl.h).to_equal(0.0)
        expect(hsl.s).to_equal(0.0)
        expect(hsl.l).to_equal(100.0)

    it "converts gray to HSL with zero saturation":
        val rgb = RGB(r: 128, g: 128, b: 128)
        val hsl = rgb_to_hsl(rgb)
        expect(hsl.s).to_equal(0.0)

    it "converts pure green to HSL with hue near 120":
        val rgb = RGB(r: 0, g: 255, b: 0)
        val hsl = rgb_to_hsl(rgb)
        expect(hsl.h).to_equal(120.0)

    it "converts pure blue to HSL with hue near 240":
        val rgb = RGB(r: 0, g: 0, b: 255)
        val hsl = rgb_to_hsl(rgb)
        expect(hsl.h).to_equal(240.0)

# ============================================================================
# HSL to RGB Conversion
# ============================================================================

describe "hsl_to_rgb":

    it "converts achromatic (gray) HSL":
        val hsl = HSL(h: 0.0, s: 0.0, l: 50.0)
        val rgb = hsl_to_rgb(hsl)
        expect(rgb.r).to_equal(127)
        expect(rgb.g).to_equal(127)
        expect(rgb.b).to_equal(127)

    it "converts black HSL to black RGB":
        val hsl = HSL(h: 0.0, s: 0.0, l: 0.0)
        val rgb = hsl_to_rgb(hsl)
        expect(rgb.r).to_equal(0)
        expect(rgb.g).to_equal(0)
        expect(rgb.b).to_equal(0)

    it "converts white HSL to white RGB":
        val hsl = HSL(h: 0.0, s: 0.0, l: 100.0)
        val rgb = hsl_to_rgb(hsl)
        expect(rgb.r).to_equal(255)
        expect(rgb.g).to_equal(255)
        expect(rgb.b).to_equal(255)

    it "converts pure red HSL to red RGB":
        val hsl = HSL(h: 0.0, s: 100.0, l: 50.0)
        val rgb = hsl_to_rgb(hsl)
        expect(rgb.r).to_equal(255)
        expect(rgb.g).to_equal(0)
        expect(rgb.b).to_equal(0)

# ============================================================================
# RGB -> HSL -> RGB Round-trip
# ============================================================================

describe "RGB to HSL round-trip":

    it "round-trips pure red":
        val original = RGB(r: 255, g: 0, b: 0)
        val hsl = rgb_to_hsl(original)
        val result = hsl_to_rgb(hsl)
        expect(result.r).to_equal(255)
        expect(result.g).to_equal(0)
        expect(result.b).to_equal(0)

    it "round-trips black":
        val original = RGB(r: 0, g: 0, b: 0)
        val hsl = rgb_to_hsl(original)
        val result = hsl_to_rgb(hsl)
        expect(result.r).to_equal(0)
        expect(result.g).to_equal(0)
        expect(result.b).to_equal(0)

    it "round-trips white":
        val original = RGB(r: 255, g: 255, b: 255)
        val hsl = rgb_to_hsl(original)
        val result = hsl_to_rgb(hsl)
        expect(result.r).to_equal(255)
        expect(result.g).to_equal(255)
        expect(result.b).to_equal(255)

# ============================================================================
# Lighten / Darken
# ============================================================================

describe "lighten":

    it "lightening black produces a non-black color":
        val black = RGB(r: 0, g: 0, b: 0)
        val result = lighten(black, 50.0)
        val sum = result.r + result.g + result.b
        expect(sum).to_be_greater_than(0)

    it "lightening by 0 returns approximately same color":
        val red = RGB(r: 255, g: 0, b: 0)
        val result = lighten(red, 0.0)
        expect(result.r).to_equal(255)
        expect(result.g).to_equal(0)
        expect(result.b).to_equal(0)

    it "lightening clamps at 100 lightness":
        val color = RGB(r: 200, g: 200, b: 200)
        val result = lighten(color, 200.0)
        expect(result.r).to_equal(255)
        expect(result.g).to_equal(255)
        expect(result.b).to_equal(255)

describe "darken":

    it "darkening white produces a non-white color":
        val white = RGB(r: 255, g: 255, b: 255)
        val result = darken(white, 50.0)
        val under_255 = result.r < 255
        expect(under_255).to_equal(true)

    it "darkening by 0 returns approximately same color":
        val red = RGB(r: 255, g: 0, b: 0)
        val result = darken(red, 0.0)
        expect(result.r).to_equal(255)
        expect(result.g).to_equal(0)
        expect(result.b).to_equal(0)

    it "darkening clamps at 0 lightness":
        val color = RGB(r: 50, g: 50, b: 50)
        val result = darken(color, 200.0)
        expect(result.r).to_equal(0)
        expect(result.g).to_equal(0)
        expect(result.b).to_equal(0)

# ============================================================================
# Saturate / Desaturate
# ============================================================================

describe "saturate":

    it "increasing saturation produces valid RGB":
        val color = RGB(r: 200, g: 100, b: 50)
        val result = saturate(color, 20.0)
        # Saturated color should still have valid RGB values
        val r_valid = result.r >= 0
        val g_valid = result.g >= 0
        val b_valid = result.b >= 0
        expect(r_valid).to_equal(true)
        expect(g_valid).to_equal(true)
        expect(b_valid).to_equal(true)

    it "saturation clamps at 100":
        val color = RGB(r: 200, g: 100, b: 50)
        val result = saturate(color, 500.0)
        val hsl = rgb_to_hsl(result)
        val s_clamped = hsl.s <= 100.0
        expect(s_clamped).to_equal(true)

describe "desaturate":

    it "fully desaturating a color produces gray":
        val color = RGB(r: 255, g: 0, b: 0)
        val result = desaturate(color, 200.0)
        # Full desaturation = grayscale, all channels equal
        expect(result.r).to_equal(result.g)
        expect(result.g).to_equal(result.b)

    it "desaturation clamps at 0":
        val color = RGB(r: 200, g: 100, b: 50)
        val result = desaturate(color, 500.0)
        val hsl = rgb_to_hsl(result)
        val s_zero = hsl.s <= 0.0
        expect(s_zero).to_equal(true)

# ============================================================================
# Color Schemes
# ============================================================================

describe "complementary_scheme":

    it "complement of red is cyan-ish":
        val red = RGB(r: 255, g: 0, b: 0)
        val comp = complementary_scheme(red)
        # Complementary of red (hue 0) is hue ~180 (cyan)
        # Allow floating-point tolerance
        val hsl = rgb_to_hsl(comp)
        val near_180 = hsl.h > 179.0
        val under_181 = hsl.h < 181.0
        expect(near_180).to_equal(true)
        expect(under_181).to_equal(true)

    it "complement of black is still black (achromatic)":
        val black = RGB(r: 0, g: 0, b: 0)
        val comp = complementary_scheme(black)
        expect(comp.r).to_equal(0)
        expect(comp.g).to_equal(0)
        expect(comp.b).to_equal(0)

describe "triadic_scheme":

    it "returns three colors":
        val red = RGB(r: 255, g: 0, b: 0)
        val result = triadic_scheme(red)
        # result is a tuple of 3 RGBs
        val c1 = result[0]
        val c2 = result[1]
        val c3 = result[2]
        # First color should be original
        expect(c1.r).to_equal(255)
        expect(c1.g).to_equal(0)
        expect(c1.b).to_equal(0)

# ============================================================================
# WCAG Accessibility
# ============================================================================

describe "relative_luminance":

    it "black has luminance near 0":
        val black = RGB(r: 0, g: 0, b: 0)
        val lum = relative_luminance(black)
        expect(lum).to_equal(0.0)

    it "white has luminance near 1":
        val white = RGB(r: 255, g: 255, b: 255)
        val lum = relative_luminance(white)
        val near_one = lum > 0.9
        expect(near_one).to_equal(true)

    it "red has lower luminance than white":
        val red = RGB(r: 255, g: 0, b: 0)
        val white = RGB(r: 255, g: 255, b: 255)
        val red_lum = relative_luminance(red)
        val white_lum = relative_luminance(white)
        val less = red_lum < white_lum
        expect(less).to_equal(true)

describe "contrast_ratio":

    it "black vs white has highest contrast":
        val black = RGB(r: 0, g: 0, b: 0)
        val white = RGB(r: 255, g: 255, b: 255)
        val ratio = contrast_ratio(black, white)
        val high = ratio > 20.0
        expect(high).to_equal(true)

    it "same color has contrast ratio of 1":
        val red = RGB(r: 255, g: 0, b: 0)
        val ratio = contrast_ratio(red, red)
        expect(ratio).to_equal(1.0)

    it "is symmetric":
        val c1 = RGB(r: 100, g: 50, b: 200)
        val c2 = RGB(r: 200, g: 200, b: 50)
        val r1 = contrast_ratio(c1, c2)
        val r2 = contrast_ratio(c2, c1)
        expect(r1).to_equal(r2)

describe "meets_wcag_aa":

    it "black and white meet AA":
        val black = RGB(r: 0, g: 0, b: 0)
        val white = RGB(r: 255, g: 255, b: 255)
        val result = meets_wcag_aa(black, white)
        expect(result).to_equal(true)

    it "similar colors may not meet AA":
        val c1 = RGB(r: 200, g: 200, b: 200)
        val c2 = RGB(r: 210, g: 210, b: 210)
        val result = meets_wcag_aa(c1, c2)
        expect(result).to_equal(false)

describe "meets_wcag_aaa":

    it "black and white meet AAA":
        val black = RGB(r: 0, g: 0, b: 0)
        val white = RGB(r: 255, g: 255, b: 255)
        val result = meets_wcag_aaa(black, white)
        expect(result).to_equal(true)

    it "similar colors do not meet AAA":
        val c1 = RGB(r: 200, g: 200, b: 200)
        val c2 = RGB(r: 210, g: 210, b: 210)
        val result = meets_wcag_aaa(c1, c2)
        expect(result).to_equal(false)

# ============================================================================
# Named Colors
# ============================================================================

describe "named_color":

    it "returns red color for 'red'":
        val c = named_color("red")
        expect(c.r).to_equal(255)
        expect(c.g).to_equal(0)
        expect(c.b).to_equal(0)

    it "returns green color for 'green'":
        val c = named_color("green")
        expect(c.r).to_equal(0)
        expect(c.g).to_equal(128)
        expect(c.b).to_equal(0)

    it "returns blue color for 'blue'":
        val c = named_color("blue")
        expect(c.r).to_equal(0)
        expect(c.g).to_equal(0)
        expect(c.b).to_equal(255)

    it "returns black for 'black'":
        val c = named_color("black")
        expect(c.r).to_equal(0)
        expect(c.g).to_equal(0)
        expect(c.b).to_equal(0)

    it "returns white for 'white'":
        val c = named_color("white")
        expect(c.r).to_equal(255)
        expect(c.g).to_equal(255)
        expect(c.b).to_equal(255)

    it "returns nil for unknown color":
        val c = named_color("purple")
        expect(c).to_be_nil()

# ============================================================================
# Invert
# ============================================================================

describe "invert":

    it "inverts black to white":
        val black = RGB(r: 0, g: 0, b: 0)
        val result = invert(black)
        expect(result.r).to_equal(255)
        expect(result.g).to_equal(255)
        expect(result.b).to_equal(255)

    it "inverts white to black":
        val white = RGB(r: 255, g: 255, b: 255)
        val result = invert(white)
        expect(result.r).to_equal(0)
        expect(result.g).to_equal(0)
        expect(result.b).to_equal(0)

    it "inverts a specific color":
        val color = RGB(r: 100, g: 150, b: 200)
        val result = invert(color)
        expect(result.r).to_equal(155)
        expect(result.g).to_equal(105)
        expect(result.b).to_equal(55)

    it "double inversion returns original":
        val original = RGB(r: 42, g: 128, b: 200)
        val double_inv = invert(invert(original))
        expect(double_inv.r).to_equal(42)
        expect(double_inv.g).to_equal(128)
        expect(double_inv.b).to_equal(200)

# ============================================================================
# Grayscale
# ============================================================================

describe "grayscale":

    it "converts pure red to gray":
        val red = RGB(r: 255, g: 0, b: 0)
        val result = grayscale(red)
        expect(result.r).to_equal(result.g)
        expect(result.g).to_equal(result.b)
        expect(result.r).to_equal(85)

    it "white remains white in grayscale":
        val white = RGB(r: 255, g: 255, b: 255)
        val result = grayscale(white)
        expect(result.r).to_equal(255)
        expect(result.g).to_equal(255)
        expect(result.b).to_equal(255)

    it "black remains black in grayscale":
        val black = RGB(r: 0, g: 0, b: 0)
        val result = grayscale(black)
        expect(result.r).to_equal(0)
        expect(result.g).to_equal(0)
        expect(result.b).to_equal(0)

    it "gray stays gray":
        val gray = RGB(r: 128, g: 128, b: 128)
        val result = grayscale(gray)
        expect(result.r).to_equal(128)
        expect(result.g).to_equal(128)
        expect(result.b).to_equal(128)
