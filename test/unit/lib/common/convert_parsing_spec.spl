# Tests for std.convert module
# Covers type conversion utilities: digit parsing, int parsing, bool/text conversion

use std.convert.{digit_value, safe_parse_int, parse_u16, parse_u32, parse_u64}
use std.convert.{i64_to_usize, usize_to_i64, to_bool, bool_to_text, i64_to_text, f64_to_text}

describe "std.convert":
    describe "digit_value":
        it "returns value for digit characters":
            expect(digit_value("0")).to_equal(0)
            expect(digit_value("1")).to_equal(1)
            expect(digit_value("5")).to_equal(5)
            expect(digit_value("9")).to_equal(9)

        it "returns -1 for non-digits":
            expect(digit_value("a")).to_equal(-1)
            expect(digit_value("Z")).to_equal(-1)
            expect(digit_value(" ")).to_equal(-1)

    describe "safe_parse_int":
        it "parses positive integers":
            expect(safe_parse_int("42")).to_equal(42)
            expect(safe_parse_int("0")).to_equal(0)
            expect(safe_parse_int("12345")).to_equal(12345)

        it "parses negative integers":
            expect(safe_parse_int("-1")).to_equal(-1)
            expect(safe_parse_int("-42")).to_equal(-42)

        it "returns 0 for invalid input":
            expect(safe_parse_int("")).to_equal(0)
            expect(safe_parse_int("abc")).to_equal(0)
            expect(safe_parse_int("-")).to_equal(0)

        it "trims whitespace":
            expect(safe_parse_int("  42  ")).to_equal(42)
            expect(safe_parse_int(" -7 ")).to_equal(-7)

    describe "parse_u16":
        it "parses valid u16 values":
            expect(parse_u16("0")).to_equal(0)
            expect(parse_u16("256")).to_equal(256)
            expect(parse_u16("65535")).to_equal(65535)

        it "returns 0 for out of range":
            expect(parse_u16("65536")).to_equal(0)
            expect(parse_u16("-1")).to_equal(0)

        it "returns 0 for invalid":
            expect(parse_u16("abc")).to_equal(0)

    describe "parse_u32":
        it "parses valid u32 values":
            expect(parse_u32("0")).to_equal(0)
            expect(parse_u32("100000")).to_equal(100000)

        it "returns 0 for negative":
            expect(parse_u32("-1")).to_equal(0)

    describe "parse_u64":
        it "parses valid u64 values":
            expect(parse_u64("0")).to_equal(0)
            expect(parse_u64("999999")).to_equal(999999)

        it "returns 0 for negative":
            expect(parse_u64("-1")).to_equal(0)

    describe "i64_to_usize":
        it "passes through non-negative values":
            expect(i64_to_usize(0)).to_equal(0)
            expect(i64_to_usize(42)).to_equal(42)
            expect(i64_to_usize(1000)).to_equal(1000)

        it "clamps negatives to 0":
            expect(i64_to_usize(-1)).to_equal(0)
            expect(i64_to_usize(-100)).to_equal(0)

    describe "usize_to_i64":
        it "is identity operation":
            expect(usize_to_i64(0)).to_equal(0)
            expect(usize_to_i64(42)).to_equal(42)
            expect(usize_to_i64(999)).to_equal(999)

    describe "to_bool":
        it "returns true for truthy strings":
            expect(to_bool("true")).to_equal(true)
            expect(to_bool("1")).to_equal(true)
            expect(to_bool("yes")).to_equal(true)
            expect(to_bool("on")).to_equal(true)

        it "is case insensitive":
            expect(to_bool("TRUE")).to_equal(true)
            expect(to_bool("True")).to_equal(true)
            expect(to_bool("YES")).to_equal(true)

        it "returns false for other strings":
            expect(to_bool("false")).to_equal(false)
            expect(to_bool("0")).to_equal(false)
            expect(to_bool("no")).to_equal(false)
            expect(to_bool("")).to_equal(false)

    describe "bool_to_text":
        it "converts booleans to text":
            expect(bool_to_text(true)).to_equal("true")
            expect(bool_to_text(false)).to_equal("false")

    describe "i64_to_text":
        it "converts integers to text":
            expect(i64_to_text(42)).to_equal("42")
            expect(i64_to_text(0)).to_equal("0")
            expect(i64_to_text(-7)).to_equal("-7")

    describe "f64_to_text":
        it "converts floats to text":
            val result = f64_to_text(3.14)
            expect(result).to_contain("3.14")
