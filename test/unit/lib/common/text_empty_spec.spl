"""
# Text Presence Functions Specification

**Feature IDs:** #2100-PRESENCE
**Category:** Stdlib
**Difficulty:** 1/5
**Status:** Implemented
**Research:** doc/research/text_validity_presence_pattern_2026-02-24.md

## Overview

Tests `presence` and `presence_trimmed` functions that convert text to `text?`,
returning the value if non-empty/non-blank, or `nil` otherwise.

## Note

Functions are defined locally because importing `lib.common.text` causes
timeout (~40s) due to heavy transitive dependencies. The canonical source
is `src/lib/common/text.spl`. These local copies mirror that implementation.
"""

# Local copies â€” canonical source: src/lib/common/text.spl
# Defined here to avoid heavy lib.common.text import timeout.
fn presence(s: text) -> text?:
    if s.len() > 0: s else: nil

fn _is_blank(s: text) -> bool:
    if s.len() == 0: return true
    for i in 0..s.len():
        val c = s[i:i + 1]
        if c != " " and c != "\t" and c != "\n" and c != "\r":
            return false
    true

fn presence_trimmed(s: text) -> text?:
    if not _is_blank(s): s else: nil

describe "presence":
    """
    ## Value-Returning Empty Check

    `presence(s)` returns `s` if non-empty, `nil` if empty.
    Enables pattern binding and nil coalescing for text values.
    """

    it "returns value for non-empty":
        """Returns the original string when it has content."""
        expect(presence("hello") ?? "").to_equal("hello")

    it "returns nil for empty":
        """Returns nil for empty string, enabling ?? fallback."""
        expect(presence("") ?? "default").to_equal("default")

    it "returns whitespace string":
        """Whitespace-only strings are non-empty (use presence_trimmed for blank check)."""
        expect(presence("  ") ?? "").to_equal("  ")

describe "presence_trimmed":
    """
    ## Value-Returning Blank Check

    `presence_trimmed(s)` returns `s` if non-blank (has non-whitespace content),
    `nil` if empty or whitespace-only.
    """

    it "returns value for non-blank":
        """Returns string when it has meaningful (non-whitespace) content."""
        expect(presence_trimmed("hello") ?? "").to_equal("hello")

    it "returns nil for empty":
        """Returns nil for empty string."""
        expect(presence_trimmed("") ?? "default").to_equal("default")

    it "returns nil for whitespace-only":
        """Returns nil for strings with only whitespace characters."""
        expect(presence_trimmed("  ") ?? "default").to_equal("default")
