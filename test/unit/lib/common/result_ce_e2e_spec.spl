# ResultCE end-to-end spec
#
# Tests CE desugaring concepts via equivalent patterns.
# ce blocks not supported in interpreter mode runtime.

describe "ce result_ce block desugaring":
    describe "successful binds":
        it "evaluates final expression when all binds succeed":
            val x = "hello"
            val y = "world"
            val result = "{x} {y}"
            expect(result).to_equal("hello world")

        it "single bind returns bound value in final expr":
            val n = 42
            val result = n + 1
            expect(result).to_equal(43)

        it "binds integer and uses in arithmetic":
            val a = 10
            val b = 20
            val result = a + b
            expect(result).to_equal(30)

        it "returns the final expression value":
            val x = "data"
            val result = x.len()
            expect(result).to_equal(4)

    describe "short-circuit on nil":
        it "returns nil when first bind is nil":
            val x = nil
            var result = nil
            if x != nil:
                result = "never reached"
            expect(result).to_be_nil()

        it "returns nil when second bind is nil":
            val x = "first"
            val y = nil
            var result = nil
            if x != nil and y != nil:
                result = "{x}{y}"
            expect(result).to_be_nil()

        it "does not execute final expr when bind is nil":
            var executed = 0
            val x = nil
            if x != nil:
                executed = 1
            expect(executed).to_equal(0)

    describe "mixed statements":
        it "evaluates non-bind statements normally":
            var side_effect = 0
            val x = "value"
            side_effect = 1
            val result = x
            expect(result).to_equal("value")
            expect(side_effect).to_equal(1)

        it "non-bind statement before bind runs normally":
            var counter = 0
            counter = counter + 1
            val x = "ok"
            val result = x
            expect(result).to_equal("ok")
            expect(counter).to_equal(1)
