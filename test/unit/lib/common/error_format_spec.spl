# Error Format Spec - Tests for error_format.spl
#
# Tests the error formatting utilities.

use std.error_core.{error_new, error_with_file, error_with_kind, error_with_cause}
use std.error_format.{format_error_message, format_error_compact, format_error_with_context}
use std.error_format.{format_source_location, format_location_line_only}
use std.error_format.{format_error_list, format_error_summary}
use std.error_format.{format_function_context, format_stage_context}

describe "Error Message Formatting":
    it "formats basic error":
        val error = error_new("Test error", 42, 10)
        val formatted = format_error_message(error)
        expect(formatted).to_contain("error[error]")
        expect(formatted).to_contain("42:10")
        expect(formatted).to_contain("Test error")

    it "formats error with file":
        val error = error_with_file("File error", 10, 5, "test.spl")
        val formatted = format_error_message(error)
        expect(formatted).to_contain("test.spl")
        expect(formatted).to_contain("10:5")

    it "formats error with kind":
        val error = error_with_kind("Parse error", 1, 1, "parse")
        val formatted = format_error_message(error)
        expect(formatted).to_contain("error[parse]")

    it "formats error with cause":
        val base = error_new("Operation failed", 0, 0)
        val with_cause = error_with_cause(base, "Permission denied")
        val formatted = format_error_message(with_cause)
        expect(formatted).to_contain("Caused by: Permission denied")

    it "formats compact error":
        val error = error_with_kind("Test", 0, 0, "type")
        val formatted = format_error_compact(error)
        expect(formatted).to_equal("type error: Test")

    it "formats error with context":
        val error = error_new("Test", 0, 0)
        val formatted = format_error_with_context(error, "additional context")
        expect(formatted).to_contain("additional context")

describe "Source Location Formatting":
    it "formats full location":
        val loc = format_source_location("main.spl", 42, 15)
        expect(loc).to_equal("main.spl:42:15")

    it "formats location without column":
        val loc = format_location_line_only("main.spl", 42)
        expect(loc).to_equal("main.spl:42")

    it "formats location without file":
        val loc = format_source_location("", 10, 5)
        expect(loc).to_equal(":10:5")

describe "Error List Formatting":
    it "formats empty error list":
        val errors = []
        val formatted = format_error_list(errors)
        expect(formatted).to_equal("No errors")

    it "formats single error":
        val errors = [error_new("Error 1", 10, 5)]
        val formatted = format_error_list(errors)
        expect(formatted).to_contain("1 error(s)")
        expect(formatted).to_contain("Error 1")

    it "formats multiple errors":
        val errors = [
            error_new("Error 1", 10, 5),
            error_new("Error 2", 20, 10)
        ]
        val formatted = format_error_list(errors)
        expect(formatted).to_contain("2 error(s)")
        expect(formatted).to_contain("Error 1")
        expect(formatted).to_contain("Error 2")

    it "formats error summary":
        val summary = format_error_summary(3, 5)
        expect(summary).to_equal("3 error(s), 5 warning(s)")

describe "Error Context Helpers":
    it "formats function context":
        val error = error_new("Division by zero", 0, 0)
        val formatted = format_function_context("calculate", error)
        expect(formatted).to_contain("calculate")
        expect(formatted).to_contain("Division by zero")

    it "formats stage context":
        val error = error_new("Syntax error", 0, 0)
        val formatted = format_stage_context("parsing", error)
        expect(formatted).to_contain("parsing")
        expect(formatted).to_contain("Syntax error")
