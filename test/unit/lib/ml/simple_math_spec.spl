# Simple Math Operations Test Suite
# Feature: ML Math Operations (clamp, select)
# Category: ML, Math
# Status: Complete
#
# Tests for ml.torch math operations including clamp, conditional
# select, and element-wise operations.

use ml.torch as torch
use ml.torch.simple_math as math
use ml.torch.ffi_helpers as helpers
use ml.torch.dtype.DType.*

# Local Device enum (runtime can't handle imported enum constructors with data)
enum Device:
    CPU
    CUDA(index: i64)

describe "Math Operations":
    # Tests for tensor math operations.
    context "clamp":
        it "clamps values to range":
            val device = Device.CUDA(1)
            val x = helpers.randn_1d(100, device=device)
            val clamped = math.clamp(x, -1.0, 1.0)
            expect clamped.shape() == [100]
            expect clamped.device().cuda_id() == Some(1)

    context "select":
        it "selects values conditionally":
            val device = Device.CUDA(1)
            val cond = helpers.randn_1d(10, device=device)
            val x = helpers.ones_1d(10, device=device)
            val y = helpers.zeros_1d(10, device=device)
            val selected = math.select_where(cond, x, y)
            expect selected.shape() == [10]
            expect selected.device().cuda_id() == Some(1)

    context "element-wise operations":
        it "applies element-wise min/max":
            val device = Device.CUDA(1)
            val x = helpers.randn_1d(20, device=device)
            val y = helpers.randn_1d(20, device=device)
            val selected = math.select_where(x, x, y)
            expect selected.shape() == [20]
            expect selected.device().cuda_id() == Some(1)
