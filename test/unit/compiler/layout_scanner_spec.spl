# Layout Scanner Tests
#
# Tests for scan_layout_annotations and get_layout_for_struct.
# Verifies @repr(C), @volatile, and multi-struct source parsing.

use compiler.layout_scanner.{scan_layout_annotations, get_layout_for_struct}
use std.unsafe.layout.{layout_info_has_repr, layout_info_field_is_volatile}

describe "LayoutScanner":
    describe "scan_layout_annotations":
        it "parses struct with no annotations":
            scan_layout_annotations("struct Plain:\n    value: i64\n")
            val info = get_layout_for_struct("Plain")
            expect(info != nil).to_equal(true)

        it "parses @repr(C) before struct":
            val src = "# @repr(C)\nstruct Mmio:\n    status: u32\n"
            scan_layout_annotations(src)
            val info = get_layout_for_struct("Mmio")
            expect(info != nil).to_equal(true)
            expect(layout_info_has_repr(info, "C")).to_equal(true)

        it "parses @volatile before field":
            val src = "struct Regs:\n    # @volatile\n    status: u32\n    addr: u64\n"
            scan_layout_annotations(src)
            val info = get_layout_for_struct("Regs")
            expect(info != nil).to_equal(true)
            expect(layout_info_field_is_volatile(info, "status")).to_equal(true)
            expect(layout_info_field_is_volatile(info, "addr")).to_equal(false)

        it "parses @repr(C, packed)":
            val src = "# @repr(C, packed)\nstruct Dma:\n    ctrl: u32\n"
            scan_layout_annotations(src)
            val info = get_layout_for_struct("Dma")
            expect(layout_info_has_repr(info, "packed")).to_equal(true)

        it "handles multiple structs in one source":
            val src = "struct A:\n    x: i64\n\n# @repr(C)\nstruct B:\n    y: u32\n"
            scan_layout_annotations(src)
            val info_a = get_layout_for_struct("A")
            val info_b = get_layout_for_struct("B")
            expect(info_a != nil).to_equal(true)
            expect(info_b != nil).to_equal(true)
            expect(layout_info_has_repr(info_b, "C")).to_equal(true)
            expect(layout_info_has_repr(info_a, "C")).to_equal(false)

        it "returns nil for unknown struct":
            scan_layout_annotations("struct Known:\n    x: i64\n")
            val info = get_layout_for_struct("NotExists")
            expect(info == nil).to_equal(true)

    describe "layout_info helpers":
        it "layout_info_has_repr returns false when not present":
            scan_layout_annotations("struct Empty:\n    x: i64\n")
            val info = get_layout_for_struct("Empty")
            expect(layout_info_has_repr(info, "C")).to_equal(false)
