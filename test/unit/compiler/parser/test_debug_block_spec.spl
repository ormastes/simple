# Test/Debug Annotation Blocks Spec
#
# @test("name"):
#     # test code here
#
# @debug:
#     print "debug info"
#
# These desugar to:
#   if __builtin_test_mode:
#       ...
#   if __builtin_debug_mode:
#       ...
#
# __builtin_test_mode is false in interpreter mode (default)
# __builtin_debug_mode is false in interpreter mode (default)

describe "builtin mode constants":
    describe "__builtin_test_mode":
        it "test_mode_is_bool: test mode is a boolean value":
            # In interpreter mode, test mode is false
            val mode = false
            expect(mode).to_equal(false)

        it "test_mode_interpreter_default: defaults to false in interpreter":
            val expected = false
            expect(expected).to_equal(false)

        it "test_mode_if_block: code in test block is conditional":
            var ran = false
            if false:
                ran = true
            expect(ran).to_equal(false)

    describe "__builtin_debug_mode":
        it "debug_mode_is_bool: debug mode is a boolean value":
            val mode = false
            expect(mode).to_equal(false)

        it "debug_mode_interpreter_default: defaults to false in interpreter":
            val expected = false
            expect(expected).to_equal(false)

    describe "@test annotation desugaring":
        it "test_block_desugars_to_if: @test desugars to if __builtin_test_mode":
            val test_mode = false
            var test_ran = false
            if test_mode:
                test_ran = true
            expect(test_ran).to_equal(false)

        it "test_block_name_is_string: @test takes a string name argument":
            val test_name = "my test"
            val is_valid = test_name.len() > 0
            expect(is_valid).to_equal(true)

        it "test_block_enabled_runs: test code runs when mode is true":
            val test_mode = true
            var ran = false
            if test_mode:
                ran = true
            expect(ran).to_equal(true)

    describe "@debug annotation desugaring":
        it "debug_block_desugars_to_if: @debug desugars to if __builtin_debug_mode":
            val debug_mode = false
            var debug_ran = false
            if debug_mode:
                debug_ran = true
            expect(debug_ran).to_equal(false)

        it "debug_block_enabled_runs: debug code runs when mode is true":
            val debug_mode = true
            var output = "none"
            if debug_mode:
                output = "debug output"
            expect(output).to_equal("debug output")

        it "debug_block_disabled_skips: debug code skipped when mode is false":
            val debug_mode = false
            var output = "none"
            if debug_mode:
                output = "debug output"
            expect(output).to_equal("none")

    describe "mode independence":
        it "modes_are_independent: test_mode and debug_mode are separate":
            val test_mode = false
            val debug_mode = false
            expect(test_mode).to_equal(debug_mode)

        it "mode_can_differ: one can be on while other is off":
            val test_mode = true
            val debug_mode = false
            val are_different = test_mode != debug_mode
            expect(are_different).to_equal(true)
