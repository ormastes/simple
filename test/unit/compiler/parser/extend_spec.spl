# Extension methods spec
#
# Tests for adding methods to existing types using name-mangled functions.
# The `extend TypeName:` keyword is planned; currently we use the
# name-mangling pattern directly (TypeName__method).

struct Point:
    x: i64
    y: i64

# Extension methods via name-mangled free functions
fn Point__magnitude(p: Point) -> i64:
    p.x * p.x + p.y * p.y

fn Point__translate(p: Point, dx: i64, dy: i64) -> Point:
    Point(x: p.x + dx, y: p.y + dy)

fn Point__zero() -> Point:
    Point(x: 0, y: 0)

fn Point__distance(a: Point, b: Point) -> i64:
    val dx = a.x - b.x
    val dy = a.y - b.y
    dx * dx + dy * dy

describe "extend type declarations":
    it "can call extended method (magnitude)":
        val p = Point(x: 3, y: 4)
        val mag = Point__magnitude(p)
        expect(mag).to_equal(25)

    it "can call extended method that returns struct":
        val p = Point(x: 1, y: 2)
        val p2 = Point__translate(p, 10, 20)
        expect(p2.x).to_equal(11)
        expect(p2.y).to_equal(22)

    it "can call extended static method":
        val origin = Point__zero()
        expect(origin.x).to_equal(0)
        expect(origin.y).to_equal(0)

    it "distance between two points":
        val a = Point(x: 0, y: 0)
        val b = Point(x: 3, y: 4)
        val dist = Point__distance(a, b)
        expect(dist).to_equal(25)
