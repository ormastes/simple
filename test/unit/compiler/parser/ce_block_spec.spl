# CE block syntax spec
#
# Tests for `ce NAME:` computation expression block syntax.
# Verifies parser support for DECL_CE / EXPR_DO_BLOCK (ce variant)
# and STMT_BIND (bind x = expr) inside ce blocks.

describe "ce block syntax - basic parsing":
    it "ce block with single bind parses and evaluates":
        val result = ce result_ce:
            bind x = 42
            x
        expect(result).to_equal(42)

    it "ce block returns last expression value":
        val result = ce option_ce:
            bind a = 10
            bind b = 20
            a + b
        expect(result).to_equal(30)

    it "ce block with text bind":
        val result = ce result_ce:
            bind name = "hello"
            name
        expect(result).to_equal("hello")

describe "ce block syntax - bind statement":
    it "bind x = expr makes x available in rest of block":
        val result = ce result_ce:
            bind first = 5
            bind second = first * 2
            second
        expect(result).to_equal(10)

    it "multiple bind statements chain":
        val result = ce result_ce:
            bind a = 1
            bind b = 2
            bind c = 3
            a + b + c
        expect(result).to_equal(6)

    it "bind name is accessible after bind statement":
        val result = ce result_ce:
            bind item = "world"
            "hello " + item
        expect(result).to_equal("hello world")

describe "ce block syntax - builder names":
    it "ce with result_ce builder name parses":
        val r = ce result_ce:
            bind x = 99
            x
        expect(r).to_equal(99)

    it "ce with option_ce builder name parses":
        val r = ce option_ce:
            bind x = 7
            x * 3
        expect(r).to_equal(21)

    it "ce with custom_ce builder name parses":
        val r = ce custom_ce:
            bind x = 100
            x
        expect(r).to_equal(100)

describe "ce block syntax - final expression":
    it "final expression is the return value when no bind":
        val result = ce result_ce:
            100
        expect(result).to_equal(100)

    it "final expression after binds is the return value":
        val result = ce result_ce:
            bind a = 5
            bind b = 10
            a * b
        expect(result).to_equal(50)

    it "final text expression after bind":
        val result = ce result_ce:
            bind prefix = "pre"
            bind suffix = "suf"
            prefix + "_" + suffix
        expect(result).to_equal("pre_suf")
