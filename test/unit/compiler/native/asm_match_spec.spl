# Asm Match Specification
#
# Tests for target-qualified inline assembly: asm match/assert syntax.
# Verifies parsing, target spec matching, and exhaustiveness checking.

fn check(condition: bool):
    expect(condition).to_equal(true)
fn check_msg(condition: bool, message: text):
    if not condition:
        expect(message).to_equal("")

describe "Asm Match Syntax":

    it "recognizes asm match keyword combination":
        val code = "asm match:"
        check(code.starts_with("asm"))
        check(code.contains("match"))
        check(code.ends_with(":"))

    it "recognizes case with target spec":
        val arm = "case [x86_64]:"
        check(arm.starts_with("case"))
        check(arm.contains("["))
        check(arm.contains("x86_64"))
        check(arm.contains("]"))

    it "recognizes case with pipe grouping":
        val arm = "case [x86_64 | x86]:"
        check(arm.contains("|"))
        check(arm.contains("x86_64"))
        check(arm.contains("x86"))

    it "recognizes case with os qualifier":
        val arm = "case [x86_64, linux]:"
        check(arm.contains(","))
        check(arm.contains("linux"))

    it "recognizes case with full qualifier":
        val arm = "case [x86_64, linux, gnu, llvm >= 15]:"
        check(arm.contains("x86_64"))
        check(arm.contains("linux"))
        check(arm.contains("gnu"))
        check(arm.contains("llvm"))
        check(arm.contains(">="))
        check(arm.contains("15"))

    it "recognizes wildcard case":
        val arm = "case _:"
        check(arm.contains("_"))

    it "recognizes compile_error in arm":
        val body = "compile_error(\"unsupported arch\")"
        check(body.starts_with("compile_error"))
        check(body.contains("unsupported arch"))

    it "recognizes asm assert syntax":
        val code = "asm assert [x86_64, linux]"
        check(code.starts_with("asm"))
        check(code.contains("assert"))
        check(code.contains("["))
        check(code.contains("x86_64"))

describe "Asm Match Complete Example":

    it "parses full asm match block syntax":
        # Verify the complete syntax structure is valid
        val example = "asm match:\n    case [x86_64]:\n        \"cli\"\n    case [aarch64]:\n        \"msr daifset, #0xf\"\n    case _:\n        compile_error(\"unsupported\")"
        check(example.contains("asm match:"))
        check(example.contains("case [x86_64]:"))
        check(example.contains("case [aarch64]:"))
        check(example.contains("case _:"))
        check(example.contains("compile_error"))

    it "parses version constraint operators":
        val ops = [">= 15", "== 17", "< 18", "~= 17"]
        check(ops.len() == 4)
        check(ops[0].contains(">="))
        check(ops[1].contains("=="))
        check(ops[2].contains("<"))
        check(ops[3].contains("~="))

describe "Asm Assert Examples":

    it "parses asm assert with arch only":
        val code = "asm assert [x86_64]"
        check(code.contains("assert"))
        check(code.contains("x86_64"))

    it "parses asm assert with full spec":
        val code = "asm assert [x86_64, linux, gnu, llvm >= 15]"
        check(code.contains("assert"))
        check(code.contains("x86_64"))
        check(code.contains("linux"))
        check(code.contains("gnu"))
        check(code.contains("llvm"))
