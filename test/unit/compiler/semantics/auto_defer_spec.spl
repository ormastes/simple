# Auto-Defer Insertion Tests (WI-5)
#
# Verifies the auto_defer.spl semantic analysis pass exists
# and has the expected functions and exports.

extern fn rt_file_read_text(path: text) -> text

describe "WI-5: Auto-defer pass file exists":
    it "auto_defer.spl exists in semantics directory":
        val content = rt_file_read_text("src/compiler/35.semantics/auto_defer.spl") ?? ""
        expect(content.len()).to_be_greater_than(0)

describe "WI-5: Auto-defer data structures":
    it "AutoDeferCandidate struct defined":
        val content = rt_file_read_text("src/compiler/35.semantics/auto_defer.spl") ?? ""
        expect(content.contains("struct AutoDeferCandidate")).to_equal(true)

    it "AutoDeferCandidate has var_name field":
        val content = rt_file_read_text("src/compiler/35.semantics/auto_defer.spl") ?? ""
        expect(content.contains("var_name: text")).to_equal(true)

    it "AutoDeferCandidate has type_name field":
        val content = rt_file_read_text("src/compiler/35.semantics/auto_defer.spl") ?? ""
        expect(content.contains("type_name: text")).to_equal(true)

    it "AutoDeferCandidate has has_manual_defer field":
        val content = rt_file_read_text("src/compiler/35.semantics/auto_defer.spl") ?? ""
        expect(content.contains("has_manual_defer: bool")).to_equal(true)

    it "AutoDeferCandidate has no_auto_defer annotation field":
        val content = rt_file_read_text("src/compiler/35.semantics/auto_defer.spl") ?? ""
        expect(content.contains("has_no_auto_defer_annotation: bool")).to_equal(true)

    it "AutoDeferResult struct defined":
        val content = rt_file_read_text("src/compiler/35.semantics/auto_defer.spl") ?? ""
        expect(content.contains("struct AutoDeferResult")).to_equal(true)

describe "WI-5: Resource trait detection":
    it "is_resource_type function defined":
        val content = rt_file_read_text("src/compiler/35.semantics/auto_defer.spl") ?? ""
        expect(content.contains("fn is_resource_type")).to_equal(true)

    it "checks for Resource trait":
        val content = rt_file_read_text("src/compiler/35.semantics/auto_defer.spl") ?? ""
        expect(content.contains("\"Resource\"")).to_equal(true)

    it "checks for Closeable trait":
        val content = rt_file_read_text("src/compiler/35.semantics/auto_defer.spl") ?? ""
        expect(content.contains("\"Closeable\"")).to_equal(true)

    it "checks for AutoCloseable trait":
        val content = rt_file_read_text("src/compiler/35.semantics/auto_defer.spl") ?? ""
        expect(content.contains("\"AutoCloseable\"")).to_equal(true)

    it "has_close_method function defined":
        val content = rt_file_read_text("src/compiler/35.semantics/auto_defer.spl") ?? ""
        expect(content.contains("fn has_close_method")).to_equal(true)

describe "WI-5: Scope analysis":
    it "find_deferred_vars function defined":
        val content = rt_file_read_text("src/compiler/35.semantics/auto_defer.spl") ?? ""
        expect(content.contains("fn find_deferred_vars")).to_equal(true)

    it "parses defer x.close() pattern":
        val content = rt_file_read_text("src/compiler/35.semantics/auto_defer.spl") ?? ""
        expect(content.contains("starts_with(\"defer \")")).to_equal(true)

    it "has_no_auto_defer_annotation function defined":
        val content = rt_file_read_text("src/compiler/35.semantics/auto_defer.spl") ?? ""
        expect(content.contains("fn has_no_auto_defer_annotation")).to_equal(true)

describe "WI-5: Auto-defer analysis pass":
    it "auto_defer_analyze function defined":
        val content = rt_file_read_text("src/compiler/35.semantics/auto_defer.spl") ?? ""
        expect(content.contains("fn auto_defer_analyze")).to_equal(true)

    it "auto_defer_generate_stmts function defined":
        val content = rt_file_read_text("src/compiler/35.semantics/auto_defer.spl") ?? ""
        expect(content.contains("fn auto_defer_generate_stmts")).to_equal(true)

    it "generates defer var.close() statements":
        val content = rt_file_read_text("src/compiler/35.semantics/auto_defer.spl") ?? ""
        # Checks that the generated statement includes .close()
        expect(content.contains(".var_name}.close()")).to_equal(true)

describe "WI-5: Exports":
    it "exports data structures":
        val content = rt_file_read_text("src/compiler/35.semantics/auto_defer.spl") ?? ""
        expect(content.contains("export AutoDeferCandidate, AutoDeferResult")).to_equal(true)

    it "exports analysis functions":
        val content = rt_file_read_text("src/compiler/35.semantics/auto_defer.spl") ?? ""
        expect(content.contains("export auto_defer_analyze, auto_defer_generate_stmts")).to_equal(true)

    it "exports detection functions":
        val content = rt_file_read_text("src/compiler/35.semantics/auto_defer.spl") ?? ""
        expect(content.contains("export is_resource_type, has_close_method")).to_equal(true)
