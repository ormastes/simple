# VHDL Builder Specification
#
# Tests for VhdlBuilder: VHDL-2008 code generation engine.

"""
# VHDL Builder Specification

**Feature IDs:** #vhdl-builder
**Category:** Backend
**Difficulty:** 3/5
**Status:** In Progress

## Overview

Tests VhdlBuilder which generates VHDL-2008 source text including
library headers, packages, entities, architectures, processes,
signal assignments, and component instantiation.

## Related Files
- `src/compiler/backend/vhdl/vhdl_builder.spl` - Builder implementation
"""

use compiler.backend.vhdl.vhdl_builder.VhdlBuilder
use std.text.{NL}
use std.spec.{check, check_msg}

# ============================================================================
# Library and Package Emission
# ============================================================================

describe "VhdlBuilder library emission":
    """
    ## Library Header

    Standard IEEE library and use clauses.
    """

    it "emits standard library header":
        var builder = VhdlBuilder__create("test_mod")
        builder.emit_library_header()
        val result = builder.build()
        check(result.contains("library ieee;"))
        check(result.contains("use ieee.std_logic_1164.all;"))
        check(result.contains("use ieee.numeric_std.all;"))

    it "emits custom use clause":
        var builder = VhdlBuilder__create("test_mod")
        builder.emit_use_package("work", "my_pkg")
        val result = builder.build()
        check(result.contains("use work.my_pkg.all;"))

describe "VhdlBuilder package emission":
    it "emits package begin and end":
        var builder = VhdlBuilder__create("test_mod")
        builder.emit_package_begin("test_mod")
        builder.emit_package_end("test_mod")
        val result = builder.build()
        check(result.contains("package test_mod_pkg is"))
        check(result.contains("end package test_mod_pkg;"))

    it "emits type declaration inside package":
        var builder = VhdlBuilder__create("test_mod")
        builder.emit_package_begin("test_mod")
        builder.emit_type_decl("state_t", "(Idle, Running, Done)")
        builder.emit_package_end("test_mod")
        val result = builder.build()
        check(result.contains("type state_t is (Idle, Running, Done);"))

    it "emits subtype declaration":
        var builder = VhdlBuilder__create("test_mod")
        builder.emit_subtype_decl("byte", "unsigned", "(7 downto 0)")
        val result = builder.build()
        check(result.contains("subtype byte is unsigned(7 downto 0);"))

    it "emits constant declaration":
        var builder = VhdlBuilder__create("test_mod")
        builder.emit_constant_decl("WIDTH", "integer", "32")
        val result = builder.build()
        check(result.contains("constant WIDTH : integer := 32;"))

# ============================================================================
# Entity Declaration
# ============================================================================

describe "VhdlBuilder entity emission":
    """
    ## Entity Declaration

    Entity with generics and ports.
    """

    it "emits simple entity with ports":
        var builder = VhdlBuilder__create("adder")
        builder.emit_entity_begin("adder")
        builder.emit_port_begin()
        builder.emit_port("a", "in", "signed(31 downto 0)", false)
        builder.emit_port("b", "in", "signed(31 downto 0)", false)
        builder.emit_port("sum", "out", "signed(31 downto 0)", true)
        builder.emit_port_end()
        builder.emit_entity_end("adder")
        val result = builder.build()
        check(result.contains("entity adder is"))
        check(result.contains("port ("))
        check(result.contains("a : in signed(31 downto 0);"))
        check(result.contains("b : in signed(31 downto 0);"))
        check(result.contains("sum : out signed(31 downto 0)"))
        check(result.contains("end entity adder;"))

    it "emits entity with generics":
        var builder = VhdlBuilder__create("generic_mod")
        builder.emit_entity_begin("generic_mod")
        builder.emit_generic_begin()
        builder.emit_generic_param("WIDTH", "integer", Some("8"), true)
        builder.emit_generic_end()
        builder.emit_port_begin()
        builder.emit_port("data_in", "in", "unsigned(WIDTH-1 downto 0)", true)
        builder.emit_port_end()
        builder.emit_entity_end("generic_mod")
        val result = builder.build()
        check(result.contains("generic ("))
        check(result.contains("WIDTH : integer := 8"))
        check(result.contains("data_in : in unsigned(WIDTH-1 downto 0)"))

    it "emits generic without default value":
        var builder = VhdlBuilder__create("test")
        builder.emit_entity_begin("test")
        builder.emit_generic_begin()
        builder.emit_generic_param("N", "integer", nil, true)
        builder.emit_generic_end()
        builder.emit_entity_end("test")
        val result = builder.build()
        check(result.contains("N : integer"))
        check(not result.contains(":="))

    it "last port has no trailing semicolon":
        var builder = VhdlBuilder__create("test")
        builder.emit_port_begin()
        builder.emit_port("clk", "in", "bit", false)
        builder.emit_port("data", "out", "bit", true)
        builder.emit_port_end()
        val result = builder.build()
        check(result.contains("clk : in bit;"))
        # Last port should not end with semicolon
        check(result.contains("data : out bit"))

# ============================================================================
# Architecture
# ============================================================================

describe "VhdlBuilder architecture emission":
    """
    ## Architecture Body

    Signal declarations and body region.
    """

    it "emits architecture shell":
        var builder = VhdlBuilder__create("test")
        builder.emit_architecture_begin("adder", "rtl")
        builder.emit_architecture_body_begin()
        builder.emit_architecture_end("rtl")
        val result = builder.build()
        check(result.contains("architecture rtl of adder is"))
        check(result.contains("begin"))
        check(result.contains("end architecture rtl;"))

    it "emits signal declarations":
        var builder = VhdlBuilder__create("test")
        builder.emit_architecture_begin("mod", "rtl")
        builder.emit_signal_decl("temp", "signed(31 downto 0)", nil)
        builder.emit_signal_decl("flag", "bit", Some("'0'"))
        builder.emit_architecture_body_begin()
        builder.emit_architecture_end("rtl")
        val result = builder.build()
        check(result.contains("signal temp : signed(31 downto 0);"))
        check(result.contains("signal flag : bit := '0';"))

# ============================================================================
# Processes
# ============================================================================

describe "VhdlBuilder process emission":
    """
    ## Process Generation

    Combinational and clocked processes with sensitivity lists.
    """

    context "combinational process":
        it "emits process with sensitivity list":
            var builder = VhdlBuilder__create("test")
            builder.emit_process_begin(nil, ["a", "b"])
            builder.emit_process_body_begin()
            builder.emit_signal_assign("sum", "a + b")
            builder.emit_process_end(nil)
            val result = builder.build()
            check(result.contains("process(a, b)"))
            check(result.contains("begin"))
            check(result.contains("sum <= a + b;"))
            check(result.contains("end process;"))

        it "emits labeled process":
            var builder = VhdlBuilder__create("test")
            builder.emit_process_begin(Some("comb_proc"), ["a", "b"])
            builder.emit_process_body_begin()
            builder.emit_process_end(Some("comb_proc"))
            val result = builder.build()
            check(result.contains("comb_proc: process(a, b)"))
            check(result.contains("end process comb_proc;"))

    context "clocked process":
        it "emits clocked process with clock only":
            var builder = VhdlBuilder__create("test")
            builder.emit_clocked_process_begin(nil, "clk", nil)
            builder.emit_process_body_begin()
            builder.emit_rising_edge_check("clk")
            builder.emit_signal_assign("q", "d")
            builder.emit_if_end()
            builder.emit_process_end(nil)
            val result = builder.build()
            check(result.contains("process(clk)"))
            check(result.contains("if rising_edge(clk) then"))
            check(result.contains("q <= d;"))

        it "emits clocked process with reset":
            var builder = VhdlBuilder__create("test")
            builder.emit_clocked_process_begin(nil, "clk", Some("rst"))
            builder.emit_process_body_begin()
            builder.emit_process_end(nil)
            val result = builder.build()
            check(result.contains("process(clk, rst)"))

    context "process variables":
        it "emits process variable declarations":
            var builder = VhdlBuilder__create("test")
            builder.emit_process_begin(nil, ["a"])
            builder.emit_process_var("temp", "signed(31 downto 0)", nil)
            builder.emit_process_var("count", "integer", Some("0"))
            builder.emit_process_body_begin()
            builder.emit_process_end(nil)
            val result = builder.build()
            check(result.contains("variable temp : signed(31 downto 0);"))
            check(result.contains("variable count : integer := 0;"))

# ============================================================================
# Statements
# ============================================================================

describe "VhdlBuilder statement emission":
    """
    ## Statement Generation

    Signal/variable assignments, if/elsif/else, for loops.
    """

    context "assignments":
        it "emits signal assignment":
            var builder = VhdlBuilder__create("test")
            builder.emit_signal_assign("q", "d")
            val result = builder.build()
            check(result.contains("q <= d;"))

        it "emits signal assignment with delay":
            var builder = VhdlBuilder__create("test")
            builder.emit_signal_assign_delay("q", "d", 10)
            val result = builder.build()
            check(result.contains("q <= d after 10 ns;"))

        it "emits variable assignment":
            var builder = VhdlBuilder__create("test")
            builder.emit_var_assign("temp", "a + b")
            val result = builder.build()
            check(result.contains("temp := a + b;"))

    context "conditionals":
        it "emits if-then-end if":
            var builder = VhdlBuilder__create("test")
            builder.emit_if_begin("a = '1'")
            builder.emit_signal_assign("q", "'1'")
            builder.emit_if_end()
            val result = builder.build()
            check(result.contains("if a = '1' then"))
            check(result.contains("q <= '1';"))
            check(result.contains("end if;"))

        it "emits if-elsif-else":
            var builder = VhdlBuilder__create("test")
            builder.emit_if_begin("sel = \"00\"")
            builder.emit_signal_assign("out", "a")
            builder.emit_elsif("sel = \"01\"")
            builder.emit_signal_assign("out", "b")
            builder.emit_else()
            builder.emit_signal_assign("out", "c")
            builder.emit_if_end()
            val result = builder.build()
            check(result.contains("if sel = \"00\" then"))
            check(result.contains("elsif sel = \"01\" then"))
            check(result.contains("else"))
            check(result.contains("end if;"))

    context "edge checks":
        it "emits rising_edge check":
            var builder = VhdlBuilder__create("test")
            builder.emit_rising_edge_check("clk")
            builder.emit_if_end()
            val result = builder.build()
            check(result.contains("if rising_edge(clk) then"))
            check(result.contains("end if;"))

        it "emits falling_edge check":
            var builder = VhdlBuilder__create("test")
            builder.emit_falling_edge_check("clk")
            builder.emit_if_end()
            val result = builder.build()
            check(result.contains("if falling_edge(clk) then"))

    context "for loops":
        it "emits bounded for loop":
            var builder = VhdlBuilder__create("test")
            builder.emit_for_loop_begin("i", 0, 7)
            builder.emit_signal_assign("data(i)", "'0'")
            builder.emit_for_loop_end()
            val result = builder.build()
            check(result.contains("for i in 0 to 7 loop"))
            check(result.contains("end loop;"))

# ============================================================================
# Component Instantiation
# ============================================================================

describe "VhdlBuilder component instantiation":
    it "emits component instance with port map":
        var builder = VhdlBuilder__create("test")
        builder.emit_instance_begin("u_adder", "adder")
        builder.emit_port_map_begin()
        builder.emit_port_map_entry("a", "sig_a", false)
        builder.emit_port_map_entry("b", "sig_b", false)
        builder.emit_port_map_entry("sum", "sig_sum", true)
        builder.emit_port_map_end()
        val result = builder.build()
        check(result.contains("u_adder: entity work.adder"))
        check(result.contains("port map ("))
        check(result.contains("a => sig_a,"))
        check(result.contains("b => sig_b,"))
        check(result.contains("sum => sig_sum"))
        check(result.contains(");"))

# ============================================================================
# Resize, Slice, Concat
# ============================================================================

describe "VhdlBuilder resize/slice/concat":
    it "emits resize operation":
        var builder = VhdlBuilder__create("test")
        builder.emit_resize("wide_sig", "narrow_sig", 32, true)
        val result = builder.build()
        check(result.contains("wide_sig <= resize(narrow_sig, 32);"))

    it "emits slice operation":
        var builder = VhdlBuilder__create("test")
        builder.emit_slice("byte0", "word", 7, 0)
        val result = builder.build()
        check(result.contains("byte0 <= word(7 downto 0);"))

    it "emits concatenation":
        var builder = VhdlBuilder__create("test")
        builder.emit_concat("full", ["high", "low"])
        val result = builder.build()
        check(result.contains("full <= high & low;"))

    it "emits multi-part concatenation":
        var builder = VhdlBuilder__create("test")
        builder.emit_concat("result", ["a", "b", "c", "d"])
        val result = builder.build()
        check(result.contains("result <= a & b & c & d;"))

# ============================================================================
# Assertions and Pragmas
# ============================================================================

describe "VhdlBuilder assertions":
    it "emits assert statement":
        var builder = VhdlBuilder__create("test")
        builder.emit_assert("width > 0", "Width must be positive", "error")
        val result = builder.build()
        check(result.contains("assert width > 0"))
        check(result.contains("report \"Width must be positive\""))
        check(result.contains("severity error;"))

    it "emits synthesis translate_off/on":
        var builder = VhdlBuilder__create("test")
        builder.emit_synthesis_translate_off()
        builder.emit_assert("true", "sim only", "note")
        builder.emit_synthesis_translate_on()
        val result = builder.build()
        check(result.contains("-- synthesis translate_off"))
        check(result.contains("-- synthesis translate_on"))

# ============================================================================
# Comments and Labels
# ============================================================================

describe "VhdlBuilder comments and labels":
    it "emits comment":
        var builder = VhdlBuilder__create("test")
        builder.emit_comment("This is a test comment")
        val result = builder.build()
        check(result.contains("-- This is a test comment"))

    it "allocates unique labels":
        var builder = VhdlBuilder__create("test")
        val l0 = builder.alloc_label()
        val l1 = builder.alloc_label()
        val l2 = builder.alloc_label()
        expect(l0).to_equal("label_0")
        expect(l1).to_equal("label_1")
        expect(l2).to_equal("label_2")

# ============================================================================
# Output and Build
# ============================================================================

describe "VhdlBuilder output":
    it "builds empty output":
        val builder = VhdlBuilder__create("test")
        val result = builder.build()
        expect(result).to_equal("")

    it "builds multi-line output":
        var builder = VhdlBuilder__create("test")
        builder.emit_library_header()
        val result = builder.build()
        val lines = result.split(NL)
        check(lines.len() > 1)

    it "gets output lines as array":
        var builder = VhdlBuilder__create("test")
        builder.emit_comment("line 1")
        builder.emit_comment("line 2")
        val lines = builder.get_output()
        expect(lines.len()).to_equal(2)

# ============================================================================
# Complete Entity Example
# ============================================================================

describe "VhdlBuilder complete entity":
    it "generates a full counter entity":
        var builder = VhdlBuilder__create("counter")
        builder.emit_library_header()
        builder.emit_entity_begin("counter")
        builder.emit_port_begin()
        builder.emit_port("clk", "in", "bit", false)
        builder.emit_port("rst", "in", "bit", false)
        builder.emit_port("count", "out", "unsigned(7 downto 0)", true)
        builder.emit_port_end()
        builder.emit_entity_end("counter")
        builder.emit_architecture_begin("counter", "rtl")
        builder.emit_signal_decl("count_reg", "unsigned(7 downto 0)", Some("(others => '0')"))
        builder.emit_architecture_body_begin()
        builder.emit_clocked_process_begin(Some("cnt_proc"), "clk", Some("rst"))
        builder.emit_process_body_begin()
        builder.emit_if_begin("rst = '1'")
        builder.emit_signal_assign("count_reg", "(others => '0')")
        builder.emit_elsif("rising_edge(clk)")
        builder.emit_signal_assign("count_reg", "count_reg + 1")
        builder.emit_if_end()
        builder.emit_process_end(Some("cnt_proc"))
        builder.emit_signal_assign("count", "count_reg")
        builder.emit_architecture_end("rtl")

        val result = builder.build()
        check(result.contains("library ieee;"))
        check(result.contains("entity counter is"))
        check(result.contains("architecture rtl of counter is"))
        check(result.contains("signal count_reg"))
        check(result.contains("cnt_proc: process(clk, rst)"))
        check(result.contains("end architecture rtl;"))
