#!/usr/bin/env simple
# Interpreter Mode Configuration Tests
#
# Tests for configurable interpreter modes (Classic vs Optimized).
# Verifies InterpreterConfig factories, builders, and InterpreterBackendImpl constructors.

describe "InterpreterConfig":
    describe "Classic factory":
        it "returns classic mode":
            val config = InterpreterConfig__classic()
            expect config.enable_debug_hooks == true
            expect config.enable_gc == true
            expect config.use_ffi_arithmetic == true

        it "sets mode to Classic":
            val config = InterpreterConfig__classic()
            match config.mode:
                case InterpreterMode.Classic:
                    expect true
                case _:
                    expect false

    describe "Optimized factory":
        it "returns optimized mode":
            val config = InterpreterConfig__optimized()
            expect config.enable_debug_hooks == false
            expect config.enable_gc == false
            expect config.use_ffi_arithmetic == false

        it "sets mode to Optimized":
            val config = InterpreterConfig__optimized()
            match config.mode:
                case InterpreterMode.Optimized:
                    expect true
                case _:
                    expect false

    describe "Builder methods":
        it "with_gc overrides GC setting":
            val config = InterpreterConfig__classic().with_gc(false)
            expect config.enable_gc == false
            expect config.enable_debug_hooks == true
            expect config.use_ffi_arithmetic == true

        it "with_debug overrides debug hooks setting":
            val config = InterpreterConfig__classic().with_debug(false)
            expect config.enable_debug_hooks == false
            expect config.enable_gc == true

        it "chains multiple builders":
            val config = InterpreterConfig__optimized().with_gc(true).with_debug(true)
            expect config.enable_gc == true
            expect config.enable_debug_hooks == true
            expect config.use_ffi_arithmetic == false

describe "InterpreterBackendImpl":
    describe "Constructors":
        it "new() uses classic config":
            val backend = InterpreterBackendImpl__new()
            expect backend.config.enable_gc == true
            expect backend.config.enable_debug_hooks == true
            expect backend.config.use_ffi_arithmetic == true

        it "optimized() uses optimized config":
            val backend = InterpreterBackendImpl__optimized()
            expect backend.config.enable_gc == false
            expect backend.config.enable_debug_hooks == false
            expect backend.config.use_ffi_arithmetic == false

        it "with_config() uses provided config":
            val config = InterpreterConfig__classic().with_gc(false)
            val backend = InterpreterBackendImpl__with_config(config)
            expect backend.config.enable_gc == false
            expect backend.config.enable_debug_hooks == true

    describe "Backend interface":
        it "reports name as interpreter":
            val backend = InterpreterBackendImpl__new()
            expect backend.name() == "interpreter"

        it "reports kind as Interpreter":
            val backend = InterpreterBackendImpl__new()
            match backend.kind():
                case BackendKind.Interpreter:
                    expect true
                case _:
                    expect false
