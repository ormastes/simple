# Compiler Shared Dependency Injection Check
#
# Validates that the compiler_shared delegation (DI) pattern is correctly
# wired for all migrated files:
#   compiler_shared/<path>.spl  -- canonical shared implementation
#   compiler/<path>.spl         -- thin delegation wrapper
#   compiler/<path>.spl    -- thin delegation wrapper
#
# Each delegation wrapper must:
#   1. Import from compiler_shared (contains "use compiler_shared.")
#   2. Re-export the symbols (contains "export")

extern fn rt_file_read_text(path: text) -> text

# ============================================================================
# Helpers
# ============================================================================

fn _file_exists(path: text) -> bool:
    val content = rt_file_read_text(path) ?? ""
    content.len() > 0

fn _file_delegates(path: text) -> bool:
    val content = rt_file_read_text(path) ?? ""
    content.contains("use compiler_shared.")

fn _file_exports(path: text) -> bool:
    val content = rt_file_read_text(path) ?? ""
    content.contains("export")

fn _wrapper_ok(compiler_path: text) -> bool:
    val ok1 = _file_delegates(compiler_path)
    val ok2 = _file_exports(compiler_path)
    ok1 and ok2

# ============================================================================
# Batch 1: Identical files — shared sources exist
# ============================================================================

describe "DI Check - Batch 1 shared sources exist":
    """
    Verifies the canonical implementations exist in compiler_shared/.
    These 9 non-test files are byte-for-byte identical copies from the original.
    """

    it "backend/backend_ffi.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/backend/backend_ffi.spl")).to_equal(true)

    it "blocks/builtin_blocks_defs.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/blocks/builtin_blocks_defs.spl")).to_equal(true)

    it "blocks/builtin.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/blocks/builtin.spl")).to_equal(true)

    it "error_explanations.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/error_explanations.spl")).to_equal(true)

    it "hir.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/hir.spl")).to_equal(true)

    it "mir.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/mir.spl")).to_equal(true)

    it "pattern_analysis.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/pattern_analysis.spl")).to_equal(true)

    it "semantics.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/semantics.spl")).to_equal(true)

    it "type_system/__init__.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/type_system/__init__.spl")).to_equal(true)


# ============================================================================
# Batch 1: Identical files — compiler/ wrappers delegate to compiler_shared
# ============================================================================

describe "DI Check - Batch 1 compiler/ wrappers":
    """
    Verifies compiler/ wrappers import from compiler_shared and re-export.
    """

    it "compiler/backend/backend_ffi.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/backend_ffi.spl")).to_equal(true)

    it "compiler/blocks/builtin_blocks_defs.spl delegates":
        expect(_wrapper_ok("src/compiler/blocks/builtin_blocks_defs.spl")).to_equal(true)

    it "compiler/blocks/builtin.spl delegates":
        expect(_wrapper_ok("src/compiler/blocks/builtin.spl")).to_equal(true)

    it "compiler/error_explanations.spl delegates":
        expect(_wrapper_ok("src/compiler/error_explanations.spl")).to_equal(true)

    it "compiler/hir.spl delegates":
        expect(_wrapper_ok("src/compiler/hir.spl")).to_equal(true)

    it "compiler/mir.spl delegates":
        expect(_wrapper_ok("src/compiler/mir.spl")).to_equal(true)

    it "compiler/pattern_analysis.spl delegates":
        expect(_wrapper_ok("src/compiler/pattern_analysis.spl")).to_equal(true)

    it "compiler/semantics.spl delegates":
        expect(_wrapper_ok("src/compiler/semantics.spl")).to_equal(true)

    it "compiler/type_system/__init__.spl delegates":
        expect(_wrapper_ok("src/compiler/type_system/__init__.spl")).to_equal(true)


# ============================================================================
# Batch 1: Identical files — compiler/ wrappers delegate to compiler_shared
# ============================================================================

describe "DI Check - Batch 1 compiler/ wrappers":
    """
    Verifies compiler/ wrappers import from compiler_shared and re-export.
    """

    it "compiler/backend/backend_ffi.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/backend_ffi.spl")).to_equal(true)

    it "compiler/blocks/builtin_blocks_defs.spl delegates":
        expect(_wrapper_ok("src/compiler/blocks/builtin_blocks_defs.spl")).to_equal(true)

    it "compiler/blocks/builtin.spl delegates":
        expect(_wrapper_ok("src/compiler/blocks/builtin.spl")).to_equal(true)

    it "compiler/error_explanations.spl delegates":
        expect(_wrapper_ok("src/compiler/error_explanations.spl")).to_equal(true)

    it "compiler/hir.spl delegates":
        expect(_wrapper_ok("src/compiler/hir.spl")).to_equal(true)

    it "compiler/mir.spl delegates":
        expect(_wrapper_ok("src/compiler/mir.spl")).to_equal(true)

    it "compiler/pattern_analysis.spl delegates":
        expect(_wrapper_ok("src/compiler/pattern_analysis.spl")).to_equal(true)

    it "compiler/semantics.spl delegates":
        expect(_wrapper_ok("src/compiler/semantics.spl")).to_equal(true)

    it "compiler/type_system/__init__.spl delegates":
        expect(_wrapper_ok("src/compiler/type_system/__init__.spl")).to_equal(true)


# ============================================================================
# Batch 2: Near-identical files — shared sources exist (8 fully migrated)
# ============================================================================

describe "DI Check - Batch 2 shared sources exist":
    """
    Verifies shared implementations exist for fully-migrated near-identical files.
    8 of 16 Batch 2 files have both compiler/ and compiler/ wrappers complete.
    """

    it "desugar/state_enum.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/desugar/state_enum.spl")).to_equal(true)

    it "backend/capability_tracker.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/backend/capability_tracker.spl")).to_equal(true)

    it "backend/native/encode_riscv32.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/backend/native/encode_riscv32.spl")).to_equal(true)

    it "backend/native/encode_riscv64.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/backend/native/encode_riscv64.spl")).to_equal(true)

    it "backend/vulkan/spirv_builder.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/backend/vulkan/spirv_builder.spl")).to_equal(true)

    it "loader/smf_mmap_native.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/loader/smf_mmap_native.spl")).to_equal(true)

    it "mir_json.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/mir_json.spl")).to_equal(true)

    it "mir_serialization.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/mir_serialization.spl")).to_equal(true)


# ============================================================================
# Batch 2: Near-identical files — compiler/ wrappers delegate
# ============================================================================

describe "DI Check - Batch 2 compiler/ wrappers":

    it "compiler/desugar/state_enum.spl delegates":
        expect(_wrapper_ok("src/compiler/desugar/state_enum.spl")).to_equal(true)

    it "compiler/backend/capability_tracker.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/capability_tracker.spl")).to_equal(true)

    it "compiler/backend/native/encode_riscv32.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/native/encode_riscv32.spl")).to_equal(true)

    it "compiler/backend/native/encode_riscv64.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/native/encode_riscv64.spl")).to_equal(true)

    it "compiler/backend/vulkan/spirv_builder.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/vulkan/spirv_builder.spl")).to_equal(true)

    it "compiler/loader/smf_mmap_native.spl delegates":
        expect(_wrapper_ok("src/compiler/loader/smf_mmap_native.spl")).to_equal(true)

    it "compiler/mir_json.spl delegates":
        expect(_wrapper_ok("src/compiler/mir_json.spl")).to_equal(true)

    it "compiler/mir_serialization.spl delegates":
        expect(_wrapper_ok("src/compiler/mir_serialization.spl")).to_equal(true)


# ============================================================================
# Batch 2: Near-identical files — compiler/ wrappers delegate
# ============================================================================

describe "DI Check - Batch 2 compiler/ wrappers":

    it "compiler/desugar/state_enum.spl delegates":
        expect(_wrapper_ok("src/compiler/desugar/state_enum.spl")).to_equal(true)

    it "compiler/backend/capability_tracker.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/capability_tracker.spl")).to_equal(true)

    it "compiler/backend/native/encode_riscv32.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/native/encode_riscv32.spl")).to_equal(true)

    it "compiler/backend/native/encode_riscv64.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/native/encode_riscv64.spl")).to_equal(true)

    it "compiler/backend/vulkan/spirv_builder.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/vulkan/spirv_builder.spl")).to_equal(true)

    it "compiler/loader/smf_mmap_native.spl delegates":
        expect(_wrapper_ok("src/compiler/loader/smf_mmap_native.spl")).to_equal(true)

    it "compiler/mir_json.spl delegates":
        expect(_wrapper_ok("src/compiler/mir_json.spl")).to_equal(true)

    it "compiler/mir_serialization.spl delegates":
        expect(_wrapper_ok("src/compiler/mir_serialization.spl")).to_equal(true)


# ============================================================================
# Batch 3 (partial): Mostly-same files — shared sources exist
# ============================================================================

describe "DI Check - Batch 3 shared sources exist":
    """
    Verifies the 4 Batch 3 files migrated in the current work-in-progress
    exist in compiler_shared/.
    """

    it "backend/native/encode_aarch64.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/backend/native/encode_aarch64.spl")).to_equal(true)

    it "blocks/error_helpers.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/blocks/error_helpers.spl")).to_equal(true)

    it "blocks/text_transforms.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/blocks/text_transforms.spl")).to_equal(true)

    it "desugar_async.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/desugar_async.spl")).to_equal(true)


# ============================================================================
# Batch 3 (partial): Mostly-same files — compiler/ wrappers delegate
# ============================================================================

describe "DI Check - Batch 3 compiler/ wrappers":

    it "compiler/backend/native/encode_aarch64.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/native/encode_aarch64.spl")).to_equal(true)

    it "compiler/blocks/error_helpers.spl delegates":
        expect(_wrapper_ok("src/compiler/blocks/error_helpers.spl")).to_equal(true)

    it "compiler/blocks/text_transforms.spl delegates":
        expect(_wrapper_ok("src/compiler/blocks/text_transforms.spl")).to_equal(true)

    it "compiler/desugar_async.spl delegates":
        expect(_wrapper_ok("src/compiler/desugar_async.spl")).to_equal(true)


# ============================================================================
# Batch 3 (partial): Mostly-same files — compiler/ wrappers delegate
# ============================================================================

describe "DI Check - Batch 3 compiler/ wrappers":

    it "compiler/backend/native/encode_aarch64.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/native/encode_aarch64.spl")).to_equal(true)

    it "compiler/blocks/error_helpers.spl delegates":
        expect(_wrapper_ok("src/compiler/blocks/error_helpers.spl")).to_equal(true)

    it "compiler/blocks/text_transforms.spl delegates":
        expect(_wrapper_ok("src/compiler/blocks/text_transforms.spl")).to_equal(true)

    it "compiler/desugar_async.spl delegates":
        expect(_wrapper_ok("src/compiler/desugar_async.spl")).to_equal(true)

    it "compiler/backend/native/encode_x86_64.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/native/encode_x86_64.spl")).to_equal(true)

    it "compiler/backend/native/elf_writer.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/native/elf_writer.spl")).to_equal(true)

    it "compiler/backend/native/regalloc.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/native/regalloc.spl")).to_equal(true)

    it "compiler/linker/linker_wrapper_lib_support.spl delegates":
        expect(_wrapper_ok("src/compiler/linker/linker_wrapper_lib_support.spl")).to_equal(true)

    it "compiler/blocks/definition.spl delegates":
        expect(_wrapper_ok("src/compiler/blocks/definition.spl")).to_equal(true)

    it "compiler/blocks/easy.spl delegates":
        expect(_wrapper_ok("src/compiler/blocks/easy.spl")).to_equal(true)

    it "compiler/blocks/testing.spl delegates":
        expect(_wrapper_ok("src/compiler/blocks/testing.spl")).to_equal(true)

    it "compiler/desugar/poll_generator.spl delegates":
        expect(_wrapper_ok("src/compiler/desugar/poll_generator.spl")).to_equal(true)

    it "compiler/backend/native/mach_inst.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/native/mach_inst.spl")).to_equal(true)


# ============================================================================
# Batch 3 extended: compiler/ wrappers for new files
# ============================================================================

describe "DI Check - Batch 3 extended compiler/ wrappers":

    it "compiler/backend/native/encode_x86_64.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/native/encode_x86_64.spl")).to_equal(true)

    it "compiler/backend/native/elf_writer.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/native/elf_writer.spl")).to_equal(true)

    it "compiler/backend/native/regalloc.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/native/regalloc.spl")).to_equal(true)

    it "compiler/linker/linker_wrapper_lib_support.spl delegates":
        expect(_wrapper_ok("src/compiler/linker/linker_wrapper_lib_support.spl")).to_equal(true)

    it "compiler/blocks/definition.spl delegates":
        expect(_wrapper_ok("src/compiler/blocks/definition.spl")).to_equal(true)

    it "compiler/blocks/easy.spl delegates":
        expect(_wrapper_ok("src/compiler/blocks/easy.spl")).to_equal(true)

    it "compiler/blocks/testing.spl delegates":
        expect(_wrapper_ok("src/compiler/blocks/testing.spl")).to_equal(true)

    it "compiler/desugar/poll_generator.spl delegates":
        expect(_wrapper_ok("src/compiler/desugar/poll_generator.spl")).to_equal(true)

    it "compiler/backend/native/mach_inst.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/native/mach_inst.spl")).to_equal(true)


# ============================================================================
# Batch 2 remaining: error_codes, visibility, hir_lowering, irdsl/codegen
# ============================================================================

describe "DI Check - Batch 2 completed wrappers":

    it "compiler/error_codes.spl delegates":
        expect(_wrapper_ok("src/compiler/error_codes.spl")).to_equal(true)

    it "compiler/error_codes.spl has exports":
        expect(_file_exports("src/compiler/error_codes.spl")).to_equal(true)

    it "compiler/visibility.spl delegates":
        expect(_wrapper_ok("src/compiler/visibility.spl")).to_equal(true)

    it "compiler/visibility.spl delegates":
        expect(_wrapper_ok("src/compiler/visibility.spl")).to_equal(true)

    it "compiler/hir_lowering.spl delegates":
        expect(_wrapper_ok("src/compiler/hir_lowering.spl")).to_equal(true)

    it "compiler/hir_lowering.spl delegates":
        expect(_wrapper_ok("src/compiler/hir_lowering.spl")).to_equal(true)

    it "compiler/irdsl/codegen.spl delegates":
        expect(_wrapper_ok("src/compiler/irdsl/codegen.spl")).to_equal(true)

    it "compiler/irdsl/codegen.spl delegates":
        expect(_wrapper_ok("src/compiler/irdsl/codegen.spl")).to_equal(true)


# ============================================================================
# Batch 3 new: dependency/, monomorphize/, backend/native/isel_*
# ============================================================================

describe "DI Check - Batch 3 new shared sources exist":

    it "dependency/graph.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/dependency/graph.spl")).to_equal(true)

    it "dependency/symbol.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/dependency/symbol.spl")).to_equal(true)

    it "dependency/resolution.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/dependency/resolution.spl")).to_equal(true)

    it "monomorphize/tracker.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/monomorphize/tracker.spl")).to_equal(true)

    it "backend/native/isel_x86_64.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/backend/native/isel_x86_64.spl")).to_equal(true)

    it "backend/native/isel_aarch64.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/backend/native/isel_aarch64.spl")).to_equal(true)


describe "DI Check - Batch 3 new compiler/ wrappers":

    it "compiler/dependency/graph.spl delegates":
        expect(_wrapper_ok("src/compiler/dependency/graph.spl")).to_equal(true)

    it "compiler/dependency/symbol.spl delegates":
        expect(_wrapper_ok("src/compiler/dependency/symbol.spl")).to_equal(true)

    it "compiler/dependency/resolution.spl delegates":
        expect(_wrapper_ok("src/compiler/dependency/resolution.spl")).to_equal(true)

    it "compiler/monomorphize/tracker.spl delegates":
        expect(_wrapper_ok("src/compiler/monomorphize/tracker.spl")).to_equal(true)

    it "compiler/backend/native/isel_x86_64.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/native/isel_x86_64.spl")).to_equal(true)

    it "compiler/backend/native/isel_aarch64.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/native/isel_aarch64.spl")).to_equal(true)


describe "DI Check - Batch 3 new compiler/ wrappers":

    it "compiler/dependency/graph.spl delegates":
        expect(_wrapper_ok("src/compiler/dependency/graph.spl")).to_equal(true)

    it "compiler/dependency/symbol.spl delegates":
        expect(_wrapper_ok("src/compiler/dependency/symbol.spl")).to_equal(true)

    it "compiler/dependency/resolution.spl delegates":
        expect(_wrapper_ok("src/compiler/dependency/resolution.spl")).to_equal(true)

    it "compiler/monomorphize/tracker.spl delegates":
        expect(_wrapper_ok("src/compiler/monomorphize/tracker.spl")).to_equal(true)

    it "compiler/backend/native/isel_x86_64.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/native/isel_x86_64.spl")).to_equal(true)

    it "compiler/backend/native/isel_aarch64.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/native/isel_aarch64.spl")).to_equal(true)


# ============================================================================
# Batch 2/3 additional: isel_riscv32, isel_riscv64, native_bridge
# ============================================================================

describe "DI Check - Additional shared sources exist":

    it "backend/native/isel_riscv32.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/backend/native/isel_riscv32.spl")).to_equal(true)

    it "backend/native/isel_riscv64.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/backend/native/isel_riscv64.spl")).to_equal(true)

    it "backend/native_bridge.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/backend/native_bridge.spl")).to_equal(true)


describe "DI Check - Additional compiler/ wrappers":

    it "compiler/backend/native/isel_riscv32.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/native/isel_riscv32.spl")).to_equal(true)

    it "compiler/backend/native/isel_riscv64.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/native/isel_riscv64.spl")).to_equal(true)

    it "compiler/backend/native_bridge.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/native_bridge.spl")).to_equal(true)


describe "DI Check - Additional compiler/ wrappers":

    it "compiler/backend/native/isel_riscv32.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/native/isel_riscv32.spl")).to_equal(true)

    it "compiler/backend/native/isel_riscv64.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/native/isel_riscv64.spl")).to_equal(true)

    it "compiler/backend/native_bridge.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/native_bridge.spl")).to_equal(true)


# ============================================================================
# Wave 2: files, gc_analysis, mir, inference, blocks, hir_lowering, module_resolver, loader, borrow_check
# ============================================================================

describe "DI Check - Wave 2 shared sources exist":

    it "predicate.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/predicate.spl")).to_equal(true)

    it "ffi.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/ffi.spl")).to_equal(true)

    it "ffi_minimal.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/ffi_minimal.spl")).to_equal(true)

    it "ast.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/ast.spl")).to_equal(true)

    it "parser_types.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/parser_types.spl")).to_equal(true)

    it "type_layout.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/type_layout.spl")).to_equal(true)

    it "hir_definitions.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/hir_definitions.spl")).to_equal(true)

    it "gc_analysis/barriers.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/gc_analysis/barriers.spl")).to_equal(true)

    it "mir/ghost_erasure.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/mir/ghost_erasure.spl")).to_equal(true)

    it "borrow_check/lifetime.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/borrow_check/lifetime.spl")).to_equal(true)

    it "borrow_check/nll.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/borrow_check/nll.spl")).to_equal(true)

    it "loader/compiler_ffi.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/loader/compiler_ffi.spl")).to_equal(true)

    it "loader/module_loader.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/loader/module_loader.spl")).to_equal(true)

    it "module_resolver/types.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/module_resolver/types.spl")).to_equal(true)

    it "semantics/binary_ops.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/semantics/binary_ops.spl")).to_equal(true)

    it "treesitter/outline.spl exists in compiler_shared":
        expect(_file_exists("src/compiler_shared/treesitter/outline.spl")).to_equal(true)


describe "DI Check - Wave 2 compiler/ wrappers":

    it "compiler/predicate.spl delegates":
        expect(_wrapper_ok("src/compiler/predicate.spl")).to_equal(true)

    it "compiler/ffi.spl delegates":
        expect(_wrapper_ok("src/compiler/ffi.spl")).to_equal(true)

    it "compiler/ast.spl delegates":
        expect(_wrapper_ok("src/compiler/ast.spl")).to_equal(true)

    it "compiler/parser_types.spl delegates":
        expect(_wrapper_ok("src/compiler/parser_types.spl")).to_equal(true)

    it "compiler/type_layout.spl delegates":
        expect(_wrapper_ok("src/compiler/type_layout.spl")).to_equal(true)

    it "compiler/hir_definitions.spl delegates":
        expect(_wrapper_ok("src/compiler/hir_definitions.spl")).to_equal(true)

    it "compiler/gc_analysis/barriers.spl delegates":
        expect(_wrapper_ok("src/compiler/gc_analysis/barriers.spl")).to_equal(true)

    it "compiler/mir/ghost_erasure.spl delegates":
        expect(_wrapper_ok("src/compiler/mir/ghost_erasure.spl")).to_equal(true)

    it "compiler/borrow_check/lifetime.spl delegates":
        expect(_wrapper_ok("src/compiler/borrow_check/lifetime.spl")).to_equal(true)

    it "compiler/borrow_check/nll.spl delegates":
        expect(_wrapper_ok("src/compiler/borrow_check/nll.spl")).to_equal(true)

    it "compiler/loader/compiler_ffi.spl delegates":
        expect(_wrapper_ok("src/compiler/loader/compiler_ffi.spl")).to_equal(true)

    it "compiler/module_resolver/types.spl delegates":
        expect(_wrapper_ok("src/compiler/module_resolver/types.spl")).to_equal(true)

    it "compiler/semantics/binary_ops.spl delegates":
        expect(_wrapper_ok("src/compiler/semantics/binary_ops.spl")).to_equal(true)

    it "compiler/treesitter/outline.spl delegates":
        expect(_wrapper_ok("src/compiler/treesitter/outline.spl")).to_equal(true)

    it "compiler/type_system/effects.spl delegates":
        expect(_wrapper_ok("src/compiler/type_system/effects.spl")).to_equal(true)

    it "compiler/type_system/bidirectional.spl delegates":
        expect(_wrapper_ok("src/compiler/type_system/bidirectional.spl")).to_equal(true)


describe "DI Check - Wave 2 compiler/ wrappers":

    it "compiler/predicate.spl delegates":
        expect(_wrapper_ok("src/compiler/predicate.spl")).to_equal(true)

    it "compiler/ffi.spl delegates":
        expect(_wrapper_ok("src/compiler/ffi.spl")).to_equal(true)

    it "compiler/ast.spl delegates":
        expect(_wrapper_ok("src/compiler/ast.spl")).to_equal(true)

    it "compiler/parser_types.spl delegates":
        expect(_wrapper_ok("src/compiler/parser_types.spl")).to_equal(true)

    it "compiler/type_layout.spl delegates":
        expect(_wrapper_ok("src/compiler/type_layout.spl")).to_equal(true)

    it "compiler/hir_definitions.spl delegates":
        expect(_wrapper_ok("src/compiler/hir_definitions.spl")).to_equal(true)

    it "compiler/gc_analysis/barriers.spl delegates":
        expect(_wrapper_ok("src/compiler/gc_analysis/barriers.spl")).to_equal(true)

    it "compiler/mir/ghost_erasure.spl delegates":
        expect(_wrapper_ok("src/compiler/mir/ghost_erasure.spl")).to_equal(true)

    it "compiler/borrow_check/lifetime.spl delegates":
        expect(_wrapper_ok("src/compiler/borrow_check/lifetime.spl")).to_equal(true)

    it "compiler/borrow_check/nll.spl delegates":
        expect(_wrapper_ok("src/compiler/borrow_check/nll.spl")).to_equal(true)

    it "compiler/loader/compiler_ffi.spl delegates":
        expect(_wrapper_ok("src/compiler/loader/compiler_ffi.spl")).to_equal(true)

    it "compiler/module_resolver/types.spl delegates":
        expect(_wrapper_ok("src/compiler/module_resolver/types.spl")).to_equal(true)

    it "compiler/semantics/binary_ops.spl delegates":
        expect(_wrapper_ok("src/compiler/semantics/binary_ops.spl")).to_equal(true)

    it "compiler/treesitter/outline.spl delegates":
        expect(_wrapper_ok("src/compiler/treesitter/outline.spl")).to_equal(true)

    it "compiler/type_system/effects.spl delegates":
        expect(_wrapper_ok("src/compiler/type_system/effects.spl")).to_equal(true)

    it "compiler/type_system/bidirectional.spl delegates":
        expect(_wrapper_ok("src/compiler/type_system/bidirectional.spl")).to_equal(true)

describe "Batch 4 - Final Migration (mir_test_builder, registry)":
    it "compiler/backend/mir_test_builder.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/mir_test_builder.spl")).to_equal(true)

    it "compiler/backend/mir_test_builder.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/mir_test_builder.spl")).to_equal(true)

    it "compiler_shared/backend/mir_test_builder.spl exists":
        expect(_file_exists("src/compiler_shared/backend/mir_test_builder.spl")).to_equal(true)

    it "compiler/backend/mir_test_builder_full.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/mir_test_builder_full.spl")).to_equal(true)

    it "compiler/backend/mir_test_builder_full.spl delegates":
        expect(_wrapper_ok("src/compiler/backend/mir_test_builder_full.spl")).to_equal(true)

    it "compiler_shared/backend/mir_test_builder_full.spl exists":
        expect(_file_exists("src/compiler_shared/backend/mir_test_builder_full.spl")).to_equal(true)

    it "compiler/registry/mod.spl delegates":
        expect(_wrapper_ok("src/compiler/registry/mod.spl")).to_equal(true)

    it "compiler/registry/mod.spl delegates":
        expect(_wrapper_ok("src/compiler/registry/mod.spl")).to_equal(true)

    it "compiler_shared/registry/mod.spl exists":
        expect(_file_exists("src/compiler_shared/registry/mod.spl")).to_equal(true)

    it "blocks/definition delegation wrappers correct":
        expect(_wrapper_ok("src/compiler/blocks/definition.spl")).to_equal(true)

    it "blocks/easy delegation wrappers correct":
        expect(_wrapper_ok("src/compiler/blocks/easy.spl")).to_equal(true)

    it "blocks/testing delegation wrappers correct":
        expect(_wrapper_ok("src/compiler/blocks/testing.spl")).to_equal(true)

    it "desugar/poll_generator delegation wrappers correct":
        expect(_wrapper_ok("src/compiler/desugar/poll_generator.spl")).to_equal(true)

    it "backend/native/mach_inst delegation wrappers correct":
        expect(_wrapper_ok("src/compiler/backend/native/mach_inst.spl")).to_equal(true)
