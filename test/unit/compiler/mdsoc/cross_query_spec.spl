describe "Cross Query":
    it "skipped":
        skip("pre-existing test failures - functions/imports not available")

# # Tests for cross-dimension query.
# # Run with: bin/simple test test/unit/compiler/mdsoc/cross_query_spec.spl
# #
# # Tests for: src/compiler/85.mdsoc/mdsoc/cross_query.spl
# # Covers query_cross_dimension, query_by_construct, query_by_layer_range,
# # and internal helpers.
# 
# use compiler.mdsoc.types.*
# use compiler.mdsoc.cross_query.*
# 
# # ============================================================================
# # Helper: build test capsules
# # ============================================================================
# 
# fn make_trait_capsule() -> ConstructCapsule:
#     var cap = ConstructCapsule.new("trait", ConstructKind.Trait, ConstructTier.Advanced)
#     cap.exclusive_files = ["25.traits/traits.spl", "25.traits/solver.spl"]
#     var sb1 = SharedBinding.new("10.frontend/core/ast.spl", "func", 10)
#     sb1.construct_tags = ["func", "trait"]
#     var sb2 = SharedBinding.new("30.types/associated_types_phase4a.spl", "trait", 30)
#     cap.shared_bindings = [sb1, sb2]
#     cap
# 
# fn make_expr_capsule() -> ConstructCapsule:
#     var cap = ConstructCapsule.new("expr", ConstructKind.Expr, ConstructTier.Core)
#     cap.exclusive_files = ["10.frontend/core/parser_expr.spl"]
#     var sb1 = SharedBinding.new("50.mir/mir_instructions.spl", "expr", 50)
#     cap.shared_bindings = [sb1]
#     cap
# 
# fn make_func_capsule() -> ConstructCapsule:
#     var cap = ConstructCapsule.new("func", ConstructKind.Func, ConstructTier.Decl)
#     cap.exclusive_files = []
#     var sb1 = SharedBinding.new("10.frontend/core/ast.spl", "func", 10)
#     var sb2 = SharedBinding.new("70.backend/backend/c_backend.spl", "func", 70)
#     cap.shared_bindings = [sb1, sb2]
#     cap
# 
# # ============================================================================
# # query_cross_dimension — construct filter
# # ============================================================================
# 
# describe "query_cross_dimension construct filter":
#     it "returns only files from matched construct":
#         val manifest = MdsocManifest.new("proj")
#         val caps = [make_trait_capsule(), make_expr_capsule()]
#         val query = CrossDimensionQuery.for_construct("trait")
#         val result = query_cross_dimension(manifest, caps, query)
#         expect(result.has_results()).to_equal(true)
#         # trait capsule has 2 exclusive + 2 shared = 4 potential files
#         expect(result.total_count()).to_be_greater_than(0)
# 
#     it "non-matching construct returns empty":
#         val manifest = MdsocManifest.new("proj")
#         val caps = [make_trait_capsule()]
#         val query = CrossDimensionQuery.for_construct("asm")
#         val result = query_cross_dimension(manifest, caps, query)
#         expect(result.has_results()).to_equal(false)
# 
#     it "exclusive_count includes only exclusive files":
#         val manifest = MdsocManifest.new("proj")
#         val caps = [make_trait_capsule()]
#         val query = CrossDimensionQuery.for_construct("trait")
#         val result = query_cross_dimension(manifest, caps, query)
#         expect(result.exclusive_count).to_equal(2)
# 
#     it "shared_count includes shared bindings":
#         val manifest = MdsocManifest.new("proj")
#         val caps = [make_trait_capsule()]
#         val query = CrossDimensionQuery.for_construct("trait")
#         val result = query_cross_dimension(manifest, caps, query)
#         expect(result.shared_count).to_equal(2)
# 
#     it "total_count is exclusive + shared":
#         val manifest = MdsocManifest.new("proj")
#         val caps = [make_trait_capsule()]
#         val query = CrossDimensionQuery.for_construct("trait")
#         val result = query_cross_dimension(manifest, caps, query)
#         expect(result.total_count()).to_equal(result.exclusive_count + result.shared_count)
# 
# # ============================================================================
# # query_cross_dimension — no filter (all constructs)
# # ============================================================================
# 
# describe "query_cross_dimension no filter":
#     it "returns files from all capsules when no construct filter":
#         val manifest = MdsocManifest.new("proj")
#         val caps = [make_trait_capsule(), make_expr_capsule()]
#         val query = CrossDimensionQuery.new("", "", -1, 999)
#         val result = query_cross_dimension(manifest, caps, query)
#         expect(result.total_count()).to_be_greater_than(2)
# 
#     it "deduplicates shared files across capsules":
#         val manifest = MdsocManifest.new("proj")
#         # trait and func both share ast.spl
#         val caps = [make_trait_capsule(), make_func_capsule()]
#         val query = CrossDimensionQuery.new("", "", -1, 999)
#         val result = query_cross_dimension(manifest, caps, query)
#         # ast.spl should appear only once despite being in both capsules
#         var ast_count: i64 = 0
#         for f in result.matching_files:
#             if f == "10.frontend/core/ast.spl":
#                 ast_count = ast_count + 1
#         expect(ast_count).to_equal(1)
# 
# # ============================================================================
# # query_cross_dimension — layer range filter
# # ============================================================================
# 
# describe "query_cross_dimension layer range filter":
#     it "layer range filters out files outside range":
#         val manifest = MdsocManifest.new("proj")
#         val caps = [make_trait_capsule()]
#         # Only layer 25-30: should include 25.traits/ files and 30.types/ file
#         val query = CrossDimensionQuery.new("", "trait", 25, 30)
#         val result = query_cross_dimension(manifest, caps, query)
#         # trait exclusive: 25.traits/traits.spl (layer 25), solver.spl (layer 25)
#         # shared: ast.spl (layer 10) excluded, assoc4a (layer 30) included
#         expect(result.total_count()).to_be_greater_than(0)
# 
#     it "layer range 0-9 excludes higher-layer files":
#         val manifest = MdsocManifest.new("proj")
#         val caps = [make_trait_capsule()]
#         val query = CrossDimensionQuery.new("", "trait", 0, 9)
#         val result = query_cross_dimension(manifest, caps, query)
#         # trait files are at layer 25+ so none should match
#         expect(result.total_count()).to_equal(0)
# 
#     it "layer range 10-10 returns only layer 10 files":
#         val manifest = MdsocManifest.new("proj")
#         val caps = [make_expr_capsule()]
#         val query = CrossDimensionQuery.new("", "expr", 10, 10)
#         val result = query_cross_dimension(manifest, caps, query)
#         # expr exclusive: parser_expr.spl (layer 10) — included
#         # expr shared: mir_instructions.spl (layer 50) — excluded
#         expect(result.exclusive_count).to_equal(1)
#         expect(result.shared_count).to_equal(0)
# 
# # ============================================================================
# # query_cross_dimension — feature filter
# # ============================================================================
# 
# describe "query_cross_dimension feature filter":
#     it "feature filter includes files containing the feature string":
#         val manifest = MdsocManifest.new("proj")
#         val caps = [make_trait_capsule()]
#         val query = CrossDimensionQuery.new("traits", "trait", -1, 999)
#         val result = query_cross_dimension(manifest, caps, query)
#         # Only files with "traits" in path: 25.traits/traits.spl, 25.traits/solver.spl
#         for f in result.matching_files:
#             expect(f.contains("traits")).to_equal(true)
# 
#     it "empty feature filter matches all files":
#         val manifest = MdsocManifest.new("proj")
#         val caps = [make_expr_capsule()]
#         val query = CrossDimensionQuery.new("", "expr", -1, 999)
#         val result = query_cross_dimension(manifest, caps, query)
#         expect(result.total_count()).to_be_greater_than(0)
# 
#     it "non-matching feature filter returns empty":
#         val manifest = MdsocManifest.new("proj")
#         val caps = [make_trait_capsule()]
#         val query = CrossDimensionQuery.new("wasm_codegen", "trait", -1, 999)
#         val result = query_cross_dimension(manifest, caps, query)
#         expect(result.has_results()).to_equal(false)
# 
# # ============================================================================
# # query_by_construct convenience function
# # ============================================================================
# 
# describe "query_by_construct":
#     it "returns all files for named construct":
#         val caps = [make_trait_capsule(), make_expr_capsule()]
#         val result = query_by_construct(caps, "expr")
#         expect(result.has_results()).to_equal(true)
#         # expr has 1 exclusive + 1 shared = 2 files
#         expect(result.total_count()).to_equal(2)
# 
#     it "returns empty for unknown construct":
#         val caps = [make_trait_capsule()]
#         val result = query_by_construct(caps, "unknown_construct")
#         expect(result.has_results()).to_equal(false)
# 
# # ============================================================================
# # query_by_layer_range convenience function
# # ============================================================================
# 
# describe "query_by_layer_range":
#     it "returns all construct files in range":
#         val caps = [make_trait_capsule(), make_expr_capsule()]
#         # Layer range 10-10: parser_expr (10), ast (10)
#         val result = query_by_layer_range(caps, 10, 10)
#         expect(result.total_count()).to_be_greater_than(0)
# 
#     it "no files outside range":
#         val caps = [make_expr_capsule()]
#         # Layer 20-40: mir_instructions.spl (50) excluded, parser_expr (10) excluded
#         val result = query_by_layer_range(caps, 20, 40)
#         expect(result.total_count()).to_equal(0)
# 
# # ============================================================================
# # CrossDimensionResult properties
# # ============================================================================
# 
# describe "CrossDimensionResult from query":
#     it "empty() has no results":
#         val r = CrossDimensionResult.empty()
#         expect(r.has_results()).to_equal(false)
#         expect(r.total_count()).to_equal(0)
# 
#     it "total_count reflects matching_files length":
#         val caps = [make_trait_capsule()]
#         val result = query_by_construct(caps, "trait")
#         expect(result.total_count()).to_equal(result.matching_files.len())
