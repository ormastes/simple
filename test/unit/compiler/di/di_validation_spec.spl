# DI Constructor Injection Validation Specification
#
# Tests for dependency injection validation rules.
# Uses DiValidation struct: ok/error_kind/message

use compiler.di_validator.{ParamInfo, ConstructorInfo, DiValidation, validate_constructor}

describe "Constructor Injection Validation":

    it "accepts all params with @inject":
        val ctor = ConstructorInfo.create(
            "UserService",
            has_sys_inject: false,
            params: [
                ParamInfo.create("db", "Database", true),
                ParamInfo.create("cache", "Cache", true)
            ]
        )
        val result = validate_constructor(ctor)
        expect(result.ok).to_equal(true)
        expect(result.error_kind).to_equal("")

    it "accepts no params with @inject":
        val ctor = ConstructorInfo.create(
            "Config",
            has_sys_inject: false,
            params: [
                ParamInfo.create("name", "text", false),
                ParamInfo.create("value", "i64", false)
            ]
        )
        val result = validate_constructor(ctor)
        expect(result.ok).to_equal(true)

    it "accepts @sys.inject on class with no param annotations":
        val ctor = ConstructorInfo.create(
            "OrderService",
            has_sys_inject: true,
            params: [
                ParamInfo.create("repo", "OrderRepository", false),
                ParamInfo.create("payment", "PaymentService", false)
            ]
        )
        val result = validate_constructor(ctor)
        expect(result.ok).to_equal(true)
        expect(result.error_kind).to_equal("")

    it "rejects mixed injection":
        val ctor = ConstructorInfo.create(
            "UserService",
            has_sys_inject: false,
            params: [
                ParamInfo.create("db", "Database", true),
                ParamInfo.create("config", "Config", false)
            ]
        )
        val result = validate_constructor(ctor)
        expect(result.ok).to_equal(false)
        expect(result.error_kind).to_equal("MixedInjection")

    it "rejects mixing @sys.inject with @inject on params":
        val ctor = ConstructorInfo.create(
            "PaymentService",
            has_sys_inject: true,
            params: [
                ParamInfo.create("gateway", "Gateway", true),
                ParamInfo.create("logger", "Logger", false)
            ]
        )
        val result = validate_constructor(ctor)
        expect(result.ok).to_equal(false)
        expect(result.error_kind).to_equal("MixedAnnotations")

    it "accepts empty params":
        val ctor = ConstructorInfo.create(
            "EmptyService",
            has_sys_inject: false,
            params: []
        )
        val result = validate_constructor(ctor)
        expect(result.ok).to_equal(true)

    it "accepts @sys.inject with empty params":
        val ctor = ConstructorInfo.create(
            "Marker",
            has_sys_inject: true,
            params: []
        )
        val result = validate_constructor(ctor)
        expect(result.ok).to_equal(true)

    it "rejects when only some of three params have @inject":
        val ctor = ConstructorInfo.create(
            "Multi",
            has_sys_inject: false,
            params: [
                ParamInfo.create("a", "A", true),
                ParamInfo.create("b", "B", false),
                ParamInfo.create("c", "C", true)
            ]
        )
        val result = validate_constructor(ctor)
        expect(result.ok).to_equal(false)
        expect(result.error_kind).to_equal("MixedInjection")

    it "error message contains class name for MixedInjection":
        val ctor = ConstructorInfo.create(
            "BrokenService",
            has_sys_inject: false,
            params: [
                ParamInfo.create("a", "A", true),
                ParamInfo.create("b", "B", false)
            ]
        )
        val result = validate_constructor(ctor)
        expect(result.ok).to_equal(false)
        expect(result.message.contains("BrokenService")).to_equal(true)

    it "error message contains class name for MixedAnnotations":
        val ctor = ConstructorInfo.create(
            "AnnotatedService",
            has_sys_inject: true,
            params: [
                ParamInfo.create("dep", "Dep", true)
            ]
        )
        val result = validate_constructor(ctor)
        expect(result.ok).to_equal(false)
        expect(result.message.contains("AnnotatedService")).to_equal(true)
