# DI Runtime Specification
#
# Tests for the lazy DI runtime engine: factory registration,
# singleton caching, cascade forcing, and cycle detection.

use compiler.di_runtime.{di_register, di_resolve, di_reset, di_stats, di_is_registered, di_force_count, di_service_names}

describe "DI Runtime":

    describe "registration and resolution":
        it "registers and resolves an eager service":
            di_reset()
            di_register("svc_a", fn(): "hello_a", false)
            val result = di_resolve("svc_a")
            expect(result).to_equal("hello_a")

        it "registers and resolves a lazy service":
            di_reset()
            di_register("svc_b", fn(): "hello_b", true)
            val result = di_resolve("svc_b")
            expect(result).to_equal("hello_b")

        it "reports registered services":
            di_reset()
            di_register("svc_c", fn(): 42, false)
            expect(di_is_registered("svc_c")).to_equal(true)
            expect(di_is_registered("nonexistent")).to_equal(false)

    describe "singleton caching":
        it "returns the same instance on repeated resolve":
            di_reset()
            var call_count = 0
            di_register("cached", fn():
                call_count = call_count + 1
                "instance_{call_count}"
            , true)
            val first = di_resolve("cached")
            val second = di_resolve("cached")
            expect(first).to_equal(second)

        it "eager services are instantiated at registration":
            di_reset()
            di_register("eager_svc", fn(): "eager_val", false)
            # Should be cached already - no force needed
            val result = di_resolve("eager_svc")
            expect(result).to_equal("eager_val")

    describe "cascade forcing":
        it "forces transitive dependencies":
            di_reset()
            di_register("dep_c", fn(): "leaf_value", true)
            di_register("dep_b", fn():
                val c = di_resolve("dep_c")
                "b_uses_{c}"
            , true)
            di_register("dep_a", fn():
                val b = di_resolve("dep_b")
                "a_uses_{b}"
            , true)
            val result = di_resolve("dep_a")
            expect(result).to_equal("a_uses_b_uses_leaf_value")

    describe "cycle detection":
        it "detects circular dependencies":
            di_reset()
            di_register("cycle_a", fn():
                di_resolve("cycle_b")
            , true)
            di_register("cycle_b", fn():
                di_resolve("cycle_a")
            , true)
            # This should print an error and return nil instead of infinite loop
            val result = di_resolve("cycle_a")
            expect(result).to_equal(nil)

    describe "reset":
        it "clears all registered services":
            di_reset()
            di_register("temp", fn(): "temp_val", false)
            expect(di_is_registered("temp")).to_equal(true)
            di_reset()
            expect(di_is_registered("temp")).to_equal(false)

        it "resets force count":
            di_reset()
            di_register("lazy_svc", fn(): "val", true)
            di_resolve("lazy_svc")
            expect(di_force_count() > 0).to_equal(true)
            di_reset()
            expect(di_force_count()).to_equal(0)

    describe "stats":
        it "returns diagnostic info":
            di_reset()
            di_register("s1", fn(): "v1", true)
            di_register("s2", fn(): "v2", false)
            val info = di_stats()
            expect(info.contains("2 registered")).to_equal(true)

    describe "service_names":
        it "lists registered service names":
            di_reset()
            di_register("alpha", fn(): 1, true)
            di_register("beta", fn(): 2, false)
            val names = di_service_names()
            expect(names.len()).to_equal(2)

    describe "missing service":
        it "returns nil for unregistered service":
            di_reset()
            val result = di_resolve("nonexistent")
            expect(result).to_equal(nil)
