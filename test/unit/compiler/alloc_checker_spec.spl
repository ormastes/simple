use compiler.alloc_checker.{alloc_annotation_from_source, check_alloc_imports, alloc_check_error_new}

describe "AllocChecker":
    describe "alloc_annotation_from_source":
        it "detects @alloc in first line":
            val src = "# @alloc\nfn foo(): 1"
            val ann = alloc_annotation_from_source(src)
            expect(ann).to_equal("@alloc")

        it "detects @no_alloc in first line":
            val src = "# @no_alloc\nfn foo(): 1"
            val ann = alloc_annotation_from_source(src)
            expect(ann).to_equal("@no_alloc")

        it "returns empty for unannotated files":
            val src = "# Regular comment\nfn foo(): 1"
            val ann = alloc_annotation_from_source(src)
            expect(ann).to_equal("")

        it "returns empty for empty source":
            val ann = alloc_annotation_from_source("")
            expect(ann).to_equal("")

    describe "check_alloc_imports":
        it "returns no errors when alloc_allowed is true":
            val src = "use std.array.{push}\nfn foo(): 1"
            val errs = check_alloc_imports(src, true)
            expect(errs.len()).to_equal(0)

        it "returns errors when @alloc module imported in no-alloc mode":
            val src = "use std.array.{push}\nfn foo(): 1"
            val errs = check_alloc_imports(src, false)
            expect(errs.len()).to_be_greater_than(0)

        it "returns no errors for @no_alloc imports in no-alloc mode":
            val src = "use std.effects.{Effect}\nfn foo(): 1"
            val errs = check_alloc_imports(src, false)
            expect(errs.len()).to_equal(0)

        it "returns no errors for empty source":
            val errs = check_alloc_imports("", false)
            expect(errs.len()).to_equal(0)

        it "returns no errors for unknown module in no-alloc mode":
            val src = "use std.unknown_module.{thing}\nfn foo(): 1"
            val errs = check_alloc_imports(src, false)
            expect(errs.len()).to_equal(0)

    describe "alloc_check_error_new":
        it "creates error with correct message":
            val err = alloc_check_error_new("main.spl", "src/std/array.spl")
            expect(err.imported_module).to_equal("src/std/array.spl")

        it "creates error with correct file_path":
            val err = alloc_check_error_new("main.spl", "src/std/array.spl")
            expect(err.file_path).to_equal("main.spl")

        it "creates error with descriptive message":
            val err = alloc_check_error_new("main.spl", "src/std/array.spl")
            expect(err.message).to_contain("alloc module")
