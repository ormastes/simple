# SHB Cache Manager Test
#
# Verifies two-level hash optimization, stale detection,
# and dependency validation.

use compiler.shb.shb_types.{
    ShbModuleInterface, ShbFnEntry, ShbDependencyEntry, ShbParam,
    shb_module_interface_new, SHB_FLAG_PUB
}
use compiler.shb.shb_writer.{shb_write}
use compiler.shb.shb_reader.{ShbReader}
use compiler.shb.shb_hash.{shb_interface_hash}
use compiler.shb.shb_cache.{
    ShbCacheManager, ShbCacheConfig, ShbCacheResult, ShbBatchResult,
    ShbChangeEvent, shb_cache_config_default,
    compile_changed_to_shb, shb_batch_summary, shb_batch_has_interface_changes,
    SHB_CACHE_UNCHANGED, SHB_CACHE_BODY_ONLY, SHB_CACHE_INTERFACE, SHB_CACHE_NEW
}

describe "SHB Cache":
    describe "Cache Config":
        it "has default cache dir":
            val config = shb_cache_config_default()
            expect(config.cache_dir).to_equal(".build/headers")
            expect(config.enabled).to_equal(true)

    describe "Cache Manager":
        it "creates with defaults":
            val mgr = ShbCacheManager.with_defaults()
            expect(mgr.config.enabled).to_equal(true)

        it "converts source path to shb path":
            val mgr = ShbCacheManager.with_defaults()
            val shb_path = mgr.source_to_shb_path("src/app/cli/main.spl")
            expect(shb_path).to_contain("src_app_cli_main.shb")

    describe "Stale Detection":
        it "detects stale when no cache exists":
            val mgr = ShbCacheManager.with_defaults()
            val stale = mgr.is_dependency_stale("nonexistent.spl", 42)
            expect(stale).to_equal(true)

    describe "Dependency Validation":
        it "validates dependencies with matching hashes":
            val config = ShbCacheConfig(cache_dir: "/tmp/shb_test_deps", enabled: true)
            var mgr = ShbCacheManager.create(config)

            var iface = shb_module_interface_new(1, 2)
            iface.dependencies.push(ShbDependencyEntry(
                module_path: "dep_module.spl",
                interface_hash: 12345
            ))
            val shb_path = "/tmp/shb_test_deps/test_module.shb"
            shb_write(iface, shb_path)

            mgr.interface_hashes["dep_module.spl"] = 12345

            val valid = mgr.validate_dependencies(shb_path)
            expect(valid).to_equal(true)

        it "detects stale dependency with wrong hash":
            val config = ShbCacheConfig(cache_dir: "/tmp/shb_test_deps2", enabled: true)
            var mgr = ShbCacheManager.create(config)

            var iface = shb_module_interface_new(1, 2)
            iface.dependencies.push(ShbDependencyEntry(
                module_path: "dep2.spl",
                interface_hash: 99999
            ))
            val shb_path = "/tmp/shb_test_deps2/test2.shb"
            shb_write(iface, shb_path)

            mgr.interface_hashes["dep2.spl"] = 11111

            val valid = mgr.validate_dependencies(shb_path)
            expect(valid).to_equal(false)

    describe "Batch Processing":
        it "reports summary for empty batch":
            val config = ShbCacheConfig(cache_dir: "/tmp/shb_test_batch", enabled: true)
            val mgr = ShbCacheManager.create(config)
            var changes: [ShbChangeEvent] = []
            val result = compile_changed_to_shb(changes, mgr)
            expect(result.unchanged_count).to_equal(0)
            expect(result.error_count).to_equal(0)

        it "skips non-spl files":
            val config = ShbCacheConfig(cache_dir: "/tmp/shb_test_batch2", enabled: true)
            val mgr = ShbCacheManager.create(config)
            var changes: [ShbChangeEvent] = []
            changes.push(ShbChangeEvent(path: "readme.md", event_type: "modified"))
            val result = compile_changed_to_shb(changes, mgr)
            expect(result.unchanged_count).to_equal(0)
            expect(result.new_count).to_equal(0)

        it "skips deleted files":
            val config = ShbCacheConfig(cache_dir: "/tmp/shb_test_batch3", enabled: true)
            val mgr = ShbCacheManager.create(config)
            var changes: [ShbChangeEvent] = []
            changes.push(ShbChangeEvent(path: "foo.spl", event_type: "deleted"))
            val result = compile_changed_to_shb(changes, mgr)
            expect(result.unchanged_count).to_equal(0)

        it "detects interface changes in batch":
            val result = ShbBatchResult(
                results: [],
                unchanged_count: 2,
                body_only_count: 1,
                interface_changed_count: 1,
                new_count: 0,
                error_count: 0
            )
            expect(shb_batch_has_interface_changes(result)).to_equal(true)

        it "reports no interface changes when only body changed":
            val result = ShbBatchResult(
                results: [],
                unchanged_count: 3,
                body_only_count: 2,
                interface_changed_count: 0,
                new_count: 0,
                error_count: 0
            )
            expect(shb_batch_has_interface_changes(result)).to_equal(false)

        it "formats batch summary":
            val result = ShbBatchResult(
                results: [],
                unchanged_count: 5,
                body_only_count: 2,
                interface_changed_count: 1,
                new_count: 0,
                error_count: 0
            )
            val summary = shb_batch_summary(result)
            expect(summary).to_contain("5 unchanged")
            expect(summary).to_contain("2 body-only")
            expect(summary).to_contain("1 interface changed")
