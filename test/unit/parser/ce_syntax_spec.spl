# Computation Expression (CE) syntax spec
#
# Tests for F#-style ce NAME: block syntax and bind x = expr statements.
# The `ce NAME:` block desugars to a do-like block where `bind x = expr`
# stores the result of expr into x (or short-circuits on nil).

describe "ce block syntax":
    describe "basic ce block as expression":
        it "ce block returns last value":
            val result = ce option:
                val x = 10
                val y = 20
                x + y
            expect(result).to_equal(30)

        it "ce block with plain statements works":
            var side = 0
            val result = ce result:
                side = 7
                side * 3
            expect(result).to_equal(21)
            expect(side).to_equal(7)

    describe "bind statement in ce block":
        it "bind stores non-nil value":
            val result = ce option:
                bind x = "hello"
                x.len()
            expect(result).to_equal(5)

        it "bind chains two values":
            val result = ce option:
                bind x = 10
                bind y = 20
                x + y
            expect(result).to_equal(30)

        it "bind with nil short-circuits":
            var reached = false
            val result = ce result:
                bind x = nil
                reached = true
                x
            expect(reached).to_equal(false)

        it "bind result is nil when short-circuited":
            val result = ce option:
                bind x = nil
                "never"
            expect(result).to_be_nil()

    describe "bind with non-nil values passes through":
        it "bind passes text value":
            val result = ce option:
                bind name = "Alice"
                "Hello, {name}!"
            expect(result).to_equal("Hello, Alice!")

        it "bind passes integer value":
            val result = ce result:
                bind n = 42
                n * 2
            expect(result).to_equal(84)

    describe "nested ce blocks":
        it "nested ce blocks work independently":
            val inner = ce option:
                bind a = 5
                a + 1
            val outer = ce result:
                bind b = inner
                b * 10
            expect(outer).to_equal(60)
