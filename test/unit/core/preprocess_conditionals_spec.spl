#!/usr/bin/env simple

use core.ast.{ast_reset}
use core.parser.{parse_module, parser_has_errors}

fn pp_parse_ok(code: text) -> bool:
    ast_reset()
    parse_module(code, "pp_spec.spl")
    parser_has_errors() == false

describe "core preprocessor hash directives":
    it "supports #if/#else/#endif with trailing colon":
        val src = "#if true:\nfn selected() -> i64:\n    return 1\n#else:\nfn broken( -> i64:\n#endif:\nfn main() -> i64:\n    return selected()"
        expect(pp_parse_ok(src)).to_equal(true)

    it "supports #elif with trailing colon":
        val src = "#if false:\nfn broken_a( -> i64:\n#elif true:\nfn selected() -> i64:\n    return 2\n#else:\nfn broken_b( -> i64:\n#endif\nfn main() -> i64:\n    return selected()"
        expect(pp_parse_ok(src)).to_equal(true)

    it "supports parenthesized #if with trailing colon":
        val src = "#if (true):\nfn selected() -> i64:\n    return 7\n#else:\nfn broken( -> i64:\n#endif:\nfn main() -> i64:\n    return selected()"
        expect(pp_parse_ok(src)).to_equal(true)
