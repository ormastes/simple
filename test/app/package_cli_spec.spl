# Package CLI Commands - SSpec Tests
# Tests for: add, remove, update, install, list, tree, lock, cache

use std.spec.{check, check_msg}

extern fn rt_file_exists(path: text) -> bool
use std.spec.{check, check_msg}

extern fn rt_file_read_text(path: text) -> text
use std.spec.{check, check_msg}

extern fn rt_file_write_text(path: text, content: text) -> bool
use std.spec.{check, check_msg}

extern fn rt_dir_create(path: text, recursive: bool) -> bool
use std.spec.{check, check_msg}

extern fn rt_package_remove_dir_all(path: text) -> i32
use std.spec.{check, check_msg}

extern fn rt_env_cwd() -> text

use std.spec.{check, check_msg}

val test_dir = "/tmp/simple-test-pkg-cli"

use std.spec.{check, check_msg}

fn setup_test_project():
use std.spec.{check, check_msg}

    rt_dir_create(test_dir, true)
use std.spec.{check, check_msg}

    val manifest = "package:\n  name: test-project\n  version: 0.1.0\n\ndependencies:\n  http: ^1.0.0\n  json: ~2.0.0\n"
use std.spec.{check, check_msg}

    rt_file_write_text("{test_dir}/simple.sdn", manifest)

use std.spec.{check, check_msg}

fn cleanup_test_project():
use std.spec.{check, check_msg}

    rt_package_remove_dir_all(test_dir)

use std.spec.{check, check_msg}

describe "Package CLI - add command":
use std.spec.{check, check_msg}

    before_each:
use std.spec.{check, check_msg}

        setup_test_project()
use std.spec.{check, check_msg}

    after_each:
use std.spec.{check, check_msg}

        cleanup_test_project()

use std.spec.{check, check_msg}

    it "parses package@version spec":
use std.spec.{check, check_msg}

        # The add command should parse name@constraint format
use std.spec.{check, check_msg}

        val manifest = rt_file_read_text("{test_dir}/simple.sdn")
use std.spec.{check, check_msg}

        check(manifest.contains("dependencies:"))

use std.spec.{check, check_msg}

    it "detects existing dependencies":
use std.spec.{check, check_msg}

        val manifest = rt_file_read_text("{test_dir}/simple.sdn")
use std.spec.{check, check_msg}

        check(manifest.contains("http:"))

use std.spec.{check, check_msg}

    it "supports --dev flag for dev dependencies":
use std.spec.{check, check_msg}

        # Verify dev_dependencies section can be added
use std.spec.{check, check_msg}

        check(true)

use std.spec.{check, check_msg}

describe "Package CLI - remove command":
use std.spec.{check, check_msg}

    before_each:
use std.spec.{check, check_msg}

        setup_test_project()
use std.spec.{check, check_msg}

    after_each:
use std.spec.{check, check_msg}

        cleanup_test_project()

use std.spec.{check, check_msg}

    it "removes dependency from manifest":
use std.spec.{check, check_msg}

        val manifest = rt_file_read_text("{test_dir}/simple.sdn")
use std.spec.{check, check_msg}

        check(manifest.contains("http:"))
use std.spec.{check, check_msg}

        check(manifest.contains("json:"))

use std.spec.{check, check_msg}

    it "reports error for missing dependency":
use std.spec.{check, check_msg}

        # Removing non-existent package should fail
use std.spec.{check, check_msg}

        check(true)

use std.spec.{check, check_msg}

describe "Package CLI - list command":
use std.spec.{check, check_msg}

    before_each:
use std.spec.{check, check_msg}

        setup_test_project()
use std.spec.{check, check_msg}

    after_each:
use std.spec.{check, check_msg}

        cleanup_test_project()

use std.spec.{check, check_msg}

    it "reads dependencies from manifest":
use std.spec.{check, check_msg}

        val manifest = rt_file_read_text("{test_dir}/simple.sdn")
use std.spec.{check, check_msg}

        check(manifest.contains("http: ^1.0.0"))
use std.spec.{check, check_msg}

        check(manifest.contains("json: ~2.0.0"))

use std.spec.{check, check_msg}

    it "distinguishes dev from regular dependencies":
use std.spec.{check, check_msg}

        check(true)

use std.spec.{check, check_msg}

describe "Package CLI - lock command":
use std.spec.{check, check_msg}

    before_each:
use std.spec.{check, check_msg}

        setup_test_project()
use std.spec.{check, check_msg}

    after_each:
use std.spec.{check, check_msg}

        cleanup_test_project()

use std.spec.{check, check_msg}

    it "generates lockfile from manifest":
use std.spec.{check, check_msg}

        check(not rt_file_exists("{test_dir}/simple.lock"))

use std.spec.{check, check_msg}

    it "validates lockfile format":
use std.spec.{check, check_msg}

        val lock_content = "lockfile_version: 1\ngenerated: 2026-02-03\npackages |name, version, source, checksum, deps|\n  http, 1.0.0, registry, sha256:0000000000000000000000000000000000000000000000000000000000000000, []\n"
use std.spec.{check, check_msg}

        rt_file_write_text("{test_dir}/simple.lock", lock_content)
use std.spec.{check, check_msg}

        check(rt_file_exists("{test_dir}/simple.lock"))

use std.spec.{check, check_msg}

describe "Package CLI - cache command":
use std.spec.{check, check_msg}

    it "returns cache directory path":
use std.spec.{check, check_msg}

        # Cache dir should be ~/.simple/cache/
use std.spec.{check, check_msg}

        check(true)

use std.spec.{check, check_msg}

    it "handles empty cache gracefully":
use std.spec.{check, check_msg}

        check(true)

use std.spec.{check, check_msg}

describe "Package CLI - tree command":
use std.spec.{check, check_msg}

    before_each:
use std.spec.{check, check_msg}

        setup_test_project()
use std.spec.{check, check_msg}

    after_each:
use std.spec.{check, check_msg}

        cleanup_test_project()

use std.spec.{check, check_msg}

    it "reads project name and version":
use std.spec.{check, check_msg}

        val manifest = rt_file_read_text("{test_dir}/simple.sdn")
use std.spec.{check, check_msg}

        check(manifest.contains("name: test-project"))
use std.spec.{check, check_msg}

        check(manifest.contains("version: 0.1.0"))

use std.spec.{check, check_msg}

    it "lists top-level dependencies":
use std.spec.{check, check_msg}

        val manifest = rt_file_read_text("{test_dir}/simple.sdn")
use std.spec.{check, check_msg}

        check(manifest.contains("http:"))
use std.spec.{check, check_msg}

        check(manifest.contains("json:"))
