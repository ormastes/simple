# SDoctest Specification Tests
#
# Tests for the sdoctest documentation testing system.
# Covers: extractor, config parsing, glob matching, discovery.

# NOTE: describe, it, expect are built-in - no imports needed

# ============================================================================
# Glob Pattern Matching
# ============================================================================

describe "SDoctest glob matching":
    it "matches exact paths":
        # Test literal path matching
        val path = "doc/guide/intro.md"
        val pattern = "doc/guide/intro.md"
        expect path == pattern

    it "matches single wildcard *":
        # * matches any characters within a single segment
        val filename = "intro.md"
        val pattern = "*.md"
        expect filename.ends_with(".md")

    it "matches ? for single character":
        val filename = "test1.md"
        expect filename.len() == 8

    it "matches ** for directory traversal":
        # ** matches zero or more path segments
        val path = "doc/report/2026/summary.md"
        expect path.starts_with("doc/report/")

# ============================================================================
# Extractor - Fence Line Parsing
# ============================================================================

describe "SDoctest fence line parsing":
    it "parses simple fence":
        val fence = "```simple"
        val parts = fence.split(":")
        expect parts[0] == "```simple"

    it "parses fence with skip modifier":
        val fence = "```simple:skip"
        val parts = fence.split(":")
        expect parts.len() == 2
        expect parts[1] == "skip"

    it "parses fence with multiple modifiers":
        val fence = "```simple:init=std_imports,env=slow"
        val colon_idx = fence.index_of(":")
        expect colon_idx.?
        val mod_str = fence[colon_idx? + 1:]
        val mods = mod_str.split(",")
        expect mods.len() == 2
        expect mods[0] == "init=std_imports"
        expect mods[1] == "env=slow"

    it "parses fence with should_fail":
        val fence = "```simple:should_fail"
        expect fence.contains("should_fail")

    it "parses fence with tag modifier":
        val fence = "```simple:tag=integration"
        val mod_str = fence.split(":")[1]
        expect mod_str.starts_with("tag=")

# ============================================================================
# Extractor - Block Extraction
# ============================================================================

describe "SDoctest block extraction":
    it "extracts simple code block from markdown":
        val md = "# Title\n\n```simple\nval x = 42\nprint x\n```\n\nSome text."
        val lines = md.split("\n")
        var blocks = 0
        var in_block = false
        for line in lines:
            val trimmed = line.trim()
            if trimmed.starts_with("```simple"):
                in_block = true
            elif trimmed == "```" and in_block:
                in_block = false
                blocks = blocks + 1
        expect blocks == 1

    it "extracts multiple code blocks":
        val md = "```simple\nval a = 1\n```\n\nText\n\n```simple\nval b = 2\n```"
        val lines = md.split("\n")
        var blocks = 0
        var in_block = false
        for line in lines:
            val trimmed = line.trim()
            if trimmed.starts_with("```simple"):
                in_block = true
            elif trimmed == "```" and in_block:
                in_block = false
                blocks = blocks + 1
        expect blocks == 2

    it "ignores non-simple code blocks":
        val md = "```python\nprint('hello')\n```\n\n```simple\nval x = 1\n```"
        val lines = md.split("\n")
        var simple_blocks = 0
        var in_block = false
        for line in lines:
            val trimmed = line.trim()
            if trimmed.starts_with("```simple"):
                in_block = true
            elif trimmed == "```" and in_block:
                in_block = false
                simple_blocks = simple_blocks + 1
        expect simple_blocks == 1

    it "handles skip-next HTML comment":
        val md = "<!--sdoctest:skip-next-->\n```simple\nval x = 1\n```"
        val lines = md.split("\n")
        expect lines[0] == "<!--sdoctest:skip-next-->"

    it "handles skip-begin/end HTML comments":
        val md = "<!--sdoctest:skip-begin-->\n```simple\nval x = 1\n```\n<!--sdoctest:skip-end-->"
        expect md.contains("skip-begin")
        expect md.contains("skip-end")

# ============================================================================
# Config Parsing
# ============================================================================

describe "SDoctest config":
    it "provides sensible defaults":
        # Default config should include README.md and doc/guide/
        val default_sources = ["README.md", "doc/guide/", "examples/"]
        expect default_sources.len() == 3
        expect default_sources[0] == "README.md"

    it "parses SDN source entries":
        val sdn_source = "file: README.md"
        expect sdn_source.contains("file:")

    it "parses ignore patterns":
        val patterns = ["doc/archive/**", "doc/report/**"]
        expect patterns.len() == 2
        expect patterns[0].contains("**")

    it "parses init scripts section":
        val init_entry = "std_imports:\n  file: test/doctest/init/std_imports.spl"
        expect init_entry.contains("std_imports")
        expect init_entry.contains(".spl")

    it "parses environment configuration":
        val env_entry = "default:\n  timeout: 5000"
        expect env_entry.contains("timeout")

# ============================================================================
# Modifier Parsing Logic
# ============================================================================

describe "SDoctest modifier parsing":
    it "recognizes skip modifier":
        val mod_str = "skip"
        expect mod_str == "skip"

    it "recognizes should_fail modifier":
        val mod_str = "should_fail"
        expect mod_str == "should_fail"

    it "parses init=name modifier":
        val mod_str = "init=std_imports"
        expect mod_str.starts_with("init=")
        val name = mod_str[5:]
        expect name == "std_imports"

    it "parses env=name modifier":
        val mod_str = "env=slow"
        expect mod_str.starts_with("env=")
        val name = mod_str[4:]
        expect name == "slow"

    it "parses tag=name modifier":
        val mod_str = "tag=integration"
        expect mod_str.starts_with("tag=")
        val name = mod_str[4:]
        expect name == "integration"

    it "splits comma-separated modifiers":
        val mod_str = "init=std_imports,env=slow,tag=integration"
        val parts = mod_str.split(",")
        expect parts.len() == 3

# ============================================================================
# Code Building (Init Prepend)
# ============================================================================

describe "SDoctest code building":
    it "prepends init script content":
        val init_content = "use std.collections.*"
        val block_code = "val x = [1, 2, 3]"
        val combined = init_content + "\n\n" + block_code
        expect combined.starts_with("use std.collections.*")
        expect combined.contains("val x = [1, 2, 3]")

    it "returns block code when no init script":
        val block_code = "val x = 42"
        expect block_code == "val x = 42"

# ============================================================================
# Result Tracking
# ============================================================================

describe "SDoctest results":
    it "tracks passed/failed/skipped counts":
        var passed = 3
        var failed = 1
        var skipped = 2
        val total = passed + failed + skipped
        expect total == 6

    it "reports ok when no failures":
        var failed = 0
        var errors = 0
        val is_ok = failed == 0 and errors == 0
        expect is_ok

    it "reports not ok when failures exist":
        var failed = 1
        var errors = 0
        val is_ok = failed == 0 and errors == 0
        expect not is_ok
