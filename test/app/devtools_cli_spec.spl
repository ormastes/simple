# Dev Tools CLI Commands - SSpec Tests
# Tests for: targets, diff, migrate, watch, brief

use std.spec.{check, check_msg}

extern fn rt_file_exists(path: text) -> bool
use std.spec.{check, check_msg}

extern fn rt_file_read_text(path: text) -> text
use std.spec.{check, check_msg}

extern fn rt_file_write_text(path: text, content: text) -> bool
use std.spec.{check, check_msg}

extern fn rt_dir_create(path: text, recursive: bool) -> bool
use std.spec.{check, check_msg}

extern fn rt_package_remove_dir_all(path: text) -> i32

use std.spec.{check, check_msg}

val test_dir = "/tmp/simple-test-devtools-cli"

use std.spec.{check, check_msg}

fn cleanup():
use std.spec.{check, check_msg}

    rt_package_remove_dir_all(test_dir)

use std.spec.{check, check_msg}

describe "Dev Tools CLI - targets command":
use std.spec.{check, check_msg}

    it "lists tier 1 targets":
use std.spec.{check, check_msg}

        # Should include x86_64 and aarch64
use std.spec.{check, check_msg}

        check(true)

use std.spec.{check, check_msg}

    it "supports --json output":
use std.spec.{check, check_msg}

        check(true)

use std.spec.{check, check_msg}

describe "Dev Tools CLI - diff command":
use std.spec.{check, check_msg}

    before_each:
use std.spec.{check, check_msg}

        cleanup()
use std.spec.{check, check_msg}

        rt_dir_create(test_dir, true)
use std.spec.{check, check_msg}

    after_each:
use std.spec.{check, check_msg}

        cleanup()

use std.spec.{check, check_msg}

    it "detects identical files":
use std.spec.{check, check_msg}

        rt_file_write_text("{test_dir}/a.spl", "fn hello():\n    pass\n")
use std.spec.{check, check_msg}

        rt_file_write_text("{test_dir}/b.spl", "fn hello():\n    pass\n")
use std.spec.{check, check_msg}

        val a = rt_file_read_text("{test_dir}/a.spl")
use std.spec.{check, check_msg}

        val b = rt_file_read_text("{test_dir}/b.spl")
use std.spec.{check, check_msg}

        check(a == b)

use std.spec.{check, check_msg}

    it "detects differences between files":
use std.spec.{check, check_msg}

        rt_file_write_text("{test_dir}/a.spl", "fn hello():\n    pass\n")
use std.spec.{check, check_msg}

        rt_file_write_text("{test_dir}/b.spl", "fn hello():\n    print \"hello\"\n")
use std.spec.{check, check_msg}

        val a = rt_file_read_text("{test_dir}/a.spl")
use std.spec.{check, check_msg}

        val b = rt_file_read_text("{test_dir}/b.spl")
use std.spec.{check, check_msg}

        check(a != b)

use std.spec.{check, check_msg}

describe "Dev Tools CLI - migrate command":
use std.spec.{check, check_msg}

    before_each:
use std.spec.{check, check_msg}

        cleanup()
use std.spec.{check, check_msg}

        rt_dir_create(test_dir, true)
use std.spec.{check, check_msg}

    after_each:
use std.spec.{check, check_msg}

        cleanup()

use std.spec.{check, check_msg}

    it "migrates if let to if val":
use std.spec.{check, check_msg}

        val code = "fn test():\n    if let Some(x) = opt:\n        print x\n"
use std.spec.{check, check_msg}

        rt_file_write_text("{test_dir}/test.spl", code)
use std.spec.{check, check_msg}

        val content = rt_file_read_text("{test_dir}/test.spl")
use std.spec.{check, check_msg}

        check(content.contains("if let "))

use std.spec.{check, check_msg}

    it "migrates [] generics to <> syntax":
use std.spec.{check, check_msg}

        val code = "val opt: Option[Int] = Some(42)\n"
use std.spec.{check, check_msg}

        rt_file_write_text("{test_dir}/test.spl", code)
use std.spec.{check, check_msg}

        val content = rt_file_read_text("{test_dir}/test.spl")
use std.spec.{check, check_msg}

        check(content.contains("Option["))

use std.spec.{check, check_msg}

    it "supports --dry-run flag":
use std.spec.{check, check_msg}

        check(true)

use std.spec.{check, check_msg}

describe "Dev Tools CLI - brief command":
use std.spec.{check, check_msg}

    before_each:
use std.spec.{check, check_msg}

        cleanup()
use std.spec.{check, check_msg}

        rt_dir_create("{test_dir}/src", true)
use std.spec.{check, check_msg}

        rt_file_write_text("{test_dir}/simple.sdn", "package:\n  name: test\n  version: 0.1.0\n")
use std.spec.{check, check_msg}

        rt_file_write_text("{test_dir}/src/main.spl", "fn main():\n    print \"hello\"\n")
use std.spec.{check, check_msg}

    after_each:
use std.spec.{check, check_msg}

        cleanup()

use std.spec.{check, check_msg}

    it "reads project manifest":
use std.spec.{check, check_msg}

        val manifest = rt_file_read_text("{test_dir}/simple.sdn")
use std.spec.{check, check_msg}

        check(manifest.contains("name: test"))

use std.spec.{check, check_msg}

    it "scans source files":
use std.spec.{check, check_msg}

        check(rt_file_exists("{test_dir}/src/main.spl"))

use std.spec.{check, check_msg}

describe "Dev Tools CLI - watch command":
use std.spec.{check, check_msg}

    it "requires a path argument":
use std.spec.{check, check_msg}

        check(true)

use std.spec.{check, check_msg}

    it "supports --interval flag":
use std.spec.{check, check_msg}

        check(true)
