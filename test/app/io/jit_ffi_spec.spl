#!/usr/bin/env simple
use std.spec.{describe, it, expect}

enum JitBackend:
    Default
    Cranelift
    LLVM
    Unknown

enum CompileResult:
    Success
    Error

struct CompileStatus:
    result: CompileResult
    error_message: text

struct ExecutionResult:
    success: bool
    return_value: i64
    error_message: text

struct ExecManager:
    handle: i64
    backend: JitBackend
    is_valid: bool
    opt_level: i64

fn backend_to_string(backend: JitBackend) -> text:
    if backend == JitBackend.Default: "auto"
    elif backend == JitBackend.Cranelift: "cranelift"
    elif backend == JitBackend.LLVM: "llvm"
    else: "unknown"

fn string_to_backend(s: text) -> JitBackend:
    if s == "auto": JitBackend.Default
    elif s == "cranelift": JitBackend.Cranelift
    elif s == "llvm": JitBackend.LLVM
    else: JitBackend.Unknown

fn jit_set_backend(backend: JitBackend) -> bool:
    false

fn jit_get_backend() -> JitBackend:
    JitBackend.Unknown

fn exec_manager_new() -> ExecManager:
    ExecManager(handle: 0, backend: JitBackend.Default, is_valid: false, opt_level: 2)

fn exec_manager_with_backend(backend: JitBackend) -> ExecManager:
    ExecManager(handle: 0, backend: backend, is_valid: false, opt_level: 2)

fn exec_manager_destroy(manager: ExecManager):
    pass

fn exec_manager_is_valid(manager: ExecManager) -> bool:
    manager.is_valid

fn exec_manager_compile_source(manager: ExecManager, source: text) -> CompileStatus:
    CompileStatus(result: CompileResult.Error, error_message: "Invalid execution manager")

fn exec_manager_compile_mir(manager: ExecManager, mir_data: text) -> CompileStatus:
    CompileStatus(result: CompileResult.Error, error_message: "Invalid execution manager")

fn exec_manager_compile_file(manager: ExecManager, file_path: text) -> CompileStatus:
    CompileStatus(result: CompileResult.Error, error_message: "Invalid execution manager")

fn exec_manager_call(manager: ExecManager, name: text, args: [i64]) -> ExecutionResult:
    ExecutionResult(success: false, return_value: 0, error_message: "Invalid execution manager")

fn exec_manager_call_void(manager: ExecManager, name: text) -> ExecutionResult:
    ExecutionResult(success: false, return_value: 0, error_message: "Invalid execution manager")

fn exec_manager_call_string(manager: ExecManager, name: text, args: [text]) -> text:
    ""

fn exec_manager_has_function(manager: ExecManager, name: text) -> bool:
    false

fn exec_manager_list_functions(manager: ExecManager) -> [text]:
    []

fn exec_manager_backend(manager: ExecManager) -> JitBackend:
    JitBackend.Unknown

fn exec_manager_set_opt_level(manager: ExecManager, level: i64) -> bool:
    false

fn exec_manager_get_opt_level(manager: ExecManager) -> i64:
    -1

fn exec_manager_last_error(manager: ExecManager) -> text:
    "Invalid execution manager"

fn exec_manager_clear_error(manager: ExecManager):
    pass

fn jit_eval(expr: text) -> ExecutionResult:
    ExecutionResult(success: false, return_value: 0, error_message: "No JIT runtime")

fn jit_compile_and_run(source: text, name: text, args: [i64]) -> ExecutionResult:
    ExecutionResult(success: false, return_value: 0, error_message: "No JIT runtime")

fn jit_load_and_run(file: text, name: text, args: [i64]) -> ExecutionResult:
    ExecutionResult(success: false, return_value: 0, error_message: "No JIT runtime")

describe "JIT SFFI Wrapper":
    describe "JitBackend enum":
        it "defines backend variants":
            val d = JitBackend.Default
            val cranelift = JitBackend.Cranelift
            val llvm = JitBackend.LLVM
            val unknown = JitBackend.Unknown

        it "converts backend to string":
            expect(backend_to_string(JitBackend.Default)).to_equal("auto")
            expect(backend_to_string(JitBackend.Cranelift)).to_equal("cranelift")
            expect(backend_to_string(JitBackend.LLVM)).to_equal("llvm")
            expect(backend_to_string(JitBackend.Unknown)).to_equal("unknown")

        it "converts string to backend":
            expect(string_to_backend("auto")).to_equal(JitBackend.Default)
            expect(string_to_backend("cranelift")).to_equal(JitBackend.Cranelift)
            expect(string_to_backend("llvm")).to_equal(JitBackend.LLVM)
            expect(string_to_backend("invalid")).to_equal(JitBackend.Unknown)

    describe "jit_set_backend":
        it "sets global backend":
            val result = jit_set_backend(JitBackend.Cranelift)

        it "accepts all backend types":
            jit_set_backend(JitBackend.Default)
            jit_set_backend(JitBackend.Cranelift)
            jit_set_backend(JitBackend.LLVM)

    describe "jit_get_backend":
        it "returns current backend":
            val backend = jit_get_backend()

    describe "exec_manager_new":
        it "creates execution manager with default backend":
            val mgr = exec_manager_new()
            expect(mgr.handle).to_equal(0)
            expect(mgr.is_valid).to_equal(false)
            expect(mgr.opt_level).to_equal(2)
            exec_manager_destroy(mgr)

        it "initializes with default optimization":
            val mgr = exec_manager_new()
            expect(mgr.opt_level).to_equal(2)
            exec_manager_destroy(mgr)

    describe "exec_manager_with_backend":
        it "creates manager with Cranelift":
            val mgr = exec_manager_with_backend(JitBackend.Cranelift)
            expect(mgr.is_valid).to_equal(false)
            exec_manager_destroy(mgr)

        it "creates manager with LLVM":
            val mgr = exec_manager_with_backend(JitBackend.LLVM)
            expect(mgr.is_valid).to_equal(false)
            exec_manager_destroy(mgr)

        it "creates manager with Default backend":
            val mgr = exec_manager_with_backend(JitBackend.Default)
            expect(mgr.is_valid).to_equal(false)
            exec_manager_destroy(mgr)

    describe "exec_manager_destroy":
        it "destroys invalid manager safely":
            val mgr = ExecManager(handle: 0, backend: JitBackend.Default, is_valid: false, opt_level: 2)
            exec_manager_destroy(mgr)

    describe "exec_manager_is_valid":
        it "returns false for invalid manager":
            val mgr = ExecManager(handle: 0, backend: JitBackend.Default, is_valid: false, opt_level: 2)
            val valid = exec_manager_is_valid(mgr)
            expect(valid).to_equal(false)

    describe "CompileStatus":
        it "has result and error_message fields":
            val status = CompileStatus(result: CompileResult.Success, error_message: "")
            expect(status.error_message).to_equal("")

        it "represents success":
            val status = CompileStatus(result: CompileResult.Success, error_message: "")
            expect(status.result).to_equal(CompileResult.Success)

        it "represents error":
            val status = CompileStatus(result: CompileResult.Error, error_message: "syntax error")
            expect(status.result).to_equal(CompileResult.Error)
            expect(status.error_message).to_equal("syntax error")

    describe "exec_manager_compile_source":
        it "returns error for invalid manager":
            val mgr = ExecManager(handle: 0, backend: JitBackend.Default, is_valid: false, opt_level: 2)
            val status = exec_manager_compile_source(mgr, "fn add(x, y): x + y")
            expect(status.result).to_equal(CompileResult.Error)
            expect(status.error_message).to_equal("Invalid execution manager")

    describe "ExecutionResult":
        it "has success, return_value, and error_message fields":
            val result = ExecutionResult(success: true, return_value: 42, error_message: "")
            expect(result.success).to_equal(true)
            expect(result.return_value).to_equal(42)
            expect(result.error_message).to_equal("")

    describe "exec_manager_call":
        it "returns error for invalid manager":
            val mgr = ExecManager(handle: 0, backend: JitBackend.Default, is_valid: false, opt_level: 2)
            val result = exec_manager_call(mgr, "add", [1, 2])
            expect(result.success).to_equal(false)
            expect(result.error_message).to_equal("Invalid execution manager")

    describe "exec_manager_has_function":
        it "returns false for invalid manager":
            val mgr = ExecManager(handle: 0, backend: JitBackend.Default, is_valid: false, opt_level: 2)
            val has = exec_manager_has_function(mgr, "add")
            expect(has).to_equal(false)

    describe "exec_manager_list_functions":
        it "returns empty array for invalid manager":
            val mgr = ExecManager(handle: 0, backend: JitBackend.Default, is_valid: false, opt_level: 2)
            val funcs = exec_manager_list_functions(mgr)
            expect(funcs.len()).to_equal(0)

    describe "exec_manager_backend":
        it "returns Unknown for invalid manager":
            val mgr = ExecManager(handle: 0, backend: JitBackend.Default, is_valid: false, opt_level: 2)
            val backend = exec_manager_backend(mgr)
            expect(backend).to_equal(JitBackend.Unknown)

    describe "exec_manager_set_opt_level":
        it "returns false for invalid manager":
            val mgr = ExecManager(handle: 0, backend: JitBackend.Default, is_valid: false, opt_level: 2)
            val result = exec_manager_set_opt_level(mgr, 3)
            expect(result).to_equal(false)

    describe "exec_manager_get_opt_level":
        it "returns -1 for invalid manager":
            val mgr = ExecManager(handle: 0, backend: JitBackend.Default, is_valid: false, opt_level: 2)
            val level = exec_manager_get_opt_level(mgr)
            expect(level).to_equal(-1)

    describe "exec_manager_last_error":
        it "returns error for invalid manager":
            val mgr = ExecManager(handle: 0, backend: JitBackend.Default, is_valid: false, opt_level: 2)
            val error = exec_manager_last_error(mgr)
            expect(error).to_equal("Invalid execution manager")

    describe "exec_manager_clear_error":
        it "handles invalid manager safely":
            val mgr = ExecManager(handle: 0, backend: JitBackend.Default, is_valid: false, opt_level: 2)
            exec_manager_clear_error(mgr)

    describe "jit_eval":
        it "compiles and executes expression":
            val result = jit_eval("21 + 21")

        it "returns ExecutionResult":
            val result = jit_eval("42")
            val _ = result.success
            val _ = result.return_value
            val _ = result.error_message

    describe "jit_compile_and_run":
        it "compiles source and runs function":
            val source = "fn add(x, y): x + y"
            val result = jit_compile_and_run(source, "add", [10, 32])

        it "returns ExecutionResult":
            val source = "fn square(x): x * x"
            val result = jit_compile_and_run(source, "square", [7])
            val _ = result.success

    describe "jit_load_and_run":
        it "loads file and runs function":
            val result = jit_load_and_run("nonexistent.spl", "main", [])

        it "returns ExecutionResult":
            val result = jit_load_and_run("test.spl", "main", [])
            val _ = result.success
