# Mailbox Tests
#
# Tests for off-heap message queue.

# @skip
use app.interpreter.async_runtime.mailbox.{Mailbox, MailboxConfig, MailboxStats, MessageRef, MessagePriority, SendResult}

describe "Mailbox - Configuration":
    it "creates with default config":
        val mailbox = Mailbox.default()

        check(mailbox.config.capacity == 1000)
        check(mailbox.config.off_heap)
        check(not mailbox.config.priority_enabled)

    it "creates unbounded mailbox":
        val mailbox = Mailbox.unbounded()

        check(mailbox.config.capacity == 0)

    it "creates bounded mailbox":
        val config = MailboxConfig.bounded(500)
        val mailbox = Mailbox.new(config)

        check(mailbox.config.capacity == 500)

    it "creates priority-enabled mailbox":
        val config = MailboxConfig.with_priority()
        val mailbox = Mailbox.new(config)

        check(mailbox.config.priority_enabled)

describe "Mailbox - Send":
    it "sends normal message":
        var mailbox = Mailbox.default()
        val result = mailbox.send_normal(12345, 100, Some(1))

        check(result == SendResult.Success)
        check(mailbox.total_size() == 1)

    it "sends high priority message":
        var mailbox = Mailbox.new(MailboxConfig.with_priority())
        val result = mailbox.send_high(12345, 100, Some(1))

        check(result == SendResult.Success)
        check(mailbox.stats.high_priority_count == 1)

    it "rejects when queue full":
        var mailbox = Mailbox.new(MailboxConfig.bounded(2))

        mailbox.send_normal(1, 10, None)
        mailbox.send_normal(2, 10, None)
        val result = mailbox.send_normal(3, 10, None)

        check(result == SendResult.QueueFull)

    it "reserves space for high priority":
        var mailbox = Mailbox.new(MailboxConfig.bounded(10))

        # Fill most of the queue
        for i in 0..9:
            mailbox.send_normal(i, 10, None)

        # Normal fails, high succeeds
        val normal_result = mailbox.send_normal(100, 10, None)
        val high_result = mailbox.send_high(101, 10, None)

        check(normal_result == SendResult.QueueFull)
        check(high_result == SendResult.Success)

    it "rejects after close":
        var mailbox = Mailbox.default()
        mailbox.close()

        val result = mailbox.send_normal(1, 10, None)

        check(result == SendResult.MailboxClosed)

describe "Mailbox - Receive":
    it "receives in FIFO order":
        var mailbox = Mailbox.default()

        mailbox.send_normal(1, 10, None)
        mailbox.send_normal(2, 10, None)
        mailbox.send_normal(3, 10, None)

        val msg1 = mailbox.receive()
        val msg2 = mailbox.receive()

        check(msg1.?.id == 0)
        check(msg2.?.id == 1)

    it "receives by priority order":
        var mailbox = Mailbox.new(MailboxConfig.with_priority())

        # Send in mixed order
        mailbox.send(3, 10, None, MessagePriority.Low)
        mailbox.send(2, 10, None, MessagePriority.Normal)
        mailbox.send(1, 10, None, MessagePriority.High)

        # Should receive high first
        val msg = mailbox.receive()
        check(msg.?.priority == MessagePriority.High)

    it "returns None when empty":
        var mailbox = Mailbox.default()
        val msg = mailbox.receive()

        check(not msg.?)

    it "updates stats on receive":
        var mailbox = Mailbox.default()
        mailbox.send_normal(1, 100, None)
        mailbox.receive()

        val stats = mailbox.get_stats()
        check(stats.total_processed == 1)
        check(stats.off_heap_bytes == 0)

describe "Mailbox - Selective Receive":
    it "selects by predicate":
        var mailbox = Mailbox.default()

        mailbox.send_normal(100, 10, Some(1))
        mailbox.send_normal(200, 20, Some(2))
        mailbox.send_normal(300, 30, Some(1))

        # Select message from sender 2
        val msg = mailbox.select(\m: m.sender_id == Some(2))

        check(msg.?)
        check(msg.unwrap().sender_id == Some(2))
        check(mailbox.total_size() == 2  # Other messages remain)

    it "selects by sender":
        var mailbox = Mailbox.default()

        mailbox.send_normal(100, 10, Some(5))
        mailbox.send_normal(200, 20, Some(10))

        val msg = mailbox.select_by_sender(10)

        check(msg.?)
        check(msg.unwrap().sender_id == Some(10))

    it "returns None when no match":
        var mailbox = Mailbox.default()
        mailbox.send_normal(100, 10, Some(1))

        val msg = mailbox.select(\m: m.sender_id == Some(999))

        check(not msg.?)
        check(mailbox.total_size() == 1  # Message still there)

describe "Mailbox - Management":
    it "clears all messages":
        var mailbox = Mailbox.default()

        mailbox.send_normal(1, 10, None)
        mailbox.send_normal(2, 10, None)
        mailbox.clear()

        check(mailbox.is_empty())
        check(mailbox.stats.current_size == 0)

    it "drops stale messages":
        var mailbox = Mailbox.default()

        # Send messages (they'll have timestamp 0 from placeholder)
        mailbox.send_normal(1, 10, None)
        mailbox.send_normal(2, 10, None)

        # Drop messages older than -1 (all of them)
        val dropped = mailbox.drop_stale(-1)

        check(dropped == 2)
        check(mailbox.is_empty())

    it "closes mailbox":
        var mailbox = Mailbox.default()
        mailbox.send_normal(1, 10, None)

        mailbox.close()

        check(mailbox.is_closed)
        # Can still receive existing messages
        val msg = mailbox.receive()
        check(msg.?)

describe "Mailbox - Queries":
    it "reports size":
        var mailbox = Mailbox.default()

        check(mailbox.total_size() == 0)
        mailbox.send_normal(1, 10, None)
        check(mailbox.total_size() == 1)

    it "reports empty status":
        var mailbox = Mailbox.default()

        check(mailbox.is_empty())
        mailbox.send_normal(1, 10, None)
        check(not mailbox.is_empty())

    it "reports full status":
        var mailbox = Mailbox.new(MailboxConfig.bounded(2))

        check(not mailbox.is_full())
        mailbox.send_normal(1, 10, None)
        mailbox.send_normal(2, 10, None)
        check(mailbox.is_full())

describe "Mailbox - Statistics":
    it "tracks throughput":
        var mailbox = Mailbox.default()

        mailbox.send_normal(1, 10, None)
        mailbox.send_normal(2, 10, None)
        mailbox.receive()

        val stats = mailbox.get_stats()
        val throughput = stats.throughput()

        check(throughput == 0.5 ) # 1 processed / 2 received)

    it "tracks drop rate":
        var mailbox = Mailbox.new(MailboxConfig.bounded(1))

        mailbox.send_normal(1, 10, None)
        mailbox.send_normal(2, 10, None)  # Dropped

        val stats = mailbox.get_stats()
        val drop_rate = stats.drop_rate()

        check(drop_rate == 50.0 ) # 1 dropped / 2 attempted)

    it "tracks peak size":
        var mailbox = Mailbox.default()

        mailbox.send_normal(1, 10, None)
        mailbox.send_normal(2, 10, None)
        mailbox.send_normal(3, 10, None)
        mailbox.receive()
        mailbox.receive()

        val stats = mailbox.get_stats()
        check(stats.peak_size == 3)

describe "MessagePriority - Ordering":
    it "compares priorities":
        check(MessagePriority.High.cmp(MessagePriority.Normal) < 0)
        check(MessagePriority.Normal.cmp(MessagePriority.Low) < 0)
        check(MessagePriority.Low.cmp(MessagePriority.High) > 0)

    it "converts to i64":
        check(MessagePriority.High.to_i64() == 0)
        check(MessagePriority.Normal.to_i64() == 1)
        check(MessagePriority.Low.to_i64() == 2)

describe "MessageRef - Age":
    it "calculates message age":
        val msg = MessageRef.new(1, None, MessagePriority.Normal, 100, 0)
        # With placeholder current_time_ms() returning 0, age is 0
        check(msg.age_ms() == 0)

    it "checks staleness":
        val msg = MessageRef.new(1, None, MessagePriority.Normal, 100, 0)
        # Message with age 0 is not stale for positive threshold
        check(not msg.is_stale(1000))
        # But is stale for negative threshold
        check(msg.is_stale(-1))

describe "Mailbox - Display":
    it "formats mailbox for display":
        val mailbox = Mailbox.default()
        val str = mailbox.fmt()

        check(str.contains("Mailbox"))
        check(str.contains("size=0"))

    it "formats stats for display":
        val stats = MailboxStats.new()
        val str = stats.fmt()

        check(str.contains("MailboxStats"))
