# Control Flow Module Tests
#
# Tests for the interpreter control flow module implementations:
# - loops.spl: for/while/loop evaluation
# - conditional.spl: if/else evaluation
# - match.spl: pattern matching evaluation

# @skip - Uses unsupported keyword: with
use std.spec


# ============================================================================
# Test Group 1: For Loop Evaluation (eval_for)
# ============================================================================

describe "eval_for":
    """
    ## For Loop Evaluation

    Tests for the eval_for function in loops.spl.
    Verifies iterator creation, scope handling, and control flow signals.
    """

    context "iterable evaluation":
        """
        ### Scenario: Iterable Initialization

        Tests that the iterable expression is evaluated before loop execution.
        """

        it "evaluates iterable before loop":
            var result = 0
            val items = [1, 2, 3]
            for x in items:
                result = result + x
            expect result == 6

        it "evaluates range expression":
            var sum = 0
            for i in 1..5:
                sum = sum + i
            expect sum == 10

    context "loop variable scope":
        """
        ### Scenario: Loop Variable Scoping

        Tests that loop variables are properly scoped.
        """

        it "creates new scope for loop variable":
            val x = 100
            for x in [1, 2, 3]:
                pass
            expect x == 100

        it "binds loop variable for each iteration":
            var last = 0
            for i in [5, 10, 15]:
                last = i
            expect last == 15

    context "control flow signals":
        """
        ### Scenario: Break and Continue

        Tests break and continue control flow within for loops.
        """

        it "handles break with value":
            var count = 0
            for i in 0..10:
                count = count + 1
                if i == 5:
                    break
            expect count == 6

        it "handles continue signal":
            var sum = 0
            for i in 0..5:
                if i == 2:
                    continue
                sum = sum + i
            expect sum == 8


# ============================================================================
# Test Group 2: While Loop Evaluation (eval_while)
# ============================================================================

describe "eval_while":
    """
    ## While Loop Evaluation

    Tests for the eval_while function in loops.spl.
    Verifies condition checking and iteration control.
    """

    context "condition evaluation":
        """
        ### Scenario: Condition Checking

        Tests that condition is checked before each iteration.
        """

        it "checks condition before each iteration":
            var i = 0
            var count = 0
            while i < 3:
                count = count + 1
                i = i + 1
            expect count == 3

        it "does not execute body if condition is false":
            var executed = false
            while false:
                executed = true
            expect not executed

    context "control flow signals":
        """
        ### Scenario: Control Flow in While

        Tests break and continue in while loops.
        """

        it "handles continue signal":
            var sum = 0
            var i = 0
            while i < 5:
                i = i + 1
                if i == 3:
                    continue
                sum = sum + i
            expect sum == 12

        it "handles break signal":
            var count = 0
            while true:
                count = count + 1
                if count == 5:
                    break
            expect count == 5


# ============================================================================
# Test Group 3: Infinite Loop Evaluation (eval_loop)
# ============================================================================

describe "eval_loop":
    """
    ## Infinite Loop Evaluation

    Tests for infinite loops that require break to exit.
    """

    context "break signal":
        """
        ### Scenario: Breaking from Loop

        Tests that loop exits only on break signal.
        """

        it "breaks on Break signal":
            var iterations = 0
            loop:
                iterations = iterations + 1
                if iterations >= 3:
                    break
            expect iterations == 3

        it "can break with computed condition":
            var n = 10
            loop:
                n = n - 1
                if n == 0:
                    break
            expect n == 0


# ============================================================================
# Test Group 4: If/Else Evaluation (eval_if)
# ============================================================================

describe "eval_if":
    """
    ## Conditional Expression Evaluation

    Tests for if/else evaluation in conditional.spl.
    """

    context "condition evaluation":
        """
        ### Scenario: Truthy/Falsy Evaluation

        Tests condition evaluation for truthy/falsy values.
        """

        it "evaluates true condition":
            val result = if true: 1 else: 0
            expect result == 1

        it "evaluates false condition":
            val result = if false: 1 else: 0
            expect result == 0

        it "evaluates comparison expression":
            val x = 10
            val result = if x > 5: 1 else: 0
            expect result == 1

    context "branch execution":
        """
        ### Scenario: Branch Selection

        Tests that correct branch is executed.
        """

        it "executes then branch when true":
            var executed = "none"
            if true:
                executed = "then"
            else:
                executed = "else"
            expect executed == "then"

        it "executes else branch when false":
            var executed = "none"
            if false:
                executed = "then"
            else:
                executed = "else"
            expect executed == "else"


# ============================================================================
# Test Group 5: Match Expression Evaluation (eval_match)
# ============================================================================

describe "eval_match":
    """
    ## Pattern Match Evaluation

    Tests for pattern matching in match.spl.
    """

    context "tuple matching":
        """
        ### Scenario: Tuple Pattern Binding

        Tests tuple pattern matching and variable binding.
        """

        it "matches tuple and binds variables":
            val t = (1, 2)
            val result = match t:
                case (1, x): x * 10
                case _: 0
            expect result == 20

        it "uses wildcard for unmatched patterns":
            val t = (5, 5)
            val result = match t:
                case (1, x): x
                case _: 99
            expect result == 99

    context "array matching":
        """
        ### Scenario: Array Pattern Binding

        Tests array pattern matching.
        """

        it "matches array and binds elements":
            val arr = [5, 10]
            val result = match arr:
                case [a, b]: a + b
                case _: 0
            expect result == 15

        it "handles array length mismatch":
            val arr = [1, 2, 3]
            val result = match arr:
                case [a, b]: a + b
                case _: -1
            expect result == -1


# ============================================================================
# Test Group 6: Integration Tests
# ============================================================================

describe "Control Flow Integration":
    """
    ## Combined Control Flow Tests

    Tests for combining multiple control flow constructs.
    """

    it "nests for inside while":
        var sum = 0
        var outer = 0
        while outer < 2:
            for i in 0..3:
                sum = sum + 1
            outer = outer + 1
        expect sum == 6

    it "nests if inside for":
        var evens = 0
        for i in 0..10:
            if i % 2 == 0:
                evens = evens + 1
        expect evens == 5

    it "combines match with for":
        var sum = 0
        val items = [(1, 10), (2, 20), (3, 30)]
        for item in items:
            val add = match item:
                case (1, x): x
                case (2, x): x * 2
                case _: 0
            sum = sum + add
        expect sum == 50
