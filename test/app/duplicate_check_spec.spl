# Tests for duplicate-check command

use std.spec.*
use app.duplicate_check.config.{DuplicationConfig}
use app.duplicate_check.tokenizer.{tokenize, SimpleToken, SimpleTokenKind}
use app.duplicate_check.detector.{collect_files}
use app.duplicate_check.formatter.{print_text_report}
use app.duplicate_check.features.{extract_token_frequencies, build_feature_vector, cosine_similarity}
use app.build.duplication.{DuplicationCheckConfig, run_duplication_check, default_duplication_config}

describe "duplicate-check config":
    it "loads default config":
        val config = DuplicationConfig(
            min_tokens: 30,
            min_lines: 5,
            ignore_identifiers: true,
            ignore_literals: false,
            ignore_comments: true,
            ignore_whitespace: true,
            similarity_threshold: 0.85,
            output_format: "text",
            report_path: "doc/analysis/duplicate_db.sdn",
            max_allowed: 0,
            min_impact: 50,
            exclude_patterns: ["test/"],
            use_ast_features: false,
            use_cosine_similarity: false
        )
        expect(config.min_tokens).to_equal(30)
        expect(config.min_lines).to_equal(5)
        expect(config.ignore_identifiers).to_equal(true)

describe "duplicate-check tokenizer":
    it "tokenizes simple code":
        val source = "fn test(): x + 1"
        val config = DuplicationConfig(
            min_tokens: 30,
            min_lines: 5,
            ignore_identifiers: false,
            ignore_literals: false,
            ignore_comments: true,
            ignore_whitespace: true,
            similarity_threshold: 0.85,
            output_format: "text",
            report_path: "doc/analysis/duplicate_db.sdn",
            max_allowed: 0,
            min_impact: 50,
            exclude_patterns: [],
            use_ast_features: false,
            use_cosine_similarity: false
        )
        val tokens = tokenize(source, config)
        expect(tokens.len()).to_be_greater_than(0)

    it "normalizes identifiers when configured":
        val source = "var count = 0"
        val config_norm = DuplicationConfig(
            min_tokens: 30,
            min_lines: 5,
            ignore_identifiers: true,
            ignore_literals: false,
            ignore_comments: true,
            ignore_whitespace: true,
            similarity_threshold: 0.85,
            output_format: "text",
            report_path: "doc/analysis/duplicate_db.sdn",
            max_allowed: 0,
            min_impact: 50,
            exclude_patterns: [],
            use_ast_features: false,
            use_cosine_similarity: false
        )
        val tokens_norm = tokenize(source, config_norm)
        var has_identifier_token = false
        for token in tokens_norm:
            if token.value == "IDENTIFIER":
                has_identifier_token = true
                break
        expect(has_identifier_token).to_equal(true)

describe "duplicate-check detector":
    it "collects files from directory":
        val config = DuplicationConfig(
            min_tokens: 30,
            min_lines: 5,
            ignore_identifiers: true,
            ignore_literals: false,
            ignore_comments: true,
            ignore_whitespace: true,
            similarity_threshold: 0.85,
            output_format: "text",
            report_path: "doc/analysis/duplicate_db.sdn",
            max_allowed: 0,
            min_impact: 50,
            exclude_patterns: [],
            use_ast_features: false,
            use_cosine_similarity: false
        )
        val files = collect_files("src/app/duplicate_check/", config)
        expect(files.len()).to_be_greater_than(0)

    it "excludes files by pattern":
        val config = DuplicationConfig(
            min_tokens: 30,
            min_lines: 5,
            ignore_identifiers: true,
            ignore_literals: false,
            ignore_comments: true,
            ignore_whitespace: true,
            similarity_threshold: 0.85,
            output_format: "text",
            report_path: "doc/analysis/duplicate_db.sdn",
            max_allowed: 0,
            min_impact: 50,
            exclude_patterns: ["spec"],
            use_ast_features: false,
            use_cosine_similarity: false
        )
        val files = collect_files("test/app/", config)
        var has_spec_file = false
        for file in files:
            if file.contains("spec"):
                has_spec_file = true
                break
        expect(has_spec_file).to_equal(false)

describe "duplicate-check features":
    it "extracts token frequencies":
        val tokens = [
            SimpleToken(kind: SimpleTokenKind.Keyword, value: "fn", line: 1, column: 1),
            SimpleToken(kind: SimpleTokenKind.Identifier, value: "test", line: 1, column: 4),
            SimpleToken(kind: SimpleTokenKind.Identifier, value: "test", line: 1, column: 9)
        ]

        val freq_map = extract_token_frequencies(tokens, 0, 3)

        val fn_key = "SimpleTokenKind::Keyword:fn"
        val id_key = "SimpleTokenKind::Identifier:test"

        expect(freq_map[fn_key]).to_equal(1)
        expect(freq_map[id_key]).to_equal(2)

    it "builds feature vector with normalized weights":
        var freq_map = {}
        freq_map["SimpleTokenKind::Keyword:fn"] = 1
        freq_map["SimpleTokenKind::Identifier:test"] = 2

        val feature_vec = build_feature_vector(0, freq_map)

        val fn_weight = feature_vec.features["SimpleTokenKind::Keyword:fn"]
        val id_weight = feature_vec.features["SimpleTokenKind::Identifier:test"]

        expect(fn_weight).to_be_greater_than(0.0)
        expect(id_weight).to_be_greater_than(0.0)
        expect(feature_vec.magnitude).to_be_greater_than(0.0)

    it "computes cosine similarity for identical vectors":
        var freq_map = {}
        freq_map["SimpleTokenKind::Keyword:fn"] = 1
        freq_map["SimpleTokenKind::Identifier:test"] = 2

        val vector1 = build_feature_vector(0, freq_map)
        val vector2 = build_feature_vector(1, freq_map)

        val similarity = cosine_similarity(vector1, vector2)

        expect(similarity).to_be_greater_than(0.99)

    it "computes cosine similarity for different vectors":
        var freq_map1 = {}
        freq_map1["SimpleTokenKind::Keyword:fn"] = 1
        freq_map1["SimpleTokenKind::Identifier:test"] = 2

        var freq_map2 = {}
        freq_map2["SimpleTokenKind::Keyword:var"] = 1
        freq_map2["SimpleTokenKind::Identifier:count"] = 1

        val vector1 = build_feature_vector(0, freq_map1)
        val vector2 = build_feature_vector(1, freq_map2)

        val similarity = cosine_similarity(vector1, vector2)

        expect(similarity).to_be_less_than(1.0)

    it "handles empty vectors":
        var empty_map = {}

        var freq_map = {}
        freq_map["SimpleTokenKind::Keyword:fn"] = 1

        val vector1 = build_feature_vector(0, empty_map)
        val vector2 = build_feature_vector(1, freq_map)

        val similarity = cosine_similarity(vector1, vector2)

        expect(similarity).to_equal(0.0)

describe "duplicate-check build integration":
    it "has default configuration":
        val config = default_duplication_config()
        expect(config.enabled).to_equal(true)
        expect(config.min_tokens).to_equal(30)
        expect(config.min_lines).to_equal(5)

    it "runs without errors when no duplicates":
        val config = DuplicationCheckConfig(
            enabled: true,
            fail_on_duplicates: false,
            max_allowed: 0,
            min_tokens: 50,
            min_lines: 10,
            min_impact: 200,
            report_path: "doc/analysis/duplicate_db.sdn"
        )
        val result = run_duplication_check(config)
        expect(result.exit_code).to_equal(0)
