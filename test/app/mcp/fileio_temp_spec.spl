# Temporary File Manager Tests
# Tests session management, cleanup, and temp directory isolation

use app.mcp.fileio_temp (TempManager, create_temp_manager)

describe "Temporary File Manager":

    describe "Session Management":

        it "creates new session with timestamp ID":
            val manager = create_temp_manager(".fileio_temp_test", "session_", true, 24)
            val session = manager.create_session()

            check(session.session_id.starts_with("session_"))
            check(session.base_dir.contains(".fileio_temp_test"))

        it "reuses current session":
            val manager = create_temp_manager(".fileio_temp_test", "session_", true, 24)
            val session1 = manager.get_session()
            val session2 = manager.get_session()

            check(session1.session_id == session2.session_id)

        it "creates session directory on init":
            val manager = create_temp_manager(".fileio_temp_test2", "sess_", true, 24)
            val session = manager.get_session()

            # Just check session was created
            check(session.session_id.len() > 0)

        it "tracks temp files in session":
            val manager = create_temp_manager(".fileio_temp_test3", "session_", true, 24)
            val path1 = manager.get_temp_path("file1.txt")
            val path2 = manager.get_temp_path("file2.txt")

            val files = manager.list_temp_files()
            check(files.len() == 2)
            check(files.contains(path1))
            check(files.contains(path2))

        it "generates unique temp paths for files":
            val manager = create_temp_manager(".fileio_temp_test4", "session_", true, 24)
            val path1 = manager.get_temp_path("original/path/file.txt")
            val path2 = manager.get_temp_path("other/file.txt")

            check(path1.contains("file.txt"))
            check(path2.contains("file.txt"))
            check(path1 != path2)

    describe "Cleanup":

        it "cleans up current session":
            val manager = create_temp_manager(".fileio_temp_test5", "session_", true, 24)
            val session = manager.get_session()

            manager.cleanup_session()

            # Session should be reset
            check(true)

        it "resets current session after cleanup":
            val manager = create_temp_manager(".fileio_temp_test6", "session_", true, 24)
            val session1 = manager.get_session()
            manager.cleanup_session()
            val session2 = manager.get_session()

            check(session1.session_id != session2.session_id)

        it "cleans up old sessions based on age":
            val manager = create_temp_manager(".fileio_temp_test7", "session_", true, 1)

            # Create session
            val session1 = manager.create_session()

            # Trigger cleanup
            manager.cleanup_old_sessions()

            # Just verify no crash
            check(true)

        it "lists all session directories":
            val manager = create_temp_manager(".fileio_temp_test8", "session_", true, 24)
            manager.create_session()

            val sessions = manager.list_sessions()
            check(sessions.len() >= 1)

    describe "Temp Directory":

        it "returns current session temp dir":
            val manager = create_temp_manager(".fileio_temp_test9", "session_", true, 24)
            val temp_dir = manager.get_temp_dir()

            check(temp_dir.contains(".fileio_temp_test9"))
            check(temp_dir.contains("session_"))

        it "creates base directory if missing":
            val manager = create_temp_manager(".fileio_temp_new", "session_", true, 24)

            # Base directory should be created on init
            check(true)

    describe "Edge Cases":

        it "handles empty file list":
            val manager = create_temp_manager(".fileio_temp_test10", "session_", true, 24)
            val files = manager.list_temp_files()

            # No temp paths requested yet
            check(files.len() == 0)

        it "handles cleanup with no session":
            val manager = create_temp_manager(".fileio_temp_test11", "session_", false, 24)
            # Don't create session
            manager.cleanup_session()  # Should not crash

            check(true)

        it "handles duplicate temp path requests":
            val manager = create_temp_manager(".fileio_temp_test12", "session_", true, 24)
            val path1 = manager.get_temp_path("file.txt")
            val path2 = manager.get_temp_path("file.txt")

            check(path1 == path2)
            val files = manager.list_temp_files()
            check(files.len() == 1)
