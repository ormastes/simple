# Temporary File Manager Tests
# Tests session management, cleanup, and temp directory isolation

use app.mcp.fileio_temp (TempManager, create_temp_manager)

describe "Temporary File Manager":

    describe "Session Management":

        it "creates new session with timestamp ID":
            val manager = create_temp_manager(".fileio_temp_test", "session_", true, 24)
            val session = manager.create_session()

            assert session.session_id.starts_with("session_")
            assert session.base_dir.contains(".fileio_temp_test")

        it "reuses current session":
            val manager = create_temp_manager(".fileio_temp_test", "session_", true, 24)
            val session1 = manager.get_session()
            val session2 = manager.get_session()

            assert session1.session_id == session2.session_id

        it "creates session directory on init":
            val manager = create_temp_manager(".fileio_temp_test2", "sess_", true, 24)
            val session = manager.get_session()

            # Just check session was created
            assert session.session_id.len() > 0

        it "tracks temp files in session":
            val manager = create_temp_manager(".fileio_temp_test3", "session_", true, 24)
            val path1 = manager.get_temp_path("file1.txt")
            val path2 = manager.get_temp_path("file2.txt")

            val files = manager.list_temp_files()
            assert files.len() == 2
            assert files.contains(path1)
            assert files.contains(path2)

        it "generates unique temp paths for files":
            val manager = create_temp_manager(".fileio_temp_test4", "session_", true, 24)
            val path1 = manager.get_temp_path("original/path/file.txt")
            val path2 = manager.get_temp_path("other/file.txt")

            assert path1.contains("file.txt")
            assert path2.contains("file.txt")
            assert path1 != path2

    describe "Cleanup":

        it "cleans up current session":
            val manager = create_temp_manager(".fileio_temp_test5", "session_", true, 24)
            val session = manager.get_session()

            manager.cleanup_session()

            # Session should be reset
            assert true

        it "resets current session after cleanup":
            val manager = create_temp_manager(".fileio_temp_test6", "session_", true, 24)
            val session1 = manager.get_session()
            manager.cleanup_session()
            val session2 = manager.get_session()

            assert session1.session_id != session2.session_id

        it "cleans up old sessions based on age":
            val manager = create_temp_manager(".fileio_temp_test7", "session_", true, 1)

            # Create session
            val session1 = manager.create_session()

            # Trigger cleanup
            manager.cleanup_old_sessions()

            # Just verify no crash
            assert true

        it "lists all session directories":
            val manager = create_temp_manager(".fileio_temp_test8", "session_", true, 24)
            manager.create_session()

            val sessions = manager.list_sessions()
            assert sessions.len() >= 1

    describe "Temp Directory":

        it "returns current session temp dir":
            val manager = create_temp_manager(".fileio_temp_test9", "session_", true, 24)
            val temp_dir = manager.get_temp_dir()

            assert temp_dir.contains(".fileio_temp_test9")
            assert temp_dir.contains("session_")

        it "creates base directory if missing":
            val manager = create_temp_manager(".fileio_temp_new", "session_", true, 24)

            # Base directory should be created on init
            assert true

    describe "Edge Cases":

        it "handles empty file list":
            val manager = create_temp_manager(".fileio_temp_test10", "session_", true, 24)
            val files = manager.list_temp_files()

            # No temp paths requested yet
            assert files.len() == 0

        it "handles cleanup with no session":
            val manager = create_temp_manager(".fileio_temp_test11", "session_", false, 24)
            # Don't create session
            manager.cleanup_session()  # Should not crash

            assert true

        it "handles duplicate temp path requests":
            val manager = create_temp_manager(".fileio_temp_test12", "session_", true, 24)
            val path1 = manager.get_temp_path("file.txt")
            val path2 = manager.get_temp_path("file.txt")

            assert path1 == path2
            val files = manager.list_temp_files()
            assert files.len() == 1
