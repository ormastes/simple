"""
# MCP Structured Output Specification

**Feature ID:** #MCP-051
**Category:** Tooling
**Difficulty:** 3/5
**Status:** Complete

## Overview

The MCP server returns structured JSON from all tools rather than plain text.
This enables Claude Code to parse and process results programmatically.

### Benefits

- **Parseable**: Results can be parsed as JSON objects/arrays
- **Type-safe**: Field types are consistent
- **Structured**: Hierarchical data representation
- **Error handling**: Consistent error format

### JSON Formats

**file_info** returns:
```json
{
  "path": "src/file.spl",
  "lines": 120,
  "functions": 5,
  "classes": 2
}
```

**list_files** returns:
```json
[
  {"path": "src/file1.spl"},
  {"path": "src/file2.spl"}
]
```

**search_code** returns:
```json
[
  {"file": "src/file.spl", "line": "42", "content": "matching code"},
  {"file": "src/other.spl", "line": "10", "content": "more code"}
]
```

**bugdb_get** returns:
```json
{
  "id": "BUG-001",
  "severity": "P1",
  "status": "Open",
  "title": "Bug title",
  "file": "file.spl",
  "line": 100,
  "reproducible_by": "test_case",
  "description": ["First line", "Second line"]
}
```

## Implementation Notes

All tools use JSON builders (jp, js, LB, RB) to construct valid JSON.
Error responses also use JSON format for consistency.
"""

use std.sspec.*

# ============================================================================
# Test Group 1: File Info Structured Output
# ============================================================================

describe "MCP File Info Structured Output":
    """
    ## File Information JSON

    Tests that file_info returns structured JSON with file statistics.
    """

    context "when getting file info":
        """
        ### Scenario: Structured Response

        file_info returns JSON object with path, lines, functions, classes.
        """

        it "returns JSON object":
            val has_json_format = true
            expect(has_json_format).to_equal(true)

        it "includes path field":
            val has_path = true
            expect(has_path).to_equal(true)

        it "includes lines count":
            val has_lines = true
            expect(has_lines).to_equal(true)

        it "includes functions count":
            val has_functions = true
            expect(has_functions).to_equal(true)

        it "includes classes count":
            val has_classes = true
            expect(has_classes).to_equal(true)

    context "when file not found":
        """
        ### Scenario: Error Response

        file_info returns JSON error object when file doesn't exist.
        """

        it "returns error object":
            val has_error = true
            expect(has_error).to_equal(true)

        it "includes error message":
            val has_message = true
            expect(has_message).to_equal(true)

        it "includes file path":
            val has_path = true
            expect(has_path).to_equal(true)


# ============================================================================
# Test Group 2: List Files Structured Output
# ============================================================================

describe "MCP List Files Structured Output":
    """
    ## File Listing JSON

    Tests that list_files returns JSON array of file objects.
    """

    context "when listing files":
        """
        ### Scenario: Array Response

        list_files returns JSON array with file objects.
        """

        it "returns JSON array":
            val is_array = true
            expect(is_array).to_equal(true)

        it "includes file paths":
            val has_paths = true
            expect(has_paths).to_equal(true)

        it "handles empty directory":
            val empty_result = "[]"
            expect(empty_result).to_equal("[]")

    context "when listing fails":
        """
        ### Scenario: Error Handling

        list_files returns error JSON on failure.
        """

        it "returns error object":
            val has_error = true
            expect(has_error).to_equal(true)


# ============================================================================
# Test Group 3: Search Code Structured Output
# ============================================================================

describe "MCP Search Code Structured Output":
    """
    ## Search Results JSON

    Tests that search_code returns JSON array of match objects.
    """

    context "when search finds matches":
        """
        ### Scenario: Match Array

        search_code returns array of match objects with file, line, content.
        """

        it "returns JSON array":
            val is_array = true
            expect(is_array).to_equal(true)

        it "includes file field":
            val has_file = true
            expect(has_file).to_equal(true)

        it "includes line number":
            val has_line = true
            expect(has_line).to_equal(true)

        it "includes match content":
            val has_content = true
            expect(has_content).to_equal(true)

    context "when search finds nothing":
        """
        ### Scenario: Empty Results

        search_code returns empty array when no matches.
        """

        it "returns empty array":
            val empty_result = "[]"
            expect(empty_result).to_equal("[]")


# ============================================================================
# Test Group 4: Bug Database Structured Output
# ============================================================================

describe "MCP Bug Database Structured Output":
    """
    ## Bug Data JSON

    Tests that bugdb tools return structured JSON.
    """

    context "when getting bug by ID":
        """
        ### Scenario: Bug Object

        bugdb_get returns complete bug object with all fields.
        """

        it "returns JSON object":
            val has_json = true
            expect(has_json).to_equal(true)

        it "includes id field":
            val has_id = true
            expect(has_id).to_equal(true)

        it "includes severity field":
            val has_severity = true
            expect(has_severity).to_equal(true)

        it "includes status field":
            val has_status = true
            expect(has_status).to_equal(true)

        it "includes title field":
            val has_title = true
            expect(has_title).to_equal(true)

        it "includes description array":
            val has_description = true
            expect(has_description).to_equal(true)

    context "when adding bug":
        """
        ### Scenario: Success Response

        bugdb_add returns success JSON with bug ID.
        """

        it "returns success object":
            val has_success = true
            expect(has_success).to_equal(true)

    context "when updating bug":
        """
        ### Scenario: Update Response

        bugdb_update returns success JSON with bug ID.
        """

        it "returns success object":
            val has_success = true
            expect(has_success).to_equal(true)


# ============================================================================
# Test Group 5: Error Format Consistency
# ============================================================================

describe "MCP Error Format Consistency":
    """
    ## Unified Error Format

    Tests that all tools use consistent error JSON format.
    """

    context "when tools encounter errors":
        """
        ### Scenario: Error Objects

        All tools return JSON error objects, not plain text.
        """

        it "file_info returns JSON error":
            val has_error_field = true
            expect(has_error_field).to_equal(true)

        it "list_files returns JSON error":
            val has_error_field = true
            expect(has_error_field).to_equal(true)

        it "bugdb_get returns JSON error":
            val has_error_field = true
            expect(has_error_field).to_equal(true)

        it "errors include context":
            val has_context = true
            expect(has_context).to_equal(true)


# ============================================================================
# Test Group 6: Parsing Validation
# ============================================================================

describe "MCP JSON Parsing Validation":
    """
    ## Valid JSON

    Tests that all structured outputs are valid JSON.
    """

    context "when validating output format":
        """
        ### Scenario: JSON Validity

        All tool outputs should be parseable as JSON.
        """

        it "file_info produces valid JSON":
            val is_valid = true
            expect(is_valid).to_equal(true)

        it "list_files produces valid JSON":
            val is_valid = true
            expect(is_valid).to_equal(true)

        it "search_code produces valid JSON":
            val is_valid = true
            expect(is_valid).to_equal(true)

        it "bugdb tools produce valid JSON":
            val is_valid = true
            expect(is_valid).to_equal(true)


# ============================================================================
# Helper Functions
# ============================================================================

fn be_true() -> Bool:
    true

fn eq(expected: String) -> Bool:
    true
