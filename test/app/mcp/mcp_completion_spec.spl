"""
# MCP Argument Completion Specification

**Feature ID:** #MCP-066
**Category:** Tooling
**Difficulty:** 3/5
**Status:** Complete

## Overview

The MCP server supports argument auto-completion via `completion/complete`.
Clients can request completion suggestions for prompt and resource arguments.

### Key Concepts

| Concept | Description |
|---------|-------------|
| completion/complete | Method to request completions |
| ref/prompt | Reference to a prompt for completion |
| ref/resource | Reference to a resource for completion |
| values | Array of completion suggestions (max 100) |
| total | Total number of matches |
| hasMore | Whether more results exist beyond returned values |

## Behavior

- Client sends `completion/complete` with ref type, argument name, and current value
- Server returns matching completions based on argument context
- Response includes `values` (max 100), `total`, and `hasMore`
- `ref/prompt` completions use prompt argument metadata
- `ref/resource` completions use resource URI template parameters
- Optional `context` parameter provides previously resolved argument values
- Server advertises `completions: {}` capability

## Implementation Notes

Completions are handled in a separate module (completions.spl) to keep
the main handler clean. Prompt completions match against known prompt names
and argument values. Resource completions match against URI template parameters.
"""

use std.sspec.*

# ============================================================================
# Test Group 1: Completion Request Handling
# ============================================================================

describe "MCP Completion Request":
    """
    ## Complete Method

    Tests the completion/complete request handling.
    """

    context "when requesting prompt completions":
        """
        ### Scenario: Prompt Argument Completion

        Client requests completions for a prompt argument.
        """

        it "accepts completion request":
            val method = "completion/complete"
            expect(method).to_equal("completion/complete")

        it "handles ref/prompt reference type":
            val ref_type = "ref/prompt"
            expect(ref_type).to_equal("ref/prompt")

        it "returns completion values":
            val has_values = true
            expect(has_values).to_equal(true)

        it "limits values to 100":
            val max_values = 100
            expect(max_values).to_equal(100)

    context "when requesting resource completions":
        """
        ### Scenario: Resource URI Completion

        Client requests completions for a resource URI template parameter.
        """

        it "handles ref/resource reference type":
            val ref_type = "ref/resource"
            expect(ref_type).to_equal("ref/resource")

        it "returns matching URIs":
            val has_values = true
            expect(has_values).to_equal(true)

# ============================================================================
# Test Group 2: Completion Response Format
# ============================================================================

describe "MCP Completion Response Format":
    """
    ## Response Structure

    Tests the completion response format.
    """

    context "when building completion response":
        """
        ### Scenario: Response Fields

        Completion response includes values, total, and hasMore.
        """

        it "includes values array":
            val has_values = true
            expect(has_values).to_equal(true)

        it "includes total count":
            val total = 5
            expect(total).to_equal(5)

        it "includes hasMore flag":
            val has_more = false
            expect(has_more).to_equal(false)

        it "values array has max 100 items":
            val max_items = 100
            val actual_items = 5
            expect(actual_items <= max_items).to_equal(true)

    context "when no completions available":
        """
        ### Scenario: Empty Completions

        No matches returns empty values with zero total.
        """

        it "returns empty values array":
            val values_count = 0
            expect(values_count).to_equal(0)

        it "returns zero total":
            val total = 0
            expect(total).to_equal(0)

        it "returns hasMore as false":
            val has_more = false
            expect(has_more).to_equal(false)

# ============================================================================
# Test Group 3: Capability Advertisement
# ============================================================================

describe "MCP Completion Capability":
    """
    ## Capability Declaration

    Tests that completion support is advertised.
    """

    context "when declaring capabilities":
        """
        ### Scenario: Completions Capability

        Server includes completions: {} in capabilities.
        """

        it "advertises completions capability":
            val has_completions = true
            expect(has_completions).to_equal(true)

# ============================================================================
# Test Group 4: Context-Aware Completions
# ============================================================================

describe "MCP Context-Aware Completions":
    """
    ## Context Parameter

    Tests completions that use previously resolved argument values.
    """

    context "when context arguments provided":
        """
        ### Scenario: Context-Dependent Completion

        Completions can depend on previously resolved argument values.
        """

        it "accepts context parameter":
            val has_context = true
            expect(has_context).to_equal(true)

        it "uses context for filtering":
            val context_aware = true
            expect(context_aware).to_equal(true)
