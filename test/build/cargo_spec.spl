# Cargo Build System - SSpec Tests
# Comprehensive BDD tests for Phase 1 (Foundation)

use app.build.types (BuildConfig, BuildResult, BuildProfile, TestResult, profile_to_string)
use app.build.config (parse_build_args, default_config)
use app.build.cargo (Cargo, print_build_result, print_test_result)

describe "Build System Phase 1: Foundation":

    describe "BuildProfile":
        it "should have Debug profile":
            val profile = BuildProfile.Debug
            expect profile_to_string(profile) to_equal "debug"

        it "should have Release profile":
            val profile = BuildProfile.Release
            expect profile_to_string(profile) to_equal "release"

        it "should have Bootstrap profile":
            val profile = BuildProfile.Bootstrap
            expect profile_to_string(profile) to_equal "bootstrap"

    describe "BuildConfig":
        it "should create default config":
            val config = default_config()
            expect profile_to_string(config.profile) to_equal "debug"
            expect config.workspace_root to_equal "rust"
            expect config.target_dir to_equal "rust/target"
            expect config.jobs to_equal 4
            expect config.verbose to_be false

        it "should create config with custom profile":
            val config = BuildConfig(
                profile: BuildProfile.Release,
                features: [],
                workspace_root: "rust",
                target_dir: "rust/target",
                jobs: 4,
                verbose: false
            )
            expect profile_to_string(config.profile) to_equal "release"

        it "should support features":
            val config = BuildConfig(
                profile: BuildProfile.Debug,
                features: ["feature1", "feature2"],
                workspace_root: "rust",
                target_dir: "rust/target",
                jobs: 4,
                verbose: false
            )
            expect config.features.len() to_equal 2
            expect config.features[0] to_equal "feature1"

        it "should support custom job count":
            val config = BuildConfig(
                profile: BuildProfile.Debug,
                features: [],
                workspace_root: "rust",
                target_dir: "rust/target",
                jobs: 8,
                verbose: false
            )
            expect config.jobs to_equal 8

    describe "parse_build_args":
        it "should parse --release flag":
            val config = parse_build_args(["--release"])
            expect profile_to_string(config.profile) to_equal "release"

        it "should parse --bootstrap flag":
            val config = parse_build_args(["--bootstrap"])
            expect profile_to_string(config.profile) to_equal "bootstrap"

        it "should parse --verbose flag":
            val config = parse_build_args(["--verbose"])
            expect config.verbose to_be true

        it "should parse -v short flag":
            val config = parse_build_args(["-v"])
            expect config.verbose to_be true

        it "should parse --profile=release":
            val config = parse_build_args(["--profile=release"])
            expect profile_to_string(config.profile) to_equal "release"

        it "should parse --features flag":
            val config = parse_build_args(["--features=feat1,feat2"])
            expect config.features.len() to_equal 2

        it "should handle multiple flags":
            val config = parse_build_args(["--release", "--verbose"])
            expect profile_to_string(config.profile) to_equal "release"
            expect config.verbose to_be true

        it "should default to debug profile":
            val config = parse_build_args([])
            expect profile_to_string(config.profile) to_equal "debug"

    describe "BuildResult":
        it "should represent successful build":
            val result = BuildResult(
                success: true,
                exit_code: 0,
                stdout: "Build succeeded",
                stderr: "",
                duration_ms: 5000
            )
            expect result.success to_be true
            expect result.exit_code to_equal 0
            expect result.duration_ms to_equal 5000

        it "should represent failed build":
            val result = BuildResult(
                success: false,
                exit_code: 1,
                stdout: "",
                stderr: "Build failed",
                duration_ms: 1000
            )
            expect result.success to_be false
            expect result.exit_code to_equal 1

        it "should capture stdout":
            val result = BuildResult(
                success: true,
                exit_code: 0,
                stdout: "Compiling crate...",
                stderr: "",
                duration_ms: 5000
            )
            expect result.stdout to_contain "Compiling"

        it "should capture stderr":
            val result = BuildResult(
                success: false,
                exit_code: 1,
                stdout: "",
                stderr: "error: could not compile",
                duration_ms: 1000
            )
            expect result.stderr to_contain "error"

    describe "TestResult":
        it "should represent successful tests":
            val result = TestResult(
                success: true,
                exit_code: 0,
                stdout: "test result: ok",
                stderr: "",
                tests_run: 100,
                tests_passed: 100,
                tests_failed: 0
            )
            expect result.success to_be true
            expect result.tests_run to_equal 100
            expect result.tests_passed to_equal 100
            expect result.tests_failed to_equal 0

        it "should represent failed tests":
            val result = TestResult(
                success: false,
                exit_code: 1,
                stdout: "",
                stderr: "test result: FAILED",
                tests_run: 100,
                tests_passed: 95,
                tests_failed: 5
            )
            expect result.success to_be false
            expect result.tests_failed to_equal 5

        it "should track test counts":
            val result = TestResult(
                success: true,
                exit_code: 0,
                stdout: "",
                stderr: "",
                tests_run: 50,
                tests_passed: 48,
                tests_failed: 2
            )
            expect result.tests_run to_equal 50
            expect result.tests_passed to_equal 48

    describe "Cargo.clean":
        slow_it "should return exit code":
            val exit_code = Cargo.clean()
            expect exit_code to_be_a "i64"

    describe "profile_to_string":
        it "should convert Debug to string":
            val str = profile_to_string(BuildProfile.Debug)
            expect str to_equal "debug"

        it "should convert Release to string":
            val str = profile_to_string(BuildProfile.Release)
            expect str to_equal "release"

        it "should convert Bootstrap to string":
            val str = profile_to_string(BuildProfile.Bootstrap)
            expect str to_equal "bootstrap"

describe "Cargo FFI Integration":

    describe "Build operations":
        slow_it "should build with debug profile" skip:
            val config = BuildConfig(
                profile: BuildProfile.Debug,
                features: [],
                workspace_root: "rust",
                target_dir: "rust/target",
                jobs: 4,
                verbose: false
            )
            val result = Cargo.build(config)
            expect result to_be_defined
            expect result.exit_code to_be_a "i64"

        slow_it "should build with release profile" skip:
            val config = BuildConfig(
                profile: BuildProfile.Release,
                features: [],
                workspace_root: "rust",
                target_dir: "rust/target",
                jobs: 4,
                verbose: false
            )
            val result = Cargo.build(config)
            expect result to_be_defined

        slow_it "should handle build with features" skip:
            val config = BuildConfig(
                profile: BuildProfile.Debug,
                features: ["test-feature"],
                workspace_root: "rust",
                target_dir: "rust/target",
                jobs: 4,
                verbose: false
            )
            val result = Cargo.build(config)
            expect result to_be_defined

    describe "Test operations":
        slow_it "should run all tests" skip:
            val result = Cargo.test_workspace()
            expect result to_be_defined
            expect result.tests_run to_be_greater_than 0

        slow_it "should run tests with filter" skip:
            val result = Cargo.test("simple-compiler", "unit")
            expect result to_be_defined

    describe "Check operations":
        slow_it "should check without building" skip:
            val result = Cargo.check()
            expect result to_be_defined
            expect result.exit_code to_be_a "i64"

describe "Error Handling":

    describe "Invalid configurations":
        it "should handle empty workspace root":
            val config = BuildConfig(
                profile: BuildProfile.Debug,
                features: [],
                workspace_root: "",
                target_dir: "rust/target",
                jobs: 4,
                verbose: false
            )
            # Should not crash, even with invalid config
            expect config.workspace_root to_equal ""

        it "should handle zero jobs":
            val config = BuildConfig(
                profile: BuildProfile.Debug,
                features: [],
                workspace_root: "rust",
                target_dir: "rust/target",
                jobs: 0,
                verbose: false
            )
            expect config.jobs to_equal 0

    describe "Build failures":
        it "should represent compilation errors":
            val result = BuildResult(
                success: false,
                exit_code: 101,
                stdout: "",
                stderr: "error[E0308]: mismatched types",
                duration_ms: 500
            )
            expect result.success to_be false
            expect result.exit_code to_equal 101
            expect result.stderr to_contain "error"
