# Package Integration - SSpec Tests
# Comprehensive BDD tests for Phase 6 (Package Integration)

use app.build.package (
    PackageType,
    PackageConfig,
    PackageResult,
    Package,
    default_bootstrap_config,
    default_full_config,
    package_type_to_string
)

describe "Build System Phase 6: Package Integration":

    describe "PackageType":
        it "should have Bootstrap type":
            val pkg_type = PackageType.Bootstrap
            expect package_type_to_string(pkg_type) to_equal "bootstrap"

        it "should have Full type":
            val pkg_type = PackageType.Full
            expect package_type_to_string(pkg_type) to_equal "full"

        it "should have Custom type":
            val pkg_type = PackageType.Custom
            expect package_type_to_string(pkg_type) to_equal "custom"

    describe "PackageConfig":
        it "should create default bootstrap config":
            val config = default_bootstrap_config()
            expect package_type_to_string(config.package_type) to_equal "bootstrap"
            expect config.version to_equal "0.3.0"
            expect config.platform to_equal "linux-x64"
            expect config.output_path to_equal ""
            expect config.include_sources to_be false
            expect config.include_tests to_be false
            expect config.compress to_be true

        it "should create default full config":
            val config = default_full_config()
            expect package_type_to_string(config.package_type) to_equal "full"
            expect config.include_sources to_be true
            expect config.include_tests to_be true

        it "should support custom version":
            val config = PackageConfig(
                package_type: PackageType.Bootstrap,
                version: "1.0.0",
                platform: "linux-x64",
                output_path: "",
                include_sources: false,
                include_tests: false,
                compress: true
            )
            expect config.version to_equal "1.0.0"

        it "should support custom platform":
            val config = PackageConfig(
                package_type: PackageType.Bootstrap,
                version: "0.3.0",
                platform: "macos-arm64",
                output_path: "",
                include_sources: false,
                include_tests: false,
                compress: true
            )
            expect config.platform to_equal "macos-arm64"

        it "should support custom output path":
            val config = PackageConfig(
                package_type: PackageType.Bootstrap,
                version: "0.3.0",
                platform: "linux-x64",
                output_path: "releases/simple.tar.gz",
                include_sources: false,
                include_tests: false,
                compress: true
            )
            expect config.output_path to_equal "releases/simple.tar.gz"

        it "should support including sources":
            val config = PackageConfig(
                package_type: PackageType.Full,
                version: "0.3.0",
                platform: "linux-x64",
                output_path: "",
                include_sources: true,
                include_tests: false,
                compress: true
            )
            expect config.include_sources to_be true

        it "should support including tests":
            val config = PackageConfig(
                package_type: PackageType.Full,
                version: "0.3.0",
                platform: "linux-x64",
                output_path: "",
                include_sources: true,
                include_tests: true,
                compress: true
            )
            expect config.include_tests to_be true

        it "should support uncompressed packages":
            val config = PackageConfig(
                package_type: PackageType.Bootstrap,
                version: "0.3.0",
                platform: "linux-x64",
                output_path: "",
                include_sources: false,
                include_tests: false,
                compress: false
            )
            expect config.compress to_be false

    describe "PackageResult":
        it "should represent successful package creation":
            val result = PackageResult(
                success: true,
                package_path: "simple-bootstrap-0.3.0-linux-x64.tar.gz",
                package_size: 10485760,
                checksum: "abc123sha256",
                build_duration_ms: 120000
            )
            expect result.success to_be true
            expect result.package_size to_equal 10485760

        it "should represent failed package creation":
            val result = PackageResult(
                success: false,
                package_path: "",
                package_size: 0,
                checksum: "",
                build_duration_ms: 5000
            )
            expect result.success to_be false

        it "should track package size":
            val result = PackageResult(
                success: true,
                package_path: "simple-full-0.3.0.tar.gz",
                package_size: 52428800,
                checksum: "def456sha256",
                build_duration_ms: 30000
            )
            expect result.package_size to_equal 52428800

        it "should store checksum":
            val result = PackageResult(
                success: true,
                package_path: "package.tar.gz",
                package_size: 10000000,
                checksum: "sha256checksum",
                build_duration_ms: 60000
            )
            expect result.checksum to_equal "sha256checksum"

        it "should track build duration":
            val result = PackageResult(
                success: true,
                package_path: "package.tar.gz",
                package_size: 10000000,
                checksum: "checksum",
                build_duration_ms: 90000
            )
            expect result.build_duration_ms to_equal 90000

        it "should generate summary":
            val result = PackageResult(
                success: true,
                package_path: "simple-bootstrap-0.3.0-linux-x64.tar.gz",
                package_size: 10485760,
                checksum: "abc123",
                build_duration_ms: 120000
            )
            val summary = result.summary()
            expect summary to_contain "Package created"

describe "Package Operations":

    describe "Package.create":
        it "should create bootstrap package" skip:
            val config = default_bootstrap_config()
            val result = Package.create(config)
            expect result to_be_defined

        it "should create full package" skip:
            val config = default_full_config()
            val result = Package.create(config)
            expect result to_be_defined

        it "should handle custom package" skip:
            var config = default_bootstrap_config()
            config.package_type = PackageType.Custom
            val result = Package.create(config)
            # Custom packages not yet implemented
            expect result.success to_be false

    describe "Package.bootstrap":
        it "should create bootstrap package with defaults" skip:
            val result = Package.bootstrap()
            expect result to_be_defined

    describe "Package.full":
        it "should create full package with defaults" skip:
            val result = Package.full()
            expect result to_be_defined

describe "Bootstrap Package":

    describe "Package contents":
        it "should include runtime binary" skip:
            val result = Package.bootstrap()
            expect result.success to_be true
            # Should contain bin/simple_runtime

        it "should include standard library" skip:
            val result = Package.bootstrap()
            # Should contain lib/simple/std/

        it "should not include tests":
            val config = default_bootstrap_config()
            expect config.include_tests to_be false

        it "should not include sources":
            val config = default_bootstrap_config()
            expect config.include_sources to_be false

    describe "Package size":
        it "should be around 10 MB compressed" skip:
            val result = Package.bootstrap()
            expect result.package_size to_be_less_than 20000000
            expect result.package_size to_be_greater_than 5000000

describe "Full Package":

    describe "Package contents":
        it "should include all sources" skip:
            val config = default_full_config()
            expect config.include_sources to_be true

        it "should include tests" skip:
            val config = default_full_config()
            expect config.include_tests to_be true

        it "should include build system" skip:
            # Should contain Cargo.toml, Makefile, etc.
            pass

    describe "Package size":
        it "should be around 50 MB compressed" skip:
            val result = Package.full()
            expect result.package_size to_be_less_than 100000000
            expect result.package_size to_be_greater_than 20000000

describe "Checksums":

    describe "SHA256 verification":
        it "should generate checksum for package" skip:
            val result = Package.bootstrap()
            expect result.checksum.len() to_be_greater_than 0

        it "should use SHA256 algorithm" skip:
            val result = Package.bootstrap()
            # SHA256 produces 64 hex characters
            expect result.checksum.len() to_equal 64

describe "Error Handling":

    describe "Build failures":
        it "should fail if runtime build fails" skip:
            # Simulate build failure
            # Hard to test without breaking actual build
            pass

        it "should report build errors":
            val result = PackageResult(
                success: false,
                package_path: "",
                package_size: 0,
                checksum: "",
                build_duration_ms: 1000
            )
            expect result.success to_be false

    describe "Invalid configurations":
        it "should handle empty version":
            val config = PackageConfig(
                package_type: PackageType.Bootstrap,
                version: "",
                platform: "linux-x64",
                output_path: "",
                include_sources: false,
                include_tests: false,
                compress: true
            )
            expect config.version to_equal ""

describe "Platform Detection":

    describe "Auto-detection":
        it "should detect current platform":
            val config = default_bootstrap_config()
            # Should auto-detect (currently hardcoded to "linux-x64")
            expect config.platform to_equal "linux-x64"

    describe "Custom platform":
        it "should override platform detection":
            val config = PackageConfig(
                package_type: PackageType.Bootstrap,
                version: "0.3.0",
                platform: "windows-x64",
                output_path: "",
                include_sources: false,
                include_tests: false,
                compress: true
            )
            expect config.platform to_equal "windows-x64"
