# Quality Tools - SSpec Tests
# Comprehensive BDD tests for Phase 4 (Quality Tools)

use app.build.quality (
    LintConfig,
    FormatConfig,
    CheckConfig,
    QualityResult,
    CheckResult,
    Lint,
    Format,
    Check,
    default_lint_config,
    default_format_config,
    default_check_config
)

describe "Build System Phase 4: Quality Tools":

    describe "LintConfig":
        slow_it "should create default lint config":
            val config = default_lint_config()
            expect config.fix to_be false
            expect config.allow_warnings to_be false
            expect config.verbose to_be false

        slow_it "should support fix mode":
            val config = LintConfig(
                fix: true,
                allow_warnings: false,
                verbose: false
            )
            expect config.fix to_be true

        slow_it "should support allow warnings":
            val config = LintConfig(
                fix: false,
                allow_warnings: true,
                verbose: false
            )
            expect config.allow_warnings to_be true

        slow_it "should support verbose mode":
            val config = LintConfig(
                fix: false,
                allow_warnings: false,
                verbose: true
            )
            expect config.verbose to_be true

    describe "FormatConfig":
        slow_it "should create default format config":
            val config = default_format_config()
            expect config.check to_be false
            expect config.verbose to_be false

        slow_it "should support check mode":
            val config = FormatConfig(
                check: true,
                verbose: false
            )
            expect config.check to_be true

        slow_it "should support verbose mode":
            val config = FormatConfig(
                check: false,
                verbose: true
            )
            expect config.verbose to_be true

    describe "CheckConfig":
        slow_it "should create default check config":
            val config = default_check_config()
            expect config.run_lint to_be true
            expect config.run_format_check to_be true
            expect config.run_tests to_be true
            expect config.full to_be false
            expect config.verbose to_be false

        slow_it "should support full mode":
            val config = CheckConfig(
                run_lint: true,
                run_format_check: true,
                run_tests: true,
                full: true,
                verbose: false
            )
            expect config.full to_be true

        slow_it "should support selective checks":
            val config = CheckConfig(
                run_lint: true,
                run_format_check: false,
                run_tests: false,
                full: false,
                verbose: false
            )
            expect config.run_lint to_be true
            expect config.run_format_check to_be false
            expect config.run_tests to_be false

    describe "QualityResult":
        slow_it "should represent successful result":
            val result = QualityResult(
                success: true,
                exit_code: 0,
                warnings_count: 0,
                errors_count: 0,
                fixes_applied: 0
            )
            expect result.success to_be true
            expect result.errors_count to_equal 0

        slow_it "should represent result with warnings":
            val result = QualityResult(
                success: true,
                exit_code: 0,
                warnings_count: 5,
                errors_count: 0,
                fixes_applied: 0
            )
            expect result.warnings_count to_equal 5
            expect result.success to_be true

        slow_it "should represent result with errors":
            val result = QualityResult(
                success: false,
                exit_code: 1,
                warnings_count: 0,
                errors_count: 3,
                fixes_applied: 0
            )
            expect result.success to_be false
            expect result.errors_count to_equal 3

        slow_it "should track applied fixes":
            val result = QualityResult(
                success: true,
                exit_code: 0,
                warnings_count: 0,
                errors_count: 0,
                fixes_applied: 10
            )
            expect result.fixes_applied to_equal 10

    describe "CheckResult":
        slow_it "should represent successful combined checks":
            val lint_result = QualityResult(
                success: true, exit_code: 0,
                warnings_count: 0, errors_count: 0, fixes_applied: 0
            )
            val format_result = QualityResult(
                success: true, exit_code: 0,
                warnings_count: 0, errors_count: 0, fixes_applied: 0
            )
            val test_result = QualityResult(
                success: true, exit_code: 0,
                warnings_count: 0, errors_count: 0, fixes_applied: 0
            )

            val result = CheckResult(
                lint: lint_result,
                format: format_result,
                test: test_result,
                overall_success: true
            )

            expect result.overall_success to_be true

        slow_it "should detect failures in any check":
            val lint_result = QualityResult(
                success: false, exit_code: 1,
                warnings_count: 0, errors_count: 5, fixes_applied: 0
            )
            val format_result = QualityResult(
                success: true, exit_code: 0,
                warnings_count: 0, errors_count: 0, fixes_applied: 0
            )
            val test_result = QualityResult(
                success: true, exit_code: 0,
                warnings_count: 0, errors_count: 0, fixes_applied: 0
            )

            val result = CheckResult(
                lint: lint_result,
                format: format_result,
                test: test_result,
                overall_success: false
            )

            expect result.overall_success to_be false

describe "Lint Operations":

    describe "Lint.run":
        slow_it "should run lint with default config" skip:
            val config = default_lint_config()
            val result = Lint.run(config)
            expect result to_be_defined

        slow_it "should run lint in check mode" skip:
            var config = default_lint_config()
            config.fix = false
            val result = Lint.run(config)
            expect result to_be_defined

        slow_it "should run lint in fix mode" skip:
            var config = default_lint_config()
            config.fix = true
            val result = Lint.run(config)
            expect result.fixes_applied to_be_greater_than_or_equal 0

    describe "Lint.quick":
        slow_it "should run quick lint" skip:
            val result = Lint.quick()
            expect result to_be_defined

    describe "Lint.fix":
        slow_it "should apply auto-fixes" skip:
            val result = Lint.fix()
            expect result to_be_defined

describe "Format Operations":

    describe "Format.run":
        slow_it "should run format with default config" skip:
            val config = default_format_config()
            val result = Format.run(config)
            expect result to_be_defined

        slow_it "should check formatting" skip:
            var config = default_format_config()
            config.check = true
            val result = Format.run(config)
            expect result to_be_defined

        slow_it "should apply formatting" skip:
            var config = default_format_config()
            config.check = false
            val result = Format.run(config)
            expect result to_be_defined

    describe "Format.check":
        slow_it "should check formatting without applying" skip:
            val result = Format.check()
            expect result to_be_defined

    describe "Format.fix":
        slow_it "should apply formatting fixes" skip:
            val result = Format.fix()
            expect result to_be_defined

describe "Combined Checks":

    describe "Check.run":
        slow_it "should run all checks with default config" skip:
            val config = default_check_config()
            val result = Check.run(config)
            expect result to_be_defined

        slow_it "should run selective checks" skip:
            var config = default_check_config()
            config.run_tests = false
            val result = Check.run(config)
            expect result to_be_defined

        slow_it "should run full checks" skip:
            var config = default_check_config()
            config.full = true
            val result = Check.run(config)
            expect result to_be_defined

    describe "Check.quick":
        slow_it "should run quick checks" skip:
            val result = Check.quick()
            expect result to_be_defined

    describe "Check.full":
        slow_it "should run full checks with coverage" skip:
            val result = Check.full()
            expect result to_be_defined

describe "Warning and Error Handling":

    describe "Clippy warnings":
        slow_it "should detect warnings" skip:
            val config = default_lint_config()
            val result = Lint.run(config)
            expect result.warnings_count to_be_greater_than_or_equal 0

        slow_it "should treat warnings as errors when configured" skip:
            var config = default_lint_config()
            config.allow_warnings = false
            val result = Lint.run(config)
            # With allow_warnings=false, warnings should cause failure
            expect config.allow_warnings to_be false

    describe "Format errors":
        slow_it "should detect formatting issues" skip:
            var config = default_format_config()
            config.check = true
            val result = Format.run(config)
            expect result to_be_defined

describe "Auto-Fix Capabilities":

    describe "Lint auto-fix":
        slow_it "should count fixed warnings" skip:
            var config = default_lint_config()
            config.fix = true
            val result = Lint.run(config)
            expect result.fixes_applied to_be_a "i64"

        slow_it "should not fix when disabled" skip:
            var config = default_lint_config()
            config.fix = false
            val result = Lint.run(config)
            expect result.fixes_applied to_equal 0

    describe "Format auto-fix":
        slow_it "should format code when not in check mode" skip:
            var config = default_format_config()
            config.check = false
            val result = Format.run(config)
            expect result to_be_defined

describe "Verbose Output":

    describe "Lint verbose":
        slow_it "should provide detailed output when verbose" skip:
            var config = default_lint_config()
            config.verbose = true
            val result = Lint.run(config)
            expect result to_be_defined

    describe "Format verbose":
        slow_it "should provide detailed output when verbose" skip:
            var config = default_format_config()
            config.verbose = true
            val result = Format.run(config)
            expect result to_be_defined

    describe "Check verbose":
        slow_it "should provide detailed output when verbose" skip:
            var config = default_check_config()
            config.verbose = true
            val result = Check.run(config)
            expect result to_be_defined

describe "Integration with Build System":

    describe "Pre-commit checks":
        slow_it "should run lint before commit" skip:
            val result = Lint.quick()
            expect result.success to_be true

        slow_it "should check formatting before commit" skip:
            val result = Format.check()
            expect result.success to_be true

    describe "CI/CD integration":
        slow_it "should run full checks in CI" skip:
            val result = Check.full()
            expect result to_be_defined
