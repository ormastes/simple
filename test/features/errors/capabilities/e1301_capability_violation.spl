# E1301: Capability Violation

Feature: E1301 - Capability Violation
  As a Simple compiler with reference capabilities
  I want to detect attempts to mutate through immutable capabilities
  So that capability safety is enforced at compile time

  Background:
    Given I have the Simple compiler
    And the compiler supports reference capabilities (T, mut T, iso T)

  Scenario: Calling mutable method on immutable capability
    When I compile:
      '''
      struct Counter:
        count: i32

      impl Counter:
        me increment():  # 'me' requires mut T capability
          self.count = self.count + 1

      fn test(c: Counter):  # Immutable capability
        c.increment()  # Error: requires mut Counter
      '''
    Then I should see error E1301 at line 9
    And the error message should contain "capability violation"
    And the error should indicate "trying to mutate through immutable capability"
    And the note should say "method `increment` requires `mut Counter` capability"
    And the help should suggest "change parameter to `c: mut Counter`"

  Scenario: Mutating field directly on immutable
    When I compile:
      '''
      struct Point:
        x: i32
        y: i32

      fn move_point(p: Point):  # Immutable
        p.x = 10  # Error: cannot mutate field
        p.y = 20
      '''
    Then I should see error E1301 at line 6
    And the error should indicate "cannot mutate field of immutable capability"

  Scenario: Passing immutable to function requiring mutable
    When I compile:
      '''
      fn modify(buf: mut [i32]):
        buf[0] = 42

      fn test():
        val arr = [1, 2, 3]  # Immutable binding
        modify(arr)  # Error: arr is not mut
      '''
    Then I should see error E1301 at line 6
    And the error message should contain "capability mismatch"
    And the help should suggest "use `var arr` or pass `mut arr`"

  Scenario: Valid mutable capability usage
    When I compile:
      '''
      struct Buffer:
        data: [i32]

      impl Buffer:
        me append(item: i32):
          self.data.push(item)

      fn test():
        var buf = Buffer([])  # Mutable binding
        buf.append(42)  # OK: buf has mut capability
      '''
    Then compilation should succeed

  Scenario: Korean language error
    Given I set compiler language to "ko"
    When I compile:
      '''
      struct Counter:
        value: i32

      impl Counter:
        me inc():
          self.value += 1

      fn test(c: Counter):
        c.inc()
      '''
    Then I should see error E1301
    And the error message should contain "기능 위반"
    And the error message should contain "불변을 변경하려고 시도"

  Scenario: Capability violation in closure
    When I compile:
      '''
      fn test():
        val x = 42
        val f = \:
          x = 100  # Error: x is immutable in closure
        f()
      '''
    Then I should see error E1301 at line 4
    And the error should indicate "cannot mutate captured immutable variable"

  Scenario: Capability downgrade is allowed
    When I compile:
      '''
      fn readonly(x: Counter):  # Takes immutable
        print(x.count)

      fn test():
        var c = Counter(0)  # Mutable
        readonly(c)  # OK: mut -> immut is allowed (downgrade)
      '''
    Then compilation should succeed

  Scenario: Capability upgrade is not allowed
    When I compile:
      '''
      fn write(x: mut Counter):  # Requires mutable
        x.count = 10

      fn test():
        val c = Counter(0)  # Immutable
        write(c)  # Error: cannot upgrade immut -> mut
      '''
    Then I should see error E1301
    And the error should indicate "cannot convert immutable to mutable capability"
