# Integration tests for Test Formatters
# Tests progress, doc, and JSON formatters

import spec.{describe, context, it, expect, before_each}
import spec.matchers.{eq, include_string, start_with, end_with, gt, be_true, be_false}
import spec.runner.executor.{TestExecutor, TestResult, ExecutionResults, TestStatus}
import spec.formatters.progress.{ProgressFormatter}
import spec.formatters.doc.{DocFormatter}
import spec.formatters.json.{JsonFormatter, to_json, to_json_pretty}
import spec.registry.{reset_registry, ExampleGroup, Example}

describe "Formatter Integration":
    before_each:
        reset_registry()

    context "ProgressFormatter":
        it "formats passing test as green dot":
            val formatter = ProgressFormatter.new()

            describe "Sample":
                it "passes":
                    pass

            val executor = TestExecutor.new()
            val results = executor.run()
            val result = results.results[0]

            val dot = formatter.format_dot(result)
            # Dot should be "." (without colors) or green "." (with colors)
            expect(dot).to include_string(".")

        it "formats failing test as red F":
            val formatter = ProgressFormatter.new().without_colors()

            describe "Sample":
                it "fails":
                    expect(true).to be_false()

            val executor = TestExecutor.new()
            val results = executor.run()
            val result = results.results[0]

            val dot = formatter.format_dot(result)
            expect(dot).to eq("F")

        it "formats pending test as yellow asterisk":
            val formatter = ProgressFormatter.new().without_colors()

            describe "Sample":
                skip "not implemented":
                    pass

            val executor = TestExecutor.new()
            val results = executor.run()
            val result = results.results[0]

            val dot = formatter.format_dot(result)
            expect(dot).to eq("*")

        it "formats summary with counts":
            val formatter = ProgressFormatter.new()

            describe "Sample":
                it "pass 1":
                    pass
                it "pass 2":
                    pass
                it "fail":
                    expect(true).to be_false()

            val executor = TestExecutor.new()
            val results = executor.run()

            val summary = formatter.format_summary(results)
            expect(summary).to include_string("3 examples")
            expect(summary).to include_string("1 failures")

        it "formats failures with messages":
            val formatter = ProgressFormatter.new()

            describe "Calculator":
                it "adds numbers":
                    expect(2 + 2).to eq(5)  # Intentional failure

            val executor = TestExecutor.new()
            val results = executor.run()

            val failures_text = formatter.format_failures(results)
            expect(failures_text).to include_string("Failures:")
            expect(failures_text).to include_string("adds numbers")

        it "can disable colors":
            val formatter = ProgressFormatter.new().without_colors()
            expect(formatter.show_colors).to be_false()

        it "can set line width":
            val formatter = ProgressFormatter.new().with_line_width(40)
            expect(formatter.dots_per_line).to eq(40)

    context "DocFormatter":
        it "formats tests hierarchically":
            val formatter = DocFormatter.new()

            describe "Calculator":
                context "addition":
                    it "adds positive numbers":
                        pass
                context "subtraction":
                    it "subtracts numbers":
                        pass

            val executor = TestExecutor.new()
            val results = executor.run()

            val output = formatter.format_results(results)
            expect(output).to include_string("Calculator")
            expect(output).to include_string("addition")
            expect(output).to include_string("subtraction")

        it "shows test status with markers":
            val formatter = DocFormatter.new().without_colors()

            describe "Sample":
                it "passes":
                    pass
                it "fails":
                    expect(true).to be_false()
                skip "pending":
                    pass

            val executor = TestExecutor.new()
            val results = executor.run()

            val output = formatter.format_results(results)
            expect(output).to include_string("✓")  # Pass marker
            expect(output).to include_string("✗")  # Fail marker
            expect(output).to include_string("○")  # Pending marker

        it "includes failure details":
            val formatter = DocFormatter.new()

            describe "Calculator":
                it "multiplies":
                    expect(2 * 3).to eq(7)  # Intentional failure

            val executor = TestExecutor.new()
            val results = executor.run()

            val output = formatter.format_results(results)
            expect(output).to include_string("Failures:")
            expect(output).to include_string("multiplies")

        it "shows summary with duration":
            val formatter = DocFormatter.new()

            describe "Sample":
                it "test 1":
                    pass
                it "test 2":
                    pass

            val executor = TestExecutor.new()
            val results = executor.run()

            val summary = formatter.format_summary(results)
            expect(summary).to include_string("Finished in")
            expect(summary).to include_string("2 examples")
            expect(summary).to include_string("0 failures")

        it "can show individual test durations":
            val formatter = DocFormatter.new().with_duration()
            expect(formatter.show_duration).to be_true()

        it "can set indentation size":
            val formatter = DocFormatter.new().with_indent(4)
            expect(formatter.indent_size).to eq(4)

    context "JsonFormatter":
        it "formats results as valid JSON":
            val formatter = JsonFormatter.new()

            describe "Sample":
                it "passes":
                    pass

            val executor = TestExecutor.new()
            val results = executor.run()

            val json_str = formatter.to_json(results)
            expect(json_str).to include_string("summary")
            expect(json_str).to include_string("examples")

        it "includes summary statistics":
            describe "Sample":
                it "pass 1":
                    pass
                it "pass 2":
                    pass
                it "fail":
                    expect(true).to be_false()

            val executor = TestExecutor.new()
            val results = executor.run()

            val json_str = to_json(results)
            expect(json_str).to include_string("example_count")
            expect(json_str).to include_string("passed_count")
            expect(json_str).to include_string("failed_count")
            expect(json_str).to include_string("success_rate")

        it "includes individual example results":
            describe "Calculator":
                it "adds numbers":
                    expect(2 + 3).to eq(5)

            val executor = TestExecutor.new()
            val results = executor.run()

            val json_str = to_json(results)
            expect(json_str).to include_string("adds numbers")
            expect(json_str).to include_string("description")
            expect(json_str).to include_string("status")

        it "includes failure messages":
            describe "Sample":
                it "fails":
                    expect(10).to eq(20)

            val executor = TestExecutor.new()
            val results = executor.run()

            val json_str = to_json(results)
            expect(json_str).to include_string("failure_message")
            expect(json_str).to include_string("failures")

        it "includes metadata when requested":
            val formatter = JsonFormatter.new()
            expect(formatter.include_metadata).to be_true()

            describe "Sample":
                it "passes":
                    pass

            val executor = TestExecutor.new()
            val results = executor.run()

            val json_str = formatter.to_json(results)
            expect(json_str).to include_string("metadata")
            expect(json_str).to include_string("framework")
            expect(json_str).to include_string("SSpec")

        it "can exclude metadata":
            val formatter = JsonFormatter.new().without_metadata()
            expect(formatter.include_metadata).to be_false()

        it "can pretty-print JSON":
            val formatter = JsonFormatter.new().with_pretty_print()
            expect(formatter.pretty_print).to be_true()

            describe "Sample":
                it "passes":
                    pass

            val executor = TestExecutor.new()
            val results = executor.run()

            val json_str = formatter.to_json(results)
            # Pretty-printed JSON should have newlines and indentation
            expect(json_str).to include_string("\n")

        it "includes test tags in output":
            describe "Sample":
                it "tagged test":
                    pass.with_tag("unit").with_tag("fast")

            val executor = TestExecutor.new()
            val results = executor.run()

            val json_str = to_json(results)
            expect(json_str).to include_string("tags")
            expect(json_str).to include_string("unit")
            expect(json_str).to include_string("fast")

    context "Formatter comparison":
        it "all formatters handle same results":
            describe "Sample":
                it "pass":
                    pass
                it "fail":
                    expect(true).to be_false()
                skip "pending":
                    pass

            val executor = TestExecutor.new()
            val results = executor.run()

            # Progress formatter
            val progress = ProgressFormatter.new().without_colors()
            val progress_output = progress.format_results(results)
            expect(progress_output).to include_string(".")
            expect(progress_output).to include_string("F")

            # Doc formatter
            val doc = DocFormatter.new().without_colors()
            val doc_output = doc.format_results(results)
            expect(doc_output).to include_string("Sample")
            expect(doc_output).to include_string("✓")
            expect(doc_output).to include_string("✗")

            # JSON formatter
            val json = JsonFormatter.new()
            val json_output = json.to_json(results)
            expect(json_output).to include_string("passed")
            expect(json_output).to include_string("failed")
            expect(json_output).to include_string("pending")

        it "all formatters show failure counts":
            describe "Sample":
                it "fail 1":
                    expect(1).to eq(2)
                it "fail 2":
                    expect(3).to eq(4)

            val executor = TestExecutor.new()
            val results = executor.run()

            val progress = ProgressFormatter.new().format_summary(results)
            expect(progress).to include_string("2 failures")

            val doc = DocFormatter.new().format_summary(results)
            expect(doc).to include_string("2 failures")

            val json_str = to_json(results)
            expect(json_str).to include_string("failed_count")
