# Integration Tests for Bare-Metal Build System
#
# Tests the baremetal build integration including:
# - Linker script usage
# - crt0.s assembly
# - QEMU integration
# - Test output parsing

use std.spec.{describe, it, expect}
use app.build.baremetal.{BaremetalConfig, BaremetalBuilder, QemuRunner, baremetal_config_arm, baremetal_config_x86_64, baremetal_config_riscv, parse_test_output}
use app.io.mod.{file_exists, dir_create, file_write}

describe "Bare-Metal Build System", fn():
    describe "Linker Scripts", fn():
        it "ARM linker script exists", fn():
            expect(file_exists("src/compiler/baremetal/arm/linker.ld")).to_equal(true)

        it "x86_64 linker script exists", fn():
            expect(file_exists("src/compiler/baremetal/x86_64/linker.ld")).to_equal(true)

        it "RISC-V linker script exists", fn():
            expect(file_exists("src/compiler/baremetal/riscv/linker.ld")).to_equal(true)

    describe "Startup Code", fn():
        it "ARM crt0.s exists", fn():
            expect(file_exists("src/compiler/baremetal/arm/crt0.s")).to_equal(true)

        it "x86_64 crt0.s exists", fn():
            expect(file_exists("src/compiler/baremetal/x86_64/crt0.s")).to_equal(true)

        it "RISC-V crt0.s exists", fn():
            expect(file_exists("src/compiler/baremetal/riscv/crt0.s")).to_equal(true)

    describe "Configuration", fn():
        it "ARM config has correct paths", fn():
            val config = baremetal_config_arm()
            expect(config.linker_script).to_equal("src/compiler/baremetal/arm/linker.ld")
            expect(config.crt0_path).to_equal("src/compiler/baremetal/arm/crt0.s")
            expect(config.entry_point).to_equal("reset_handler")

        it "x86_64 config has correct paths", fn():
            val config = baremetal_config_x86_64()
            expect(config.linker_script).to_equal("src/compiler/baremetal/x86_64/linker.ld")
            expect(config.crt0_path).to_equal("src/compiler/baremetal/x86_64/crt0.s")
            expect(config.entry_point).to_equal("_start")

        it "RISC-V config has correct paths", fn():
            val config = baremetal_config_riscv()
            expect(config.linker_script).to_equal("src/compiler/baremetal/riscv/linker.ld")
            expect(config.crt0_path).to_equal("src/compiler/baremetal/riscv/crt0.s")
            expect(config.entry_point).to_equal("_start")

    describe "Target Triples", fn():
        it "ARM target triple", fn():
            val config = baremetal_config_arm()
            expect(config.target_triple()).to_equal("armv7m-none-eabi")

        it "x86_64 target triple", fn():
            val config = baremetal_config_x86_64()
            expect(config.target_triple()).to_equal("x86_64-unknown-none")

        it "RISC-V target triple", fn():
            val config = baremetal_config_riscv()
            expect(config.target_triple()).to_equal("riscv64gc-unknown-none-elf")

    describe "Test Output Parsing", fn():
        it "parses passing tests", fn():
            val output = "[TEST START]\n[PASS] test_one\n[PASS] test_two\n[TEST END] passed=2 failed=0"
            val result = parse_test_output(output, 1)
            expect(result.tests_run).to_equal(2)
            expect(result.tests_passed).to_equal(2)
            expect(result.tests_failed).to_equal(0)
            expect(result.success).to_equal(true)

        it "parses failing tests", fn():
            val output = "[TEST START]\n[PASS] test_one\n[FAIL] test_two: assertion failed\n[TEST END] passed=1 failed=1"
            val result = parse_test_output(output, 1)
            expect(result.tests_run).to_equal(2)
            expect(result.tests_passed).to_equal(1)
            expect(result.tests_failed).to_equal(1)
            expect(result.success).to_equal(false)

        it "adjusts QEMU exit codes correctly", fn():
            # isa-debug-exit: exit code 0 becomes 1
            val result1 = parse_test_output("", 1)
            expect(result1.exit_code).to_equal(0)

            # isa-debug-exit: exit code 1 becomes 3
            val result2 = parse_test_output("", 3)
            expect(result2.exit_code).to_equal(1)

    describe "QEMU Runner", fn():
        it "ARM QEMU executable", fn():
            val config = baremetal_config_arm()
            val runner = QemuRunner.new(config, 30000)
            expect(runner.qemu_executable()).to_equal("qemu-system-arm")

        it "x86_64 QEMU executable", fn():
            val config = baremetal_config_x86_64()
            val runner = QemuRunner.new(config, 30000)
            expect(runner.qemu_executable()).to_equal("qemu-system-x86_64")

        it "RISC-V QEMU executable", fn():
            val config = baremetal_config_riscv()
            val runner = QemuRunner.new(config, 30000)
            expect(runner.qemu_executable()).to_equal("qemu-system-riscv64")
