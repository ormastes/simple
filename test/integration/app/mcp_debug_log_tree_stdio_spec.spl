# Dedicated MCP stdio regression for debug_log_tree(format=json).

use std.spec
use app.io.mod.{shell}

extern fn rt_file_write_text(path: text, content: text) -> bool

fn mcp_msg(body: text) -> text:
    "Content-Length: " + body.len().to_string() + "\r\n\r\n" + body

fn init_request() -> text:
    val body = "{\"jsonrpc\":\"2.0\",\"id\":\"1\",\"method\":\"initialize\",\"params\":{\"protocolVersion\":\"2025-06-18\",\"capabilities\":{},\"clientInfo\":{\"name\":\"test\",\"version\":\"1.0\"}}}"
    mcp_msg(body)

fn initialized_notification() -> text:
    mcp_msg("{\"jsonrpc\":\"2.0\",\"method\":\"initialized\"}")

fn tools_call_request(id: text, name: text, arguments_json: text) -> text:
    val body = "{\"jsonrpc\":\"2.0\",\"id\":\"" + id + "\",\"method\":\"tools/call\",\"params\":{\"name\":\"" + name + "\",\"arguments\":" + arguments_json + "}}"
    mcp_msg(body)

fn shutdown_request(id: text) -> text:
    mcp_msg("{\"jsonrpc\":\"2.0\",\"id\":\"" + id + "\",\"method\":\"shutdown\"}")

fn send_mcp(messages: text) -> text:
    val tmp = "/tmp/mcp_debug_log_tree_input.txt"
    rt_file_write_text(tmp, messages)
    val result = shell("cat " + tmp + " | timeout 20s bin/simple_mcp_server 2>/dev/null")
    result.stdout ?? ""

describe "MCP Stdio Debug Log Tree":
    it "returns JSON tree and keeps session alive":
        val input = init_request() + initialized_notification() + tools_call_request("2", "debug_log_enable", "{\"pattern\":\"*\"}") + tools_call_request("3", "debug_log_tree", "{\"format\":\"json\"}") + shutdown_request("4")
        val output = send_mcp(input)

        expect(output.contains("\"id\":\"3\"")).to_equal(true)
        expect(output.contains("\"format\":\"json\"")).to_equal(true)
        expect(output.contains("\"tree\":[")).to_equal(true)
        expect(output.contains("\"id\":\"4\"")).to_equal(true)
