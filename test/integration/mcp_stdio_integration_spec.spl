"""
# MCP Server Stdio Integration Tests


End-to-end tests that pipe real JSON-RPC messages to bin/simple mcp server
via stdin and verify the responses.
"""

use std.spec
use app.io.mod.{shell}
use std.string.{NL}
use std.string.{NL}

extern fn rt_file_write_text(path: text, content: text) -> bool

fn mcp_msg(body: text) -> text:
    "Content-Length: " + body.len().to_string() + "\r{NL}\r{NL}" + body

fn init_request() -> text:
    val body = "{\"jsonrpc\":\"2.0\",\"id\":\"1\",\"method\":\"initialize\",\"params\":{\"protocolVersion\":\"2025-06-18\",\"capabilities\":{},\"clientInfo\":{\"name\":\"test\",\"version\":\"1.0\"}}}"
    mcp_msg(body)

fn initialized_notification() -> text:
    val body = "{\"jsonrpc\":\"2.0\",\"method\":\"initialized\"}"
    mcp_msg(body)

fn ping_request(id: text) -> text:
    val body = "{\"jsonrpc\":\"2.0\",\"id\":\"" + id + "\",\"method\":\"ping\"}"
    mcp_msg(body)

fn shutdown_request(id: text) -> text:
    val body = "{\"jsonrpc\":\"2.0\",\"id\":\"" + id + "\",\"method\":\"shutdown\"}"
    mcp_msg(body)

fn tools_list_request(id: text) -> text:
    val body = "{\"jsonrpc\":\"2.0\",\"id\":\"" + id + "\",\"method\":\"tools/list\"}"
    mcp_msg(body)

fn resources_list_request(id: text) -> text:
    val body = "{\"jsonrpc\":\"2.0\",\"id\":\"" + id + "\",\"method\":\"resources/list\"}"
    mcp_msg(body)

fn prompts_list_request(id: text) -> text:
    val body = "{\"jsonrpc\":\"2.0\",\"id\":\"" + id + "\",\"method\":\"prompts/list\"}"
    mcp_msg(body)

fn unknown_method_request(id: text) -> text:
    val body = "{\"jsonrpc\":\"2.0\",\"id\":\"" + id + "\",\"method\":\"nonexistent/method\"}"
    mcp_msg(body)

fn send_mcp(messages: text) -> text:
    val tmp = "/tmp/mcp_e2e_input.txt"
    rt_file_write_text(tmp, messages)
    val result = shell("cat " + tmp + " | bin/simple mcp server 2>/dev/null")
    result.stdout ?? ""

# =========================================================================
# Tests
# =========================================================================

describe "MCP Stdio E2E - Initialize":
    it "responds with server capabilities":
        val input = init_request() + initialized_notification() + shutdown_request("2")
        val output = send_mcp(input)
        expect(output.contains("jsonrpc")).to_equal(true)
        expect(output.contains("2.0")).to_equal(true)
        expect(output.contains("serverInfo")).to_equal(true)
        expect(output.contains("simple-mcp")).to_equal(true)
        expect(output.contains("capabilities")).to_equal(true)

    it "includes protocol version in response":
        val input = init_request() + initialized_notification() + shutdown_request("2")
        val output = send_mcp(input)
        expect(output.contains("protocolVersion")).to_equal(true)

describe "MCP Stdio E2E - Ping":
    it "responds with empty result":
        val input = init_request() + initialized_notification() + ping_request("2") + shutdown_request("3")
        val output = send_mcp(input)
        # Should contain ping response with id "2" and empty result {}
        expect(output.contains("\"id\":\"2\"")).to_equal(true)

describe "MCP Stdio E2E - Tools List":
    it "returns list of tools":
        val input = init_request() + initialized_notification() + tools_list_request("2") + shutdown_request("3")
        val output = send_mcp(input)
        expect(output.contains("tools")).to_equal(true)
        expect(output.contains("read_code")).to_equal(true)
        expect(output.contains("list_files")).to_equal(true)
        expect(output.contains("search_code")).to_equal(true)

describe "MCP Stdio E2E - Resources List":
    it "returns list of resources":
        val input = init_request() + initialized_notification() + resources_list_request("2") + shutdown_request("3")
        val output = send_mcp(input)
        expect(output.contains("resources")).to_equal(true)
        expect(output.contains("project:///info")).to_equal(true)

describe "MCP Stdio E2E - Prompts List":
    it "returns list of prompts":
        val input = init_request() + initialized_notification() + prompts_list_request("2") + shutdown_request("3")
        val output = send_mcp(input)
        expect(output.contains("prompts")).to_equal(true)

describe "MCP Stdio E2E - Unknown Method":
    it "returns method not found error":
        val input = init_request() + initialized_notification() + unknown_method_request("2") + shutdown_request("3")
        val output = send_mcp(input)
        expect(output.contains("-32601")).to_equal(true)
        expect(output.contains("Method not found")).to_equal(true)

describe "MCP Stdio E2E - Shutdown":
    it "responds with null result":
        val input = init_request() + initialized_notification() + shutdown_request("2")
        val output = send_mcp(input)
        expect(output.contains("\"id\":\"2\"")).to_equal(true)
