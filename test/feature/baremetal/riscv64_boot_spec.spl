"""
# RISC-V 64-bit Bare-Metal Boot Tests

**Feature ID:** #BAREMETAL-009
**Category:** Baremetal
**Status:** In Progress

## Overview

Tests RISC-V 64-bit bare-metal boot functionality including machine mode startup,
trap vector setup with direct and vectored modes, machine status register initialization,
interrupt enable configuration (timer, external, software), and 16-byte stack alignment.
Validates that the RISC-V 64 boot infrastructure correctly initializes mtvec, mstatus, and mie CSRs.

## Syntax

```simple
val mstatus = MSTATUS_MPP_MACHINE
expect(check_machine_mode(mstatus)).to_equal(true)

val mtvec = 0x80000100
val (base, mode) = parse_mtvec(mtvec)
expect(mode).to_equal(MTVEC_MODE_DIRECT)
expect(validate_trap_vector(mtvec)).to_equal(true)
```
"""
# @platform: baremetal(riscv)
# RISC-V 64-bit Bare-Metal Boot Tests
#
# Tests RISC-V 64-bit bare-metal boot functionality:
# - Machine mode startup
# - Trap vector setup
# - Stack setup
# - Jump to kernel_main
#
# These tests verify the RISC-V 64 boot infrastructure works correctly.

use std.spec
use std.spec.{check, check_msg}
use baremetal.riscv.test_support.{check_machine_mode, check_mtvec_alignment, check_mstatus_bits, get_stack_pointer, check_stack_alignment_rv64, parse_mtvec, validate_trap_vector, check_mstatus_init, check_interrupt_enabled, STACK_SIZE, RAM_BASE, MSTATUS_MIE, MSTATUS_MPIE, MSTATUS_MPP_MACHINE, MIE_MSIE, MIE_MTIE, MIE_MEIE, MTVEC_MODE_DIRECT, MTVEC_MODE_VECTORED}

# ===========================================================================
# Boot Code Tests
# ===========================================================================

describe "RISC-V 64 Boot Code":
    it "starts in machine mode":
        # After reset: MPP = 11 (machine mode), MIE = 0 (interrupts disabled)
        val mstatus = MSTATUS_MPP_MACHINE  # MPP=11, MIE=0
        expect(check_machine_mode(mstatus)).to_equal(true)
        expect(check_mstatus_init(mstatus)).to_equal(true)

    it "sets up trap vector":
        # Direct mode trap vector at 0x80000100
        val mtvec = 0x80000100  # Base aligned, mode = 0 (direct)
        val (base, mode) = parse_mtvec(mtvec)
        expect(mode).to_equal(MTVEC_MODE_DIRECT)
        expect(check_mtvec_alignment(base, mode)).to_equal(true)
        expect(validate_trap_vector(mtvec)).to_equal(true)

    it "configures machine registers":
        # Verify interrupt enable bits
        val mie = MIE_MTIE | MIE_MEIE  # Timer + External interrupts
        expect(check_interrupt_enabled(mie, MIE_MTIE)).to_equal(true)
        expect(check_interrupt_enabled(mie, MIE_MEIE)).to_equal(true)
        expect(check_interrupt_enabled(mie, MIE_MSIE)).to_equal(false)

        # Verify stack setup
        val sp = get_stack_pointer()
        expect(sp).to_equal(RAM_BASE + STACK_SIZE)
        expect(check_stack_alignment_rv64(sp)).to_equal(true)

# ===========================================================================
# QEMU Boot Tests
# ===========================================================================

describe "RISC-V 64 QEMU Boot":
    skip_it "boots on virt machine":
        # Requires QEMU installation
        check(true)

    skip_it "handles traps correctly":
        # Requires QEMU + test kernel with trap handlers
        check(true)
