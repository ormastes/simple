# @platform: baremetal(x86)
# x86 Bare-Metal Boot Tests
#
# Tests x86 bare-metal boot functionality:
# - Multiboot header generation
# - Boot code assembly
# - Stack setup
# - Jump to kernel_main
#
# These tests verify the x86 boot infrastructure works correctly.

use std.spec
use std.spec.{check, check_msg}
use baremetal.x86.test_support.{MultibootHeader, multiboot_header, validate_multiboot, get_stack_pointer, STACK_SIZE}

# ===========================================================================
# Multiboot Header Tests
# ===========================================================================

describe "x86 Multiboot Header":
    it "has correct magic number":
        val header = multiboot_header()
        expect(header.magic).to_equal(0x1BADB002)

    it "has valid checksum":
        val header = multiboot_header()
        val sum = (header.magic as i64 + header.flags as i64 + header.checksum as i64) as u32
        expect(sum).to_equal(0)

    it "has correct flags":
        val header = multiboot_header()
        # Flags: PAGE_ALIGN (bit 0) | MEMORY_INFO (bit 1) = 3
        expect(header.flags).to_equal(3)

    it "validates successfully":
        val header = multiboot_header()
        expect(validate_multiboot(header)).to_equal(true)

# ===========================================================================
# Boot Code Tests
# ===========================================================================

describe "x86 Boot Code":
    it "allocates 64KB stack":
        expect(STACK_SIZE).to_equal(65536)

    it "maintains 16-byte stack alignment":
        expect(STACK_SIZE % 16).to_equal(0)

    it "sets up stack pointer correctly":
        val sp = get_stack_pointer()
        # SP should be non-zero and 16-byte aligned
        expect(sp > 0).to_equal(true)
        expect(sp % 16).to_equal(0)

# ===========================================================================
# Linker Script Tests
# ===========================================================================

describe "x86 Linker Script":
    skip_it "places multiboot header at correct address":
        # Requires linker output analysis
        check(true)

    skip_it "sets correct entry point":
        # Requires linker output analysis
        check(true)

# ===========================================================================
# QEMU Boot Tests
# ===========================================================================

describe "x86 QEMU Boot":
    skip_it "boots successfully in QEMU":
        # Requires QEMU installation
        check(true)

    skip_it "handles interrupts correctly":
        # Requires QEMU + test kernel with IDT
        check(true)
