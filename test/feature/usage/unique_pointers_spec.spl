# # Unique Pointers Specification
#
# **Feature ID:** #PTR-UNIQUE
# **Category:** Runtime
# **Status:** Implemented
#
# ## Overview
#
# UniquePtr provides exclusive ownership semantics via cooperative move tracking.
# Since Simple copies on assignment, unique_move returns a new valid ptr and
# marks the old one as moved internally.

use std.ptr.unique.{unique_new, unique_reset, unique_get, unique_is_valid, unique_move, unique_invalidate, unique_into_inner}


# ============================================================================
# Basic Unique Pointer Operations
# ============================================================================

describe "Unique - create and read":
    it "creates and reads value":
        unique_reset()
        val p = unique_new(42, "test")
        expect(unique_get(p)).to_equal(42)
        expect(unique_is_valid(p)).to_equal(true)
        unique_reset()

describe "Unique - move ownership":
    it "transfers ownership on move":
        unique_reset()
        val p1 = unique_new(100, "moveable")
        val p2 = unique_move(p1)
        expect(unique_is_valid(p1)).to_equal(false)
        expect(unique_is_valid(p2)).to_equal(true)
        expect(unique_get(p2)).to_equal(100)
        unique_reset()

describe "Unique - moved returns -1":
    it "get on moved ptr returns -1":
        unique_reset()
        val p = unique_new(77, "once")
        val p2 = unique_move(p)
        expect(unique_get(p)).to_equal(-1)
        unique_reset()

describe "Unique - into_inner":
    it "consumes and returns value":
        unique_reset()
        val p = unique_new(33, "consume")
        val v = unique_into_inner(p)
        expect(v).to_equal(33)
        expect(unique_is_valid(p)).to_equal(false)
        unique_reset()

describe "Unique - manual invalidate":
    it "marks as moved":
        unique_reset()
        val p = unique_new(55, "manual")
        unique_invalidate(p.id)
        expect(unique_is_valid(p)).to_equal(false)
        unique_reset()
