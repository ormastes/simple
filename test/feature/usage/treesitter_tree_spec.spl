# # TreeSitter OutlineModule Structure Specification
#
# **Feature IDs:** #TS-TREE-001 to #TS-TREE-020
# **Category:** Infrastructure | Parser
# **Status:** Implemented
#
# Tests that TreeSitter parses source into correct OutlineModule structure,
# including function, class, struct, enum, import, and export outlines.
#
# ## API
#
# ```simple
# use compiler.treesitter.*
#
# var ts = TreeSitter.new(source)
# val outline = ts.parse_outline()
# ```

use compiler.treesitter.*


# ============================================================================
# Test Group 1: Function Outline Parsing
# ============================================================================

describe "OutlineModule Function Parsing":
    # Tests parsing function declarations into FunctionOutline.

    it "parses a simple function":
        val source = "fn hello():\n    42"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.functions.len() to_equal 1
        val f = outline.functions[0]
        expect f.name to_equal "hello"

    it "parses function with parameters":
        val source = "fn add(x: i64, y: i64) -> i64:\n    x + y"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.functions.len() to_equal 1
        val f = outline.functions[0]
        expect f.name to_equal "add"
        expect f.params.len() to_equal 2

    it "parses extern function":
        val source = "extern fn rt_read(path: text) -> text"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.functions.len() to_equal 1
        val f = outline.functions[0]
        expect f.name to_equal "rt_read"
        expect f.is_extern to_equal true

    it "parses multiple functions":
        val source = "fn foo():\n    1\n\nfn bar():\n    2\n\nfn baz():\n    3"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.functions.len() to_equal 3


# ============================================================================
# Test Group 2: Class Outline Parsing
# ============================================================================

describe "OutlineModule Class Parsing":
    # Tests parsing class declarations into ClassOutline.

    it "parses a simple class":
        val source = "class Point:\n    x: i64\n    y: i64"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.classes.len() to_equal 1
        val c = outline.classes[0]
        expect c.name to_equal "Point"

    it "parses class fields":
        val source = "class Point:\n    x: i64\n    y: i64"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        val c = outline.classes[0]
        expect c.fields.len() to_equal 2


# ============================================================================
# Test Group 3: Struct Outline Parsing
# ============================================================================

describe "OutlineModule Struct Parsing":
    # Tests parsing struct declarations into StructOutline.

    it "parses a simple struct":
        val source = "struct Vec2:\n    x: f64\n    y: f64"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.structs.len() to_equal 1
        val s = outline.structs[0]
        expect s.name to_equal "Vec2"

    it "parses struct fields":
        val source = "struct Color:\n    r: u8\n    g: u8\n    b: u8"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        val s = outline.structs[0]
        expect s.fields.len() to_equal 3


# ============================================================================
# Test Group 4: Enum Outline Parsing
# ============================================================================

describe "OutlineModule Enum Parsing":
    # Tests parsing enum declarations into EnumOutline.

    it "parses a simple enum":
        val source = "enum Color:\n    Red\n    Green\n    Blue"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.enums.len() to_equal 1
        val e = outline.enums[0]
        expect e.name to_equal "Color"

    it "parses enum variants":
        val source = "enum Direction:\n    North\n    South\n    East\n    West"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        val e = outline.enums[0]
        expect e.variants.len() to_equal 4


# ============================================================================
# Test Group 5: Import/Export Parsing
# ============================================================================

describe "OutlineModule Import Parsing":
    # Tests parsing import and export declarations.

    it "parses use statement":
        val source = "use std.text.{NL2}\n\nfn main():\n    42"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.imports.len() >= 1

    it "parses export statement":
        val source = "export Foo, Bar"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.exports.len() to_equal 1


# ============================================================================
# Test Group 6: Multiple Declarations
# ============================================================================

describe "OutlineModule Multiple Declarations":
    # Tests parsing source with multiple declaration types.

    it "parses mixed declarations":
        val source = "fn hello():\n    42\n\nstruct Point:\n    x: i64\n    y: i64\n\nenum Color:\n    Red\n    Blue"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.functions.len() to_equal 1
        expect outline.structs.len() to_equal 1
        expect outline.enums.len() to_equal 1

    it "produces empty module for empty source":
        val source = ""
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.functions.len() to_equal 0
        expect outline.classes.len() to_equal 0
        expect outline.structs.len() to_equal 0
        expect outline.enums.len() to_equal 0
