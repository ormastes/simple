use std.spec

fn count_texts(items: [text]) -> i64:
    var n = 0
    for _item in items:
        n = n + 1
    n

fn has_text(items: [text], needle: text) -> bool:
    for item in items:
        if item == needle:
            return true
    false

val PARSER_PHASE = [
    "keyword: bitfield",
    "declaration syntax: bitfield Name(BackingType):",
    "lowering shape: struct with __raw plus named fields"
]

val VALIDATION_PHASE = [
    "storage widths: u8/u16/u32/u64",
    "field widths: bool/uN/iN",
    "reserved fields: _"
]

val COVERAGE_PATHS = [
    "test/feature/usage/bitfield_spec.spl",
    "test/feature/usage/bitfield_runtime_compat_spec.spl",
    "test/unit/compiler/parser/bitfield_pure_simple_spec.spl",
    "test/unit/compiler/native/bitfield_codegen_spec.spl",
    "src/compiler/10.frontend/core/parser_decls.spl",
    "src/compiler_cpp/real_compiler.c"
]

describe "Bitfield Feature Plan":
    it "locks parser phase scope":
        expect(count_texts(PARSER_PHASE)).to_equal(3)
        expect(has_text(PARSER_PHASE, "keyword: bitfield")).to_equal(true)
        expect(has_text(PARSER_PHASE, "declaration syntax: bitfield Name(BackingType):")).to_equal(true)

    it "locks validation phase scope":
        expect(count_texts(VALIDATION_PHASE)).to_equal(3)
        expect(has_text(VALIDATION_PHASE, "storage widths: u8/u16/u32/u64")).to_equal(true)
        expect(has_text(VALIDATION_PHASE, "reserved fields: _")).to_equal(true)

    it "links to canonical implementation plan":
        val docs = ["doc/plan/bitfield_feature_plan_2026-02-24.md"]
        expect(count_texts(docs)).to_equal(1)
        expect(has_text(docs, "doc/plan/bitfield_feature_plan_2026-02-24.md")).to_equal(true)

    it "tracks executable coverage paths":
        expect(count_texts(COVERAGE_PATHS)).to_equal(6)
        expect(has_text(COVERAGE_PATHS, "test/feature/usage/bitfield_runtime_compat_spec.spl")).to_equal(true)
        expect(has_text(COVERAGE_PATHS, "test/unit/compiler/parser/bitfield_pure_simple_spec.spl")).to_equal(true)
        expect(has_text(COVERAGE_PATHS, "test/unit/compiler/native/bitfield_codegen_spec.spl")).to_equal(true)
