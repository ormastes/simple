"""
# TreeSitter Parser Specification

**Feature IDs:** #TS-PARSER-001 to #TS-PARSER-020
**Category:** Infrastructure | Parser
**Status:** Implemented

Tests the basic TreeSitter.new(source).parse_outline() workflow,
verifying that source code is correctly parsed into an OutlineModule.

## API

```simple
use compiler.treesitter.*

var ts = TreeSitter.new(source)
val outline = ts.parse_outline()
```
"""

use compiler.treesitter.*


# ============================================================================
# Test Group 1: Parser Creation
# ============================================================================

describe "TreeSitter Parser Creation":
    """
    Tests that TreeSitter can be created from source code.
    """

    it "creates parser from source":
        var ts = TreeSitter.new("val x = 42")
        val outline = ts.parse_outline()
        # Parser created and parsed without crashing
        expect true to_equal true

    it "creates parser from empty source":
        var ts = TreeSitter.new("")
        val outline = ts.parse_outline()
        expect true to_equal true


# ============================================================================
# Test Group 2: Basic Function Parsing
# ============================================================================

describe "TreeSitter Basic Function Parsing":
    """
    Tests parsing function declarations.
    """

    it "parses single function":
        val source = "fn test():\n    42"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.functions.len() to_equal 1
        expect outline.functions[0].name to_equal "test"

    it "parses function with return type":
        val source = "fn get_value() -> i64:\n    42"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.functions.len() to_equal 1
        val f = outline.functions[0]
        expect f.name to_equal "get_value"
        expect f.has_return_type to_equal true

    it "parses function with parameters":
        val source = "fn greet(name: text) -> text:\n    name"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        val f = outline.functions[0]
        expect f.params.len() to_equal 1


# ============================================================================
# Test Group 3: Basic Struct Parsing
# ============================================================================

describe "TreeSitter Basic Struct Parsing":
    """
    Tests parsing struct declarations.
    """

    it "parses struct with fields":
        val source = "struct Point:\n    x: i64\n    y: i64"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.structs.len() to_equal 1
        val s = outline.structs[0]
        expect s.name to_equal "Point"
        expect s.fields.len() to_equal 2


# ============================================================================
# Test Group 4: Basic Enum Parsing
# ============================================================================

describe "TreeSitter Basic Enum Parsing":
    """
    Tests parsing enum declarations.
    """

    it "parses enum with variants":
        val source = "enum Direction:\n    North\n    South\n    East\n    West"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.enums.len() to_equal 1
        val e = outline.enums[0]
        expect e.name to_equal "Direction"
        expect e.variants.len() to_equal 4


# ============================================================================
# Test Group 5: Import Parsing
# ============================================================================

describe "TreeSitter Import Parsing":
    """
    Tests parsing import/use declarations.
    """

    it "parses use statement":
        val source = "use std.text.{NL2}\n\nfn main():\n    42"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.imports.len() >= 1


# ============================================================================
# Test Group 6: Export Parsing
# ============================================================================

describe "TreeSitter Export Parsing":
    """
    Tests parsing export declarations.
    """

    it "parses export statement":
        val source = "export Foo, Bar"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.exports.len() to_equal 1


# ============================================================================
# Test Group 7: Multi-Declaration Parsing
# ============================================================================

describe "TreeSitter Multi-Declaration Parsing":
    """
    Tests parsing source with multiple declaration types.
    """

    it "parses function and struct":
        val source = "fn hello():\n    42\n\nstruct Point:\n    x: i64\n    y: i64"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.functions.len() to_equal 1
        expect outline.structs.len() to_equal 1

    it "parses function, struct, and enum":
        val source = "fn hello():\n    42\n\nstruct Point:\n    x: i64\n\nenum Color:\n    Red\n    Blue"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.functions.len() to_equal 1
        expect outline.structs.len() to_equal 1
        expect outline.enums.len() to_equal 1


# ============================================================================
# Test Group 8: Complex Source Parsing
# ============================================================================

describe "TreeSitter Complex Source Parsing":
    """
    Tests parsing realistic Simple source code.
    """

    it "parses function with impl":
        val source = "struct Point:\n    x: i64\n    y: i64\n\nimpl Point:\n    fn get_x() -> i64:\n        self.x"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.structs.len() to_equal 1
        expect outline.impls.len() to_equal 1


# ============================================================================
# Test Group 9: Empty Source
# ============================================================================

describe "TreeSitter Empty Source Parsing":
    """
    Tests parsing empty and minimal source.
    """

    it "returns empty outline for empty source":
        var ts = TreeSitter.new("")
        val outline = ts.parse_outline()
        expect outline.functions.len() to_equal 0
        expect outline.classes.len() to_equal 0
        expect outline.structs.len() to_equal 0
        expect outline.enums.len() to_equal 0
        expect outline.traits.len() to_equal 0
        expect outline.impls.len() to_equal 0
