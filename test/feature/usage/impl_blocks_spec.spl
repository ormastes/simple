# # Implementation Blocks Specification
#
# **Feature IDs:** #830-835
# **Category:** Language
# **Difficulty:** 2/5
# **Status:** Implemented
#
# ## Overview
#
# Implementation blocks (`impl`) provide a flexible way to define methods for types outside
# of the type definition. This enables separation of concerns, method organization, and
# extension of types in different modules without modifying the original definition.
#
# ## Key Concepts
#
# | Concept | Description |
# |---------|-------------|
# | Impl Block | Collection of methods for a type |
# | Instance Method | Methods that receive self as implicit parameter |
# | Static Method | Methods that don't receive self |
# | Method Organization | Grouping related behavior in impl blocks |
#
# ## Behavior
#
# - Methods in impl blocks are part of the type's interface
# - Impl blocks can be placed in any module or location
# - Multiple impl blocks for the same type are merged
# - Static methods are called with type name prefix
# - Instance methods use dot notation on values



# ============================================================================
# Type Definitions (module level for impl blocks)
# ============================================================================

struct Point:
    x: i64
    y: i64

impl Point:
    fn get_x() -> i64:
        self.x

    fn get_y() -> i64:
        self.y

    static fn origin() -> Point:
        Point(x: 0, y: 0)

    static fn from_coords(x: i64, y: i64) -> Point:
        Point(x: x, y: y)


struct Rectangle:
    width: i64
    height: i64

impl Rectangle:
    fn area() -> i64:
        self.width * self.height

    fn perimeter() -> i64:
        2 * (self.width + self.height)


struct Circle:
    radius: f64

impl Circle:
    fn area() -> f64:
        3.14159 * self.radius * self.radius

    fn circumference() -> f64:
        2.0 * 3.14159 * self.radius


class Counter:
    count: i64

impl Counter:
    me increment():
        self.count = self.count + 1

    me decrement():
        self.count = self.count - 1


struct Temperature:
    celsius: f64

impl Temperature:
    static fn from_fahrenheit(f: f64) -> Temperature:
        Temperature(celsius: (f - 32.0) * 5.0 / 9.0)

    fn to_fahrenheit() -> f64:
        self.celsius * 9.0 / 5.0 + 32.0


# ============================================================================
# Basic Implementation Blocks
# ============================================================================

describe "Implementation Blocks - Basic":
    # ## Basic Impl Block Definition and Usage
    #
    # Tests basic implementation block syntax and method definition.

    it "defines methods in impl block":
        val p = Point(x: 5, y: 10)
        expect p.get_x() == 5

    it "defines multiple methods":
        val r = Rectangle(width: 4, height: 5)
        expect r.area() == 20
        expect r.perimeter() == 18


# ============================================================================
# Static Methods
# ============================================================================

describe "Implementation Blocks - Static Methods":
    # ## Static Method Definition
    #
    # Tests static methods in implementation blocks.

    it "uses static factory method":
        val p1 = Point.origin()
        expect p1.x == 0
        expect p1.y == 0

        val p2 = Point.from_coords(3, 4)
        expect p2.x == 3
        expect p2.y == 4


# ============================================================================
# Instance Methods
# ============================================================================

describe "Implementation Blocks - Instance Methods":
    # ## Instance Method Definition
    #
    # Tests instance methods that operate on self.

    it "defines immutable methods":
        val c = Circle(radius: 5.0)
        # Approximate equality due to floating point
        expect c.area() > 78.0
        expect c.circumference() > 31.0

    it "defines mutable methods":
        val c = Counter(count: 0)
        c.increment()
        expect c.count == 1
        c.decrement()
        expect c.count == 0


# ============================================================================
# Mixed Static and Instance
# ============================================================================

describe "Implementation Blocks - Mixed Methods":
    # ## Mixed Method Types
    #
    # Impl blocks can contain both static and instance methods.

    it "mixes static and instance methods":
        val t = Temperature.from_fahrenheit(32.0)
        # Approximately 0 celsius
        expect t.celsius > -1.0
        expect t.celsius < 1.0
