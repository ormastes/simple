# # Weak Pointers Specification
#
# **Feature ID:** #PTR-WEAK
# **Category:** Runtime
# **Status:** Implemented
#
# ## Overview
#
# Weak references provide non-owning references to values managed by a global
# weak reference table. When the target is invalidated (or strong count drops
# to zero), weak references return -1 on upgrade.

use std.ptr.weak.{weak_register, weak_reset, weak_create, weak_upgrade, weak_is_alive, weak_invalidate, weak_add_strong, weak_remove_strong, weak_strong_count}


# ============================================================================
# Basic Weak Reference Operations
# ============================================================================

describe "Weak - create and upgrade":
    it "creates and upgrades weak reference":
        weak_reset()
        val tid = weak_register(42)
        val w = weak_create(tid)
        expect(weak_upgrade(w)).to_equal(42)
        expect(weak_is_alive(w)).to_equal(true)
        weak_reset()

describe "Weak - expired reference":
    it "returns -1 after invalidation":
        weak_reset()
        val tid = weak_register(99)
        val w = weak_create(tid)
        weak_invalidate(tid)
        expect(weak_upgrade(w)).to_equal(-1)
        expect(weak_is_alive(w)).to_equal(false)
        weak_reset()

describe "Weak - auto-invalidate":
    it "invalidates when strong count drops to zero":
        weak_reset()
        val tid = weak_register(50)
        val w = weak_create(tid)
        weak_remove_strong(tid)
        expect(weak_is_alive(w)).to_equal(false)
        weak_reset()

describe "Weak - multiple refs":
    it "both expire together":
        weak_reset()
        val tid = weak_register(77)
        val w1 = weak_create(tid)
        val w2 = weak_create(tid)
        expect(weak_upgrade(w1)).to_equal(77)
        expect(weak_upgrade(w2)).to_equal(77)
        weak_invalidate(tid)
        expect(weak_upgrade(w1)).to_equal(-1)
        expect(weak_upgrade(w2)).to_equal(-1)
        weak_reset()

describe "Weak - strong count tracking":
    it "tracks add and remove":
        weak_reset()
        val tid = weak_register(10)
        expect(weak_strong_count(tid)).to_equal(1)
        weak_add_strong(tid)
        expect(weak_strong_count(tid)).to_equal(2)
        weak_remove_strong(tid)
        expect(weak_strong_count(tid)).to_equal(1)
        weak_reset()
