"""
# LLVM Backend RISC-V 32-bit Specification


**Feature IDs:** #4003
**Category:** Infrastructure
**Difficulty:** 3/5
**Status:** In Progress

Validates that the LLVM backend correctly generates code for RISC-V 32-bit targets.
"""

use compiler.backend.llvm_ir_builder.{LlvmIRBuilder, LlvmIRBuilder__create, MirToLlvm, MirToLlvm__create}
use compiler.backend.llvm_target.{LlvmTargetTriple, LlvmTargetTriple__from_target, LlvmTargetConfig, LlvmTargetConfig__for_target}
use compiler.backend.llvm_type_mapper.{LlvmTypeMapper, LlvmTypeMapper__create_for_target}
use compiler.backend.entry_point.halt_instruction_for_target
use compiler.backend.backend_types.{CodegenTarget, OptimizationLevel}

describe "LLVM Backend RISC-V 32":

    context "target triple":
        it "generates correct riscv32 triple":
            val triple = LlvmTargetTriple__from_target(CodegenTarget.Riscv32)
            expect(triple.arch).to_equal("riscv32")
            expect(triple.to_text()).to_contain("riscv32")

    context "datalayout":
        it "contains correct riscv32 layout":
            val triple = LlvmTargetTriple__from_target(CodegenTarget.Riscv32)
            val dl = triple.datalayout()
            expect(dl).to_contain("p:32:32")

    context "CPU defaults":
        it "defaults to generic-rv32":
            val config = LlvmTargetConfig__for_target(CodegenTarget.Riscv32, nil)
            expect(config.cpu).to_equal("generic-rv32")

        it "includes standard extensions":
            val config = LlvmTargetConfig__for_target(CodegenTarget.Riscv32, nil)
            expect(config.features).to_contain("+m")
            expect(config.features).to_contain("+a")
            expect(config.features).to_contain("+f")
            expect(config.features).to_contain("+d")
            expect(config.features).to_contain("+c")

    context "native integer type":
        it "native_int_type is i32":
            var translator = MirToLlvm__create("test", CodegenTarget.Riscv32, nil)
            expect(translator.native_int()).to_equal("i32")

    context "type mapping":
        it "uses 32-bit target_bits":
            val mapper = LlvmTypeMapper__create_for_target(CodegenTarget.Riscv32)
            expect(mapper.target_bits).to_equal(32)

    context "bare-metal entry":
        it "uses wfi instruction for halt":
            val halt = halt_instruction_for_target(CodegenTarget.Riscv32)
            expect(halt).to_equal("wfi")

    context "builder size type":
        it "uses i32 size type":
            val triple = LlvmTargetTriple__from_target(CodegenTarget.Riscv32)
            var builder = LlvmIRBuilder__create("test", triple)
            expect(builder.size_type).to_equal("i32")
