# # Mat4 Specification
#
# **Feature IDs:** #MATH-002
# **Category:** Stdlib
# **Difficulty:** 3/5
# **Status:** Implemented
#
# ## Overview
# Mat4 (f32) and Mat4d (f64) 4x4 transformation matrices with column-major storage.
#
# ## Key Concepts
# | Concept | Description |
# |---------|-------------|
# | Column-major | GPU/Vulkan standard storage order |
# | Transform | Translation, rotation, scale factories |
# | Projection | Perspective and orthographic projection |
#
# ## Behavior
# - Column-major storage for GPU compatibility
# - Factory methods for common transforms
# - Matrix multiplication and inverse
# - Point and vector transformation

use math

# ============================================================================
# Mat4 Identity and Factories
# ============================================================================

describe "Mat4 Identity and Factories":
    it "creates identity matrix":
        val m = math.Mat4.identity()
        expect m.data[0] == 1.0
        expect m.data[5] == 1.0
        expect m.data[10] == 1.0
        expect m.data[15] == 1.0
        expect m.data[1] == 0.0

    it "creates translation matrix":
        val m = math.Mat4.translation(1.0, 2.0, 3.0)
        # Column-major: translation in column 3 (indices 12, 13, 14)
        expect m.data[12] == 1.0
        expect m.data[13] == 2.0
        expect m.data[14] == 3.0

    it "creates scale matrix":
        val m = math.Mat4.scale(2.0, 3.0, 4.0)
        expect m.data[0] == 2.0
        expect m.data[5] == 3.0
        expect m.data[10] == 4.0

# ============================================================================
# Mat4 Operations
# ============================================================================

describe "Mat4 Operations":
    it "multiplies identity by identity":
        val a = math.Mat4.identity()
        val b = math.Mat4.identity()
        val c = a.mul(b)
        expect c.data[0] == 1.0
        expect c.data[5] == 1.0
        expect c.data[10] == 1.0
        expect c.data[15] == 1.0

    it "multiplies translation matrices":
        val a = math.Mat4.translation(1.0, 0.0, 0.0)
        val b = math.Mat4.translation(0.0, 2.0, 0.0)
        val c = a.mul(b)
        # Combined translation: (1, 2, 0)
        expect c.data[12] == 1.0
        expect c.data[13] == 2.0
        expect c.data[14] == 0.0

    it "transforms a point":
        val m = math.Mat4.translation(10.0, 20.0, 30.0)
        val p = math.Vec3(1.0, 2.0, 3.0)
        val result = m.transform_point(p)
        expect result.x == 11.0
        expect result.y == 22.0
        expect result.z == 33.0

    it "transforms a direction vector (ignores translation)":
        val m = math.Mat4.translation(10.0, 20.0, 30.0)
        val v = math.Vec3(1.0, 0.0, 0.0)
        val result = m.transform_vec3(v)
        expect result.x == 1.0
        expect result.y == 0.0
        expect result.z == 0.0

    it "extracts 3x3 submatrix":
        val m = math.Mat4.scale(2.0, 3.0, 4.0)
        val m3 = m.to_mat3()
        expect m3.data[0] == 2.0
        expect m3.data[4] == 3.0
        expect m3.data[8] == 4.0

# ============================================================================
# Mat4 Inverse
# ============================================================================

describe "Mat4 Inverse":
    it "inverts identity to identity":
        val m = math.Mat4.identity()
        val inv = m.inverse()
        expect inv.data[0] == 1.0
        expect inv.data[5] == 1.0

    it "inverts translation":
        val m = math.Mat4.translation(5.0, 10.0, 15.0)
        val inv = m.inverse()
        # Inverse translation should negate
        expect inv.data[12] == -5.0
        expect inv.data[13] == -10.0
        expect inv.data[14] == -15.0
