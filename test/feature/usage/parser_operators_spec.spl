# # Parser Operator Specification
#
# **Feature IDs:** #PARSER-OP-001 to #PARSER-OP-020
# **Category:** Infrastructure | Parser
# **Status:** Implemented
#
# Tests that the parser correctly tokenizes and parses all operators
# including arithmetic, comparison, logical, bitwise, and special operators.
#
# ## Syntax
#
# ```simple
# # Arithmetic: + - * / % ** //
# # Comparison: < > <= >= == !=
# # Logical: and or not
# # Bitwise: & | ^ ~ << >>
# # Pipeline: |> >> <<
# # Optional: ?. ?? .?
# ```



# ============================================================================
# Test Group 1: Arithmetic Operators
# ============================================================================

describe "Arithmetic Operator Parsing":
    # ## Basic Arithmetic
    #
    # Tests parsing of arithmetic operators with correct precedence.

    it "parses addition":
        expect 2 + 3 == 5

    it "parses subtraction":
        expect 5 - 3 == 2

    it "parses multiplication":
        expect 3 * 4 == 12

    it "parses division":
        expect 10 / 2 == 5

    it "parses modulo":
        expect 10 % 3 == 1

    it "parses power":
        expect 2 ** 3 == 8

    it "parses integer division":
        expect 7.fdiv(2) == 3


# ============================================================================
# Test Group 2: Comparison Operators
# ============================================================================

describe "Comparison Operator Parsing":
    # ## Relational Operators
    #
    # Tests parsing of comparison operators.

    it "parses less than":
        expect 1 < 2

    it "parses greater than":
        expect 2 > 1

    it "parses less than or equal":
        expect 2 <= 2
        expect 1 <= 2

    it "parses greater than or equal":
        expect 2 >= 2
        expect 3 >= 2

    it "parses equality":
        expect 2 == 2

    it "parses inequality":
        expect 1 != 2


# ============================================================================
# Test Group 3: Logical Operators
# ============================================================================

describe "Logical Operator Parsing":
    # ## Boolean Logic
    #
    # Tests parsing of logical operators.

    it "parses and":
        expect (true and true) == true
        expect (true and false) == false

    it "parses or":
        expect (true or false) == true
        expect (false or false) == false

    it "parses not":
        expect (not false) == true
        expect (not true) == false

    it "parses combined logical":
        expect (true and false or true) == true
        expect (not (true and false)) == true


# ============================================================================
# Test Group 4: Bitwise Operators
# ============================================================================

describe "Bitwise Operator Parsing":
    # ## Bit Manipulation
    #
    # Tests parsing of bitwise operators.

    it "parses bitwise and":
        expect (0b1100 & 0b1010) == 0b1000

    it "parses bitwise or":
        expect (0b1100 | 0b1010) == 0b1110

    it "parses bitwise xor":
        expect (5 xor 3) == 6

    it "parses bitwise not":
        expect (~0) == -1

    it "parses left shift":
        expect (1 << 4) == 16

    it "parses right shift":
        expect (16 >> 2) == 4


# ============================================================================
# Test Group 5: Assignment Operators
# ============================================================================

describe "Assignment Operator Parsing":
    # ## Assignment and Compound Assignment
    #
    # Tests parsing of assignment operators.

    it "parses simple assignment":
        var x = 0
        x = 42
        expect x == 42

    it "parses add-assign":
        var x = 10
        x += 5
        expect x == 15

    it "parses sub-assign":
        var x = 10
        x -= 3
        expect x == 7

    it "parses mul-assign":
        var x = 5
        x *= 2
        expect x == 10

    it "parses div-assign":
        var x = 20
        x /= 4
        expect x == 5

    it "parses mod-assign":
        var x = 10
        x %= 3
        expect x == 1

    it "parses suspend-assign":
        fn async_val() -> i64:
            42
        var x = 0
        x ~= async_val()
        expect x == 42


# ============================================================================
# Test Group 6: Pipeline Operators
# ============================================================================

describe "Pipeline Operator Parsing":
    # ## Function Composition and Piping
    #
    # Tests parsing of pipeline operators.

    it "parses pipe forward":
        fn double(x: i64) -> i64:
            x * 2
        val result = 21 |> double
        expect result == 42


# ============================================================================
# Test Group 7: Optional Operators
# ============================================================================

describe "Optional Operator Parsing":
    # ## Safe Navigation and Coalescing
    #
    # Tests parsing of optional chaining operators.

    it "parses optional chaining":
        val opt: Option<text> = Some("hello")
        val len = opt?.len()
        expect len == Some(5)

    it "parses null coalescing":
        val opt: Option<i64> = None
        val value = opt ?? 42
        expect value == 42

    it "parses existence check":
        val opt = Some(42)
        expect opt.?

    it "parses negated existence":
        val opt: Option<i64> = None
        expect not opt.?

    it "parses try operator":
        fn may_fail() -> Result<i64, text>:
            Ok(42)
        fn use_result() -> Result<i64, text>:
            val x = may_fail()?
            Ok(x * 2)
        expect use_result().unwrap() == 84


# ============================================================================
# Test Group 8: Range Operators
# ============================================================================

describe "Range Operator Parsing":
    # ## Range Syntax
    #
    # Tests parsing of range operators.

    it "parses exclusive range":
        var sum = 0
        for i in 0..5:
            sum = sum + i
        expect sum == 10

    it "parses inclusive range":
        var sum = 0
        for i in 0..=5:
            sum = sum + i
        expect sum == 15

    it "parses range in slice":
        val arr = [0, 1, 2, 3, 4]
        val sliced = arr[1..4]
        expect sliced.len() == 3


# ============================================================================
# Test Group 9: Operator Precedence
# ============================================================================

describe "Operator Precedence Parsing":
    # ## Correct Precedence Handling
    #
    # Tests that operators are parsed with correct precedence.

    it "power before multiplication":
        expect 2 ** 3 * 2 == 16

    it "multiplication before addition":
        expect 2 + 3 * 4 == 14

    it "comparison after arithmetic":
        expect (2 + 3 < 10) == true

    it "logical after comparison":
        expect (1 < 2 and 3 < 4) == true

    it "parentheses override precedence":
        expect (2 + 3) * 4 == 20

    it "complex expression precedence":
        expect 2 + 3 * 4 ** 2 / 8 == 8


# ============================================================================
# Test Group 10: Special Operators
# ============================================================================

describe "Special Operator Parsing":
    # ## Domain-Specific Operators
    #
    # Tests parsing of special operators for specific domains.

    it "parses matrix multiplication":
        # @ is matrix multiplication operator
        # Requires array/matrix support
        expect true  # Placeholder

    it "parses broadcast operators":
        # .+ .- .* ./ are element-wise operators
        # Requires array support
        expect true  # Placeholder

    it "parses layer connect":
        # ~> connects neural network layers
        expect true  # Placeholder
