# # TreeSitter Advanced Outline Parsing Specification
#
# **Feature IDs:** #TS-QUERY-001 to #TS-QUERY-020
# **Category:** Infrastructure | Parser
# **Status:** Implemented
#
# Tests advanced outline features: type parameters, traits, impls,
# type aliases, and constants.
#
# ## API
#
# ```simple
# use compiler.treesitter.*
#
# var ts = TreeSitter.new(source)
# val outline = ts.parse_outline()
# ```

use compiler.treesitter.*


# ============================================================================
# Test Group 1: Type Parameters
# ============================================================================

describe "OutlineModule Type Parameters":
    # Tests parsing generic type parameters on declarations.

    it "parses struct with type parameter":
        val source = "struct Box<T>:\n    value: T"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.structs.len() to_equal 1
        val s = outline.structs[0]
        expect s.name to_equal "Box"
        expect s.type_params.len() to_equal 1

    it "parses class with multiple type parameters":
        val source = "class Pair<A, B>:\n    first: A\n    second: B"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.classes.len() to_equal 1
        val c = outline.classes[0]
        expect c.name to_equal "Pair"
        expect c.type_params.len() to_equal 2


# ============================================================================
# Test Group 2: Trait Outline
# ============================================================================

describe "OutlineModule Trait Parsing":
    # Tests parsing trait declarations.

    it "parses trait with methods":
        val source = "trait Drawable:\n    fn draw():\n        pass\n    fn area() -> f64:\n        0.0"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.traits.len() to_equal 1
        val t = outline.traits[0]
        expect t.name to_equal "Drawable"

    it "parses empty trait":
        val source = "trait Marker:\n    pass"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.traits.len() to_equal 1
        val t = outline.traits[0]
        expect t.name to_equal "Marker"


# ============================================================================
# Test Group 3: Impl Outline
# ============================================================================

describe "OutlineModule Impl Parsing":
    # Tests parsing impl blocks.

    it "parses impl with methods":
        val source = "impl Point:\n    fn get_x() -> i64:\n        self.x\n    fn get_y() -> i64:\n        self.y"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.impls.len() to_equal 1

    it "parses impl with static method":
        val source = "impl Point:\n    static fn origin() -> Point:\n        Point(x: 0, y: 0)"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.impls.len() to_equal 1


# ============================================================================
# Test Group 4: Type Alias Outline
# ============================================================================

describe "OutlineModule Type Alias Parsing":
    # Tests parsing type alias declarations.

    it "parses type alias":
        val source = "type Point2D = Point"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.type_aliases.len() to_equal 1
        val ta = outline.type_aliases[0]
        expect ta.name to_equal "Point2D"


# ============================================================================
# Test Group 5: Const Outline
# ============================================================================

describe "OutlineModule Const Parsing":
    # Tests parsing val/var at module level.

    it "parses val declaration":
        val source = "val PI = 3.14"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.constants.len() to_equal 1
        val c = outline.constants[0]
        expect c.name to_equal "PI"
        expect c.is_mutable to_equal false

    it "parses var declaration":
        val source = "var counter = 0"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.constants.len() to_equal 1
        val c = outline.constants[0]
        expect c.name to_equal "counter"
        expect c.is_mutable to_equal true


# ============================================================================
# Test Group 6: Multiple Advanced Declarations
# ============================================================================

describe "OutlineModule Mixed Advanced Declarations":
    # Tests parsing multiple advanced declaration types together.

    it "parses traits and impls together":
        val source = "trait Shape:\n    fn area() -> f64:\n        0.0\n\nimpl Circle:\n    fn area() -> f64:\n        3.14"
        var ts = TreeSitter.new(source)
        val outline = ts.parse_outline()
        expect outline.traits.len() to_equal 1
        expect outline.impls.len() to_equal 1
