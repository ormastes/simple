"""
# Existence Check Operator (.?) Specification

**Feature IDs:** #2100
**Category:** Syntax
**Difficulty:** 3/5
**Status:** Implemented
**Research:** doc/research/text_validity_presence_pattern_2026-02-24.md

## Overview

The `.?` operator checks if a value is "present" (non-nil AND non-empty).
Returns `T?` — the value itself if present, `nil` if absent.

After compiler rebuild, `.?` returns `T?` instead of `bool`, enabling
pattern binding (`if val x = expr.?:`) and nil coalescing (`expr.? ?? default`).

## Behavior

- Option types: pass-through (Some stays Some, nil stays nil)
- Collections: returns value if non-empty, nil if empty
- Strings: returns value if non-empty, nil if ""
- Primitives: always returns value (0, false are still present)

## Related

- `presence(text) -> text?` — named equivalent for text
- `presence_trimmed(text) -> text?` — blank-aware variant
"""

describe "Existence Check Operator .?":
    """
    ## Existence Check

    Verifies the `.?` operator that tests whether a value is
    "present" (non-nil AND non-empty). Works across Option, collections,
    strings, and primitives. Integrates with no-paren method calls.
    """

    context "Option type":
        """
        ### Option Presence

        `Some(x).?` is truthy (value exists), `None.?` is falsy.
        """

        it "returns true for Some":
            val some_val: Option<i32> = Some(42)
            expect some_val.? == true

        it "returns true for Some(0)":
            val some_zero: Option<i32> = Some(0)
            expect some_zero.? == true

        it "returns false for None":
            val none_val: Option<i32> = None
            expect none_val.? == false

    context "List type":
        """
        ### List Presence

        Non-empty lists are present, empty lists are absent.
        """

        it "returns false for empty list":
            val empty: List<i32> = []
            expect empty.? == false

        it "returns true for non-empty list":
            val items = [1, 2, 3]
            expect items.? == true

    context "Dict type":
        """
        ### Dict Presence

        Non-empty dicts are present, empty dicts are absent.
        """

        it "returns false for empty dict":
            val empty: Dict<text, i32> = {}
            expect empty.? == false

        it "returns true for non-empty dict":
            val items = {"a": 1}
            expect items.? == true

    context "String type":
        """
        ### String Presence

        Non-empty strings are present, `""` is absent.
        """

        it "returns false for empty string":
            val empty = ""
            expect empty.? == false

        it "returns true for non-empty string":
            val s = "hello"
            expect s.? == true

    context "Primitive types":
        """
        ### Primitive Presence

        Primitives always exist — even `0` and `false` are present values.
        """

        it "returns true for positive number":
            val num = 42
            expect num.? == true

        it "returns true for zero":
            val zero = 0
            expect zero.? == true

        it "returns true for false":
            val flag = false
            expect flag.? == true

    context "with no-paren method calls":
        """
        ### No-Paren + Existence

        `.?` chains with no-paren method calls for idiomatic patterns.
        """

        it "works with list.first.?":
            val items = [1, 2, 3]
            expect items.first.? == true

        it "returns false for empty list.first.?":
            val empty: List<i32> = []
            expect empty.first.? == false

        it "works with string.trim.?":
            val s = "  hello  "
            expect s.trim.? == true

        it "works with chained no-paren methods":
            val s = "  HELLO  "
            expect s.trim.lower.? == true

        it "returns false for empty result":
            val empty = ""
            expect empty.trim.? == false
