"""
# GPU Basic Operations

**Feature ID:** #GPU-002
**Category:** Runtime
**Status:** In Progress

## Overview

Tests GPU device detection and basic operations across all backends. Validates
backend detection, preferred backend selection, device listing, memory allocation
and deallocation (including typed f32 arrays), host-to-device and device-to-host
data transfers, device synchronization, and GPU info reporting. Most tests
require GPU hardware to be available.

## Syntax

```simple
val backends = detect_backends()
val device = gpu_default()
val buffer = gpu_alloc(device, 1024)
gpu_copy_to(buffer, data)
```
"""
# GPU Basic Tests
#
# Tests for GPU device detection and basic operations.

use std.compute.*
use std.testing.gpu_helpers.*
use std.spec.{check, check_msg}

describe "GPU Device Management":
    it "detects available backends":
        val backends = detect_backends()
        # At minimum, we should get an empty list or some backends
        expect(backends.len() >= 0).to_equal(true)

    it "gets preferred backend":
        val backend = preferred_backend()
        # Should return a valid enum variant
        if backend == GpuBackend.Cuda:
            expect(true).to_equal(true)
        elif backend == GpuBackend.Vulkan:
            expect(true).to_equal(true)
        elif backend == GpuBackend.NoGpu:
            expect(true).to_equal(true)
        else:
            expect(true).to_equal(true)

    it "lists all GPUs":
        val devices = list_all_gpus()
        # Should return a list (may be empty)
        expect(devices.len() >= 0).to_equal(true)

    it "reports GPU availability consistently":
        val available = gpu_available()
        val count = gpu_count()
        if available:
            expect(count > 0).to_equal(true)
        else:
            expect(count).to_equal(0)

describe "GPU Default Device":
    it "creates default GPU device":
        val device = gpu_default()
        # gpu_default should always return, even if invalid
        expect(true).to_equal(true)

    it "reports device validity correctly":
        val device = gpu_default()
        if gpu_available():
            expect(device.is_valid()).to_equal(true)
        else:
            expect(not device.is_valid()).to_equal(true)

    # @tag(reason: "requires_gpu")  # @skip - attributes on test cases not supported
    it "gets device name":
        require_gpu()
        val device = gpu_default()
        val name = device.name()
        expect(name.len() > 0).to_equal(true)

    # @tag(reason: "requires_gpu")  # @skip - attributes on test cases not supported
    it "gets device memory":
        require_gpu()
        val device = gpu_default()
        val mem = device.total_memory()
        expect(mem > 0).to_equal(true)

describe "GPU Memory Allocation":
    # @tag(reason: "requires_gpu")  # @skip - attributes on test cases not supported
    it "allocates and frees buffer":
        require_gpu()
        val device = gpu_default()
        val buffer = gpu_alloc(device, 1024)
        expect(buffer.is_valid).to_equal(true)
        expect(buffer.len() == 1024).to_equal(true)
        expect(gpu_free(buffer)).to_equal(true)

    # @tag(reason: "requires_gpu")  # @skip - attributes on test cases not supported
    it "handles zero-size allocation":
        require_gpu()
        val device = gpu_default()
        val buffer = gpu_alloc(device, 0)
        # Zero-size allocation behavior may vary by backend
        gpu_free(buffer)

    # @tag(reason: "requires_gpu")  # @skip - attributes on test cases not supported
    it "allocates typed arrays":
        require_gpu()
        val device = gpu_default()
        val floats = gpu_alloc_f32(device, 100)
        expect(floats.valid()).to_equal(true)
        expect(floats.count() == 100).to_equal(true)
        expect(floats.size_bytes() == 400).to_equal(true)  # 100 * 4 bytes

describe "GPU Data Transfer":
    # @tag(reason: "requires_gpu")  # @skip - attributes on test cases not supported
    it "copies data to device":
        require_gpu()
        val device = gpu_default()
        val buffer = gpu_alloc(device, 16)

        val data: [u8] = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16]
        val success = gpu_copy_to(buffer, data)
        expect(success).to_equal(true)

        gpu_free(buffer)

    # @tag(reason: "requires_gpu")  # @skip - attributes on test cases not supported
    it "copies data from device":
        require_gpu()
        val device = gpu_default()
        val buffer = gpu_alloc(device, 16)

        val src: [u8] = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16]
        gpu_copy_to(buffer, src)

        var dst: [u8] = []
        for i in 0..16:
            dst.push(0)

        val success = gpu_copy_from(dst, buffer)
        expect(success).to_equal(true)
        # Note: dst should now contain the data from the GPU

        gpu_free(buffer)

describe "GPU Synchronization":
    # @tag(reason: "requires_gpu")  # @skip - attributes on test cases not supported
    it "synchronizes device":
        require_gpu()
        val device = gpu_default()
        expect(device.wait_for_idle()).to_equal(true)

    # @tag(reason: "requires_gpu")  # @skip - attributes on test cases not supported
    it "synchronizes all devices":
        require_gpu()
        expect(gpu_wait_all()).to_equal(true)

describe "GPU Info":
    it "generates GPU info string":
        val info = gpu_info()
        expect(info.len() > 0).to_equal(true)
        expect(info.contains("GPU Information")).to_equal(true)

    # @tag(reason: "requires_gpu")  # @skip - attributes on test cases not supported
    it "runs GPU smoke test":
        require_gpu()
        expect(gpu_test_basic()).to_equal(true)

    # @tag(reason: "requires_gpu")  # @skip - attributes on test cases not supported
    it "reports GPU is ready":
        require_gpu()
        expect(gpu_is_ready()).to_equal(true)
