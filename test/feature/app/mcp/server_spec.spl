# # MCP Server Specification
#
# **Feature IDs:** #TBD
# **Category:** Tooling
# **Status:** In Progress
#
# ## Overview
#
# Tests that the Simple MCP server responds correctly to basic
# MCP protocol messages (initialize, tools/list).

use std.spec
use app.io.mod.{shell, shell_output, cwd, file_exists}
use std.text.{contains}


fn skip_on_interpreter(name: text, block: fn()):
    print "    it {name} ... skipped (interpreter mode)"

describe "MCP Server":
    it "responds to initialize message with protocolVersion":
        skip_on_interpreter "requires compiled MCP server binary":
            val base_dir = cwd()
            val mcp_server = base_dir + "/bin/simple_mcp_server_optimized"
            val init_msg = "{\"jsonrpc\":\"2.0\",\"method\":\"initialize\",\"params\":{\"protocolVersion\":\"2025-06-18\",\"capabilities\":{}},\"id\":1}"
            val init_cmd = "(echo 'Content-Length: " + init_msg.len().to_text() + "'; echo ''; echo '" + init_msg + "'; sleep 0.5) | timeout 2 " + mcp_server + " server 2>/dev/null"
            val init_result = shell(init_cmd)
            expect(contains(init_result.stdout, "protocolVersion")).to_equal(true)

    it "responds to tools/list with tool names":
        skip_on_interpreter "requires compiled MCP server binary":
            val base_dir = cwd()
            val mcp_server = base_dir + "/bin/simple_mcp_server_optimized"
            val init_msg = "{\"jsonrpc\":\"2.0\",\"method\":\"initialize\",\"params\":{\"protocolVersion\":\"2025-06-18\",\"capabilities\":{}},\"id\":1}"
            val tools_msg = "{\"jsonrpc\":\"2.0\",\"method\":\"tools/list\",\"id\":2}"
            val tools_cmd = "(echo 'Content-Length: " + init_msg.len().to_text() + "'; echo ''; echo '" + init_msg + "'; echo 'Content-Length: " + tools_msg.len().to_text() + "'; echo ''; echo '" + tools_msg + "'; sleep 0.5) | timeout 2 " + mcp_server + " server 2>/dev/null"
            val tools_result = shell(tools_cmd)
            expect(contains(tools_result.stdout, "tools")).to_equal(true)
