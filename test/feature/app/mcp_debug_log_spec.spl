# MCP Debug Log Tools Specification
#
# Tests for src/app/mcp/debug_log_tools.spl
# MCP tool handlers and schemas for debug logging.

use compiler_core.aop_debug_log.{debug_log_enable, debug_log_disable, debug_log_clear, debug_log_enter, debug_log_exit, debug_log_get_entries}
use app.mcp.debug_log_tools.{schema_debug_log_enable, schema_debug_log_disable, schema_debug_log_clear, schema_debug_log_query, schema_debug_log_tree, schema_debug_log_status, handle_debug_log_enable, handle_debug_log_disable, handle_debug_log_clear, handle_debug_log_query, handle_debug_log_tree, handle_debug_log_status, handle_debuglog_resource}

describe "MCP Debug Log Tools":

    context "tool schemas":
        it "generates enable schema with pattern param":
            val schema = schema_debug_log_enable()
            expect(schema).to_contain("debug_log_enable")
            expect(schema).to_contain("pattern")
            expect(schema).to_contain("Enable AOP debug logging")

        it "generates disable schema":
            val schema = schema_debug_log_disable()
            expect(schema).to_contain("debug_log_disable")
            expect(schema).to_contain("Disable AOP debug logging")

        it "generates clear schema with destructive hint":
            val schema = schema_debug_log_clear()
            expect(schema).to_contain("debug_log_clear")
            expect(schema).to_contain("\"destructiveHint\":true")

        it "generates query schema with filter params":
            val schema = schema_debug_log_query()
            expect(schema).to_contain("debug_log_query")
            expect(schema).to_contain("since_id")
            expect(schema).to_contain("entry_type")
            expect(schema).to_contain("max_results")
            expect(schema).to_contain("function_pattern")

        it "generates tree schema with format and expand params":
            val schema = schema_debug_log_tree()
            expect(schema).to_contain("debug_log_tree")
            expect(schema).to_contain("format")
            expect(schema).to_contain("max_depth")
            expect(schema).to_contain("expanded_groups")

        it "generates status schema as read-only":
            val schema = schema_debug_log_status()
            expect(schema).to_contain("debug_log_status")
            expect(schema).to_contain("\"readOnlyHint\":true")

    context "handle_debug_log_enable":
        it "enables logging and returns status":
            debug_log_clear()
            debug_log_disable()
            val body = "{\"arguments\":{\"pattern\":\"parse_*\"}}"
            val result = handle_debug_log_enable("1", body)
            expect(result).to_contain("enabled")
            expect(result).to_contain("parse_*")
            debug_log_disable()

    context "handle_debug_log_disable":
        it "disables logging":
            debug_log_enable("*")
            val result = handle_debug_log_disable("2")
            expect(result).to_contain("disabled")

    context "handle_debug_log_clear":
        it "clears all entries":
            debug_log_enable("*")
            debug_log_enter("func", "mod", "", 1, "")
            val result = handle_debug_log_clear("3")
            expect(result).to_contain("cleared")
            expect(result).to_contain("\"entry_count\":0")
            debug_log_disable()

    context "handle_debug_log_query":
        it "returns entries as JSON":
            debug_log_clear()
            debug_log_enable("*")
            val g1 = debug_log_enter("query_test", "mod", "", 1, "")
            debug_log_exit("query_test", "mod", g1, 0)
            val body = "{\"arguments\":{}}"
            val result = handle_debug_log_query("4", body)
            expect(result).to_contain("query_test")
            expect(result).to_contain("\"count\":")
            debug_log_disable()

        it "filters by entry_type":
            debug_log_clear()
            debug_log_enable("*")
            val g1 = debug_log_enter("filtered", "mod", "", 1, "")
            debug_log_exit("filtered", "mod", g1, 0)
            val body = "{\"arguments\":{\"entry_type\":\"enter\"}}"
            val result = handle_debug_log_query("5", body)
            expect(result).to_contain("\"count\":1")
            debug_log_disable()

    context "handle_debug_log_tree":
        it "returns text tree by default":
            debug_log_clear()
            debug_log_enable("*")
            val g1 = debug_log_enter("tree_func", "app.mod", "", 10, "x=1")
            debug_log_exit("tree_func", "app.mod", g1, 0)
            val body = "{\"arguments\":{}}"
            val result = handle_debug_log_tree("6", body)
            expect(result).to_contain("\"format\":\"text\"")
            expect(result).to_contain("tree_func")
            debug_log_disable()

        it "returns JSON tree when format=json":
            debug_log_clear()
            debug_log_enable("*")
            val g1 = debug_log_enter("json_func", "mod", "", 5, "")
            debug_log_exit("json_func", "mod", g1, 0)
            val body = "{\"arguments\":{\"format\":\"json\"}}"
            val result = handle_debug_log_tree("7", body)
            expect(result).to_contain("\"format\":\"json\"")
            expect(result).to_contain("json_func")
            debug_log_disable()

    context "handle_debug_log_status":
        it "returns current status":
            debug_log_clear()
            debug_log_enable("test_*")
            debug_log_enter("test_fn", "mod", "", 1, "")
            val result = handle_debug_log_status("8")
            expect(result).to_contain("\"enabled\":true")
            expect(result).to_contain("test_*")
            debug_log_disable()

    context "debuglog resource":
        it "handles /status query":
            debug_log_clear()
            debug_log_enable("*")
            val content = handle_debuglog_resource("/status")
            expect(content).to_contain("\"enabled\":true")
            debug_log_disable()

        it "handles /entries query":
            debug_log_clear()
            debug_log_enable("*")
            debug_log_enter("res_func", "mod", "", 1, "")
            val content = handle_debuglog_resource("/entries")
            expect(content).to_contain("res_func")
            debug_log_disable()

        it "handles /tree query":
            debug_log_clear()
            debug_log_enable("*")
            val g1 = debug_log_enter("tree_res", "mod", "", 1, "")
            debug_log_exit("tree_res", "mod", g1, 0)
            val content = handle_debuglog_resource("/tree")
            expect(content).to_contain("tree_res")
            debug_log_disable()

        it "handles /text query":
            debug_log_clear()
            debug_log_enable("*")
            val g1 = debug_log_enter("text_res", "app.mod", "", 1, "")
            debug_log_exit("text_res", "app.mod", g1, 0)
            val content = handle_debuglog_resource("/text")
            expect(content).to_contain("text_res")
            expect(content).to_contain(">>")
            debug_log_disable()

        it "returns error for unknown query":
            val content = handle_debuglog_resource("/unknown")
            expect(content).to_contain("Unknown debuglog query")
