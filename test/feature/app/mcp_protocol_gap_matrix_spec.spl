# # MCP Protocol Compliance and Gap Matrix
#
# **Feature ID:** #MCP-PROTOCOL-001
# **Category:** Application / MCP
# **Status:** Active (documentation + planning contract)
#
# This spec intentionally locks:
# 1) current feature inventory
# 2) known protocol/format gaps
# 3) planned implementation phases
#
# It is designed as an SSpec-backed documentation contract.

use std.spec

fn count_texts(items: [text]) -> i64:
    var n = 0
    for _item in items:
        n = n + 1
    n

fn has_text(items: [text], needle: text) -> bool:
    for item in items:
        if item == needle:
            return true
    false

val DEBUG_TOOLS = [
    "debug_create_session", "debug_list_sessions", "debug_close_session",
    "debug_set_breakpoint", "debug_remove_breakpoint", "debug_continue",
    "debug_step", "debug_get_variables", "debug_stack_trace",
    "debug_evaluate", "debug_set_function_breakpoint", "debug_enable_breakpoint",
    "debug_get_source", "debug_watch", "debug_set_variable",
    "debug_set_data_breakpoint", "debug_list_data_breakpoints", "debug_remove_data_breakpoint",
    "debug_terminate"
]

val DEBUG_LOG_TOOLS = [
    "debug_log_enable", "debug_log_disable", "debug_log_clear",
    "debug_log_query", "debug_log_tree", "debug_log_status"
]

val DIAG_TOOLS = [
    "simple_read", "simple_check", "simple_symbols", "simple_status",
    "simple_edit", "simple_multi_edit", "simple_run",
    "simple_diff", "simple_log", "simple_squash", "simple_new", "simple_api"
]

val RESOLVED_METHOD_GAPS = [
    "resources/templates/list",
    "resources/read",
    "prompts/get",
    "completion/complete",
    "completions/complete",
    "logging/setLevel",
    "roots/list"
]

val RESOLVED_RESPONSE_GAPS = [
    "jsonrpc-id-type-preservation",
    "capabilities-completeness",
    "tool-schema-properties-required",
    "tool-result-isError-semantics",
    "structured-tool-payloads"
]

val PLAN_PHASES = [
    "Phase 1: Protocol Correctness",
    "Phase 2: Method Completeness",
    "Phase 3: Capability and Schema Quality",
    "Phase 4: Error and Payload Semantics"
]

describe "MCP Protocol Compliance Matrix":

    context "feature inventory lock":
        it "tracks complete debug tool set":
            expect(count_texts(DEBUG_TOOLS)).to_equal(19)
            expect(has_text(DEBUG_TOOLS, "debug_create_session")).to_equal(true)
            expect(has_text(DEBUG_TOOLS, "debug_terminate")).to_equal(true)

        it "tracks complete debug-log tool set":
            expect(count_texts(DEBUG_LOG_TOOLS)).to_equal(6)
            expect(has_text(DEBUG_LOG_TOOLS, "debug_log_enable")).to_equal(true)
            expect(has_text(DEBUG_LOG_TOOLS, "debug_log_status")).to_equal(true)

        it "tracks complete diagnostic tool set":
            expect(count_texts(DIAG_TOOLS)).to_equal(12)
            expect(has_text(DIAG_TOOLS, "simple_read")).to_equal(true)
            expect(has_text(DIAG_TOOLS, "simple_api")).to_equal(true)

        it "tracks total advertised tool count":
            val total = count_texts(DEBUG_TOOLS) + count_texts(DEBUG_LOG_TOOLS) + count_texts(DIAG_TOOLS)
            expect(total).to_equal(37)

    context "gap inventory lock":
        it "tracks resolved protocol method gaps":
            expect(count_texts(RESOLVED_METHOD_GAPS)).to_equal(7)
            expect(has_text(RESOLVED_METHOD_GAPS, "resources/read")).to_equal(true)
            expect(has_text(RESOLVED_METHOD_GAPS, "prompts/get")).to_equal(true)
            expect(has_text(RESOLVED_METHOD_GAPS, "completion/complete")).to_equal(true)

        it "tracks resolved response format gaps":
            expect(count_texts(RESOLVED_RESPONSE_GAPS)).to_equal(5)
            expect(has_text(RESOLVED_RESPONSE_GAPS, "jsonrpc-id-type-preservation")).to_equal(true)
            expect(has_text(RESOLVED_RESPONSE_GAPS, "tool-schema-properties-required")).to_equal(true)

    context "plan coverage lock":
        it "tracks all implementation phases":
            expect(count_texts(PLAN_PHASES)).to_equal(4)
            expect(has_text(PLAN_PHASES, "Phase 1: Protocol Correctness")).to_equal(true)
            expect(has_text(PLAN_PHASES, "Phase 4: Error and Payload Semantics")).to_equal(true)

    context "documentation linkage lock":
        it "includes canonical docs and test artifacts":
            val docs = [
                "doc/plan/mcp_protocol_gap_closure_plan_2026-02-24.md",
                "doc/research/mcp_command_and_response_gap_analysis_2026-02-24.md",
                "doc/design/simple_mcp_debug_design.md",
                "doc/feature/app/mcp_protocol_compliance.md",
                "doc/spec/feature/app/mcp_protocol_compliance_spec.md"
            ]
            expect(count_texts(docs)).to_equal(5)
            expect(has_text(docs, "doc/spec/feature/app/mcp_protocol_compliance_spec.md")).to_equal(true)
