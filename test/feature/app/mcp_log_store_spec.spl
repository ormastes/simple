"""
# MCP Log Store

**Feature ID:** #MCP-003
**Category:** Application
**Status:** Active

## Overview

Tests the JSON serialization and tree rendering of AOP debug log entries for the MCP log store.
Validates single entry and multi-entry JSON serialization, hierarchical tree building from nested
function calls, text-based tree rendering with collapsed (>>) and expanded (v>) markers and
indentation, and status serialization including enabled state, filter pattern, entry count,
and current depth.

## Syntax

```simple
val json = log_entry_to_json(entry)
expect(json).to_contain("\"function_name\":\"start\"")

val text_tree = format_log_tree_text(entries, expanded)
expect(text_tree).to_contain(">> app.mcp.main::start_server")
```
"""
# MCP Log Store Specification
#
# Tests for src/app/mcp/log_store.spl
# JSON serialization and tree rendering of debug log entries.

use compiler.core.aop_debug_log.{DebugLogEntry, debug_log_enter, debug_log_exit, debug_log_enable, debug_log_disable, debug_log_clear, debug_log_get_entries}
use app.mcp.log_store.{log_entry_to_json, log_entries_to_json, log_tree_to_json, format_log_tree_text, log_status_to_json}

describe "MCP Log Store":

    context "log_entry_to_json":
        it "serializes a single entry to JSON":
            val entry = DebugLogEntry(
                entry_id: 1, group_id: 10, parent_group_id: 0,
                depth: 0, entry_type: "enter",
                package_path: "app.mcp", class_name: "Server",
                function_name: "start", line_number: 42,
                timestamp_ms: 1000, duration_ms: 0,
                params_text: "port=8080", message: ""
            )
            val json = log_entry_to_json(entry)
            expect(json).to_contain("\"entry_id\":1")
            expect(json).to_contain("\"group_id\":10")
            expect(json).to_contain("\"entry_type\":\"enter\"")
            expect(json).to_contain("\"function_name\":\"start\"")
            expect(json).to_contain("\"package_path\":\"app.mcp\"")
            expect(json).to_contain("\"class_name\":\"Server\"")
            expect(json).to_contain("\"params_text\":\"port=8080\"")

    context "log_entries_to_json":
        it "serializes empty array":
            var entries: [DebugLogEntry] = []
            val json = log_entries_to_json(entries)
            expect(json).to_equal("[]")

        it "serializes multiple entries":
            debug_log_clear()
            debug_log_enable("*")
            val g1 = debug_log_enter("func_a", "mod.a", "", 1, "")
            debug_log_exit("func_a", "mod.a", g1, 0)
            val entries = debug_log_get_entries()
            val json = log_entries_to_json(entries)
            expect(json).to_start_with("[")
            expect(json).to_end_with("]")
            expect(json).to_contain("func_a")
            expect(json).to_contain("\"entry_type\":\"enter\"")
            expect(json).to_contain("\"entry_type\":\"exit\"")
            debug_log_disable()

    context "log_tree_to_json":
        it "builds hierarchical tree from nested calls":
            debug_log_clear()
            debug_log_enable("*")
            val g_outer = debug_log_enter("outer", "mod", "", 1, "x=1")
            val g_inner = debug_log_enter("inner", "mod", "", 2, "y=2")
            debug_log_exit("inner", "mod", g_inner, 0)
            debug_log_exit("outer", "mod", g_outer, 0)
            val entries = debug_log_get_entries()
            val tree = log_tree_to_json(entries)
            expect(tree).to_start_with("[")
            expect(tree).to_contain("\"function_name\":\"outer\"")
            expect(tree).to_contain("\"children\":")
            expect(tree).to_contain("\"function_name\":\"inner\"")
            debug_log_disable()

        it "returns empty array for no entries":
            var entries: [DebugLogEntry] = []
            val tree = log_tree_to_json(entries)
            expect(tree).to_equal("[]")

    context "format_log_tree_text":
        it "renders collapsed tree with >> markers":
            debug_log_clear()
            debug_log_enable("*")
            val g1 = debug_log_enter("start_server", "app.mcp.main", "", 91, "port=8080")
            debug_log_exit("start_server", "app.mcp.main", g1, 0)
            val entries = debug_log_get_entries()
            var expanded: [i64] = []
            val text_tree = format_log_tree_text(entries, expanded)
            expect(text_tree).to_contain(">> app.mcp.main::start_server")
            expect(text_tree).to_contain("(line 91)")
            expect(text_tree).to_contain("> (...)")
            expect(text_tree).to_contain("<< app.mcp.main::start_server")
            debug_log_disable()

        it "renders expanded tree with v> markers":
            debug_log_clear()
            debug_log_enable("*")
            val g1 = debug_log_enter("read_file", "app.mcp.resources", "", 234, "path=/src/main.spl")
            debug_log_exit("read_file", "app.mcp.resources", g1, 0)
            val entries = debug_log_get_entries()
            val expanded = [g1]
            val text_tree = format_log_tree_text(entries, expanded)
            expect(text_tree).to_contain("v> app.mcp.resources::read_file")
            expect(text_tree).to_contain("params: path=/src/main.spl")
            debug_log_disable()

        it "renders nested indentation":
            debug_log_clear()
            debug_log_enable("*")
            val g1 = debug_log_enter("outer", "mod", "", 1, "")
            val g2 = debug_log_enter("inner", "mod", "", 2, "")
            debug_log_exit("inner", "mod", g2, 0)
            debug_log_exit("outer", "mod", g1, 0)
            val entries = debug_log_get_entries()
            var expanded: [i64] = []
            val text_tree = format_log_tree_text(entries, expanded)
            # Inner should be indented (2 spaces per level)
            expect(text_tree).to_contain("  >> mod::inner")
            debug_log_disable()

    context "log_status_to_json":
        it "serializes status correctly":
            val json = log_status_to_json(true, "parse_*", 42, 3)
            expect(json).to_contain("\"enabled\":true")
            expect(json).to_contain("\"filter_pattern\":\"parse_*\"")
            expect(json).to_contain("\"entry_count\":42")
            expect(json).to_contain("\"current_depth\":3")

        it "serializes disabled status":
            val json = log_status_to_json(false, "*", 0, 0)
            expect(json).to_contain("\"enabled\":false")
