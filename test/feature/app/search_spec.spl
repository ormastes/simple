# # Registry Search Specification
#
#
# **Feature IDs:** #959-960
# **Category:** Tooling
# **Difficulty:** 2/5
# **Status:** In Progress
#
# ## Overview
# Tests for the `simple search` command that queries the package listing.
#
# ## Key Concepts
# - Package listing parsing
# - Name and description matching
# - Result limiting

use std.spec

describe "Search Command":
    # ## Package Search
    # Tests for searching the registry by name or description.

    context "when packages match":
        it "finds packages by name":
            var results = search_listing(sample_listing(), "http", 20)
            expect(results.len()).to_equal(1)

        it "finds packages by description":
            var results = search_listing(sample_listing(), "parser", 20)
            expect(results.len()).to_equal(1)

        it "is case insensitive":
            var results = search_listing(sample_listing(), "HTTP", 20)
            expect(results.len()).to_equal(1)

    context "when no packages match":
        it "returns empty list":
            var results = search_listing(sample_listing(), "nonexistent", 20)
            expect(results.len()).to_equal(0)

    context "when limit is applied":
        it "respects result limit":
            var results = search_listing(sample_listing(), "", 1)
            expect(results.len()).to_equal(1)

# Helpers

fn sample_listing() -> text:
    "packages |name, description, latest_version|\n  http, HTTP client library, 1.1.0\n  json, JSON parser and serializer, 2.0.1\n  collections, Extended collection types, 0.3.0\n"

struct SearchResult:
    name: text
    description: text
    latest_version: text

fn search_listing(content: text, query: text, limit: i64) -> [SearchResult]:
    val lines = content.split("\n")
    var results = []
    var in_table = false
    val query_lower = query.lower()

    for line in lines:
        val trimmed = line.trim()
        if trimmed.starts_with("packages "):
            in_table = true
        elif in_table and trimmed.contains(","):
            val parts = trimmed.split(",")
            if parts.len() >= 3:
                val name = parts[0].trim()
                val desc = parts[1].trim()
                val ver = parts[2].trim()
                if query_lower == "" or name.lower().contains(query_lower) or desc.lower().contains(query_lower):
                    results.push(SearchResult(name: name, description: desc, latest_version: ver))
                    if results.len() >= limit:
                        return results
    results
