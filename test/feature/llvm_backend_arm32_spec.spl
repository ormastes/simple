"""
# LLVM Backend ARM 32-bit Specification


**Feature IDs:** #4004
**Category:** Infrastructure
**Difficulty:** 3/5
**Status:** In Progress

Validates that the LLVM backend correctly generates code for ARM 32-bit (ARMv7) targets.
"""

use compiler.backend.llvm_ir_builder.{LlvmIRBuilder, LlvmIRBuilder__create, MirToLlvm, MirToLlvm__create}
use compiler.backend.llvm_target.{LlvmTargetTriple, LlvmTargetTriple__from_target, LlvmTargetConfig, LlvmTargetConfig__for_target}
use compiler.backend.llvm_type_mapper.{LlvmTypeMapper, LlvmTypeMapper__create_for_target}
use compiler.backend.entry_point.halt_instruction_for_target
use compiler.backend.backend_types.{CodegenTarget, OptimizationLevel}
use std.string.{NL}

describe "LLVM Backend ARM32":

    context "target triple":
        it "generates correct armv7 triple":
            val triple = LlvmTargetTriple__from_target(CodegenTarget.Arm)
            expect(triple.arch).to_equal("armv7")
            expect(triple.to_text()).to_contain("armv7")

        it "includes gnueabihf env on linux":
            val triple = LlvmTargetTriple__from_target(CodegenTarget.Arm)
            val text = triple.to_text()
            expect(text).to_contain("armv7")

    context "datalayout":
        it "contains correct arm32 layout":
            val triple = LlvmTargetTriple__from_target(CodegenTarget.Arm)
            val dl = triple.datalayout()
            expect(dl).to_contain("p:32:32")

    context "CPU defaults":
        it "defaults to cortex-a7":
            val config = LlvmTargetConfig__for_target(CodegenTarget.Arm, nil)
            expect(config.cpu).to_equal("cortex-a7")

        it "includes neon feature":
            val config = LlvmTargetConfig__for_target(CodegenTarget.Arm, nil)
            expect(config.features).to_contain("+neon")

        it "includes vfp4 feature":
            val config = LlvmTargetConfig__for_target(CodegenTarget.Arm, nil)
            expect(config.features).to_contain("+vfp4")

    context "native integer type":
        it "native_int_type is i32":
            var translator = MirToLlvm__create("test", CodegenTarget.Arm, nil)
            expect(translator.native_int()).to_equal("i32")

    context "type mapping":
        it "uses 32-bit target_bits":
            val mapper = LlvmTypeMapper__create_for_target(CodegenTarget.Arm)
            expect(mapper.target_bits).to_equal(32)

    context "bare-metal entry":
        it "uses wfi instruction for halt":
            val halt = halt_instruction_for_target(CodegenTarget.Arm)
            expect(halt).to_equal("wfi")

    context "builder size type":
        it "uses i32 size type":
            val triple = LlvmTargetTriple__from_target(CodegenTarget.Arm)
            var builder = LlvmIRBuilder__create("test", triple)
            expect(builder.size_type).to_equal("i32")
