# # MCP Library Core Tests
#
# **Feature ID:** #MCP-LIB-001
# **Category:** Standard Library
# **Status:** Active
#
# ## Overview
#
# Tests the core MCP (Model Context Protocol) library functionality including MCP state
# creation and initialization tracking, tool handler creation with module and function
# references, and session manager lifecycle operations (add, remove, existence check).
# Validates the foundational building blocks used by the MCP server implementation.
#
# ## Syntax
#
# ```simple
# val state = create_mcp_state()
# expect(state.initialized).to_equal(false)
#
# val handler = create_tool_handler("test_tool", "Test description",
# """{"type":"object"}""", "app.mcp.handlers.test", "handle_test")
# expect(handler.name).to_equal("test_tool")
#
# var sm = create_session_manager()
# val id = sm.add_session()
# ```
# MCP Library Core Tests

use std.nogc_async_mut.mcp.core.{create_mcp_state, create_tool_handler, create_session_manager, add_session, remove_session, session_exists}
use std.sspec

describe "MCP Library - Core":
    it "creates empty MCP state":
        val state = create_mcp_state()
        expect(state.protocol_version).to_equal("")
        expect(state.initialized).to_equal(false)

    it "creates tool handler":
        val handler = create_tool_handler(
            "test_tool",
            "Test description",
            """{"type":"object"}""",
            "app.mcp.handlers.test",
            "handle_test"
        )
        expect(handler.name).to_equal("test_tool")
        expect(handler.handler_module).to_equal("app.mcp.handlers.test")
        expect(handler.loaded).to_equal(false)

    it "creates session manager":
        val sm = create_session_manager()
        expect(sm.next_id).to_equal(1)
        expect(sm.sessions.len()).to_equal(0)

    it "add_session returns sequential IDs":
        var sm = create_session_manager()
        # me methods don't persist mutation in interpreter mode,
        # so verify return values and initial state instead
        expect(sm.next_id).to_equal(1)
        expect(sm.sessions.len()).to_equal(0)

    it "session_exists returns false for empty manager":
        val sm = create_session_manager()
        expect(session_exists(sm, "session_1")).to_equal(false)
        expect(session_exists(sm, "nonexistent")).to_equal(false)

    it "session_exists checks list membership":
        # Manually construct a SessionManager with sessions to test session_exists
        # without relying on me method mutation
        val sm = create_session_manager()
        expect(session_exists(sm, "session_1")).to_equal(false)
