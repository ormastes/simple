"""
# Extended File I/O Specification

**Feature IDs:** #700-715
**Category:** Infrastructure
**Status:** Implemented

Extended File I/O operations including line-based reading, append operations,
binary I/O, file moving, recursive directory operations, and path utilities.
"""


use infra.*
use std.text.{NL}

# ============================================================================
# Test Group 1: Line-Based File Reading
# ============================================================================

describe "read_lines":
    """
    Verifies line-based file reading that returns content as a list of strings,
    splitting on newline characters. Handles both multi-line content and empty
    files (returning an empty list).
    """

    it "reads multiple lines correctly":
        val test_path = "/tmp/simple_test_multiline.txt"
        val content = "line1{NL}line2{NL}line3"
        write_file(test_path, content)

        val result = read_lines(test_path)
        expect result.is_ok() == true

        match result:
            Ok(lines):
                expect lines.len() == 3
                expect lines[0] == "line1"
                expect lines[1] == "line2"
                expect lines[2] == "line3"
            Err(_):
                fail("Should have read lines successfully")

        remove_file(test_path)

    it "reads empty file as empty list":
        val test_path = "/tmp/simple_test_empty_lines.txt"
        write_file(test_path, "")

        val result = read_lines(test_path)
        expect result.is_ok() == true

        match result:
            Ok(lines):
                expect lines.len() == 0
            Err(_):
                fail("Should have read empty file")

        remove_file(test_path)

# ============================================================================
# Test Group 2: Append File Operations
# ============================================================================

describe "append_file":
    """
    Verifies file append operations that add content to the end of existing
    files or create new files if they don't exist. This enables log-style
    writing and incremental file building.
    """

    it "appends to existing file":
        val test_path = "/tmp/simple_test_append.txt"
        write_file(test_path, "Hello")

        val result = append_file(test_path, ", World!")
        expect result.is_ok() == true

        val content = read_file(test_path)
        match content:
            Ok(text):
                expect text == "Hello, World!"
            Err(_):
                fail("Should have read appended file")

        remove_file(test_path)

    it "creates file if not exists":
        val test_path = "/tmp/simple_test_append_new.txt"

        if file_exist(test_path):
            remove_file(test_path)

        val result = append_file(test_path, "New content")
        expect result.is_ok() == true
        expect file_exist(test_path) == true

        val content = read_file(test_path)
        match content:
            Ok(text):
                expect text == "New content"
            Err(_):
                fail("Should have read new file")

        remove_file(test_path)

# ============================================================================
# Test Group 3: Binary I/O
# ============================================================================

describe "binary I/O":
    """
    Verifies binary file I/O operations (read_bytes and write_bytes) that
    handle raw byte arrays without text encoding/decoding. Critical for
    working with non-text files like images, executables, and data files.
    """

    it "preserves binary data exactly":
        val test_path = "/tmp/simple_test_binary.bin"
        val data = [0, 127, 255, 1, 128]

        val write_result = write_bytes(test_path, data)
        expect write_result.is_ok() == true

        val read_result = read_bytes(test_path)
        expect read_result.is_ok() == true

        match read_result:
            Ok(bytes):
                expect bytes.len() == 5
                expect bytes[0] == 0
                expect bytes[1] == 127
                expect bytes[2] == 255
                expect bytes[3] == 1
                expect bytes[4] == 128
            Err(_):
                fail("Should have read bytes")

        remove_file(test_path)

# ============================================================================
# Test Group 4: Move File
# ============================================================================

describe "move_file":
    """
    Verifies file move operations that atomically relocate a file from source
    to destination path. The source file is removed after successful move.
    """

    it "moves file to new location":
        val src_path = "/tmp/simple_test_move_src.txt"
        val dest_path = "/tmp/simple_test_move_dest.txt"
        write_file(src_path, "content to move")

        if file_exist(dest_path):
            remove_file(dest_path)

        val result = move_file(src_path, dest_path)
        expect result.is_ok() == true
        expect file_exist(src_path) == false
        expect file_exist(dest_path) == true

        val content = read_file(dest_path)
        match content:
            Ok(text):
                expect text == "content to move"
            Err(_):
                fail("Should read moved file")

        remove_file(dest_path)

# ============================================================================
# Test Group 5: Directory Operations
# ============================================================================

describe "create_dir_all":
    """
    Verifies recursive directory creation that creates all missing parent
    directories in a path. Similar to `mkdir -p` in shell.
    """

    it "creates nested directories":
        val nested_path = "/tmp/simple_test_nested/a/b/c"

        val result = create_dir_all(nested_path)
        expect result.is_ok() == true
        expect file_exist(nested_path) == true

        # Cleanup
        remove_dir("/tmp/simple_test_nested/a/b/c")
        remove_dir("/tmp/simple_test_nested/a/b")
        remove_dir("/tmp/simple_test_nested/a")
        remove_dir("/tmp/simple_test_nested")

describe "walk_dir":
    """
    Verifies recursive directory traversal that returns all files and
    subdirectories under a given path. Useful for file discovery and
    batch operations.
    """

    it "returns all files recursively":
        val base = "/tmp/simple_test_walk"
        create_dir_all(base)
        write_file(base + "/file1.txt", "1")
        create_dir(base + "/sub")
        write_file(base + "/sub/file2.txt", "2")

        val result = walk_dir(base)
        expect result.is_ok() == true

        match result:
            Ok(entries):
                expect entries.len() >= 3
            Err(_):
                fail("Should walk directory")

        # Cleanup
        remove_file(base + "/sub/file2.txt")
        remove_dir(base + "/sub")
        remove_file(base + "/file1.txt")
        remove_dir(base)

describe "current_dir and set_current_dir":
    """
    Verifies working directory operations that get and set the current
    working directory. Returns absolute paths for reliable path resolution.
    """

    it "gets absolute path":
        val cwd = current_dir()
        expect cwd.len() > 0
        expect cwd.starts_with("/") == true

describe "remove_dir_all":
    """
    Verifies recursive directory removal that deletes a directory and all
    its contents (files and subdirectories). Similar to `rm -rf` in shell.
    """

    it "removes directory and contents":
        val base = "/tmp/simple_test_rmall"
        create_dir_all(base + "/sub/deep")
        write_file(base + "/file.txt", "content")
        write_file(base + "/sub/file2.txt", "content2")

        val result = remove_dir_all(base)
        expect result.is_ok() == true
        expect file_exist(base) == false

# ============================================================================
# Test Group 6: Path Operations
# ============================================================================

describe "stem":
    """
    Verifies path stem extraction that returns the filename without its
    extension. Handles multiple dots and files without extensions.
    """

    it "extracts filename without extension":
        expect stem("file.txt") == "file"

    it "handles multiple dots":
        expect stem("archive.tar.gz") == "archive.tar"

    it "handles no extension":
        expect stem("README") == "README"

describe "relative_path":
    """
    Verifies relative path computation that calculates the path from a base
    directory to a target path. Returns empty string when paths are identical.
    """

    it "computes relative path":
        expect relative_path("/a/b/c/file.txt", "/a/b") == "c/file.txt"

    it "handles same path":
        expect relative_path("/a/b", "/a/b") == ""

describe "path_join":
    """
    Verifies path joining that combines directory and file components into
    a complete path, handling separator insertion correctly.
    """

    it "joins two paths":
        expect path_join("/home/user", "file.txt") == "/home/user/file.txt"

# ============================================================================
# Error Handling Tests
# ============================================================================

describe "Error Handling":
    """
    Verifies proper error propagation for file I/O operations when files
    or directories don't exist. All operations return Result types that
    indicate failure with meaningful error information.
    """

    it "read_lines fails for non-existent file":
        val result = read_lines("/tmp/nonexistent_file_12345.txt")
        expect result.is_err() == true

    it "read_bytes fails for non-existent file":
        val result = read_bytes("/tmp/nonexistent_file_12345.bin")
        expect result.is_err() == true

    it "move_file fails for non-existent source":
        val result = move_file("/tmp/nonexistent_12345.txt", "/tmp/dest.txt")
        expect result.is_err() == true

    it "walk_dir fails for non-existent directory":
        val result = walk_dir("/tmp/nonexistent_dir_12345")
        expect result.is_err() == true
